# Comparing `tmp/skypilot_nightly-1.0.0.dev20240510.tar.gz` & `tmp/skypilot_nightly-1.0.0.dev20240511.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "skypilot_nightly-1.0.0.dev20240510.tar", last modified: Fri May 10 10:38:15 2024, max compression
+gzip compressed data, was "skypilot_nightly-1.0.0.dev20240511.tar", last modified: Sat May 11 10:38:08 2024, max compression
```

## Comparing `skypilot_nightly-1.0.0.dev20240510.tar` & `skypilot_nightly-1.0.0.dev20240511.tar`

### file list

```diff
@@ -1,339 +1,339 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.943324 skypilot_nightly-1.0.0.dev20240510/
--rw-r--r--   0 runner    (1001) docker     (127)    12170 2024-05-10 10:38:10.000000 skypilot_nightly-1.0.0.dev20240510/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    18140 2024-05-10 10:38:15.943324 skypilot_nightly-1.0.0.dev20240510/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)    12079 2024-05-10 10:38:10.000000 skypilot_nightly-1.0.0.dev20240510/README.md
--rw-r--r--   0 runner    (1001) docker     (127)      640 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-10 10:38:15.943324 skypilot_nightly-1.0.0.dev20240510/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (127)    12055 2024-05-10 10:38:13.000000 skypilot_nightly-1.0.0.dev20240510/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.887323 skypilot_nightly-1.0.0.dev20240510/sky/
--rw-r--r--   0 runner    (1001) docker     (127)     5588 2024-05-10 10:38:15.000000 skypilot_nightly-1.0.0.dev20240510/sky/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.887323 skypilot_nightly-1.0.0.dev20240510/sky/adaptors/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/adaptors/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     6863 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/adaptors/aws.py
--rw-r--r--   0 runner    (1001) docker     (127)     2291 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/adaptors/azure.py
--rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/adaptors/cloudflare.py
--rw-r--r--   0 runner    (1001) docker     (127)     2354 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/adaptors/common.py
--rw-r--r--   0 runner    (1001) docker     (127)      239 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/adaptors/cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)      468 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/adaptors/docker.py
--rw-r--r--   0 runner    (1001) docker     (127)     3097 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/adaptors/gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)     4906 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/adaptors/ibm.py
--rw-r--r--   0 runner    (1001) docker     (127)     3920 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/adaptors/kubernetes.py
--rw-r--r--   0 runner    (1001) docker     (127)     1480 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/adaptors/oci.py
--rw-r--r--   0 runner    (1001) docker     (127)      225 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/adaptors/runpod.py
--rw-r--r--   0 runner    (1001) docker     (127)     2129 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/adaptors/vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)    21408 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/authentication.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.891323 skypilot_nightly-1.0.0.dev20240510/sky/backends/
--rw-r--r--   0 runner    (1001) docker     (127)      536 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/backends/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     5932 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/backends/backend.py
--rw-r--r--   0 runner    (1001) docker     (127)   125420 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/backends/backend_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)   230261 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/backends/cloud_vm_ray_backend.py
--rw-r--r--   0 runner    (1001) docker     (127)     8358 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/backends/docker_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    16741 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/backends/local_docker_backend.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.891323 skypilot_nightly-1.0.0.dev20240510/sky/backends/monkey_patches/
--rw-r--r--   0 runner    (1001) docker     (127)     3450 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/backends/monkey_patches/monkey_patch_ray_up.py
--rw-r--r--   0 runner    (1001) docker     (127)     7297 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/backends/wheel_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.891323 skypilot_nightly-1.0.0.dev20240510/sky/benchmark/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/benchmark/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     8723 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/benchmark/benchmark_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    26446 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/benchmark/benchmark_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     5908 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/check.py
--rw-r--r--   0 runner    (1001) docker     (127)   190684 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/cli.py
--rw-r--r--   0 runner    (1001) docker     (127)    11806 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/cloud_stores.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.895323 skypilot_nightly-1.0.0.dev20240510/sky/clouds/
--rw-r--r--   0 runner    (1001) docker     (127)     1310 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    44608 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/aws.py
--rw-r--r--   0 runner    (1001) docker     (127)    31006 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/azure.py
--rw-r--r--   0 runner    (1001) docker     (127)    31817 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)      955 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/cloud_registry.py
--rw-r--r--   0 runner    (1001) docker     (127)    12036 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)    12647 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/fluidstack.py
--rw-r--r--   0 runner    (1001) docker     (127)    48019 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)    21044 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/ibm.py
--rw-r--r--   0 runner    (1001) docker     (127)    20409 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/kubernetes.py
--rw-r--r--   0 runner    (1001) docker     (127)    12157 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/lambda_cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)    25299 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/oci.py
--rw-r--r--   0 runner    (1001) docker     (127)    10561 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/paperspace.py
--rw-r--r--   0 runner    (1001) docker     (127)    11166 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/runpod.py
--rw-r--r--   0 runner    (1001) docker     (127)    15546 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/scp.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.895323 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/
--rw-r--r--   0 runner    (1001) docker     (127)    12771 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    12550 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/aws_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     7289 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/azure_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)    26837 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/common.py
--rw-r--r--   0 runner    (1001) docker     (127)     1793 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      411 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)     4335 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/cudo_catalog.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.899323 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/data_fetchers/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/data_fetchers/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    22424 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
--rw-r--r--   0 runner    (1001) docker     (127)    11477 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
--rw-r--r--   0 runner    (1001) docker     (127)     5072 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)     3895 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py
--rw-r--r--   0 runner    (1001) docker     (127)    22243 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)     4297 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)    21462 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)     5038 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/fluidstack_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)    24120 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/gcp_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4472 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/ibm_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4240 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/kubernetes_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     5082 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/lambda_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/oci_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     3768 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/paperspace_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4184 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/runpod_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     5174 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/scp_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4391 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/vsphere_catalog.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.899323 skypilot_nightly-1.0.0.dev20240510/sky/clouds/utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     6968 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/utils/gcp_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     9991 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/utils/lambda_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     4482 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/utils/oci_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    15781 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/utils/scp_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    11969 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/clouds/vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)    34233 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/core.py
--rw-r--r--   0 runner    (1001) docker     (127)     2529 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/dag.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.899323 skypilot_nightly-1.0.0.dev20240510/sky/data/
--rw-r--r--   0 runner    (1001) docker     (127)      184 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/data/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7346 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/data/data_transfer.py
--rw-r--r--   0 runner    (1001) docker     (127)    21664 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/data/data_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     8351 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/data/mounting_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)   118872 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/data/storage.py
--rw-r--r--   0 runner    (1001) docker     (127)     6867 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/data/storage_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     8249 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/exceptions.py
--rw-r--r--   0 runner    (1001) docker     (127)    25107 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/execution.py
--rw-r--r--   0 runner    (1001) docker     (127)    28681 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/global_user_state.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.903324 skypilot_nightly-1.0.0.dev20240510/sky/jobs/
--rw-r--r--   0 runner    (1001) docker     (127)     1398 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/jobs/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1350 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/jobs/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    26607 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/jobs/controller.py
--rw-r--r--   0 runner    (1001) docker     (127)    13430 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/jobs/core.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.903324 skypilot_nightly-1.0.0.dev20240510/sky/jobs/dashboard/
--rw-r--r--   0 runner    (1001) docker     (127)     3050 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/jobs/dashboard/dashboard.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.903324 skypilot_nightly-1.0.0.dev20240510/sky/jobs/dashboard/static/
--rw-r--r--   0 runner    (1001) docker     (127)    15086 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/jobs/dashboard/static/favicon.ico
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.903324 skypilot_nightly-1.0.0.dev20240510/sky/jobs/dashboard/templates/
--rw-r--r--   0 runner    (1001) docker     (127)     9837 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/jobs/dashboard/templates/index.html
--rw-r--r--   0 runner    (1001) docker     (127)    25556 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/jobs/recovery_strategy.py
--rw-r--r--   0 runner    (1001) docker     (127)    23041 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/jobs/state.py
--rw-r--r--   0 runner    (1001) docker     (127)    33067 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/jobs/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    54188 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/optimizer.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.903324 skypilot_nightly-1.0.0.dev20240510/sky/provision/
--rw-r--r--   0 runner    (1001) docker     (127)     5951 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.903324 skypilot_nightly-1.0.0.dev20240510/sky/provision/aws/
--rw-r--r--   0 runner    (1001) docker     (127)      731 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/aws/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    22092 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/aws/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    36307 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/aws/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     3238 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/aws/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.903324 skypilot_nightly-1.0.0.dev20240510/sky/provision/azure/
--rw-r--r--   0 runner    (1001) docker     (127)      146 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/azure/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4028 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/azure/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     9339 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/common.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.903324 skypilot_nightly-1.0.0.dev20240510/sky/provision/cudo/
--rw-r--r--   0 runner    (1001) docker     (127)      676 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/cudo/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      327 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/cudo/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      696 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/cudo/cudo_machine_type.py
--rw-r--r--   0 runner    (1001) docker     (127)     4046 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/cudo/cudo_wrapper.py
--rw-r--r--   0 runner    (1001) docker     (127)     8307 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/cudo/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    16758 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/docker_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.907323 skypilot_nightly-1.0.0.dev20240510/sky/provision/fluidstack/
--rw-r--r--   0 runner    (1001) docker     (127)      592 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/fluidstack/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      326 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/fluidstack/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     8262 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/fluidstack/fluidstack_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    14974 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/fluidstack/instance.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.907323 skypilot_nightly-1.0.0.dev20240510/sky/provision/gcp/
--rw-r--r--   0 runner    (1001) docker     (127)      528 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/gcp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    32964 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/gcp/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     7234 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/gcp/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    24215 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/gcp/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    59069 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/gcp/instance_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    22186 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/instance_setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.907323 skypilot_nightly-1.0.0.dev20240510/sky/provision/kubernetes/
--rw-r--r--   0 runner    (1001) docker     (127)      653 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/kubernetes/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    22684 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/kubernetes/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    32919 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/kubernetes/instance.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.907323 skypilot_nightly-1.0.0.dev20240510/sky/provision/kubernetes/manifests/
--rw-r--r--   0 runner    (1001) docker     (127)      229 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/kubernetes/manifests/smarter-device-manager-configmap.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     1939 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml
--rw-r--r--   0 runner    (1001) docker     (127)    10561 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/kubernetes/network.py
--rw-r--r--   0 runner    (1001) docker     (127)     9384 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/kubernetes/network_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    61255 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/kubernetes/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2103 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/logging.py
--rw-r--r--   0 runner    (1001) docker     (127)     4013 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/metadata_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.907323 skypilot_nightly-1.0.0.dev20240510/sky/provision/paperspace/
--rw-r--r--   0 runner    (1001) docker     (127)      598 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/paperspace/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1541 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/paperspace/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      802 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/paperspace/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    12045 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/paperspace/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     9428 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/paperspace/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    25103 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/provisioner.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.911324 skypilot_nightly-1.0.0.dev20240510/sky/provision/runpod/
--rw-r--r--   0 runner    (1001) docker     (127)      502 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/runpod/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      321 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/runpod/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     7905 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/runpod/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     4648 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/runpod/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.911324 skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/
--rw-r--r--   0 runner    (1001) docker     (127)      788 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.911324 skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/common/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/common/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4167 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/common/cls_api_client.py
--rw-r--r--   0 runner    (1001) docker     (127)    14096 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/common/cls_api_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)      481 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/common/custom_script.py
--rw-r--r--   0 runner    (1001) docker     (127)      303 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/common/id_generator.py
--rw-r--r--   0 runner    (1001) docker     (127)      914 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/common/metadata_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1817 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/common/service_manager.py
--rw-r--r--   0 runner    (1001) docker     (127)      544 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/common/service_manager_factory.py
--rw-r--r--   0 runner    (1001) docker     (127)      795 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/common/ssl_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)     2932 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/common/vapiconnect.py
--rw-r--r--   0 runner    (1001) docker     (127)    17877 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/common/vim_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      504 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    24488 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    15151 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/vsphere_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    65346 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/resources.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.915324 skypilot_nightly-1.0.0.dev20240510/sky/serve/
--rw-r--r--   0 runner    (1001) docker     (127)     1661 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/serve/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    30136 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/serve/autoscalers.py
--rw-r--r--   0 runner    (1001) docker     (127)     3746 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/serve/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)     8022 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/serve/controller.py
--rw-r--r--   0 runner    (1001) docker     (127)    28522 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/serve/core.py
--rw-r--r--   0 runner    (1001) docker     (127)     5298 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/serve/load_balancer.py
--rw-r--r--   0 runner    (1001) docker     (127)     2047 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/serve/load_balancing_policies.py
--rw-r--r--   0 runner    (1001) docker     (127)    56630 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/serve/replica_managers.py
--rw-r--r--   0 runner    (1001) docker     (127)    18830 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/serve/serve_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    37183 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/serve/serve_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    10931 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/serve/service.py
--rw-r--r--   0 runner    (1001) docker     (127)    13803 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/serve/service_spec.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.915324 skypilot_nightly-1.0.0.dev20240510/sky/setup_files/
--rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/setup_files/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    12055 2024-05-10 10:38:13.000000 skypilot_nightly-1.0.0.dev20240510/sky/setup_files/setup.py
--rw-r--r--   0 runner    (1001) docker     (127)     4000 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/sky_logging.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.915324 skypilot_nightly-1.0.0.dev20240510/sky/skylet/
--rw-r--r--   0 runner    (1001) docker     (127)    12381 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1963 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/attempt_skylet.py
--rw-r--r--   0 runner    (1001) docker     (127)     4478 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/autostop_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)     1887 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/configs.py
--rw-r--r--   0 runner    (1001) docker     (127)     9977 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    11759 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/events.py
--rw-r--r--   0 runner    (1001) docker     (127)    35198 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/job_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)    18824 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/log_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)     4295 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/log_lib.pyi
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.915324 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.915324 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/azure/
--rw-r--r--   0 runner    (1001) docker     (127)       97 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/azure/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4344 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/azure/azure-config-template.json
--rw-r--r--   0 runner    (1001) docker     (127)    10901 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/azure/azure-vm-template.json
--rw-r--r--   0 runner    (1001) docker     (127)     6342 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/azure/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    19215 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/azure/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)    16355 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/command_runner.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.919324 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/ibm/
--rw-r--r--   0 runner    (1001) docker     (127)       94 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/ibm/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    38280 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/ibm/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)     1292 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/ibm/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    34630 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/ibm/vpc_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.919324 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/lambda_cloud/
--rw-r--r--   0 runner    (1001) docker     (127)      112 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/lambda_cloud/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    13971 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/lambda_cloud/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.919324 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/oci/
--rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/oci/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    20492 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/oci/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)    17202 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/oci/query_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)      508 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/oci/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.919324 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/scp/
--rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/scp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4683 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/scp/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    22411 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/scp/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.919324 skypilot_nightly-1.0.0.dev20240510/sky/skylet/ray_patches/
--rw-r--r--   0 runner    (1001) docker     (127)     2761 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/ray_patches/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/ray_patches/autoscaler.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      349 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/ray_patches/cli.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      224 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/ray_patches/command_runner.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      531 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/ray_patches/log_monitor.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      658 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      289 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/ray_patches/updater.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      565 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/ray_patches/worker.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)     1153 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/skylet.py
--rw-r--r--   0 runner    (1001) docker     (127)     1348 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skylet/subprocess_daemon.py
--rw-r--r--   0 runner    (1001) docker     (127)     5734 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/skypilot_config.py
--rw-r--r--   0 runner    (1001) docker     (127)     1457 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/status_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)    47130 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/task.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.923324 skypilot_nightly-1.0.0.dev20240510/sky/templates/
--rw-r--r--   0 runner    (1001) docker     (127)     7477 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/templates/aws-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     9037 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/templates/azure-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3435 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/templates/cudo-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3465 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/templates/fluidstack-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     8880 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/templates/gcp-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     6607 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/templates/ibm-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1343 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/templates/jobs-controller.yaml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1095 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/templates/kubernetes-ingress.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)      376 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/templates/kubernetes-loadbalancer.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     2547 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/templates/kubernetes-port-forward-proxy-command.sh.j2
--rw-r--r--   0 runner    (1001) docker     (127)    13943 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/templates/kubernetes-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     2747 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/templates/kubernetes-ssh-jump.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     5676 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/templates/lambda-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1185 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/templates/local-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     6970 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/templates/oci-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3898 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/templates/paperspace-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3496 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/templates/runpod-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     5546 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/templates/scp-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1148 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/templates/sky-serve-controller.yaml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3474 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/templates/vsphere-ray.yml.j2
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.923324 skypilot_nightly-1.0.0.dev20240510/sky/usage/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/usage/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      590 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/usage/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    17601 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/usage/usage_lib.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.927324 skypilot_nightly-1.0.0.dev20240510/sky/utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     3798 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/accelerator_registry.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.927324 skypilot_nightly-1.0.0.dev20240510/sky/utils/cli_utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/cli_utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    11032 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/cli_utils/status_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      849 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/cluster_yaml_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    22168 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/command_runner.py
--rw-r--r--   0 runner    (1001) docker     (127)     4748 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/command_runner.pyi
--rw-r--r--   0 runner    (1001) docker     (127)    23848 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/common_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    34359 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/controller_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     5731 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/dag_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2786 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/db_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      861 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/env_options.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.927324 skypilot_nightly-1.0.0.dev20240510/sky/utils/kubernetes/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/kubernetes/__init__.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     9759 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/kubernetes/create_cluster.sh
--rwxr-xr-x   0 runner    (1001) docker     (127)      927 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/kubernetes/delete_cluster.sh
--rw-r--r--   0 runner    (1001) docker     (127)     3187 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/kubernetes/generate_kind_config.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     4422 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/kubernetes/generate_static_kubeconfig.sh
--rw-r--r--   0 runner    (1001) docker     (127)     6960 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/kubernetes/gpu_labeler.py
--rw-r--r--   0 runner    (1001) docker     (127)     1186 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     3812 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     6560 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py
--rw-r--r--   0 runner    (1001) docker     (127)     1384 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/kubernetes_enums.py
--rw-r--r--   0 runner    (1001) docker     (127)     8139 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/log_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     5540 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/resources_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1581 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/rich_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    22737 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/schemas.py
--rw-r--r--   0 runner    (1001) docker     (127)     6509 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/subprocess_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     3936 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/timeline.py
--rw-r--r--   0 runner    (1001) docker     (127)     3264 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/ux_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      701 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/sky/utils/validator.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.931324 skypilot_nightly-1.0.0.dev20240510/skypilot_nightly.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)    18140 2024-05-10 10:38:15.000000 skypilot_nightly-1.0.0.dev20240510/skypilot_nightly.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     9353 2024-05-10 10:38:15.000000 skypilot_nightly-1.0.0.dev20240510/skypilot_nightly.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-10 10:38:15.000000 skypilot_nightly-1.0.0.dev20240510/skypilot_nightly.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)       36 2024-05-10 10:38:15.000000 skypilot_nightly-1.0.0.dev20240510/skypilot_nightly.egg-info/entry_points.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2270 2024-05-10 10:38:15.000000 skypilot_nightly-1.0.0.dev20240510/skypilot_nightly.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (127)        4 2024-05-10 10:38:15.000000 skypilot_nightly-1.0.0.dev20240510/skypilot_nightly.egg-info/top_level.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-10 10:38:15.931324 skypilot_nightly-1.0.0.dev20240510/tests/
--rw-r--r--   0 runner    (1001) docker     (127)      171 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/tests/test_api.py
--rw-r--r--   0 runner    (1001) docker     (127)     3618 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/tests/test_cli.py
--rw-r--r--   0 runner    (1001) docker     (127)     9592 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/tests/test_config.py
--rw-r--r--   0 runner    (1001) docker     (127)      267 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/tests/test_global_user_state.py
--rw-r--r--   0 runner    (1001) docker     (127)     8789 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/tests/test_jobs.py
--rw-r--r--   0 runner    (1001) docker     (127)    17529 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/tests/test_jobs_and_serve.py
--rw-r--r--   0 runner    (1001) docker     (127)     3718 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/tests/test_list_accelerators.py
--rw-r--r--   0 runner    (1001) docker     (127)    27759 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/tests/test_optimizer_dryruns.py
--rw-r--r--   0 runner    (1001) docker     (127)     6996 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/tests/test_optimizer_random_dag.py
--rw-r--r--   0 runner    (1001) docker     (127)     1102 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/tests/test_serve_autoscaler.py
--rw-r--r--   0 runner    (1001) docker     (127)   215682 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/tests/test_smoke.py
--rw-r--r--   0 runner    (1001) docker     (127)     4048 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/tests/test_storage.py
--rw-r--r--   0 runner    (1001) docker     (127)     1070 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/tests/test_wheels.py
--rw-r--r--   0 runner    (1001) docker     (127)     3915 2024-05-10 10:38:11.000000 skypilot_nightly-1.0.0.dev20240510/tests/test_yaml_parser.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.858343 skypilot_nightly-1.0.0.dev20240511/
+-rw-r--r--   0 runner    (1001) docker     (127)    12170 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    18140 2024-05-11 10:38:08.854343 skypilot_nightly-1.0.0.dev20240511/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)    12079 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/README.md
+-rw-r--r--   0 runner    (1001) docker     (127)      640 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-11 10:38:08.858343 skypilot_nightly-1.0.0.dev20240511/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (127)    12055 2024-05-11 10:38:05.000000 skypilot_nightly-1.0.0.dev20240511/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.790343 skypilot_nightly-1.0.0.dev20240511/sky/
+-rw-r--r--   0 runner    (1001) docker     (127)     5588 2024-05-11 10:38:08.000000 skypilot_nightly-1.0.0.dev20240511/sky/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.794343 skypilot_nightly-1.0.0.dev20240511/sky/adaptors/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/adaptors/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6863 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/adaptors/aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2291 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/adaptors/azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/adaptors/cloudflare.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2354 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/adaptors/common.py
+-rw-r--r--   0 runner    (1001) docker     (127)      239 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/adaptors/cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)      468 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/adaptors/docker.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3097 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/adaptors/gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4906 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/adaptors/ibm.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4109 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/adaptors/kubernetes.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1480 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/adaptors/oci.py
+-rw-r--r--   0 runner    (1001) docker     (127)      225 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/adaptors/runpod.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2129 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/adaptors/vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21408 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/authentication.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.794343 skypilot_nightly-1.0.0.dev20240511/sky/backends/
+-rw-r--r--   0 runner    (1001) docker     (127)      536 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/backends/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5932 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/backends/backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)   125420 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/backends/backend_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)   230760 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/backends/cloud_vm_ray_backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8358 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/backends/docker_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16741 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/backends/local_docker_backend.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.794343 skypilot_nightly-1.0.0.dev20240511/sky/backends/monkey_patches/
+-rw-r--r--   0 runner    (1001) docker     (127)     3450 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/backends/monkey_patches/monkey_patch_ray_up.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7297 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/backends/wheel_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.794343 skypilot_nightly-1.0.0.dev20240511/sky/benchmark/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/benchmark/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8723 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/benchmark/benchmark_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26446 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/benchmark/benchmark_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5908 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/check.py
+-rw-r--r--   0 runner    (1001) docker     (127)   192150 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/cli.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11806 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/cloud_stores.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.798343 skypilot_nightly-1.0.0.dev20240511/sky/clouds/
+-rw-r--r--   0 runner    (1001) docker     (127)     1310 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    44608 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)    31006 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)    31817 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)      955 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/cloud_registry.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12036 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12647 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/fluidstack.py
+-rw-r--r--   0 runner    (1001) docker     (127)    48019 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21044 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/ibm.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20376 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/kubernetes.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12157 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/lambda_cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25299 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/oci.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10561 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/paperspace.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11166 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/runpod.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15546 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/scp.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.802343 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/
+-rw-r--r--   0 runner    (1001) docker     (127)    12771 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12550 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/aws_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7289 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/azure_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26837 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/common.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1793 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      411 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4335 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/cudo_catalog.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.802343 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/data_fetchers/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/data_fetchers/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22424 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11477 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5072 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3895 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22243 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4297 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21462 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5038 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/fluidstack_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24120 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/gcp_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4472 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/ibm_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4240 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/kubernetes_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5082 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/lambda_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/oci_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3768 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/paperspace_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4184 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/runpod_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5174 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/scp_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4391 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/vsphere_catalog.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.802343 skypilot_nightly-1.0.0.dev20240511/sky/clouds/utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6968 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/utils/gcp_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9991 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/utils/lambda_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4482 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/utils/oci_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15781 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/utils/scp_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11969 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/clouds/vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)    34233 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/core.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2529 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/dag.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.806343 skypilot_nightly-1.0.0.dev20240511/sky/data/
+-rw-r--r--   0 runner    (1001) docker     (127)      184 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/data/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7346 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/data/data_transfer.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21664 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/data/data_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8351 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/data/mounting_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)   118872 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/data/storage.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6867 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/data/storage_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8249 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/exceptions.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25107 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/execution.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28681 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/global_user_state.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.806343 skypilot_nightly-1.0.0.dev20240511/sky/jobs/
+-rw-r--r--   0 runner    (1001) docker     (127)     1398 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/jobs/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1350 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/jobs/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26607 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/jobs/controller.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13430 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/jobs/core.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.806343 skypilot_nightly-1.0.0.dev20240511/sky/jobs/dashboard/
+-rw-r--r--   0 runner    (1001) docker     (127)     3050 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/jobs/dashboard/dashboard.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.806343 skypilot_nightly-1.0.0.dev20240511/sky/jobs/dashboard/static/
+-rw-r--r--   0 runner    (1001) docker     (127)    15086 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/jobs/dashboard/static/favicon.ico
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.806343 skypilot_nightly-1.0.0.dev20240511/sky/jobs/dashboard/templates/
+-rw-r--r--   0 runner    (1001) docker     (127)     9837 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/jobs/dashboard/templates/index.html
+-rw-r--r--   0 runner    (1001) docker     (127)    25556 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/jobs/recovery_strategy.py
+-rw-r--r--   0 runner    (1001) docker     (127)    23041 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/jobs/state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    33067 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/jobs/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    54188 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/optimizer.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.806343 skypilot_nightly-1.0.0.dev20240511/sky/provision/
+-rw-r--r--   0 runner    (1001) docker     (127)     5951 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.810343 skypilot_nightly-1.0.0.dev20240511/sky/provision/aws/
+-rw-r--r--   0 runner    (1001) docker     (127)      731 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/aws/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22092 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/aws/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    36307 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/aws/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3238 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/aws/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.810343 skypilot_nightly-1.0.0.dev20240511/sky/provision/azure/
+-rw-r--r--   0 runner    (1001) docker     (127)      146 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/azure/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4028 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/azure/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9339 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/common.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.810343 skypilot_nightly-1.0.0.dev20240511/sky/provision/cudo/
+-rw-r--r--   0 runner    (1001) docker     (127)      676 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/cudo/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      327 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/cudo/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      696 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/cudo/cudo_machine_type.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4046 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/cudo/cudo_wrapper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8307 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/cudo/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16758 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/docker_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.810343 skypilot_nightly-1.0.0.dev20240511/sky/provision/fluidstack/
+-rw-r--r--   0 runner    (1001) docker     (127)      592 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/fluidstack/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      326 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/fluidstack/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8262 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/fluidstack/fluidstack_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14974 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/fluidstack/instance.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.810343 skypilot_nightly-1.0.0.dev20240511/sky/provision/gcp/
+-rw-r--r--   0 runner    (1001) docker     (127)      528 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/gcp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32964 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/gcp/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7234 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/gcp/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24215 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/gcp/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    59069 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/gcp/instance_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22186 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/instance_setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.814343 skypilot_nightly-1.0.0.dev20240511/sky/provision/kubernetes/
+-rw-r--r--   0 runner    (1001) docker     (127)      653 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/kubernetes/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28319 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/kubernetes/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32919 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/kubernetes/instance.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.814343 skypilot_nightly-1.0.0.dev20240511/sky/provision/kubernetes/manifests/
+-rw-r--r--   0 runner    (1001) docker     (127)      229 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/kubernetes/manifests/smarter-device-manager-configmap.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     1939 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)    10561 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/kubernetes/network.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9384 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/kubernetes/network_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    62091 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/kubernetes/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2103 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/logging.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4013 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/metadata_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.814343 skypilot_nightly-1.0.0.dev20240511/sky/provision/paperspace/
+-rw-r--r--   0 runner    (1001) docker     (127)      598 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/paperspace/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1541 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/paperspace/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      802 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/paperspace/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12045 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/paperspace/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9428 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/paperspace/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25103 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/provisioner.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.814343 skypilot_nightly-1.0.0.dev20240511/sky/provision/runpod/
+-rw-r--r--   0 runner    (1001) docker     (127)      502 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/runpod/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      321 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/runpod/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7905 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/runpod/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4648 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/runpod/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.814343 skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/
+-rw-r--r--   0 runner    (1001) docker     (127)      788 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.818343 skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/common/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/common/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4167 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/common/cls_api_client.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14096 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/common/cls_api_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)      481 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/common/custom_script.py
+-rw-r--r--   0 runner    (1001) docker     (127)      303 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/common/id_generator.py
+-rw-r--r--   0 runner    (1001) docker     (127)      914 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/common/metadata_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1817 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/common/service_manager.py
+-rw-r--r--   0 runner    (1001) docker     (127)      544 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/common/service_manager_factory.py
+-rw-r--r--   0 runner    (1001) docker     (127)      795 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/common/ssl_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2932 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/common/vapiconnect.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17877 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/common/vim_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      504 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24488 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15151 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/vsphere_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    65346 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/resources.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.822343 skypilot_nightly-1.0.0.dev20240511/sky/serve/
+-rw-r--r--   0 runner    (1001) docker     (127)     1661 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/serve/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    30136 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/serve/autoscalers.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3746 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/serve/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8022 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/serve/controller.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28522 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/serve/core.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5298 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/serve/load_balancer.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2047 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/serve/load_balancing_policies.py
+-rw-r--r--   0 runner    (1001) docker     (127)    56630 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/serve/replica_managers.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18830 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/serve/serve_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    37183 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/serve/serve_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10931 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/serve/service.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13803 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/serve/service_spec.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.822343 skypilot_nightly-1.0.0.dev20240511/sky/setup_files/
+-rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/setup_files/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    12055 2024-05-11 10:38:05.000000 skypilot_nightly-1.0.0.dev20240511/sky/setup_files/setup.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4000 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/sky_logging.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.822343 skypilot_nightly-1.0.0.dev20240511/sky/skylet/
+-rw-r--r--   0 runner    (1001) docker     (127)    12381 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1963 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/attempt_skylet.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4478 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/autostop_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1887 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/configs.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9977 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11759 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/events.py
+-rw-r--r--   0 runner    (1001) docker     (127)    35198 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/job_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18824 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/log_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4295 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/log_lib.pyi
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.822343 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.826343 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/azure/
+-rw-r--r--   0 runner    (1001) docker     (127)       97 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/azure/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4344 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/azure/azure-config-template.json
+-rw-r--r--   0 runner    (1001) docker     (127)    10901 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/azure/azure-vm-template.json
+-rw-r--r--   0 runner    (1001) docker     (127)     6342 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/azure/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    19215 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/azure/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16355 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/command_runner.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.826343 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/ibm/
+-rw-r--r--   0 runner    (1001) docker     (127)       94 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/ibm/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    38280 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/ibm/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1292 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/ibm/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    34630 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/ibm/vpc_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.826343 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/lambda_cloud/
+-rw-r--r--   0 runner    (1001) docker     (127)      112 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/lambda_cloud/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13971 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/lambda_cloud/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.826343 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/oci/
+-rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/oci/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20492 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/oci/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17202 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/oci/query_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)      508 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/oci/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.826343 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/scp/
+-rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/scp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4683 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/scp/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22411 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/scp/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.830343 skypilot_nightly-1.0.0.dev20240511/sky/skylet/ray_patches/
+-rw-r--r--   0 runner    (1001) docker     (127)     2761 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/ray_patches/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/ray_patches/autoscaler.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      349 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/ray_patches/cli.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      224 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/ray_patches/command_runner.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      531 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/ray_patches/log_monitor.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      658 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      289 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/ray_patches/updater.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      565 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/ray_patches/worker.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)     1153 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/skylet.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1348 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skylet/subprocess_daemon.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5734 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/skypilot_config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1457 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/status_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)    47130 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/task.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.834343 skypilot_nightly-1.0.0.dev20240511/sky/templates/
+-rw-r--r--   0 runner    (1001) docker     (127)     7477 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/templates/aws-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     9037 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/templates/azure-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3435 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/templates/cudo-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3465 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/templates/fluidstack-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     8880 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/templates/gcp-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     6607 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/templates/ibm-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1343 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/templates/jobs-controller.yaml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1095 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/templates/kubernetes-ingress.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)      376 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/templates/kubernetes-loadbalancer.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     2547 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/templates/kubernetes-port-forward-proxy-command.sh.j2
+-rw-r--r--   0 runner    (1001) docker     (127)    15373 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/templates/kubernetes-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     2747 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/templates/kubernetes-ssh-jump.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     5676 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/templates/lambda-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1185 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/templates/local-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     6970 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/templates/oci-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3898 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/templates/paperspace-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3496 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/templates/runpod-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     5546 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/templates/scp-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1148 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/templates/sky-serve-controller.yaml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3474 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/templates/vsphere-ray.yml.j2
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.834343 skypilot_nightly-1.0.0.dev20240511/sky/usage/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/usage/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      590 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/usage/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17601 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/usage/usage_lib.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.838343 skypilot_nightly-1.0.0.dev20240511/sky/utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3798 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/accelerator_registry.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.838343 skypilot_nightly-1.0.0.dev20240511/sky/utils/cli_utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/cli_utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11032 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/cli_utils/status_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      849 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/cluster_yaml_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22168 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/command_runner.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4748 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/command_runner.pyi
+-rw-r--r--   0 runner    (1001) docker     (127)    23848 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/common_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    34359 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/controller_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5731 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/dag_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2786 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/db_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      861 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/env_options.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.838343 skypilot_nightly-1.0.0.dev20240511/sky/utils/kubernetes/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/kubernetes/__init__.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     9759 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/kubernetes/create_cluster.sh
+-rwxr-xr-x   0 runner    (1001) docker     (127)      927 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/kubernetes/delete_cluster.sh
+-rw-r--r--   0 runner    (1001) docker     (127)     3187 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/kubernetes/generate_kind_config.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     4422 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/kubernetes/generate_static_kubeconfig.sh
+-rw-r--r--   0 runner    (1001) docker     (127)     6960 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/kubernetes/gpu_labeler.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1186 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     3812 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     6560 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1384 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/kubernetes_enums.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8139 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/log_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5540 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/resources_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1581 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/rich_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22737 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/schemas.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6509 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/subprocess_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3936 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/timeline.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3264 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/ux_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      701 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/sky/utils/validator.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.842343 skypilot_nightly-1.0.0.dev20240511/skypilot_nightly.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)    18140 2024-05-11 10:38:08.000000 skypilot_nightly-1.0.0.dev20240511/skypilot_nightly.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     9353 2024-05-11 10:38:08.000000 skypilot_nightly-1.0.0.dev20240511/skypilot_nightly.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-11 10:38:08.000000 skypilot_nightly-1.0.0.dev20240511/skypilot_nightly.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       36 2024-05-11 10:38:08.000000 skypilot_nightly-1.0.0.dev20240511/skypilot_nightly.egg-info/entry_points.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2270 2024-05-11 10:38:08.000000 skypilot_nightly-1.0.0.dev20240511/skypilot_nightly.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        4 2024-05-11 10:38:08.000000 skypilot_nightly-1.0.0.dev20240511/skypilot_nightly.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-11 10:38:08.842343 skypilot_nightly-1.0.0.dev20240511/tests/
+-rw-r--r--   0 runner    (1001) docker     (127)      171 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/tests/test_api.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3579 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/tests/test_cli.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9592 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/tests/test_config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      267 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/tests/test_global_user_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8789 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/tests/test_jobs.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17529 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/tests/test_jobs_and_serve.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3718 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/tests/test_list_accelerators.py
+-rw-r--r--   0 runner    (1001) docker     (127)    27759 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/tests/test_optimizer_dryruns.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6996 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/tests/test_optimizer_random_dag.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1102 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/tests/test_serve_autoscaler.py
+-rw-r--r--   0 runner    (1001) docker     (127)   215704 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/tests/test_smoke.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4048 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/tests/test_storage.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1070 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/tests/test_wheels.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3915 2024-05-11 10:38:03.000000 skypilot_nightly-1.0.0.dev20240511/tests/test_yaml_parser.py
```

### Comparing `skypilot_nightly-1.0.0.dev20240510/LICENSE` & `skypilot_nightly-1.0.0.dev20240511/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/MANIFEST.in` & `skypilot_nightly-1.0.0.dev20240511/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/PKG-INFO` & `skypilot_nightly-1.0.0.dev20240511/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot-nightly
-Version: 1.0.0.dev20240510
+Version: 1.0.0.dev20240511
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
```

### Comparing `skypilot_nightly-1.0.0.dev20240510/README.md` & `skypilot_nightly-1.0.0.dev20240511/README.md`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/pyproject.toml` & `skypilot_nightly-1.0.0.dev20240511/pyproject.toml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/setup.py` & `skypilot_nightly-1.0.0.dev20240511/setup.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/__init__.py` & `skypilot_nightly-1.0.0.dev20240511/sky/__init__.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,15 +1,15 @@
 """The SkyPilot package."""
 import os
 import subprocess
 from typing import Optional
 import urllib.request
 
 # Replaced with the current commit when building the wheels.
-_SKYPILOT_COMMIT_SHA = '4683c46edb5e1b5dcadb1ef143e6baedc145fcd4'
+_SKYPILOT_COMMIT_SHA = '8a0a34d36bc75cd1e337e11d14e5bf8aeb4144e4'
 
 
 def _get_git_commit():
     if 'SKYPILOT_COMMIT_SHA' not in _SKYPILOT_COMMIT_SHA:
         # This is a release build, so we don't need to get the commit hash from
         # git, as it's already been set.
         return _SKYPILOT_COMMIT_SHA
@@ -31,15 +31,15 @@
             commit_hash += '-dirty'
         return commit_hash
     except Exception:  # pylint: disable=broad-except
         return _SKYPILOT_COMMIT_SHA
 
 
 __commit__ = _get_git_commit()
-__version__ = '1.0.0.dev20240510'
+__version__ = '1.0.0.dev20240511'
 __root_dir__ = os.path.dirname(os.path.abspath(__file__))
 
 
 # ---------------------- Proxy Configuration ---------------------- #
 def _set_http_proxy_env_vars() -> None:
     urllib_proxies = dict(urllib.request.getproxies())
```

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/adaptors/aws.py` & `skypilot_nightly-1.0.0.dev20240511/sky/adaptors/aws.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/adaptors/azure.py` & `skypilot_nightly-1.0.0.dev20240511/sky/adaptors/azure.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/adaptors/cloudflare.py` & `skypilot_nightly-1.0.0.dev20240511/sky/adaptors/cloudflare.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/adaptors/common.py` & `skypilot_nightly-1.0.0.dev20240511/sky/adaptors/common.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/adaptors/gcp.py` & `skypilot_nightly-1.0.0.dev20240511/sky/adaptors/gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/adaptors/ibm.py` & `skypilot_nightly-1.0.0.dev20240511/sky/adaptors/ibm.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/adaptors/kubernetes.py` & `skypilot_nightly-1.0.0.dev20240511/sky/adaptors/kubernetes.py`

 * *Files 9% similar despite different names*

```diff
@@ -18,14 +18,15 @@
 _configured = False
 _core_api = None
 _auth_api = None
 _networking_api = None
 _custom_objects_api = None
 _node_api = None
 _apps_api = None
+_api_client = None
 
 # Timeout to use for API calls
 API_TIMEOUT = 5
 
 
 def _load_config():
     global _configured
@@ -114,14 +115,23 @@
     if _apps_api is None:
         _load_config()
         _apps_api = kubernetes.client.AppsV1Api()
 
     return _apps_api
 
 
+def api_client():
+    global _api_client
+    if _api_client is None:
+        _load_config()
+        _api_client = kubernetes.client.ApiClient()
+
+    return _api_client
+
+
 def api_exception():
     return kubernetes.client.rest.ApiException
 
 
 def config_exception():
     return kubernetes.config.config_exception.ConfigException
```

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/adaptors/oci.py` & `skypilot_nightly-1.0.0.dev20240511/sky/adaptors/oci.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/adaptors/vsphere.py` & `skypilot_nightly-1.0.0.dev20240511/sky/adaptors/vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/authentication.py` & `skypilot_nightly-1.0.0.dev20240511/sky/authentication.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/backends/__init__.py` & `skypilot_nightly-1.0.0.dev20240511/sky/backends/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/backends/backend.py` & `skypilot_nightly-1.0.0.dev20240511/sky/backends/backend.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/backends/backend_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/backends/backend_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/backends/cloud_vm_ray_backend.py` & `skypilot_nightly-1.0.0.dev20240511/sky/backends/cloud_vm_ray_backend.py`

 * *Files 1% similar despite different names*

```diff
@@ -132,14 +132,27 @@
 # Path to the monkey-patched ray up script.
 # We don't do import then __file__ because that script needs to be filled in
 # (so import would fail).
 _RAY_UP_WITH_MONKEY_PATCHED_HASH_LAUNCH_CONF_PATH = (
     pathlib.Path(sky.__file__).resolve().parent / 'backends' /
     'monkey_patches' / 'monkey_patch_ray_up.py')
 
+# The maximum size of a command line arguments is 128 KB, i.e. the command
+# executed with /bin/sh should be less than 128KB.
+# https://github.com/torvalds/linux/blob/master/include/uapi/linux/binfmts.h
+#
+# If a user have very long run or setup commands, the generated command may
+# exceed the limit, as we encode the script in base64 and directly include it in
+# the job submission command. If the command is too long, we instead write it to
+# a file, rsync and execute it.
+#
+# We use 120KB as a threshold to be safe for other arguments that
+# might be added during ssh.
+_MAX_INLINE_SCRIPT_LENGTH = 120 * 1024
+
 
 def _get_cluster_config_template(cloud):
     cloud_to_template = {
         clouds.AWS: 'aws-ray.yml.j2',
         clouds.Azure: 'azure-ray.yml.j2',
         clouds.Cudo: 'cudo-ray.yml.j2',
         clouds.GCP: 'gcp-ray.yml.j2',
@@ -3132,28 +3145,38 @@
             setup_envs = task.envs.copy()
             setup_envs.update(self._skypilot_predefined_env_vars(handle))
             setup_envs['SKYPILOT_SETUP_NODE_IPS'] = '\n'.join(internal_ips)
             setup_envs['SKYPILOT_SETUP_NODE_RANK'] = str(node_id)
             runner = runners[node_id]
             setup_script = log_lib.make_task_bash_script(setup,
                                                          env_vars=setup_envs)
-            with tempfile.NamedTemporaryFile('w', prefix='sky_setup_') as f:
-                f.write(setup_script)
-                f.flush()
-                setup_sh_path = f.name
-                runner.rsync(source=setup_sh_path,
-                             target=remote_setup_file_name,
-                             up=True,
-                             stream_logs=False)
+            encoded_script = base64.b64encode(
+                setup_script.encode('utf-8')).decode('utf-8')
+            if (detach_setup or
+                    len(encoded_script) > _MAX_INLINE_SCRIPT_LENGTH):
+                with tempfile.NamedTemporaryFile('w', prefix='sky_setup_') as f:
+                    f.write(setup_script)
+                    f.flush()
+                    setup_sh_path = f.name
+                    runner.rsync(source=setup_sh_path,
+                                 target=remote_setup_file_name,
+                                 up=True,
+                                 stream_logs=False)
+                create_script_code = 'true'
+            else:
+                create_script_code = (
+                    f'{{ echo "{encoded_script}" | base64 --decode > '
+                    f'{remote_setup_file_name}; }}')
+
             if detach_setup:
                 return
             setup_log_path = os.path.join(self.log_dir,
                                           f'setup-{runner.node_id}.log')
             returncode = runner.run(
-                setup_cmd,
+                f'{create_script_code} && {setup_cmd}',
                 log_path=setup_log_path,
                 process_stream=False,
                 source_bashrc=True,
             )
 
             def error_message() -> str:
                 # Use the function to avoid tailing the file in success case
@@ -3233,25 +3256,15 @@
             f'--submission-id {job_id}-$(whoami) --no-wait '
             # Redirect stderr to /dev/null to avoid distracting error from ray.
             f'"{constants.SKY_PYTHON_CMD} -u {script_path} > {remote_log_path} 2> /dev/null"'
         )
 
         code = job_lib.JobLibCodeGen.queue_job(job_id, job_submit_cmd)
         job_submit_cmd = ' && '.join([mkdir_code, create_script_code, code])
-        if len(job_submit_cmd) > 120 * 1024:
-            # The maximum size of a command line arguments is 128 KB, i.e. the
-            # command executed with /bin/sh should be less than 128KB.
-            # https://github.com/torvalds/linux/blob/master/include/uapi/linux/binfmts.h
-            # If a user have very long run or setup commands, the generated
-            # command may exceed the limit, as we encode the script in base64
-            # and directly include it in the job submission command. If the
-            # command is too long, we instead write it to a file, rsync and
-            # execute it.
-            # We use 120KB as a threshold to be safe for other arguments that
-            # might be added during ssh.
+        if len(job_submit_cmd) > _MAX_INLINE_SCRIPT_LENGTH:
             runners = handle.get_command_runners()
             head_runner = runners[0]
             with tempfile.NamedTemporaryFile('w', prefix='sky_app_') as fp:
                 fp.write(codegen)
                 fp.flush()
                 script_path = os.path.join(SKY_REMOTE_APP_DIR,
                                            f'sky_job_{job_id}')
@@ -3707,14 +3720,15 @@
         self.run_on_head(
             handle,
             code,
             stream_logs=True,
             process_stream=False,
             ssh_mode=command_runner.SshMode.INTERACTIVE,
             stdin=subprocess.DEVNULL,
+            source_bashrc=True,
         )
 
     def tail_serve_logs(self, handle: CloudVmRayResourceHandle,
                         service_name: str, target: serve_lib.ServiceComponent,
                         replica_id: Optional[int], follow: bool) -> None:
         """Tail the logs of a service.
 
@@ -3744,14 +3758,15 @@
         self.run_on_head(
             handle,
             code,
             stream_logs=True,
             process_stream=False,
             ssh_mode=command_runner.SshMode.INTERACTIVE,
             stdin=subprocess.DEVNULL,
+            source_bashrc=True,
         )
 
     def teardown_no_lock(self,
                          handle: CloudVmRayResourceHandle,
                          terminate: bool,
                          purge: bool = False,
                          post_teardown_cleanup: bool = True,
```

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/backends/docker_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/backends/docker_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/backends/local_docker_backend.py` & `skypilot_nightly-1.0.0.dev20240511/sky/backends/local_docker_backend.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/backends/monkey_patches/monkey_patch_ray_up.py` & `skypilot_nightly-1.0.0.dev20240511/sky/backends/monkey_patches/monkey_patch_ray_up.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/backends/wheel_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/backends/wheel_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/benchmark/benchmark_state.py` & `skypilot_nightly-1.0.0.dev20240511/sky/benchmark/benchmark_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/benchmark/benchmark_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/benchmark/benchmark_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/check.py` & `skypilot_nightly-1.0.0.dev20240511/sky/check.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/cli.py` & `skypilot_nightly-1.0.0.dev20240511/sky/cli.py`

 * *Files 0% similar despite different names*

```diff
@@ -3060,14 +3060,42 @@
         result = service_catalog.list_accelerators(gpus_only=True,
                                                    name_filter=name,
                                                    quantity_filter=quantity,
                                                    region_filter=region,
                                                    clouds=cloud,
                                                    case_sensitive=False,
                                                    all_regions=all_regions)
+        # Import here to save module load speed.
+        # pylint: disable=import-outside-toplevel,line-too-long
+        from sky.clouds.service_catalog import common
+
+        # For each gpu name (count not included):
+        #   - Group by cloud
+        #   - Sort within each group by prices
+        #   - Sort groups by each cloud's (min price, min spot price)
+        new_result = {}
+        for i, (gpu, items) in enumerate(result.items()):
+            df = pd.DataFrame([t._asdict() for t in items])
+            # Determine the minimum prices for each cloud.
+            min_price_df = df.groupby('cloud').agg(min_price=('price', 'min'),
+                                                   min_spot_price=('spot_price',
+                                                                   'min'))
+            df = df.merge(min_price_df, on='cloud')
+            # Sort within each cloud by price.
+            df = df.groupby('cloud', group_keys=False).apply(
+                lambda x: x.sort_values(by=['price', 'spot_price']))
+            # Sort across groups (clouds).
+            df = df.sort_values(by=['min_price', 'min_spot_price'])
+            df = df.drop(columns=['min_price', 'min_spot_price'])
+            sorted_dataclasses = [
+                common.InstanceTypeInfo(*row)
+                for row in df.to_records(index=False)
+            ]
+            new_result[gpu] = sorted_dataclasses
+        result = new_result
 
         if len(result) == 0:
             if cloud == 'kubernetes':
                 yield kubernetes_utils.NO_GPU_ERROR_MESSAGE
                 return
 
             quantity_str = (f' with requested quantity {quantity}'
@@ -3093,21 +3121,22 @@
                 accelerator_table_headers.append('REGION')
             accelerator_table = log_utils.create_table(
                 accelerator_table_headers)
             for item in items:
                 instance_type_str = item.instance_type if not pd.isna(
                     item.instance_type) else '(attachable)'
                 cpu_count = item.cpu_count
-                if pd.isna(cpu_count):
-                    cpu_str = '-'
-                elif isinstance(cpu_count, (float, int)):
+                if not pd.isna(cpu_count) and isinstance(
+                        cpu_count, (float, int)):
                     if int(cpu_count) == cpu_count:
                         cpu_str = str(int(cpu_count))
                     else:
                         cpu_str = f'{cpu_count:.1f}'
+                else:
+                    cpu_str = '-'
                 device_memory_str = (f'{item.device_memory:.0f}GB' if
                                      not pd.isna(item.device_memory) else '-')
                 host_memory_str = f'{item.memory:.0f}GB' if not pd.isna(
                     item.memory) else '-'
                 price_str = f'$ {item.price:.3f}' if not pd.isna(
                     item.price) else '-'
                 spot_price_str = f'$ {item.spot_price:.3f}' if not pd.isna(
```

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/cloud_stores.py` & `skypilot_nightly-1.0.0.dev20240511/sky/cloud_stores.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/__init__.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/aws.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/aws.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/azure.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/azure.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/cloud.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/cloud_registry.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/cloud_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/cudo.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/cudo.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/fluidstack.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/fluidstack.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/gcp.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/ibm.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/ibm.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/kubernetes.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/kubernetes.py`

 * *Files 0% similar despite different names*

```diff
@@ -25,24 +25,23 @@
 # Check if KUBECONFIG is set, and use it if it is.
 DEFAULT_KUBECONFIG_PATH = '~/.kube/config'
 CREDENTIAL_PATH = os.environ.get('KUBECONFIG', DEFAULT_KUBECONFIG_PATH)
 
 # Namespace for SkyPilot resources shared across multiple tenants on the
 # same cluster (even if they might be running in different namespaces).
 # E.g., FUSE device manager daemonset is run in this namespace.
-_SKY_SYSTEM_NAMESPACE = 'skypilot-system'
+_SKYPILOT_SYSTEM_NAMESPACE = 'skypilot-system'
 
 
 @clouds.CLOUD_REGISTRY.register
 class Kubernetes(clouds.Cloud):
     """Kubernetes."""
 
     SKY_SSH_KEY_SECRET_NAME = 'sky-ssh-keys'
     SKY_SSH_JUMP_NAME = 'sky-ssh-jump-pod'
-    SKY_DEFAULT_SERVICE_ACCOUNT_NAME = 'skypilot-service-account'
     PORT_FORWARD_PROXY_CMD_TEMPLATE = \
         'kubernetes-port-forward-proxy-command.sh.j2'
     PORT_FORWARD_PROXY_CMD_PATH = '~/.sky/port-forward-proxy-cmd.sh'
     # Timeout for resource provisioning. This timeout determines how long to
     # wait for pod to be in pending status before giving up.
     # Larger timeout may be required for autoscaling clusters, since autoscaler
     # may take some time to provision new nodes.
@@ -280,15 +279,16 @@
                 schemas.RemoteIdentityOptions.LOCAL_CREDENTIALS.value):
             # SA name doesn't matter since automounting credentials is disabled
             k8s_service_account_name = 'default'
             k8s_automount_sa_token = 'false'
         elif (remote_identity ==
               schemas.RemoteIdentityOptions.SERVICE_ACCOUNT.value):
             # Use the default service account
-            k8s_service_account_name = self.SKY_DEFAULT_SERVICE_ACCOUNT_NAME
+            k8s_service_account_name = (
+                kubernetes_utils.DEFAULT_SERVICE_ACCOUNT_NAME)
             k8s_automount_sa_token = 'true'
         else:
             # User specified a custom service account
             k8s_service_account_name = remote_identity
             k8s_automount_sa_token = 'true'
 
         fuse_device_required = bool(resources.requires_fuse)
@@ -309,15 +309,15 @@
             'k8s_acc_label_value': k8s_acc_label_value,
             'k8s_ssh_jump_name': self.SKY_SSH_JUMP_NAME,
             'k8s_ssh_jump_image': ssh_jump_image,
             'k8s_service_account_name': k8s_service_account_name,
             'k8s_automount_sa_token': k8s_automount_sa_token,
             'k8s_fuse_device_required': fuse_device_required,
             # Namespace to run the FUSE device manager in
-            'k8s_fuse_device_manager_namespace': _SKY_SYSTEM_NAMESPACE,
+            'k8s_skypilot_system_namespace': _SKYPILOT_SYSTEM_NAMESPACE,
             'image_id': image_id,
         }
 
         return deploy_vars
 
     def _get_feasible_launchable_resources(
         self, resources: 'resources_lib.Resources'
```

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/lambda_cloud.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/lambda_cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/oci.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/oci.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/paperspace.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/paperspace.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/runpod.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/runpod.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/scp.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/scp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/__init__.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/aws_catalog.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/aws_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/azure_catalog.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/azure_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/common.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/common.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/config.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/cudo_catalog.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/cudo_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/data_fetchers/fetch_aws.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/data_fetchers/fetch_aws.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/data_fetchers/fetch_azure.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/data_fetchers/fetch_azure.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/fluidstack_catalog.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/fluidstack_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/gcp_catalog.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/gcp_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/ibm_catalog.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/ibm_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/kubernetes_catalog.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/kubernetes_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/lambda_catalog.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/lambda_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/oci_catalog.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/oci_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/paperspace_catalog.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/paperspace_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/runpod_catalog.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/runpod_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/scp_catalog.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/scp_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/service_catalog/vsphere_catalog.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/service_catalog/vsphere_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/utils/gcp_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/utils/gcp_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/utils/lambda_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/utils/lambda_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/utils/oci_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/utils/oci_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/utils/scp_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/utils/scp_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/clouds/vsphere.py` & `skypilot_nightly-1.0.0.dev20240511/sky/clouds/vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/core.py` & `skypilot_nightly-1.0.0.dev20240511/sky/core.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/dag.py` & `skypilot_nightly-1.0.0.dev20240511/sky/dag.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/data/data_transfer.py` & `skypilot_nightly-1.0.0.dev20240511/sky/data/data_transfer.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/data/data_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/data/data_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/data/mounting_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/data/mounting_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/data/storage.py` & `skypilot_nightly-1.0.0.dev20240511/sky/data/storage.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/data/storage_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/data/storage_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/exceptions.py` & `skypilot_nightly-1.0.0.dev20240511/sky/exceptions.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/execution.py` & `skypilot_nightly-1.0.0.dev20240511/sky/execution.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/global_user_state.py` & `skypilot_nightly-1.0.0.dev20240511/sky/global_user_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/jobs/__init__.py` & `skypilot_nightly-1.0.0.dev20240511/sky/jobs/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/jobs/constants.py` & `skypilot_nightly-1.0.0.dev20240511/sky/jobs/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/jobs/controller.py` & `skypilot_nightly-1.0.0.dev20240511/sky/jobs/controller.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/jobs/core.py` & `skypilot_nightly-1.0.0.dev20240511/sky/jobs/core.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/jobs/dashboard/dashboard.py` & `skypilot_nightly-1.0.0.dev20240511/sky/jobs/dashboard/dashboard.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/jobs/dashboard/static/favicon.ico` & `skypilot_nightly-1.0.0.dev20240511/sky/jobs/dashboard/static/favicon.ico`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/jobs/dashboard/templates/index.html` & `skypilot_nightly-1.0.0.dev20240511/sky/jobs/dashboard/templates/index.html`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/jobs/recovery_strategy.py` & `skypilot_nightly-1.0.0.dev20240511/sky/jobs/recovery_strategy.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/jobs/state.py` & `skypilot_nightly-1.0.0.dev20240511/sky/jobs/state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/jobs/utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/jobs/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/optimizer.py` & `skypilot_nightly-1.0.0.dev20240511/sky/optimizer.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/__init__.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/aws/__init__.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/aws/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/aws/config.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/aws/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/aws/instance.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/aws/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/aws/utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/aws/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/azure/instance.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/azure/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/common.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/common.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/cudo/__init__.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/cudo/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/cudo/cudo_machine_type.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/cudo/cudo_machine_type.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/cudo/cudo_wrapper.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/cudo/cudo_wrapper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/cudo/instance.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/cudo/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/docker_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/docker_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/fluidstack/__init__.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/fluidstack/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/fluidstack/fluidstack_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/fluidstack/fluidstack_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/fluidstack/instance.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/fluidstack/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/gcp/__init__.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/gcp/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/gcp/config.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/gcp/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/gcp/constants.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/gcp/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/gcp/instance.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/gcp/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/gcp/instance_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/gcp/instance_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/instance_setup.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/instance_setup.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/kubernetes/__init__.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/kubernetes/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/kubernetes/config.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/kubernetes/config.py`

 * *Files 24% similar despite different names*

```diff
@@ -1,13 +1,13 @@
 """Kubernetes-specific configuration for the provisioner."""
 import copy
 import logging
 import math
 import os
-from typing import Any, Dict, Union
+from typing import Any, Dict, Optional, Union
 
 import yaml
 
 from sky.adaptors import kubernetes
 from sky.provision import common
 from sky.provision.kubernetes import utils as kubernetes_utils
 
@@ -23,19 +23,17 @@
     del region, cluster_name  # unused
     namespace = kubernetes_utils.get_current_kube_config_context_namespace()
 
     _configure_services(namespace, config.provider_config)
 
     config = _configure_ssh_jump(namespace, config)
 
-    if config.provider_config.get('fuse_device_required', False):
-        _configure_fuse_mounting(config.provider_config)
-
     requested_service_account = config.node_config['spec']['serviceAccountName']
-    if requested_service_account == 'skypilot-service-account':
+    if (requested_service_account ==
+            kubernetes_utils.DEFAULT_SERVICE_ACCOUNT_NAME):
         # If the user has requested a different service account (via pod_config
         # in ~/.sky/config.yaml), we assume they have already set up the
         # necessary roles and role bindings.
         # If not, set up the roles and bindings for skypilot-service-account
         # here.
         _configure_autoscaler_service_account(namespace, config.provider_config)
         _configure_autoscaler_role(namespace,
@@ -67,14 +65,34 @@
                         ' Skipping ingress role and role binding setup.')
                 else:
                     raise e
 
     elif requested_service_account != 'default':
         logger.info(f'Using service account {requested_service_account!r}, '
                     'skipping role and role binding setup.')
+
+    # SkyPilot system namespace is required for FUSE mounting. Here we just
+    # create the namespace and set up the necessary permissions.
+    #
+    # We need to setup the namespace outside the if block below because if
+    # we put in the if block, the following happens:
+    # 1. User launches job controller on Kubernetes with SERVICE_ACCOUNT. No
+    #    namespace is created at this point since the controller does not
+    #    require FUSE.
+    # 2. User submits a job requiring FUSE.
+    # 3. The namespace is created here, but since the job controller is using
+    #    SERVICE_ACCOUNT, it does not have the necessary permissions to create
+    #    a role for itself to create the FUSE device manager.
+    # 4. The job fails to launch.
+    _configure_skypilot_system_namespace(config.provider_config,
+                                         requested_service_account)
+
+    if config.provider_config.get('fuse_device_required', False):
+        _configure_fuse_mounting(config.provider_config)
+
     return config
 
 
 class InvalidNamespaceError(ValueError):
 
     def __init__(self, field_name: str, namespace: str):
         super().__init__(
@@ -234,14 +252,17 @@
 
     name = account['metadata']['name']
     field_selector = f'metadata.name={name}'
     accounts = (kubernetes.core_api().list_namespaced_service_account(
         namespace, field_selector=field_selector).items)
     if len(accounts) > 0:
         assert len(accounts) == 1
+        # Nothing to check for equality and patch here,
+        # since the service_account.metadata.name is the only important
+        # attribute, which is already filtered for above.
         logger.info('_configure_autoscaler_service_account: '
                     f'{using_existing_msg(account_field, name)}')
         return
 
     logger.info('_configure_autoscaler_service_account: '
                 f'{not_found_msg(account_field, name)}')
     kubernetes.core_api().create_namespaced_service_account(namespace, account)
@@ -268,31 +289,42 @@
     if 'namespace' not in role['metadata']:
         role['metadata']['namespace'] = namespace
     else:
         namespace = role['metadata']['namespace']
 
     name = role['metadata']['name']
     field_selector = f'metadata.name={name}'
-    accounts = (kubernetes.auth_api().list_namespaced_role(
+    roles = (kubernetes.auth_api().list_namespaced_role(
         namespace, field_selector=field_selector).items)
-    if len(accounts) > 0:
-        assert len(accounts) == 1
+    if len(roles) > 0:
+        assert len(roles) == 1
+        existing_role = roles[0]
+        # Convert to k8s object to compare
+        new_role = kubernetes_utils.dict_to_k8s_object(role, 'V1Role')
+        if new_role.rules == existing_role.rules:
+            logger.info('_configure_autoscaler_role: '
+                        f'{using_existing_msg(role_field, name)}')
+            return
         logger.info('_configure_autoscaler_role: '
-                    f'{using_existing_msg(role_field, name)}')
+                    f'{updating_existing_msg(role_field, name)}')
+        kubernetes.auth_api().patch_namespaced_role(name, namespace, role)
         return
 
     logger.info('_configure_autoscaler_role: '
                 f'{not_found_msg(role_field, name)}')
     kubernetes.auth_api().create_namespaced_role(namespace, role)
     logger.info(f'_configure_autoscaler_role: {created_msg(role_field, name)}')
 
 
-def _configure_autoscaler_role_binding(namespace: str,
-                                       provider_config: Dict[str, Any],
-                                       binding_field: str) -> None:
+def _configure_autoscaler_role_binding(
+        namespace: str,
+        provider_config: Dict[str, Any],
+        binding_field: str,
+        override_name: Optional[str] = None,
+        override_subject_namespace: Optional[str] = None) -> None:
     """ Reads the role binding from the config, creates if it does not exist.
 
     Args:
         namespace: The namespace to create the role binding in.
         provider_config: The provider config.
         binding_field: The field in the provider config that contains the role
     """
@@ -305,30 +337,45 @@
     binding = provider_config[binding_field]
     if 'namespace' not in binding['metadata']:
         binding['metadata']['namespace'] = namespace
         rb_namespace = namespace
     else:
         rb_namespace = binding['metadata']['namespace']
 
+    # If override_subject_namespace is provided, we will use that
+    # namespace for the subject. Otherwise, we will raise an error.
+    subject_namespace = override_subject_namespace or namespace
     for subject in binding['subjects']:
         if 'namespace' not in subject:
-            subject['namespace'] = namespace
-        elif subject['namespace'] != namespace:
+            subject['namespace'] = subject_namespace
+        elif subject['namespace'] != subject_namespace:
             subject_name = subject['name']
             raise InvalidNamespaceError(
                 binding_field + f' subject {subject_name}', namespace)
 
+    # Override name if provided
+    binding['metadata']['name'] = override_name or binding['metadata']['name']
     name = binding['metadata']['name']
+
     field_selector = f'metadata.name={name}'
-    accounts = (kubernetes.auth_api().list_namespaced_role_binding(
+    role_bindings = (kubernetes.auth_api().list_namespaced_role_binding(
         rb_namespace, field_selector=field_selector).items)
-    if len(accounts) > 0:
-        assert len(accounts) == 1
+    if len(role_bindings) > 0:
+        assert len(role_bindings) == 1
+        existing_binding = role_bindings[0]
+        new_rb = kubernetes_utils.dict_to_k8s_object(binding, 'V1RoleBinding')
+        if (new_rb.role_ref == existing_binding.role_ref and
+                new_rb.subjects == existing_binding.subjects):
+            logger.info('_configure_autoscaler_role_binding: '
+                        f'{using_existing_msg(binding_field, name)}')
+            return
         logger.info('_configure_autoscaler_role_binding: '
-                    f'{using_existing_msg(binding_field, name)}')
+                    f'{updating_existing_msg(binding_field, name)}')
+        kubernetes.auth_api().patch_namespaced_role_binding(
+            name, rb_namespace, binding)
         return
 
     logger.info('_configure_autoscaler_role_binding: '
                 f'{not_found_msg(binding_field, name)}')
     kubernetes.auth_api().create_namespaced_role_binding(rb_namespace, binding)
     logger.info('_configure_autoscaler_role_binding: '
                 f'{created_msg(binding_field, name)}')
@@ -346,20 +393,27 @@
     if 'namespace' not in role['metadata']:
         role['metadata']['namespace'] = namespace
     elif role['metadata']['namespace'] != namespace:
         raise InvalidNamespaceError(role_field, namespace)
 
     name = role['metadata']['name']
     field_selector = f'metadata.name={name}'
-    accounts = (kubernetes.auth_api().list_cluster_role(
+    cluster_roles = (kubernetes.auth_api().list_cluster_role(
         field_selector=field_selector).items)
-    if len(accounts) > 0:
-        assert len(accounts) == 1
+    if len(cluster_roles) > 0:
+        assert len(cluster_roles) == 1
+        existing_cr = cluster_roles[0]
+        new_cr = kubernetes_utils.dict_to_k8s_object(role, 'V1ClusterRole')
+        if new_cr.rules == existing_cr.rules:
+            logger.info('_configure_autoscaler_cluster_role: '
+                        f'{using_existing_msg(role_field, name)}')
+            return
         logger.info('_configure_autoscaler_cluster_role: '
-                    f'{using_existing_msg(role_field, name)}')
+                    f'{updating_existing_msg(role_field, name)}')
+        kubernetes.auth_api().patch_cluster_role(name, role)
         return
 
     logger.info('_configure_autoscaler_cluster_role: '
                 f'{not_found_msg(role_field, name)}')
     kubernetes.auth_api().create_cluster_role(role)
     logger.info(
         f'_configure_autoscaler_cluster_role: {created_msg(role_field, name)}')
@@ -384,20 +438,29 @@
         elif subject['namespace'] != namespace:
             subject_name = subject['name']
             raise InvalidNamespaceError(
                 binding_field + f' subject {subject_name}', namespace)
 
     name = binding['metadata']['name']
     field_selector = f'metadata.name={name}'
-    accounts = (kubernetes.auth_api().list_cluster_role_binding(
+    cr_bindings = (kubernetes.auth_api().list_cluster_role_binding(
         field_selector=field_selector).items)
-    if len(accounts) > 0:
-        assert len(accounts) == 1
+    if len(cr_bindings) > 0:
+        assert len(cr_bindings) == 1
+        existing_binding = cr_bindings[0]
+        new_binding = kubernetes_utils.dict_to_k8s_object(
+            binding, 'V1ClusterRoleBinding')
+        if (new_binding.role_ref == existing_binding.role_ref and
+                new_binding.subjects == existing_binding.subjects):
+            logger.info('_configure_autoscaler_cluster_role_binding: '
+                        f'{using_existing_msg(binding_field, name)}')
+            return
         logger.info('_configure_autoscaler_cluster_role_binding: '
-                    f'{using_existing_msg(binding_field, name)}')
+                    f'{updating_existing_msg(binding_field, name)}')
+        kubernetes.auth_api().patch_cluster_role_binding(name, binding)
         return
 
     logger.info('_configure_autoscaler_cluster_role_binding: '
                 f'{not_found_msg(binding_field, name)}')
     kubernetes.auth_api().create_cluster_role_binding(binding)
     logger.info('_configure_autoscaler_cluster_role_binding: '
                 f'{created_msg(binding_field, name)}')
@@ -434,33 +497,73 @@
     #  service is missing, we should raise an error.
 
     kubernetes_utils.setup_ssh_jump_pod(ssh_jump_name, ssh_jump_image,
                                         ssh_key_secret_name, namespace)
     return config
 
 
+def _configure_skypilot_system_namespace(
+        provider_config: Dict[str,
+                              Any], service_account: Optional[str]) -> None:
+    """Creates the namespace for skypilot-system mounting if it does not exist.
+
+    Also patches the SkyPilot service account to have the necessary permissions
+    to manage resources in the namespace.
+    """
+    svc_account_namespace = provider_config['namespace']
+    skypilot_system_namespace = provider_config['skypilot_system_namespace']
+    kubernetes_utils.create_namespace(skypilot_system_namespace)
+
+    # Setup permissions if using the default service account.
+    # If the user has requested a different service account (via
+    # remote_identity in ~/.sky/config.yaml), we assume they have already set
+    # up the necessary roles and role bindings.
+    if service_account == kubernetes_utils.DEFAULT_SERVICE_ACCOUNT_NAME:
+        # Note - this must be run only after the service account has been
+        # created in the cluster (in bootstrap_instances).
+        # Create the role in the skypilot-system namespace if it does not exist.
+        _configure_autoscaler_role(skypilot_system_namespace,
+                                   provider_config,
+                                   role_field='autoscaler_skypilot_system_role')
+        # We must create a unique role binding per-namespace that SkyPilot is
+        # running in, so we override the name with a unique name identifying
+        # the namespace. This is required for multi-tenant setups where
+        # different SkyPilot instances may be running in different namespaces.
+        override_name = provider_config[
+            'autoscaler_skypilot_system_role_binding']['metadata'][
+                'name'] + '-' + svc_account_namespace
+
+        # Create the role binding in the skypilot-system namespace, and have
+        # the subject namespace be the namespace that the SkyPilot service
+        # account is created in.
+        _configure_autoscaler_role_binding(
+            skypilot_system_namespace,
+            provider_config,
+            binding_field='autoscaler_skypilot_system_role_binding',
+            override_name=override_name,
+            override_subject_namespace=svc_account_namespace)
+
+
 def _configure_fuse_mounting(provider_config: Dict[str, Any]) -> None:
     """Creates sidecars required for FUSE mounting.
 
     FUSE mounting in Kubernetes without privileged containers requires us to
     run a sidecar container with the necessary capabilities. We run a daemonset
     which exposes the host /dev/fuse device as a Kubernetes resource. The
     SkyPilot pod requests this resource to mount the FUSE filesystem.
 
-    We create this daemonset in a common namespace, which is configurable in the
-    provider config. This allows the FUSE mounting sidecar to be shared across
-    multiple tenants. The default namespace is 'sky-system' (populated in
-    clouds.Kubernetes)
+    We create this daemonset in the skypilot_system_namespace, which is
+    configurable in the provider config. This allows the FUSE mounting sidecar
+    to be shared across multiple tenants. The default namespace is
+    'skypilot-system' (populated in clouds.Kubernetes).
     """
 
     logger.info('_configure_fuse_mounting: Setting up FUSE device manager.')
 
-    fuse_device_manager_namespace = provider_config.get(
-        'fuse_device_manager_namespace', 'default')
-    kubernetes_utils.create_namespace(fuse_device_manager_namespace)
+    fuse_device_manager_namespace = provider_config['skypilot_system_namespace']
 
     # Read the device manager YAMLs from the manifests directory
     root_dir = os.path.dirname(os.path.dirname(__file__))
 
     # Load and create the ConfigMap
     logger.info('_configure_fuse_mounting: Creating configmap.')
     config_map_path = os.path.join(
@@ -522,15 +625,17 @@
         name = service['metadata']['name']
         field_selector = f'metadata.name={name}'
         services = (kubernetes.core_api().list_namespaced_service(
             namespace, field_selector=field_selector).items)
         if len(services) > 0:
             assert len(services) == 1
             existing_service = services[0]
-            if service == existing_service:
+            # Convert to k8s object to compare
+            new_svc = kubernetes_utils.dict_to_k8s_object(service, 'V1Service')
+            if new_svc.spec.ports == existing_service.spec.ports:
                 logger.info('_configure_services: '
                             f'{using_existing_msg("service", name)}')
                 return
             else:
                 logger.info('_configure_services: '
                             f'{updating_existing_msg("service", name)}')
                 kubernetes.core_api().patch_namespaced_service(
```

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/kubernetes/instance.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/kubernetes/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/kubernetes/network.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/kubernetes/network.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/kubernetes/network_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/kubernetes/network_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/kubernetes/utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/kubernetes/utils.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,8 +1,9 @@
 """Kubernetes utilities for SkyPilot."""
+import json
 import math
 import os
 import re
 import subprocess
 from typing import Any, Dict, List, Optional, Set, Tuple, Union
 from urllib.parse import urlparse
 
@@ -17,16 +18,19 @@
 from sky.provision.kubernetes import network_utils
 from sky.utils import common_utils
 from sky.utils import env_options
 from sky.utils import kubernetes_enums
 from sky.utils import schemas
 from sky.utils import ux_utils
 
+# TODO(romilb): Move constants to constants.py
 DEFAULT_NAMESPACE = 'default'
 
+DEFAULT_SERVICE_ACCOUNT_NAME = 'skypilot-service-account'
+
 MEMORY_SIZE_UNITS = {
     'B': 1,
     'K': 2**10,
     'M': 2**20,
     'G': 2**30,
     'T': 2**40,
     'P': 2**50,
@@ -1439,7 +1443,27 @@
     """Returns the autoscaler type by reading from config"""
     autoscaler_type = skypilot_config.get_nested(['kubernetes', 'autoscaler'],
                                                  None)
     if autoscaler_type is not None:
         autoscaler_type = kubernetes_enums.KubernetesAutoscalerType(
             autoscaler_type)
     return autoscaler_type
+
+
+def dict_to_k8s_object(object_dict: Dict[str, Any], object_type: 'str') -> Any:
+    """Converts a dictionary to a Kubernetes object.
+
+    Useful for comparing two Kubernetes objects. Adapted from
+    https://github.com/kubernetes-client/python/issues/977#issuecomment-592030030  # pylint: disable=line-too-long
+
+    Args:
+        object_dict: Dictionary representing the Kubernetes object
+        object_type: Type of the Kubernetes object. E.g., 'V1Pod', 'V1Service'.
+    """
+
+    class FakeKubeResponse:
+
+        def __init__(self, obj):
+            self.data = json.dumps(obj)
+
+    fake_kube_response = FakeKubeResponse(object_dict)
+    return kubernetes.api_client().deserialize(fake_kube_response, object_type)
```

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/logging.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/logging.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/metadata_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/metadata_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/paperspace/__init__.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/paperspace/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/paperspace/config.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/paperspace/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/paperspace/constants.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/paperspace/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/paperspace/instance.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/paperspace/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/paperspace/utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/paperspace/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/provisioner.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/provisioner.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/runpod/instance.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/runpod/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/runpod/utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/runpod/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/__init__.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/common/cls_api_client.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/common/cls_api_client.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/common/cls_api_helper.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/common/cls_api_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/common/metadata_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/common/metadata_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/common/service_manager.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/common/service_manager.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/common/service_manager_factory.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/common/service_manager_factory.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/common/ssl_helper.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/common/ssl_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/common/vapiconnect.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/common/vapiconnect.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/common/vim_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/common/vim_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/instance.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/provision/vsphere/vsphere_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/provision/vsphere/vsphere_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/resources.py` & `skypilot_nightly-1.0.0.dev20240511/sky/resources.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/serve/__init__.py` & `skypilot_nightly-1.0.0.dev20240511/sky/serve/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/serve/autoscalers.py` & `skypilot_nightly-1.0.0.dev20240511/sky/serve/autoscalers.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/serve/constants.py` & `skypilot_nightly-1.0.0.dev20240511/sky/serve/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/serve/controller.py` & `skypilot_nightly-1.0.0.dev20240511/sky/serve/controller.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/serve/core.py` & `skypilot_nightly-1.0.0.dev20240511/sky/serve/core.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/serve/load_balancer.py` & `skypilot_nightly-1.0.0.dev20240511/sky/serve/load_balancer.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/serve/load_balancing_policies.py` & `skypilot_nightly-1.0.0.dev20240511/sky/serve/load_balancing_policies.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/serve/replica_managers.py` & `skypilot_nightly-1.0.0.dev20240511/sky/serve/replica_managers.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/serve/serve_state.py` & `skypilot_nightly-1.0.0.dev20240511/sky/serve/serve_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/serve/serve_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/serve/serve_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/serve/service.py` & `skypilot_nightly-1.0.0.dev20240511/sky/serve/service.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/serve/service_spec.py` & `skypilot_nightly-1.0.0.dev20240511/sky/serve/service_spec.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/setup_files/MANIFEST.in` & `skypilot_nightly-1.0.0.dev20240511/sky/setup_files/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/setup_files/setup.py` & `skypilot_nightly-1.0.0.dev20240511/sky/setup_files/setup.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/sky_logging.py` & `skypilot_nightly-1.0.0.dev20240511/sky/sky_logging.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/LICENSE` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/attempt_skylet.py` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/attempt_skylet.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/autostop_lib.py` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/autostop_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/configs.py` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/configs.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/constants.py` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/events.py` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/events.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/job_lib.py` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/job_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/log_lib.py` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/log_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/log_lib.pyi` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/log_lib.pyi`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/azure/azure-config-template.json` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/azure/azure-config-template.json`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/azure/azure-vm-template.json` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/azure/azure-vm-template.json`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/azure/config.py` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/azure/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/azure/node_provider.py` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/azure/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/command_runner.py` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/command_runner.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/ibm/node_provider.py` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/ibm/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/ibm/utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/ibm/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/ibm/vpc_provider.py` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/ibm/vpc_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/lambda_cloud/node_provider.py` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/lambda_cloud/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/oci/node_provider.py` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/oci/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/oci/query_helper.py` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/oci/query_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/scp/config.py` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/scp/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/providers/scp/node_provider.py` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/providers/scp/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/ray_patches/__init__.py` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/ray_patches/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/ray_patches/log_monitor.py.patch` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/ray_patches/log_monitor.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/ray_patches/resource_demand_scheduler.py.patch` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/ray_patches/resource_demand_scheduler.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/ray_patches/worker.py.patch` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/ray_patches/worker.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/skylet.py` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/skylet.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skylet/subprocess_daemon.py` & `skypilot_nightly-1.0.0.dev20240511/sky/skylet/subprocess_daemon.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/skypilot_config.py` & `skypilot_nightly-1.0.0.dev20240511/sky/skypilot_config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/status_lib.py` & `skypilot_nightly-1.0.0.dev20240511/sky/status_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/task.py` & `skypilot_nightly-1.0.0.dev20240511/sky/task.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/templates/aws-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240511/sky/templates/aws-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/templates/azure-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240511/sky/templates/azure-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/templates/cudo-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240511/sky/templates/cudo-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/templates/fluidstack-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240511/sky/templates/fluidstack-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/templates/gcp-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240511/sky/templates/gcp-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/templates/ibm-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240511/sky/templates/ibm-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/templates/jobs-controller.yaml.j2` & `skypilot_nightly-1.0.0.dev20240511/sky/templates/jobs-controller.yaml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/templates/kubernetes-ingress.yml.j2` & `skypilot_nightly-1.0.0.dev20240511/sky/templates/kubernetes-ingress.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/templates/kubernetes-port-forward-proxy-command.sh.j2` & `skypilot_nightly-1.0.0.dev20240511/sky/templates/kubernetes-port-forward-proxy-command.sh.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/templates/kubernetes-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240511/sky/templates/kubernetes-ray.yml.j2`

 * *Files 8% similar despite different names*

```diff
@@ -29,18 +29,21 @@
     # head node.
     use_internal_ips: true
 
     timeout: {{timeout}}
 
     ssh_jump_image: {{k8s_ssh_jump_image}}
 
+    # Namespace used to host SkyPilot system components, such as fuse device
+    # manager.
+    skypilot_system_namespace: {{k8s_skypilot_system_namespace}}
+
     # Boolean flag to indicate if the cluster requires FUSE mounting.
     # Used to set up the necessary permissions and sidecars.
     fuse_device_required: {{k8s_fuse_device_required}}
-    fuse_device_manager_namespace: {{k8s_fuse_device_manager_namespace}}
 
     # ServiceAccount created by the autoscaler for the head node pod that it
     # runs in. If this field isn't provided, the head pod config below must
     # contain a user-created service account with the proper permissions.
     autoscaler_service_account:
         apiVersion: v1
         kind: ServiceAccount
@@ -81,14 +84,45 @@
         - kind: ServiceAccount
           name: skypilot-service-account
         roleRef:
             kind: Role
             name: skypilot-service-account-role
             apiGroup: rbac.authorization.k8s.io
 
+    # Role for the skypilot-system namespace to create FUSE device manager and
+    # any other system components.
+    autoscaler_skypilot_system_role:
+        kind: Role
+        apiVersion: rbac.authorization.k8s.io/v1
+        metadata:
+            namespace: {{k8s_skypilot_system_namespace}}
+            labels:
+                parent: skypilot
+            name: skypilot-system-service-account-role
+        rules:
+        - apiGroups: ["*"]
+          resources: ["*"]
+          verbs: ["*"]
+
+    # RoleBinding for skypilot-system namespace role
+    autoscaler_skypilot_system_role_binding:
+        apiVersion: rbac.authorization.k8s.io/v1
+        kind: RoleBinding
+        metadata:
+            namespace: {{k8s_skypilot_system_namespace}}
+            labels:
+                parent: skypilot
+            name: skypilot-system-service-account-role-binding
+        subjects:
+        - kind: ServiceAccount
+          name: skypilot-service-account
+        roleRef:
+            kind: Role
+            name: skypilot-system-service-account-role
+            apiGroup: rbac.authorization.k8s.io
 
     # Role to access ingress services for fetching IP
     autoscaler_ingress_role:
         kind: Role
         apiVersion: rbac.authorization.k8s.io/v1
         metadata:
             namespace: ingress-nginx
@@ -97,15 +131,15 @@
                 parent: skypilot
         rules:
             - apiGroups: [ "" ]
               resources: [ "services" ]
               verbs: [ "list", "get", "watch" ]
             - apiGroups: [ "rbac.authorization.k8s.io" ]
               resources: [ "roles", "rolebindings" ]
-              verbs: [ "get", "list", "watch" ]
+              verbs: [ "get", "list", "watch", "patch" ]
 
     # RoleBinding to access ingress services for fetching IP
     autoscaler_ingress_role_binding:
         apiVersion: rbac.authorization.k8s.io/v1
         kind: RoleBinding
         metadata:
             namespace: ingress-nginx
@@ -130,17 +164,20 @@
             labels:
                 parent: skypilot
             name: skypilot-service-account-cluster-role
         rules:
         - apiGroups: [ "" ]
           resources: [ "nodes" ]  # Required for getting node resources.
           verbs: [ "get", "list", "watch" ]
+        - apiGroups: [ "" ]
+          resources: [ "namespaces" ]  # Required for creating skypilot-system namespace, which hosts fuse device manager.
+          verbs: [ "get", "list", "watch", "create" ]
         - apiGroups: [ "rbac.authorization.k8s.io" ]
           resources: [ "clusterroles", "clusterrolebindings" ]  # Required for launching more SkyPilot clusters from within the pod.
-          verbs: [ "get", "list", "watch" ]
+          verbs: [ "get", "list", "watch", "create", "update", "patch", "delete" ]
         - apiGroups: [ "node.k8s.io" ]
           resources: [ "runtimeclasses" ]   # Required for autodetecting the runtime class of the nodes.
           verbs: [ "get", "list", "watch" ]
         - apiGroups: [ "networking.k8s.io" ]   # Required for exposing services.
           resources: [ "ingressclasses" ]
           verbs: [ "get", "list", "watch" ]
```

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/templates/kubernetes-ssh-jump.yml.j2` & `skypilot_nightly-1.0.0.dev20240511/sky/templates/kubernetes-ssh-jump.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/templates/lambda-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240511/sky/templates/lambda-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/templates/local-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240511/sky/templates/local-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/templates/oci-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240511/sky/templates/oci-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/templates/paperspace-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240511/sky/templates/paperspace-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/templates/runpod-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240511/sky/templates/runpod-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/templates/scp-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240511/sky/templates/scp-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/templates/sky-serve-controller.yaml.j2` & `skypilot_nightly-1.0.0.dev20240511/sky/templates/sky-serve-controller.yaml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/templates/vsphere-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240511/sky/templates/vsphere-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/usage/constants.py` & `skypilot_nightly-1.0.0.dev20240511/sky/usage/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/usage/usage_lib.py` & `skypilot_nightly-1.0.0.dev20240511/sky/usage/usage_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/accelerator_registry.py` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/accelerator_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/cli_utils/status_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/cli_utils/status_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/cluster_yaml_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/cluster_yaml_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/command_runner.py` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/command_runner.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/command_runner.pyi` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/command_runner.pyi`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/common_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/common_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/controller_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/controller_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/dag_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/dag_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/db_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/db_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/env_options.py` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/env_options.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/kubernetes/create_cluster.sh` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/kubernetes/create_cluster.sh`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/kubernetes/delete_cluster.sh` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/kubernetes/delete_cluster.sh`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/kubernetes/generate_kind_config.py` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/kubernetes/generate_kind_config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/kubernetes/generate_static_kubeconfig.sh` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/kubernetes/generate_static_kubeconfig.sh`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/kubernetes/gpu_labeler.py` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/kubernetes/gpu_labeler.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/kubernetes_enums.py` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/kubernetes_enums.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/log_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/log_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/resources_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/resources_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/rich_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/rich_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/schemas.py` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/schemas.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/subprocess_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/subprocess_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/timeline.py` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/timeline.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/ux_utils.py` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/ux_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/sky/utils/validator.py` & `skypilot_nightly-1.0.0.dev20240511/sky/utils/validator.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/skypilot_nightly.egg-info/PKG-INFO` & `skypilot_nightly-1.0.0.dev20240511/skypilot_nightly.egg-info/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot-nightly
-Version: 1.0.0.dev20240510
+Version: 1.0.0.dev20240511
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
```

### Comparing `skypilot_nightly-1.0.0.dev20240510/skypilot_nightly.egg-info/SOURCES.txt` & `skypilot_nightly-1.0.0.dev20240511/skypilot_nightly.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/skypilot_nightly.egg-info/requires.txt` & `skypilot_nightly-1.0.0.dev20240511/skypilot_nightly.egg-info/requires.txt`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/tests/test_cli.py` & `skypilot_nightly-1.0.0.dev20240511/tests/test_cli.py`

 * *Files 9% similar despite different names*

```diff
@@ -44,18 +44,17 @@
 
         _capture_match_gpus_spec(f.name, 'V100:1')
         _capture_match_gpus_spec(f.name, 'v100:1')
         _capture_match_gpus_spec(f.name, 'V100')
 
 
 def test_show_gpus():
-    """
-    This is a test suite for `sky show-gpus` to check functionality (but not correctness).
-    The tests below correspond to the following terminal commands,
-    in order:
+    """Tests `sky show-gpus` can be invoked (but not correctness).
+
+    Tests below correspond to the following terminal commands, in order:
 
     -> sky show-gpus
     -> sky show-gpus --all
     -> sky show-gpus V100:4
     -> sky show-gpus :4
     -> sky show-gpus V100:0
     -> sky show-gpus V100:-2
```

### Comparing `skypilot_nightly-1.0.0.dev20240510/tests/test_config.py` & `skypilot_nightly-1.0.0.dev20240511/tests/test_config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/tests/test_jobs.py` & `skypilot_nightly-1.0.0.dev20240511/tests/test_jobs.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/tests/test_jobs_and_serve.py` & `skypilot_nightly-1.0.0.dev20240511/tests/test_jobs_and_serve.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/tests/test_list_accelerators.py` & `skypilot_nightly-1.0.0.dev20240511/tests/test_list_accelerators.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/tests/test_optimizer_dryruns.py` & `skypilot_nightly-1.0.0.dev20240511/tests/test_optimizer_dryruns.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/tests/test_optimizer_random_dag.py` & `skypilot_nightly-1.0.0.dev20240511/tests/test_optimizer_random_dag.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/tests/test_serve_autoscaler.py` & `skypilot_nightly-1.0.0.dev20240511/tests/test_serve_autoscaler.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/tests/test_smoke.py` & `skypilot_nightly-1.0.0.dev20240511/tests/test_smoke.py`

 * *Files 1% similar despite different names*

```diff
@@ -7561,5921 +7561,5922 @@
 0001d880: 7273 7061 6365 2020 2320 5061 7065 7273  rspace  # Papers
 0001d890: 7061 6365 2064 6f65 7320 6e6f 7420 7375  pace does not su
 0001d8a0: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
 0001d8b0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
 0001d8c0: 6b2e 6e6f 5f73 6370 2020 2320 5343 5020  k.no_scp  # SCP 
 0001d8d0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
 0001d8e0: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
-0001d8f0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-0001d900: 6b75 6265 726e 6574 6573 2020 2320 4b75  kubernetes  # Ku
-0001d910: 6265 726e 6574 6573 2064 6f65 7320 6e6f  bernetes does no
-0001d920: 7420 6861 7665 2061 206e 6f74 696f 6e20  t have a notion 
-0001d930: 6f66 2073 706f 7420 696e 7374 616e 6365  of spot instance
-0001d940: 730a 4070 7974 6573 742e 6d61 726b 2e6d  s.@pytest.mark.m
-0001d950: 616e 6167 6564 5f6a 6f62 730a 6465 6620  anaged_jobs.def 
-0001d960: 7465 7374 5f6d 616e 6167 6564 5f6a 6f62  test_managed_job
-0001d970: 735f 7374 6f72 6167 6528 6765 6e65 7269  s_storage(generi
-0001d980: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-0001d990: 2020 2022 2222 5465 7374 2073 746f 7261     """Test stora
-0001d9a0: 6765 2077 6974 6820 6d61 6e61 6765 6420  ge with managed 
-0001d9b0: 6a6f 6222 2222 0a20 2020 206e 616d 6520  job""".    name 
-0001d9c0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0001d9d0: 616d 6528 290a 2020 2020 7961 6d6c 5f73  ame().    yaml_s
-0001d9e0: 7472 203d 2070 6174 686c 6962 2e50 6174  tr = pathlib.Pat
-0001d9f0: 6828 0a20 2020 2020 2020 2027 6578 616d  h(.        'exam
-0001da00: 706c 6573 2f6d 616e 6167 6564 5f6a 6f62  ples/managed_job
-0001da10: 5f77 6974 685f 7374 6f72 6167 652e 7961  _with_storage.ya
-0001da20: 6d6c 2729 2e72 6561 645f 7465 7874 2829  ml').read_text()
-0001da30: 0a20 2020 2073 746f 7261 6765 5f6e 616d  .    storage_nam
-0001da40: 6520 3d20 6627 736b 792d 7465 7374 2d7b  e = f'sky-test-{
-0001da50: 696e 7428 7469 6d65 2e74 696d 6528 2929  int(time.time())
-0001da60: 7d27 0a0a 2020 2020 2320 416c 736f 2070  }'..    # Also p
-0001da70: 6572 666f 726d 2072 6567 696f 6e20 7465  erform region te
-0001da80: 7374 696e 6720 666f 7220 6275 636b 6574  sting for bucket
-0001da90: 2063 7265 6174 696f 6e20 746f 2076 616c   creation to val
-0001daa0: 6964 6174 6520 6966 2062 7563 6b65 7473  idate if buckets
-0001dab0: 2061 7265 0a20 2020 2023 2063 7265 6174   are.    # creat
-0001dac0: 6564 2069 6e20 7468 6520 636f 7272 6563  ed in the correc
-0001dad0: 7420 7265 6769 6f6e 2061 6e64 2063 6f72  t region and cor
-0001dae0: 7265 6374 6c79 206d 6f75 6e74 6564 2069  rectly mounted i
-0001daf0: 6e20 6d61 6e61 6765 6420 6a6f 6273 2e0a  n managed jobs..
-0001db00: 2020 2020 2320 486f 7765 7665 722c 2077      # However, w
-0001db10: 6520 696e 6a65 6374 2074 6869 7320 7465  e inject this te
-0001db20: 7374 696e 6720 6f6e 6c79 2066 6f72 2041  sting only for A
-0001db30: 5753 2061 6e64 2047 4350 2073 696e 6365  WS and GCP since
-0001db40: 2074 6865 7920 6172 6520 7468 650a 2020   they are the.  
-0001db50: 2020 2320 7375 7070 6f72 7465 6420 6f62    # supported ob
-0001db60: 6a65 6374 2073 746f 7261 6765 2070 726f  ject storage pro
-0001db70: 7669 6465 7273 2069 6e20 536b 7950 696c  viders in SkyPil
-0001db80: 6f74 2e0a 2020 2020 7265 6769 6f6e 5f66  ot..    region_f
-0001db90: 6c61 6720 3d20 2727 0a20 2020 2072 6567  lag = ''.    reg
-0001dba0: 696f 6e5f 7661 6c69 6461 7469 6f6e 5f63  ion_validation_c
-0001dbb0: 6d64 203d 2027 7472 7565 270a 2020 2020  md = 'true'.    
-0001dbc0: 6966 2067 656e 6572 6963 5f63 6c6f 7564  if generic_cloud
-0001dbd0: 203d 3d20 2761 7773 273a 0a20 2020 2020   == 'aws':.     
-0001dbe0: 2020 2072 6567 696f 6e20 3d20 2765 752d     region = 'eu-
-0001dbf0: 6365 6e74 7261 6c2d 3127 0a20 2020 2020  central-1'.     
-0001dc00: 2020 2072 6567 696f 6e5f 666c 6167 203d     region_flag =
-0001dc10: 2066 2720 2d2d 7265 6769 6f6e 207b 7265   f' --region {re
-0001dc20: 6769 6f6e 7d27 0a20 2020 2020 2020 2072  gion}'.        r
-0001dc30: 6567 696f 6e5f 636d 6420 3d20 5465 7374  egion_cmd = Test
-0001dc40: 5374 6f72 6167 6557 6974 6843 7265 6465  StorageWithCrede
-0001dc50: 6e74 6961 6c73 2e63 6c69 5f72 6567 696f  ntials.cli_regio
-0001dc60: 6e5f 636d 6428 0a20 2020 2020 2020 2020  n_cmd(.         
-0001dc70: 2020 2073 746f 7261 6765 5f6c 6962 2e53     storage_lib.S
-0001dc80: 746f 7265 5479 7065 2e53 332c 2073 746f  toreType.S3, sto
-0001dc90: 7261 6765 5f6e 616d 6529 0a20 2020 2020  rage_name).     
-0001dca0: 2020 2072 6567 696f 6e5f 7661 6c69 6461     region_valida
-0001dcb0: 7469 6f6e 5f63 6d64 203d 2066 277b 7265  tion_cmd = f'{re
-0001dcc0: 6769 6f6e 5f63 6d64 7d20 7c20 6772 6570  gion_cmd} | grep
-0001dcd0: 207b 7265 6769 6f6e 7d27 0a20 2020 2065   {region}'.    e
-0001dce0: 6c69 6620 6765 6e65 7269 635f 636c 6f75  lif generic_clou
-0001dcf0: 6420 3d3d 2027 6763 7027 3a0a 2020 2020  d == 'gcp':.    
-0001dd00: 2020 2020 7265 6769 6f6e 203d 2027 7573      region = 'us
-0001dd10: 2d77 6573 7432 270a 2020 2020 2020 2020  -west2'.        
-0001dd20: 7265 6769 6f6e 5f66 6c61 6720 3d20 6627  region_flag = f'
-0001dd30: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-0001dd40: 6e7d 270a 2020 2020 2020 2020 7265 6769  n}'.        regi
-0001dd50: 6f6e 5f63 6d64 203d 2054 6573 7453 746f  on_cmd = TestSto
-0001dd60: 7261 6765 5769 7468 4372 6564 656e 7469  rageWithCredenti
-0001dd70: 616c 732e 636c 695f 7265 6769 6f6e 5f63  als.cli_region_c
-0001dd80: 6d64 280a 2020 2020 2020 2020 2020 2020  md(.            
-0001dd90: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0001dda0: 6554 7970 652e 4743 532c 2073 746f 7261  eType.GCS, stora
-0001ddb0: 6765 5f6e 616d 6529 0a20 2020 2020 2020  ge_name).       
-0001ddc0: 2072 6567 696f 6e5f 7661 6c69 6461 7469   region_validati
-0001ddd0: 6f6e 5f63 6d64 203d 2066 277b 7265 6769  on_cmd = f'{regi
-0001dde0: 6f6e 5f63 6d64 7d20 7c20 6772 6570 207b  on_cmd} | grep {
-0001ddf0: 7265 6769 6f6e 7d27 0a0a 2020 2020 7961  region}'..    ya
-0001de00: 6d6c 5f73 7472 203d 2079 616d 6c5f 7374  ml_str = yaml_st
-0001de10: 722e 7265 706c 6163 6528 2773 6b79 2d77  r.replace('sky-w
-0001de20: 6f72 6b64 6972 2d7a 6877 7527 2c20 7374  orkdir-zhwu', st
-0001de30: 6f72 6167 655f 6e61 6d65 290a 2020 2020  orage_name).    
-0001de40: 7769 7468 2074 656d 7066 696c 652e 4e61  with tempfile.Na
-0001de50: 6d65 6454 656d 706f 7261 7279 4669 6c65  medTemporaryFile
-0001de60: 2873 7566 6669 783d 272e 7961 6d6c 272c  (suffix='.yaml',
-0001de70: 206d 6f64 653d 2777 2729 2061 7320 663a   mode='w') as f:
-0001de80: 0a20 2020 2020 2020 2066 2e77 7269 7465  .        f.write
-0001de90: 2879 616d 6c5f 7374 7229 0a20 2020 2020  (yaml_str).     
-0001dea0: 2020 2066 2e66 6c75 7368 2829 0a20 2020     f.flush().   
-0001deb0: 2020 2020 2066 696c 655f 7061 7468 203d       file_path =
-0001dec0: 2066 2e6e 616d 650a 2020 2020 2020 2020   f.name.        
-0001ded0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-0001dee0: 2020 2020 2020 2020 2027 6d61 6e61 6765           'manage
-0001def0: 645f 6a6f 6273 5f73 746f 7261 6765 272c  d_jobs_storage',
-0001df00: 0a20 2020 2020 2020 2020 2020 205b 0a20  .            [. 
-0001df10: 2020 2020 2020 2020 2020 2020 2020 202a                 *
-0001df20: 7374 6f72 6167 655f 7365 7475 705f 636f  storage_setup_co
-0001df30: 6d6d 616e 6473 2c0a 2020 2020 2020 2020  mmands,.        
-0001df40: 2020 2020 2020 2020 6627 736b 7920 6a6f          f'sky jo
-0001df50: 6273 206c 6175 6e63 6820 2d6e 207b 6e61  bs launch -n {na
-0001df60: 6d65 7d20 2d2d 7573 652d 7370 6f74 202d  me} --use-spot -
-0001df70: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-0001df80: 636c 6f75 647d 7b72 6567 696f 6e5f 666c  cloud}{region_fl
-0001df90: 6167 7d20 7b66 696c 655f 7061 7468 7d20  ag} {file_path} 
-0001dfa0: 2d79 272c 0a20 2020 2020 2020 2020 2020  -y',.           
-0001dfb0: 2020 2020 2072 6567 696f 6e5f 7661 6c69       region_vali
-0001dfc0: 6461 7469 6f6e 5f63 6d64 2c20 2023 2043  dation_cmd,  # C
-0001dfd0: 6865 636b 2069 6620 7468 6520 6275 636b  heck if the buck
-0001dfe0: 6574 2069 7320 6372 6561 7465 6420 696e  et is created in
-0001dff0: 2074 6865 2063 6f72 7265 6374 2072 6567   the correct reg
-0001e000: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
-0001e010: 2020 2020 2773 6c65 6570 2036 3027 2c20      'sleep 60', 
-0001e020: 2023 2057 6169 7420 7468 6520 7370 6f74   # Wait the spot
-0001e030: 2071 7565 7565 2074 6f20 6265 2075 7064   queue to be upd
-0001e040: 6174 6564 0a20 2020 2020 2020 2020 2020  ated.           
-0001e050: 2020 2020 2066 277b 5f4a 4f42 5f51 5545       f'{_JOB_QUE
-0001e060: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-0001e070: 6e61 6d65 7d20 7c20 6772 6570 2053 5543  name} | grep SUC
-0001e080: 4345 4544 4544 272c 0a20 2020 2020 2020  CEEDED',.       
-0001e090: 2020 2020 2020 2020 2066 275b 2024 2861           f'[ $(a
-0001e0a0: 7773 2073 3361 7069 206c 6973 742d 6275  ws s3api list-bu
-0001e0b0: 636b 6574 7320 2d2d 7175 6572 7920 2242  ckets --query "B
-0001e0c0: 7563 6b65 7473 5b3f 636f 6e74 6169 6e73  uckets[?contains
-0001e0d0: 284e 616d 652c 205c 277b 7374 6f72 6167  (Name, \'{storag
-0001e0e0: 655f 6e61 6d65 7d5c 2729 5d2e 4e61 6d65  e_name}\')].Name
-0001e0f0: 2220 2d2d 6f75 7470 7574 2074 6578 7420  " --output text 
-0001e100: 7c20 7763 202d 6c29 202d 6571 2030 205d  | wc -l) -eq 0 ]
-0001e110: 270a 2020 2020 2020 2020 2020 2020 5d2c  '.            ],
-0001e120: 0a20 2020 2020 2020 2020 2020 205f 4a4f  .            _JO
-0001e130: 425f 4341 4e43 454c 5f57 4149 542e 666f  B_CANCEL_WAIT.fo
-0001e140: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
-0001e150: 6d65 292c 0a20 2020 2020 2020 2020 2020  me),.           
-0001e160: 2023 2049 6e63 7265 6173 6520 7469 6d65   # Increase time
-0001e170: 6f75 7420 7369 6e63 6520 736b 7920 6a6f  out since sky jo
-0001e180: 6273 2071 7565 7565 202d 7220 6361 6e20  bs queue -r can 
-0001e190: 6265 2062 6c6f 636b 6564 2062 7920 6f74  be blocked by ot
-0001e1a0: 6865 7220 7370 6f74 2074 6573 7473 2e0a  her spot tests..
-0001e1b0: 2020 2020 2020 2020 2020 2020 7469 6d65              time
-0001e1c0: 6f75 743d 3230 202a 2036 302c 0a20 2020  out=20 * 60,.   
-0001e1d0: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-0001e1e0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-0001e1f0: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
-0001e200: 2054 6573 7469 6e67 2073 706f 7420 5450   Testing spot TP
-0001e210: 5520 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  U ----------.@py
-0001e220: 7465 7374 2e6d 6172 6b2e 6763 700a 4070  test.mark.gcp.@p
-0001e230: 7974 6573 742e 6d61 726b 2e6d 616e 6167  ytest.mark.manag
-0001e240: 6564 5f6a 6f62 730a 4070 7974 6573 742e  ed_jobs.@pytest.
-0001e250: 6d61 726b 2e74 7075 0a64 6566 2074 6573  mark.tpu.def tes
-0001e260: 745f 6d61 6e61 6765 645f 6a6f 6273 5f74  t_managed_jobs_t
-0001e270: 7075 2829 3a0a 2020 2020 2222 2254 6573  pu():.    """Tes
-0001e280: 7420 6d61 6e61 6765 6420 6a6f 6220 6f6e  t managed job on
-0001e290: 2054 5055 2e22 2222 0a20 2020 206e 616d   TPU.""".    nam
-0001e2a0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-0001e2b0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-0001e2c0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-0001e2d0: 2027 7465 7374 2d73 706f 742d 7470 7527   'test-spot-tpu'
-0001e2e0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-0001e2f0: 2020 2020 2020 2020 6627 736b 7920 6a6f          f'sky jo
-0001e300: 6273 206c 6175 6e63 6820 2d6e 207b 6e61  bs launch -n {na
-0001e310: 6d65 7d20 2d2d 7573 652d 7370 6f74 2065  me} --use-spot e
-0001e320: 7861 6d70 6c65 732f 7470 752f 7470 7576  xamples/tpu/tpuv
-0001e330: 6d5f 6d6e 6973 742e 7961 6d6c 202d 7920  m_mnist.yaml -y 
-0001e340: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
-0001e350: 2027 736c 6565 7020 3527 2c0a 2020 2020   'sleep 5',.    
-0001e360: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
-0001e370: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-0001e380: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
-0001e390: 2d6e 3120 7c20 6772 6570 2053 5441 5254  -n1 | grep START
-0001e3a0: 494e 4727 2c0a 2020 2020 2020 2020 2020  ING',.          
-0001e3b0: 2020 2773 6c65 6570 2039 3030 272c 2020    'sleep 900',  
-0001e3c0: 2320 5450 5520 7461 6b65 7320 6120 7768  # TPU takes a wh
-0001e3d0: 696c 6520 746f 206c 6175 6e63 680a 2020  ile to launch.  
-0001e3e0: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
-0001e3f0: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
-0001e400: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
-0001e410: 6420 2d6e 3120 7c20 6772 6570 2022 5255  d -n1 | grep "RU
-0001e420: 4e4e 494e 475c 7c53 5543 4345 4544 4544  NNING\|SUCCEEDED
-0001e430: 2227 2c0a 2020 2020 2020 2020 5d2c 0a20  "',.        ],. 
-0001e440: 2020 2020 2020 205f 4a4f 425f 4341 4e43         _JOB_CANC
-0001e450: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
-0001e460: 6f62 5f6e 616d 653d 6e61 6d65 292c 0a20  ob_name=name),. 
-0001e470: 2020 2020 2020 2023 2049 6e63 7265 6173         # Increas
-0001e480: 6520 7469 6d65 6f75 7420 7369 6e63 6520  e timeout since 
-0001e490: 736b 7920 6a6f 6273 2071 7565 7565 202d  sky jobs queue -
-0001e4a0: 7220 6361 6e20 6265 2062 6c6f 636b 6564  r can be blocked
-0001e4b0: 2062 7920 6f74 6865 7220 7370 6f74 2074   by other spot t
-0001e4c0: 6573 7473 2e0a 2020 2020 2020 2020 7469  ests..        ti
-0001e4d0: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
-0001e4e0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-0001e4f0: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-0001e500: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7469  ---------- Testi
-0001e510: 6e67 2065 6e76 2066 6f72 206d 616e 6167  ng env for manag
-0001e520: 6564 206a 6f62 7320 2d2d 2d2d 2d2d 2d2d  ed jobs --------
-0001e530: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
-0001e540: 6d61 6e61 6765 645f 6a6f 6273 0a64 6566  managed_jobs.def
-0001e550: 2074 6573 745f 6d61 6e61 6765 645f 6a6f   test_managed_jo
-0001e560: 6273 5f69 6e6c 696e 655f 656e 7628 6765  bs_inline_env(ge
-0001e570: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
-0001e580: 293a 0a20 2020 2022 2222 5465 7374 206d  ):.    """Test m
-0001e590: 616e 6167 6564 206a 6f62 7320 656e 7622  anaged jobs env"
-0001e5a0: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
-0001e5b0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-0001e5c0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-0001e5d0: 7428 0a20 2020 2020 2020 2027 7465 7374  t(.        'test
-0001e5e0: 2d6d 616e 6167 6564 2d6a 6f62 732d 696e  -managed-jobs-in
-0001e5f0: 6c69 6e65 2d65 6e76 272c 0a20 2020 2020  line-env',.     
-0001e600: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-0001e610: 2066 2773 6b79 206a 6f62 7320 6c61 756e   f'sky jobs laun
-0001e620: 6368 202d 6e20 7b6e 616d 657d 202d 7920  ch -n {name} -y 
-0001e630: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-0001e640: 5f63 6c6f 7564 7d20 2d2d 656e 7620 5445  _cloud} --env TE
-0001e650: 5354 5f45 4e56 3d22 6865 6c6c 6f20 776f  ST_ENV="hello wo
-0001e660: 726c 6422 202d 2d20 2228 5b5b 2021 202d  rld" -- "([[ ! -
-0001e670: 7a20 5c5c 225c 2454 4553 545f 454e 565c  z \\"\$TEST_ENV\
-0001e680: 5c22 205d 5d20 2626 205b 5b20 2120 2d7a  \" ]] && [[ ! -z
-0001e690: 205c 5c22 5c24 534b 5950 494c 4f54 5f4e   \\"\$SKYPILOT_N
-0001e6a0: 4f44 455f 4950 535c 5c22 205d 5d20 2626  ODE_IPS\\" ]] &&
-0001e6b0: 205b 5b20 2120 2d7a 205c 5c22 5c24 534b   [[ ! -z \\"\$SK
-0001e6c0: 5950 494c 4f54 5f4e 4f44 455f 5241 4e4b  YPILOT_NODE_RANK
-0001e6d0: 5c5c 2220 5d5d 2920 7c7c 2065 7869 7420  \\" ]]) || exit 
-0001e6e0: 3122 272c 0a20 2020 2020 2020 2020 2020  1"',.           
-0001e6f0: 2027 736c 6565 7020 3230 272c 0a20 2020   'sleep 20',.   
-0001e700: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
-0001e710: 5f51 5545 5545 5f57 4149 547d 207c 2067  _QUEUE_WAIT} | g
-0001e720: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-0001e730: 7020 5355 4343 4545 4445 4427 2c0a 2020  p SUCCEEDED',.  
-0001e740: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0001e750: 205f 4a4f 425f 4341 4e43 454c 5f57 4149   _JOB_CANCEL_WAI
-0001e760: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
-0001e770: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
-0001e780: 2023 2049 6e63 7265 6173 6520 7469 6d65   # Increase time
-0001e790: 6f75 7420 7369 6e63 6520 736b 7920 6a6f  out since sky jo
-0001e7a0: 6273 2071 7565 7565 202d 7220 6361 6e20  bs queue -r can 
-0001e7b0: 6265 2062 6c6f 636b 6564 2062 7920 6f74  be blocked by ot
-0001e7c0: 6865 7220 7370 6f74 2074 6573 7473 2e0a  her spot tests..
-0001e7d0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-0001e7e0: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
-0001e7f0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-0001e800: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-0001e810: 2d2d 2d2d 2054 6573 7469 6e67 2065 6e76  ---- Testing env
-0001e820: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 6465 6620   ----------.def 
-0001e830: 7465 7374 5f69 6e6c 696e 655f 656e 7628  test_inline_env(
-0001e840: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-0001e850: 7472 293a 0a20 2020 2022 2222 5465 7374  tr):.    """Test
-0001e860: 2065 6e76 2222 220a 2020 2020 6e61 6d65   env""".    name
-0001e870: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-0001e880: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-0001e890: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-0001e8a0: 2774 6573 742d 696e 6c69 6e65 2d65 6e76  'test-inline-env
-0001e8b0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-0001e8c0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0001e8d0: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
-0001e8e0: 2d79 202d 2d63 6c6f 7564 207b 6765 6e65  -y --cloud {gene
-0001e8f0: 7269 635f 636c 6f75 647d 202d 2d65 6e76  ric_cloud} --env
-0001e900: 2054 4553 545f 454e 563d 2268 656c 6c6f   TEST_ENV="hello
-0001e910: 2077 6f72 6c64 2220 2d2d 2022 285b 5b20   world" -- "([[ 
-0001e920: 2120 2d7a 205c 5c22 5c24 5445 5354 5f45  ! -z \\"\$TEST_E
-0001e930: 4e56 5c5c 2220 5d5d 2026 2620 5b5b 2021  NV\\" ]] && [[ !
-0001e940: 202d 7a20 5c5c 225c 2453 4b59 5049 4c4f   -z \\"\$SKYPILO
-0001e950: 545f 4e4f 4445 5f49 5053 5c5c 2220 5d5d  T_NODE_IPS\\" ]]
-0001e960: 2026 2620 5b5b 2021 202d 7a20 5c5c 225c   && [[ ! -z \\"\
-0001e970: 2453 4b59 5049 4c4f 545f 4e4f 4445 5f52  $SKYPILOT_NODE_R
-0001e980: 414e 4b5c 5c22 205d 5d29 207c 7c20 6578  ANK\\" ]]) || ex
-0001e990: 6974 2031 2227 2c0a 2020 2020 2020 2020  it 1"',.        
-0001e9a0: 2020 2020 2773 6c65 6570 2032 3027 2c0a      'sleep 20',.
-0001e9b0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0001e9c0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-0001e9d0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-0001e9e0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-0001e9f0: 6320 7b6e 616d 657d 202d 2d65 6e76 2054  c {name} --env T
-0001ea00: 4553 545f 454e 5632 3d22 7375 6363 6573  EST_ENV2="succes
-0001ea10: 7322 2022 285b 5b20 2120 2d7a 205c 5c22  s" "([[ ! -z \\"
-0001ea20: 5c24 5445 5354 5f45 4e56 325c 5c22 205d  \$TEST_ENV2\\" ]
-0001ea30: 5d20 2626 205b 5b20 2120 2d7a 205c 5c22  ] && [[ ! -z \\"
-0001ea40: 5c24 534b 5950 494c 4f54 5f4e 4f44 455f  \$SKYPILOT_NODE_
-0001ea50: 4950 535c 5c22 205d 5d20 2626 205b 5b20  IPS\\" ]] && [[ 
-0001ea60: 2120 2d7a 205c 5c22 5c24 534b 5950 494c  ! -z \\"\$SKYPIL
-0001ea70: 4f54 5f4e 4f44 455f 5241 4e4b 5c5c 2220  OT_NODE_RANK\\" 
-0001ea80: 5d5d 2920 7c7c 2065 7869 7420 3122 272c  ]]) || exit 1"',
-0001ea90: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0001eaa0: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
-0001eab0: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-0001eac0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-0001ead0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-0001eae0: 6d65 7d27 2c0a 2020 2020 2020 2020 5f67  me}',.        _g
-0001eaf0: 6574 5f74 696d 656f 7574 2867 656e 6572  et_timeout(gener
-0001eb00: 6963 5f63 6c6f 7564 292c 0a20 2020 2029  ic_cloud),.    )
-0001eb10: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-0001eb20: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
-0001eb30: 2d2d 2d2d 2d2d 2054 6573 7469 6e67 2065  ------ Testing e
-0001eb40: 6e76 2066 696c 6520 2d2d 2d2d 2d2d 2d2d  nv file --------
-0001eb50: 2d2d 0a64 6566 2074 6573 745f 696e 6c69  --.def test_inli
-0001eb60: 6e65 5f65 6e76 5f66 696c 6528 6765 6e65  ne_env_file(gene
-0001eb70: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
-0001eb80: 0a20 2020 2022 2222 5465 7374 2065 6e76  .    """Test env
-0001eb90: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
-0001eba0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-0001ebb0: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-0001ebc0: 7374 280a 2020 2020 2020 2020 2774 6573  st(.        'tes
-0001ebd0: 742d 696e 6c69 6e65 2d65 6e76 2d66 696c  t-inline-env-fil
-0001ebe0: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
-0001ebf0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0001ec00: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
-0001ec10: 202d 7920 2d2d 636c 6f75 6420 7b67 656e   -y --cloud {gen
-0001ec20: 6572 6963 5f63 6c6f 7564 7d20 2d2d 656e  eric_cloud} --en
-0001ec30: 7620 5445 5354 5f45 4e56 3d22 6865 6c6c  v TEST_ENV="hell
-0001ec40: 6f20 776f 726c 6422 202d 2d20 2228 5b5b  o world" -- "([[
-0001ec50: 2021 202d 7a20 5c5c 225c 2454 4553 545f   ! -z \\"\$TEST_
-0001ec60: 454e 565c 5c22 205d 5d20 2626 205b 5b20  ENV\\" ]] && [[ 
-0001ec70: 2120 2d7a 205c 5c22 5c24 534b 5950 494c  ! -z \\"\$SKYPIL
-0001ec80: 4f54 5f4e 4f44 455f 4950 535c 5c22 205d  OT_NODE_IPS\\" ]
-0001ec90: 5d20 2626 205b 5b20 2120 2d7a 205c 5c22  ] && [[ ! -z \\"
-0001eca0: 5c24 534b 5950 494c 4f54 5f4e 4f44 455f  \$SKYPILOT_NODE_
-0001ecb0: 5241 4e4b 5c5c 2220 5d5d 2920 7c7c 2065  RANK\\" ]]) || e
-0001ecc0: 7869 7420 3122 272c 0a20 2020 2020 2020  xit 1"',.       
-0001ecd0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-0001ece0: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-0001ecf0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-0001ed00: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-0001ed10: 7d20 2d2d 656e 762d 6669 6c65 2065 7861  } --env-file exa
-0001ed20: 6d70 6c65 732f 7361 6d70 6c65 5f64 6f74  mples/sample_dot
-0001ed30: 656e 7620 2228 5b5b 2021 202d 7a20 5c5c  env "([[ ! -z \\
-0001ed40: 225c 2454 4553 545f 454e 5632 5c5c 2220  "\$TEST_ENV2\\" 
-0001ed50: 5d5d 2026 2620 5b5b 2021 202d 7a20 5c5c  ]] && [[ ! -z \\
-0001ed60: 225c 2453 4b59 5049 4c4f 545f 4e4f 4445  "\$SKYPILOT_NODE
-0001ed70: 5f49 5053 5c5c 2220 5d5d 2026 2620 5b5b  _IPS\\" ]] && [[
-0001ed80: 2021 202d 7a20 5c5c 225c 2453 4b59 5049   ! -z \\"\$SKYPI
-0001ed90: 4c4f 545f 4e4f 4445 5f52 414e 4b5c 5c22  LOT_NODE_RANK\\"
-0001eda0: 205d 5d29 207c 7c20 6578 6974 2031 2227   ]]) || exit 1"'
-0001edb0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001edc0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0001edd0: 3220 2d2d 7374 6174 7573 272c 0a20 2020  2 --status',.   
-0001ede0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0001edf0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-0001ee00: 616d 657d 272c 0a20 2020 2020 2020 205f  ame}',.        _
-0001ee10: 6765 745f 7469 6d65 6f75 7428 6765 6e65  get_timeout(gene
-0001ee20: 7269 635f 636c 6f75 6429 2c0a 2020 2020  ric_cloud),.    
-0001ee30: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-0001ee40: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-0001ee50: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
-0001ee60: 6375 7374 6f6d 2069 6d61 6765 202d 2d2d  custom image ---
-0001ee70: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
-0001ee80: 6d61 726b 2e61 7773 0a64 6566 2074 6573  mark.aws.def tes
-0001ee90: 745f 6177 735f 6375 7374 6f6d 5f69 6d61  t_aws_custom_ima
-0001eea0: 6765 2829 3a0a 2020 2020 2222 2254 6573  ge():.    """Tes
-0001eeb0: 7420 4157 5320 6375 7374 6f6d 2069 6d61  t AWS custom ima
-0001eec0: 6765 2222 220a 2020 2020 6e61 6d65 203d  ge""".    name =
-0001eed0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-0001eee0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-0001eef0: 5465 7374 280a 2020 2020 2020 2020 2774  Test(.        't
-0001ef00: 6573 742d 6177 732d 6375 7374 6f6d 2d69  est-aws-custom-i
-0001ef10: 6d61 6765 272c 0a20 2020 2020 2020 205b  mage',.        [
-0001ef20: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0001ef30: 6b79 206c 6175 6e63 6820 2d63 207b 6e61  ky launch -c {na
-0001ef40: 6d65 7d20 2d2d 7265 7472 792d 756e 7469  me} --retry-unti
-0001ef50: 6c2d 7570 202d 7920 7465 7374 732f 7465  l-up -y tests/te
-0001ef60: 7374 5f79 616d 6c73 2f74 6573 745f 6375  st_yamls/test_cu
-0001ef70: 7374 6f6d 5f69 6d61 6765 2e79 616d 6c20  stom_image.yaml 
-0001ef80: 2d2d 636c 6f75 6420 6177 7320 2d2d 7265  --cloud aws --re
-0001ef90: 6769 6f6e 2075 732d 6561 7374 2d32 202d  gion us-east-2 -
-0001efa0: 2d69 6d61 6765 2d69 6420 616d 692d 3036  -image-id ami-06
-0001efb0: 3264 6464 3930 6662 3666 3832 3637 6127  2ddd90fb6f8267a'
-0001efc0: 2c20 2023 204e 7669 6469 6120 696d 6167  ,  # Nvidia imag
-0001efd0: 650a 2020 2020 2020 2020 2020 2020 6627  e.            f'
-0001efe0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0001eff0: 3120 2d2d 7374 6174 7573 272c 0a20 2020  1 --status',.   
-0001f000: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0001f010: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-0001f020: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
-0001f030: 696d 656f 7574 3d33 3020 2a20 3630 2c0a  imeout=30 * 60,.
-0001f040: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-0001f050: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-0001f060: 7079 7465 7374 2e6d 6172 6b2e 6b75 6265  pytest.mark.kube
-0001f070: 726e 6574 6573 0a40 7079 7465 7374 2e6d  rnetes.@pytest.m
-0001f080: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
-0001f090: 0a20 2020 2027 696d 6167 655f 6964 272c  .    'image_id',
-0001f0a0: 0a20 2020 205b 0a20 2020 2020 2020 2027  .    [.        '
-0001f0b0: 646f 636b 6572 3a6e 7669 6469 612f 6375  docker:nvidia/cu
-0001f0c0: 6461 3a31 312e 382e 302d 6465 7665 6c2d  da:11.8.0-devel-
-0001f0d0: 7562 756e 7475 3138 2e30 3427 2c0a 2020  ubuntu18.04',.  
-0001f0e0: 2020 2020 2020 2764 6f63 6b65 723a 7562        'docker:ub
-0001f0f0: 756e 7475 3a31 382e 3034 272c 0a20 2020  untu:18.04',.   
-0001f100: 2020 2020 2023 2054 6573 7420 6c61 7465       # Test late
-0001f110: 7374 2069 6d61 6765 2077 6974 6820 7079  st image with py
-0001f120: 7468 6f6e 2033 2e31 3120 696e 7374 616c  thon 3.11 instal
-0001f130: 6c65 6420 6279 2064 6566 6175 6c74 2e0a  led by default..
-0001f140: 2020 2020 2020 2020 2320 446f 6573 206e          # Does n
-0001f150: 6f74 2077 6f72 6b20 666f 7220 7079 7468  ot work for pyth
-0001f160: 6f6e 2033 2e31 3220 6475 6520 746f 2072  on 3.12 due to r
-0001f170: 6179 2773 2072 6571 7569 7265 6d65 6e74  ay's requirement
-0001f180: 2066 6f72 2033 2e31 312e 0a20 2020 2020   for 3.11..     
-0001f190: 2020 2027 646f 636b 6572 3a63 6f6e 7469     'docker:conti
-0001f1a0: 6e75 756d 696f 2f6d 696e 6963 6f6e 6461  nuumio/miniconda
-0001f1b0: 333a 3234 2e31 2e32 2d30 272c 0a20 2020  3:24.1.2-0',.   
-0001f1c0: 205d 290a 6465 6620 7465 7374 5f6b 7562   ]).def test_kub
-0001f1d0: 6572 6e65 7465 735f 6375 7374 6f6d 5f69  ernetes_custom_i
-0001f1e0: 6d61 6765 2869 6d61 6765 5f69 6429 3a0a  mage(image_id):.
-0001f1f0: 2020 2020 2222 2254 6573 7420 4b75 6265      """Test Kube
-0001f200: 726e 6574 6573 2063 7573 746f 6d20 696d  rnetes custom im
-0001f210: 6167 6522 2222 0a20 2020 206e 616d 6520  age""".    name 
-0001f220: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0001f230: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-0001f240: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-0001f250: 7465 7374 2d6b 7562 6572 6e65 7465 732d  test-kubernetes-
-0001f260: 6375 7374 6f6d 2d69 6d61 6765 272c 0a20  custom-image',. 
-0001f270: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0001f280: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-0001f290: 6820 2d63 207b 6e61 6d65 7d20 2d2d 7265  h -c {name} --re
-0001f2a0: 7472 792d 756e 7469 6c2d 7570 202d 7920  try-until-up -y 
-0001f2b0: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-0001f2c0: 2f74 6573 745f 6375 7374 6f6d 5f69 6d61  /test_custom_ima
-0001f2d0: 6765 2e79 616d 6c20 2d2d 636c 6f75 6420  ge.yaml --cloud 
-0001f2e0: 6b75 6265 726e 6574 6573 202d 2d69 6d61  kubernetes --ima
-0001f2f0: 6765 2d69 6420 7b69 6d61 6765 5f69 647d  ge-id {image_id}
-0001f300: 202d 2d72 6567 696f 6e20 4e6f 6e65 202d   --region None -
-0001f310: 2d67 7075 7320 5434 3a31 272c 0a20 2020  -gpus T4:1',.   
-0001f320: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0001f330: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-0001f340: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-0001f350: 2020 2020 2320 5472 7920 6578 6563 2074      # Try exec t
-0001f360: 6f20 7275 6e20 6167 6169 6e20 616e 6420  o run again and 
-0001f370: 6368 6563 6b20 6966 2074 6865 206c 6f67  check if the log
-0001f380: 7320 6172 6520 7072 696e 7465 640a 2020  s are printed.  
-0001f390: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0001f3a0: 6578 6563 207b 6e61 6d65 7d20 7465 7374  exec {name} test
-0001f3b0: 732f 7465 7374 5f79 616d 6c73 2f74 6573  s/test_yamls/tes
-0001f3c0: 745f 6375 7374 6f6d 5f69 6d61 6765 2e79  t_custom_image.y
-0001f3d0: 616d 6c20 2d2d 636c 6f75 6420 6b75 6265  aml --cloud kube
-0001f3e0: 726e 6574 6573 202d 2d69 6d61 6765 2d69  rnetes --image-i
-0001f3f0: 6420 7b69 6d61 6765 5f69 647d 202d 2d72  d {image_id} --r
-0001f400: 6567 696f 6e20 4e6f 6e65 202d 2d67 7075  egion None --gpu
-0001f410: 7320 5434 3a31 207c 2067 7265 7020 2248  s T4:1 | grep "H
-0001f420: 656c 6c6f 2031 3030 2227 2c0a 2020 2020  ello 100"',.    
-0001f430: 2020 2020 2020 2020 2320 4d61 6b65 2073          # Make s
-0001f440: 7572 6520 7373 6820 6973 2077 6f72 6b69  ure ssh is worki
-0001f450: 6e67 2077 6974 6820 6375 7374 6f6d 2075  ng with custom u
-0001f460: 7365 726e 616d 650a 2020 2020 2020 2020  sername.        
-0001f470: 2020 2020 6627 7373 6820 7b6e 616d 657d      f'ssh {name}
-0001f480: 2065 6368 6f20 6869 207c 2067 7265 7020   echo hi | grep 
-0001f490: 6869 272c 0a20 2020 2020 2020 205d 2c0a  hi',.        ],.
-0001f4a0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-0001f4b0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-0001f4c0: 2020 2020 2020 2074 696d 656f 7574 3d33         timeout=3
-0001f4d0: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
-0001f4e0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-0001f4f0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-0001f500: 6172 6b2e 736c 6f77 0a64 6566 2074 6573  ark.slow.def tes
-0001f510: 745f 617a 7572 655f 7374 6172 745f 7374  t_azure_start_st
-0001f520: 6f70 5f74 776f 5f6e 6f64 6573 2829 3a0a  op_two_nodes():.
-0001f530: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-0001f540: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-0001f550: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-0001f560: 2020 2020 2020 2020 2761 7a75 7265 2d73          'azure-s
-0001f570: 7461 7274 2d73 746f 702d 7477 6f2d 6e6f  tart-stop-two-no
-0001f580: 6465 7327 2c0a 2020 2020 2020 2020 5b0a  des',.        [.
-0001f590: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0001f5a0: 7920 6c61 756e 6368 202d 2d6e 756d 2d6e  y launch --num-n
-0001f5b0: 6f64 6573 3d32 202d 7920 2d63 207b 6e61  odes=2 -y -c {na
-0001f5c0: 6d65 7d20 6578 616d 706c 6573 2f61 7a75  me} examples/azu
-0001f5d0: 7265 5f73 7461 7274 5f73 746f 702e 7961  re_start_stop.ya
-0001f5e0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-0001f5f0: 2066 2773 6b79 2065 7865 6320 2d2d 6e75   f'sky exec --nu
-0001f600: 6d2d 6e6f 6465 733d 3220 7b6e 616d 657d  m-nodes=2 {name}
-0001f610: 2065 7861 6d70 6c65 732f 617a 7572 655f   examples/azure_
-0001f620: 7374 6172 745f 7374 6f70 2e79 616d 6c27  start_stop.yaml'
-0001f630: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001f640: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0001f650: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
-0001f660: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-0001f670: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-0001f680: 2020 2020 2020 6627 736b 7920 7374 6f70        f'sky stop
-0001f690: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-0001f6a0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-0001f6b0: 7461 7274 202d 7920 7b6e 616d 657d 202d  tart -y {name} -
-0001f6c0: 6920 3127 2c0a 2020 2020 2020 2020 2020  i 1',.          
-0001f6d0: 2020 6627 736b 7920 6578 6563 202d 2d6e    f'sky exec --n
-0001f6e0: 756d 2d6e 6f64 6573 3d32 207b 6e61 6d65  um-nodes=2 {name
-0001f6f0: 7d20 6578 616d 706c 6573 2f61 7a75 7265  } examples/azure
-0001f700: 5f73 7461 7274 5f73 746f 702e 7961 6d6c  _start_stop.yaml
-0001f710: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001f720: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0001f730: 2032 202d 2d73 7461 7475 7327 2c20 2023   2 --status',  #
-0001f740: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-0001f750: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-0001f760: 2020 2020 2020 2027 736c 6565 7020 3230         'sleep 20
-0001f770: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-0001f780: 6627 733d 2428 736b 7920 7374 6174 7573  f's=$(sky status
-0001f790: 202d 7220 7b6e 616d 657d 2920 2626 2065   -r {name}) && e
-0001f7a0: 6368 6f20 2224 7322 2026 2620 6563 686f  cho "$s" && echo
-0001f7b0: 2022 2473 2220 7c20 6772 6570 2022 494e   "$s" | grep "IN
-0001f7c0: 4954 5c7c 5354 4f50 5045 4422 270a 2020  IT\|STOPPED"'.  
-0001f7d0: 2020 2020 2020 2020 2020 6627 7c7c 207b            f'|| {
-0001f7e0: 7b20 7373 6820 7b6e 616d 657d 2022 6361  { ssh {name} "ca
-0001f7f0: 7420 7e2f 2e73 6b79 2f73 6b79 6c65 742e  t ~/.sky/skylet.
-0001f800: 6c6f 6722 3b20 6578 6974 2031 3b20 7d7d  log"; exit 1; }}
-0001f810: 270a 2020 2020 2020 2020 5d2c 0a20 2020  '.        ],.   
-0001f820: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-0001f830: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-0001f840: 2020 2020 7469 6d65 6f75 743d 3330 202a      timeout=30 *
-0001f850: 2036 302c 2020 2320 3330 206d 696e 7320   60,  # 30 mins 
-0001f860: 2028 6974 2074 616b 6573 2061 726f 756e   (it takes aroun
-0001f870: 6420 7e32 3320 6d69 6e73 290a 2020 2020  d ~23 mins).    
-0001f880: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-0001f890: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-0001f8a0: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
-0001f8b0: 656e 7620 666f 7220 6469 736b 2074 6965  env for disk tie
-0001f8c0: 7220 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  r ----------.@py
-0001f8d0: 7465 7374 2e6d 6172 6b2e 6177 730a 6465  test.mark.aws.de
-0001f8e0: 6620 7465 7374 5f61 7773 5f64 6973 6b5f  f test_aws_disk_
-0001f8f0: 7469 6572 2829 3a0a 0a20 2020 2064 6566  tier():..    def
-0001f900: 205f 6765 745f 6177 735f 7175 6572 795f   _get_aws_query_
-0001f910: 636f 6d6d 616e 6428 7265 6769 6f6e 2c20  command(region, 
-0001f920: 696e 7374 616e 6365 5f69 642c 2066 6965  instance_id, fie
-0001f930: 6c64 2c20 6578 7065 6374 6564 293a 0a20  ld, expected):. 
-0001f940: 2020 2020 2020 2072 6574 7572 6e20 2866         return (f
-0001f950: 2761 7773 2065 6332 2064 6573 6372 6962  'aws ec2 describ
-0001f960: 652d 766f 6c75 6d65 7320 2d2d 7265 6769  e-volumes --regi
-0001f970: 6f6e 207b 7265 6769 6f6e 7d20 270a 2020  on {region} '.  
-0001f980: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-0001f990: 2d2d 6669 6c74 6572 7320 4e61 6d65 3d61  --filters Name=a
-0001f9a0: 7474 6163 686d 656e 742e 696e 7374 616e  ttachment.instan
-0001f9b0: 6365 2d69 642c 5661 6c75 6573 3d7b 696e  ce-id,Values={in
-0001f9c0: 7374 616e 6365 5f69 647d 2027 0a20 2020  stance_id} '.   
-0001f9d0: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
-0001f9e0: 2d71 7565 7279 2056 6f6c 756d 6573 5b2a  -query Volumes[*
-0001f9f0: 5d2e 7b66 6965 6c64 7d20 7c20 6772 6570  ].{field} | grep
-0001fa00: 207b 6578 7065 6374 6564 7d20 3b20 2729   {expected} ; ')
-0001fa10: 0a0a 2020 2020 666f 7220 6469 736b 5f74  ..    for disk_t
-0001fa20: 6965 7220 696e 206c 6973 7428 7265 736f  ier in list(reso
-0001fa30: 7572 6365 735f 7574 696c 732e 4469 736b  urces_utils.Disk
-0001fa40: 5469 6572 293a 0a20 2020 2020 2020 2073  Tier):.        s
-0001fa50: 7065 6373 203d 2041 5753 2e5f 6765 745f  pecs = AWS._get_
-0001fa60: 6469 736b 5f73 7065 6373 2864 6973 6b5f  disk_specs(disk_
-0001fa70: 7469 6572 290a 2020 2020 2020 2020 6e61  tier).        na
-0001fa80: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-0001fa90: 725f 6e61 6d65 2829 202b 2027 2d27 202b  r_name() + '-' +
-0001faa0: 2064 6973 6b5f 7469 6572 2e76 616c 7565   disk_tier.value
-0001fab0: 0a20 2020 2020 2020 206e 616d 655f 6f6e  .        name_on
-0001fac0: 5f63 6c6f 7564 203d 2063 6f6d 6d6f 6e5f  _cloud = common_
-0001fad0: 7574 696c 732e 6d61 6b65 5f63 6c75 7374  utils.make_clust
-0001fae0: 6572 5f6e 616d 655f 6f6e 5f63 6c6f 7564  er_name_on_cloud
-0001faf0: 280a 2020 2020 2020 2020 2020 2020 6e61  (.            na
-0001fb00: 6d65 2c20 736b 792e 4157 532e 6d61 785f  me, sky.AWS.max_
-0001fb10: 636c 7573 7465 725f 6e61 6d65 5f6c 656e  cluster_name_len
-0001fb20: 6774 6828 2929 0a20 2020 2020 2020 2072  gth()).        r
-0001fb30: 6567 696f 6e20 3d20 2775 732d 6561 7374  egion = 'us-east
-0001fb40: 2d32 270a 2020 2020 2020 2020 7465 7374  -2'.        test
-0001fb50: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-0001fb60: 2020 2020 2027 6177 732d 6469 736b 2d74       'aws-disk-t
-0001fb70: 6965 722d 2720 2b20 6469 736b 5f74 6965  ier-' + disk_tie
-0001fb80: 722e 7661 6c75 652c 0a20 2020 2020 2020  r.value,.       
-0001fb90: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-0001fba0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-0001fbb0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-0001fbc0: 202d 2d63 6c6f 7564 2061 7773 202d 2d72   --cloud aws --r
-0001fbd0: 6567 696f 6e20 7b72 6567 696f 6e7d 2027  egion {region} '
-0001fbe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fbf0: 2066 272d 2d64 6973 6b2d 7469 6572 207b   f'--disk-tier {
-0001fc00: 6469 736b 5f74 6965 722e 7661 6c75 657d  disk_tier.value}
-0001fc10: 2065 6368 6f20 2268 656c 6c6f 2073 6b79   echo "hello sky
-0001fc20: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-0001fc30: 2020 2020 6627 6964 3d60 6177 7320 6563      f'id=`aws ec
-0001fc40: 3220 6465 7363 7269 6265 2d69 6e73 7461  2 describe-insta
-0001fc50: 6e63 6573 202d 2d72 6567 696f 6e20 7b72  nces --region {r
-0001fc60: 6567 696f 6e7d 202d 2d66 696c 7465 7273  egion} --filters
-0001fc70: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0001fc80: 2020 2066 274e 616d 653d 7461 673a 7261     f'Name=tag:ra
-0001fc90: 792d 636c 7573 7465 722d 6e61 6d65 2c56  y-cluster-name,V
-0001fca0: 616c 7565 733d 7b6e 616d 655f 6f6e 5f63  alues={name_on_c
-0001fcb0: 6c6f 7564 7d20 2d2d 7175 6572 7920 270a  loud} --query '.
-0001fcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fcd0: 6627 5265 7365 7276 6174 696f 6e73 5b5d  f'Reservations[]
-0001fce0: 2e49 6e73 7461 6e63 6573 5b5d 2e49 6e73  .Instances[].Ins
-0001fcf0: 7461 6e63 6549 6420 2d2d 6f75 7470 7574  tanceId --output
-0001fd00: 2074 6578 7460 3b20 2720 2b0a 2020 2020   text`; ' +.    
-0001fd10: 2020 2020 2020 2020 2020 2020 5f67 6574              _get
-0001fd20: 5f61 7773 5f71 7565 7279 5f63 6f6d 6d61  _aws_query_comma
-0001fd30: 6e64 2872 6567 696f 6e2c 2027 2469 6427  nd(region, '$id'
-0001fd40: 2c20 2756 6f6c 756d 6554 7970 6527 2c0a  , 'VolumeType',.
-0001fd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fd70: 2020 2020 2020 2073 7065 6373 5b27 6469         specs['di
-0001fd80: 736b 5f74 6965 7227 5d29 202b 0a20 2020  sk_tier']) +.   
-0001fd90: 2020 2020 2020 2020 2020 2020 2028 2727               (''
-0001fda0: 2069 6620 6469 736b 5f74 6965 7220 3d3d   if disk_tier ==
-0001fdb0: 2072 6573 6f75 7263 6573 5f75 7469 6c73   resources_utils
-0001fdc0: 2e44 6973 6b54 6965 722e 4c4f 5720 656c  .DiskTier.LOW el
-0001fdd0: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-0001fde0: 2020 2020 285f 6765 745f 6177 735f 7175      (_get_aws_qu
-0001fdf0: 6572 795f 636f 6d6d 616e 6428 7265 6769  ery_command(regi
-0001fe00: 6f6e 2c20 2724 6964 272c 2027 496f 7073  on, '$id', 'Iops
-0001fe10: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-0001fe20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fe30: 2020 2020 2020 2020 2020 2020 7370 6563              spec
-0001fe40: 735b 2764 6973 6b5f 696f 7073 275d 2920  s['disk_iops']) 
-0001fe50: 2b0a 2020 2020 2020 2020 2020 2020 2020  +.              
-0001fe60: 2020 2020 5f67 6574 5f61 7773 5f71 7565      _get_aws_que
-0001fe70: 7279 5f63 6f6d 6d61 6e64 2872 6567 696f  ry_command(regio
-0001fe80: 6e2c 2027 2469 6427 2c20 2754 6872 6f75  n, '$id', 'Throu
-0001fe90: 6768 7075 7427 2c0a 2020 2020 2020 2020  ghput',.        
-0001fea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d8f0: 4070 7974 6573 742e 6d61 726b 2e6d 616e  @pytest.mark.man
+0001d900: 6167 6564 5f6a 6f62 730a 6465 6620 7465  aged_jobs.def te
+0001d910: 7374 5f6d 616e 6167 6564 5f6a 6f62 735f  st_managed_jobs_
+0001d920: 7374 6f72 6167 6528 6765 6e65 7269 635f  storage(generic_
+0001d930: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+0001d940: 2022 2222 5465 7374 2073 746f 7261 6765   """Test storage
+0001d950: 2077 6974 6820 6d61 6e61 6765 6420 6a6f   with managed jo
+0001d960: 6222 2222 0a20 2020 206e 616d 6520 3d20  b""".    name = 
+0001d970: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+0001d980: 6528 290a 2020 2020 7961 6d6c 5f73 7472  e().    yaml_str
+0001d990: 203d 2070 6174 686c 6962 2e50 6174 6828   = pathlib.Path(
+0001d9a0: 0a20 2020 2020 2020 2027 6578 616d 706c  .        'exampl
+0001d9b0: 6573 2f6d 616e 6167 6564 5f6a 6f62 5f77  es/managed_job_w
+0001d9c0: 6974 685f 7374 6f72 6167 652e 7961 6d6c  ith_storage.yaml
+0001d9d0: 2729 2e72 6561 645f 7465 7874 2829 0a20  ').read_text(). 
+0001d9e0: 2020 2073 746f 7261 6765 5f6e 616d 6520     storage_name 
+0001d9f0: 3d20 6627 736b 792d 7465 7374 2d7b 696e  = f'sky-test-{in
+0001da00: 7428 7469 6d65 2e74 696d 6528 2929 7d27  t(time.time())}'
+0001da10: 0a0a 2020 2020 2320 416c 736f 2070 6572  ..    # Also per
+0001da20: 666f 726d 2072 6567 696f 6e20 7465 7374  form region test
+0001da30: 696e 6720 666f 7220 6275 636b 6574 2063  ing for bucket c
+0001da40: 7265 6174 696f 6e20 746f 2076 616c 6964  reation to valid
+0001da50: 6174 6520 6966 2062 7563 6b65 7473 2061  ate if buckets a
+0001da60: 7265 0a20 2020 2023 2063 7265 6174 6564  re.    # created
+0001da70: 2069 6e20 7468 6520 636f 7272 6563 7420   in the correct 
+0001da80: 7265 6769 6f6e 2061 6e64 2063 6f72 7265  region and corre
+0001da90: 6374 6c79 206d 6f75 6e74 6564 2069 6e20  ctly mounted in 
+0001daa0: 6d61 6e61 6765 6420 6a6f 6273 2e0a 2020  managed jobs..  
+0001dab0: 2020 2320 486f 7765 7665 722c 2077 6520    # However, we 
+0001dac0: 696e 6a65 6374 2074 6869 7320 7465 7374  inject this test
+0001dad0: 696e 6720 6f6e 6c79 2066 6f72 2041 5753  ing only for AWS
+0001dae0: 2061 6e64 2047 4350 2073 696e 6365 2074   and GCP since t
+0001daf0: 6865 7920 6172 6520 7468 650a 2020 2020  hey are the.    
+0001db00: 2320 7375 7070 6f72 7465 6420 6f62 6a65  # supported obje
+0001db10: 6374 2073 746f 7261 6765 2070 726f 7669  ct storage provi
+0001db20: 6465 7273 2069 6e20 536b 7950 696c 6f74  ders in SkyPilot
+0001db30: 2e0a 2020 2020 7265 6769 6f6e 5f66 6c61  ..    region_fla
+0001db40: 6720 3d20 2727 0a20 2020 2072 6567 696f  g = ''.    regio
+0001db50: 6e5f 7661 6c69 6461 7469 6f6e 5f63 6d64  n_validation_cmd
+0001db60: 203d 2027 7472 7565 270a 2020 2020 7573   = 'true'.    us
+0001db70: 655f 7370 6f74 203d 2027 202d 2d75 7365  e_spot = ' --use
+0001db80: 2d73 706f 7427 0a20 2020 2069 6620 6765  -spot'.    if ge
+0001db90: 6e65 7269 635f 636c 6f75 6420 3d3d 2027  neric_cloud == '
+0001dba0: 6177 7327 3a0a 2020 2020 2020 2020 7265  aws':.        re
+0001dbb0: 6769 6f6e 203d 2027 6575 2d63 656e 7472  gion = 'eu-centr
+0001dbc0: 616c 2d31 270a 2020 2020 2020 2020 7265  al-1'.        re
+0001dbd0: 6769 6f6e 5f66 6c61 6720 3d20 6627 202d  gion_flag = f' -
+0001dbe0: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
+0001dbf0: 270a 2020 2020 2020 2020 7265 6769 6f6e  '.        region
+0001dc00: 5f63 6d64 203d 2054 6573 7453 746f 7261  _cmd = TestStora
+0001dc10: 6765 5769 7468 4372 6564 656e 7469 616c  geWithCredential
+0001dc20: 732e 636c 695f 7265 6769 6f6e 5f63 6d64  s.cli_region_cmd
+0001dc30: 280a 2020 2020 2020 2020 2020 2020 7374  (.            st
+0001dc40: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0001dc50: 7970 652e 5333 2c20 7374 6f72 6167 655f  ype.S3, storage_
+0001dc60: 6e61 6d65 290a 2020 2020 2020 2020 7265  name).        re
+0001dc70: 6769 6f6e 5f76 616c 6964 6174 696f 6e5f  gion_validation_
+0001dc80: 636d 6420 3d20 6627 7b72 6567 696f 6e5f  cmd = f'{region_
+0001dc90: 636d 647d 207c 2067 7265 7020 7b72 6567  cmd} | grep {reg
+0001dca0: 696f 6e7d 270a 2020 2020 656c 6966 2067  ion}'.    elif g
+0001dcb0: 656e 6572 6963 5f63 6c6f 7564 203d 3d20  eneric_cloud == 
+0001dcc0: 2767 6370 273a 0a20 2020 2020 2020 2072  'gcp':.        r
+0001dcd0: 6567 696f 6e20 3d20 2775 732d 7765 7374  egion = 'us-west
+0001dce0: 3227 0a20 2020 2020 2020 2072 6567 696f  2'.        regio
+0001dcf0: 6e5f 666c 6167 203d 2066 2720 2d2d 7265  n_flag = f' --re
+0001dd00: 6769 6f6e 207b 7265 6769 6f6e 7d27 0a20  gion {region}'. 
+0001dd10: 2020 2020 2020 2072 6567 696f 6e5f 636d         region_cm
+0001dd20: 6420 3d20 5465 7374 5374 6f72 6167 6557  d = TestStorageW
+0001dd30: 6974 6843 7265 6465 6e74 6961 6c73 2e63  ithCredentials.c
+0001dd40: 6c69 5f72 6567 696f 6e5f 636d 6428 0a20  li_region_cmd(. 
+0001dd50: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+0001dd60: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0001dd70: 2e47 4353 2c20 7374 6f72 6167 655f 6e61  .GCS, storage_na
+0001dd80: 6d65 290a 2020 2020 2020 2020 7265 6769  me).        regi
+0001dd90: 6f6e 5f76 616c 6964 6174 696f 6e5f 636d  on_validation_cm
+0001dda0: 6420 3d20 6627 7b72 6567 696f 6e5f 636d  d = f'{region_cm
+0001ddb0: 647d 207c 2067 7265 7020 7b72 6567 696f  d} | grep {regio
+0001ddc0: 6e7d 270a 2020 2020 656c 6966 2067 656e  n}'.    elif gen
+0001ddd0: 6572 6963 5f63 6c6f 7564 203d 3d20 276b  eric_cloud == 'k
+0001dde0: 7562 6572 6e65 7465 7327 3a0a 2020 2020  ubernetes':.    
+0001ddf0: 2020 2020 7573 655f 7370 6f74 203d 2027      use_spot = '
+0001de00: 202d 2d6e 6f2d 7573 652d 7370 6f74 270a   --no-use-spot'.
+0001de10: 0a20 2020 2079 616d 6c5f 7374 7220 3d20  .    yaml_str = 
+0001de20: 7961 6d6c 5f73 7472 2e72 6570 6c61 6365  yaml_str.replace
+0001de30: 2827 736b 792d 776f 726b 6469 722d 7a68  ('sky-workdir-zh
+0001de40: 7775 272c 2073 746f 7261 6765 5f6e 616d  wu', storage_nam
+0001de50: 6529 0a20 2020 2077 6974 6820 7465 6d70  e).    with temp
+0001de60: 6669 6c65 2e4e 616d 6564 5465 6d70 6f72  file.NamedTempor
+0001de70: 6172 7946 696c 6528 7375 6666 6978 3d27  aryFile(suffix='
+0001de80: 2e79 616d 6c27 2c20 6d6f 6465 3d27 7727  .yaml', mode='w'
+0001de90: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
+0001dea0: 662e 7772 6974 6528 7961 6d6c 5f73 7472  f.write(yaml_str
+0001deb0: 290a 2020 2020 2020 2020 662e 666c 7573  ).        f.flus
+0001dec0: 6828 290a 2020 2020 2020 2020 6669 6c65  h().        file
+0001ded0: 5f70 6174 6820 3d20 662e 6e61 6d65 0a20  _path = f.name. 
+0001dee0: 2020 2020 2020 2074 6573 7420 3d20 5465         test = Te
+0001def0: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
+0001df00: 276d 616e 6167 6564 5f6a 6f62 735f 7374  'managed_jobs_st
+0001df10: 6f72 6167 6527 2c0a 2020 2020 2020 2020  orage',.        
+0001df20: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+0001df30: 2020 2020 2020 2a73 746f 7261 6765 5f73        *storage_s
+0001df40: 6574 7570 5f63 6f6d 6d61 6e64 732c 0a20  etup_commands,. 
+0001df50: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001df60: 2773 6b79 206a 6f62 7320 6c61 756e 6368  'sky jobs launch
+0001df70: 202d 6e20 7b6e 616d 657d 7b75 7365 5f73   -n {name}{use_s
+0001df80: 706f 747d 202d 2d63 6c6f 7564 207b 6765  pot} --cloud {ge
+0001df90: 6e65 7269 635f 636c 6f75 647d 7b72 6567  neric_cloud}{reg
+0001dfa0: 696f 6e5f 666c 6167 7d20 7b66 696c 655f  ion_flag} {file_
+0001dfb0: 7061 7468 7d20 2d79 272c 0a20 2020 2020  path} -y',.     
+0001dfc0: 2020 2020 2020 2020 2020 2072 6567 696f             regio
+0001dfd0: 6e5f 7661 6c69 6461 7469 6f6e 5f63 6d64  n_validation_cmd
+0001dfe0: 2c20 2023 2043 6865 636b 2069 6620 7468  ,  # Check if th
+0001dff0: 6520 6275 636b 6574 2069 7320 6372 6561  e bucket is crea
+0001e000: 7465 6420 696e 2074 6865 2063 6f72 7265  ted in the corre
+0001e010: 6374 2072 6567 696f 6e0a 2020 2020 2020  ct region.      
+0001e020: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001e030: 2036 3027 2c20 2023 2057 6169 7420 7468   60',  # Wait th
+0001e040: 6520 7370 6f74 2071 7565 7565 2074 6f20  e spot queue to 
+0001e050: 6265 2075 7064 6174 6564 0a20 2020 2020  be updated.     
+0001e060: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
+0001e070: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
+0001e080: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
+0001e090: 6570 2053 5543 4345 4544 4544 272c 0a20  ep SUCCEEDED',. 
+0001e0a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001e0b0: 275b 2024 2861 7773 2073 3361 7069 206c  '[ $(aws s3api l
+0001e0c0: 6973 742d 6275 636b 6574 7320 2d2d 7175  ist-buckets --qu
+0001e0d0: 6572 7920 2242 7563 6b65 7473 5b3f 636f  ery "Buckets[?co
+0001e0e0: 6e74 6169 6e73 284e 616d 652c 205c 277b  ntains(Name, \'{
+0001e0f0: 7374 6f72 6167 655f 6e61 6d65 7d5c 2729  storage_name}\')
+0001e100: 5d2e 4e61 6d65 2220 2d2d 6f75 7470 7574  ].Name" --output
+0001e110: 2074 6578 7420 7c20 7763 202d 6c29 202d   text | wc -l) -
+0001e120: 6571 2030 205d 270a 2020 2020 2020 2020  eq 0 ]'.        
+0001e130: 2020 2020 5d2c 0a20 2020 2020 2020 2020      ],.         
+0001e140: 2020 205f 4a4f 425f 4341 4e43 454c 5f57     _JOB_CANCEL_W
+0001e150: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
+0001e160: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
+0001e170: 2020 2020 2020 2023 2049 6e63 7265 6173         # Increas
+0001e180: 6520 7469 6d65 6f75 7420 7369 6e63 6520  e timeout since 
+0001e190: 736b 7920 6a6f 6273 2071 7565 7565 202d  sky jobs queue -
+0001e1a0: 7220 6361 6e20 6265 2062 6c6f 636b 6564  r can be blocked
+0001e1b0: 2062 7920 6f74 6865 7220 7370 6f74 2074   by other spot t
+0001e1c0: 6573 7473 2e0a 2020 2020 2020 2020 2020  ests..          
+0001e1d0: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
+0001e1e0: 302c 0a20 2020 2020 2020 2029 0a20 2020  0,.        ).   
+0001e1f0: 2020 2020 2072 756e 5f6f 6e65 5f74 6573       run_one_tes
+0001e200: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+0001e210: 2d2d 2d2d 2d2d 2054 6573 7469 6e67 2073  ------ Testing s
+0001e220: 706f 7420 5450 5520 2d2d 2d2d 2d2d 2d2d  pot TPU --------
+0001e230: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
+0001e240: 6763 700a 4070 7974 6573 742e 6d61 726b  gcp.@pytest.mark
+0001e250: 2e6d 616e 6167 6564 5f6a 6f62 730a 4070  .managed_jobs.@p
+0001e260: 7974 6573 742e 6d61 726b 2e74 7075 0a64  ytest.mark.tpu.d
+0001e270: 6566 2074 6573 745f 6d61 6e61 6765 645f  ef test_managed_
+0001e280: 6a6f 6273 5f74 7075 2829 3a0a 2020 2020  jobs_tpu():.    
+0001e290: 2222 2254 6573 7420 6d61 6e61 6765 6420  """Test managed 
+0001e2a0: 6a6f 6220 6f6e 2054 5055 2e22 2222 0a20  job on TPU.""". 
+0001e2b0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+0001e2c0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+0001e2d0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+0001e2e0: 2020 2020 2020 2027 7465 7374 2d73 706f         'test-spo
+0001e2f0: 742d 7470 7527 2c0a 2020 2020 2020 2020  t-tpu',.        
+0001e300: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+0001e310: 736b 7920 6a6f 6273 206c 6175 6e63 6820  sky jobs launch 
+0001e320: 2d6e 207b 6e61 6d65 7d20 2d2d 7573 652d  -n {name} --use-
+0001e330: 7370 6f74 2065 7861 6d70 6c65 732f 7470  spot examples/tp
+0001e340: 752f 7470 7576 6d5f 6d6e 6973 742e 7961  u/tpuvm_mnist.ya
+0001e350: 6d6c 202d 7920 2d64 272c 0a20 2020 2020  ml -y -d',.     
+0001e360: 2020 2020 2020 2027 736c 6565 7020 3527         'sleep 5'
+0001e370: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001e380: 7b5f 4a4f 425f 5155 4555 455f 5741 4954  {_JOB_QUEUE_WAIT
+0001e390: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+0001e3a0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+0001e3b0: 2053 5441 5254 494e 4727 2c0a 2020 2020   STARTING',.    
+0001e3c0: 2020 2020 2020 2020 2773 6c65 6570 2039          'sleep 9
+0001e3d0: 3030 272c 2020 2320 5450 5520 7461 6b65  00',  # TPU take
+0001e3e0: 7320 6120 7768 696c 6520 746f 206c 6175  s a while to lau
+0001e3f0: 6e63 680a 2020 2020 2020 2020 2020 2020  nch.            
+0001e400: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
+0001e410: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+0001e420: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+0001e430: 6570 2022 5255 4e4e 494e 475c 7c53 5543  ep "RUNNING\|SUC
+0001e440: 4345 4544 4544 2227 2c0a 2020 2020 2020  CEEDED"',.      
+0001e450: 2020 5d2c 0a20 2020 2020 2020 205f 4a4f    ],.        _JO
+0001e460: 425f 4341 4e43 454c 5f57 4149 542e 666f  B_CANCEL_WAIT.fo
+0001e470: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
+0001e480: 6d65 292c 0a20 2020 2020 2020 2023 2049  me),.        # I
+0001e490: 6e63 7265 6173 6520 7469 6d65 6f75 7420  ncrease timeout 
+0001e4a0: 7369 6e63 6520 736b 7920 6a6f 6273 2071  since sky jobs q
+0001e4b0: 7565 7565 202d 7220 6361 6e20 6265 2062  ueue -r can be b
+0001e4c0: 6c6f 636b 6564 2062 7920 6f74 6865 7220  locked by other 
+0001e4d0: 7370 6f74 2074 6573 7473 2e0a 2020 2020  spot tests..    
+0001e4e0: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
+0001e4f0: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+0001e500: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0001e510: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
+0001e520: 2054 6573 7469 6e67 2065 6e76 2066 6f72   Testing env for
+0001e530: 206d 616e 6167 6564 206a 6f62 7320 2d2d   managed jobs --
+0001e540: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
+0001e550: 2e6d 6172 6b2e 6d61 6e61 6765 645f 6a6f  .mark.managed_jo
+0001e560: 6273 0a64 6566 2074 6573 745f 6d61 6e61  bs.def test_mana
+0001e570: 6765 645f 6a6f 6273 5f69 6e6c 696e 655f  ged_jobs_inline_
+0001e580: 656e 7628 6765 6e65 7269 635f 636c 6f75  env(generic_clou
+0001e590: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
+0001e5a0: 5465 7374 206d 616e 6167 6564 206a 6f62  Test managed job
+0001e5b0: 7320 656e 7622 2222 0a20 2020 206e 616d  s env""".    nam
+0001e5c0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+0001e5d0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+0001e5e0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+0001e5f0: 2027 7465 7374 2d6d 616e 6167 6564 2d6a   'test-managed-j
+0001e600: 6f62 732d 696e 6c69 6e65 2d65 6e76 272c  obs-inline-env',
+0001e610: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+0001e620: 2020 2020 2020 2066 2773 6b79 206a 6f62         f'sky job
+0001e630: 7320 6c61 756e 6368 202d 6e20 7b6e 616d  s launch -n {nam
+0001e640: 657d 202d 7920 2d2d 636c 6f75 6420 7b67  e} -y --cloud {g
+0001e650: 656e 6572 6963 5f63 6c6f 7564 7d20 2d2d  eneric_cloud} --
+0001e660: 656e 7620 5445 5354 5f45 4e56 3d22 6865  env TEST_ENV="he
+0001e670: 6c6c 6f20 776f 726c 6422 202d 2d20 2228  llo world" -- "(
+0001e680: 5b5b 2021 202d 7a20 5c5c 225c 2454 4553  [[ ! -z \\"\$TES
+0001e690: 545f 454e 565c 5c22 205d 5d20 2626 205b  T_ENV\\" ]] && [
+0001e6a0: 5b20 2120 2d7a 205c 5c22 5c24 534b 5950  [ ! -z \\"\$SKYP
+0001e6b0: 494c 4f54 5f4e 4f44 455f 4950 535c 5c22  ILOT_NODE_IPS\\"
+0001e6c0: 205d 5d20 2626 205b 5b20 2120 2d7a 205c   ]] && [[ ! -z \
+0001e6d0: 5c22 5c24 534b 5950 494c 4f54 5f4e 4f44  \"\$SKYPILOT_NOD
+0001e6e0: 455f 5241 4e4b 5c5c 2220 5d5d 2920 7c7c  E_RANK\\" ]]) ||
+0001e6f0: 2065 7869 7420 3122 272c 0a20 2020 2020   exit 1"',.     
+0001e700: 2020 2020 2020 2027 736c 6565 7020 3230         'sleep 20
+0001e710: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001e720: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
+0001e730: 547d 207c 2067 7265 7020 7b6e 616d 657d  T} | grep {name}
+0001e740: 207c 2067 7265 7020 5355 4343 4545 4445   | grep SUCCEEDE
+0001e750: 4427 2c0a 2020 2020 2020 2020 5d2c 0a20  D',.        ],. 
+0001e760: 2020 2020 2020 205f 4a4f 425f 4341 4e43         _JOB_CANC
+0001e770: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
+0001e780: 6f62 5f6e 616d 653d 6e61 6d65 292c 0a20  ob_name=name),. 
+0001e790: 2020 2020 2020 2023 2049 6e63 7265 6173         # Increas
+0001e7a0: 6520 7469 6d65 6f75 7420 7369 6e63 6520  e timeout since 
+0001e7b0: 736b 7920 6a6f 6273 2071 7565 7565 202d  sky jobs queue -
+0001e7c0: 7220 6361 6e20 6265 2062 6c6f 636b 6564  r can be blocked
+0001e7d0: 2062 7920 6f74 6865 7220 7370 6f74 2074   by other spot t
+0001e7e0: 6573 7473 2e0a 2020 2020 2020 2020 7469  ests..        ti
+0001e7f0: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
+0001e800: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+0001e810: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+0001e820: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7469  ---------- Testi
+0001e830: 6e67 2065 6e76 202d 2d2d 2d2d 2d2d 2d2d  ng env ---------
+0001e840: 2d0a 6465 6620 7465 7374 5f69 6e6c 696e  -.def test_inlin
+0001e850: 655f 656e 7628 6765 6e65 7269 635f 636c  e_env(generic_cl
+0001e860: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
+0001e870: 2222 5465 7374 2065 6e76 2222 220a 2020  ""Test env""".  
+0001e880: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+0001e890: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+0001e8a0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+0001e8b0: 2020 2020 2020 2774 6573 742d 696e 6c69        'test-inli
+0001e8c0: 6e65 2d65 6e76 272c 0a20 2020 2020 2020  ne-env',.       
+0001e8d0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+0001e8e0: 2773 6b79 206c 6175 6e63 6820 2d63 207b  'sky launch -c {
+0001e8f0: 6e61 6d65 7d20 2d79 202d 2d63 6c6f 7564  name} -y --cloud
+0001e900: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
+0001e910: 202d 2d65 6e76 2054 4553 545f 454e 563d   --env TEST_ENV=
+0001e920: 2268 656c 6c6f 2077 6f72 6c64 2220 2d2d  "hello world" --
+0001e930: 2022 285b 5b20 2120 2d7a 205c 5c22 5c24   "([[ ! -z \\"\$
+0001e940: 5445 5354 5f45 4e56 5c5c 2220 5d5d 2026  TEST_ENV\\" ]] &
+0001e950: 2620 5b5b 2021 202d 7a20 5c5c 225c 2453  & [[ ! -z \\"\$S
+0001e960: 4b59 5049 4c4f 545f 4e4f 4445 5f49 5053  KYPILOT_NODE_IPS
+0001e970: 5c5c 2220 5d5d 2026 2620 5b5b 2021 202d  \\" ]] && [[ ! -
+0001e980: 7a20 5c5c 225c 2453 4b59 5049 4c4f 545f  z \\"\$SKYPILOT_
+0001e990: 4e4f 4445 5f52 414e 4b5c 5c22 205d 5d29  NODE_RANK\\" ]])
+0001e9a0: 207c 7c20 6578 6974 2031 2227 2c0a 2020   || exit 1"',.  
+0001e9b0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001e9c0: 2032 3027 2c0a 2020 2020 2020 2020 2020   20',.          
+0001e9d0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+0001e9e0: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+0001e9f0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0001ea00: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+0001ea10: 2d65 6e76 2054 4553 545f 454e 5632 3d22  -env TEST_ENV2="
+0001ea20: 7375 6363 6573 7322 2022 285b 5b20 2120  success" "([[ ! 
+0001ea30: 2d7a 205c 5c22 5c24 5445 5354 5f45 4e56  -z \\"\$TEST_ENV
+0001ea40: 325c 5c22 205d 5d20 2626 205b 5b20 2120  2\\" ]] && [[ ! 
+0001ea50: 2d7a 205c 5c22 5c24 534b 5950 494c 4f54  -z \\"\$SKYPILOT
+0001ea60: 5f4e 4f44 455f 4950 535c 5c22 205d 5d20  _NODE_IPS\\" ]] 
+0001ea70: 2626 205b 5b20 2120 2d7a 205c 5c22 5c24  && [[ ! -z \\"\$
+0001ea80: 534b 5950 494c 4f54 5f4e 4f44 455f 5241  SKYPILOT_NODE_RA
+0001ea90: 4e4b 5c5c 2220 5d5d 2920 7c7c 2065 7869  NK\\" ]]) || exi
+0001eaa0: 7420 3122 272c 0a20 2020 2020 2020 2020  t 1"',.         
+0001eab0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+0001eac0: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
+0001ead0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+0001eae0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+0001eaf0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+0001eb00: 2020 2020 5f67 6574 5f74 696d 656f 7574      _get_timeout
+0001eb10: 2867 656e 6572 6963 5f63 6c6f 7564 292c  (generic_cloud),
+0001eb20: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+0001eb30: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+0001eb40: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
+0001eb50: 7469 6e67 2065 6e76 2066 696c 6520 2d2d  ting env file --
+0001eb60: 2d2d 2d2d 2d2d 2d2d 0a64 6566 2074 6573  --------.def tes
+0001eb70: 745f 696e 6c69 6e65 5f65 6e76 5f66 696c  t_inline_env_fil
+0001eb80: 6528 6765 6e65 7269 635f 636c 6f75 643a  e(generic_cloud:
+0001eb90: 2073 7472 293a 0a20 2020 2022 2222 5465   str):.    """Te
+0001eba0: 7374 2065 6e76 2222 220a 2020 2020 6e61  st env""".    na
+0001ebb0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+0001ebc0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+0001ebd0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+0001ebe0: 2020 2774 6573 742d 696e 6c69 6e65 2d65    'test-inline-e
+0001ebf0: 6e76 2d66 696c 6527 2c0a 2020 2020 2020  nv-file',.      
+0001ec00: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+0001ec10: 6627 736b 7920 6c61 756e 6368 202d 6320  f'sky launch -c 
+0001ec20: 7b6e 616d 657d 202d 7920 2d2d 636c 6f75  {name} -y --clou
+0001ec30: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+0001ec40: 7d20 2d2d 656e 7620 5445 5354 5f45 4e56  } --env TEST_ENV
+0001ec50: 3d22 6865 6c6c 6f20 776f 726c 6422 202d  ="hello world" -
+0001ec60: 2d20 2228 5b5b 2021 202d 7a20 5c5c 225c  - "([[ ! -z \\"\
+0001ec70: 2454 4553 545f 454e 565c 5c22 205d 5d20  $TEST_ENV\\" ]] 
+0001ec80: 2626 205b 5b20 2120 2d7a 205c 5c22 5c24  && [[ ! -z \\"\$
+0001ec90: 534b 5950 494c 4f54 5f4e 4f44 455f 4950  SKYPILOT_NODE_IP
+0001eca0: 535c 5c22 205d 5d20 2626 205b 5b20 2120  S\\" ]] && [[ ! 
+0001ecb0: 2d7a 205c 5c22 5c24 534b 5950 494c 4f54  -z \\"\$SKYPILOT
+0001ecc0: 5f4e 4f44 455f 5241 4e4b 5c5c 2220 5d5d  _NODE_RANK\\" ]]
+0001ecd0: 2920 7c7c 2065 7869 7420 3122 272c 0a20  ) || exit 1"',. 
+0001ece0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001ecf0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+0001ed00: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+0001ed10: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+0001ed20: 207b 6e61 6d65 7d20 2d2d 656e 762d 6669   {name} --env-fi
+0001ed30: 6c65 2065 7861 6d70 6c65 732f 7361 6d70  le examples/samp
+0001ed40: 6c65 5f64 6f74 656e 7620 2228 5b5b 2021  le_dotenv "([[ !
+0001ed50: 202d 7a20 5c5c 225c 2454 4553 545f 454e   -z \\"\$TEST_EN
+0001ed60: 5632 5c5c 2220 5d5d 2026 2620 5b5b 2021  V2\\" ]] && [[ !
+0001ed70: 202d 7a20 5c5c 225c 2453 4b59 5049 4c4f   -z \\"\$SKYPILO
+0001ed80: 545f 4e4f 4445 5f49 5053 5c5c 2220 5d5d  T_NODE_IPS\\" ]]
+0001ed90: 2026 2620 5b5b 2021 202d 7a20 5c5c 225c   && [[ ! -z \\"\
+0001eda0: 2453 4b59 5049 4c4f 545f 4e4f 4445 5f52  $SKYPILOT_NODE_R
+0001edb0: 414e 4b5c 5c22 205d 5d29 207c 7c20 6578  ANK\\" ]]) || ex
+0001edc0: 6974 2031 2227 2c0a 2020 2020 2020 2020  it 1"',.        
+0001edd0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0001ede0: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
+0001edf0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+0001ee00: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+0001ee10: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+0001ee20: 2020 2020 205f 6765 745f 7469 6d65 6f75       _get_timeou
+0001ee30: 7428 6765 6e65 7269 635f 636c 6f75 6429  t(generic_cloud)
+0001ee40: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+0001ee50: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+0001ee60: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
+0001ee70: 7374 696e 6720 6375 7374 6f6d 2069 6d61  sting custom ima
+0001ee80: 6765 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  ge ----------.@p
+0001ee90: 7974 6573 742e 6d61 726b 2e61 7773 0a64  ytest.mark.aws.d
+0001eea0: 6566 2074 6573 745f 6177 735f 6375 7374  ef test_aws_cust
+0001eeb0: 6f6d 5f69 6d61 6765 2829 3a0a 2020 2020  om_image():.    
+0001eec0: 2222 2254 6573 7420 4157 5320 6375 7374  """Test AWS cust
+0001eed0: 6f6d 2069 6d61 6765 2222 220a 2020 2020  om image""".    
+0001eee0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+0001eef0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+0001ef00: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+0001ef10: 2020 2020 2774 6573 742d 6177 732d 6375      'test-aws-cu
+0001ef20: 7374 6f6d 2d69 6d61 6765 272c 0a20 2020  stom-image',.   
+0001ef30: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+0001ef40: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+0001ef50: 2d63 207b 6e61 6d65 7d20 2d2d 7265 7472  -c {name} --retr
+0001ef60: 792d 756e 7469 6c2d 7570 202d 7920 7465  y-until-up -y te
+0001ef70: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
+0001ef80: 6573 745f 6375 7374 6f6d 5f69 6d61 6765  est_custom_image
+0001ef90: 2e79 616d 6c20 2d2d 636c 6f75 6420 6177  .yaml --cloud aw
+0001efa0: 7320 2d2d 7265 6769 6f6e 2075 732d 6561  s --region us-ea
+0001efb0: 7374 2d32 202d 2d69 6d61 6765 2d69 6420  st-2 --image-id 
+0001efc0: 616d 692d 3036 3264 6464 3930 6662 3666  ami-062ddd90fb6f
+0001efd0: 3832 3637 6127 2c20 2023 204e 7669 6469  8267a',  # Nvidi
+0001efe0: 6120 696d 6167 650a 2020 2020 2020 2020  a image.        
+0001eff0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0001f000: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+0001f010: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+0001f020: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+0001f030: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+0001f040: 2020 2020 2074 696d 656f 7574 3d33 3020       timeout=30 
+0001f050: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
+0001f060: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+0001f070: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+0001f080: 6b2e 6b75 6265 726e 6574 6573 0a40 7079  k.kubernetes.@py
+0001f090: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
+0001f0a0: 7472 697a 6528 0a20 2020 2027 696d 6167  trize(.    'imag
+0001f0b0: 655f 6964 272c 0a20 2020 205b 0a20 2020  e_id',.    [.   
+0001f0c0: 2020 2020 2027 646f 636b 6572 3a6e 7669       'docker:nvi
+0001f0d0: 6469 612f 6375 6461 3a31 312e 382e 302d  dia/cuda:11.8.0-
+0001f0e0: 6465 7665 6c2d 7562 756e 7475 3138 2e30  devel-ubuntu18.0
+0001f0f0: 3427 2c0a 2020 2020 2020 2020 2764 6f63  4',.        'doc
+0001f100: 6b65 723a 7562 756e 7475 3a31 382e 3034  ker:ubuntu:18.04
+0001f110: 272c 0a20 2020 2020 2020 2023 2054 6573  ',.        # Tes
+0001f120: 7420 6c61 7465 7374 2069 6d61 6765 2077  t latest image w
+0001f130: 6974 6820 7079 7468 6f6e 2033 2e31 3120  ith python 3.11 
+0001f140: 696e 7374 616c 6c65 6420 6279 2064 6566  installed by def
+0001f150: 6175 6c74 2e0a 2020 2020 2020 2020 2320  ault..        # 
+0001f160: 446f 6573 206e 6f74 2077 6f72 6b20 666f  Does not work fo
+0001f170: 7220 7079 7468 6f6e 2033 2e31 3220 6475  r python 3.12 du
+0001f180: 6520 746f 2072 6179 2773 2072 6571 7569  e to ray's requi
+0001f190: 7265 6d65 6e74 2066 6f72 2033 2e31 312e  rement for 3.11.
+0001f1a0: 0a20 2020 2020 2020 2027 646f 636b 6572  .        'docker
+0001f1b0: 3a63 6f6e 7469 6e75 756d 696f 2f6d 696e  :continuumio/min
+0001f1c0: 6963 6f6e 6461 333a 3234 2e31 2e32 2d30  iconda3:24.1.2-0
+0001f1d0: 272c 0a20 2020 205d 290a 6465 6620 7465  ',.    ]).def te
+0001f1e0: 7374 5f6b 7562 6572 6e65 7465 735f 6375  st_kubernetes_cu
+0001f1f0: 7374 6f6d 5f69 6d61 6765 2869 6d61 6765  stom_image(image
+0001f200: 5f69 6429 3a0a 2020 2020 2222 2254 6573  _id):.    """Tes
+0001f210: 7420 4b75 6265 726e 6574 6573 2063 7573  t Kubernetes cus
+0001f220: 746f 6d20 696d 6167 6522 2222 0a20 2020  tom image""".   
+0001f230: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+0001f240: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+0001f250: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+0001f260: 2020 2020 2027 7465 7374 2d6b 7562 6572       'test-kuber
+0001f270: 6e65 7465 732d 6375 7374 6f6d 2d69 6d61  netes-custom-ima
+0001f280: 6765 272c 0a20 2020 2020 2020 205b 0a20  ge',.        [. 
+0001f290: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001f2a0: 206c 6175 6e63 6820 2d63 207b 6e61 6d65   launch -c {name
+0001f2b0: 7d20 2d2d 7265 7472 792d 756e 7469 6c2d  } --retry-until-
+0001f2c0: 7570 202d 7920 7465 7374 732f 7465 7374  up -y tests/test
+0001f2d0: 5f79 616d 6c73 2f74 6573 745f 6375 7374  _yamls/test_cust
+0001f2e0: 6f6d 5f69 6d61 6765 2e79 616d 6c20 2d2d  om_image.yaml --
+0001f2f0: 636c 6f75 6420 6b75 6265 726e 6574 6573  cloud kubernetes
+0001f300: 202d 2d69 6d61 6765 2d69 6420 7b69 6d61   --image-id {ima
+0001f310: 6765 5f69 647d 202d 2d72 6567 696f 6e20  ge_id} --region 
+0001f320: 4e6f 6e65 202d 2d67 7075 7320 5434 3a31  None --gpus T4:1
+0001f330: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001f340: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+0001f350: 2031 202d 2d73 7461 7475 7327 2c0a 2020   1 --status',.  
+0001f360: 2020 2020 2020 2020 2020 2320 5472 7920            # Try 
+0001f370: 6578 6563 2074 6f20 7275 6e20 6167 6169  exec to run agai
+0001f380: 6e20 616e 6420 6368 6563 6b20 6966 2074  n and check if t
+0001f390: 6865 206c 6f67 7320 6172 6520 7072 696e  he logs are prin
+0001f3a0: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
+0001f3b0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+0001f3c0: 7d20 7465 7374 732f 7465 7374 5f79 616d  } tests/test_yam
+0001f3d0: 6c73 2f74 6573 745f 6375 7374 6f6d 5f69  ls/test_custom_i
+0001f3e0: 6d61 6765 2e79 616d 6c20 2d2d 636c 6f75  mage.yaml --clou
+0001f3f0: 6420 6b75 6265 726e 6574 6573 202d 2d69  d kubernetes --i
+0001f400: 6d61 6765 2d69 6420 7b69 6d61 6765 5f69  mage-id {image_i
+0001f410: 647d 202d 2d72 6567 696f 6e20 4e6f 6e65  d} --region None
+0001f420: 202d 2d67 7075 7320 5434 3a31 207c 2067   --gpus T4:1 | g
+0001f430: 7265 7020 2248 656c 6c6f 2031 3030 2227  rep "Hello 100"'
+0001f440: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+0001f450: 4d61 6b65 2073 7572 6520 7373 6820 6973  Make sure ssh is
+0001f460: 2077 6f72 6b69 6e67 2077 6974 6820 6375   working with cu
+0001f470: 7374 6f6d 2075 7365 726e 616d 650a 2020  stom username.  
+0001f480: 2020 2020 2020 2020 2020 6627 7373 6820            f'ssh 
+0001f490: 7b6e 616d 657d 2065 6368 6f20 6869 207c  {name} echo hi |
+0001f4a0: 2067 7265 7020 6869 272c 0a20 2020 2020   grep hi',.     
+0001f4b0: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+0001f4c0: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+0001f4d0: 657d 272c 0a20 2020 2020 2020 2074 696d  e}',.        tim
+0001f4e0: 656f 7574 3d33 3020 2a20 3630 2c0a 2020  eout=30 * 60,.  
+0001f4f0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+0001f500: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+0001f510: 7465 7374 2e6d 6172 6b2e 736c 6f77 0a64  test.mark.slow.d
+0001f520: 6566 2074 6573 745f 617a 7572 655f 7374  ef test_azure_st
+0001f530: 6172 745f 7374 6f70 5f74 776f 5f6e 6f64  art_stop_two_nod
+0001f540: 6573 2829 3a0a 2020 2020 6e61 6d65 203d  es():.    name =
+0001f550: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+0001f560: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+0001f570: 5465 7374 280a 2020 2020 2020 2020 2761  Test(.        'a
+0001f580: 7a75 7265 2d73 7461 7274 2d73 746f 702d  zure-start-stop-
+0001f590: 7477 6f2d 6e6f 6465 7327 2c0a 2020 2020  two-nodes',.    
+0001f5a0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+0001f5b0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+0001f5c0: 2d6e 756d 2d6e 6f64 6573 3d32 202d 7920  -num-nodes=2 -y 
+0001f5d0: 2d63 207b 6e61 6d65 7d20 6578 616d 706c  -c {name} exampl
+0001f5e0: 6573 2f61 7a75 7265 5f73 7461 7274 5f73  es/azure_start_s
+0001f5f0: 746f 702e 7961 6d6c 272c 0a20 2020 2020  top.yaml',.     
+0001f600: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0001f610: 6320 2d2d 6e75 6d2d 6e6f 6465 733d 3220  c --num-nodes=2 
+0001f620: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
+0001f630: 617a 7572 655f 7374 6172 745f 7374 6f70  azure_start_stop
+0001f640: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+0001f650: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0001f660: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+0001f670: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+0001f680: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+0001f690: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0001f6a0: 7920 7374 6f70 202d 7920 7b6e 616d 657d  y stop -y {name}
+0001f6b0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001f6c0: 2773 6b79 2073 7461 7274 202d 7920 7b6e  'sky start -y {n
+0001f6d0: 616d 657d 202d 6920 3127 2c0a 2020 2020  ame} -i 1',.    
+0001f6e0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+0001f6f0: 6563 202d 2d6e 756d 2d6e 6f64 6573 3d32  ec --num-nodes=2
+0001f700: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
+0001f710: 2f61 7a75 7265 5f73 7461 7274 5f73 746f  /azure_start_sto
+0001f720: 702e 7961 6d6c 272c 0a20 2020 2020 2020  p.yaml',.       
+0001f730: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+0001f740: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
+0001f750: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+0001f760: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+0001f770: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0001f780: 6565 7020 3230 3027 2c0a 2020 2020 2020  eep 200',.      
+0001f790: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
+0001f7a0: 7374 6174 7573 202d 7220 7b6e 616d 657d  status -r {name}
+0001f7b0: 2920 2626 2065 6368 6f20 2224 7322 2026  ) && echo "$s" &
+0001f7c0: 2620 6563 686f 2022 2473 2220 7c20 6772  & echo "$s" | gr
+0001f7d0: 6570 2022 494e 4954 5c7c 5354 4f50 5045  ep "INIT\|STOPPE
+0001f7e0: 4422 270a 2020 2020 2020 2020 2020 2020  D"'.            
+0001f7f0: 6627 7c7c 207b 7b20 7373 6820 7b6e 616d  f'|| {{ ssh {nam
+0001f800: 657d 2022 6361 7420 7e2f 2e73 6b79 2f73  e} "cat ~/.sky/s
+0001f810: 6b79 6c65 742e 6c6f 6722 3b20 6578 6974  kylet.log"; exit
+0001f820: 2031 3b20 7d7d 270a 2020 2020 2020 2020   1; }}'.        
+0001f830: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+0001f840: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+0001f850: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+0001f860: 743d 3330 202a 2036 302c 2020 2320 3330  t=30 * 60,  # 30
+0001f870: 206d 696e 7320 2028 6974 2074 616b 6573   mins  (it takes
+0001f880: 2061 726f 756e 6420 7e32 3320 6d69 6e73   around ~23 mins
+0001f890: 290a 2020 2020 290a 2020 2020 7275 6e5f  ).    ).    run_
+0001f8a0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+0001f8b0: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
+0001f8c0: 7374 696e 6720 656e 7620 666f 7220 6469  sting env for di
+0001f8d0: 736b 2074 6965 7220 2d2d 2d2d 2d2d 2d2d  sk tier --------
+0001f8e0: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
+0001f8f0: 6177 730a 6465 6620 7465 7374 5f61 7773  aws.def test_aws
+0001f900: 5f64 6973 6b5f 7469 6572 2829 3a0a 0a20  _disk_tier():.. 
+0001f910: 2020 2064 6566 205f 6765 745f 6177 735f     def _get_aws_
+0001f920: 7175 6572 795f 636f 6d6d 616e 6428 7265  query_command(re
+0001f930: 6769 6f6e 2c20 696e 7374 616e 6365 5f69  gion, instance_i
+0001f940: 642c 2066 6965 6c64 2c20 6578 7065 6374  d, field, expect
+0001f950: 6564 293a 0a20 2020 2020 2020 2072 6574  ed):.        ret
+0001f960: 7572 6e20 2866 2761 7773 2065 6332 2064  urn (f'aws ec2 d
+0001f970: 6573 6372 6962 652d 766f 6c75 6d65 7320  escribe-volumes 
+0001f980: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
+0001f990: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
+0001f9a0: 2020 2020 6627 2d2d 6669 6c74 6572 7320      f'--filters 
+0001f9b0: 4e61 6d65 3d61 7474 6163 686d 656e 742e  Name=attachment.
+0001f9c0: 696e 7374 616e 6365 2d69 642c 5661 6c75  instance-id,Valu
+0001f9d0: 6573 3d7b 696e 7374 616e 6365 5f69 647d  es={instance_id}
+0001f9e0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0001f9f0: 2020 2066 272d 2d71 7565 7279 2056 6f6c     f'--query Vol
+0001fa00: 756d 6573 5b2a 5d2e 7b66 6965 6c64 7d20  umes[*].{field} 
+0001fa10: 7c20 6772 6570 207b 6578 7065 6374 6564  | grep {expected
+0001fa20: 7d20 3b20 2729 0a0a 2020 2020 666f 7220  } ; ')..    for 
+0001fa30: 6469 736b 5f74 6965 7220 696e 206c 6973  disk_tier in lis
+0001fa40: 7428 7265 736f 7572 6365 735f 7574 696c  t(resources_util
+0001fa50: 732e 4469 736b 5469 6572 293a 0a20 2020  s.DiskTier):.   
+0001fa60: 2020 2020 2073 7065 6373 203d 2041 5753       specs = AWS
+0001fa70: 2e5f 6765 745f 6469 736b 5f73 7065 6373  ._get_disk_specs
+0001fa80: 2864 6973 6b5f 7469 6572 290a 2020 2020  (disk_tier).    
+0001fa90: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+0001faa0: 636c 7573 7465 725f 6e61 6d65 2829 202b  cluster_name() +
+0001fab0: 2027 2d27 202b 2064 6973 6b5f 7469 6572   '-' + disk_tier
+0001fac0: 2e76 616c 7565 0a20 2020 2020 2020 206e  .value.        n
+0001fad0: 616d 655f 6f6e 5f63 6c6f 7564 203d 2063  ame_on_cloud = c
+0001fae0: 6f6d 6d6f 6e5f 7574 696c 732e 6d61 6b65  ommon_utils.make
+0001faf0: 5f63 6c75 7374 6572 5f6e 616d 655f 6f6e  _cluster_name_on
+0001fb00: 5f63 6c6f 7564 280a 2020 2020 2020 2020  _cloud(.        
+0001fb10: 2020 2020 6e61 6d65 2c20 736b 792e 4157      name, sky.AW
+0001fb20: 532e 6d61 785f 636c 7573 7465 725f 6e61  S.max_cluster_na
+0001fb30: 6d65 5f6c 656e 6774 6828 2929 0a20 2020  me_length()).   
+0001fb40: 2020 2020 2072 6567 696f 6e20 3d20 2775       region = 'u
+0001fb50: 732d 6561 7374 2d32 270a 2020 2020 2020  s-east-2'.      
+0001fb60: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+0001fb70: 2020 2020 2020 2020 2020 2027 6177 732d             'aws-
+0001fb80: 6469 736b 2d74 6965 722d 2720 2b20 6469  disk-tier-' + di
+0001fb90: 736b 5f74 6965 722e 7661 6c75 652c 0a20  sk_tier.value,. 
+0001fba0: 2020 2020 2020 2020 2020 205b 0a20 2020             [.   
+0001fbb0: 2020 2020 2020 2020 2020 2020 2066 2773               f's
+0001fbc0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+0001fbd0: 7b6e 616d 657d 202d 2d63 6c6f 7564 2061  {name} --cloud a
+0001fbe0: 7773 202d 2d72 6567 696f 6e20 7b72 6567  ws --region {reg
+0001fbf0: 696f 6e7d 2027 0a20 2020 2020 2020 2020  ion} '.         
+0001fc00: 2020 2020 2020 2066 272d 2d64 6973 6b2d         f'--disk-
+0001fc10: 7469 6572 207b 6469 736b 5f74 6965 722e  tier {disk_tier.
+0001fc20: 7661 6c75 657d 2065 6368 6f20 2268 656c  value} echo "hel
+0001fc30: 6c6f 2073 6b79 2227 2c0a 2020 2020 2020  lo sky"',.      
+0001fc40: 2020 2020 2020 2020 2020 6627 6964 3d60            f'id=`
+0001fc50: 6177 7320 6563 3220 6465 7363 7269 6265  aws ec2 describe
+0001fc60: 2d69 6e73 7461 6e63 6573 202d 2d72 6567  -instances --reg
+0001fc70: 696f 6e20 7b72 6567 696f 6e7d 202d 2d66  ion {region} --f
+0001fc80: 696c 7465 7273 2027 0a20 2020 2020 2020  ilters '.       
+0001fc90: 2020 2020 2020 2020 2066 274e 616d 653d           f'Name=
+0001fca0: 7461 673a 7261 792d 636c 7573 7465 722d  tag:ray-cluster-
+0001fcb0: 6e61 6d65 2c56 616c 7565 733d 7b6e 616d  name,Values={nam
+0001fcc0: 655f 6f6e 5f63 6c6f 7564 7d20 2d2d 7175  e_on_cloud} --qu
+0001fcd0: 6572 7920 270a 2020 2020 2020 2020 2020  ery '.          
+0001fce0: 2020 2020 2020 6627 5265 7365 7276 6174        f'Reservat
+0001fcf0: 696f 6e73 5b5d 2e49 6e73 7461 6e63 6573  ions[].Instances
+0001fd00: 5b5d 2e49 6e73 7461 6e63 6549 6420 2d2d  [].InstanceId --
+0001fd10: 6f75 7470 7574 2074 6578 7460 3b20 2720  output text`; ' 
+0001fd20: 2b0a 2020 2020 2020 2020 2020 2020 2020  +.              
+0001fd30: 2020 5f67 6574 5f61 7773 5f71 7565 7279    _get_aws_query
+0001fd40: 5f63 6f6d 6d61 6e64 2872 6567 696f 6e2c  _command(region,
+0001fd50: 2027 2469 6427 2c20 2756 6f6c 756d 6554   '$id', 'VolumeT
+0001fd60: 7970 6527 2c0a 2020 2020 2020 2020 2020  ype',.          
+0001fd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fd80: 2020 2020 2020 2020 2020 2020 2073 7065               spe
+0001fd90: 6373 5b27 6469 736b 5f74 6965 7227 5d29  cs['disk_tier'])
+0001fda0: 202b 0a20 2020 2020 2020 2020 2020 2020   +.             
+0001fdb0: 2020 2028 2727 2069 6620 6469 736b 5f74     ('' if disk_t
+0001fdc0: 6965 7220 3d3d 2072 6573 6f75 7263 6573  ier == resources
+0001fdd0: 5f75 7469 6c73 2e44 6973 6b54 6965 722e  _utils.DiskTier.
+0001fde0: 4c4f 5720 656c 7365 0a20 2020 2020 2020  LOW else.       
+0001fdf0: 2020 2020 2020 2020 2020 285f 6765 745f            (_get_
+0001fe00: 6177 735f 7175 6572 795f 636f 6d6d 616e  aws_query_comman
+0001fe10: 6428 7265 6769 6f6e 2c20 2724 6964 272c  d(region, '$id',
+0001fe20: 2027 496f 7073 272c 0a20 2020 2020 2020   'Iops',.       
+0001fe30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fe40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fe50: 2020 7370 6563 735b 2764 6973 6b5f 696f    specs['disk_io
+0001fe60: 7073 275d 2920 2b0a 2020 2020 2020 2020  ps']) +.        
+0001fe70: 2020 2020 2020 2020 2020 5f67 6574 5f61            _get_a
+0001fe80: 7773 5f71 7565 7279 5f63 6f6d 6d61 6e64  ws_query_command
+0001fe90: 2872 6567 696f 6e2c 2027 2469 6427 2c20  (region, '$id', 
+0001fea0: 2754 6872 6f75 6768 7075 7427 2c0a 2020  'Throughput',.  
 0001feb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fec0: 2073 7065 6373 5b27 6469 736b 5f74 6872   specs['disk_thr
-0001fed0: 6f75 6768 7075 7427 5d29 2929 2c0a 2020  oughput']))),.  
-0001fee0: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
-0001fef0: 2020 2020 2020 2020 2066 2773 6b79 2064           f'sky d
-0001ff00: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-0001ff10: 2020 2020 2020 2020 2020 2020 7469 6d65              time
-0001ff20: 6f75 743d 3130 202a 2036 302c 2020 2320  out=10 * 60,  # 
-0001ff30: 3130 206d 696e 7320 2028 6974 2074 616b  10 mins  (it tak
-0001ff40: 6573 2061 726f 756e 6420 7e36 206d 696e  es around ~6 min
-0001ff50: 7329 0a20 2020 2020 2020 2029 0a20 2020  s).        ).   
-0001ff60: 2020 2020 2072 756e 5f6f 6e65 5f74 6573       run_one_tes
-0001ff70: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-0001ff80: 742e 6d61 726b 2e67 6370 0a64 6566 2074  t.mark.gcp.def t
-0001ff90: 6573 745f 6763 705f 6469 736b 5f74 6965  est_gcp_disk_tie
-0001ffa0: 7228 293a 0a20 2020 2066 6f72 2064 6973  r():.    for dis
-0001ffb0: 6b5f 7469 6572 2069 6e20 6c69 7374 2872  k_tier in list(r
-0001ffc0: 6573 6f75 7263 6573 5f75 7469 6c73 2e44  esources_utils.D
-0001ffd0: 6973 6b54 6965 7229 3a0a 2020 2020 2020  iskTier):.      
-0001ffe0: 2020 7479 7065 203d 2047 4350 2e5f 6765    type = GCP._ge
-0001fff0: 745f 6469 736b 5f74 7970 6528 6469 736b  t_disk_type(disk
-00020000: 5f74 6965 7229 0a20 2020 2020 2020 206e  _tier).        n
-00020010: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00020020: 6572 5f6e 616d 6528 2920 2b20 272d 2720  er_name() + '-' 
-00020030: 2b20 6469 736b 5f74 6965 722e 7661 6c75  + disk_tier.valu
-00020040: 650a 2020 2020 2020 2020 6e61 6d65 5f6f  e.        name_o
-00020050: 6e5f 636c 6f75 6420 3d20 636f 6d6d 6f6e  n_cloud = common
-00020060: 5f75 7469 6c73 2e6d 616b 655f 636c 7573  _utils.make_clus
-00020070: 7465 725f 6e61 6d65 5f6f 6e5f 636c 6f75  ter_name_on_clou
-00020080: 6428 0a20 2020 2020 2020 2020 2020 206e  d(.            n
-00020090: 616d 652c 2073 6b79 2e47 4350 2e6d 6178  ame, sky.GCP.max
-000200a0: 5f63 6c75 7374 6572 5f6e 616d 655f 6c65  _cluster_name_le
-000200b0: 6e67 7468 2829 290a 2020 2020 2020 2020  ngth()).        
-000200c0: 7265 6769 6f6e 203d 2027 7573 2d77 6573  region = 'us-wes
-000200d0: 7432 270a 2020 2020 2020 2020 7465 7374  t2'.        test
-000200e0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-000200f0: 2020 2020 2027 6763 702d 6469 736b 2d74       'gcp-disk-t
-00020100: 6965 722d 2720 2b20 6469 736b 5f74 6965  ier-' + disk_tie
-00020110: 722e 7661 6c75 652c 0a20 2020 2020 2020  r.value,.       
-00020120: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00020130: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00020140: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-00020150: 202d 2d63 6c6f 7564 2067 6370 202d 2d72   --cloud gcp --r
-00020160: 6567 696f 6e20 7b72 6567 696f 6e7d 2027  egion {region} '
-00020170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020180: 2066 272d 2d64 6973 6b2d 7469 6572 207b   f'--disk-tier {
-00020190: 6469 736b 5f74 6965 722e 7661 6c75 657d  disk_tier.value}
-000201a0: 2065 6368 6f20 2268 656c 6c6f 2073 6b79   echo "hello sky
-000201b0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-000201c0: 2020 2020 6627 6e61 6d65 3d60 6763 6c6f      f'name=`gclo
-000201d0: 7564 2063 6f6d 7075 7465 2069 6e73 7461  ud compute insta
-000201e0: 6e63 6573 206c 6973 7420 2d2d 6669 6c74  nces list --filt
-000201f0: 6572 3d27 0a20 2020 2020 2020 2020 2020  er='.           
-00020200: 2020 2020 2066 2722 6c61 6265 6c73 2e72       f'"labels.r
-00020210: 6179 2d63 6c75 7374 6572 2d6e 616d 653a  ay-cluster-name:
-00020220: 7b6e 616d 655f 6f6e 5f63 6c6f 7564 7d22  {name_on_cloud}"
-00020230: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00020240: 2020 2027 2d2d 666f 726d 6174 3d22 7661     '--format="va
-00020250: 6c75 6528 6e61 6d65 2922 603b 2027 0a20  lue(name)"`; '. 
-00020260: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00020270: 2767 636c 6f75 6420 636f 6d70 7574 6520  'gcloud compute 
-00020280: 6469 736b 7320 6c69 7374 202d 2d66 696c  disks list --fil
-00020290: 7465 723d 226e 616d 653d 246e 616d 6522  ter="name=$name"
-000202a0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-000202b0: 2020 2066 272d 2d66 6f72 6d61 743d 2276     f'--format="v
-000202c0: 616c 7565 2874 7970 6529 2220 7c20 6772  alue(type)" | gr
-000202d0: 6570 207b 7479 7065 7d20 270a 2020 2020  ep {type} '.    
-000202e0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-000202f0: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-00020300: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-00020310: 2020 2020 2020 2020 2020 7469 6d65 6f75            timeou
-00020320: 743d 3620 2a20 3630 2c20 2023 2036 206d  t=6 * 60,  # 6 m
-00020330: 696e 7320 2028 6974 2074 616b 6573 2061  ins  (it takes a
-00020340: 726f 756e 6420 7e33 206d 696e 7329 0a20  round ~3 mins). 
-00020350: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00020360: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00020370: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00020380: 726b 2e61 7a75 7265 0a64 6566 2074 6573  rk.azure.def tes
-00020390: 745f 617a 7572 655f 6469 736b 5f74 6965  t_azure_disk_tie
-000203a0: 7228 293a 0a20 2020 2066 6f72 2064 6973  r():.    for dis
-000203b0: 6b5f 7469 6572 2069 6e20 6c69 7374 2872  k_tier in list(r
-000203c0: 6573 6f75 7263 6573 5f75 7469 6c73 2e44  esources_utils.D
-000203d0: 6973 6b54 6965 7229 3a0a 2020 2020 2020  iskTier):.      
-000203e0: 2020 6966 2064 6973 6b5f 7469 6572 203d    if disk_tier =
-000203f0: 3d20 7265 736f 7572 6365 735f 7574 696c  = resources_util
-00020400: 732e 4469 736b 5469 6572 2e48 4947 483a  s.DiskTier.HIGH:
-00020410: 0a20 2020 2020 2020 2020 2020 2023 2041  .            # A
-00020420: 7a75 7265 2064 6f65 7320 6e6f 7420 7375  zure does not su
-00020430: 7070 6f72 7420 6869 6768 2064 6973 6b20  pport high disk 
-00020440: 7469 6572 2e0a 2020 2020 2020 2020 2020  tier..          
-00020450: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-00020460: 2020 2074 7970 6520 3d20 417a 7572 652e     type = Azure.
-00020470: 5f67 6574 5f64 6973 6b5f 7479 7065 2864  _get_disk_type(d
-00020480: 6973 6b5f 7469 6572 290a 2020 2020 2020  isk_tier).      
-00020490: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-000204a0: 7573 7465 725f 6e61 6d65 2829 202b 2027  uster_name() + '
-000204b0: 2d27 202b 2064 6973 6b5f 7469 6572 2e76  -' + disk_tier.v
-000204c0: 616c 7565 0a20 2020 2020 2020 206e 616d  alue.        nam
-000204d0: 655f 6f6e 5f63 6c6f 7564 203d 2063 6f6d  e_on_cloud = com
-000204e0: 6d6f 6e5f 7574 696c 732e 6d61 6b65 5f63  mon_utils.make_c
-000204f0: 6c75 7374 6572 5f6e 616d 655f 6f6e 5f63  luster_name_on_c
-00020500: 6c6f 7564 280a 2020 2020 2020 2020 2020  loud(.          
-00020510: 2020 6e61 6d65 2c20 736b 792e 417a 7572    name, sky.Azur
-00020520: 652e 6d61 785f 636c 7573 7465 725f 6e61  e.max_cluster_na
-00020530: 6d65 5f6c 656e 6774 6828 2929 0a20 2020  me_length()).   
-00020540: 2020 2020 2072 6567 696f 6e20 3d20 2777       region = 'w
-00020550: 6573 7475 7332 270a 2020 2020 2020 2020  estus2'.        
-00020560: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00020570: 2020 2020 2020 2020 2027 617a 7572 652d           'azure-
-00020580: 6469 736b 2d74 6965 722d 2720 2b20 6469  disk-tier-' + di
-00020590: 736b 5f74 6965 722e 7661 6c75 652c 0a20  sk_tier.value,. 
-000205a0: 2020 2020 2020 2020 2020 205b 0a20 2020             [.   
-000205b0: 2020 2020 2020 2020 2020 2020 2066 2773               f's
-000205c0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-000205d0: 7b6e 616d 657d 202d 2d63 6c6f 7564 2061  {name} --cloud a
-000205e0: 7a75 7265 202d 2d72 6567 696f 6e20 7b72  zure --region {r
-000205f0: 6567 696f 6e7d 2027 0a20 2020 2020 2020  egion} '.       
-00020600: 2020 2020 2020 2020 2066 272d 2d64 6973           f'--dis
-00020610: 6b2d 7469 6572 207b 6469 736b 5f74 6965  k-tier {disk_tie
-00020620: 722e 7661 6c75 657d 2065 6368 6f20 2268  r.value} echo "h
-00020630: 656c 6c6f 2073 6b79 2227 2c0a 2020 2020  ello sky"',.    
-00020640: 2020 2020 2020 2020 2020 2020 6627 617a              f'az
-00020650: 2072 6573 6f75 7263 6520 6c69 7374 202d   resource list -
-00020660: 2d74 6167 2072 6179 2d63 6c75 7374 6572  -tag ray-cluster
-00020670: 2d6e 616d 653d 7b6e 616d 655f 6f6e 5f63  -name={name_on_c
-00020680: 6c6f 7564 7d20 2d2d 7175 6572 7920 270a  loud} --query '.
-00020690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000206a0: 6627 225b 3f74 7970 653d 3d5c 274d 6963  f'"[?type==\'Mic
-000206b0: 726f 736f 6674 2e43 6f6d 7075 7465 2f64  rosoft.Compute/d
-000206c0: 6973 6b73 5c27 5d2e 736b 752e 6e61 6d65  isks\'].sku.name
-000206d0: 2220 270a 2020 2020 2020 2020 2020 2020  " '.            
-000206e0: 2020 2020 6627 2d2d 6f75 7470 7574 2074      f'--output t
-000206f0: 7376 207c 2067 7265 7020 7b74 7970 657d  sv | grep {type}
-00020700: 270a 2020 2020 2020 2020 2020 2020 5d2c  '.            ],
-00020710: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00020720: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00020730: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-00020740: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
-00020750: 2020 2320 3230 206d 696e 7320 2028 6974    # 20 mins  (it
-00020760: 2074 616b 6573 2061 726f 756e 6420 7e31   takes around ~1
-00020770: 3220 6d69 6e73 290a 2020 2020 2020 2020  2 mins).        
-00020780: 290a 2020 2020 2020 2020 7275 6e5f 6f6e  ).        run_on
-00020790: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-000207a0: 7079 7465 7374 2e6d 6172 6b2e 617a 7572  pytest.mark.azur
-000207b0: 650a 6465 6620 7465 7374 5f61 7a75 7265  e.def test_azure
-000207c0: 5f62 6573 745f 7469 6572 5f66 6169 6c6f  _best_tier_failo
-000207d0: 7665 7228 293a 0a20 2020 2074 7970 6520  ver():.    type 
-000207e0: 3d20 417a 7572 652e 5f67 6574 5f64 6973  = Azure._get_dis
-000207f0: 6b5f 7479 7065 2872 6573 6f75 7263 6573  k_type(resources
-00020800: 5f75 7469 6c73 2e44 6973 6b54 6965 722e  _utils.DiskTier.
-00020810: 4c4f 5729 0a20 2020 206e 616d 6520 3d20  LOW).    name = 
-00020820: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00020830: 6528 290a 2020 2020 6e61 6d65 5f6f 6e5f  e().    name_on_
-00020840: 636c 6f75 6420 3d20 636f 6d6d 6f6e 5f75  cloud = common_u
-00020850: 7469 6c73 2e6d 616b 655f 636c 7573 7465  tils.make_cluste
-00020860: 725f 6e61 6d65 5f6f 6e5f 636c 6f75 6428  r_name_on_cloud(
-00020870: 0a20 2020 2020 2020 206e 616d 652c 2073  .        name, s
-00020880: 6b79 2e41 7a75 7265 2e6d 6178 5f63 6c75  ky.Azure.max_clu
-00020890: 7374 6572 5f6e 616d 655f 6c65 6e67 7468  ster_name_length
-000208a0: 2829 290a 2020 2020 7265 6769 6f6e 203d  ()).    region =
-000208b0: 2027 7765 7374 7573 3227 0a20 2020 2074   'westus2'.    t
-000208c0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-000208d0: 2020 2020 2761 7a75 7265 2d62 6573 742d      'azure-best-
-000208e0: 7469 6572 2d66 6169 6c6f 7665 7227 2c0a  tier-failover',.
-000208f0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00020900: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00020910: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-00020920: 2d2d 636c 6f75 6420 617a 7572 6520 2d2d  --cloud azure --
-00020930: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-00020940: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
-00020950: 2d2d 6469 736b 2d74 6965 7220 6265 7374  --disk-tier best
-00020960: 202d 2d69 6e73 7461 6e63 652d 7479 7065   --instance-type
-00020970: 2053 7461 6e64 6172 645f 4438 5f76 3520   Standard_D8_v5 
-00020980: 6563 686f 2022 6865 6c6c 6f20 736b 7922  echo "hello sky"
-00020990: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000209a0: 2761 7a20 7265 736f 7572 6365 206c 6973  'az resource lis
-000209b0: 7420 2d2d 7461 6720 7261 792d 636c 7573  t --tag ray-clus
-000209c0: 7465 722d 6e61 6d65 3d7b 6e61 6d65 5f6f  ter-name={name_o
-000209d0: 6e5f 636c 6f75 647d 202d 2d71 7565 7279  n_cloud} --query
-000209e0: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
-000209f0: 2722 5b3f 7479 7065 3d3d 5c27 4d69 6372  '"[?type==\'Micr
-00020a00: 6f73 6f66 742e 436f 6d70 7574 652f 6469  osoft.Compute/di
-00020a10: 736b 735c 275d 2e73 6b75 2e6e 616d 6522  sks\'].sku.name"
-00020a20: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
-00020a30: 272d 2d6f 7574 7075 7420 7473 7620 7c20  '--output tsv | 
-00020a40: 6772 6570 207b 7479 7065 7d27 2c0a 2020  grep {type}',.  
-00020a50: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00020a60: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00020a70: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
-00020a80: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
-00020a90: 2020 2320 3230 206d 696e 7320 2028 6974    # 20 mins  (it
-00020aa0: 2074 616b 6573 2061 726f 756e 6420 7e31   takes around ~1
-00020ab0: 3220 6d69 6e73 290a 2020 2020 290a 2020  2 mins).    ).  
-00020ac0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00020ad0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d20  est)...# ------ 
-00020ae0: 5465 7374 696e 6720 5a65 726f 2051 756f  Testing Zero Quo
-00020af0: 7461 2046 6169 6c6f 7665 7220 2d2d 2d2d  ta Failover ----
-00020b00: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
-00020b10: 6177 730a 6465 6620 7465 7374 5f61 7773  aws.def test_aws
-00020b20: 5f7a 6572 6f5f 7175 6f74 615f 6661 696c  _zero_quota_fail
-00020b30: 6f76 6572 2829 3a0a 0a20 2020 206e 616d  over():..    nam
-00020b40: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00020b50: 5f6e 616d 6528 290a 2020 2020 7265 6769  _name().    regi
-00020b60: 6f6e 203d 2067 6574 5f61 7773 5f72 6567  on = get_aws_reg
-00020b70: 696f 6e5f 666f 725f 7175 6f74 615f 6661  ion_for_quota_fa
-00020b80: 696c 6f76 6572 2829 0a0a 2020 2020 6966  ilover()..    if
-00020b90: 206e 6f74 2072 6567 696f 6e3a 0a20 2020   not region:.   
-00020ba0: 2020 2020 2070 7974 6573 742e 7866 6169       pytest.xfai
-00020bb0: 6c28 0a20 2020 2020 2020 2020 2020 2027  l(.            '
-00020bc0: 556e 6162 6c65 2074 6f20 7465 7374 207a  Unable to test z
-00020bd0: 6572 6f20 7175 6f74 6120 6661 696c 6f76  ero quota failov
-00020be0: 6572 206f 7074 696d 697a 6174 696f 6e20  er optimization 
-00020bf0: e280 9420 7175 6f74 6173 2027 0a20 2020  ... quotas '.   
-00020c00: 2020 2020 2020 2020 2027 666f 7220 4543           'for EC
-00020c10: 3220 5033 2069 6e73 7461 6e63 6573 2077  2 P3 instances w
-00020c20: 6572 6520 666f 756e 6420 6f6e 2061 6c6c  ere found on all
-00020c30: 2041 5753 2072 6567 696f 6e73 2e20 4973   AWS regions. Is
-00020c40: 2074 6869 7320 270a 2020 2020 2020 2020   this '.        
-00020c50: 2020 2020 2765 7870 6563 7465 6420 666f      'expected fo
-00020c60: 7220 796f 7572 2061 6363 6f75 6e74 3f27  r your account?'
-00020c70: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00020c80: 0a0a 2020 2020 7465 7374 203d 2054 6573  ..    test = Tes
-00020c90: 7428 0a20 2020 2020 2020 2027 6177 732d  t(.        'aws-
-00020ca0: 7a65 726f 2d71 756f 7461 2d66 6169 6c6f  zero-quota-failo
-00020cb0: 7665 7227 2c0a 2020 2020 2020 2020 5b0a  ver',.        [.
-00020cc0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00020cd0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-00020ce0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6177  name} --cloud aw
-00020cf0: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
-00020d00: 6f6e 7d20 2d2d 6770 7573 2056 3130 303a  on} --gpus V100:
-00020d10: 3820 2d2d 7573 652d 7370 6f74 207c 2067  8 --use-spot | g
-00020d20: 7265 7020 2246 6f75 6e64 206e 6f20 7175  rep "Found no qu
-00020d30: 6f74 6122 272c 0a20 2020 2020 2020 205d  ota"',.        ]
-00020d40: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00020d50: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-00020d60: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00020d70: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00020d80: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
-00020d90: 0a64 6566 2074 6573 745f 6763 705f 7a65  .def test_gcp_ze
-00020da0: 726f 5f71 756f 7461 5f66 6169 6c6f 7665  ro_quota_failove
-00020db0: 7228 293a 0a0a 2020 2020 6e61 6d65 203d  r():..    name =
-00020dc0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00020dd0: 6d65 2829 0a20 2020 2072 6567 696f 6e20  me().    region 
-00020de0: 3d20 6765 745f 6763 705f 7265 6769 6f6e  = get_gcp_region
-00020df0: 5f66 6f72 5f71 756f 7461 5f66 6169 6c6f  _for_quota_failo
-00020e00: 7665 7228 290a 0a20 2020 2069 6620 6e6f  ver()..    if no
-00020e10: 7420 7265 6769 6f6e 3a0a 2020 2020 2020  t region:.      
-00020e20: 2020 7079 7465 7374 2e78 6661 696c 280a    pytest.xfail(.
-00020e30: 2020 2020 2020 2020 2020 2020 2755 6e61              'Una
-00020e40: 626c 6520 746f 2074 6573 7420 7a65 726f  ble to test zero
-00020e50: 2071 756f 7461 2066 6169 6c6f 7665 7220   quota failover 
-00020e60: 6f70 7469 6d69 7a61 7469 6f6e 20e2 8094  optimization ...
-00020e70: 2071 756f 7461 7320 270a 2020 2020 2020   quotas '.      
-00020e80: 2020 2020 2020 2766 6f72 2041 3130 302d        'for A100-
-00020e90: 3830 4742 2047 5055 7320 7765 7265 2066  80GB GPUs were f
-00020ea0: 6f75 6e64 206f 6e20 616c 6c20 4743 5020  ound on all GCP 
-00020eb0: 7265 6769 6f6e 732e 2049 7320 7468 6973  regions. Is this
-00020ec0: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-00020ed0: 6578 7065 6374 6564 2066 6f72 2079 6f75  expected for you
-00020ee0: 7220 6163 636f 756e 743f 2729 0a20 2020  r account?').   
-00020ef0: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-00020f00: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00020f10: 2020 2020 2020 2767 6370 2d7a 6572 6f2d        'gcp-zero-
-00020f20: 7175 6f74 612d 6661 696c 6f76 6572 272c  quota-failover',
-00020f30: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-00020f40: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00020f50: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-00020f60: 202d 2d63 6c6f 7564 2067 6370 202d 2d72   --cloud gcp --r
-00020f70: 6567 696f 6e20 7b72 6567 696f 6e7d 202d  egion {region} -
-00020f80: 2d67 7075 7320 4131 3030 2d38 3047 423a  -gpus A100-80GB:
-00020f90: 3120 2d2d 7573 652d 7370 6f74 207c 2067  1 --use-spot | g
-00020fa0: 7265 7020 2246 6f75 6e64 206e 6f20 7175  rep "Found no qu
-00020fb0: 6f74 6122 272c 0a20 2020 2020 2020 205d  ota"',.        ]
-00020fc0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00020fd0: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-00020fe0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00020ff0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00021000: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
-00021010: 7469 6e67 2073 6b79 7365 7276 6520 2d2d  ting skyserve --
-00021020: 2d2d 2d2d 2d2d 2d2d 0a0a 0a64 6566 205f  --------...def _
-00021030: 6765 745f 7365 7276 6963 655f 6e61 6d65  get_service_name
-00021040: 2829 202d 3e20 7374 723a 0a20 2020 2022  () -> str:.    "
-00021050: 2222 5265 7475 726e 7320 6120 7573 6572  ""Returns a user
-00021060: 2d75 6e69 7175 6520 7365 7276 6963 6520  -unique service 
-00021070: 6e61 6d65 2066 6f72 2065 6163 6820 7465  name for each te
-00021080: 7374 5f73 6b79 7365 7276 655f 3c6e 616d  st_skyserve_<nam
-00021090: 653e 2829 2e0a 0a20 2020 204d 7573 7420  e>()...    Must 
-000210a0: 6265 2063 616c 6c65 6420 6672 6f6d 2065  be called from e
-000210b0: 6163 6820 7465 7374 5f73 6b79 7365 7276  ach test_skyserv
-000210c0: 655f 3c6e 616d 653e 2829 2e0a 2020 2020  e_<name>()..    
-000210d0: 2222 220a 2020 2020 6361 6c6c 6572 5f66  """.    caller_f
-000210e0: 756e 635f 6e61 6d65 203d 2069 6e73 7065  unc_name = inspe
-000210f0: 6374 2e73 7461 636b 2829 5b31 5d5b 335d  ct.stack()[1][3]
-00021100: 0a20 2020 2074 6573 745f 6e61 6d65 203d  .    test_name =
-00021110: 2063 616c 6c65 725f 6675 6e63 5f6e 616d   caller_func_nam
-00021120: 652e 7265 706c 6163 6528 275f 272c 2027  e.replace('_', '
-00021130: 2d27 292e 7265 706c 6163 6528 2774 6573  -').replace('tes
-00021140: 742d 272c 2027 742d 2729 0a20 2020 2074  t-', 't-').    t
-00021150: 6573 745f 6e61 6d65 203d 2074 6573 745f  est_name = test_
-00021160: 6e61 6d65 2e72 6570 6c61 6365 2827 736b  name.replace('sk
-00021170: 7973 6572 7665 2d27 2c20 2773 732d 2729  yserve-', 'ss-')
-00021180: 0a20 2020 2074 6573 745f 6e61 6d65 203d  .    test_name =
-00021190: 2063 6f6d 6d6f 6e5f 7574 696c 732e 6d61   common_utils.ma
-000211a0: 6b65 5f63 6c75 7374 6572 5f6e 616d 655f  ke_cluster_name_
-000211b0: 6f6e 5f63 6c6f 7564 2874 6573 745f 6e61  on_cloud(test_na
-000211c0: 6d65 2c20 3234 290a 2020 2020 7265 7475  me, 24).    retu
-000211d0: 726e 2066 277b 7465 7374 5f6e 616d 657d  rn f'{test_name}
-000211e0: 2d7b 7465 7374 5f69 647d 270a 0a0a 2320  -{test_id}'...# 
-000211f0: 5765 2063 6865 636b 2074 6865 206f 7574  We check the out
-00021200: 7075 7420 6f66 2074 6865 2073 6b79 7365  put of the skyse
-00021210: 7276 6520 7365 7276 6963 6520 746f 2073  rve service to s
-00021220: 6565 2069 6620 6974 2069 7320 7265 6164  ee if it is read
-00021230: 792e 204f 7574 7075 7420 6f66 0a23 2060  y. Output of.# `
-00021240: 5245 504c 4943 4153 6020 6973 2069 6e20  REPLICAS` is in 
-00021250: 7468 6520 666f 726d 206f 6620 6031 2f32  the form of `1/2
-00021260: 6020 7768 6572 6520 7468 6520 6669 7273  ` where the firs
-00021270: 7420 6e75 6d62 6572 2069 7320 7468 6520  t number is the 
-00021280: 6e75 6d62 6572 206f 660a 2320 7265 6164  number of.# read
-00021290: 7920 7265 706c 6963 6173 2061 6e64 2074  y replicas and t
-000212a0: 6865 2073 6563 6f6e 6420 6e75 6d62 6572  he second number
-000212b0: 2069 7320 7468 6520 6e75 6d62 6572 206f   is the number o
-000212c0: 6620 746f 7461 6c20 7265 706c 6963 6173  f total replicas
-000212d0: 2e20 5765 0a23 2067 7265 7020 7375 6368  . We.# grep such
-000212e0: 2066 6f72 6d61 7420 746f 2065 6e73 7572   format to ensur
-000212f0: 6520 7468 6174 2074 6865 2073 6572 7669  e that the servi
-00021300: 6365 2069 7320 7265 6164 792c 2061 6e64  ce is ready, and
-00021310: 2065 6172 6c79 2065 7869 7420 6966 2061   early exit if a
-00021320: 6e79 0a23 2066 6169 6c75 7265 2064 6574  ny.# failure det
-00021330: 6563 7465 642e 2049 6e20 7468 6520 656e  ected. In the en
-00021340: 6420 7765 2073 6c65 6570 2066 6f72 0a23  d we sleep for.#
-00021350: 2073 6572 7665 2e4c 425f 434f 4e54 524f   serve.LB_CONTRO
-00021360: 4c4c 4552 5f53 594e 435f 494e 5445 5256  LLER_SYNC_INTERV
-00021370: 414c 5f53 4543 4f4e 4453 2074 6f20 6d61  AL_SECONDS to ma
-00021380: 6b65 2073 7572 6520 6c6f 6164 2062 616c  ke sure load bal
-00021390: 616e 6365 7220 6861 7665 0a23 2065 6e6f  ancer have.# eno
-000213a0: 7567 6820 7469 6d65 2074 6f20 7379 6e63  ugh time to sync
-000213b0: 2077 6974 6820 7468 6520 636f 6e74 726f   with the contro
-000213c0: 6c6c 6572 2061 6e64 2067 6574 2061 6c6c  ller and get all
-000213d0: 2072 6561 6479 2072 6570 6c69 6361 2049   ready replica I
-000213e0: 5073 2e0a 5f53 4552 5645 5f57 4149 545f  Ps.._SERVE_WAIT_
-000213f0: 554e 5449 4c5f 5245 4144 5920 3d20 280a  UNTIL_READY = (.
-00021400: 2020 2020 277b 7b20 7768 696c 6520 7472      '{{ while tr
-00021410: 7565 3b20 646f 270a 2020 2020 2720 2020  ue; do'.    '   
-00021420: 2020 733d 2428 736b 7920 7365 7276 6520    s=$(sky serve 
-00021430: 7374 6174 7573 207b 6e61 6d65 7d29 3b20  status {name}); 
-00021440: 6563 686f 2022 2473 223b 270a 2020 2020  echo "$s";'.    
-00021450: 2720 2020 2020 6563 686f 2022 2473 2220  '     echo "$s" 
-00021460: 7c20 6772 6570 202d 7120 227b 7265 706c  | grep -q "{repl
-00021470: 6963 615f 6e75 6d7d 2f7b 7265 706c 6963  ica_num}/{replic
-00021480: 615f 6e75 6d7d 2220 2626 2062 7265 616b  a_num}" && break
-00021490: 3b27 0a20 2020 2027 2020 2020 2065 6368  ;'.    '     ech
-000214a0: 6f20 2224 7322 207c 2067 7265 7020 2d71  o "$s" | grep -q
-000214b0: 2022 4641 494c 4544 2220 2626 2065 7869   "FAILED" && exi
-000214c0: 7420 313b 270a 2020 2020 2720 2020 2020  t 1;'.    '     
-000214d0: 736c 6565 7020 3130 3b27 0a20 2020 2027  sleep 10;'.    '
-000214e0: 2064 6f6e 653b 207d 7d3b 2065 6368 6f20   done; }}; echo 
-000214f0: 2247 6f74 2073 6572 7669 6365 2073 7461  "Got service sta
-00021500: 7475 7320 2473 223b 270a 2020 2020 6627  tus $s";'.    f'
-00021510: 736c 6565 7020 7b73 6572 7665 2e4c 425f  sleep {serve.LB_
-00021520: 434f 4e54 524f 4c4c 4552 5f53 594e 435f  CONTROLLER_SYNC_
-00021530: 494e 5445 5256 414c 5f53 4543 4f4e 4453  INTERVAL_SECONDS
-00021540: 202b 2032 7d3b 2729 0a5f 4950 5f52 4547   + 2};')._IP_REG
-00021550: 4558 203d 2072 2728 5b30 2d39 5d7b 312c  EX = r'([0-9]{1,
-00021560: 337d 5c2e 297b 337d 5b30 2d39 5d7b 312c  3}\.){3}[0-9]{1,
-00021570: 337d 270a 5f41 574b 5f41 4c4c 5f4c 494e  3}'._AWK_ALL_LIN
-00021580: 4553 5f42 454c 4f57 5f52 4550 4c49 4341  ES_BELOW_REPLICA
-00021590: 5320 3d20 7227 2f52 6570 6c69 6361 732f  S = r'/Replicas/
-000215a0: 7b66 6c61 673d 313b 206e 6578 747d 2066  {flag=1; next} f
-000215b0: 6c61 6727 0a5f 5345 5256 4943 455f 4c41  lag'._SERVICE_LA
-000215c0: 554e 4348 494e 475f 5354 4154 5553 5f52  UNCHING_STATUS_R
-000215d0: 4547 4558 203d 2027 5052 4f56 4953 494f  EGEX = 'PROVISIO
-000215e0: 4e49 4e47 5c7c 5354 4152 5449 4e47 270a  NING\|STARTING'.
-000215f0: 2320 5369 6e63 6520 7765 2064 6f6e 2774  # Since we don't
-00021600: 2061 6c6c 6f77 2074 6572 6d69 6e61 7465   allow terminate
-00021610: 2074 6865 2073 6572 7669 6365 2069 6620   the service if 
-00021620: 7468 6520 636f 6e74 726f 6c6c 6572 2069  the controller i
-00021630: 7320 494e 4954 2c0a 2320 7768 6963 6820  s INIT,.# which 
-00021640: 6973 2063 6f6d 6d6f 6e20 666f 7220 7369  is common for si
-00021650: 6d75 6c74 616e 656f 7573 2070 7974 6573  multaneous pytes
-00021660: 742c 2077 6520 6e65 6564 2074 6f20 7761  t, we need to wa
-00021670: 6974 2075 6e74 696c 2074 6865 0a23 2063  it until the.# c
-00021680: 6f6e 7472 6f6c 6c65 7220 6973 2055 5020  ontroller is UP 
-00021690: 6265 666f 7265 2077 6520 6361 6e20 7465  before we can te
-000216a0: 726d 696e 6174 6520 7468 6520 7365 7276  rminate the serv
-000216b0: 6963 652e 0a23 2054 6865 2074 6561 7264  ice..# The teard
-000216c0: 6f77 6e20 636f 6d6d 616e 6420 6861 7320  own command has 
-000216d0: 6120 3130 2d6d 696e 7320 7469 6d65 6f75  a 10-mins timeou
-000216e0: 742c 2073 6f20 7765 2064 6f6e 2774 206e  t, so we don't n
-000216f0: 6565 6420 746f 2064 6f0a 2320 7468 6520  eed to do.# the 
-00021700: 7469 6d65 6f75 7420 6865 7265 2e20 5365  timeout here. Se
-00021710: 6520 696d 706c 656d 656e 7461 7469 6f6e  e implementation
-00021720: 206f 6620 7275 6e5f 6f6e 655f 7465 7374   of run_one_test
-00021730: 2829 2066 6f72 2064 6574 6169 6c73 2e0a  () for details..
-00021740: 5f54 4541 5244 4f57 4e5f 5345 5256 4943  _TEARDOWN_SERVIC
-00021750: 4520 3d20 280a 2020 2020 2728 666f 7220  E = (.    '(for 
-00021760: 6920 696e 2060 7365 7120 3120 3230 603b  i in `seq 1 20`;
-00021770: 2064 6f27 0a20 2020 2027 2020 2020 2073   do'.    '     s
-00021780: 3d24 2873 6b79 2073 6572 7665 2064 6f77  =$(sky serve dow
-00021790: 6e20 2d79 207b 6e61 6d65 7d29 3b27 0a20  n -y {name});'. 
-000217a0: 2020 2027 2020 2020 2065 6368 6f20 2254     '     echo "T
-000217b0: 7279 696e 6720 746f 2074 6572 6d69 6e61  rying to termina
-000217c0: 7465 207b 6e61 6d65 7d22 3b27 0a20 2020  te {name}";'.   
-000217d0: 2027 2020 2020 2065 6368 6f20 2224 7322   '     echo "$s"
+0001fec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fed0: 2020 2020 2020 2073 7065 6373 5b27 6469         specs['di
+0001fee0: 736b 5f74 6872 6f75 6768 7075 7427 5d29  sk_throughput'])
+0001fef0: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+0001ff00: 5d2c 0a20 2020 2020 2020 2020 2020 2066  ],.            f
+0001ff10: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0001ff20: 6d65 7d27 2c0a 2020 2020 2020 2020 2020  me}',.          
+0001ff30: 2020 7469 6d65 6f75 743d 3130 202a 2036    timeout=10 * 6
+0001ff40: 302c 2020 2320 3130 206d 696e 7320 2028  0,  # 10 mins  (
+0001ff50: 6974 2074 616b 6573 2061 726f 756e 6420  it takes around 
+0001ff60: 7e36 206d 696e 7329 0a20 2020 2020 2020  ~6 mins).       
+0001ff70: 2029 0a20 2020 2020 2020 2072 756e 5f6f   ).        run_o
+0001ff80: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+0001ff90: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
+0001ffa0: 0a64 6566 2074 6573 745f 6763 705f 6469  .def test_gcp_di
+0001ffb0: 736b 5f74 6965 7228 293a 0a20 2020 2066  sk_tier():.    f
+0001ffc0: 6f72 2064 6973 6b5f 7469 6572 2069 6e20  or disk_tier in 
+0001ffd0: 6c69 7374 2872 6573 6f75 7263 6573 5f75  list(resources_u
+0001ffe0: 7469 6c73 2e44 6973 6b54 6965 7229 3a0a  tils.DiskTier):.
+0001fff0: 2020 2020 2020 2020 7479 7065 203d 2047          type = G
+00020000: 4350 2e5f 6765 745f 6469 736b 5f74 7970  CP._get_disk_typ
+00020010: 6528 6469 736b 5f74 6965 7229 0a20 2020  e(disk_tier).   
+00020020: 2020 2020 206e 616d 6520 3d20 5f67 6574       name = _get
+00020030: 5f63 6c75 7374 6572 5f6e 616d 6528 2920  _cluster_name() 
+00020040: 2b20 272d 2720 2b20 6469 736b 5f74 6965  + '-' + disk_tie
+00020050: 722e 7661 6c75 650a 2020 2020 2020 2020  r.value.        
+00020060: 6e61 6d65 5f6f 6e5f 636c 6f75 6420 3d20  name_on_cloud = 
+00020070: 636f 6d6d 6f6e 5f75 7469 6c73 2e6d 616b  common_utils.mak
+00020080: 655f 636c 7573 7465 725f 6e61 6d65 5f6f  e_cluster_name_o
+00020090: 6e5f 636c 6f75 6428 0a20 2020 2020 2020  n_cloud(.       
+000200a0: 2020 2020 206e 616d 652c 2073 6b79 2e47       name, sky.G
+000200b0: 4350 2e6d 6178 5f63 6c75 7374 6572 5f6e  CP.max_cluster_n
+000200c0: 616d 655f 6c65 6e67 7468 2829 290a 2020  ame_length()).  
+000200d0: 2020 2020 2020 7265 6769 6f6e 203d 2027        region = '
+000200e0: 7573 2d77 6573 7432 270a 2020 2020 2020  us-west2'.      
+000200f0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00020100: 2020 2020 2020 2020 2020 2027 6763 702d             'gcp-
+00020110: 6469 736b 2d74 6965 722d 2720 2b20 6469  disk-tier-' + di
+00020120: 736b 5f74 6965 722e 7661 6c75 652c 0a20  sk_tier.value,. 
+00020130: 2020 2020 2020 2020 2020 205b 0a20 2020             [.   
+00020140: 2020 2020 2020 2020 2020 2020 2066 2773               f's
+00020150: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00020160: 7b6e 616d 657d 202d 2d63 6c6f 7564 2067  {name} --cloud g
+00020170: 6370 202d 2d72 6567 696f 6e20 7b72 6567  cp --region {reg
+00020180: 696f 6e7d 2027 0a20 2020 2020 2020 2020  ion} '.         
+00020190: 2020 2020 2020 2066 272d 2d64 6973 6b2d         f'--disk-
+000201a0: 7469 6572 207b 6469 736b 5f74 6965 722e  tier {disk_tier.
+000201b0: 7661 6c75 657d 2065 6368 6f20 2268 656c  value} echo "hel
+000201c0: 6c6f 2073 6b79 2227 2c0a 2020 2020 2020  lo sky"',.      
+000201d0: 2020 2020 2020 2020 2020 6627 6e61 6d65            f'name
+000201e0: 3d60 6763 6c6f 7564 2063 6f6d 7075 7465  =`gcloud compute
+000201f0: 2069 6e73 7461 6e63 6573 206c 6973 7420   instances list 
+00020200: 2d2d 6669 6c74 6572 3d27 0a20 2020 2020  --filter='.     
+00020210: 2020 2020 2020 2020 2020 2066 2722 6c61             f'"la
+00020220: 6265 6c73 2e72 6179 2d63 6c75 7374 6572  bels.ray-cluster
+00020230: 2d6e 616d 653a 7b6e 616d 655f 6f6e 5f63  -name:{name_on_c
+00020240: 6c6f 7564 7d22 2027 0a20 2020 2020 2020  loud}" '.       
+00020250: 2020 2020 2020 2020 2027 2d2d 666f 726d           '--form
+00020260: 6174 3d22 7661 6c75 6528 6e61 6d65 2922  at="value(name)"
+00020270: 603b 2027 0a20 2020 2020 2020 2020 2020  `; '.           
+00020280: 2020 2020 2066 2767 636c 6f75 6420 636f       f'gcloud co
+00020290: 6d70 7574 6520 6469 736b 7320 6c69 7374  mpute disks list
+000202a0: 202d 2d66 696c 7465 723d 226e 616d 653d   --filter="name=
+000202b0: 246e 616d 6522 2027 0a20 2020 2020 2020  $name" '.       
+000202c0: 2020 2020 2020 2020 2066 272d 2d66 6f72           f'--for
+000202d0: 6d61 743d 2276 616c 7565 2874 7970 6529  mat="value(type)
+000202e0: 2220 7c20 6772 6570 207b 7479 7065 7d20  " | grep {type} 
+000202f0: 270a 2020 2020 2020 2020 2020 2020 5d2c  '.            ],
+00020300: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00020310: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00020320: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+00020330: 7469 6d65 6f75 743d 3620 2a20 3630 2c20  timeout=6 * 60, 
+00020340: 2023 2036 206d 696e 7320 2028 6974 2074   # 6 mins  (it t
+00020350: 616b 6573 2061 726f 756e 6420 7e33 206d  akes around ~3 m
+00020360: 696e 7329 0a20 2020 2020 2020 2029 0a20  ins).        ). 
+00020370: 2020 2020 2020 2072 756e 5f6f 6e65 5f74         run_one_t
+00020380: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+00020390: 6573 742e 6d61 726b 2e61 7a75 7265 0a64  est.mark.azure.d
+000203a0: 6566 2074 6573 745f 617a 7572 655f 6469  ef test_azure_di
+000203b0: 736b 5f74 6965 7228 293a 0a20 2020 2066  sk_tier():.    f
+000203c0: 6f72 2064 6973 6b5f 7469 6572 2069 6e20  or disk_tier in 
+000203d0: 6c69 7374 2872 6573 6f75 7263 6573 5f75  list(resources_u
+000203e0: 7469 6c73 2e44 6973 6b54 6965 7229 3a0a  tils.DiskTier):.
+000203f0: 2020 2020 2020 2020 6966 2064 6973 6b5f          if disk_
+00020400: 7469 6572 203d 3d20 7265 736f 7572 6365  tier == resource
+00020410: 735f 7574 696c 732e 4469 736b 5469 6572  s_utils.DiskTier
+00020420: 2e48 4947 483a 0a20 2020 2020 2020 2020  .HIGH:.         
+00020430: 2020 2023 2041 7a75 7265 2064 6f65 7320     # Azure does 
+00020440: 6e6f 7420 7375 7070 6f72 7420 6869 6768  not support high
+00020450: 2064 6973 6b20 7469 6572 2e0a 2020 2020   disk tier..    
+00020460: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+00020470: 0a20 2020 2020 2020 2074 7970 6520 3d20  .        type = 
+00020480: 417a 7572 652e 5f67 6574 5f64 6973 6b5f  Azure._get_disk_
+00020490: 7479 7065 2864 6973 6b5f 7469 6572 290a  type(disk_tier).
+000204a0: 2020 2020 2020 2020 6e61 6d65 203d 205f          name = _
+000204b0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+000204c0: 2829 202b 2027 2d27 202b 2064 6973 6b5f  () + '-' + disk_
+000204d0: 7469 6572 2e76 616c 7565 0a20 2020 2020  tier.value.     
+000204e0: 2020 206e 616d 655f 6f6e 5f63 6c6f 7564     name_on_cloud
+000204f0: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
+00020500: 6d61 6b65 5f63 6c75 7374 6572 5f6e 616d  make_cluster_nam
+00020510: 655f 6f6e 5f63 6c6f 7564 280a 2020 2020  e_on_cloud(.    
+00020520: 2020 2020 2020 2020 6e61 6d65 2c20 736b          name, sk
+00020530: 792e 417a 7572 652e 6d61 785f 636c 7573  y.Azure.max_clus
+00020540: 7465 725f 6e61 6d65 5f6c 656e 6774 6828  ter_name_length(
+00020550: 2929 0a20 2020 2020 2020 2072 6567 696f  )).        regio
+00020560: 6e20 3d20 2777 6573 7475 7332 270a 2020  n = 'westus2'.  
+00020570: 2020 2020 2020 7465 7374 203d 2054 6573        test = Tes
+00020580: 7428 0a20 2020 2020 2020 2020 2020 2027  t(.            '
+00020590: 617a 7572 652d 6469 736b 2d74 6965 722d  azure-disk-tier-
+000205a0: 2720 2b20 6469 736b 5f74 6965 722e 7661  ' + disk_tier.va
+000205b0: 6c75 652c 0a20 2020 2020 2020 2020 2020  lue,.           
+000205c0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+000205d0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+000205e0: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
+000205f0: 6c6f 7564 2061 7a75 7265 202d 2d72 6567  loud azure --reg
+00020600: 696f 6e20 7b72 6567 696f 6e7d 2027 0a20  ion {region} '. 
+00020610: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00020620: 272d 2d64 6973 6b2d 7469 6572 207b 6469  '--disk-tier {di
+00020630: 736b 5f74 6965 722e 7661 6c75 657d 2065  sk_tier.value} e
+00020640: 6368 6f20 2268 656c 6c6f 2073 6b79 2227  cho "hello sky"'
+00020650: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00020660: 2020 6627 617a 2072 6573 6f75 7263 6520    f'az resource 
+00020670: 6c69 7374 202d 2d74 6167 2072 6179 2d63  list --tag ray-c
+00020680: 6c75 7374 6572 2d6e 616d 653d 7b6e 616d  luster-name={nam
+00020690: 655f 6f6e 5f63 6c6f 7564 7d20 2d2d 7175  e_on_cloud} --qu
+000206a0: 6572 7920 270a 2020 2020 2020 2020 2020  ery '.          
+000206b0: 2020 2020 2020 6627 225b 3f74 7970 653d        f'"[?type=
+000206c0: 3d5c 274d 6963 726f 736f 6674 2e43 6f6d  =\'Microsoft.Com
+000206d0: 7075 7465 2f64 6973 6b73 5c27 5d2e 736b  pute/disks\'].sk
+000206e0: 752e 6e61 6d65 2220 270a 2020 2020 2020  u.name" '.      
+000206f0: 2020 2020 2020 2020 2020 6627 2d2d 6f75            f'--ou
+00020700: 7470 7574 2074 7376 207c 2067 7265 7020  tput tsv | grep 
+00020710: 7b74 7970 657d 270a 2020 2020 2020 2020  {type}'.        
+00020720: 2020 2020 5d2c 0a20 2020 2020 2020 2020      ],.         
+00020730: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+00020740: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
+00020750: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
+00020760: 202a 2036 302c 2020 2320 3230 206d 696e   * 60,  # 20 min
+00020770: 7320 2028 6974 2074 616b 6573 2061 726f  s  (it takes aro
+00020780: 756e 6420 7e31 3220 6d69 6e73 290a 2020  und ~12 mins).  
+00020790: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000207a0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+000207b0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+000207c0: 6b2e 617a 7572 650a 6465 6620 7465 7374  k.azure.def test
+000207d0: 5f61 7a75 7265 5f62 6573 745f 7469 6572  _azure_best_tier
+000207e0: 5f66 6169 6c6f 7665 7228 293a 0a20 2020  _failover():.   
+000207f0: 2074 7970 6520 3d20 417a 7572 652e 5f67   type = Azure._g
+00020800: 6574 5f64 6973 6b5f 7479 7065 2872 6573  et_disk_type(res
+00020810: 6f75 7263 6573 5f75 7469 6c73 2e44 6973  ources_utils.Dis
+00020820: 6b54 6965 722e 4c4f 5729 0a20 2020 206e  kTier.LOW).    n
+00020830: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00020840: 6572 5f6e 616d 6528 290a 2020 2020 6e61  er_name().    na
+00020850: 6d65 5f6f 6e5f 636c 6f75 6420 3d20 636f  me_on_cloud = co
+00020860: 6d6d 6f6e 5f75 7469 6c73 2e6d 616b 655f  mmon_utils.make_
+00020870: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
+00020880: 636c 6f75 6428 0a20 2020 2020 2020 206e  cloud(.        n
+00020890: 616d 652c 2073 6b79 2e41 7a75 7265 2e6d  ame, sky.Azure.m
+000208a0: 6178 5f63 6c75 7374 6572 5f6e 616d 655f  ax_cluster_name_
+000208b0: 6c65 6e67 7468 2829 290a 2020 2020 7265  length()).    re
+000208c0: 6769 6f6e 203d 2027 7765 7374 7573 3227  gion = 'westus2'
+000208d0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+000208e0: 280a 2020 2020 2020 2020 2761 7a75 7265  (.        'azure
+000208f0: 2d62 6573 742d 7469 6572 2d66 6169 6c6f  -best-tier-failo
+00020900: 7665 7227 2c0a 2020 2020 2020 2020 5b0a  ver',.        [.
+00020910: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00020920: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00020930: 6e61 6d65 7d20 2d2d 636c 6f75 6420 617a  name} --cloud az
+00020940: 7572 6520 2d2d 7265 6769 6f6e 207b 7265  ure --region {re
+00020950: 6769 6f6e 7d20 270a 2020 2020 2020 2020  gion} '.        
+00020960: 2020 2020 6627 2d2d 6469 736b 2d74 6965      f'--disk-tie
+00020970: 7220 6265 7374 202d 2d69 6e73 7461 6e63  r best --instanc
+00020980: 652d 7479 7065 2053 7461 6e64 6172 645f  e-type Standard_
+00020990: 4438 5f76 3520 6563 686f 2022 6865 6c6c  D8_v5 echo "hell
+000209a0: 6f20 736b 7922 272c 0a20 2020 2020 2020  o sky"',.       
+000209b0: 2020 2020 2066 2761 7a20 7265 736f 7572       f'az resour
+000209c0: 6365 206c 6973 7420 2d2d 7461 6720 7261  ce list --tag ra
+000209d0: 792d 636c 7573 7465 722d 6e61 6d65 3d7b  y-cluster-name={
+000209e0: 6e61 6d65 5f6f 6e5f 636c 6f75 647d 202d  name_on_cloud} -
+000209f0: 2d71 7565 7279 2027 0a20 2020 2020 2020  -query '.       
+00020a00: 2020 2020 2066 2722 5b3f 7479 7065 3d3d       f'"[?type==
+00020a10: 5c27 4d69 6372 6f73 6f66 742e 436f 6d70  \'Microsoft.Comp
+00020a20: 7574 652f 6469 736b 735c 275d 2e73 6b75  ute/disks\'].sku
+00020a30: 2e6e 616d 6522 2027 0a20 2020 2020 2020  .name" '.       
+00020a40: 2020 2020 2066 272d 2d6f 7574 7075 7420       f'--output 
+00020a50: 7473 7620 7c20 6772 6570 207b 7479 7065  tsv | grep {type
+00020a60: 7d27 2c0a 2020 2020 2020 2020 5d2c 0a20  }',.        ],. 
+00020a70: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+00020a80: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+00020a90: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
+00020aa0: 202a 2036 302c 2020 2320 3230 206d 696e   * 60,  # 20 min
+00020ab0: 7320 2028 6974 2074 616b 6573 2061 726f  s  (it takes aro
+00020ac0: 756e 6420 7e31 3220 6d69 6e73 290a 2020  und ~12 mins).  
+00020ad0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00020ae0: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
+00020af0: 2d2d 2d2d 2d20 5465 7374 696e 6720 5a65  ----- Testing Ze
+00020b00: 726f 2051 756f 7461 2046 6169 6c6f 7665  ro Quota Failove
+00020b10: 7220 2d2d 2d2d 2d2d 0a40 7079 7465 7374  r ------.@pytest
+00020b20: 2e6d 6172 6b2e 6177 730a 6465 6620 7465  .mark.aws.def te
+00020b30: 7374 5f61 7773 5f7a 6572 6f5f 7175 6f74  st_aws_zero_quot
+00020b40: 615f 6661 696c 6f76 6572 2829 3a0a 0a20  a_failover():.. 
+00020b50: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00020b60: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00020b70: 2020 7265 6769 6f6e 203d 2067 6574 5f61    region = get_a
+00020b80: 7773 5f72 6567 696f 6e5f 666f 725f 7175  ws_region_for_qu
+00020b90: 6f74 615f 6661 696c 6f76 6572 2829 0a0a  ota_failover()..
+00020ba0: 2020 2020 6966 206e 6f74 2072 6567 696f      if not regio
+00020bb0: 6e3a 0a20 2020 2020 2020 2070 7974 6573  n:.        pytes
+00020bc0: 742e 7866 6169 6c28 0a20 2020 2020 2020  t.xfail(.       
+00020bd0: 2020 2020 2027 556e 6162 6c65 2074 6f20       'Unable to 
+00020be0: 7465 7374 207a 6572 6f20 7175 6f74 6120  test zero quota 
+00020bf0: 6661 696c 6f76 6572 206f 7074 696d 697a  failover optimiz
+00020c00: 6174 696f 6e20 e280 9420 7175 6f74 6173  ation ... quotas
+00020c10: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
+00020c20: 666f 7220 4543 3220 5033 2069 6e73 7461  for EC2 P3 insta
+00020c30: 6e63 6573 2077 6572 6520 666f 756e 6420  nces were found 
+00020c40: 6f6e 2061 6c6c 2041 5753 2072 6567 696f  on all AWS regio
+00020c50: 6e73 2e20 4973 2074 6869 7320 270a 2020  ns. Is this '.  
+00020c60: 2020 2020 2020 2020 2020 2765 7870 6563            'expec
+00020c70: 7465 6420 666f 7220 796f 7572 2061 6363  ted for your acc
+00020c80: 6f75 6e74 3f27 290a 2020 2020 2020 2020  ount?').        
+00020c90: 7265 7475 726e 0a0a 2020 2020 7465 7374  return..    test
+00020ca0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00020cb0: 2027 6177 732d 7a65 726f 2d71 756f 7461   'aws-zero-quota
+00020cc0: 2d66 6169 6c6f 7665 7227 2c0a 2020 2020  -failover',.    
+00020cd0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00020ce0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00020cf0: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
+00020d00: 6f75 6420 6177 7320 2d2d 7265 6769 6f6e  oud aws --region
+00020d10: 207b 7265 6769 6f6e 7d20 2d2d 6770 7573   {region} --gpus
+00020d20: 2056 3130 303a 3820 2d2d 7573 652d 7370   V100:8 --use-sp
+00020d30: 6f74 207c 2067 7265 7020 2246 6f75 6e64  ot | grep "Found
+00020d40: 206e 6f20 7175 6f74 6122 272c 0a20 2020   no quota"',.   
+00020d50: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00020d60: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+00020d70: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
+00020d80: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00020d90: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00020da0: 726b 2e67 6370 0a64 6566 2074 6573 745f  rk.gcp.def test_
+00020db0: 6763 705f 7a65 726f 5f71 756f 7461 5f66  gcp_zero_quota_f
+00020dc0: 6169 6c6f 7665 7228 293a 0a0a 2020 2020  ailover():..    
+00020dd0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00020de0: 7465 725f 6e61 6d65 2829 0a20 2020 2072  ter_name().    r
+00020df0: 6567 696f 6e20 3d20 6765 745f 6763 705f  egion = get_gcp_
+00020e00: 7265 6769 6f6e 5f66 6f72 5f71 756f 7461  region_for_quota
+00020e10: 5f66 6169 6c6f 7665 7228 290a 0a20 2020  _failover()..   
+00020e20: 2069 6620 6e6f 7420 7265 6769 6f6e 3a0a   if not region:.
+00020e30: 2020 2020 2020 2020 7079 7465 7374 2e78          pytest.x
+00020e40: 6661 696c 280a 2020 2020 2020 2020 2020  fail(.          
+00020e50: 2020 2755 6e61 626c 6520 746f 2074 6573    'Unable to tes
+00020e60: 7420 7a65 726f 2071 756f 7461 2066 6169  t zero quota fai
+00020e70: 6c6f 7665 7220 6f70 7469 6d69 7a61 7469  lover optimizati
+00020e80: 6f6e 20e2 8094 2071 756f 7461 7320 270a  on ... quotas '.
+00020e90: 2020 2020 2020 2020 2020 2020 2766 6f72              'for
+00020ea0: 2041 3130 302d 3830 4742 2047 5055 7320   A100-80GB GPUs 
+00020eb0: 7765 7265 2066 6f75 6e64 206f 6e20 616c  were found on al
+00020ec0: 6c20 4743 5020 7265 6769 6f6e 732e 2049  l GCP regions. I
+00020ed0: 7320 7468 6973 2027 0a20 2020 2020 2020  s this '.       
+00020ee0: 2020 2020 2027 6578 7065 6374 6564 2066       'expected f
+00020ef0: 6f72 2079 6f75 7220 6163 636f 756e 743f  or your account?
+00020f00: 2729 0a20 2020 2020 2020 2072 6574 7572  ').        retur
+00020f10: 6e0a 0a20 2020 2074 6573 7420 3d20 5465  n..    test = Te
+00020f20: 7374 280a 2020 2020 2020 2020 2767 6370  st(.        'gcp
+00020f30: 2d7a 6572 6f2d 7175 6f74 612d 6661 696c  -zero-quota-fail
+00020f40: 6f76 6572 272c 0a20 2020 2020 2020 205b  over',.        [
+00020f50: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00020f60: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00020f70: 7b6e 616d 657d 202d 2d63 6c6f 7564 2067  {name} --cloud g
+00020f80: 6370 202d 2d72 6567 696f 6e20 7b72 6567  cp --region {reg
+00020f90: 696f 6e7d 202d 2d67 7075 7320 4131 3030  ion} --gpus A100
+00020fa0: 2d38 3047 423a 3120 2d2d 7573 652d 7370  -80GB:1 --use-sp
+00020fb0: 6f74 207c 2067 7265 7020 2246 6f75 6e64  ot | grep "Found
+00020fc0: 206e 6f20 7175 6f74 6122 272c 0a20 2020   no quota"',.   
+00020fd0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00020fe0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+00020ff0: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
+00021000: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00021010: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
+00021020: 2d2d 2054 6573 7469 6e67 2073 6b79 7365  -- Testing skyse
+00021030: 7276 6520 2d2d 2d2d 2d2d 2d2d 2d2d 0a0a  rve ----------..
+00021040: 0a64 6566 205f 6765 745f 7365 7276 6963  .def _get_servic
+00021050: 655f 6e61 6d65 2829 202d 3e20 7374 723a  e_name() -> str:
+00021060: 0a20 2020 2022 2222 5265 7475 726e 7320  .    """Returns 
+00021070: 6120 7573 6572 2d75 6e69 7175 6520 7365  a user-unique se
+00021080: 7276 6963 6520 6e61 6d65 2066 6f72 2065  rvice name for e
+00021090: 6163 6820 7465 7374 5f73 6b79 7365 7276  ach test_skyserv
+000210a0: 655f 3c6e 616d 653e 2829 2e0a 0a20 2020  e_<name>()...   
+000210b0: 204d 7573 7420 6265 2063 616c 6c65 6420   Must be called 
+000210c0: 6672 6f6d 2065 6163 6820 7465 7374 5f73  from each test_s
+000210d0: 6b79 7365 7276 655f 3c6e 616d 653e 2829  kyserve_<name>()
+000210e0: 2e0a 2020 2020 2222 220a 2020 2020 6361  ..    """.    ca
+000210f0: 6c6c 6572 5f66 756e 635f 6e61 6d65 203d  ller_func_name =
+00021100: 2069 6e73 7065 6374 2e73 7461 636b 2829   inspect.stack()
+00021110: 5b31 5d5b 335d 0a20 2020 2074 6573 745f  [1][3].    test_
+00021120: 6e61 6d65 203d 2063 616c 6c65 725f 6675  name = caller_fu
+00021130: 6e63 5f6e 616d 652e 7265 706c 6163 6528  nc_name.replace(
+00021140: 275f 272c 2027 2d27 292e 7265 706c 6163  '_', '-').replac
+00021150: 6528 2774 6573 742d 272c 2027 742d 2729  e('test-', 't-')
+00021160: 0a20 2020 2074 6573 745f 6e61 6d65 203d  .    test_name =
+00021170: 2074 6573 745f 6e61 6d65 2e72 6570 6c61   test_name.repla
+00021180: 6365 2827 736b 7973 6572 7665 2d27 2c20  ce('skyserve-', 
+00021190: 2773 732d 2729 0a20 2020 2074 6573 745f  'ss-').    test_
+000211a0: 6e61 6d65 203d 2063 6f6d 6d6f 6e5f 7574  name = common_ut
+000211b0: 696c 732e 6d61 6b65 5f63 6c75 7374 6572  ils.make_cluster
+000211c0: 5f6e 616d 655f 6f6e 5f63 6c6f 7564 2874  _name_on_cloud(t
+000211d0: 6573 745f 6e61 6d65 2c20 3234 290a 2020  est_name, 24).  
+000211e0: 2020 7265 7475 726e 2066 277b 7465 7374    return f'{test
+000211f0: 5f6e 616d 657d 2d7b 7465 7374 5f69 647d  _name}-{test_id}
+00021200: 270a 0a0a 2320 5765 2063 6865 636b 2074  '...# We check t
+00021210: 6865 206f 7574 7075 7420 6f66 2074 6865  he output of the
+00021220: 2073 6b79 7365 7276 6520 7365 7276 6963   skyserve servic
+00021230: 6520 746f 2073 6565 2069 6620 6974 2069  e to see if it i
+00021240: 7320 7265 6164 792e 204f 7574 7075 7420  s ready. Output 
+00021250: 6f66 0a23 2060 5245 504c 4943 4153 6020  of.# `REPLICAS` 
+00021260: 6973 2069 6e20 7468 6520 666f 726d 206f  is in the form o
+00021270: 6620 6031 2f32 6020 7768 6572 6520 7468  f `1/2` where th
+00021280: 6520 6669 7273 7420 6e75 6d62 6572 2069  e first number i
+00021290: 7320 7468 6520 6e75 6d62 6572 206f 660a  s the number of.
+000212a0: 2320 7265 6164 7920 7265 706c 6963 6173  # ready replicas
+000212b0: 2061 6e64 2074 6865 2073 6563 6f6e 6420   and the second 
+000212c0: 6e75 6d62 6572 2069 7320 7468 6520 6e75  number is the nu
+000212d0: 6d62 6572 206f 6620 746f 7461 6c20 7265  mber of total re
+000212e0: 706c 6963 6173 2e20 5765 0a23 2067 7265  plicas. We.# gre
+000212f0: 7020 7375 6368 2066 6f72 6d61 7420 746f  p such format to
+00021300: 2065 6e73 7572 6520 7468 6174 2074 6865   ensure that the
+00021310: 2073 6572 7669 6365 2069 7320 7265 6164   service is read
+00021320: 792c 2061 6e64 2065 6172 6c79 2065 7869  y, and early exi
+00021330: 7420 6966 2061 6e79 0a23 2066 6169 6c75  t if any.# failu
+00021340: 7265 2064 6574 6563 7465 642e 2049 6e20  re detected. In 
+00021350: 7468 6520 656e 6420 7765 2073 6c65 6570  the end we sleep
+00021360: 2066 6f72 0a23 2073 6572 7665 2e4c 425f   for.# serve.LB_
+00021370: 434f 4e54 524f 4c4c 4552 5f53 594e 435f  CONTROLLER_SYNC_
+00021380: 494e 5445 5256 414c 5f53 4543 4f4e 4453  INTERVAL_SECONDS
+00021390: 2074 6f20 6d61 6b65 2073 7572 6520 6c6f   to make sure lo
+000213a0: 6164 2062 616c 616e 6365 7220 6861 7665  ad balancer have
+000213b0: 0a23 2065 6e6f 7567 6820 7469 6d65 2074  .# enough time t
+000213c0: 6f20 7379 6e63 2077 6974 6820 7468 6520  o sync with the 
+000213d0: 636f 6e74 726f 6c6c 6572 2061 6e64 2067  controller and g
+000213e0: 6574 2061 6c6c 2072 6561 6479 2072 6570  et all ready rep
+000213f0: 6c69 6361 2049 5073 2e0a 5f53 4552 5645  lica IPs.._SERVE
+00021400: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
+00021410: 5920 3d20 280a 2020 2020 277b 7b20 7768  Y = (.    '{{ wh
+00021420: 696c 6520 7472 7565 3b20 646f 270a 2020  ile true; do'.  
+00021430: 2020 2720 2020 2020 733d 2428 736b 7920    '     s=$(sky 
+00021440: 7365 7276 6520 7374 6174 7573 207b 6e61  serve status {na
+00021450: 6d65 7d29 3b20 6563 686f 2022 2473 223b  me}); echo "$s";
+00021460: 270a 2020 2020 2720 2020 2020 6563 686f  '.    '     echo
+00021470: 2022 2473 2220 7c20 6772 6570 202d 7120   "$s" | grep -q 
+00021480: 227b 7265 706c 6963 615f 6e75 6d7d 2f7b  "{replica_num}/{
+00021490: 7265 706c 6963 615f 6e75 6d7d 2220 2626  replica_num}" &&
+000214a0: 2062 7265 616b 3b27 0a20 2020 2027 2020   break;'.    '  
+000214b0: 2020 2065 6368 6f20 2224 7322 207c 2067     echo "$s" | g
+000214c0: 7265 7020 2d71 2022 4641 494c 4544 2220  rep -q "FAILED" 
+000214d0: 2626 2065 7869 7420 313b 270a 2020 2020  && exit 1;'.    
+000214e0: 2720 2020 2020 736c 6565 7020 3130 3b27  '     sleep 10;'
+000214f0: 0a20 2020 2027 2064 6f6e 653b 207d 7d3b  .    ' done; }};
+00021500: 2065 6368 6f20 2247 6f74 2073 6572 7669   echo "Got servi
+00021510: 6365 2073 7461 7475 7320 2473 223b 270a  ce status $s";'.
+00021520: 2020 2020 6627 736c 6565 7020 7b73 6572      f'sleep {ser
+00021530: 7665 2e4c 425f 434f 4e54 524f 4c4c 4552  ve.LB_CONTROLLER
+00021540: 5f53 594e 435f 494e 5445 5256 414c 5f53  _SYNC_INTERVAL_S
+00021550: 4543 4f4e 4453 202b 2032 7d3b 2729 0a5f  ECONDS + 2};')._
+00021560: 4950 5f52 4547 4558 203d 2072 2728 5b30  IP_REGEX = r'([0
+00021570: 2d39 5d7b 312c 337d 5c2e 297b 337d 5b30  -9]{1,3}\.){3}[0
+00021580: 2d39 5d7b 312c 337d 270a 5f41 574b 5f41  -9]{1,3}'._AWK_A
+00021590: 4c4c 5f4c 494e 4553 5f42 454c 4f57 5f52  LL_LINES_BELOW_R
+000215a0: 4550 4c49 4341 5320 3d20 7227 2f52 6570  EPLICAS = r'/Rep
+000215b0: 6c69 6361 732f 7b66 6c61 673d 313b 206e  licas/{flag=1; n
+000215c0: 6578 747d 2066 6c61 6727 0a5f 5345 5256  ext} flag'._SERV
+000215d0: 4943 455f 4c41 554e 4348 494e 475f 5354  ICE_LAUNCHING_ST
+000215e0: 4154 5553 5f52 4547 4558 203d 2027 5052  ATUS_REGEX = 'PR
+000215f0: 4f56 4953 494f 4e49 4e47 5c7c 5354 4152  OVISIONING\|STAR
+00021600: 5449 4e47 270a 2320 5369 6e63 6520 7765  TING'.# Since we
+00021610: 2064 6f6e 2774 2061 6c6c 6f77 2074 6572   don't allow ter
+00021620: 6d69 6e61 7465 2074 6865 2073 6572 7669  minate the servi
+00021630: 6365 2069 6620 7468 6520 636f 6e74 726f  ce if the contro
+00021640: 6c6c 6572 2069 7320 494e 4954 2c0a 2320  ller is INIT,.# 
+00021650: 7768 6963 6820 6973 2063 6f6d 6d6f 6e20  which is common 
+00021660: 666f 7220 7369 6d75 6c74 616e 656f 7573  for simultaneous
+00021670: 2070 7974 6573 742c 2077 6520 6e65 6564   pytest, we need
+00021680: 2074 6f20 7761 6974 2075 6e74 696c 2074   to wait until t
+00021690: 6865 0a23 2063 6f6e 7472 6f6c 6c65 7220  he.# controller 
+000216a0: 6973 2055 5020 6265 666f 7265 2077 6520  is UP before we 
+000216b0: 6361 6e20 7465 726d 696e 6174 6520 7468  can terminate th
+000216c0: 6520 7365 7276 6963 652e 0a23 2054 6865  e service..# The
+000216d0: 2074 6561 7264 6f77 6e20 636f 6d6d 616e   teardown comman
+000216e0: 6420 6861 7320 6120 3130 2d6d 696e 7320  d has a 10-mins 
+000216f0: 7469 6d65 6f75 742c 2073 6f20 7765 2064  timeout, so we d
+00021700: 6f6e 2774 206e 6565 6420 746f 2064 6f0a  on't need to do.
+00021710: 2320 7468 6520 7469 6d65 6f75 7420 6865  # the timeout he
+00021720: 7265 2e20 5365 6520 696d 706c 656d 656e  re. See implemen
+00021730: 7461 7469 6f6e 206f 6620 7275 6e5f 6f6e  tation of run_on
+00021740: 655f 7465 7374 2829 2066 6f72 2064 6574  e_test() for det
+00021750: 6169 6c73 2e0a 5f54 4541 5244 4f57 4e5f  ails.._TEARDOWN_
+00021760: 5345 5256 4943 4520 3d20 280a 2020 2020  SERVICE = (.    
+00021770: 2728 666f 7220 6920 696e 2060 7365 7120  '(for i in `seq 
+00021780: 3120 3230 603b 2064 6f27 0a20 2020 2027  1 20`; do'.    '
+00021790: 2020 2020 2073 3d24 2873 6b79 2073 6572       s=$(sky ser
+000217a0: 7665 2064 6f77 6e20 2d79 207b 6e61 6d65  ve down -y {name
+000217b0: 7d29 3b27 0a20 2020 2027 2020 2020 2065  });'.    '     e
+000217c0: 6368 6f20 2254 7279 696e 6720 746f 2074  cho "Trying to t
+000217d0: 6572 6d69 6e61 7465 207b 6e61 6d65 7d22  erminate {name}"
 000217e0: 3b27 0a20 2020 2027 2020 2020 2065 6368  ;'.    '     ech
-000217f0: 6f20 2224 7322 207c 2067 7265 7020 2d71  o "$s" | grep -q
-00021800: 2022 7363 6865 6475 6c65 6420 746f 2062   "scheduled to b
-00021810: 6520 7465 726d 696e 6174 6564 5c7c 4e6f  e terminated\|No
-00021820: 2073 6572 7669 6365 2074 6f20 7465 726d   service to term
-00021830: 696e 6174 6522 2026 2620 6272 6561 6b3b  inate" && break;
-00021840: 270a 2020 2020 2720 2020 2020 736c 6565  '.    '     slee
-00021850: 7020 3130 3b27 0a20 2020 2027 2020 2020  p 10;'.    '    
-00021860: 205b 2024 6920 2d65 7120 3230 205d 2026   [ $i -eq 20 ] &
-00021870: 2620 6563 686f 2022 4661 696c 6564 2074  & echo "Failed t
-00021880: 6f20 7465 726d 696e 6174 6520 7365 7276  o terminate serv
-00021890: 6963 6520 7b6e 616d 657d 223b 270a 2020  ice {name}";'.  
-000218a0: 2020 2764 6f6e 6529 2729 0a0a 5f53 4552    'done)').._SER
-000218b0: 5645 5f45 4e44 504f 494e 545f 5741 4954  VE_ENDPOINT_WAIT
-000218c0: 203d 2028 0a20 2020 2027 6578 706f 7274   = (.    'export
-000218d0: 204f 5249 4749 4e5f 534b 5950 494c 4f54   ORIGIN_SKYPILOT
-000218e0: 5f44 4542 5547 3d24 534b 5950 494c 4f54  _DEBUG=$SKYPILOT
-000218f0: 5f44 4542 5547 3b20 6578 706f 7274 2053  _DEBUG; export S
-00021900: 4b59 5049 4c4f 545f 4445 4255 473d 303b  KYPILOT_DEBUG=0;
-00021910: 2027 0a20 2020 2027 656e 6470 6f69 6e74   '.    'endpoint
-00021920: 3d24 2873 6b79 2073 6572 7665 2073 7461  =$(sky serve sta
-00021930: 7475 7320 2d2d 656e 6470 6f69 6e74 207b  tus --endpoint {
-00021940: 6e61 6d65 7d29 3b20 270a 2020 2020 2775  name}); '.    'u
-00021950: 6e74 696c 2021 2065 6368 6f20 2224 656e  ntil ! echo "$en
-00021960: 6470 6f69 6e74 2220 7c20 6772 6570 2022  dpoint" | grep "
-00021970: 436f 6e74 726f 6c6c 6572 2069 7320 696e  Controller is in
-00021980: 6974 6961 6c69 7a69 6e67 223b 2027 0a20  itializing"; '. 
-00021990: 2020 2027 646f 2065 6368 6f20 2257 6169     'do echo "Wai
-000219a0: 7469 6e67 2066 6f72 2073 6572 7665 2065  ting for serve e
-000219b0: 6e64 706f 696e 7420 746f 2062 6520 7265  ndpoint to be re
-000219c0: 6164 792e 2e2e 223b 2027 0a20 2020 2027  ady..."; '.    '
-000219d0: 736c 6565 7020 353b 2065 6e64 706f 696e  sleep 5; endpoin
-000219e0: 743d 2428 736b 7920 7365 7276 6520 7374  t=$(sky serve st
-000219f0: 6174 7573 202d 2d65 6e64 706f 696e 7420  atus --endpoint 
-00021a00: 7b6e 616d 657d 293b 2064 6f6e 653b 2027  {name}); done; '
-00021a10: 0a20 2020 2027 6578 706f 7274 2053 4b59  .    'export SKY
-00021a20: 5049 4c4f 545f 4445 4255 473d 244f 5249  PILOT_DEBUG=$ORI
-00021a30: 4749 4e5f 534b 5950 494c 4f54 5f44 4542  GIN_SKYPILOT_DEB
-00021a40: 5547 3b20 6563 686f 2022 2465 6e64 706f  UG; echo "$endpo
-00021a50: 696e 7422 2729 0a0a 5f53 4552 5645 5f53  int"').._SERVE_S
-00021a60: 5441 5455 535f 5741 4954 203d 2028 2773  TATUS_WAIT = ('s
-00021a70: 3d24 2873 6b79 2073 6572 7665 2073 7461  =$(sky serve sta
-00021a80: 7475 7320 7b6e 616d 657d 293b 2027 0a20  tus {name}); '. 
-00021a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021aa0: 2020 2020 2027 756e 7469 6c20 2120 6563       'until ! ec
-00021ab0: 686f 2022 2473 2220 7c20 6772 6570 2022  ho "$s" | grep "
-00021ac0: 436f 6e74 726f 6c6c 6572 2069 7320 696e  Controller is in
-00021ad0: 6974 6961 6c69 7a69 6e67 2e22 3b20 270a  itializing."; '.
-00021ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021af0: 2020 2020 2020 2764 6f20 6563 686f 2022        'do echo "
-00021b00: 5761 6974 696e 6720 666f 7220 7365 7276  Waiting for serv
-00021b10: 6520 7374 6174 7573 2074 6f20 6265 2072  e status to be r
-00021b20: 6561 6479 2e2e 2e22 3b20 270a 2020 2020  eady..."; '.    
-00021b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021b40: 2020 2773 6c65 6570 2035 3b20 733d 2428    'sleep 5; s=$(
-00021b50: 736b 7920 7365 7276 6520 7374 6174 7573  sky serve status
-00021b60: 207b 6e61 6d65 7d29 3b20 646f 6e65 3b20   {name}); done; 
-00021b70: 6563 686f 2022 2473 2227 290a 0a0a 6465  echo "$s"')...de
-00021b80: 6620 5f67 6574 5f72 6570 6c69 6361 5f69  f _get_replica_i
-00021b90: 7028 6e61 6d65 3a20 7374 722c 2072 6570  p(name: str, rep
-00021ba0: 6c69 6361 5f69 643a 2069 6e74 2920 2d3e  lica_id: int) ->
-00021bb0: 2073 7472 3a0a 2020 2020 7265 7475 726e   str:.    return
-00021bc0: 2028 6627 6970 7b72 6570 6c69 6361 5f69   (f'ip{replica_i
-00021bd0: 647d 3d24 2865 6368 6f20 2224 7322 207c  d}=$(echo "$s" |
-00021be0: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
-00021bf0: 2761 776b 2022 7b5f 4157 4b5f 414c 4c5f  'awk "{_AWK_ALL_
-00021c00: 4c49 4e45 535f 4245 4c4f 575f 5245 504c  LINES_BELOW_REPL
-00021c10: 4943 4153 7d22 207c 2027 0a20 2020 2020  ICAS}" | '.     
-00021c20: 2020 2020 2020 2066 2767 7265 7020 2d45         f'grep -E
-00021c30: 2022 7b6e 616d 657d 5c73 2b7b 7265 706c   "{name}\s+{repl
-00021c40: 6963 615f 6964 7d22 207c 2027 0a20 2020  ica_id}" | '.   
-00021c50: 2020 2020 2020 2020 2066 2767 7265 7020           f'grep 
-00021c60: 2d45 6f20 227b 5f49 505f 5245 4745 587d  -Eo "{_IP_REGEX}
-00021c70: 2229 2729 0a0a 0a64 6566 205f 6765 745f  ")')...def _get_
-00021c80: 736b 7973 6572 7665 5f68 7474 705f 7465  skyserve_http_te
-00021c90: 7374 286e 616d 653a 2073 7472 2c20 636c  st(name: str, cl
-00021ca0: 6f75 643a 2073 7472 2c0a 2020 2020 2020  oud: str,.      
-00021cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021cc0: 2020 2020 2020 7469 6d65 6f75 745f 6d69        timeout_mi
-00021cd0: 6e75 7465 733a 2069 6e74 2920 2d3e 2054  nutes: int) -> T
-00021ce0: 6573 743a 0a20 2020 2074 6573 7420 3d20  est:.    test = 
-00021cf0: 5465 7374 280a 2020 2020 2020 2020 6627  Test(.        f'
-00021d00: 7465 7374 2d73 6b79 7365 7276 652d 7b63  test-skyserve-{c
-00021d10: 6c6f 7564 2e72 6570 6c61 6365 2822 5f22  loud.replace("_"
-00021d20: 2c20 222d 2229 7d27 2c0a 2020 2020 2020  , "-")}',.      
-00021d30: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00021d40: 6627 736b 7920 7365 7276 6520 7570 202d  f'sky serve up -
-00021d50: 6e20 7b6e 616d 657d 202d 7920 7465 7374  n {name} -y test
-00021d60: 732f 736b 7973 6572 7665 2f68 7474 702f  s/skyserve/http/
-00021d70: 7b63 6c6f 7564 7d2e 7961 6d6c 272c 0a20  {cloud}.yaml',. 
-00021d80: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
-00021d90: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
-00021da0: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
-00021db0: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
-00021dc0: 3d32 292c 0a20 2020 2020 2020 2020 2020  =2),.           
-00021dd0: 2066 277b 5f53 4552 5645 5f45 4e44 504f   f'{_SERVE_ENDPO
-00021de0: 494e 545f 5741 4954 2e66 6f72 6d61 7428  INT_WAIT.format(
-00021df0: 6e61 6d65 3d6e 616d 6529 7d3b 2027 0a20  name=name)}; '. 
-00021e00: 2020 2020 2020 2020 2020 2027 6375 726c             'curl
-00021e10: 202d 4c20 6874 7470 3a2f 2f24 656e 6470   -L http://$endp
-00021e20: 6f69 6e74 207c 2067 7265 7020 2248 692c  oint | grep "Hi,
-00021e30: 2053 6b79 5069 6c6f 7420 6865 7265 2227   SkyPilot here"'
-00021e40: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-00021e50: 2020 2020 205f 5445 4152 444f 574e 5f53       _TEARDOWN_S
-00021e60: 4552 5649 4345 2e66 6f72 6d61 7428 6e61  ERVICE.format(na
-00021e70: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
-00021e80: 2020 7469 6d65 6f75 743d 7469 6d65 6f75    timeout=timeou
-00021e90: 745f 6d69 6e75 7465 7320 2a20 3630 2c0a  t_minutes * 60,.
-00021ea0: 2020 2020 290a 2020 2020 7265 7475 726e      ).    return
-00021eb0: 2074 6573 740a 0a0a 6465 6620 5f63 6865   test...def _che
-00021ec0: 636b 5f72 6570 6c69 6361 5f69 6e5f 7374  ck_replica_in_st
-00021ed0: 6174 7573 286e 616d 653a 2073 7472 2c20  atus(name: str, 
-00021ee0: 6368 6563 6b5f 7475 706c 6573 3a20 4c69  check_tuples: Li
-00021ef0: 7374 5b54 7570 6c65 5b69 6e74 2c20 626f  st[Tuple[int, bo
-00021f00: 6f6c 2c0a 2020 2020 2020 2020 2020 2020  ol,.            
-00021f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000217f0: 6f20 2224 7322 3b27 0a20 2020 2027 2020  o "$s";'.    '  
+00021800: 2020 2065 6368 6f20 2224 7322 207c 2067     echo "$s" | g
+00021810: 7265 7020 2d71 2022 7363 6865 6475 6c65  rep -q "schedule
+00021820: 6420 746f 2062 6520 7465 726d 696e 6174  d to be terminat
+00021830: 6564 5c7c 4e6f 2073 6572 7669 6365 2074  ed\|No service t
+00021840: 6f20 7465 726d 696e 6174 6522 2026 2620  o terminate" && 
+00021850: 6272 6561 6b3b 270a 2020 2020 2720 2020  break;'.    '   
+00021860: 2020 736c 6565 7020 3130 3b27 0a20 2020    sleep 10;'.   
+00021870: 2027 2020 2020 205b 2024 6920 2d65 7120   '     [ $i -eq 
+00021880: 3230 205d 2026 2620 6563 686f 2022 4661  20 ] && echo "Fa
+00021890: 696c 6564 2074 6f20 7465 726d 696e 6174  iled to terminat
+000218a0: 6520 7365 7276 6963 6520 7b6e 616d 657d  e service {name}
+000218b0: 223b 270a 2020 2020 2764 6f6e 6529 2729  ";'.    'done)')
+000218c0: 0a0a 5f53 4552 5645 5f45 4e44 504f 494e  .._SERVE_ENDPOIN
+000218d0: 545f 5741 4954 203d 2028 0a20 2020 2027  T_WAIT = (.    '
+000218e0: 6578 706f 7274 204f 5249 4749 4e5f 534b  export ORIGIN_SK
+000218f0: 5950 494c 4f54 5f44 4542 5547 3d24 534b  YPILOT_DEBUG=$SK
+00021900: 5950 494c 4f54 5f44 4542 5547 3b20 6578  YPILOT_DEBUG; ex
+00021910: 706f 7274 2053 4b59 5049 4c4f 545f 4445  port SKYPILOT_DE
+00021920: 4255 473d 303b 2027 0a20 2020 2027 656e  BUG=0; '.    'en
+00021930: 6470 6f69 6e74 3d24 2873 6b79 2073 6572  dpoint=$(sky ser
+00021940: 7665 2073 7461 7475 7320 2d2d 656e 6470  ve status --endp
+00021950: 6f69 6e74 207b 6e61 6d65 7d29 3b20 270a  oint {name}); '.
+00021960: 2020 2020 2775 6e74 696c 2021 2065 6368      'until ! ech
+00021970: 6f20 2224 656e 6470 6f69 6e74 2220 7c20  o "$endpoint" | 
+00021980: 6772 6570 2022 436f 6e74 726f 6c6c 6572  grep "Controller
+00021990: 2069 7320 696e 6974 6961 6c69 7a69 6e67   is initializing
+000219a0: 223b 2027 0a20 2020 2027 646f 2065 6368  "; '.    'do ech
+000219b0: 6f20 2257 6169 7469 6e67 2066 6f72 2073  o "Waiting for s
+000219c0: 6572 7665 2065 6e64 706f 696e 7420 746f  erve endpoint to
+000219d0: 2062 6520 7265 6164 792e 2e2e 223b 2027   be ready..."; '
+000219e0: 0a20 2020 2027 736c 6565 7020 353b 2065  .    'sleep 5; e
+000219f0: 6e64 706f 696e 743d 2428 736b 7920 7365  ndpoint=$(sky se
+00021a00: 7276 6520 7374 6174 7573 202d 2d65 6e64  rve status --end
+00021a10: 706f 696e 7420 7b6e 616d 657d 293b 2064  point {name}); d
+00021a20: 6f6e 653b 2027 0a20 2020 2027 6578 706f  one; '.    'expo
+00021a30: 7274 2053 4b59 5049 4c4f 545f 4445 4255  rt SKYPILOT_DEBU
+00021a40: 473d 244f 5249 4749 4e5f 534b 5950 494c  G=$ORIGIN_SKYPIL
+00021a50: 4f54 5f44 4542 5547 3b20 6563 686f 2022  OT_DEBUG; echo "
+00021a60: 2465 6e64 706f 696e 7422 2729 0a0a 5f53  $endpoint"').._S
+00021a70: 4552 5645 5f53 5441 5455 535f 5741 4954  ERVE_STATUS_WAIT
+00021a80: 203d 2028 2773 3d24 2873 6b79 2073 6572   = ('s=$(sky ser
+00021a90: 7665 2073 7461 7475 7320 7b6e 616d 657d  ve status {name}
+00021aa0: 293b 2027 0a20 2020 2020 2020 2020 2020  ); '.           
+00021ab0: 2020 2020 2020 2020 2020 2027 756e 7469             'unti
+00021ac0: 6c20 2120 6563 686f 2022 2473 2220 7c20  l ! echo "$s" | 
+00021ad0: 6772 6570 2022 436f 6e74 726f 6c6c 6572  grep "Controller
+00021ae0: 2069 7320 696e 6974 6961 6c69 7a69 6e67   is initializing
+00021af0: 2e22 3b20 270a 2020 2020 2020 2020 2020  ."; '.          
+00021b00: 2020 2020 2020 2020 2020 2020 2764 6f20              'do 
+00021b10: 6563 686f 2022 5761 6974 696e 6720 666f  echo "Waiting fo
+00021b20: 7220 7365 7276 6520 7374 6174 7573 2074  r serve status t
+00021b30: 6f20 6265 2072 6561 6479 2e2e 2e22 3b20  o be ready..."; 
+00021b40: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00021b50: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
+00021b60: 3b20 733d 2428 736b 7920 7365 7276 6520  ; s=$(sky serve 
+00021b70: 7374 6174 7573 207b 6e61 6d65 7d29 3b20  status {name}); 
+00021b80: 646f 6e65 3b20 6563 686f 2022 2473 2227  done; echo "$s"'
+00021b90: 290a 0a0a 6465 6620 5f67 6574 5f72 6570  )...def _get_rep
+00021ba0: 6c69 6361 5f69 7028 6e61 6d65 3a20 7374  lica_ip(name: st
+00021bb0: 722c 2072 6570 6c69 6361 5f69 643a 2069  r, replica_id: i
+00021bc0: 6e74 2920 2d3e 2073 7472 3a0a 2020 2020  nt) -> str:.    
+00021bd0: 7265 7475 726e 2028 6627 6970 7b72 6570  return (f'ip{rep
+00021be0: 6c69 6361 5f69 647d 3d24 2865 6368 6f20  lica_id}=$(echo 
+00021bf0: 2224 7322 207c 2027 0a20 2020 2020 2020  "$s" | '.       
+00021c00: 2020 2020 2066 2761 776b 2022 7b5f 4157       f'awk "{_AW
+00021c10: 4b5f 414c 4c5f 4c49 4e45 535f 4245 4c4f  K_ALL_LINES_BELO
+00021c20: 575f 5245 504c 4943 4153 7d22 207c 2027  W_REPLICAS}" | '
+00021c30: 0a20 2020 2020 2020 2020 2020 2066 2767  .            f'g
+00021c40: 7265 7020 2d45 2022 7b6e 616d 657d 5c73  rep -E "{name}\s
+00021c50: 2b7b 7265 706c 6963 615f 6964 7d22 207c  +{replica_id}" |
+00021c60: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
+00021c70: 2767 7265 7020 2d45 6f20 227b 5f49 505f  'grep -Eo "{_IP_
+00021c80: 5245 4745 587d 2229 2729 0a0a 0a64 6566  REGEX}")')...def
+00021c90: 205f 6765 745f 736b 7973 6572 7665 5f68   _get_skyserve_h
+00021ca0: 7474 705f 7465 7374 286e 616d 653a 2073  ttp_test(name: s
+00021cb0: 7472 2c20 636c 6f75 643a 2073 7472 2c0a  tr, cloud: str,.
+00021cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021cd0: 2020 2020 2020 2020 2020 2020 7469 6d65              time
+00021ce0: 6f75 745f 6d69 6e75 7465 733a 2069 6e74  out_minutes: int
+00021cf0: 2920 2d3e 2054 6573 743a 0a20 2020 2074  ) -> Test:.    t
+00021d00: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00021d10: 2020 2020 6627 7465 7374 2d73 6b79 7365      f'test-skyse
+00021d20: 7276 652d 7b63 6c6f 7564 2e72 6570 6c61  rve-{cloud.repla
+00021d30: 6365 2822 5f22 2c20 222d 2229 7d27 2c0a  ce("_", "-")}',.
+00021d40: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00021d50: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
+00021d60: 6520 7570 202d 6e20 7b6e 616d 657d 202d  e up -n {name} -
+00021d70: 7920 7465 7374 732f 736b 7973 6572 7665  y tests/skyserve
+00021d80: 2f68 7474 702f 7b63 6c6f 7564 7d2e 7961  /http/{cloud}.ya
+00021d90: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00021da0: 205f 5345 5256 455f 5741 4954 5f55 4e54   _SERVE_WAIT_UNT
+00021db0: 494c 5f52 4541 4459 2e66 6f72 6d61 7428  IL_READY.format(
+00021dc0: 6e61 6d65 3d6e 616d 652c 2072 6570 6c69  name=name, repli
+00021dd0: 6361 5f6e 756d 3d32 292c 0a20 2020 2020  ca_num=2),.     
+00021de0: 2020 2020 2020 2066 277b 5f53 4552 5645         f'{_SERVE
+00021df0: 5f45 4e44 504f 494e 545f 5741 4954 2e66  _ENDPOINT_WAIT.f
+00021e00: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+00021e10: 7d3b 2027 0a20 2020 2020 2020 2020 2020  }; '.           
+00021e20: 2027 6375 726c 202d 4c20 6874 7470 3a2f   'curl -L http:/
+00021e30: 2f24 656e 6470 6f69 6e74 207c 2067 7265  /$endpoint | gre
+00021e40: 7020 2248 692c 2053 6b79 5069 6c6f 7420  p "Hi, SkyPilot 
+00021e50: 6865 7265 2227 2c0a 2020 2020 2020 2020  here"',.        
+00021e60: 5d2c 0a20 2020 2020 2020 205f 5445 4152  ],.        _TEAR
+00021e70: 444f 574e 5f53 4552 5649 4345 2e66 6f72  DOWN_SERVICE.for
+00021e80: 6d61 7428 6e61 6d65 3d6e 616d 6529 2c0a  mat(name=name),.
+00021e90: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00021ea0: 7469 6d65 6f75 745f 6d69 6e75 7465 7320  timeout_minutes 
+00021eb0: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
+00021ec0: 7265 7475 726e 2074 6573 740a 0a0a 6465  return test...de
+00021ed0: 6620 5f63 6865 636b 5f72 6570 6c69 6361  f _check_replica
+00021ee0: 5f69 6e5f 7374 6174 7573 286e 616d 653a  _in_status(name:
+00021ef0: 2073 7472 2c20 6368 6563 6b5f 7475 706c   str, check_tupl
+00021f00: 6573 3a20 4c69 7374 5b54 7570 6c65 5b69  es: List[Tuple[i
+00021f10: 6e74 2c20 626f 6f6c 2c0a 2020 2020 2020  nt, bool,.      
 00021f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00021f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021f40: 2020 2020 2073 7472 5d5d 2920 2d3e 2073       str]]) -> s
-00021f50: 7472 3a0a 2020 2020 2222 2243 6865 636b  tr:.    """Check
-00021f60: 2072 6570 6c69 6361 7327 2073 7461 7475   replicas' statu
-00021f70: 7320 616e 6420 636f 756e 7420 696e 2073  s and count in s
-00021f80: 6b79 2073 6572 7665 2073 7461 7475 730a  ky serve status.
-00021f90: 0a20 2020 2057 6520 7769 6c6c 2063 6865  .    We will che
-00021fa0: 636b 2076 4350 553d 322c 2061 7320 616c  ck vCPU=2, as al
-00021fb0: 6c20 6f75 7220 7465 7374 7320 7573 6520  l our tests use 
-00021fc0: 7643 5055 3d32 2e0a 2020 2020 0a20 2020  vCPU=2..    .   
-00021fd0: 2041 7267 733a 0a20 2020 2020 2020 206e   Args:.        n
-00021fe0: 616d 653a 2074 6865 206e 616d 6520 6f66  ame: the name of
-00021ff0: 2074 6865 2073 6572 7669 6365 0a20 2020   the service.   
-00022000: 2020 2020 2063 6865 636b 5f74 7570 6c65       check_tuple
-00022010: 733a 2041 206c 6973 7420 6f66 2072 6570  s: A list of rep
-00022020: 6c69 6361 2070 726f 7065 7274 7920 746f  lica property to
-00022030: 2063 6865 636b 2e20 4561 6368 2074 7570   check. Each tup
-00022040: 6c65 2069 730a 2020 2020 2020 2020 2020  le is.          
-00022050: 2020 2863 6f75 6e74 2c20 6973 5f73 706f    (count, is_spo
-00022060: 742c 2073 7461 7475 7329 0a20 2020 2022  t, status).    "
-00022070: 2222 0a20 2020 2063 6865 636b 5f63 6d64  "".    check_cmd
-00022080: 203d 2027 270a 2020 2020 666f 7220 6368   = ''.    for ch
-00022090: 6563 6b5f 7475 706c 6520 696e 2063 6865  eck_tuple in che
-000220a0: 636b 5f74 7570 6c65 733a 0a20 2020 2020  ck_tuples:.     
-000220b0: 2020 2063 6f75 6e74 2c20 6973 5f73 706f     count, is_spo
-000220c0: 742c 2073 7461 7475 7320 3d20 6368 6563  t, status = chec
-000220d0: 6b5f 7475 706c 650a 2020 2020 2020 2020  k_tuple.        
-000220e0: 7265 736f 7572 6365 5f73 7472 203d 2027  resource_str = '
-000220f0: 270a 2020 2020 2020 2020 6966 2073 7461  '.        if sta
-00022100: 7475 7320 6e6f 7420 696e 205b 2750 454e  tus not in ['PEN
-00022110: 4449 4e47 272c 2027 5348 5554 5449 4e47  DING', 'SHUTTING
-00022120: 5f44 4f57 4e27 0a20 2020 2020 2020 2020  _DOWN'.         
-00022130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022140: 5d20 616e 6420 6e6f 7420 7374 6174 7573  ] and not status
-00022150: 2e73 7461 7274 7377 6974 6828 2746 4149  .startswith('FAI
-00022160: 4c45 4427 293a 0a20 2020 2020 2020 2020  LED'):.         
-00022170: 2020 2073 706f 745f 7374 7220 3d20 2727     spot_str = ''
-00022180: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00022190: 6973 5f73 706f 743a 0a20 2020 2020 2020  is_spot:.       
-000221a0: 2020 2020 2020 2020 2073 706f 745f 7374           spot_st
-000221b0: 7220 3d20 275c 5b53 706f 745c 5d27 0a20  r = '\[Spot\]'. 
-000221c0: 2020 2020 2020 2020 2020 2072 6573 6f75             resou
-000221d0: 7263 655f 7374 7220 3d20 6627 287b 7370  rce_str = f'({sp
-000221e0: 6f74 5f73 7472 7d76 4350 553d 3229 270a  ot_str}vCPU=2)'.
-000221f0: 2020 2020 2020 2020 6368 6563 6b5f 636d          check_cm
-00022200: 6420 2b3d 2028 6627 2065 6368 6f20 2224  d += (f' echo "$
-00022210: 7322 207c 2067 7265 7020 227b 7265 736f  s" | grep "{reso
-00022220: 7572 6365 5f73 7472 7d22 207c 2027 0a20  urce_str}" | '. 
-00022230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022240: 2020 2020 2066 2767 7265 7020 227b 7374       f'grep "{st
-00022250: 6174 7573 7d22 207c 2077 6320 2d6c 207c  atus}" | wc -l |
-00022260: 2067 7265 7020 7b63 6f75 6e74 7d20 7c7c   grep {count} ||
-00022270: 2065 7869 7420 313b 2729 0a20 2020 2072   exit 1;').    r
-00022280: 6574 7572 6e20 2866 277b 5f53 4552 5645  eturn (f'{_SERVE
-00022290: 5f53 5441 5455 535f 5741 4954 2e66 6f72  _STATUS_WAIT.for
-000222a0: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
-000222b0: 2065 6368 6f20 2224 7322 3b20 2720 2b20   echo "$s"; ' + 
-000222c0: 6368 6563 6b5f 636d 6429 0a0a 0a64 6566  check_cmd)...def
-000222d0: 205f 6368 6563 6b5f 7365 7276 6963 655f   _check_service_
-000222e0: 7665 7273 696f 6e28 7365 7276 6963 655f  version(service_
-000222f0: 6e61 6d65 3a20 7374 722c 2076 6572 7369  name: str, versi
-00022300: 6f6e 3a20 7374 7229 202d 3e20 7374 723a  on: str) -> str:
-00022310: 0a20 2020 2023 2047 7265 7020 7468 6520  .    # Grep the 
-00022320: 6c69 6e65 7320 6265 666f 7265 2027 5365  lines before 'Se
-00022330: 7276 6963 6520 5265 706c 6963 6173 2720  rvice Replicas' 
-00022340: 616e 6420 6368 6563 6b20 6966 2074 6865  and check if the
-00022350: 2073 6572 7669 6365 2076 6572 7369 6f6e   service version
-00022360: 0a20 2020 2023 2069 7320 636f 7272 6563  .    # is correc
-00022370: 742e 0a20 2020 2072 6574 7572 6e20 2866  t..    return (f
-00022380: 2765 6368 6f20 2224 7322 207c 2067 7265  'echo "$s" | gre
-00022390: 7020 2d42 3130 3030 2022 5365 7276 6963  p -B1000 "Servic
-000223a0: 6520 5265 706c 6963 6173 2220 7c20 270a  e Replicas" | '.
-000223b0: 2020 2020 2020 2020 2020 2020 6627 6772              f'gr
-000223c0: 6570 202d 4520 227b 7365 7276 6963 655f  ep -E "{service_
-000223d0: 6e61 6d65 7d5c 732b 7b76 6572 7369 6f6e  name}\s+{version
-000223e0: 7d22 207c 7c20 6578 6974 2031 3b20 2729  }" || exit 1; ')
-000223f0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00022400: 6763 700a 4070 7974 6573 742e 6d61 726b  gcp.@pytest.mark
-00022410: 2e73 6572 7665 0a64 6566 2074 6573 745f  .serve.def test_
-00022420: 736b 7973 6572 7665 5f67 6370 5f68 7474  skyserve_gcp_htt
-00022430: 7028 293a 0a20 2020 2022 2222 5465 7374  p():.    """Test
-00022440: 2073 6b79 7365 7276 6520 6f6e 2047 4350   skyserve on GCP
-00022450: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
-00022460: 6765 745f 7365 7276 6963 655f 6e61 6d65  get_service_name
-00022470: 2829 0a20 2020 2074 6573 7420 3d20 5f67  ().    test = _g
-00022480: 6574 5f73 6b79 7365 7276 655f 6874 7470  et_skyserve_http
-00022490: 5f74 6573 7428 6e61 6d65 2c20 2767 6370  _test(name, 'gcp
-000224a0: 272c 2032 3029 0a20 2020 2072 756e 5f6f  ', 20).    run_o
-000224b0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-000224c0: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
-000224d0: 0a40 7079 7465 7374 2e6d 6172 6b2e 7365  .@pytest.mark.se
-000224e0: 7276 650a 6465 6620 7465 7374 5f73 6b79  rve.def test_sky
-000224f0: 7365 7276 655f 6177 735f 6874 7470 2829  serve_aws_http()
-00022500: 3a0a 2020 2020 2222 2254 6573 7420 736b  :.    """Test sk
-00022510: 7973 6572 7665 206f 6e20 4157 5322 2222  yserve on AWS"""
-00022520: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00022530: 5f73 6572 7669 6365 5f6e 616d 6528 290a  _service_name().
-00022540: 2020 2020 7465 7374 203d 205f 6765 745f      test = _get_
-00022550: 736b 7973 6572 7665 5f68 7474 705f 7465  skyserve_http_te
-00022560: 7374 286e 616d 652c 2027 6177 7327 2c20  st(name, 'aws', 
-00022570: 3230 290a 2020 2020 7275 6e5f 6f6e 655f  20).    run_one_
-00022580: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-00022590: 7465 7374 2e6d 6172 6b2e 617a 7572 650a  test.mark.azure.
-000225a0: 4070 7974 6573 742e 6d61 726b 2e73 6572  @pytest.mark.ser
-000225b0: 7665 0a64 6566 2074 6573 745f 736b 7973  ve.def test_skys
-000225c0: 6572 7665 5f61 7a75 7265 5f68 7474 7028  erve_azure_http(
-000225d0: 293a 0a20 2020 2022 2222 5465 7374 2073  ):.    """Test s
-000225e0: 6b79 7365 7276 6520 6f6e 2041 7a75 7265  kyserve on Azure
-000225f0: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
-00022600: 6765 745f 7365 7276 6963 655f 6e61 6d65  get_service_name
-00022610: 2829 0a20 2020 2074 6573 7420 3d20 5f67  ().    test = _g
-00022620: 6574 5f73 6b79 7365 7276 655f 6874 7470  et_skyserve_http
-00022630: 5f74 6573 7428 6e61 6d65 2c20 2761 7a75  _test(name, 'azu
-00022640: 7265 272c 2033 3029 0a20 2020 2072 756e  re', 30).    run
-00022650: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-00022660: 0a0a 4070 7974 6573 742e 6d61 726b 2e6b  ..@pytest.mark.k
-00022670: 7562 6572 6e65 7465 730a 4070 7974 6573  ubernetes.@pytes
-00022680: 742e 6d61 726b 2e73 6572 7665 0a64 6566  t.mark.serve.def
-00022690: 2074 6573 745f 736b 7973 6572 7665 5f6b   test_skyserve_k
-000226a0: 7562 6572 6e65 7465 735f 6874 7470 2829  ubernetes_http()
-000226b0: 3a0a 2020 2020 2222 2254 6573 7420 736b  :.    """Test sk
-000226c0: 7973 6572 7665 206f 6e20 4b75 6265 726e  yserve on Kubern
-000226d0: 6574 6573 2222 220a 2020 2020 6e61 6d65  etes""".    name
-000226e0: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
-000226f0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-00022700: 3d20 5f67 6574 5f73 6b79 7365 7276 655f  = _get_skyserve_
-00022710: 6874 7470 5f74 6573 7428 6e61 6d65 2c20  http_test(name, 
-00022720: 276b 7562 6572 6e65 7465 7327 2c20 3330  'kubernetes', 30
-00022730: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00022740: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-00022750: 7374 2e6d 6172 6b2e 7365 7276 650a 6465  st.mark.serve.de
-00022760: 6620 7465 7374 5f73 6b79 7365 7276 655f  f test_skyserve_
-00022770: 6c6c 6d28 6765 6e65 7269 635f 636c 6f75  llm(generic_clou
-00022780: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
-00022790: 5465 7374 2073 6b79 7365 7276 6520 7769  Test skyserve wi
-000227a0: 7468 2072 6561 6c20 4c4c 4d20 7573 6563  th real LLM usec
-000227b0: 6173 6522 2222 0a20 2020 206e 616d 6520  ase""".    name 
-000227c0: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
-000227d0: 616d 6528 290a 0a20 2020 2064 6566 2067  ame()..    def g
-000227e0: 656e 6572 6174 655f 6c6c 6d5f 7465 7374  enerate_llm_test
-000227f0: 5f63 6f6d 6d61 6e64 2870 726f 6d70 743a  _command(prompt:
-00022800: 2073 7472 2c20 6578 7065 6374 6564 5f6f   str, expected_o
-00022810: 7574 7075 743a 2073 7472 2920 2d3e 2073  utput: str) -> s
-00022820: 7472 3a0a 2020 2020 2020 2020 7072 6f6d  tr:.        prom
-00022830: 7074 203d 2073 686c 6578 2e71 756f 7465  pt = shlex.quote
-00022840: 2870 726f 6d70 7429 0a20 2020 2020 2020  (prompt).       
-00022850: 2065 7870 6563 7465 645f 6f75 7470 7574   expected_output
-00022860: 203d 2073 686c 6578 2e71 756f 7465 2865   = shlex.quote(e
-00022870: 7870 6563 7465 645f 6f75 7470 7574 290a  xpected_output).
-00022880: 2020 2020 2020 2020 7265 7475 726e 2028          return (
-00022890: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-000228a0: 5f53 4552 5645 5f45 4e44 504f 494e 545f  _SERVE_ENDPOINT_
-000228b0: 5741 4954 2e66 6f72 6d61 7428 6e61 6d65  WAIT.format(name
-000228c0: 3d6e 616d 6529 7d3b 2027 0a20 2020 2020  =name)}; '.     
-000228d0: 2020 2020 2020 2027 7079 7468 6f6e 2074         'python t
-000228e0: 6573 7473 2f73 6b79 7365 7276 652f 6c6c  ests/skyserve/ll
-000228f0: 6d2f 6765 745f 7265 7370 6f6e 7365 2e70  m/get_response.p
-00022900: 7920 2d2d 656e 6470 6f69 6e74 2024 656e  y --endpoint $en
-00022910: 6470 6f69 6e74 2027 0a20 2020 2020 2020  dpoint '.       
-00022920: 2020 2020 2066 272d 2d70 726f 6d70 7420       f'--prompt 
-00022930: 7b70 726f 6d70 747d 207c 2067 7265 7020  {prompt} | grep 
-00022940: 7b65 7870 6563 7465 645f 6f75 7470 7574  {expected_output
-00022950: 7d27 290a 0a20 2020 2077 6974 6820 6f70  }')..    with op
-00022960: 656e 2827 7465 7374 732f 736b 7973 6572  en('tests/skyser
-00022970: 7665 2f6c 6c6d 2f70 726f 6d70 745f 6f75  ve/llm/prompt_ou
-00022980: 7470 7574 2e6a 736f 6e27 2c20 2772 272c  tput.json', 'r',
-00022990: 0a20 2020 2020 2020 2020 2020 2020 2065  .              e
-000229a0: 6e63 6f64 696e 673d 2775 7466 2d38 2729  ncoding='utf-8')
-000229b0: 2061 7320 663a 0a20 2020 2020 2020 2070   as f:.        p
-000229c0: 726f 6d70 7432 6f75 7470 7574 203d 206a  rompt2output = j
-000229d0: 736f 6e2e 6c6f 6164 2866 290a 0a20 2020  son.load(f)..   
-000229e0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-000229f0: 2020 2020 2020 6627 7465 7374 2d73 6b79        f'test-sky
-00022a00: 7365 7276 652d 6c6c 6d27 2c0a 2020 2020  serve-llm',.    
-00022a10: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00022a20: 2020 6627 736b 7920 7365 7276 6520 7570    f'sky serve up
-00022a30: 202d 6e20 7b6e 616d 657d 202d 2d63 6c6f   -n {name} --clo
-00022a40: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
-00022a50: 647d 202d 7920 7465 7374 732f 736b 7973  d} -y tests/skys
-00022a60: 6572 7665 2f6c 6c6d 2f73 6572 7669 6365  erve/llm/service
-00022a70: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00022a80: 2020 2020 5f53 4552 5645 5f57 4149 545f      _SERVE_WAIT_
-00022a90: 554e 5449 4c5f 5245 4144 592e 666f 726d  UNTIL_READY.form
-00022aa0: 6174 286e 616d 653d 6e61 6d65 2c20 7265  at(name=name, re
-00022ab0: 706c 6963 615f 6e75 6d3d 3129 2c0a 2020  plica_num=1),.  
-00022ac0: 2020 2020 2020 2020 2020 2a5b 0a20 2020            *[.   
-00022ad0: 2020 2020 2020 2020 2020 2020 2067 656e               gen
-00022ae0: 6572 6174 655f 6c6c 6d5f 7465 7374 5f63  erate_llm_test_c
-00022af0: 6f6d 6d61 6e64 2870 726f 6d70 742c 206f  ommand(prompt, o
-00022b00: 7574 7075 7429 0a20 2020 2020 2020 2020  utput).         
-00022b10: 2020 2020 2020 2066 6f72 2070 726f 6d70         for promp
-00022b20: 742c 206f 7574 7075 7420 696e 2070 726f  t, output in pro
-00022b30: 6d70 7432 6f75 7470 7574 2e69 7465 6d73  mpt2output.items
-00022b40: 2829 0a20 2020 2020 2020 2020 2020 205d  ().            ]
-00022b50: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-00022b60: 2020 2020 205f 5445 4152 444f 574e 5f53       _TEARDOWN_S
-00022b70: 4552 5649 4345 2e66 6f72 6d61 7428 6e61  ERVICE.format(na
-00022b80: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
-00022b90: 2020 7469 6d65 6f75 743d 3430 202a 2036    timeout=40 * 6
-00022ba0: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
-00022bb0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-00022bc0: 0a0a 4070 7974 6573 742e 6d61 726b 2e67  ..@pytest.mark.g
-00022bd0: 6370 0a40 7079 7465 7374 2e6d 6172 6b2e  cp.@pytest.mark.
-00022be0: 7365 7276 650a 6465 6620 7465 7374 5f73  serve.def test_s
-00022bf0: 6b79 7365 7276 655f 7370 6f74 5f72 6563  kyserve_spot_rec
-00022c00: 6f76 6572 7928 293a 0a20 2020 206e 616d  overy():.    nam
-00022c10: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
-00022c20: 5f6e 616d 6528 290a 2020 2020 7a6f 6e65  _name().    zone
-00022c30: 203d 2027 7573 2d63 656e 7472 616c 312d   = 'us-central1-
-00022c40: 6127 0a0a 2020 2020 7465 7374 203d 2054  a'..    test = T
-00022c50: 6573 7428 0a20 2020 2020 2020 2066 2774  est(.        f't
-00022c60: 6573 742d 736b 7973 6572 7665 2d73 706f  est-skyserve-spo
-00022c70: 742d 7265 636f 7665 7279 2d67 6370 272c  t-recovery-gcp',
-00022c80: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-00022c90: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
-00022ca0: 7665 2075 7020 2d6e 207b 6e61 6d65 7d20  ve up -n {name} 
-00022cb0: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
-00022cc0: 652f 7370 6f74 2f72 6563 6f76 6572 792e  e/spot/recovery.
-00022cd0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00022ce0: 2020 205f 5345 5256 455f 5741 4954 5f55     _SERVE_WAIT_U
-00022cf0: 4e54 494c 5f52 4541 4459 2e66 6f72 6d61  NTIL_READY.forma
-00022d00: 7428 6e61 6d65 3d6e 616d 652c 2072 6570  t(name=name, rep
-00022d10: 6c69 6361 5f6e 756d 3d31 292c 0a20 2020  lica_num=1),.   
-00022d20: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
-00022d30: 5645 5f45 4e44 504f 494e 545f 5741 4954  VE_ENDPOINT_WAIT
-00022d40: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-00022d50: 6529 7d3b 2027 0a20 2020 2020 2020 2020  e)}; '.         
-00022d60: 2020 2027 7265 7175 6573 745f 6f75 7470     'request_outp
-00022d70: 7574 3d24 2863 7572 6c20 2d4c 2068 7474  ut=$(curl -L htt
-00022d80: 703a 2f2f 2465 6e64 706f 696e 7429 3b20  p://$endpoint); 
-00022d90: 6563 686f 2022 2472 6571 7565 7374 5f6f  echo "$request_o
-00022da0: 7574 7075 7422 3b20 6563 686f 2022 2472  utput"; echo "$r
-00022db0: 6571 7565 7374 5f6f 7574 7075 7422 207c  equest_output" |
-00022dc0: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
-00022dd0: 6c6f 7420 6865 7265 2227 2c0a 2020 2020  lot here"',.    
-00022de0: 2020 2020 2020 2020 5f74 6572 6d69 6e61          _termina
-00022df0: 7465 5f67 6370 5f72 6570 6c69 6361 286e  te_gcp_replica(n
-00022e00: 616d 652c 207a 6f6e 652c 2031 292c 0a20  ame, zone, 1),. 
-00022e10: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
-00022e20: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
-00022e30: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
-00022e40: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
-00022e50: 3d31 292c 0a20 2020 2020 2020 2020 2020  =1),.           
-00022e60: 2066 277b 5f53 4552 5645 5f45 4e44 504f   f'{_SERVE_ENDPO
-00022e70: 494e 545f 5741 4954 2e66 6f72 6d61 7428  INT_WAIT.format(
-00022e80: 6e61 6d65 3d6e 616d 6529 7d3b 2027 0a20  name=name)}; '. 
-00022e90: 2020 2020 2020 2020 2020 2027 7265 7175             'requ
-00022ea0: 6573 745f 6f75 7470 7574 3d24 2863 7572  est_output=$(cur
-00022eb0: 6c20 2d4c 2068 7474 703a 2f2f 2465 6e64  l -L http://$end
-00022ec0: 706f 696e 7429 3b20 6563 686f 2022 2472  point); echo "$r
-00022ed0: 6571 7565 7374 5f6f 7574 7075 7422 3b20  equest_output"; 
-00022ee0: 6563 686f 2022 2472 6571 7565 7374 5f6f  echo "$request_o
-00022ef0: 7574 7075 7422 207c 2067 7265 7020 2248  utput" | grep "H
-00022f00: 692c 2053 6b79 5069 6c6f 7420 6865 7265  i, SkyPilot here
-00022f10: 2227 2c0a 2020 2020 2020 2020 5d2c 0a20  "',.        ],. 
-00022f20: 2020 2020 2020 205f 5445 4152 444f 574e         _TEARDOWN
-00022f30: 5f53 4552 5649 4345 2e66 6f72 6d61 7428  _SERVICE.format(
-00022f40: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
-00022f50: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
-00022f60: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
-00022f70: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00022f80: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00022f90: 2e73 6572 7665 0a40 7079 7465 7374 2e6d  .serve.@pytest.m
-00022fa0: 6172 6b2e 6e6f 5f6b 7562 6572 6e65 7465  ark.no_kubernete
-00022fb0: 730a 6465 6620 7465 7374 5f73 6b79 7365  s.def test_skyse
-00022fc0: 7276 655f 6261 7365 5f6f 6e64 656d 616e  rve_base_ondeman
-00022fd0: 645f 6661 6c6c 6261 636b 2867 656e 6572  d_fallback(gener
-00022fe0: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
-00022ff0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00023000: 7365 7276 6963 655f 6e61 6d65 2829 0a20  service_name(). 
-00023010: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00023020: 2020 2020 2020 2020 6627 7465 7374 2d73          f'test-s
-00023030: 6b79 7365 7276 652d 6261 7365 2d6f 6e64  kyserve-base-ond
-00023040: 656d 616e 642d 6661 6c6c 6261 636b 272c  emand-fallback',
-00023050: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-00023060: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
-00023070: 7665 2075 7020 2d6e 207b 6e61 6d65 7d20  ve up -n {name} 
-00023080: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-00023090: 5f63 6c6f 7564 7d20 2d79 2074 6573 7473  _cloud} -y tests
-000230a0: 2f73 6b79 7365 7276 652f 7370 6f74 2f62  /skyserve/spot/b
-000230b0: 6173 655f 6f6e 6465 6d61 6e64 5f66 616c  ase_ondemand_fal
-000230c0: 6c62 6163 6b2e 7961 6d6c 272c 0a20 2020  lback.yaml',.   
-000230d0: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
-000230e0: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
-000230f0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-00023100: 652c 2072 6570 6c69 6361 5f6e 756d 3d32  e, replica_num=2
-00023110: 292c 0a20 2020 2020 2020 2020 2020 205f  ),.            _
-00023120: 6368 6563 6b5f 7265 706c 6963 615f 696e  check_replica_in
-00023130: 5f73 7461 7475 7328 6e61 6d65 2c20 5b28  _status(name, [(
-00023140: 312c 2054 7275 652c 2027 5245 4144 5927  1, True, 'READY'
-00023150: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00023160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023170: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00023180: 312c 2046 616c 7365 2c20 2752 4541 4459  1, False, 'READY
-00023190: 2729 5d29 2c0a 2020 2020 2020 2020 5d2c  ')]),.        ],
-000231a0: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
-000231b0: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
-000231c0: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
-000231d0: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
-000231e0: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-000231f0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00023200: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00023210: 726b 2e67 6370 0a40 7079 7465 7374 2e6d  rk.gcp.@pytest.m
-00023220: 6172 6b2e 7365 7276 650a 6465 6620 7465  ark.serve.def te
-00023230: 7374 5f73 6b79 7365 7276 655f 6479 6e61  st_skyserve_dyna
-00023240: 6d69 635f 6f6e 6465 6d61 6e64 5f66 616c  mic_ondemand_fal
-00023250: 6c62 6163 6b28 293a 0a20 2020 206e 616d  lback():.    nam
-00023260: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
-00023270: 5f6e 616d 6528 290a 2020 2020 7a6f 6e65  _name().    zone
-00023280: 203d 2027 7573 2d63 656e 7472 616c 312d   = 'us-central1-
-00023290: 6127 0a0a 2020 2020 7465 7374 203d 2054  a'..    test = T
-000232a0: 6573 7428 0a20 2020 2020 2020 2066 2774  est(.        f't
-000232b0: 6573 742d 736b 7973 6572 7665 2d64 796e  est-skyserve-dyn
-000232c0: 616d 6963 2d6f 6e64 656d 616e 642d 6661  amic-ondemand-fa
-000232d0: 6c6c 6261 636b 272c 0a20 2020 2020 2020  llback',.       
-000232e0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-000232f0: 2773 6b79 2073 6572 7665 2075 7020 2d6e  'sky serve up -n
-00023300: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-00023310: 6763 7020 2d79 2074 6573 7473 2f73 6b79  gcp -y tests/sky
-00023320: 7365 7276 652f 7370 6f74 2f64 796e 616d  serve/spot/dynam
-00023330: 6963 5f6f 6e64 656d 616e 645f 6661 6c6c  ic_ondemand_fall
-00023340: 6261 636b 2e79 616d 6c27 2c0a 2020 2020  back.yaml',.    
-00023350: 2020 2020 2020 2020 6627 736c 6565 7020          f'sleep 
-00023360: 3430 272c 0a20 2020 2020 2020 2020 2020  40',.           
-00023370: 2023 2032 206f 6e2d 6465 6d61 6e64 2028   # 2 on-demand (
-00023380: 7072 6f76 6973 696f 6e69 6e67 2920 2b20  provisioning) + 
-00023390: 3220 5370 6f74 2028 7072 6f76 6973 696f  2 Spot (provisio
-000233a0: 6e69 6e67 292e 0a20 2020 2020 2020 2020  ning)..         
-000233b0: 2020 2066 277b 5f53 4552 5645 5f53 5441     f'{_SERVE_STA
-000233c0: 5455 535f 5741 4954 2e66 6f72 6d61 7428  TUS_WAIT.format(
-000233d0: 6e61 6d65 3d6e 616d 6529 7d3b 2065 6368  name=name)}; ech
-000233e0: 6f20 2224 7322 3b27 0a20 2020 2020 2020  o "$s";'.       
-000233f0: 2020 2020 2027 6563 686f 2022 2473 2220       'echo "$s" 
-00023400: 7c20 6772 6570 202d 7120 2230 2f34 2220  | grep -q "0/4" 
-00023410: 7c7c 2065 7869 7420 3127 2c0a 2020 2020  || exit 1',.    
-00023420: 2020 2020 2020 2020 2320 5761 6974 2066          # Wait f
-00023430: 6f72 2074 6865 2070 726f 7669 7369 6f6e  or the provision
-00023440: 696e 6720 7374 6172 7473 0a20 2020 2020  ing starts.     
-00023450: 2020 2020 2020 2066 2773 6c65 6570 2034         f'sleep 4
-00023460: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-00023470: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
-00023480: 6e5f 7374 6174 7573 286e 616d 652c 205b  n_status(name, [
-00023490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000234a0: 2028 322c 2054 7275 652c 205f 5345 5256   (2, True, _SERV
-000234b0: 4943 455f 4c41 554e 4348 494e 475f 5354  ICE_LAUNCHING_ST
-000234c0: 4154 5553 5f52 4547 4558 202b 2027 5c7c  ATUS_REGEX + '\|
-000234d0: 5245 4144 5927 292c 0a20 2020 2020 2020  READY'),.       
-000234e0: 2020 2020 2020 2020 2028 322c 2046 616c           (2, Fal
-000234f0: 7365 2c20 5f53 4552 5649 4345 5f4c 4155  se, _SERVICE_LAU
-00023500: 4e43 4849 4e47 5f53 5441 5455 535f 5245  NCHING_STATUS_RE
-00023510: 4745 5820 2b20 275c 7c53 4855 5454 494e  GEX + '\|SHUTTIN
-00023520: 475f 444f 574e 2729 0a20 2020 2020 2020  G_DOWN').       
-00023530: 2020 2020 205d 292c 0a0a 2020 2020 2020       ]),..      
-00023540: 2020 2020 2020 2320 5761 6974 2075 6e74        # Wait unt
-00023550: 696c 2032 2073 706f 7420 696e 7374 616e  il 2 spot instan
-00023560: 6365 7320 6172 6520 7265 6164 792e 0a20  ces are ready.. 
-00023570: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
-00023580: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
-00023590: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
-000235a0: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
-000235b0: 3d32 292c 0a20 2020 2020 2020 2020 2020  =2),.           
-000235c0: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
-000235d0: 696e 5f73 7461 7475 7328 6e61 6d65 2c20  in_status(name, 
-000235e0: 5b28 322c 2054 7275 652c 2027 5245 4144  [(2, True, 'READ
-000235f0: 5927 292c 0a20 2020 2020 2020 2020 2020  Y'),.           
-00023600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021f50: 2020 2020 2020 2020 2020 2073 7472 5d5d             str]]
+00021f60: 2920 2d3e 2073 7472 3a0a 2020 2020 2222  ) -> str:.    ""
+00021f70: 2243 6865 636b 2072 6570 6c69 6361 7327  "Check replicas'
+00021f80: 2073 7461 7475 7320 616e 6420 636f 756e   status and coun
+00021f90: 7420 696e 2073 6b79 2073 6572 7665 2073  t in sky serve s
+00021fa0: 7461 7475 730a 0a20 2020 2057 6520 7769  tatus..    We wi
+00021fb0: 6c6c 2063 6865 636b 2076 4350 553d 322c  ll check vCPU=2,
+00021fc0: 2061 7320 616c 6c20 6f75 7220 7465 7374   as all our test
+00021fd0: 7320 7573 6520 7643 5055 3d32 2e0a 2020  s use vCPU=2..  
+00021fe0: 2020 0a20 2020 2041 7267 733a 0a20 2020    .    Args:.   
+00021ff0: 2020 2020 206e 616d 653a 2074 6865 206e       name: the n
+00022000: 616d 6520 6f66 2074 6865 2073 6572 7669  ame of the servi
+00022010: 6365 0a20 2020 2020 2020 2063 6865 636b  ce.        check
+00022020: 5f74 7570 6c65 733a 2041 206c 6973 7420  _tuples: A list 
+00022030: 6f66 2072 6570 6c69 6361 2070 726f 7065  of replica prope
+00022040: 7274 7920 746f 2063 6865 636b 2e20 4561  rty to check. Ea
+00022050: 6368 2074 7570 6c65 2069 730a 2020 2020  ch tuple is.    
+00022060: 2020 2020 2020 2020 2863 6f75 6e74 2c20          (count, 
+00022070: 6973 5f73 706f 742c 2073 7461 7475 7329  is_spot, status)
+00022080: 0a20 2020 2022 2222 0a20 2020 2063 6865  .    """.    che
+00022090: 636b 5f63 6d64 203d 2027 270a 2020 2020  ck_cmd = ''.    
+000220a0: 666f 7220 6368 6563 6b5f 7475 706c 6520  for check_tuple 
+000220b0: 696e 2063 6865 636b 5f74 7570 6c65 733a  in check_tuples:
+000220c0: 0a20 2020 2020 2020 2063 6f75 6e74 2c20  .        count, 
+000220d0: 6973 5f73 706f 742c 2073 7461 7475 7320  is_spot, status 
+000220e0: 3d20 6368 6563 6b5f 7475 706c 650a 2020  = check_tuple.  
+000220f0: 2020 2020 2020 7265 736f 7572 6365 5f73        resource_s
+00022100: 7472 203d 2027 270a 2020 2020 2020 2020  tr = ''.        
+00022110: 6966 2073 7461 7475 7320 6e6f 7420 696e  if status not in
+00022120: 205b 2750 454e 4449 4e47 272c 2027 5348   ['PENDING', 'SH
+00022130: 5554 5449 4e47 5f44 4f57 4e27 0a20 2020  UTTING_DOWN'.   
+00022140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022150: 2020 2020 2020 5d20 616e 6420 6e6f 7420        ] and not 
+00022160: 7374 6174 7573 2e73 7461 7274 7377 6974  status.startswit
+00022170: 6828 2746 4149 4c45 4427 293a 0a20 2020  h('FAILED'):.   
+00022180: 2020 2020 2020 2020 2073 706f 745f 7374           spot_st
+00022190: 7220 3d20 2727 0a20 2020 2020 2020 2020  r = ''.         
+000221a0: 2020 2069 6620 6973 5f73 706f 743a 0a20     if is_spot:. 
+000221b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000221c0: 706f 745f 7374 7220 3d20 275c 5b53 706f  pot_str = '\[Spo
+000221d0: 745c 5d27 0a20 2020 2020 2020 2020 2020  t\]'.           
+000221e0: 2072 6573 6f75 7263 655f 7374 7220 3d20   resource_str = 
+000221f0: 6627 287b 7370 6f74 5f73 7472 7d76 4350  f'({spot_str}vCP
+00022200: 553d 3229 270a 2020 2020 2020 2020 6368  U=2)'.        ch
+00022210: 6563 6b5f 636d 6420 2b3d 2028 6627 2065  eck_cmd += (f' e
+00022220: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+00022230: 227b 7265 736f 7572 6365 5f73 7472 7d22  "{resource_str}"
+00022240: 207c 2027 0a20 2020 2020 2020 2020 2020   | '.           
+00022250: 2020 2020 2020 2020 2020 2066 2767 7265             f'gre
+00022260: 7020 227b 7374 6174 7573 7d22 207c 2077  p "{status}" | w
+00022270: 6320 2d6c 207c 2067 7265 7020 7b63 6f75  c -l | grep {cou
+00022280: 6e74 7d20 7c7c 2065 7869 7420 313b 2729  nt} || exit 1;')
+00022290: 0a20 2020 2072 6574 7572 6e20 2866 277b  .    return (f'{
+000222a0: 5f53 4552 5645 5f53 5441 5455 535f 5741  _SERVE_STATUS_WA
+000222b0: 4954 2e66 6f72 6d61 7428 6e61 6d65 3d6e  IT.format(name=n
+000222c0: 616d 6529 7d3b 2065 6368 6f20 2224 7322  ame)}; echo "$s"
+000222d0: 3b20 2720 2b20 6368 6563 6b5f 636d 6429  ; ' + check_cmd)
+000222e0: 0a0a 0a64 6566 205f 6368 6563 6b5f 7365  ...def _check_se
+000222f0: 7276 6963 655f 7665 7273 696f 6e28 7365  rvice_version(se
+00022300: 7276 6963 655f 6e61 6d65 3a20 7374 722c  rvice_name: str,
+00022310: 2076 6572 7369 6f6e 3a20 7374 7229 202d   version: str) -
+00022320: 3e20 7374 723a 0a20 2020 2023 2047 7265  > str:.    # Gre
+00022330: 7020 7468 6520 6c69 6e65 7320 6265 666f  p the lines befo
+00022340: 7265 2027 5365 7276 6963 6520 5265 706c  re 'Service Repl
+00022350: 6963 6173 2720 616e 6420 6368 6563 6b20  icas' and check 
+00022360: 6966 2074 6865 2073 6572 7669 6365 2076  if the service v
+00022370: 6572 7369 6f6e 0a20 2020 2023 2069 7320  ersion.    # is 
+00022380: 636f 7272 6563 742e 0a20 2020 2072 6574  correct..    ret
+00022390: 7572 6e20 2866 2765 6368 6f20 2224 7322  urn (f'echo "$s"
+000223a0: 207c 2067 7265 7020 2d42 3130 3030 2022   | grep -B1000 "
+000223b0: 5365 7276 6963 6520 5265 706c 6963 6173  Service Replicas
+000223c0: 2220 7c20 270a 2020 2020 2020 2020 2020  " | '.          
+000223d0: 2020 6627 6772 6570 202d 4520 227b 7365    f'grep -E "{se
+000223e0: 7276 6963 655f 6e61 6d65 7d5c 732b 7b76  rvice_name}\s+{v
+000223f0: 6572 7369 6f6e 7d22 207c 7c20 6578 6974  ersion}" || exit
+00022400: 2031 3b20 2729 0a0a 0a40 7079 7465 7374   1; ')...@pytest
+00022410: 2e6d 6172 6b2e 6763 700a 4070 7974 6573  .mark.gcp.@pytes
+00022420: 742e 6d61 726b 2e73 6572 7665 0a64 6566  t.mark.serve.def
+00022430: 2074 6573 745f 736b 7973 6572 7665 5f67   test_skyserve_g
+00022440: 6370 5f68 7474 7028 293a 0a20 2020 2022  cp_http():.    "
+00022450: 2222 5465 7374 2073 6b79 7365 7276 6520  ""Test skyserve 
+00022460: 6f6e 2047 4350 2222 220a 2020 2020 6e61  on GCP""".    na
+00022470: 6d65 203d 205f 6765 745f 7365 7276 6963  me = _get_servic
+00022480: 655f 6e61 6d65 2829 0a20 2020 2074 6573  e_name().    tes
+00022490: 7420 3d20 5f67 6574 5f73 6b79 7365 7276  t = _get_skyserv
+000224a0: 655f 6874 7470 5f74 6573 7428 6e61 6d65  e_http_test(name
+000224b0: 2c20 2767 6370 272c 2032 3029 0a20 2020  , 'gcp', 20).   
+000224c0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+000224d0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+000224e0: 726b 2e61 7773 0a40 7079 7465 7374 2e6d  rk.aws.@pytest.m
+000224f0: 6172 6b2e 7365 7276 650a 6465 6620 7465  ark.serve.def te
+00022500: 7374 5f73 6b79 7365 7276 655f 6177 735f  st_skyserve_aws_
+00022510: 6874 7470 2829 3a0a 2020 2020 2222 2254  http():.    """T
+00022520: 6573 7420 736b 7973 6572 7665 206f 6e20  est skyserve on 
+00022530: 4157 5322 2222 0a20 2020 206e 616d 6520  AWS""".    name 
+00022540: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
+00022550: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+00022560: 205f 6765 745f 736b 7973 6572 7665 5f68   _get_skyserve_h
+00022570: 7474 705f 7465 7374 286e 616d 652c 2027  ttp_test(name, '
+00022580: 6177 7327 2c20 3230 290a 2020 2020 7275  aws', 20).    ru
+00022590: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+000225a0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+000225b0: 617a 7572 650a 4070 7974 6573 742e 6d61  azure.@pytest.ma
+000225c0: 726b 2e73 6572 7665 0a64 6566 2074 6573  rk.serve.def tes
+000225d0: 745f 736b 7973 6572 7665 5f61 7a75 7265  t_skyserve_azure
+000225e0: 5f68 7474 7028 293a 0a20 2020 2022 2222  _http():.    """
+000225f0: 5465 7374 2073 6b79 7365 7276 6520 6f6e  Test skyserve on
+00022600: 2041 7a75 7265 2222 220a 2020 2020 6e61   Azure""".    na
+00022610: 6d65 203d 205f 6765 745f 7365 7276 6963  me = _get_servic
+00022620: 655f 6e61 6d65 2829 0a20 2020 2074 6573  e_name().    tes
+00022630: 7420 3d20 5f67 6574 5f73 6b79 7365 7276  t = _get_skyserv
+00022640: 655f 6874 7470 5f74 6573 7428 6e61 6d65  e_http_test(name
+00022650: 2c20 2761 7a75 7265 272c 2033 3029 0a20  , 'azure', 30). 
+00022660: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00022670: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00022680: 6d61 726b 2e6b 7562 6572 6e65 7465 730a  mark.kubernetes.
+00022690: 4070 7974 6573 742e 6d61 726b 2e73 6572  @pytest.mark.ser
+000226a0: 7665 0a64 6566 2074 6573 745f 736b 7973  ve.def test_skys
+000226b0: 6572 7665 5f6b 7562 6572 6e65 7465 735f  erve_kubernetes_
+000226c0: 6874 7470 2829 3a0a 2020 2020 2222 2254  http():.    """T
+000226d0: 6573 7420 736b 7973 6572 7665 206f 6e20  est skyserve on 
+000226e0: 4b75 6265 726e 6574 6573 2222 220a 2020  Kubernetes""".  
+000226f0: 2020 6e61 6d65 203d 205f 6765 745f 7365    name = _get_se
+00022700: 7276 6963 655f 6e61 6d65 2829 0a20 2020  rvice_name().   
+00022710: 2074 6573 7420 3d20 5f67 6574 5f73 6b79   test = _get_sky
+00022720: 7365 7276 655f 6874 7470 5f74 6573 7428  serve_http_test(
+00022730: 6e61 6d65 2c20 276b 7562 6572 6e65 7465  name, 'kubernete
+00022740: 7327 2c20 3330 290a 2020 2020 7275 6e5f  s', 30).    run_
+00022750: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00022760: 0a40 7079 7465 7374 2e6d 6172 6b2e 7365  .@pytest.mark.se
+00022770: 7276 650a 6465 6620 7465 7374 5f73 6b79  rve.def test_sky
+00022780: 7365 7276 655f 6c6c 6d28 6765 6e65 7269  serve_llm(generi
+00022790: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+000227a0: 2020 2022 2222 5465 7374 2073 6b79 7365     """Test skyse
+000227b0: 7276 6520 7769 7468 2072 6561 6c20 4c4c  rve with real LL
+000227c0: 4d20 7573 6563 6173 6522 2222 0a20 2020  M usecase""".   
+000227d0: 206e 616d 6520 3d20 5f67 6574 5f73 6572   name = _get_ser
+000227e0: 7669 6365 5f6e 616d 6528 290a 0a20 2020  vice_name()..   
+000227f0: 2064 6566 2067 656e 6572 6174 655f 6c6c   def generate_ll
+00022800: 6d5f 7465 7374 5f63 6f6d 6d61 6e64 2870  m_test_command(p
+00022810: 726f 6d70 743a 2073 7472 2c20 6578 7065  rompt: str, expe
+00022820: 6374 6564 5f6f 7574 7075 743a 2073 7472  cted_output: str
+00022830: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
+00022840: 2020 7072 6f6d 7074 203d 2073 686c 6578    prompt = shlex
+00022850: 2e71 756f 7465 2870 726f 6d70 7429 0a20  .quote(prompt). 
+00022860: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
+00022870: 6f75 7470 7574 203d 2073 686c 6578 2e71  output = shlex.q
+00022880: 756f 7465 2865 7870 6563 7465 645f 6f75  uote(expected_ou
+00022890: 7470 7574 290a 2020 2020 2020 2020 7265  tput).        re
+000228a0: 7475 726e 2028 0a20 2020 2020 2020 2020  turn (.         
+000228b0: 2020 2066 277b 5f53 4552 5645 5f45 4e44     f'{_SERVE_END
+000228c0: 504f 494e 545f 5741 4954 2e66 6f72 6d61  POINT_WAIT.forma
+000228d0: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2027  t(name=name)}; '
+000228e0: 0a20 2020 2020 2020 2020 2020 2027 7079  .            'py
+000228f0: 7468 6f6e 2074 6573 7473 2f73 6b79 7365  thon tests/skyse
+00022900: 7276 652f 6c6c 6d2f 6765 745f 7265 7370  rve/llm/get_resp
+00022910: 6f6e 7365 2e70 7920 2d2d 656e 6470 6f69  onse.py --endpoi
+00022920: 6e74 2024 656e 6470 6f69 6e74 2027 0a20  nt $endpoint '. 
+00022930: 2020 2020 2020 2020 2020 2066 272d 2d70             f'--p
+00022940: 726f 6d70 7420 7b70 726f 6d70 747d 207c  rompt {prompt} |
+00022950: 2067 7265 7020 7b65 7870 6563 7465 645f   grep {expected_
+00022960: 6f75 7470 7574 7d27 290a 0a20 2020 2077  output}')..    w
+00022970: 6974 6820 6f70 656e 2827 7465 7374 732f  ith open('tests/
+00022980: 736b 7973 6572 7665 2f6c 6c6d 2f70 726f  skyserve/llm/pro
+00022990: 6d70 745f 6f75 7470 7574 2e6a 736f 6e27  mpt_output.json'
+000229a0: 2c20 2772 272c 0a20 2020 2020 2020 2020  , 'r',.         
+000229b0: 2020 2020 2065 6e63 6f64 696e 673d 2775       encoding='u
+000229c0: 7466 2d38 2729 2061 7320 663a 0a20 2020  tf-8') as f:.   
+000229d0: 2020 2020 2070 726f 6d70 7432 6f75 7470       prompt2outp
+000229e0: 7574 203d 206a 736f 6e2e 6c6f 6164 2866  ut = json.load(f
+000229f0: 290a 0a20 2020 2074 6573 7420 3d20 5465  )..    test = Te
+00022a00: 7374 280a 2020 2020 2020 2020 6627 7465  st(.        f'te
+00022a10: 7374 2d73 6b79 7365 7276 652d 6c6c 6d27  st-skyserve-llm'
+00022a20: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00022a30: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
+00022a40: 7276 6520 7570 202d 6e20 7b6e 616d 657d  rve up -n {name}
+00022a50: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+00022a60: 635f 636c 6f75 647d 202d 7920 7465 7374  c_cloud} -y test
+00022a70: 732f 736b 7973 6572 7665 2f6c 6c6d 2f73  s/skyserve/llm/s
+00022a80: 6572 7669 6365 2e79 616d 6c27 2c0a 2020  ervice.yaml',.  
+00022a90: 2020 2020 2020 2020 2020 5f53 4552 5645            _SERVE
+00022aa0: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
+00022ab0: 592e 666f 726d 6174 286e 616d 653d 6e61  Y.format(name=na
+00022ac0: 6d65 2c20 7265 706c 6963 615f 6e75 6d3d  me, replica_num=
+00022ad0: 3129 2c0a 2020 2020 2020 2020 2020 2020  1),.            
+00022ae0: 2a5b 0a20 2020 2020 2020 2020 2020 2020  *[.             
+00022af0: 2020 2067 656e 6572 6174 655f 6c6c 6d5f     generate_llm_
+00022b00: 7465 7374 5f63 6f6d 6d61 6e64 2870 726f  test_command(pro
+00022b10: 6d70 742c 206f 7574 7075 7429 0a20 2020  mpt, output).   
+00022b20: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00022b30: 2070 726f 6d70 742c 206f 7574 7075 7420   prompt, output 
+00022b40: 696e 2070 726f 6d70 7432 6f75 7470 7574  in prompt2output
+00022b50: 2e69 7465 6d73 2829 0a20 2020 2020 2020  .items().       
+00022b60: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00022b70: 5d2c 0a20 2020 2020 2020 205f 5445 4152  ],.        _TEAR
+00022b80: 444f 574e 5f53 4552 5649 4345 2e66 6f72  DOWN_SERVICE.for
+00022b90: 6d61 7428 6e61 6d65 3d6e 616d 6529 2c0a  mat(name=name),.
+00022ba0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00022bb0: 3430 202a 2036 302c 0a20 2020 2029 0a20  40 * 60,.    ). 
+00022bc0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00022bd0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00022be0: 6d61 726b 2e67 6370 0a40 7079 7465 7374  mark.gcp.@pytest
+00022bf0: 2e6d 6172 6b2e 7365 7276 650a 6465 6620  .mark.serve.def 
+00022c00: 7465 7374 5f73 6b79 7365 7276 655f 7370  test_skyserve_sp
+00022c10: 6f74 5f72 6563 6f76 6572 7928 293a 0a20  ot_recovery():. 
+00022c20: 2020 206e 616d 6520 3d20 5f67 6574 5f73     name = _get_s
+00022c30: 6572 7669 6365 5f6e 616d 6528 290a 2020  ervice_name().  
+00022c40: 2020 7a6f 6e65 203d 2027 7573 2d63 656e    zone = 'us-cen
+00022c50: 7472 616c 312d 6127 0a0a 2020 2020 7465  tral1-a'..    te
+00022c60: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00022c70: 2020 2066 2774 6573 742d 736b 7973 6572     f'test-skyser
+00022c80: 7665 2d73 706f 742d 7265 636f 7665 7279  ve-spot-recovery
+00022c90: 2d67 6370 272c 0a20 2020 2020 2020 205b  -gcp',.        [
+00022ca0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00022cb0: 6b79 2073 6572 7665 2075 7020 2d6e 207b  ky serve up -n {
+00022cc0: 6e61 6d65 7d20 2d79 2074 6573 7473 2f73  name} -y tests/s
+00022cd0: 6b79 7365 7276 652f 7370 6f74 2f72 6563  kyserve/spot/rec
+00022ce0: 6f76 6572 792e 7961 6d6c 272c 0a20 2020  overy.yaml',.   
+00022cf0: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
+00022d00: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
+00022d10: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00022d20: 652c 2072 6570 6c69 6361 5f6e 756d 3d31  e, replica_num=1
+00022d30: 292c 0a20 2020 2020 2020 2020 2020 2066  ),.            f
+00022d40: 277b 5f53 4552 5645 5f45 4e44 504f 494e  '{_SERVE_ENDPOIN
+00022d50: 545f 5741 4954 2e66 6f72 6d61 7428 6e61  T_WAIT.format(na
+00022d60: 6d65 3d6e 616d 6529 7d3b 2027 0a20 2020  me=name)}; '.   
+00022d70: 2020 2020 2020 2020 2027 7265 7175 6573           'reques
+00022d80: 745f 6f75 7470 7574 3d24 2863 7572 6c20  t_output=$(curl 
+00022d90: 2d4c 2068 7474 703a 2f2f 2465 6e64 706f  -L http://$endpo
+00022da0: 696e 7429 3b20 6563 686f 2022 2472 6571  int); echo "$req
+00022db0: 7565 7374 5f6f 7574 7075 7422 3b20 6563  uest_output"; ec
+00022dc0: 686f 2022 2472 6571 7565 7374 5f6f 7574  ho "$request_out
+00022dd0: 7075 7422 207c 2067 7265 7020 2248 692c  put" | grep "Hi,
+00022de0: 2053 6b79 5069 6c6f 7420 6865 7265 2227   SkyPilot here"'
+00022df0: 2c0a 2020 2020 2020 2020 2020 2020 5f74  ,.            _t
+00022e00: 6572 6d69 6e61 7465 5f67 6370 5f72 6570  erminate_gcp_rep
+00022e10: 6c69 6361 286e 616d 652c 207a 6f6e 652c  lica(name, zone,
+00022e20: 2031 292c 0a20 2020 2020 2020 2020 2020   1),.           
+00022e30: 205f 5345 5256 455f 5741 4954 5f55 4e54   _SERVE_WAIT_UNT
+00022e40: 494c 5f52 4541 4459 2e66 6f72 6d61 7428  IL_READY.format(
+00022e50: 6e61 6d65 3d6e 616d 652c 2072 6570 6c69  name=name, repli
+00022e60: 6361 5f6e 756d 3d31 292c 0a20 2020 2020  ca_num=1),.     
+00022e70: 2020 2020 2020 2066 277b 5f53 4552 5645         f'{_SERVE
+00022e80: 5f45 4e44 504f 494e 545f 5741 4954 2e66  _ENDPOINT_WAIT.f
+00022e90: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+00022ea0: 7d3b 2027 0a20 2020 2020 2020 2020 2020  }; '.           
+00022eb0: 2027 7265 7175 6573 745f 6f75 7470 7574   'request_output
+00022ec0: 3d24 2863 7572 6c20 2d4c 2068 7474 703a  =$(curl -L http:
+00022ed0: 2f2f 2465 6e64 706f 696e 7429 3b20 6563  //$endpoint); ec
+00022ee0: 686f 2022 2472 6571 7565 7374 5f6f 7574  ho "$request_out
+00022ef0: 7075 7422 3b20 6563 686f 2022 2472 6571  put"; echo "$req
+00022f00: 7565 7374 5f6f 7574 7075 7422 207c 2067  uest_output" | g
+00022f10: 7265 7020 2248 692c 2053 6b79 5069 6c6f  rep "Hi, SkyPilo
+00022f20: 7420 6865 7265 2227 2c0a 2020 2020 2020  t here"',.      
+00022f30: 2020 5d2c 0a20 2020 2020 2020 205f 5445    ],.        _TE
+00022f40: 4152 444f 574e 5f53 4552 5649 4345 2e66  ARDOWN_SERVICE.f
+00022f50: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+00022f60: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+00022f70: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
+00022f80: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00022f90: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00022fa0: 742e 6d61 726b 2e73 6572 7665 0a40 7079  t.mark.serve.@py
+00022fb0: 7465 7374 2e6d 6172 6b2e 6e6f 5f6b 7562  test.mark.no_kub
+00022fc0: 6572 6e65 7465 730a 6465 6620 7465 7374  ernetes.def test
+00022fd0: 5f73 6b79 7365 7276 655f 6261 7365 5f6f  _skyserve_base_o
+00022fe0: 6e64 656d 616e 645f 6661 6c6c 6261 636b  ndemand_fallback
+00022ff0: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
+00023000: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
+00023010: 205f 6765 745f 7365 7276 6963 655f 6e61   _get_service_na
+00023020: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00023030: 5465 7374 280a 2020 2020 2020 2020 6627  Test(.        f'
+00023040: 7465 7374 2d73 6b79 7365 7276 652d 6261  test-skyserve-ba
+00023050: 7365 2d6f 6e64 656d 616e 642d 6661 6c6c  se-ondemand-fall
+00023060: 6261 636b 272c 0a20 2020 2020 2020 205b  back',.        [
+00023070: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00023080: 6b79 2073 6572 7665 2075 7020 2d6e 207b  ky serve up -n {
+00023090: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+000230a0: 656e 6572 6963 5f63 6c6f 7564 7d20 2d79  eneric_cloud} -y
+000230b0: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
+000230c0: 7370 6f74 2f62 6173 655f 6f6e 6465 6d61  spot/base_ondema
+000230d0: 6e64 5f66 616c 6c62 6163 6b2e 7961 6d6c  nd_fallback.yaml
+000230e0: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
+000230f0: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
+00023100: 5f52 4541 4459 2e66 6f72 6d61 7428 6e61  _READY.format(na
+00023110: 6d65 3d6e 616d 652c 2072 6570 6c69 6361  me=name, replica
+00023120: 5f6e 756d 3d32 292c 0a20 2020 2020 2020  _num=2),.       
+00023130: 2020 2020 205f 6368 6563 6b5f 7265 706c       _check_repl
+00023140: 6963 615f 696e 5f73 7461 7475 7328 6e61  ica_in_status(na
+00023150: 6d65 2c20 5b28 312c 2054 7275 652c 2027  me, [(1, True, '
+00023160: 5245 4144 5927 292c 0a20 2020 2020 2020  READY'),.       
+00023170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023190: 2020 2020 2028 312c 2046 616c 7365 2c20       (1, False, 
+000231a0: 2752 4541 4459 2729 5d29 2c0a 2020 2020  'READY')]),.    
+000231b0: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
+000231c0: 5445 4152 444f 574e 5f53 4552 5649 4345  TEARDOWN_SERVICE
+000231d0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+000231e0: 6529 2c0a 2020 2020 2020 2020 7469 6d65  e),.        time
+000231f0: 6f75 743d 3230 202a 2036 302c 0a20 2020  out=20 * 60,.   
+00023200: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00023210: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+00023220: 6573 742e 6d61 726b 2e67 6370 0a40 7079  est.mark.gcp.@py
+00023230: 7465 7374 2e6d 6172 6b2e 7365 7276 650a  test.mark.serve.
+00023240: 6465 6620 7465 7374 5f73 6b79 7365 7276  def test_skyserv
+00023250: 655f 6479 6e61 6d69 635f 6f6e 6465 6d61  e_dynamic_ondema
+00023260: 6e64 5f66 616c 6c62 6163 6b28 293a 0a20  nd_fallback():. 
+00023270: 2020 206e 616d 6520 3d20 5f67 6574 5f73     name = _get_s
+00023280: 6572 7669 6365 5f6e 616d 6528 290a 2020  ervice_name().  
+00023290: 2020 7a6f 6e65 203d 2027 7573 2d63 656e    zone = 'us-cen
+000232a0: 7472 616c 312d 6127 0a0a 2020 2020 7465  tral1-a'..    te
+000232b0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+000232c0: 2020 2066 2774 6573 742d 736b 7973 6572     f'test-skyser
+000232d0: 7665 2d64 796e 616d 6963 2d6f 6e64 656d  ve-dynamic-ondem
+000232e0: 616e 642d 6661 6c6c 6261 636b 272c 0a20  and-fallback',. 
+000232f0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00023300: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
+00023310: 2075 7020 2d6e 207b 6e61 6d65 7d20 2d2d   up -n {name} --
+00023320: 636c 6f75 6420 6763 7020 2d79 2074 6573  cloud gcp -y tes
+00023330: 7473 2f73 6b79 7365 7276 652f 7370 6f74  ts/skyserve/spot
+00023340: 2f64 796e 616d 6963 5f6f 6e64 656d 616e  /dynamic_ondeman
+00023350: 645f 6661 6c6c 6261 636b 2e79 616d 6c27  d_fallback.yaml'
+00023360: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00023370: 736c 6565 7020 3430 272c 0a20 2020 2020  sleep 40',.     
+00023380: 2020 2020 2020 2023 2032 206f 6e2d 6465         # 2 on-de
+00023390: 6d61 6e64 2028 7072 6f76 6973 696f 6e69  mand (provisioni
+000233a0: 6e67 2920 2b20 3220 5370 6f74 2028 7072  ng) + 2 Spot (pr
+000233b0: 6f76 6973 696f 6e69 6e67 292e 0a20 2020  ovisioning)..   
+000233c0: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
+000233d0: 5645 5f53 5441 5455 535f 5741 4954 2e66  VE_STATUS_WAIT.f
+000233e0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+000233f0: 7d3b 2065 6368 6f20 2224 7322 3b27 0a20  }; echo "$s";'. 
+00023400: 2020 2020 2020 2020 2020 2027 6563 686f             'echo
+00023410: 2022 2473 2220 7c20 6772 6570 202d 7120   "$s" | grep -q 
+00023420: 2230 2f34 2220 7c7c 2065 7869 7420 3127  "0/4" || exit 1'
+00023430: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00023440: 5761 6974 2066 6f72 2074 6865 2070 726f  Wait for the pro
+00023450: 7669 7369 6f6e 696e 6720 7374 6172 7473  visioning starts
+00023460: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00023470: 6c65 6570 2034 3027 2c0a 2020 2020 2020  leep 40',.      
+00023480: 2020 2020 2020 5f63 6865 636b 5f72 6570        _check_rep
+00023490: 6c69 6361 5f69 6e5f 7374 6174 7573 286e  lica_in_status(n
+000234a0: 616d 652c 205b 0a20 2020 2020 2020 2020  ame, [.         
+000234b0: 2020 2020 2020 2028 322c 2054 7275 652c         (2, True,
+000234c0: 205f 5345 5256 4943 455f 4c41 554e 4348   _SERVICE_LAUNCH
+000234d0: 494e 475f 5354 4154 5553 5f52 4547 4558  ING_STATUS_REGEX
+000234e0: 202b 2027 5c7c 5245 4144 5927 292c 0a20   + '\|READY'),. 
+000234f0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00023500: 322c 2046 616c 7365 2c20 5f53 4552 5649  2, False, _SERVI
+00023510: 4345 5f4c 4155 4e43 4849 4e47 5f53 5441  CE_LAUNCHING_STA
+00023520: 5455 535f 5245 4745 5820 2b20 275c 7c53  TUS_REGEX + '\|S
+00023530: 4855 5454 494e 475f 444f 574e 2729 0a20  HUTTING_DOWN'). 
+00023540: 2020 2020 2020 2020 2020 205d 292c 0a0a             ]),..
+00023550: 2020 2020 2020 2020 2020 2020 2320 5761              # Wa
+00023560: 6974 2075 6e74 696c 2032 2073 706f 7420  it until 2 spot 
+00023570: 696e 7374 616e 6365 7320 6172 6520 7265  instances are re
+00023580: 6164 792e 0a20 2020 2020 2020 2020 2020  ady..           
+00023590: 205f 5345 5256 455f 5741 4954 5f55 4e54   _SERVE_WAIT_UNT
+000235a0: 494c 5f52 4541 4459 2e66 6f72 6d61 7428  IL_READY.format(
+000235b0: 6e61 6d65 3d6e 616d 652c 2072 6570 6c69  name=name, repli
+000235c0: 6361 5f6e 756d 3d32 292c 0a20 2020 2020  ca_num=2),.     
+000235d0: 2020 2020 2020 205f 6368 6563 6b5f 7265         _check_re
+000235e0: 706c 6963 615f 696e 5f73 7461 7475 7328  plica_in_status(
+000235f0: 6e61 6d65 2c20 5b28 322c 2054 7275 652c  name, [(2, True,
+00023600: 2027 5245 4144 5927 292c 0a20 2020 2020   'READY'),.     
 00023610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023620: 2028 302c 2046 616c 7365 2c20 2727 295d   (0, False, '')]
-00023630: 292c 0a20 2020 2020 2020 2020 2020 205f  ),.            _
-00023640: 7465 726d 696e 6174 655f 6763 705f 7265  terminate_gcp_re
-00023650: 706c 6963 6128 6e61 6d65 2c20 7a6f 6e65  plica(name, zone
-00023660: 2c20 3129 2c0a 2020 2020 2020 2020 2020  , 1),.          
-00023670: 2020 6627 736c 6565 7020 3430 272c 0a20    f'sleep 40',. 
-00023680: 2020 2020 2020 2020 2020 2023 2031 206f             # 1 o
-00023690: 6e2d 6465 6d61 6e64 2028 7072 6f76 6973  n-demand (provis
-000236a0: 696f 6e69 6e67 2920 2b20 3120 5370 6f74  ioning) + 1 Spot
-000236b0: 2028 7265 6164 7929 202b 2031 2073 706f   (ready) + 1 spo
-000236c0: 7420 2870 726f 7669 7369 6f6e 696e 6729  t (provisioning)
-000236d0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-000236e0: 7b5f 5345 5256 455f 5354 4154 5553 5f57  {_SERVE_STATUS_W
-000236f0: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
-00023700: 6e61 6d65 297d 3b20 270a 2020 2020 2020  name)}; '.      
-00023710: 2020 2020 2020 2765 6368 6f20 2224 7322        'echo "$s"
-00023720: 207c 2067 7265 7020 2d71 2022 312f 3322   | grep -q "1/3"
-00023730: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
-00023740: 6368 6563 6b5f 7265 706c 6963 615f 696e  check_replica_in
-00023750: 5f73 7461 7475 7328 0a20 2020 2020 2020  _status(.       
-00023760: 2020 2020 2020 2020 206e 616d 652c 205b           name, [
-00023770: 2831 2c20 5472 7565 2c20 2752 4541 4459  (1, True, 'READY
-00023780: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-00023790: 2020 2020 2020 2020 2020 2028 312c 2054             (1, T
-000237a0: 7275 652c 205f 5345 5256 4943 455f 4c41  rue, _SERVICE_LA
-000237b0: 554e 4348 494e 475f 5354 4154 5553 5f52  UNCHING_STATUS_R
-000237c0: 4547 4558 292c 0a20 2020 2020 2020 2020  EGEX),.         
-000237d0: 2020 2020 2020 2020 2020 2020 2020 2831                (1
-000237e0: 2c20 4661 6c73 652c 205f 5345 5256 4943  , False, _SERVIC
-000237f0: 455f 4c41 554e 4348 494e 475f 5354 4154  E_LAUNCHING_STAT
-00023800: 5553 5f52 4547 4558 295d 292c 0a0a 2020  US_REGEX)]),..  
-00023810: 2020 2020 2020 2020 2020 2320 5761 6974            # Wait
-00023820: 2075 6e74 696c 2032 2073 706f 7420 696e   until 2 spot in
-00023830: 7374 616e 6365 7320 6172 6520 7265 6164  stances are read
-00023840: 792e 0a20 2020 2020 2020 2020 2020 205f  y..            _
-00023850: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
-00023860: 5f52 4541 4459 2e66 6f72 6d61 7428 6e61  _READY.format(na
-00023870: 6d65 3d6e 616d 652c 2072 6570 6c69 6361  me=name, replica
-00023880: 5f6e 756d 3d32 292c 0a20 2020 2020 2020  _num=2),.       
-00023890: 2020 2020 205f 6368 6563 6b5f 7265 706c       _check_repl
-000238a0: 6963 615f 696e 5f73 7461 7475 7328 6e61  ica_in_status(na
-000238b0: 6d65 2c20 5b28 322c 2054 7275 652c 2027  me, [(2, True, '
-000238c0: 5245 4144 5927 292c 0a20 2020 2020 2020  READY'),.       
-000238d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023630: 2020 2020 2020 2028 302c 2046 616c 7365         (0, False
+00023640: 2c20 2727 295d 292c 0a20 2020 2020 2020  , '')]),.       
+00023650: 2020 2020 205f 7465 726d 696e 6174 655f       _terminate_
+00023660: 6763 705f 7265 706c 6963 6128 6e61 6d65  gcp_replica(name
+00023670: 2c20 7a6f 6e65 2c20 3129 2c0a 2020 2020  , zone, 1),.    
+00023680: 2020 2020 2020 2020 6627 736c 6565 7020          f'sleep 
+00023690: 3430 272c 0a20 2020 2020 2020 2020 2020  40',.           
+000236a0: 2023 2031 206f 6e2d 6465 6d61 6e64 2028   # 1 on-demand (
+000236b0: 7072 6f76 6973 696f 6e69 6e67 2920 2b20  provisioning) + 
+000236c0: 3120 5370 6f74 2028 7265 6164 7929 202b  1 Spot (ready) +
+000236d0: 2031 2073 706f 7420 2870 726f 7669 7369   1 spot (provisi
+000236e0: 6f6e 696e 6729 2e0a 2020 2020 2020 2020  oning)..        
+000236f0: 2020 2020 6627 7b5f 5345 5256 455f 5354      f'{_SERVE_ST
+00023700: 4154 5553 5f57 4149 542e 666f 726d 6174  ATUS_WAIT.format
+00023710: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
+00023720: 2020 2020 2020 2020 2020 2020 2765 6368              'ech
+00023730: 6f20 2224 7322 207c 2067 7265 7020 2d71  o "$s" | grep -q
+00023740: 2022 312f 3322 272c 0a20 2020 2020 2020   "1/3"',.       
+00023750: 2020 2020 205f 6368 6563 6b5f 7265 706c       _check_repl
+00023760: 6963 615f 696e 5f73 7461 7475 7328 0a20  ica_in_status(. 
+00023770: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00023780: 616d 652c 205b 2831 2c20 5472 7565 2c20  ame, [(1, True, 
+00023790: 2752 4541 4459 2729 2c0a 2020 2020 2020  'READY'),.      
+000237a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000237b0: 2028 312c 2054 7275 652c 205f 5345 5256   (1, True, _SERV
+000237c0: 4943 455f 4c41 554e 4348 494e 475f 5354  ICE_LAUNCHING_ST
+000237d0: 4154 5553 5f52 4547 4558 292c 0a20 2020  ATUS_REGEX),.   
+000237e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000237f0: 2020 2020 2831 2c20 4661 6c73 652c 205f      (1, False, _
+00023800: 5345 5256 4943 455f 4c41 554e 4348 494e  SERVICE_LAUNCHIN
+00023810: 475f 5354 4154 5553 5f52 4547 4558 295d  G_STATUS_REGEX)]
+00023820: 292c 0a0a 2020 2020 2020 2020 2020 2020  ),..            
+00023830: 2320 5761 6974 2075 6e74 696c 2032 2073  # Wait until 2 s
+00023840: 706f 7420 696e 7374 616e 6365 7320 6172  pot instances ar
+00023850: 6520 7265 6164 792e 0a20 2020 2020 2020  e ready..       
+00023860: 2020 2020 205f 5345 5256 455f 5741 4954       _SERVE_WAIT
+00023870: 5f55 4e54 494c 5f52 4541 4459 2e66 6f72  _UNTIL_READY.for
+00023880: 6d61 7428 6e61 6d65 3d6e 616d 652c 2072  mat(name=name, r
+00023890: 6570 6c69 6361 5f6e 756d 3d32 292c 0a20  eplica_num=2),. 
+000238a0: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
+000238b0: 6b5f 7265 706c 6963 615f 696e 5f73 7461  k_replica_in_sta
+000238c0: 7475 7328 6e61 6d65 2c20 5b28 322c 2054  tus(name, [(2, T
+000238d0: 7275 652c 2027 5245 4144 5927 292c 0a20  rue, 'READY'),. 
 000238e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000238f0: 2020 2020 2028 302c 2046 616c 7365 2c20       (0, False, 
-00023900: 2727 295d 292c 0a20 2020 2020 2020 205d  '')]),.        ]
-00023910: 2c0a 2020 2020 2020 2020 5f54 4541 5244  ,.        _TEARD
-00023920: 4f57 4e5f 5345 5256 4943 452e 666f 726d  OWN_SERVICE.form
-00023930: 6174 286e 616d 653d 6e61 6d65 292c 0a20  at(name=name),. 
-00023940: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
-00023950: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
-00023960: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00023970: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-00023980: 6172 6b2e 7365 7276 650a 6465 6620 7465  ark.serve.def te
-00023990: 7374 5f73 6b79 7365 7276 655f 7573 6572  st_skyserve_user
-000239a0: 5f62 7567 5f72 6573 7461 7274 2867 656e  _bug_restart(gen
-000239b0: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-000239c0: 3a0a 2020 2020 2222 2254 6573 7473 2074  :.    """Tests t
-000239d0: 6861 7420 7765 2072 6573 7461 7274 2074  hat we restart t
-000239e0: 6865 2073 6572 7669 6365 2061 6674 6572  he service after
-000239f0: 2075 7365 7220 6275 672e 2222 220a 2020   user bug.""".  
-00023a00: 2020 2320 544f 444f 287a 6877 7529 3a20    # TODO(zhwu): 
-00023a10: 7468 6973 2062 6568 6176 696f 7220 6e65  this behavior ne
-00023a20: 6564 7320 736f 6d65 2072 6574 6869 6e6b  eds some rethink
-00023a30: 696e 672e 0a20 2020 206e 616d 6520 3d20  ing..    name = 
-00023a40: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
-00023a50: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00023a60: 6573 7428 0a20 2020 2020 2020 2066 2774  est(.        f't
-00023a70: 6573 742d 736b 7973 6572 7665 2d75 7365  est-skyserve-use
-00023a80: 722d 6275 672d 7265 7374 6172 7427 2c0a  r-bug-restart',.
-00023a90: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00023aa0: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
-00023ab0: 6520 7570 202d 6e20 7b6e 616d 657d 202d  e up -n {name} -
-00023ac0: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-00023ad0: 636c 6f75 647d 202d 7920 7465 7374 732f  cloud} -y tests/
-00023ae0: 736b 7973 6572 7665 2f72 6573 7461 7274  skyserve/restart
-00023af0: 2f75 7365 725f 6275 672e 7961 6d6c 272c  /user_bug.yaml',
-00023b00: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00023b10: 3d24 2873 6b79 2073 6572 7665 2073 7461  =$(sky serve sta
-00023b20: 7475 7320 7b6e 616d 657d 293b 2065 6368  tus {name}); ech
-00023b30: 6f20 2224 7322 3b27 0a20 2020 2020 2020  o "$s";'.       
-00023b40: 2020 2020 2027 756e 7469 6c20 6563 686f       'until echo
-00023b50: 2022 2473 2220 7c20 6772 6570 202d 4120   "$s" | grep -A 
-00023b60: 3130 3020 2253 6572 7669 6365 2052 6570  100 "Service Rep
-00023b70: 6c69 6361 7322 207c 2067 7265 7020 2253  licas" | grep "S
-00023b80: 4855 5454 494e 475f 444f 574e 223b 2027  HUTTING_DOWN"; '
-00023b90: 0a20 2020 2020 2020 2020 2020 2027 646f  .            'do
-00023ba0: 2065 6368 6f20 2257 6169 7469 6e67 2066   echo "Waiting f
-00023bb0: 6f72 2066 6972 7374 2073 6572 7669 6365  or first service
-00023bc0: 2074 6f20 6265 2053 4855 5454 494e 4720   to be SHUTTING 
-00023bd0: 444f 574e 2e2e 2e22 3b20 270a 2020 2020  DOWN..."; '.    
-00023be0: 2020 2020 2020 2020 6627 736c 6565 7020          f'sleep 
-00023bf0: 353b 2073 3d24 2873 6b79 2073 6572 7665  5; s=$(sky serve
-00023c00: 2073 7461 7475 7320 7b6e 616d 657d 293b   status {name});
-00023c10: 2065 6368 6f20 2224 7322 3b20 646f 6e65   echo "$s"; done
-00023c20: 3b20 272c 0a20 2020 2020 2020 2020 2020  ; ',.           
-00023c30: 2066 2773 3d24 2873 6b79 2073 6572 7665   f's=$(sky serve
-00023c40: 2073 7461 7475 7320 7b6e 616d 657d 293b   status {name});
-00023c50: 2065 6368 6f20 2224 7322 3b27 0a20 2020   echo "$s";'.   
-00023c60: 2020 2020 2020 2020 2027 756e 7469 6c20           'until 
-00023c70: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-00023c80: 202d 4120 3130 3020 2253 6572 7669 6365   -A 100 "Service
-00023c90: 2052 6570 6c69 6361 7322 207c 2067 7265   Replicas" | gre
-00023ca0: 7020 2246 4149 4c45 4422 3b20 270a 2020  p "FAILED"; '.  
-00023cb0: 2020 2020 2020 2020 2020 2764 6f20 6563            'do ec
-00023cc0: 686f 2022 5761 6974 696e 6720 666f 7220  ho "Waiting for 
-00023cd0: 6669 7273 7420 7365 7276 6963 6520 746f  first service to
-00023ce0: 2062 6520 4641 494c 4544 2e2e 2e22 3b20   be FAILED..."; 
-00023cf0: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
-00023d00: 736c 6565 7020 353b 2073 3d24 2873 6b79  sleep 5; s=$(sky
-00023d10: 2073 6572 7665 2073 7461 7475 7320 7b6e   serve status {n
-00023d20: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
-00023d30: 3b20 646f 6e65 3b20 6563 686f 2022 2473  ; done; echo "$s
-00023d40: 223b 2027 0a20 2020 2020 2020 2020 2020  "; '.           
-00023d50: 202b 205f 6368 6563 6b5f 7265 706c 6963   + _check_replic
-00023d60: 615f 696e 5f73 7461 7475 7328 6e61 6d65  a_in_status(name
-00023d70: 2c20 5b28 312c 2054 7275 652c 2027 4641  , [(1, True, 'FA
-00023d80: 494c 4544 2729 5d29 202b 0a20 2020 2020  ILED')]) +.     
-00023d90: 2020 2020 2020 2023 2055 7365 7220 6275         # User bu
-00023da0: 6720 6661 696c 7572 6520 7769 6c6c 2063  g failure will c
-00023db0: 6175 7365 206e 6f20 6675 7274 6865 7220  ause no further 
-00023dc0: 7363 616c 696e 672e 0a20 2020 2020 2020  scaling..       
-00023dd0: 2020 2020 2066 2765 6368 6f20 2224 7322       f'echo "$s"
-00023de0: 207c 2067 7265 7020 2d41 2031 3030 2022   | grep -A 100 "
-00023df0: 5365 7276 6963 6520 5265 706c 6963 6173  Service Replicas
-00023e00: 2220 7c20 6772 6570 2022 7b6e 616d 657d  " | grep "{name}
-00023e10: 2220 7c20 7763 202d 6c20 7c20 6772 6570  " | wc -l | grep
-00023e20: 2031 3b20 270a 2020 2020 2020 2020 2020   1; '.          
-00023e30: 2020 6627 6563 686f 2022 2473 2220 7c20    f'echo "$s" | 
-00023e40: 6772 6570 202d 4220 3130 3020 224e 4f5f  grep -B 100 "NO_
-00023e50: 5245 504c 4943 4122 207c 2067 7265 7020  REPLICA" | grep 
-00023e60: 2230 2f30 2227 2c0a 2020 2020 2020 2020  "0/0"',.        
-00023e70: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
-00023e80: 7570 6461 7465 207b 6e61 6d65 7d20 2d2d  update {name} --
-00023e90: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-00023ea0: 6c6f 7564 7d20 2d79 2074 6573 7473 2f73  loud} -y tests/s
-00023eb0: 6b79 7365 7276 652f 6175 746f 5f72 6573  kyserve/auto_res
-00023ec0: 7461 7274 2e79 616d 6c27 2c0a 2020 2020  tart.yaml',.    
-00023ed0: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
-00023ee0: 455f 454e 4450 4f49 4e54 5f57 4149 542e  E_ENDPOINT_WAIT.
-00023ef0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-00023f00: 297d 3b20 270a 2020 2020 2020 2020 2020  )}; '.          
-00023f10: 2020 2775 6e74 696c 2063 7572 6c20 2d4c    'until curl -L
-00023f20: 2068 7474 703a 2f2f 2465 6e64 706f 696e   http://$endpoin
-00023f30: 7420 7c20 6772 6570 2022 4869 2c20 536b  t | grep "Hi, Sk
-00023f40: 7950 696c 6f74 2068 6572 6521 223b 2064  yPilot here!"; d
-00023f50: 6f20 736c 6565 7020 323b 2064 6f6e 653b  o sleep 2; done;
-00023f60: 2073 6c65 6570 2032 3b20 270a 2020 2020   sleep 2; '.    
-00023f70: 2020 2020 2020 2020 2b20 5f63 6865 636b          + _check
-00023f80: 5f72 6570 6c69 6361 5f69 6e5f 7374 6174  _replica_in_stat
-00023f90: 7573 286e 616d 652c 205b 2831 2c20 4661  us(name, [(1, Fa
-00023fa0: 6c73 652c 2027 5245 4144 5927 292c 0a20  lse, 'READY'),. 
-00023fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023fd0: 2020 2020 2020 2020 2020 2020 2028 312c               (1,
-00023fe0: 2046 616c 7365 2c20 2746 4149 4c45 4427   False, 'FAILED'
-00023ff0: 295d 292c 0a20 2020 2020 2020 205d 2c0a  )]),.        ],.
-00024000: 2020 2020 2020 2020 5f54 4541 5244 4f57          _TEARDOW
-00024010: 4e5f 5345 5256 4943 452e 666f 726d 6174  N_SERVICE.format
-00024020: 286e 616d 653d 6e61 6d65 292c 0a20 2020  (name=name),.   
-00024030: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
-00024040: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
-00024050: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00024060: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00024070: 6b2e 7365 7276 650a 4070 7974 6573 742e  k.serve.@pytest.
-00024080: 6d61 726b 2e6e 6f5f 6b75 6265 726e 6574  mark.no_kubernet
-00024090: 6573 2020 2320 5265 706c 6963 6173 206f  es  # Replicas o
-000240a0: 6e20 6b38 7320 6d61 7920 6265 2072 756e  n k8s may be run
-000240b0: 6e69 6e67 206f 6e20 7468 6520 7361 6d65  ning on the same
-000240c0: 206e 6f64 6520 616e 6420 6861 7665 2074   node and have t
-000240d0: 6865 2073 616d 6520 7075 626c 6963 2049  he same public I
-000240e0: 500a 6465 6620 7465 7374 5f73 6b79 7365  P.def test_skyse
-000240f0: 7276 655f 6c6f 6164 5f62 616c 616e 6365  rve_load_balance
-00024100: 7228 6765 6e65 7269 635f 636c 6f75 643a  r(generic_cloud:
-00024110: 2073 7472 293a 0a20 2020 2022 2222 5465   str):.    """Te
-00024120: 7374 2073 6b79 7365 7276 6520 6c6f 6164  st skyserve load
-00024130: 2062 616c 616e 6365 7220 726f 756e 642d   balancer round-
-00024140: 726f 6269 6e20 706f 6c69 6379 2222 220a  robin policy""".
-00024150: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00024160: 7365 7276 6963 655f 6e61 6d65 2829 0a20  service_name(). 
-00024170: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00024180: 2020 2020 2020 2020 6627 7465 7374 2d73          f'test-s
-00024190: 6b79 7365 7276 652d 6c6f 6164 2d62 616c  kyserve-load-bal
-000241a0: 616e 6365 7227 2c0a 2020 2020 2020 2020  ancer',.        
-000241b0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-000241c0: 736b 7920 7365 7276 6520 7570 202d 6e20  sky serve up -n 
-000241d0: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
-000241e0: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
-000241f0: 7920 7465 7374 732f 736b 7973 6572 7665  y tests/skyserve
-00024200: 2f6c 6f61 645f 6261 6c61 6e63 6572 2f73  /load_balancer/s
-00024210: 6572 7669 6365 2e79 616d 6c27 2c0a 2020  ervice.yaml',.  
-00024220: 2020 2020 2020 2020 2020 5f53 4552 5645            _SERVE
-00024230: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
-00024240: 592e 666f 726d 6174 286e 616d 653d 6e61  Y.format(name=na
-00024250: 6d65 2c20 7265 706c 6963 615f 6e75 6d3d  me, replica_num=
-00024260: 3329 2c0a 2020 2020 2020 2020 2020 2020  3),.            
-00024270: 6627 7b5f 5345 5256 455f 454e 4450 4f49  f'{_SERVE_ENDPOI
-00024280: 4e54 5f57 4149 542e 666f 726d 6174 286e  NT_WAIT.format(n
-00024290: 616d 653d 6e61 6d65 297d 3b20 270a 2020  ame=name)}; '.  
-000242a0: 2020 2020 2020 2020 2020 6627 7b5f 5345            f'{_SE
-000242b0: 5256 455f 5354 4154 5553 5f57 4149 542e  RVE_STATUS_WAIT.
-000242c0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-000242d0: 297d 3b20 270a 2020 2020 2020 2020 2020  )}; '.          
-000242e0: 2020 6627 7b5f 6765 745f 7265 706c 6963    f'{_get_replic
-000242f0: 615f 6970 286e 616d 652c 2031 297d 3b20  a_ip(name, 1)}; 
-00024300: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
-00024310: 7b5f 6765 745f 7265 706c 6963 615f 6970  {_get_replica_ip
-00024320: 286e 616d 652c 2032 297d 3b20 7b5f 6765  (name, 2)}; {_ge
-00024330: 745f 7265 706c 6963 615f 6970 286e 616d  t_replica_ip(nam
-00024340: 652c 2033 297d 3b20 270a 2020 2020 2020  e, 3)}; '.      
-00024350: 2020 2020 2020 2770 7974 686f 6e20 7465        'python te
-00024360: 7374 732f 736b 7973 6572 7665 2f6c 6f61  sts/skyserve/loa
-00024370: 645f 6261 6c61 6e63 6572 2f74 6573 745f  d_balancer/test_
-00024380: 726f 756e 645f 726f 6269 6e2e 7079 2027  round_robin.py '
-00024390: 0a20 2020 2020 2020 2020 2020 2027 2d2d  .            '--
-000243a0: 656e 6470 6f69 6e74 2024 656e 6470 6f69  endpoint $endpoi
-000243b0: 6e74 202d 2d72 6570 6c69 6361 2d6e 756d  nt --replica-num
-000243c0: 2033 202d 2d72 6570 6c69 6361 2d69 7073   3 --replica-ips
-000243d0: 2024 6970 3120 2469 7032 2024 6970 3327   $ip1 $ip2 $ip3'
-000243e0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-000243f0: 2020 2020 205f 5445 4152 444f 574e 5f53       _TEARDOWN_S
-00024400: 4552 5649 4345 2e66 6f72 6d61 7428 6e61  ERVICE.format(na
-00024410: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
-00024420: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
-00024430: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
-00024440: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-00024450: 0a0a 4070 7974 6573 742e 6d61 726b 2e67  ..@pytest.mark.g
-00024460: 6370 0a40 7079 7465 7374 2e6d 6172 6b2e  cp.@pytest.mark.
-00024470: 7365 7276 650a 4070 7974 6573 742e 6d61  serve.@pytest.ma
-00024480: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
-00024490: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
-000244a0: 7665 5f61 7574 6f5f 7265 7374 6172 7428  ve_auto_restart(
-000244b0: 293a 0a20 2020 2022 2222 5465 7374 2073  ):.    """Test s
-000244c0: 6b79 7365 7276 6520 7769 7468 2061 7574  kyserve with aut
-000244d0: 6f20 7265 7374 6172 7422 2222 0a20 2020  o restart""".   
-000244e0: 206e 616d 6520 3d20 5f67 6574 5f73 6572   name = _get_ser
-000244f0: 7669 6365 5f6e 616d 6528 290a 2020 2020  vice_name().    
-00024500: 7a6f 6e65 203d 2027 7573 2d63 656e 7472  zone = 'us-centr
-00024510: 616c 312d 6127 0a20 2020 2074 6573 7420  al1-a'.    test 
-00024520: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00024530: 6627 7465 7374 2d73 6b79 7365 7276 652d  f'test-skyserve-
-00024540: 6175 746f 2d72 6573 7461 7274 272c 0a20  auto-restart',. 
-00024550: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00024560: 2020 2020 2023 2054 4f44 4f28 7469 616e       # TODO(tian
-00024570: 293a 2077 6520 6361 6e20 6479 6e61 6d69  ): we can dynami
-00024580: 6361 6c6c 7920 6765 6e65 7261 7465 2059  cally generate Y
-00024590: 414d 4c20 6672 6f6d 2074 656d 706c 6174  AML from templat
-000245a0: 6520 746f 0a20 2020 2020 2020 2020 2020  e to.           
-000245b0: 2023 2061 766f 6964 206d 6169 6e74 6169   # avoid maintai
-000245c0: 6e69 6e67 2074 6f6f 206d 616e 7920 5941  ning too many YA
-000245d0: 4d4c 2066 696c 6573 0a20 2020 2020 2020  ML files.       
-000245e0: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
-000245f0: 2075 7020 2d6e 207b 6e61 6d65 7d20 2d79   up -n {name} -y
-00024600: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
-00024610: 6175 746f 5f72 6573 7461 7274 2e79 616d  auto_restart.yam
-00024620: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00024630: 5f53 4552 5645 5f57 4149 545f 554e 5449  _SERVE_WAIT_UNTI
-00024640: 4c5f 5245 4144 592e 666f 726d 6174 286e  L_READY.format(n
-00024650: 616d 653d 6e61 6d65 2c20 7265 706c 6963  ame=name, replic
-00024660: 615f 6e75 6d3d 3129 2c0a 2020 2020 2020  a_num=1),.      
-00024670: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
-00024680: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
-00024690: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
-000246a0: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-000246b0: 2772 6571 7565 7374 5f6f 7574 7075 743d  'request_output=
-000246c0: 2428 6375 726c 202d 4c20 6874 7470 3a2f  $(curl -L http:/
-000246d0: 2f24 656e 6470 6f69 6e74 293b 2065 6368  /$endpoint); ech
-000246e0: 6f20 2224 7265 7175 6573 745f 6f75 7470  o "$request_outp
-000246f0: 7574 223b 2065 6368 6f20 2224 7265 7175  ut"; echo "$requ
-00024700: 6573 745f 6f75 7470 7574 2220 7c20 6772  est_output" | gr
-00024710: 6570 2022 4869 2c20 536b 7950 696c 6f74  ep "Hi, SkyPilot
-00024720: 2068 6572 6522 272c 0a20 2020 2020 2020   here"',.       
-00024730: 2020 2020 2023 2073 6c65 6570 2066 6f72       # sleep for
-00024740: 2032 3020 7365 636f 6e64 7320 2869 6e69   20 seconds (ini
-00024750: 7469 616c 2064 656c 6179 2920 746f 206d  tial delay) to m
-00024760: 616b 6520 7375 7265 2069 7420 7769 6c6c  ake sure it will
-00024770: 0a20 2020 2020 2020 2020 2020 2023 2062  .            # b
-00024780: 6520 7265 7374 6172 7465 640a 2020 2020  e restarted.    
-00024790: 2020 2020 2020 2020 6627 736c 6565 7020          f'sleep 
-000247a0: 3230 272c 0a20 2020 2020 2020 2020 2020  20',.           
-000247b0: 205f 7465 726d 696e 6174 655f 6763 705f   _terminate_gcp_
-000247c0: 7265 706c 6963 6128 6e61 6d65 2c20 7a6f  replica(name, zo
-000247d0: 6e65 2c20 3129 2c0a 2020 2020 2020 2020  ne, 1),.        
-000247e0: 2020 2020 2320 5761 6974 2066 6f72 2063      # Wait for c
-000247f0: 6f6e 7365 6375 7469 7665 2066 6169 6c75  onsecutive failu
-00024800: 7265 2074 696d 656f 7574 2070 6173 7365  re timeout passe
-00024810: 642e 0a20 2020 2020 2020 2020 2020 2023  d..            #
-00024820: 2049 6620 7468 6520 636c 7573 7465 7220   If the cluster 
-00024830: 6973 206e 6f74 2075 7369 6e67 2073 706f  is not using spo
-00024840: 742c 2069 7420 776f 6e27 7420 6368 6563  t, it won't chec
-00024850: 6b20 7468 6520 636c 7573 7465 7220 7374  k the cluster st
-00024860: 6174 7573 0a20 2020 2020 2020 2020 2020  atus.           
-00024870: 2023 206f 6e20 7468 6520 636c 6f75 6420   # on the cloud 
-00024880: 2873 696e 6365 206d 616e 7561 6c20 7368  (since manual sh
-00024890: 7574 646f 776e 2069 7320 6e6f 7420 6120  utdown is not a 
-000248a0: 636f 6d6d 6f6e 2062 6568 6176 696f 7220  common behavior 
-000248b0: 616e 6420 7375 6368 0a20 2020 2020 2020  and such.       
-000248c0: 2020 2020 2023 2071 7565 7269 6573 2074       # queries t
-000248d0: 616b 6573 2061 206c 6f74 206f 6620 7469  akes a lot of ti
-000248e0: 6d65 292e 2049 6e73 7465 6164 2c20 7765  me). Instead, we
-000248f0: 2074 6869 6e6b 2063 6f6e 7469 6e75 6f75   think continuou
-00024900: 7320 3320 6d69 6e20 7072 6f62 650a 2020  s 3 min probe.  
-00024910: 2020 2020 2020 2020 2020 2320 6661 696c            # fail
-00024920: 7572 6520 6973 206e 6f74 2061 2074 656d  ure is not a tem
-00024930: 706f 7261 7279 2070 726f 626c 656d 2062  porary problem b
-00024940: 7574 2069 6e64 6565 6420 6120 6661 696c  ut indeed a fail
-00024950: 7572 652e 0a20 2020 2020 2020 2020 2020  ure..           
-00024960: 2027 736c 6565 7020 3138 3027 2c0a 2020   'sleep 180',.  
-00024970: 2020 2020 2020 2020 2020 2320 5765 2063            # We c
-00024980: 616e 6e6f 7420 7573 6520 5f53 4552 5645  annot use _SERVE
-00024990: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
-000249a0: 593b 2074 6865 7265 2077 696c 6c20 6265  Y; there will be
-000249b0: 2061 2069 6e74 6572 6d65 6469 6174 6520   a intermediate 
-000249c0: 7469 6d65 0a20 2020 2020 2020 2020 2020  time.           
-000249d0: 2023 2074 6861 7420 7468 6520 6f75 7470   # that the outp
-000249e0: 7574 206f 6620 6073 6b79 2073 6572 7665  ut of `sky serve
-000249f0: 2073 7461 7475 7360 2073 686f 7773 2046   status` shows F
-00024a00: 4149 4c45 4420 616e 6420 7468 6973 2073  AILED and this s
-00024a10: 7461 7475 7320 7769 6c6c 0a20 2020 2020  tatus will.     
-00024a20: 2020 2020 2020 2023 2063 6175 7365 205f         # cause _
-00024a30: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
-00024a40: 5f52 4541 4459 2074 6f20 6561 726c 7920  _READY to early 
-00024a50: 7175 6974 2e0a 2020 2020 2020 2020 2020  quit..          
-00024a60: 2020 2728 7768 696c 6520 7472 7565 3b20    '(while true; 
-00024a70: 646f 270a 2020 2020 2020 2020 2020 2020  do'.            
-00024a80: 6627 2020 2020 6f75 7470 7574 3d24 2873  f'    output=$(s
-00024a90: 6b79 2073 6572 7665 2073 7461 7475 7320  ky serve status 
-00024aa0: 7b6e 616d 657d 293b 270a 2020 2020 2020  {name});'.      
-00024ab0: 2020 2020 2020 2720 2020 2020 6563 686f        '     echo
-00024ac0: 2022 246f 7574 7075 7422 207c 2067 7265   "$output" | gre
-00024ad0: 7020 2d71 2022 312f 3122 2026 2620 6272  p -q "1/1" && br
-00024ae0: 6561 6b3b 270a 2020 2020 2020 2020 2020  eak;'.          
-00024af0: 2020 2720 2020 2020 736c 6565 7020 3130    '     sleep 10
-00024b00: 3b27 0a20 2020 2020 2020 2020 2020 2066  ;'.            f
-00024b10: 2764 6f6e 6529 3b20 736c 6565 7020 7b73  'done); sleep {s
-00024b20: 6572 7665 2e4c 425f 434f 4e54 524f 4c4c  erve.LB_CONTROLL
-00024b30: 4552 5f53 594e 435f 494e 5445 5256 414c  ER_SYNC_INTERVAL
-00024b40: 5f53 4543 4f4e 4453 7d3b 272c 0a20 2020  _SECONDS};',.   
-00024b50: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
-00024b60: 5645 5f45 4e44 504f 494e 545f 5741 4954  VE_ENDPOINT_WAIT
-00024b70: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-00024b80: 6529 7d3b 2027 0a20 2020 2020 2020 2020  e)}; '.         
-00024b90: 2020 2027 7265 7175 6573 745f 6f75 7470     'request_outp
-00024ba0: 7574 3d24 2863 7572 6c20 2d4c 2068 7474  ut=$(curl -L htt
-00024bb0: 703a 2f2f 2465 6e64 706f 696e 7429 3b20  p://$endpoint); 
-00024bc0: 6563 686f 2022 2472 6571 7565 7374 5f6f  echo "$request_o
-00024bd0: 7574 7075 7422 3b20 6563 686f 2022 2472  utput"; echo "$r
-00024be0: 6571 7565 7374 5f6f 7574 7075 7422 207c  equest_output" |
-00024bf0: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
-00024c00: 6c6f 7420 6865 7265 2227 2c0a 2020 2020  lot here"',.    
-00024c10: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
-00024c20: 5445 4152 444f 574e 5f53 4552 5649 4345  TEARDOWN_SERVICE
-00024c30: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-00024c40: 6529 2c0a 2020 2020 2020 2020 7469 6d65  e),.        time
-00024c50: 6f75 743d 3230 202a 2036 302c 0a20 2020  out=20 * 60,.   
-00024c60: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00024c70: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-00024c80: 6573 742e 6d61 726b 2e73 6572 7665 0a64  est.mark.serve.d
-00024c90: 6566 2074 6573 745f 736b 7973 6572 7665  ef test_skyserve
-00024ca0: 5f63 616e 6365 6c28 6765 6e65 7269 635f  _cancel(generic_
-00024cb0: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
-00024cc0: 2022 2222 5465 7374 2073 6b79 7365 7276   """Test skyserv
-00024cd0: 6520 7769 7468 2063 616e 6365 6c22 2222  e with cancel"""
-00024ce0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00024cf0: 5f73 6572 7669 6365 5f6e 616d 6528 290a  _service_name().
-00024d00: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00024d10: 280a 2020 2020 2020 2020 6627 7465 7374  (.        f'test
-00024d20: 2d73 6b79 7365 7276 652d 6361 6e63 656c  -skyserve-cancel
-00024d30: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-00024d40: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-00024d50: 6572 7665 2075 7020 2d6e 207b 6e61 6d65  erve up -n {name
-00024d60: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
-00024d70: 6963 5f63 6c6f 7564 7d20 2d79 2074 6573  ic_cloud} -y tes
-00024d80: 7473 2f73 6b79 7365 7276 652f 6361 6e63  ts/skyserve/canc
-00024d90: 656c 2f63 616e 6365 6c2e 7961 6d6c 272c  el/cancel.yaml',
-00024da0: 0a20 2020 2020 2020 2020 2020 205f 5345  .            _SE
-00024db0: 5256 455f 5741 4954 5f55 4e54 494c 5f52  RVE_WAIT_UNTIL_R
-00024dc0: 4541 4459 2e66 6f72 6d61 7428 6e61 6d65  EADY.format(name
-00024dd0: 3d6e 616d 652c 2072 6570 6c69 6361 5f6e  =name, replica_n
-00024de0: 756d 3d31 292c 0a20 2020 2020 2020 2020  um=1),.         
-00024df0: 2020 2066 277b 5f53 4552 5645 5f45 4e44     f'{_SERVE_END
-00024e00: 504f 494e 545f 5741 4954 2e66 6f72 6d61  POINT_WAIT.forma
-00024e10: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2070  t(name=name)}; p
-00024e20: 7974 686f 6e33 2027 0a20 2020 2020 2020  ython3 '.       
-00024e30: 2020 2020 2027 7465 7374 732f 736b 7973       'tests/skys
-00024e40: 6572 7665 2f63 616e 6365 6c2f 7365 6e64  erve/cancel/send
-00024e50: 5f63 616e 6365 6c5f 7265 7175 6573 742e  _cancel_request.
-00024e60: 7079 2027 0a20 2020 2020 2020 2020 2020  py '.           
-00024e70: 2027 2d2d 656e 6470 6f69 6e74 2024 656e   '--endpoint $en
-00024e80: 6470 6f69 6e74 207c 2067 7265 7020 2252  dpoint | grep "R
-00024e90: 6571 7565 7374 2077 6173 2063 616e 6365  equest was cance
-00024ea0: 6c6c 6564 2227 2c0a 2020 2020 2020 2020  lled"',.        
-00024eb0: 2020 2020 6627 733d 2428 736b 7920 7365      f's=$(sky se
-00024ec0: 7276 6520 6c6f 6773 207b 6e61 6d65 7d20  rve logs {name} 
-00024ed0: 3120 2d2d 6e6f 2d66 6f6c 6c6f 7729 3b20  1 --no-follow); 
-00024ee0: 270a 2020 2020 2020 2020 2020 2020 2775  '.            'u
-00024ef0: 6e74 696c 2021 2065 6368 6f20 2224 7322  ntil ! echo "$s"
-00024f00: 207c 2067 7265 7020 2250 6c65 6173 6520   | grep "Please 
-00024f10: 7761 6974 2066 6f72 2074 6865 2063 6f6e  wait for the con
-00024f20: 7472 6f6c 6c65 7220 746f 2062 6522 3b20  troller to be"; 
-00024f30: 270a 2020 2020 2020 2020 2020 2020 2764  '.            'd
-00024f40: 6f20 6563 686f 2022 5761 6974 696e 6720  o echo "Waiting 
-00024f50: 666f 7220 7365 7276 6520 6c6f 6773 223b  for serve logs";
-00024f60: 2073 6c65 6570 2031 303b 2027 0a20 2020   sleep 10; '.   
-00024f70: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-00024f80: 6b79 2073 6572 7665 206c 6f67 7320 7b6e  ky serve logs {n
-00024f90: 616d 657d 2031 202d 2d6e 6f2d 666f 6c6c  ame} 1 --no-foll
-00024fa0: 6f77 293b 2064 6f6e 653b 2027 0a20 2020  ow); done; '.   
-00024fb0: 2020 2020 2020 2020 2027 6563 686f 2022           'echo "
-00024fc0: 2473 223b 2065 6368 6f20 2224 7322 207c  $s"; echo "$s" |
-00024fd0: 2067 7265 7020 2243 6c69 656e 7420 6469   grep "Client di
-00024fe0: 7363 6f6e 6e65 6374 6564 2c20 7374 6f70  sconnected, stop
-00024ff0: 7069 6e67 2063 6f6d 7075 7461 7469 6f6e  ping computation
-00025000: 2227 2c0a 2020 2020 2020 2020 5d2c 0a20  "',.        ],. 
-00025010: 2020 2020 2020 205f 5445 4152 444f 574e         _TEARDOWN
-00025020: 5f53 4552 5649 4345 2e66 6f72 6d61 7428  _SERVICE.format(
-00025030: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
-00025040: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
-00025050: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
-00025060: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00025070: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00025080: 2e73 6572 7665 0a64 6566 2074 6573 745f  .serve.def test_
-00025090: 736b 7973 6572 7665 5f75 7064 6174 6528  skyserve_update(
-000250a0: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-000250b0: 7472 293a 0a20 2020 2022 2222 5465 7374  tr):.    """Test
-000250c0: 2073 6b79 7365 7276 6520 7769 7468 2075   skyserve with u
-000250d0: 7064 6174 6522 2222 0a20 2020 206e 616d  pdate""".    nam
-000250e0: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
-000250f0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00025100: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00025110: 2066 2774 6573 742d 736b 7973 6572 7665   f'test-skyserve
-00025120: 2d75 7064 6174 6527 2c0a 2020 2020 2020  -update',.      
-00025130: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00025140: 6627 736b 7920 7365 7276 6520 7570 202d  f'sky serve up -
-00025150: 6e20 7b6e 616d 657d 202d 2d63 6c6f 7564  n {name} --cloud
-00025160: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-00025170: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
-00025180: 7665 2f75 7064 6174 652f 6f6c 642e 7961  ve/update/old.ya
-00025190: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-000251a0: 205f 5345 5256 455f 5741 4954 5f55 4e54   _SERVE_WAIT_UNT
-000251b0: 494c 5f52 4541 4459 2e66 6f72 6d61 7428  IL_READY.format(
-000251c0: 6e61 6d65 3d6e 616d 652c 2072 6570 6c69  name=name, repli
-000251d0: 6361 5f6e 756d 3d32 292c 0a20 2020 2020  ca_num=2),.     
-000251e0: 2020 2020 2020 2066 277b 5f53 4552 5645         f'{_SERVE
-000251f0: 5f45 4e44 504f 494e 545f 5741 4954 2e66  _ENDPOINT_WAIT.f
-00025200: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
-00025210: 7d3b 2063 7572 6c20 2d4c 2068 7474 703a  }; curl -L http:
-00025220: 2f2f 2465 6e64 706f 696e 7420 7c20 6772  //$endpoint | gr
-00025230: 6570 2022 4869 2c20 536b 7950 696c 6f74  ep "Hi, SkyPilot
-00025240: 2068 6572 6522 272c 0a20 2020 2020 2020   here"',.       
-00025250: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
-00025260: 2075 7064 6174 6520 7b6e 616d 657d 202d   update {name} -
-00025270: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-00025280: 636c 6f75 647d 202d 2d6d 6f64 6520 626c  cloud} --mode bl
-00025290: 7565 5f67 7265 656e 202d 7920 7465 7374  ue_green -y test
-000252a0: 732f 736b 7973 6572 7665 2f75 7064 6174  s/skyserve/updat
-000252b0: 652f 6e65 772e 7961 6d6c 272c 0a20 2020  e/new.yaml',.   
-000252c0: 2020 2020 2020 2020 2023 2073 6c65 6570           # sleep
-000252d0: 2062 6566 6f72 6520 7570 6461 7465 2069   before update i
-000252e0: 7320 7265 6769 7374 6572 6564 2e0a 2020  s registered..  
-000252f0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-00025300: 2032 3027 2c0a 2020 2020 2020 2020 2020   20',.          
-00025310: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
-00025320: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
-00025330: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
-00025340: 2020 2020 2020 2020 2020 2020 2775 6e74              'unt
-00025350: 696c 2063 7572 6c20 2d4c 2068 7474 703a  il curl -L http:
-00025360: 2f2f 2465 6e64 706f 696e 7420 7c20 6772  //$endpoint | gr
-00025370: 6570 2022 4869 2c20 6e65 7720 536b 7950  ep "Hi, new SkyP
-00025380: 696c 6f74 2068 6572 6521 223b 2064 6f20  ilot here!"; do 
-00025390: 736c 6565 7020 323b 2064 6f6e 653b 270a  sleep 2; done;'.
-000253a0: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
-000253b0: 6b65 2073 7572 6520 7468 6520 7472 6166  ke sure the traf
-000253c0: 6669 6320 6973 206e 6f74 206d 6978 6564  fic is not mixed
-000253d0: 0a20 2020 2020 2020 2020 2020 2027 6375  .            'cu
-000253e0: 726c 202d 4c20 6874 7470 3a2f 2f24 656e  rl -L http://$en
-000253f0: 6470 6f69 6e74 207c 2067 7265 7020 2248  dpoint | grep "H
-00025400: 692c 206e 6577 2053 6b79 5069 6c6f 7420  i, new SkyPilot 
-00025410: 6865 7265 2227 2c0a 2020 2020 2020 2020  here"',.        
-00025420: 2020 2020 2320 5468 6520 6c61 7465 7374      # The latest
-00025430: 2032 2076 6572 7369 6f6e 2073 686f 756c   2 version shoul
-00025440: 6420 6265 2052 4541 4459 2061 6e64 2074  d be READY and t
-00025450: 6865 206f 6c64 6572 2076 6572 7369 6f6e  he older version
-00025460: 7320 7368 6f75 6c64 2062 6520 7368 7574  s should be shut
-00025470: 7469 6e67 2064 6f77 6e0a 2020 2020 2020  ting down.      
-00025480: 2020 2020 2020 285f 6368 6563 6b5f 7265        (_check_re
-00025490: 706c 6963 615f 696e 5f73 7461 7475 7328  plica_in_status(
-000254a0: 6e61 6d65 2c20 5b28 322c 2046 616c 7365  name, [(2, False
-000254b0: 2c20 2752 4541 4459 2729 2c0a 2020 2020  , 'READY'),.    
-000254c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000254d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000254e0: 2020 2020 2020 2020 2028 322c 2046 616c           (2, Fal
-000254f0: 7365 2c20 2753 4855 5454 494e 475f 444f  se, 'SHUTTING_DO
-00025500: 574e 2729 5d29 202b 0a20 2020 2020 2020  WN')]) +.       
-00025510: 2020 2020 2020 5f63 6865 636b 5f73 6572        _check_ser
-00025520: 7669 6365 5f76 6572 7369 6f6e 286e 616d  vice_version(nam
-00025530: 652c 2022 3222 2929 2c0a 2020 2020 2020  e, "2")),.      
-00025540: 2020 5d2c 0a20 2020 2020 2020 205f 5445    ],.        _TE
-00025550: 4152 444f 574e 5f53 4552 5649 4345 2e66  ARDOWN_SERVICE.f
-00025560: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
-00025570: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-00025580: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
-00025590: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-000255a0: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-000255b0: 742e 6d61 726b 2e73 6572 7665 0a64 6566  t.mark.serve.def
-000255c0: 2074 6573 745f 736b 7973 6572 7665 5f72   test_skyserve_r
-000255d0: 6f6c 6c69 6e67 5f75 7064 6174 6528 6765  olling_update(ge
-000255e0: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
-000255f0: 293a 0a20 2020 2022 2222 5465 7374 2073  ):.    """Test s
-00025600: 6b79 7365 7276 6520 7769 7468 2072 6f6c  kyserve with rol
-00025610: 6c69 6e67 2075 7064 6174 6522 2222 0a20  ling update""". 
-00025620: 2020 206e 616d 6520 3d20 5f67 6574 5f73     name = _get_s
-00025630: 6572 7669 6365 5f6e 616d 6528 290a 2020  ervice_name().  
-00025640: 2020 7369 6e67 6c65 5f6e 6577 5f72 6570    single_new_rep
-00025650: 6c69 6361 203d 205f 6368 6563 6b5f 7265  lica = _check_re
-00025660: 706c 6963 615f 696e 5f73 7461 7475 7328  plica_in_status(
-00025670: 0a20 2020 2020 2020 206e 616d 652c 205b  .        name, [
-00025680: 2832 2c20 4661 6c73 652c 2027 5245 4144  (2, False, 'READ
-00025690: 5927 292c 2028 312c 2046 616c 7365 2c20  Y'), (1, False, 
-000256a0: 5f53 4552 5649 4345 5f4c 4155 4e43 4849  _SERVICE_LAUNCHI
-000256b0: 4e47 5f53 5441 5455 535f 5245 4745 5829  NG_STATUS_REGEX)
-000256c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000256d0: 2028 312c 2046 616c 7365 2c20 2753 4855   (1, False, 'SHU
-000256e0: 5454 494e 475f 444f 574e 2729 5d29 0a20  TTING_DOWN')]). 
-000256f0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00025700: 2020 2020 2020 2020 6627 7465 7374 2d73          f'test-s
-00025710: 6b79 7365 7276 652d 726f 6c6c 696e 672d  kyserve-rolling-
-00025720: 7570 6461 7465 272c 0a20 2020 2020 2020  update',.       
-00025730: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00025740: 2773 6b79 2073 6572 7665 2075 7020 2d6e  'sky serve up -n
-00025750: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-00025760: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
-00025770: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
-00025780: 652f 7570 6461 7465 2f6f 6c64 2e79 616d  e/update/old.yam
-00025790: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-000257a0: 5f53 4552 5645 5f57 4149 545f 554e 5449  _SERVE_WAIT_UNTI
-000257b0: 4c5f 5245 4144 592e 666f 726d 6174 286e  L_READY.format(n
-000257c0: 616d 653d 6e61 6d65 2c20 7265 706c 6963  ame=name, replic
-000257d0: 615f 6e75 6d3d 3229 2c0a 2020 2020 2020  a_num=2),.      
-000257e0: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
-000257f0: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
-00025800: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
-00025810: 3b20 6375 726c 202d 4c20 6874 7470 3a2f  ; curl -L http:/
-00025820: 2f24 656e 6470 6f69 6e74 207c 2067 7265  /$endpoint | gre
-00025830: 7020 2248 692c 2053 6b79 5069 6c6f 7420  p "Hi, SkyPilot 
-00025840: 6865 7265 2227 2c0a 2020 2020 2020 2020  here"',.        
-00025850: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
-00025860: 7570 6461 7465 207b 6e61 6d65 7d20 2d2d  update {name} --
-00025870: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-00025880: 6c6f 7564 7d20 2d79 2074 6573 7473 2f73  loud} -y tests/s
-00025890: 6b79 7365 7276 652f 7570 6461 7465 2f6e  kyserve/update/n
-000258a0: 6577 2e79 616d 6c27 2c0a 2020 2020 2020  ew.yaml',.      
-000258b0: 2020 2020 2020 2320 4d61 6b65 2073 7572        # Make sur
-000258c0: 6520 7468 6520 7472 6166 6669 6320 6973  e the traffic is
-000258d0: 206d 6978 6564 2061 6372 6f73 7320 7477   mixed across tw
-000258e0: 6f20 7665 7273 696f 6e73 2c20 7468 6520  o versions, the 
-000258f0: 7265 706c 6963 6173 0a20 2020 2020 2020  replicas.       
-00025900: 2020 2020 2023 2077 6974 6820 6576 656e       # with even
-00025910: 2069 6420 7769 6c6c 2073 6c65 6570 2036   id will sleep 6
-00025920: 3020 7365 636f 6e64 7320 6265 666f 7265  0 seconds before
-00025930: 2062 6569 6e67 2072 6561 6479 2c20 736f   being ready, so
-00025940: 2077 650a 2020 2020 2020 2020 2020 2020   we.            
-00025950: 2320 7368 6f75 6c64 2062 6520 6162 6c65  # should be able
-00025960: 2074 6f20 6765 7420 6f62 7365 7276 6520   to get observe 
-00025970: 7468 6520 7065 7269 6f64 2074 6861 7420  the period that 
-00025980: 7468 6520 7472 6166 6669 6320 6973 206d  the traffic is m
-00025990: 6978 6564 0a20 2020 2020 2020 2020 2020  ixed.           
-000259a0: 2023 2061 6372 6f73 7320 7477 6f20 7665   # across two ve
-000259b0: 7273 696f 6e73 2e0a 2020 2020 2020 2020  rsions..        
-000259c0: 2020 2020 6627 7b5f 5345 5256 455f 454e      f'{_SERVE_EN
-000259d0: 4450 4f49 4e54 5f57 4149 542e 666f 726d  DPOINT_WAIT.form
-000259e0: 6174 286e 616d 653d 6e61 6d65 297d 3b20  at(name=name)}; 
-000259f0: 270a 2020 2020 2020 2020 2020 2020 2775  '.            'u
-00025a00: 6e74 696c 2063 7572 6c20 2d4c 2068 7474  ntil curl -L htt
-00025a10: 703a 2f2f 2465 6e64 706f 696e 7420 7c20  p://$endpoint | 
-00025a20: 6772 6570 2022 4869 2c20 6e65 7720 536b  grep "Hi, new Sk
-00025a30: 7950 696c 6f74 2068 6572 6521 223b 2064  yPilot here!"; d
-00025a40: 6f20 736c 6565 7020 323b 2064 6f6e 653b  o sleep 2; done;
-00025a50: 2073 6c65 6570 2032 3b20 270a 2020 2020   sleep 2; '.    
-00025a60: 2020 2020 2020 2020 2320 5468 6520 6c61          # The la
-00025a70: 7465 7374 2076 6572 7369 6f6e 2073 686f  test version sho
-00025a80: 756c 6420 6861 7665 206f 6e65 2052 4541  uld have one REA
-00025a90: 4459 2061 6e64 2074 6865 206f 6e65 206f  DY and the one o
-00025aa0: 6620 7468 6520 6f6c 6465 7220 7665 7273  f the older vers
-00025ab0: 696f 6e73 2073 686f 756c 6420 6265 2073  ions should be s
-00025ac0: 6875 7474 696e 6720 646f 776e 0a20 2020  hutting down.   
-00025ad0: 2020 2020 2020 2020 2066 277b 7369 6e67           f'{sing
-00025ae0: 6c65 5f6e 6577 5f72 6570 6c69 6361 7d20  le_new_replica} 
-00025af0: 7b5f 6368 6563 6b5f 7365 7276 6963 655f  {_check_service_
-00025b00: 7665 7273 696f 6e28 6e61 6d65 2c20 2231  version(name, "1
-00025b10: 2c32 2229 7d20 270a 2020 2020 2020 2020  ,2")} '.        
-00025b20: 2020 2020 2320 4368 6563 6b20 7468 6520      # Check the 
-00025b30: 6f75 7470 7574 2066 726f 6d20 7468 6520  output from the 
-00025b40: 6f6c 6420 7665 7273 696f 6e2c 2069 6d6d  old version, imm
-00025b50: 6564 6961 7465 6c79 2061 6674 6572 2074  ediately after t
-00025b60: 6865 0a20 2020 2020 2020 2020 2020 2023  he.            #
-00025b70: 206f 7574 7075 7420 6672 6f6d 2074 6865   output from the
-00025b80: 206e 6577 2076 6572 7369 6f6e 2061 7070   new version app
-00025b90: 6561 7273 2e20 5468 6973 2069 7320 6775  ears. This is gu
-00025ba0: 6172 616e 7465 6564 2062 7920 7468 650a  aranteed by the.
-00025bb0: 2020 2020 2020 2020 2020 2020 2320 726f              # ro
-00025bc0: 756e 6420 726f 6269 6e20 6c6f 6164 2062  und robin load b
-00025bd0: 616c 616e 6369 6e67 2070 6f6c 6963 792e  alancing policy.
-00025be0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00025bf0: 4f44 4f28 7a68 7775 293a 2077 6520 7368  ODO(zhwu): we sh
-00025c00: 6f75 6c64 2068 6176 6520 6120 6d6f 7265  ould have a more
-00025c10: 2067 656e 6572 616c 697a 6564 2077 6179   generalized way
-00025c20: 2066 6f72 2063 6865 636b 696e 6720 7468   for checking th
-00025c30: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-00025c40: 6d69 7865 6420 7665 7273 696f 6e20 6f66  mixed version of
-00025c50: 2072 6570 6c69 6361 7320 746f 2061 766f   replicas to avo
-00025c60: 6964 2064 6570 656e 6469 6e67 206f 6e20  id depending on 
-00025c70: 7468 6520 7370 6563 6966 6963 0a20 2020  the specific.   
-00025c80: 2020 2020 2020 2020 2023 2072 6f75 6e64           # round
-00025c90: 2072 6f62 696e 206c 6f61 6420 6261 6c61   robin load bala
-00025ca0: 6e63 696e 6720 706f 6c69 6379 2e0a 2020  ncing policy..  
-00025cb0: 2020 2020 2020 2020 2020 2763 7572 6c20            'curl 
-00025cc0: 2d4c 2068 7474 703a 2f2f 2465 6e64 706f  -L http://$endpo
-00025cd0: 696e 7420 7c20 6772 6570 2022 4869 2c20  int | grep "Hi, 
-00025ce0: 536b 7950 696c 6f74 2068 6572 6522 272c  SkyPilot here"',
-00025cf0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00025d00: 2020 2020 5f54 4541 5244 4f57 4e5f 5345      _TEARDOWN_SE
-00025d10: 5256 4943 452e 666f 726d 6174 286e 616d  RVICE.format(nam
-00025d20: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
-00025d30: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
-00025d40: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00025d50: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00025d60: 0a40 7079 7465 7374 2e6d 6172 6b2e 7365  .@pytest.mark.se
-00025d70: 7276 650a 6465 6620 7465 7374 5f73 6b79  rve.def test_sky
-00025d80: 7365 7276 655f 6661 7374 5f75 7064 6174  serve_fast_updat
-00025d90: 6528 6765 6e65 7269 635f 636c 6f75 643a  e(generic_cloud:
-00025da0: 2073 7472 293a 0a20 2020 2022 2222 5465   str):.    """Te
-00025db0: 7374 2073 6b79 7365 7276 6520 7769 7468  st skyserve with
-00025dc0: 2066 6173 7420 7570 6461 7465 2028 496e   fast update (In
-00025dd0: 6372 656d 656e 7420 7665 7273 696f 6e20  crement version 
-00025de0: 6f66 206f 6c64 2072 6570 6c69 6361 7329  of old replicas)
-00025df0: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
-00025e00: 6765 745f 7365 7276 6963 655f 6e61 6d65  get_service_name
-00025e10: 2829 0a0a 2020 2020 7465 7374 203d 2054  ()..    test = T
-00025e20: 6573 7428 0a20 2020 2020 2020 2066 2774  est(.        f't
-00025e30: 6573 742d 736b 7973 6572 7665 2d66 6173  est-skyserve-fas
-00025e40: 742d 7570 6461 7465 272c 0a20 2020 2020  t-update',.     
-00025e50: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00025e60: 2066 2773 6b79 2073 6572 7665 2075 7020   f'sky serve up 
-00025e70: 2d6e 207b 6e61 6d65 7d20 2d79 202d 2d63  -n {name} -y --c
-00025e80: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-00025e90: 6f75 647d 2074 6573 7473 2f73 6b79 7365  oud} tests/skyse
-00025ea0: 7276 652f 7570 6461 7465 2f62 756d 705f  rve/update/bump_
-00025eb0: 7665 7273 696f 6e5f 6265 666f 7265 2e79  version_before.y
-00025ec0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00025ed0: 2020 5f53 4552 5645 5f57 4149 545f 554e    _SERVE_WAIT_UN
-00025ee0: 5449 4c5f 5245 4144 592e 666f 726d 6174  TIL_READY.format
-00025ef0: 286e 616d 653d 6e61 6d65 2c20 7265 706c  (name=name, repl
-00025f00: 6963 615f 6e75 6d3d 3229 2c0a 2020 2020  ica_num=2),.    
-00025f10: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
-00025f20: 455f 454e 4450 4f49 4e54 5f57 4149 542e  E_ENDPOINT_WAIT.
-00025f30: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-00025f40: 297d 3b20 6375 726c 202d 4c20 6874 7470  )}; curl -L http
-00025f50: 3a2f 2f24 656e 6470 6f69 6e74 207c 2067  ://$endpoint | g
-00025f60: 7265 7020 2248 692c 2053 6b79 5069 6c6f  rep "Hi, SkyPilo
-00025f70: 7420 6865 7265 2227 2c0a 2020 2020 2020  t here"',.      
-00025f80: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
-00025f90: 6520 7570 6461 7465 207b 6e61 6d65 7d20  e update {name} 
-00025fa0: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-00025fb0: 5f63 6c6f 7564 7d20 2d2d 6d6f 6465 2062  _cloud} --mode b
-00025fc0: 6c75 655f 6772 6565 6e20 2d79 2074 6573  lue_green -y tes
-00025fd0: 7473 2f73 6b79 7365 7276 652f 7570 6461  ts/skyserve/upda
-00025fe0: 7465 2f62 756d 705f 7665 7273 696f 6e5f  te/bump_version_
-00025ff0: 6166 7465 722e 7961 6d6c 272c 0a20 2020  after.yaml',.   
-00026000: 2020 2020 2020 2020 2023 2073 6c65 6570           # sleep
-00026010: 2074 6f20 7761 6974 2066 6f72 2075 7064   to wait for upd
-00026020: 6174 6520 746f 2062 6520 7265 6769 7374  ate to be regist
-00026030: 6572 6564 2e0a 2020 2020 2020 2020 2020  ered..          
-00026040: 2020 2773 6c65 6570 2033 3027 2c0a 2020    'sleep 30',.  
-00026050: 2020 2020 2020 2020 2020 2320 3220 6f6e            # 2 on
-00026060: 2d64 6561 6d6e 6420 2872 6561 6479 2920  -deamnd (ready) 
-00026070: 2b20 3120 6f6e 2d64 656d 616e 6420 2870  + 1 on-demand (p
-00026080: 726f 7669 7369 6f6e 696e 6729 2e0a 2020  rovisioning)..  
-00026090: 2020 2020 2020 2020 2020 280a 2020 2020            (.    
-000260a0: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
-000260b0: 636b 5f72 6570 6c69 6361 5f69 6e5f 7374  ck_replica_in_st
-000260c0: 6174 7573 280a 2020 2020 2020 2020 2020  atus(.          
-000260d0: 2020 2020 2020 2020 2020 6e61 6d65 2c20            name, 
-000260e0: 5b28 322c 2046 616c 7365 2c20 2752 4541  [(2, False, 'REA
-000260f0: 4459 2729 2c0a 2020 2020 2020 2020 2020  DY'),.          
-00026100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026110: 2028 312c 2046 616c 7365 2c20 5f53 4552   (1, False, _SER
-00026120: 5649 4345 5f4c 4155 4e43 4849 4e47 5f53  VICE_LAUNCHING_S
-00026130: 5441 5455 535f 5245 4745 5829 5d29 202b  TATUS_REGEX)]) +
-00026140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00026150: 2023 2046 6173 7420 7570 6461 7465 2077   # Fast update w
-00026160: 696c 6c20 6469 7265 6374 6c79 2068 6176  ill directly hav
-00026170: 6520 7468 6520 6c61 7465 7374 2076 6572  e the latest ver
-00026180: 7369 6f6e 2072 6561 6479 2e0a 2020 2020  sion ready..    
-00026190: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
-000261a0: 636b 5f73 6572 7669 6365 5f76 6572 7369  ck_service_versi
-000261b0: 6f6e 286e 616d 652c 2022 3222 2929 2c0a  on(name, "2")),.
-000261c0: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
-000261d0: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
-000261e0: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
-000261f0: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
-00026200: 6d3d 3329 202b 0a20 2020 2020 2020 2020  m=3) +.         
-00026210: 2020 205f 6368 6563 6b5f 7365 7276 6963     _check_servic
-00026220: 655f 7665 7273 696f 6e28 6e61 6d65 2c20  e_version(name, 
-00026230: 2232 2229 2c0a 2020 2020 2020 2020 2020  "2"),.          
-00026240: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
-00026250: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
-00026260: 286e 616d 653d 6e61 6d65 297d 3b20 6375  (name=name)}; cu
-00026270: 726c 202d 4c20 6874 7470 3a2f 2f24 656e  rl -L http://$en
-00026280: 6470 6f69 6e74 207c 2067 7265 7020 2248  dpoint | grep "H
-00026290: 692c 2053 6b79 5069 6c6f 7420 6865 7265  i, SkyPilot here
-000262a0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-000262b0: 2320 5465 7374 2072 6f6c 6c69 6e67 2075  # Test rolling u
-000262c0: 7064 6174 650a 2020 2020 2020 2020 2020  pdate.          
-000262d0: 2020 6627 736b 7920 7365 7276 6520 7570    f'sky serve up
-000262e0: 6461 7465 207b 6e61 6d65 7d20 2d2d 636c  date {name} --cl
-000262f0: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-00026300: 7564 7d20 2d79 2074 6573 7473 2f73 6b79  ud} -y tests/sky
-00026310: 7365 7276 652f 7570 6461 7465 2f62 756d  serve/update/bum
-00026320: 705f 7665 7273 696f 6e5f 6265 666f 7265  p_version_before
-00026330: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00026340: 2020 2020 2320 736c 6565 7020 746f 2077      # sleep to w
-00026350: 6169 7420 666f 7220 7570 6461 7465 2074  ait for update t
-00026360: 6f20 6265 2072 6567 6973 7465 7265 642e  o be registered.
-00026370: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00026380: 6565 7020 3135 272c 0a20 2020 2020 2020  eep 15',.       
-00026390: 2020 2020 2023 2032 206f 6e2d 6465 616d       # 2 on-deam
-000263a0: 6e64 2028 7265 6164 7929 202b 2031 206f  nd (ready) + 1 o
-000263b0: 6e2d 6465 6d61 6e64 2028 7368 7574 7469  n-demand (shutti
-000263c0: 6e67 2064 6f77 6e29 2e0a 2020 2020 2020  ng down)..      
-000263d0: 2020 2020 2020 5f63 6865 636b 5f72 6570        _check_rep
-000263e0: 6c69 6361 5f69 6e5f 7374 6174 7573 286e  lica_in_status(n
-000263f0: 616d 652c 205b 2832 2c20 4661 6c73 652c  ame, [(2, False,
-00026400: 2027 5245 4144 5927 292c 0a20 2020 2020   'READY'),.     
-00026410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026430: 2020 2020 2020 2028 312c 2046 616c 7365         (1, False
-00026440: 2c20 2753 4855 5454 494e 475f 444f 574e  , 'SHUTTING_DOWN
-00026450: 2729 5d29 2c0a 2020 2020 2020 2020 2020  ')]),.          
-00026460: 2020 5f53 4552 5645 5f57 4149 545f 554e    _SERVE_WAIT_UN
-00026470: 5449 4c5f 5245 4144 592e 666f 726d 6174  TIL_READY.format
-00026480: 286e 616d 653d 6e61 6d65 2c20 7265 706c  (name=name, repl
-00026490: 6963 615f 6e75 6d3d 3229 202b 0a20 2020  ica_num=2) +.   
-000264a0: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
-000264b0: 7365 7276 6963 655f 7665 7273 696f 6e28  service_version(
-000264c0: 6e61 6d65 2c20 2233 2229 2c0a 2020 2020  name, "3"),.    
-000264d0: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
-000264e0: 455f 454e 4450 4f49 4e54 5f57 4149 542e  E_ENDPOINT_WAIT.
-000264f0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-00026500: 297d 3b20 6375 726c 202d 4c20 6874 7470  )}; curl -L http
-00026510: 3a2f 2f24 656e 6470 6f69 6e74 207c 2067  ://$endpoint | g
-00026520: 7265 7020 2248 692c 2053 6b79 5069 6c6f  rep "Hi, SkyPilo
-00026530: 7420 6865 7265 2227 2c0a 2020 2020 2020  t here"',.      
-00026540: 2020 5d2c 0a20 2020 2020 2020 205f 5445    ],.        _TE
-00026550: 4152 444f 574e 5f53 4552 5649 4345 2e66  ARDOWN_SERVICE.f
-00026560: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
-00026570: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-00026580: 743d 3330 202a 2036 302c 0a20 2020 2029  t=30 * 60,.    )
-00026590: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-000265a0: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-000265b0: 742e 6d61 726b 2e73 6572 7665 0a64 6566  t.mark.serve.def
-000265c0: 2074 6573 745f 736b 7973 6572 7665 5f75   test_skyserve_u
-000265d0: 7064 6174 655f 6175 746f 7363 616c 6528  pdate_autoscale(
-000265e0: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-000265f0: 7472 293a 0a20 2020 2022 2222 5465 7374  tr):.    """Test
-00026600: 2073 6b79 7365 7276 6520 7570 6461 7465   skyserve update
-00026610: 2077 6974 6820 6175 746f 7363 616c 6522   with autoscale"
-00026620: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
-00026630: 6574 5f73 6572 7669 6365 5f6e 616d 6528  et_service_name(
-00026640: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-00026650: 7428 0a20 2020 2020 2020 2066 2774 6573  t(.        f'tes
-00026660: 742d 736b 7973 6572 7665 2d75 7064 6174  t-skyserve-updat
-00026670: 652d 6175 746f 7363 616c 6527 2c0a 2020  e-autoscale',.  
-00026680: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00026690: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
-000266a0: 7570 202d 6e20 7b6e 616d 657d 202d 2d63  up -n {name} --c
-000266b0: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-000266c0: 6f75 647d 202d 7920 7465 7374 732f 736b  oud} -y tests/sk
-000266d0: 7973 6572 7665 2f75 7064 6174 652f 6e75  yserve/update/nu
-000266e0: 6d5f 6d69 6e5f 7477 6f2e 7961 6d6c 272c  m_min_two.yaml',
-000266f0: 0a20 2020 2020 2020 2020 2020 205f 5345  .            _SE
-00026700: 5256 455f 5741 4954 5f55 4e54 494c 5f52  RVE_WAIT_UNTIL_R
-00026710: 4541 4459 2e66 6f72 6d61 7428 6e61 6d65  EADY.format(name
-00026720: 3d6e 616d 652c 2072 6570 6c69 6361 5f6e  =name, replica_n
-00026730: 756d 3d32 2920 2b0a 2020 2020 2020 2020  um=2) +.        
-00026740: 2020 2020 5f63 6865 636b 5f73 6572 7669      _check_servi
-00026750: 6365 5f76 6572 7369 6f6e 286e 616d 652c  ce_version(name,
-00026760: 2022 3122 292c 0a20 2020 2020 2020 2020   "1"),.         
-00026770: 2020 2066 277b 5f53 4552 5645 5f45 4e44     f'{_SERVE_END
-00026780: 504f 494e 545f 5741 4954 2e66 6f72 6d61  POINT_WAIT.forma
-00026790: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2027  t(name=name)}; '
-000267a0: 0a20 2020 2020 2020 2020 2020 2027 6375  .            'cu
-000267b0: 726c 202d 4c20 6874 7470 3a2f 2f24 656e  rl -L http://$en
-000267c0: 6470 6f69 6e74 207c 2067 7265 7020 2248  dpoint | grep "H
-000267d0: 692c 2053 6b79 5069 6c6f 7420 6865 7265  i, SkyPilot here
-000267e0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-000267f0: 6627 736b 7920 7365 7276 6520 7570 6461  f'sky serve upda
-00026800: 7465 207b 6e61 6d65 7d20 2d2d 636c 6f75  te {name} --clou
-00026810: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-00026820: 7d20 2d2d 6d6f 6465 2062 6c75 655f 6772  } --mode blue_gr
-00026830: 6565 6e20 2d79 2074 6573 7473 2f73 6b79  een -y tests/sky
-00026840: 7365 7276 652f 7570 6461 7465 2f6e 756d  serve/update/num
-00026850: 5f6d 696e 5f6f 6e65 2e79 616d 6c27 2c0a  _min_one.yaml',.
-00026860: 2020 2020 2020 2020 2020 2020 2320 736c              # sl
-00026870: 6565 7020 6265 666f 7265 2075 7064 6174  eep before updat
-00026880: 6520 6973 2072 6567 6973 7465 7265 642e  e is registered.
-00026890: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-000268a0: 6565 7020 3230 272c 0a20 2020 2020 2020  eep 20',.       
-000268b0: 2020 2020 2023 2054 696d 656f 7574 2077       # Timeout w
-000268c0: 696c 6c20 6265 2074 7269 6767 6572 6564  ill be triggered
-000268d0: 2077 6865 6e20 7570 6461 7465 2066 6169   when update fai
-000268e0: 6c73 2e0a 2020 2020 2020 2020 2020 2020  ls..            
-000268f0: 5f53 4552 5645 5f57 4149 545f 554e 5449  _SERVE_WAIT_UNTI
-00026900: 4c5f 5245 4144 592e 666f 726d 6174 286e  L_READY.format(n
-00026910: 616d 653d 6e61 6d65 2c20 7265 706c 6963  ame=name, replic
-00026920: 615f 6e75 6d3d 3129 202b 0a20 2020 2020  a_num=1) +.     
-00026930: 2020 2020 2020 205f 6368 6563 6b5f 7365         _check_se
-00026940: 7276 6963 655f 7665 7273 696f 6e28 6e61  rvice_version(na
-00026950: 6d65 2c20 2232 2229 2c0a 2020 2020 2020  me, "2"),.      
-00026960: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
-00026970: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
-00026980: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
-00026990: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-000269a0: 2763 7572 6c20 2d4c 2068 7474 703a 2f2f  'curl -L http://
-000269b0: 2465 6e64 706f 696e 7420 7c20 6772 6570  $endpoint | grep
-000269c0: 2022 4869 2c20 536b 7950 696c 6f74 2068   "Hi, SkyPilot h
-000269d0: 6572 6521 2227 2c0a 2020 2020 2020 2020  ere!"',.        
-000269e0: 2020 2020 2320 526f 6c6c 696e 6720 5570      # Rolling Up
-000269f0: 6461 7465 0a20 2020 2020 2020 2020 2020  date.           
-00026a00: 2066 2773 6b79 2073 6572 7665 2075 7064   f'sky serve upd
-00026a10: 6174 6520 7b6e 616d 657d 202d 2d63 6c6f  ate {name} --clo
-00026a20: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
-00026a30: 647d 202d 7920 7465 7374 732f 736b 7973  d} -y tests/skys
-00026a40: 6572 7665 2f75 7064 6174 652f 6e75 6d5f  erve/update/num_
-00026a50: 6d69 6e5f 7477 6f2e 7961 6d6c 272c 0a20  min_two.yaml',. 
-00026a60: 2020 2020 2020 2020 2020 2023 2073 6c65             # sle
-00026a70: 6570 2062 6566 6f72 6520 7570 6461 7465  ep before update
-00026a80: 2069 7320 7265 6769 7374 6572 6564 2e0a   is registered..
-00026a90: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-00026aa0: 6570 2032 3027 2c0a 2020 2020 2020 2020  ep 20',.        
-00026ab0: 2020 2020 2320 5469 6d65 6f75 7420 7769      # Timeout wi
-00026ac0: 6c6c 2062 6520 7472 6967 6765 7265 6420  ll be triggered 
-00026ad0: 7768 656e 2075 7064 6174 6520 6661 696c  when update fail
-00026ae0: 732e 0a20 2020 2020 2020 2020 2020 205f  s..            _
-00026af0: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
-00026b00: 5f52 4541 4459 2e66 6f72 6d61 7428 6e61  _READY.format(na
-00026b10: 6d65 3d6e 616d 652c 2072 6570 6c69 6361  me=name, replica
-00026b20: 5f6e 756d 3d32 2920 2b0a 2020 2020 2020  _num=2) +.      
-00026b30: 2020 2020 2020 5f63 6865 636b 5f73 6572        _check_ser
-00026b40: 7669 6365 5f76 6572 7369 6f6e 286e 616d  vice_version(nam
-00026b50: 652c 2022 3322 292c 0a20 2020 2020 2020  e, "3"),.       
-00026b60: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
-00026b70: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
-00026b80: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
-00026b90: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-00026ba0: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
-00026bb0: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
-00026bc0: 2248 692c 2053 6b79 5069 6c6f 7420 6865  "Hi, SkyPilot he
-00026bd0: 7265 2122 272c 0a20 2020 2020 2020 205d  re!"',.        ]
-00026be0: 2c0a 2020 2020 2020 2020 5f54 4541 5244  ,.        _TEARD
-00026bf0: 4f57 4e5f 5345 5256 4943 452e 666f 726d  OWN_SERVICE.form
-00026c00: 6174 286e 616d 653d 6e61 6d65 292c 0a20  at(name=name),. 
-00026c10: 2020 2020 2020 2074 696d 656f 7574 3d33         timeout=3
-00026c20: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
-00026c30: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00026c40: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-00026c50: 6172 6b2e 7365 7276 650a 4070 7974 6573  ark.serve.@pytes
-00026c60: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
-00026c70: 6574 6573 2020 2320 5370 6f74 2069 6e73  etes  # Spot ins
-00026c80: 7461 6e63 6573 2061 7265 206e 6f74 2073  tances are not s
-00026c90: 7570 706f 7274 6564 2069 6e20 4b75 6265  upported in Kube
-00026ca0: 726e 6574 6573 0a40 7079 7465 7374 2e6d  rnetes.@pytest.m
-00026cb0: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
-00026cc0: 276d 6f64 6527 2c20 5b27 726f 6c6c 696e  'mode', ['rollin
-00026cd0: 6727 2c20 2762 6c75 655f 6772 6565 6e27  g', 'blue_green'
-00026ce0: 5d29 0a64 6566 2074 6573 745f 736b 7973  ]).def test_skys
-00026cf0: 6572 7665 5f6e 6577 5f61 7574 6f73 6361  erve_new_autosca
-00026d00: 6c65 725f 7570 6461 7465 286d 6f64 653a  ler_update(mode:
-00026d10: 2073 7472 2c20 6765 6e65 7269 635f 636c   str, generic_cl
-00026d20: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
-00026d30: 2222 5465 7374 2073 6b79 7365 7276 6520  ""Test skyserve 
-00026d40: 7769 7468 2075 7064 6174 6520 7468 6174  with update that
-00026d50: 2063 6861 6e67 6573 2061 7574 6f73 6361   changes autosca
-00026d60: 6c65 7222 2222 0a20 2020 206e 616d 6520  ler""".    name 
-00026d70: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
-00026d80: 616d 6528 2920 2b20 6d6f 6465 0a0a 2020  ame() + mode..  
-00026d90: 2020 666f 7572 5f73 706f 745f 7570 5f63    four_spot_up_c
-00026da0: 6d64 203d 205f 6368 6563 6b5f 7265 706c  md = _check_repl
-00026db0: 6963 615f 696e 5f73 7461 7475 7328 6e61  ica_in_status(na
-00026dc0: 6d65 2c20 5b28 342c 2054 7275 652c 2027  me, [(4, True, '
-00026dd0: 5245 4144 5927 295d 290a 2020 2020 7570  READY')]).    up
-00026de0: 6461 7465 5f63 6865 636b 203d 205b 6627  date_check = [f'
-00026df0: 756e 7469 6c20 287b 666f 7572 5f73 706f  until ({four_spo
-00026e00: 745f 7570 5f63 6d64 7d29 3b20 646f 2073  t_up_cmd}); do s
-00026e10: 6c65 6570 2035 3b20 646f 6e65 3b20 736c  leep 5; done; sl
-00026e20: 6565 7020 3130 3b27 5d0a 2020 2020 6966  eep 10;'].    if
-00026e30: 206d 6f64 6520 3d3d 2027 726f 6c6c 696e   mode == 'rollin
-00026e40: 6727 3a0a 2020 2020 2020 2020 2320 4368  g':.        # Ch
-00026e50: 6563 6b20 726f 6c6c 696e 6720 7570 6461  eck rolling upda
-00026e60: 7465 2c20 6974 2077 696c 6c20 7465 726d  te, it will term
-00026e70: 696e 6174 6520 6f6e 6520 6f66 2074 6865  inate one of the
-00026e80: 206f 6c64 206f 6e2d 6465 6d61 6e64 0a20   old on-demand. 
-00026e90: 2020 2020 2020 2023 2069 6e73 7461 6e63         # instanc
-00026ea0: 6573 2c20 6f6e 6365 2074 6865 7265 2061  es, once there a
-00026eb0: 7265 2034 2073 706f 7420 696e 7374 616e  re 4 spot instan
-00026ec0: 6365 2072 6561 6479 2e0a 2020 2020 2020  ce ready..      
-00026ed0: 2020 7570 6461 7465 5f63 6865 636b 202b    update_check +
-00026ee0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-00026ef0: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
-00026f00: 6e5f 7374 6174 7573 280a 2020 2020 2020  n_status(.      
-00026f10: 2020 2020 2020 2020 2020 6e61 6d65 2c20            name, 
-00026f20: 5b28 312c 2046 616c 7365 2c20 5f53 4552  [(1, False, _SER
-00026f30: 5649 4345 5f4c 4155 4e43 4849 4e47 5f53  VICE_LAUNCHING_S
-00026f40: 5441 5455 535f 5245 4745 5829 2c0a 2020  TATUS_REGEX),.  
-00026f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026f60: 2020 2020 2028 312c 2046 616c 7365 2c20       (1, False, 
-00026f70: 2753 4855 5454 494e 475f 444f 574e 2729  'SHUTTING_DOWN')
-00026f80: 2c20 2831 2c20 4661 6c73 652c 2027 5245  , (1, False, 'RE
-00026f90: 4144 5927 295d 2920 2b0a 2020 2020 2020  ADY')]) +.      
-00026fa0: 2020 2020 2020 5f63 6865 636b 5f73 6572        _check_ser
-00026fb0: 7669 6365 5f76 6572 7369 6f6e 286e 616d  vice_version(nam
-00026fc0: 652c 2022 312c 3222 292c 0a20 2020 2020  e, "1,2"),.     
-00026fd0: 2020 205d 0a20 2020 2065 6c73 653a 0a20     ].    else:. 
-00026fe0: 2020 2020 2020 2023 2043 6865 636b 2062         # Check b
-00026ff0: 6c75 6520 6772 6565 6e20 7570 6461 7465  lue green update
-00027000: 2c20 6974 2077 696c 6c20 6b65 6570 2062  , it will keep b
-00027010: 6f74 6820 6f6c 6420 6f6e 2d64 656d 616e  oth old on-deman
-00027020: 6420 696e 7374 616e 6365 730a 2020 2020  d instances.    
-00027030: 2020 2020 2320 7275 6e6e 696e 672c 206f      # running, o
-00027040: 6e63 6520 7468 6572 6520 6172 6520 3420  nce there are 4 
-00027050: 7370 6f74 2069 6e73 7461 6e63 6520 7265  spot instance re
-00027060: 6164 792e 0a20 2020 2020 2020 2075 7064  ady..        upd
-00027070: 6174 655f 6368 6563 6b20 2b3d 205b 0a20  ate_check += [. 
-00027080: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
-00027090: 6b5f 7265 706c 6963 615f 696e 5f73 7461  k_replica_in_sta
-000270a0: 7475 7328 0a20 2020 2020 2020 2020 2020  tus(.           
-000270b0: 2020 2020 206e 616d 652c 205b 2831 2c20       name, [(1, 
-000270c0: 4661 6c73 652c 205f 5345 5256 4943 455f  False, _SERVICE_
-000270d0: 4c41 554e 4348 494e 475f 5354 4154 5553  LAUNCHING_STATUS
-000270e0: 5f52 4547 4558 292c 0a20 2020 2020 2020  _REGEX),.       
-000270f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027100: 2832 2c20 4661 6c73 652c 2027 5245 4144  (2, False, 'READ
-00027110: 5927 295d 2920 2b0a 2020 2020 2020 2020  Y')]) +.        
-00027120: 2020 2020 5f63 6865 636b 5f73 6572 7669      _check_servi
-00027130: 6365 5f76 6572 7369 6f6e 286e 616d 652c  ce_version(name,
-00027140: 2022 3122 292c 0a20 2020 2020 2020 205d   "1"),.        ]
-00027150: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00027160: 280a 2020 2020 2020 2020 2774 6573 742d  (.        'test-
-00027170: 736b 7973 6572 7665 2d6e 6577 2d61 7574  skyserve-new-aut
-00027180: 6f73 6361 6c65 722d 7570 6461 7465 272c  oscaler-update',
-00027190: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-000271a0: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
-000271b0: 7665 2075 7020 2d6e 207b 6e61 6d65 7d20  ve up -n {name} 
-000271c0: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-000271d0: 5f63 6c6f 7564 7d20 2d79 2074 6573 7473  _cloud} -y tests
-000271e0: 2f73 6b79 7365 7276 652f 7570 6461 7465  /skyserve/update
-000271f0: 2f6e 6577 5f61 7574 6f73 6361 6c65 725f  /new_autoscaler_
-00027200: 6265 666f 7265 2e79 616d 6c27 2c0a 2020  before.yaml',.  
-00027210: 2020 2020 2020 2020 2020 5f53 4552 5645            _SERVE
-00027220: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
-00027230: 592e 666f 726d 6174 286e 616d 653d 6e61  Y.format(name=na
-00027240: 6d65 2c20 7265 706c 6963 615f 6e75 6d3d  me, replica_num=
-00027250: 3229 202b 0a20 2020 2020 2020 2020 2020  2) +.           
-00027260: 205f 6368 6563 6b5f 7365 7276 6963 655f   _check_service_
-00027270: 7665 7273 696f 6e28 6e61 6d65 2c20 2231  version(name, "1
-00027280: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-00027290: 6627 7b5f 5345 5256 455f 454e 4450 4f49  f'{_SERVE_ENDPOI
-000272a0: 4e54 5f57 4149 542e 666f 726d 6174 286e  NT_WAIT.format(n
-000272b0: 616d 653d 6e61 6d65 297d 3b20 270a 2020  ame=name)}; '.  
-000272c0: 2020 2020 2020 2020 2020 2773 3d24 2863            's=$(c
-000272d0: 7572 6c20 2d4c 2068 7474 703a 2f2f 2465  url -L http://$e
-000272e0: 6e64 706f 696e 7429 3b20 6563 686f 2022  ndpoint); echo "
-000272f0: 2473 223b 2065 6368 6f20 2224 7322 207c  $s"; echo "$s" |
-00027300: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
-00027310: 6c6f 7420 6865 7265 2227 2c0a 2020 2020  lot here"',.    
-00027320: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
-00027330: 7276 6520 7570 6461 7465 207b 6e61 6d65  rve update {name
-00027340: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
-00027350: 6963 5f63 6c6f 7564 7d20 2d2d 6d6f 6465  ic_cloud} --mode
-00027360: 207b 6d6f 6465 7d20 2d79 2074 6573 7473   {mode} -y tests
-00027370: 2f73 6b79 7365 7276 652f 7570 6461 7465  /skyserve/update
-00027380: 2f6e 6577 5f61 7574 6f73 6361 6c65 725f  /new_autoscaler_
-00027390: 6166 7465 722e 7961 6d6c 272c 0a20 2020  after.yaml',.   
-000273a0: 2020 2020 2020 2020 2023 2057 6169 7420           # Wait 
-000273b0: 666f 7220 7570 6461 7465 2074 6f20 6265  for update to be
-000273c0: 2072 6567 6973 7465 7265 640a 2020 2020   registered.    
-000273d0: 2020 2020 2020 2020 6627 736c 6565 7020          f'sleep 
-000273e0: 3132 3027 2c0a 2020 2020 2020 2020 2020  120',.          
-000273f0: 2020 5f63 6865 636b 5f72 6570 6c69 6361    _check_replica
-00027400: 5f69 6e5f 7374 6174 7573 280a 2020 2020  _in_status(.    
-00027410: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-00027420: 2c20 5b28 342c 2054 7275 652c 205f 5345  , [(4, True, _SE
-00027430: 5256 4943 455f 4c41 554e 4348 494e 475f  RVICE_LAUNCHING_
-00027440: 5354 4154 5553 5f52 4547 4558 202b 2027  STATUS_REGEX + '
-00027450: 5c7c 5245 4144 5927 292c 0a20 2020 2020  \|READY'),.     
-00027460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027470: 2020 2831 2c20 4661 6c73 652c 205f 5345    (1, False, _SE
-00027480: 5256 4943 455f 4c41 554e 4348 494e 475f  RVICE_LAUNCHING_
-00027490: 5354 4154 5553 5f52 4547 4558 292c 0a20  STATUS_REGEX),. 
-000274a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000274b0: 2020 2020 2020 2832 2c20 4661 6c73 652c        (2, False,
-000274c0: 2027 5245 4144 5927 295d 292c 0a20 2020   'READY')]),.   
-000274d0: 2020 2020 2020 2020 202a 7570 6461 7465           *update
-000274e0: 5f63 6865 636b 2c0a 2020 2020 2020 2020  _check,.        
-000274f0: 2020 2020 5f53 4552 5645 5f57 4149 545f      _SERVE_WAIT_
-00027500: 554e 5449 4c5f 5245 4144 592e 666f 726d  UNTIL_READY.form
-00027510: 6174 286e 616d 653d 6e61 6d65 2c20 7265  at(name=name, re
-00027520: 706c 6963 615f 6e75 6d3d 3529 2c0a 2020  plica_num=5),.  
-00027530: 2020 2020 2020 2020 2020 6627 7b5f 5345            f'{_SE
-00027540: 5256 455f 454e 4450 4f49 4e54 5f57 4149  RVE_ENDPOINT_WAI
-00027550: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
-00027560: 6d65 297d 3b20 270a 2020 2020 2020 2020  me)}; '.        
-00027570: 2020 2020 2763 7572 6c20 2d4c 2068 7474      'curl -L htt
-00027580: 703a 2f2f 2465 6e64 706f 696e 7420 7c20  p://$endpoint | 
-00027590: 6772 6570 2022 4869 2c20 536b 7950 696c  grep "Hi, SkyPil
-000275a0: 6f74 2068 6572 6522 272c 0a20 2020 2020  ot here"',.     
-000275b0: 2020 2020 2020 205f 6368 6563 6b5f 7265         _check_re
-000275c0: 706c 6963 615f 696e 5f73 7461 7475 7328  plica_in_status(
-000275d0: 6e61 6d65 2c20 5b28 342c 2054 7275 652c  name, [(4, True,
-000275e0: 2027 5245 4144 5927 292c 0a20 2020 2020   'READY'),.     
-000275f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027610: 2020 2020 2020 2028 312c 2046 616c 7365         (1, False
-00027620: 2c20 2752 4541 4459 2729 5d29 2c0a 2020  , 'READY')]),.  
-00027630: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00027640: 205f 5445 4152 444f 574e 5f53 4552 5649   _TEARDOWN_SERVI
-00027650: 4345 2e66 6f72 6d61 7428 6e61 6d65 3d6e  CE.format(name=n
-00027660: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
-00027670: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
-00027680: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00027690: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-000276a0: 7974 6573 742e 6d61 726b 2e73 6572 7665  ytest.mark.serve
-000276b0: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
-000276c0: 7665 5f66 6169 6c75 7265 7328 6765 6e65  ve_failures(gene
-000276d0: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
-000276e0: 0a20 2020 2022 2222 5465 7374 2072 6570  .    """Test rep
-000276f0: 6c69 6361 2066 6169 6c75 7265 2073 7461  lica failure sta
-00027700: 7475 7365 7322 2222 0a20 2020 206e 616d  tuses""".    nam
-00027710: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
-00027720: 5f6e 616d 6528 290a 0a20 2020 2074 6573  _name()..    tes
-00027730: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00027740: 2020 2774 6573 742d 736b 7973 6572 7665    'test-skyserve
-00027750: 2d66 6169 6c75 7265 7327 2c0a 2020 2020  -failures',.    
-00027760: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00027770: 2020 6627 736b 7920 7365 7276 6520 7570    f'sky serve up
-00027780: 202d 6e20 7b6e 616d 657d 202d 2d63 6c6f   -n {name} --clo
-00027790: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
-000277a0: 647d 202d 7920 7465 7374 732f 736b 7973  d} -y tests/skys
-000277b0: 6572 7665 2f66 6169 6c75 7265 732f 696e  erve/failures/in
-000277c0: 6974 6961 6c5f 6465 6c61 792e 7961 6d6c  itial_delay.yaml
-000277d0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000277e0: 2773 3d24 2873 6b79 2073 6572 7665 2073  's=$(sky serve s
-000277f0: 7461 7475 7320 7b6e 616d 657d 293b 2027  tatus {name}); '
-00027800: 0a20 2020 2020 2020 2020 2020 2066 2775  .            f'u
-00027810: 6e74 696c 2065 6368 6f20 2224 7322 207c  ntil echo "$s" |
-00027820: 2067 7265 7020 2246 4149 4c45 445f 494e   grep "FAILED_IN
-00027830: 4954 4941 4c5f 4445 4c41 5922 3b20 646f  ITIAL_DELAY"; do
-00027840: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-00027850: 6563 686f 2022 5761 6974 696e 6720 666f  echo "Waiting fo
-00027860: 7220 7265 706c 6963 6120 746f 2062 6520  r replica to be 
-00027870: 6661 696c 6564 2e2e 2e22 3b20 736c 6565  failed..."; slee
-00027880: 7020 353b 2027 0a20 2020 2020 2020 2020  p 5; '.         
-00027890: 2020 2066 2773 3d24 2873 6b79 2073 6572     f's=$(sky ser
-000278a0: 7665 2073 7461 7475 7320 7b6e 616d 657d  ve status {name}
-000278b0: 293b 2065 6368 6f20 2224 7322 3b20 646f  ); echo "$s"; do
-000278c0: 6e65 3b27 2c0a 2020 2020 2020 2020 2020  ne;',.          
-000278d0: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
-000278e0: 2020 2020 2020 2020 2020 6627 7b5f 5345            f'{_SE
-000278f0: 5256 455f 5354 4154 5553 5f57 4149 542e  RVE_STATUS_WAIT.
-00027900: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-00027910: 297d 3b20 6563 686f 2022 2473 2220 7c20  )}; echo "$s" | 
-00027920: 6772 6570 2022 7b6e 616d 657d 2220 7c20  grep "{name}" | 
-00027930: 6772 6570 2022 4641 494c 4544 5f49 4e49  grep "FAILED_INI
-00027940: 5449 414c 5f44 454c 4159 2220 7c20 7763  TIAL_DELAY" | wc
-00027950: 202d 6c20 7c20 6772 6570 2032 3b20 270a   -l | grep 2; '.
-00027960: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
-00027970: 6b65 2073 7572 6520 6e6f 206e 6577 2072  ke sure no new r
-00027980: 6570 6c69 6361 7320 6172 6520 7374 6172  eplicas are star
-00027990: 7465 6420 666f 7220 6561 726c 7920 6661  ted for early fa
-000279a0: 696c 7572 652e 0a20 2020 2020 2020 2020  ilure..         
-000279b0: 2020 2066 2765 6368 6f20 2224 7322 207c     f'echo "$s" |
-000279c0: 2067 7265 7020 2d41 2031 3030 2022 5365   grep -A 100 "Se
-000279d0: 7276 6963 6520 5265 706c 6963 6173 2220  rvice Replicas" 
-000279e0: 7c20 6772 6570 2022 7b6e 616d 657d 2220  | grep "{name}" 
-000279f0: 7c20 7763 202d 6c20 7c20 6772 6570 2032  | wc -l | grep 2
-00027a00: 3b27 2c0a 2020 2020 2020 2020 2020 2020  ;',.            
-00027a10: 6627 736b 7920 7365 7276 6520 7570 6461  f'sky serve upda
-00027a20: 7465 207b 6e61 6d65 7d20 2d2d 636c 6f75  te {name} --clou
-00027a30: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-00027a40: 7d20 2d79 2074 6573 7473 2f73 6b79 7365  } -y tests/skyse
-00027a50: 7276 652f 6661 696c 7572 6573 2f70 726f  rve/failures/pro
-00027a60: 6269 6e67 2e79 616d 6c27 2c0a 2020 2020  bing.yaml',.    
-00027a70: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-00027a80: 7920 7365 7276 6520 7374 6174 7573 207b  y serve status {
-00027a90: 6e61 6d65 7d29 3b20 270a 2020 2020 2020  name}); '.      
-00027aa0: 2020 2020 2020 2320 5761 6974 2066 6f72        # Wait for
-00027ab0: 2072 6570 6c69 6361 2074 6f20 6265 2072   replica to be r
-00027ac0: 6561 6479 2e0a 2020 2020 2020 2020 2020  eady..          
-00027ad0: 2020 6627 756e 7469 6c20 6563 686f 2022    f'until echo "
-00027ae0: 2473 2220 7c20 6772 6570 2022 5245 4144  $s" | grep "READ
-00027af0: 5922 3b20 646f 2027 0a20 2020 2020 2020  Y"; do '.       
-00027b00: 2020 2020 2027 6563 686f 2022 5761 6974       'echo "Wait
-00027b10: 696e 6720 666f 7220 7265 706c 6963 6120  ing for replica 
-00027b20: 746f 2062 6520 6661 696c 6564 2e2e 2e22  to be failed..."
-00027b30: 3b20 736c 6565 7020 353b 2027 0a20 2020  ; sleep 5; '.   
-00027b40: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-00027b50: 6b79 2073 6572 7665 2073 7461 7475 7320  ky serve status 
-00027b60: 7b6e 616d 657d 293b 2065 6368 6f20 2224  {name}); echo "$
-00027b70: 7322 3b20 646f 6e65 3b27 2c0a 2020 2020  s"; done;',.    
-00027b80: 2020 2020 2020 2020 2320 5761 6974 2066          # Wait f
-00027b90: 6f72 2072 6570 6c69 6361 2074 6f20 6368  or replica to ch
-00027ba0: 616e 6765 2074 6f20 4641 494c 4544 5f50  ange to FAILED_P
-00027bb0: 524f 4249 4e47 0a20 2020 2020 2020 2020  ROBING.         
-00027bc0: 2020 2066 2773 3d24 2873 6b79 2073 6572     f's=$(sky ser
-00027bd0: 7665 2073 7461 7475 7320 7b6e 616d 657d  ve status {name}
-00027be0: 293b 2027 0a20 2020 2020 2020 2020 2020  ); '.           
-00027bf0: 2066 2775 6e74 696c 2065 6368 6f20 2224   f'until echo "$
-00027c00: 7322 207c 2067 7265 7020 2246 4149 4c45  s" | grep "FAILE
-00027c10: 445f 5052 4f42 494e 4722 3b20 646f 2027  D_PROBING"; do '
-00027c20: 0a20 2020 2020 2020 2020 2020 2027 6563  .            'ec
-00027c30: 686f 2022 5761 6974 696e 6720 666f 7220  ho "Waiting for 
-00027c40: 7265 706c 6963 6120 746f 2062 6520 6661  replica to be fa
-00027c50: 696c 6564 2e2e 2e22 3b20 736c 6565 7020  iled..."; sleep 
-00027c60: 353b 2027 0a20 2020 2020 2020 2020 2020  5; '.           
-00027c70: 2066 2773 3d24 2873 6b79 2073 6572 7665   f's=$(sky serve
-00027c80: 2073 7461 7475 7320 7b6e 616d 657d 293b   status {name});
-00027c90: 2065 6368 6f20 2224 7322 3b20 646f 6e65   echo "$s"; done
-00027ca0: 3b27 202b 0a20 2020 2020 2020 2020 2020  ;' +.           
-00027cb0: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
-00027cc0: 696e 5f73 7461 7475 7328 0a20 2020 2020  in_status(.     
-00027cd0: 2020 2020 2020 2020 2020 206e 616d 652c             name,
-00027ce0: 205b 2831 2c20 4661 6c73 652c 2027 4641   [(1, False, 'FA
-00027cf0: 494c 4544 5f50 524f 4249 4e47 2729 2c0a  ILED_PROBING'),.
-00027d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027d10: 2020 2020 2020 2028 312c 2046 616c 7365         (1, False
-00027d20: 2c20 5f53 4552 5649 4345 5f4c 4155 4e43  , _SERVICE_LAUNC
-00027d30: 4849 4e47 5f53 5441 5455 535f 5245 4745  HING_STATUS_REGE
-00027d40: 5829 5d29 2c0a 2020 2020 2020 2020 2020  X)]),.          
-00027d50: 2020 2320 544f 444f 287a 6877 7529 3a20    # TODO(zhwu): 
-00027d60: 6164 6420 7465 7374 2066 6f72 2046 4149  add test for FAI
-00027d70: 4c45 445f 5052 4f56 4953 494f 4e0a 2020  LED_PROVISION.  
-00027d80: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00027d90: 205f 5445 4152 444f 574e 5f53 4552 5649   _TEARDOWN_SERVI
-00027da0: 4345 2e66 6f72 6d61 7428 6e61 6d65 3d6e  CE.format(name=n
-00027db0: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
-00027dc0: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
-00027dd0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00027de0: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-00027df0: 544f 444f 285a 696d 696e 672c 2054 6961  TODO(Ziming, Tia
-00027e00: 6e29 3a20 4164 6420 7465 7374 7320 666f  n): Add tests fo
-00027e10: 7220 6175 746f 7363 616c 696e 672e 0a0a  r autoscaling...
-00027e20: 0a23 202d 2d2d 2d2d 2d2d 2054 6573 7469  .# ------- Testi
-00027e30: 6e67 2075 7365 7220 7261 7920 636c 7573  ng user ray clus
-00027e40: 7465 7220 2d2d 2d2d 2d2d 2d2d 0a64 6566  ter --------.def
-00027e50: 2074 6573 745f 7573 6572 5f72 6179 5f63   test_user_ray_c
-00027e60: 6c75 7374 6572 2867 656e 6572 6963 5f63  luster(generic_c
-00027e70: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-00027e80: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-00027e90: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-00027ea0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-00027eb0: 2020 2020 2775 7365 722d 7261 792d 636c      'user-ray-cl
-00027ec0: 7573 7465 7227 2c0a 2020 2020 2020 2020  uster',.        
-00027ed0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-00027ee0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-00027ef0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-00027f00: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
-00027f10: 2272 6179 2073 7461 7274 202d 2d68 6561  "ray start --hea
-00027f20: 6422 272c 0a20 2020 2020 2020 2020 2020  d"',.           
-00027f30: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00027f40: 657d 2022 6563 686f 2068 6922 272c 0a20  e} "echo hi"',. 
-00027f50: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00027f60: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-00027f70: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-00027f80: 2020 2020 2020 6627 736b 7920 7374 6174        f'sky stat
-00027f90: 7573 202d 7220 7b6e 616d 657d 207c 2067  us -r {name} | g
-00027fa0: 7265 7020 5550 272c 0a20 2020 2020 2020  rep UP',.       
-00027fb0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00027fc0: 7b6e 616d 657d 2022 6563 686f 2062 7965  {name} "echo bye
-00027fd0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00027fe0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00027ff0: 7d20 3220 2d2d 7374 6174 7573 272c 0a20  } 2 --status',. 
-00028000: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00028010: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00028020: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-00028030: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00028040: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-00028050: 2d20 5465 7374 696e 6720 7468 6520 636f  - Testing the co
-00028060: 7265 2041 5049 202d 2d2d 2d2d 2d2d 2d0a  re API --------.
-00028070: 2320 4d6f 7374 206f 6620 7468 6520 636f  # Most of the co
-00028080: 7265 2041 5049 7320 6861 7665 2062 6565  re APIs have bee
-00028090: 6e20 7465 7374 6564 2069 6e20 7468 6520  n tested in the 
-000280a0: 434c 4920 7465 7374 732e 0a23 2054 6865  CLI tests..# The
-000280b0: 7365 2074 6573 7473 2061 7265 2066 6f72  se tests are for
-000280c0: 2074 6573 7469 6e67 2074 6865 2072 6574   testing the ret
-000280d0: 7572 6e20 7661 6c75 6520 6f66 2074 6865  urn value of the
-000280e0: 2041 5049 7320 6e6f 7420 6675 6c6c 7920   APIs not fully 
-000280f0: 7573 6564 2069 6e20 434c 492e 0a0a 0a40  used in CLI....@
-00028100: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
-00028110: 6465 6620 7465 7374 5f63 6f72 655f 6170  def test_core_ap
-00028120: 695f 736b 795f 6c61 756e 6368 5f65 7865  i_sky_launch_exe
-00028130: 6328 293a 0a20 2020 206e 616d 6520 3d20  c():.    name = 
-00028140: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00028150: 6528 290a 2020 2020 7461 736b 203d 2073  e().    task = s
-00028160: 6b79 2e54 6173 6b28 7275 6e3d 2277 686f  ky.Task(run="who
-00028170: 616d 6922 290a 2020 2020 7461 736b 2e73  ami").    task.s
-00028180: 6574 5f72 6573 6f75 7263 6573 2873 6b79  et_resources(sky
-00028190: 2e52 6573 6f75 7263 6573 2863 6c6f 7564  .Resources(cloud
-000281a0: 3d73 6b79 2e47 4350 2829 2929 0a20 2020  =sky.GCP())).   
-000281b0: 206a 6f62 5f69 642c 2068 616e 646c 6520   job_id, handle 
-000281c0: 3d20 736b 792e 6c61 756e 6368 2874 6173  = sky.launch(tas
-000281d0: 6b2c 2063 6c75 7374 6572 5f6e 616d 653d  k, cluster_name=
-000281e0: 6e61 6d65 290a 2020 2020 6173 7365 7274  name).    assert
-000281f0: 206a 6f62 5f69 6420 3d3d 2031 0a20 2020   job_id == 1.   
-00028200: 2061 7373 6572 7420 6861 6e64 6c65 2069   assert handle i
-00028210: 7320 6e6f 7420 4e6f 6e65 0a20 2020 2061  s not None.    a
-00028220: 7373 6572 7420 6861 6e64 6c65 2e63 6c75  ssert handle.clu
-00028230: 7374 6572 5f6e 616d 6520 3d3d 206e 616d  ster_name == nam
-00028240: 650a 2020 2020 6173 7365 7274 2068 616e  e.    assert han
-00028250: 646c 652e 6c61 756e 6368 6564 5f72 6573  dle.launched_res
-00028260: 6f75 7263 6573 2e63 6c6f 7564 2e69 735f  ources.cloud.is_
-00028270: 7361 6d65 5f63 6c6f 7564 2873 6b79 2e47  same_cloud(sky.G
-00028280: 4350 2829 290a 2020 2020 6a6f 625f 6964  CP()).    job_id
-00028290: 5f65 7865 632c 2068 616e 646c 655f 6578  _exec, handle_ex
-000282a0: 6563 203d 2073 6b79 2e65 7865 6328 7461  ec = sky.exec(ta
-000282b0: 736b 2c20 636c 7573 7465 725f 6e61 6d65  sk, cluster_name
-000282c0: 3d6e 616d 6529 0a20 2020 2061 7373 6572  =name).    asser
-000282d0: 7420 6a6f 625f 6964 5f65 7865 6320 3d3d  t job_id_exec ==
-000282e0: 2032 0a20 2020 2061 7373 6572 7420 6861   2.    assert ha
-000282f0: 6e64 6c65 5f65 7865 6320 6973 206e 6f74  ndle_exec is not
-00028300: 204e 6f6e 650a 2020 2020 6173 7365 7274   None.    assert
-00028310: 2068 616e 646c 655f 6578 6563 2e63 6c75   handle_exec.clu
-00028320: 7374 6572 5f6e 616d 6520 3d3d 206e 616d  ster_name == nam
-00028330: 650a 2020 2020 6173 7365 7274 2068 616e  e.    assert han
-00028340: 646c 655f 6578 6563 2e6c 6175 6e63 6865  dle_exec.launche
-00028350: 645f 7265 736f 7572 6365 732e 636c 6f75  d_resources.clou
-00028360: 642e 6973 5f73 616d 655f 636c 6f75 6428  d.is_same_cloud(
-00028370: 736b 792e 4743 5028 2929 0a20 2020 2023  sky.GCP()).    #
-00028380: 2046 6f72 2064 756d 6d79 2074 6173 6b20   For dummy task 
-00028390: 2869 2e65 2e20 7461 736b 2e72 756e 2069  (i.e. task.run i
-000283a0: 7320 4e6f 6e65 292c 2074 6865 206a 6f62  s None), the job
-000283b0: 2077 6f6e 2774 2062 6520 7375 626d 6974   won't be submit
-000283c0: 7465 642e 0a20 2020 2064 756d 6d79 5f74  ted..    dummy_t
-000283d0: 6173 6b20 3d20 736b 792e 5461 736b 2829  ask = sky.Task()
-000283e0: 0a20 2020 206a 6f62 5f69 645f 6475 6d6d  .    job_id_dumm
-000283f0: 792c 205f 203d 2073 6b79 2e65 7865 6328  y, _ = sky.exec(
-00028400: 6475 6d6d 795f 7461 736b 2c20 636c 7573  dummy_task, clus
-00028410: 7465 725f 6e61 6d65 3d6e 616d 6529 0a20  ter_name=name). 
-00028420: 2020 2061 7373 6572 7420 6a6f 625f 6964     assert job_id
-00028430: 5f64 756d 6d79 2069 7320 4e6f 6e65 0a20  _dummy is None. 
-00028440: 2020 2073 6b79 2e64 6f77 6e28 6e61 6d65     sky.down(name
-00028450: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
-00028460: 2054 6573 7469 6e67 2053 746f 7261 6765   Testing Storage
-00028470: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 636c 6173   ----------.clas
-00028480: 7320 5465 7374 5374 6f72 6167 6557 6974  s TestStorageWit
-00028490: 6843 7265 6465 6e74 6961 6c73 3a0a 2020  hCredentials:.  
-000284a0: 2020 2222 2253 746f 7261 6765 2074 6573    """Storage tes
-000284b0: 7473 2077 6869 6368 2072 6571 7569 7265  ts which require
-000284c0: 2063 7265 6465 6e74 6961 6c73 2061 6e64   credentials and
-000284d0: 206e 6574 776f 726b 2063 6f6e 6e65 6374   network connect
-000284e0: 696f 6e22 2222 0a0a 2020 2020 4157 535f  ion"""..    AWS_
-000284f0: 494e 5641 4c49 445f 4e41 4d45 5320 3d20  INVALID_NAMES = 
-00028500: 5b0a 2020 2020 2020 2020 2761 6227 2c20  [.        'ab', 
-00028510: 2023 206c 6573 7320 7468 616e 2033 2063   # less than 3 c
-00028520: 6861 7261 6374 6572 730a 2020 2020 2020  haracters.      
-00028530: 2020 2761 6263 6465 6667 6869 6a6b 6c6d    'abcdefghijklm
-00028540: 6e6f 7071 7273 7475 7677 7879 7a61 6263  nopqrstuvwxyzabc
-00028550: 6465 6667 6869 6a6b 6c6d 6e6f 7071 7273  defghijklmnopqrs
-00028560: 7475 7677 7879 7a61 6263 6465 6667 6869  tuvwxyzabcdefghi
-00028570: 6a6b 6c6d 6e6f 7071 7273 7475 7677 7879  jklmnopqrstuvwxy
-00028580: 7a31 272c 0a20 2020 2020 2020 2023 206d  z1',.        # m
-00028590: 6f72 6520 7468 616e 2036 3320 6368 6172  ore than 63 char
-000285a0: 6163 7465 7273 0a20 2020 2020 2020 2027  acters.        '
-000285b0: 4162 6364 6566 272c 2020 2320 636f 6e74  Abcdef',  # cont
-000285c0: 6169 6e73 2061 6e20 7570 7065 7263 6173  ains an uppercas
-000285d0: 6520 6c65 7474 6572 0a20 2020 2020 2020  e letter.       
-000285e0: 2027 6162 6320 6465 6627 2c20 2023 2063   'abc def',  # c
-000285f0: 6f6e 7461 696e 7320 6120 7370 6163 650a  ontains a space.
-00028600: 2020 2020 2020 2020 2761 6263 2e2e 6465          'abc..de
-00028610: 6627 2c20 2023 2074 776f 2061 646a 6163  f',  # two adjac
-00028620: 656e 7420 7065 7269 6f64 730a 2020 2020  ent periods.    
-00028630: 2020 2020 2731 3932 2e31 3638 2e35 2e34      '192.168.5.4
-00028640: 272c 2020 2320 666f 726d 6174 7465 6420  ',  # formatted 
-00028650: 6173 2061 6e20 4950 2061 6464 7265 7373  as an IP address
-00028660: 0a20 2020 2020 2020 2027 786e 2d2d 6275  .        'xn--bu
-00028670: 636b 6574 272c 2020 2320 7374 6172 7473  cket',  # starts
-00028680: 2077 6974 6820 2778 6e2d 2d27 2070 7265   with 'xn--' pre
-00028690: 6669 780a 2020 2020 2020 2020 2762 7563  fix.        'buc
-000286a0: 6b65 742d 7333 616c 6961 7327 2c20 2023  ket-s3alias',  #
-000286b0: 2065 6e64 7320 7769 7468 2027 2d73 3361   ends with '-s3a
-000286c0: 6c69 6173 2720 7375 6666 6978 0a20 2020  lias' suffix.   
-000286d0: 2020 2020 2027 6275 636b 6574 2d2d 6f6c       'bucket--ol
-000286e0: 2d73 3327 2c20 2023 2065 6e64 7320 7769  -s3',  # ends wi
-000286f0: 7468 2027 2d2d 6f6c 2d73 3327 2073 7566  th '--ol-s3' suf
-00028700: 6669 780a 2020 2020 2020 2020 272e 6162  fix.        '.ab
-00028710: 6327 2c20 2023 2073 7461 7274 7320 7769  c',  # starts wi
-00028720: 7468 2061 2064 6f74 0a20 2020 2020 2020  th a dot.       
-00028730: 2027 6162 632e 272c 2020 2320 656e 6473   'abc.',  # ends
-00028740: 2077 6974 6820 6120 646f 740a 2020 2020   with a dot.    
-00028750: 2020 2020 272d 6162 6327 2c20 2023 2073      '-abc',  # s
-00028760: 7461 7274 7320 7769 7468 2061 2068 7970  tarts with a hyp
-00028770: 6865 6e0a 2020 2020 2020 2020 2761 6263  hen.        'abc
-00028780: 2d27 2c20 2023 2065 6e64 7320 7769 7468  -',  # ends with
-00028790: 2061 2068 7970 6865 6e0a 2020 2020 5d0a   a hyphen.    ].
-000287a0: 0a20 2020 2047 4353 5f49 4e56 414c 4944  .    GCS_INVALID
-000287b0: 5f4e 414d 4553 203d 205b 0a20 2020 2020  _NAMES = [.     
-000287c0: 2020 2027 6162 272c 2020 2320 6c65 7373     'ab',  # less
-000287d0: 2074 6861 6e20 3320 6368 6172 6163 7465   than 3 characte
-000287e0: 7273 0a20 2020 2020 2020 2027 6162 6364  rs.        'abcd
-000287f0: 6566 6768 696a 6b6c 6d6e 6f70 7172 7374  efghijklmnopqrst
-00028800: 7576 7778 797a 6162 6364 6566 6768 696a  uvwxyzabcdefghij
-00028810: 6b6c 6d6e 6f70 7172 7374 7576 7778 797a  klmnopqrstuvwxyz
-00028820: 6162 6364 6566 6768 696a 6b6c 6d6e 6f70  abcdefghijklmnop
-00028830: 7172 7374 7576 7778 797a 3127 2c0a 2020  qrstuvwxyz1',.  
-00028840: 2020 2020 2020 2320 6d6f 7265 2074 6861        # more tha
-00028850: 6e20 3633 2063 6861 7261 6374 6572 7320  n 63 characters 
-00028860: 2877 6974 686f 7574 2064 6f74 7329 0a20  (without dots). 
-00028870: 2020 2020 2020 2027 4162 6364 6566 272c         'Abcdef',
-00028880: 2020 2320 636f 6e74 6169 6e73 2061 6e20    # contains an 
-00028890: 7570 7065 7263 6173 6520 6c65 7474 6572  uppercase letter
-000288a0: 0a20 2020 2020 2020 2027 6162 6320 6465  .        'abc de
-000288b0: 6627 2c20 2023 2063 6f6e 7461 696e 7320  f',  # contains 
-000288c0: 6120 7370 6163 650a 2020 2020 2020 2020  a space.        
-000288d0: 2761 6263 2e2e 6465 6627 2c20 2023 2074  'abc..def',  # t
-000288e0: 776f 2061 646a 6163 656e 7420 7065 7269  wo adjacent peri
-000288f0: 6f64 730a 2020 2020 2020 2020 2761 6263  ods.        'abc
-00028900: 5f2e 6465 662e 6768 692e 6a6b 6c6d 6e6f  _.def.ghi.jklmno
-00028910: 7071 7273 7475 7677 7879 7a61 6263 6465  pqrstuvwxyzabcde
-00028920: 6667 6869 6a6b 6c6d 6e6f 7071 7273 7475  fghijklmnopqrstu
-00028930: 7677 7879 7a61 6263 6465 6667 6869 6a6b  vwxyzabcdefghijk
-00028940: 6c6d 6e6f 7071 7273 7475 7677 7879 7a31  lmnopqrstuvwxyz1
-00028950: 270a 2020 2020 2020 2020 2320 4d6f 7265  '.        # More
-00028960: 2074 6861 6e20 3633 2063 6861 7261 6374   than 63 charact
-00028970: 6572 7320 6265 7477 6565 6e20 646f 7473  ers between dots
-00028980: 0a20 2020 2020 2020 2027 6162 635f 2e64  .        'abc_.d
-00028990: 6566 2e67 6869 2e6a 6b6c 6d6e 6f70 7172  ef.ghi.jklmnopqr
-000289a0: 7374 7576 7778 797a 6162 6364 6566 6768  stuvwxyzabcdefgh
-000289b0: 696a 6b6c 6d6e 6f70 7166 6768 696a 6b6c  ijklmnopqfghijkl
-000289c0: 6d6e 6f70 7172 7374 7576 7727 202a 2035  mnopqrstuvw' * 5
-000289d0: 2c0a 2020 2020 2020 2020 2320 6d6f 7265  ,.        # more
-000289e0: 2074 6861 6e20 3232 3220 6368 6172 6163   than 222 charac
-000289f0: 7465 7273 2028 7769 7468 2064 6f74 7329  ters (with dots)
-00028a00: 0a20 2020 2020 2020 2027 3139 322e 3136  .        '192.16
-00028a10: 382e 352e 3427 2c20 2023 2066 6f72 6d61  8.5.4',  # forma
-00028a20: 7474 6564 2061 7320 616e 2049 5020 6164  tted as an IP ad
-00028a30: 6472 6573 730a 2020 2020 2020 2020 2767  dress.        'g
-00028a40: 6f6f 6762 7563 6b65 7427 2c20 2023 2073  oogbucket',  # s
-00028a50: 7461 7274 7320 7769 7468 2027 676f 6f67  tarts with 'goog
-00028a60: 2720 7072 6566 6978 0a20 2020 2020 2020  ' prefix.       
-00028a70: 2027 676f 6f67 6c65 6275 636b 6574 272c   'googlebucket',
-00028a80: 2020 2320 636f 6e74 6169 6e73 2027 676f    # contains 'go
-00028a90: 6f67 6c65 270a 2020 2020 2020 2020 2767  ogle'.        'g
-00028aa0: 3030 676c 6562 7563 6b65 7427 2c20 2023  00glebucket',  #
-00028ab0: 2076 6172 6961 6e74 206f 6620 2767 6f6f   variant of 'goo
-00028ac0: 676c 6527 0a20 2020 2020 2020 2027 676f  gle'.        'go
-00028ad0: 3067 6c65 6275 636b 6574 272c 2020 2320  0glebucket',  # 
-00028ae0: 7661 7269 616e 7420 6f66 2027 676f 6f67  variant of 'goog
-00028af0: 6c65 270a 2020 2020 2020 2020 2767 306f  le'.        'g0o
-00028b00: 676c 6562 7563 6b65 7427 2c20 2023 2076  glebucket',  # v
-00028b10: 6172 6961 6e74 206f 6620 2767 6f6f 676c  ariant of 'googl
-00028b20: 6527 0a20 2020 2020 2020 2027 2e61 6263  e'.        '.abc
-00028b30: 272c 2020 2320 7374 6172 7473 2077 6974  ',  # starts wit
-00028b40: 6820 6120 646f 740a 2020 2020 2020 2020  h a dot.        
-00028b50: 2761 6263 2e27 2c20 2023 2065 6e64 7320  'abc.',  # ends 
-00028b60: 7769 7468 2061 2064 6f74 0a20 2020 2020  with a dot.     
-00028b70: 2020 2027 5f61 6263 272c 2020 2320 7374     '_abc',  # st
-00028b80: 6172 7473 2077 6974 6820 616e 2075 6e64  arts with an und
-00028b90: 6572 7363 6f72 650a 2020 2020 2020 2020  erscore.        
-00028ba0: 2761 6263 5f27 2c20 2023 2065 6e64 7320  'abc_',  # ends 
-00028bb0: 7769 7468 2061 6e20 756e 6465 7273 636f  with an undersco
-00028bc0: 7265 0a20 2020 205d 0a0a 2020 2020 4942  re.    ]..    IB
-00028bd0: 4d5f 494e 5641 4c49 445f 4e41 4d45 5320  M_INVALID_NAMES 
-00028be0: 3d20 5b0a 2020 2020 2020 2020 2761 6227  = [.        'ab'
-00028bf0: 2c20 2023 206c 6573 7320 7468 616e 2033  ,  # less than 3
-00028c00: 2063 6861 7261 6374 6572 730a 2020 2020   characters.    
-00028c10: 2020 2020 2761 6263 6465 6667 6869 6a6b      'abcdefghijk
-00028c20: 6c6d 6e6f 7071 7273 7475 7677 7879 7a61  lmnopqrstuvwxyza
-00028c30: 6263 6465 6667 6869 6a6b 6c6d 6e6f 7071  bcdefghijklmnopq
-00028c40: 7273 7475 7677 7879 7a61 6263 6465 6667  rstuvwxyzabcdefg
-00028c50: 6869 6a6b 6c6d 6e6f 7071 7273 7475 7677  hijklmnopqrstuvw
-00028c60: 7879 7a31 272c 0a20 2020 2020 2020 2023  xyz1',.        #
-00028c70: 206d 6f72 6520 7468 616e 2036 3320 6368   more than 63 ch
-00028c80: 6172 6163 7465 7273 0a20 2020 2020 2020  aracters.       
-00028c90: 2027 4162 6364 6566 272c 2020 2320 636f   'Abcdef',  # co
-00028ca0: 6e74 6169 6e73 2061 6e20 7570 7065 7263  ntains an upperc
-00028cb0: 6173 6520 6c65 7474 6572 0a20 2020 2020  ase letter.     
-00028cc0: 2020 2027 6162 6320 6465 6627 2c20 2023     'abc def',  #
-00028cd0: 2063 6f6e 7461 696e 7320 6120 7370 6163   contains a spac
-00028ce0: 650a 2020 2020 2020 2020 2761 6263 2e2e  e.        'abc..
-00028cf0: 6465 6627 2c20 2023 2074 776f 2061 646a  def',  # two adj
-00028d00: 6163 656e 7420 7065 7269 6f64 730a 2020  acent periods.  
-00028d10: 2020 2020 2020 2731 3932 2e31 3638 2e35        '192.168.5
-00028d20: 2e34 272c 2020 2320 666f 726d 6174 7465  .4',  # formatte
-00028d30: 6420 6173 2061 6e20 4950 2061 6464 7265  d as an IP addre
-00028d40: 7373 0a20 2020 2020 2020 2027 786e 2d2d  ss.        'xn--
-00028d50: 6275 636b 6574 272c 2020 2320 7374 6172  bucket',  # star
-00028d60: 7473 2077 6974 6820 2778 6e2d 2d27 2070  ts with 'xn--' p
-00028d70: 7265 6669 780a 2020 2020 2020 2020 272e  refix.        '.
-00028d80: 6162 6327 2c20 2023 2073 7461 7274 7320  abc',  # starts 
-00028d90: 7769 7468 2061 2064 6f74 0a20 2020 2020  with a dot.     
-00028da0: 2020 2027 6162 632e 272c 2020 2320 656e     'abc.',  # en
-00028db0: 6473 2077 6974 6820 6120 646f 740a 2020  ds with a dot.  
-00028dc0: 2020 2020 2020 272d 6162 6327 2c20 2023        '-abc',  #
-00028dd0: 2073 7461 7274 7320 7769 7468 2061 2068   starts with a h
-00028de0: 7970 6865 6e0a 2020 2020 2020 2020 2761  yphen.        'a
-00028df0: 6263 2d27 2c20 2023 2065 6e64 7320 7769  bc-',  # ends wi
-00028e00: 7468 2061 2068 7970 6865 6e0a 2020 2020  th a hyphen.    
-00028e10: 2020 2020 2761 2e2d 6263 272c 2020 2320      'a.-bc',  # 
-00028e20: 636f 6e74 6169 6e73 2074 6865 2073 6571  contains the seq
-00028e30: 7565 6e63 6520 272e 2d27 0a20 2020 2020  uence '.-'.     
-00028e40: 2020 2027 612d 2e62 6327 2c20 2023 2063     'a-.bc',  # c
-00028e50: 6f6e 7461 696e 7320 7468 6520 7365 7175  ontains the sequ
-00028e60: 656e 6365 2027 2d2e 270a 2020 2020 2020  ence '-.'.      
-00028e70: 2020 2761 2662 6327 2020 2320 636f 6e74    'a&bc'  # cont
-00028e80: 6169 6e73 2073 7065 6369 616c 2063 6861  ains special cha
-00028e90: 7261 6374 6572 730a 2020 2020 2020 2020  racters.        
-00028ea0: 2761 625e 6327 2020 2320 636f 6e74 6169  'ab^c'  # contai
-00028eb0: 6e73 2073 7065 6369 616c 2063 6861 7261  ns special chara
-00028ec0: 6374 6572 730a 2020 2020 5d0a 2020 2020  cters.    ].    
-00028ed0: 4749 5449 474e 4f52 455f 5359 4e43 5f54  GITIGNORE_SYNC_T
-00028ee0: 4553 545f 4449 525f 5354 5255 4354 5552  EST_DIR_STRUCTUR
-00028ef0: 4520 3d20 7b0a 2020 2020 2020 2020 2764  E = {.        'd
-00028f00: 6f75 626c 655f 6173 7465 7269 736b 273a  ouble_asterisk':
-00028f10: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
-00028f20: 646f 7562 6c65 5f61 7374 6572 6973 6b5f  double_asterisk_
-00028f30: 6578 636c 7564 6564 273a 204e 6f6e 652c  excluded': None,
-00028f40: 0a20 2020 2020 2020 2020 2020 2027 646f  .            'do
-00028f50: 7562 6c65 5f61 7374 6572 6973 6b5f 6578  uble_asterisk_ex
-00028f60: 636c 7564 6564 5f64 6972 273a 207b 0a20  cluded_dir': {. 
-00028f70: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00028f80: 6469 725f 6578 636c 7564 6564 273a 204e  dir_excluded': N
-00028f90: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-00028fa0: 207d 2c0a 2020 2020 2020 2020 7d2c 0a20   },.        },. 
-00028fb0: 2020 2020 2020 2027 646f 7562 6c65 5f61         'double_a
-00028fc0: 7374 6572 6973 6b5f 7061 7265 6e74 273a  sterisk_parent':
-00028fd0: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
-00028fe0: 7061 7265 6e74 273a 207b 0a20 2020 2020  parent': {.     
-00028ff0: 2020 2020 2020 2020 2020 2027 616c 736f             'also
-00029000: 5f65 7863 6c75 6465 642e 7478 7427 3a20  _excluded.txt': 
-00029010: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-00029020: 2020 2020 2020 2763 6869 6c64 273a 207b        'child': {
-00029030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029040: 2020 2020 2027 646f 7562 6c65 5f61 7374       'double_ast
-00029050: 6572 6973 6b5f 7061 7265 6e74 5f63 6869  erisk_parent_chi
-00029060: 6c64 5f65 7863 6c75 6465 642e 7478 7427  ld_excluded.txt'
-00029070: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-00029080: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-00029090: 2020 2020 2020 2020 2020 2027 646f 7562             'doub
-000290a0: 6c65 5f61 7374 6572 6973 6b5f 7061 7265  le_asterisk_pare
-000290b0: 6e74 5f65 7863 6c75 6465 642e 7478 7427  nt_excluded.txt'
-000290c0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-000290d0: 2020 2020 7d2c 0a20 2020 2020 2020 207d      },.        }
-000290e0: 2c0a 2020 2020 2020 2020 2765 7863 6c75  ,.        'exclu
-000290f0: 6465 642e 6c6f 6727 3a20 4e6f 6e65 2c0a  ded.log': None,.
-00029100: 2020 2020 2020 2020 2765 7863 6c75 6465          'exclude
-00029110: 645f 6469 7227 3a20 7b0a 2020 2020 2020  d_dir': {.      
-00029120: 2020 2020 2020 2765 7863 6c75 6465 642e        'excluded.
-00029130: 7478 7427 3a20 4e6f 6e65 2c0a 2020 2020  txt': None,.    
-00029140: 2020 2020 2020 2020 276e 6573 7465 645f          'nested_
-00029150: 6578 636c 7564 6564 273a 207b 0a20 2020  excluded': {.   
-00029160: 2020 2020 2020 2020 2020 2020 2027 6578               'ex
-00029170: 636c 7564 6564 273a 204e 6f6e 652c 0a20  cluded': None,. 
-00029180: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
-00029190: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-000291a0: 2027 6578 702d 3127 3a20 7b0a 2020 2020   'exp-1': {.    
-000291b0: 2020 2020 2020 2020 2762 655f 6578 636c          'be_excl
-000291c0: 7564 6564 273a 204e 6f6e 652c 0a20 2020  uded': None,.   
-000291d0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-000291e0: 2765 7870 2d32 273a 207b 0a20 2020 2020  'exp-2': {.     
-000291f0: 2020 2020 2020 2027 6265 5f65 7863 6c75         'be_exclu
-00029200: 6465 6427 3a20 4e6f 6e65 2c0a 2020 2020  ded': None,.    
-00029210: 2020 2020 7d2c 0a20 2020 2020 2020 2027      },.        '
-00029220: 6672 6f6e 745f 736c 6173 685f 6578 636c  front_slash_excl
-00029230: 7564 6564 273a 204e 6f6e 652c 0a20 2020  uded': None,.   
-00029240: 2020 2020 2027 696e 636c 7564 6564 2e6c       'included.l
-00029250: 6f67 273a 204e 6f6e 652c 0a20 2020 2020  og': None,.     
-00029260: 2020 2027 696e 636c 7564 6564 2e74 7874     'included.txt
-00029270: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-00029280: 2027 696e 636c 7564 655f 6469 7227 3a20   'include_dir': 
-00029290: 7b0a 2020 2020 2020 2020 2020 2020 2765  {.            'e
-000292a0: 7863 6c75 6465 642e 6c6f 6727 3a20 4e6f  xcluded.log': No
-000292b0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-000292c0: 2769 6e63 6c75 6465 642e 6c6f 6727 3a20  'included.log': 
-000292d0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7d2c  None,.        },
-000292e0: 0a20 2020 2020 2020 2027 6e65 7374 6564  .        'nested
-000292f0: 5f64 6f75 626c 655f 6173 7465 7269 736b  _double_asterisk
-00029300: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-00029310: 2027 6f6e 6527 3a20 7b0a 2020 2020 2020   'one': {.      
-00029320: 2020 2020 2020 2020 2020 2761 6c73 6f5f            'also_
-00029330: 6578 636c 7564 652e 7478 7427 3a20 4e6f  exclude.txt': No
-00029340: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00029350: 7d2c 0a20 2020 2020 2020 2020 2020 2027  },.            '
-00029360: 7477 6f27 3a20 7b0a 2020 2020 2020 2020  two': {.        
-00029370: 2020 2020 2020 2020 2761 6c73 6f5f 6578          'also_ex
-00029380: 636c 7564 652e 7478 7427 3a20 4e6f 6e65  clude.txt': None
-00029390: 2c0a 2020 2020 2020 2020 2020 2020 7d2c  ,.            },
-000293a0: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
-000293b0: 2020 2020 276e 6573 7465 645f 7769 6c64      'nested_wild
-000293c0: 6361 7264 5f64 6972 273a 207b 0a20 2020  card_dir': {.   
-000293d0: 2020 2020 2020 2020 2027 6d6f 6e64 6179           'monday
-000293e0: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-000293f0: 2020 2020 2027 616c 736f 5f65 7863 6c75       'also_exclu
-00029400: 6465 2e74 7874 273a 204e 6f6e 652c 0a20  de.txt': None,. 
-00029410: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
-00029420: 2020 2020 2020 2020 2020 2774 7565 7364            'tuesd
-00029430: 6179 273a 207b 0a20 2020 2020 2020 2020  ay': {.         
-00029440: 2020 2020 2020 2027 616c 736f 5f65 7863         'also_exc
-00029450: 6c75 6465 2e74 7874 273a 204e 6f6e 652c  lude.txt': None,
-00029460: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
-00029470: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-00029480: 2020 2027 6e6f 5f73 6c61 7368 5f65 7863     'no_slash_exc
-00029490: 6c75 6465 6427 3a20 4e6f 6e65 2c0a 2020  luded': None,.  
-000294a0: 2020 2020 2020 276e 6f5f 736c 6173 685f        'no_slash_
-000294b0: 7465 7374 7327 3a20 7b0a 2020 2020 2020  tests': {.      
-000294c0: 2020 2020 2020 276e 6f5f 736c 6173 685f        'no_slash_
-000294d0: 6578 636c 7564 6564 273a 207b 0a20 2020  excluded': {.   
-000294e0: 2020 2020 2020 2020 2020 2020 2027 616c               'al
-000294f0: 736f 5f65 7863 6c75 6465 642e 7478 7427  so_excluded.txt'
-00029500: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-00029510: 2020 2020 7d2c 0a20 2020 2020 2020 207d      },.        }
-00029520: 2c0a 2020 2020 2020 2020 2771 7565 7374  ,.        'quest
-00029530: 696f 6e5f 6d61 726b 273a 207b 0a20 2020  ion_mark': {.   
-00029540: 2020 2020 2020 2020 2027 6578 636c 7564           'exclud
-00029550: 6564 312e 7478 7427 3a20 4e6f 6e65 2c0a  ed1.txt': None,.
-00029560: 2020 2020 2020 2020 2020 2020 2765 7863              'exc
-00029570: 6c75 6465 6440 2e74 7874 273a 204e 6f6e  luded@.txt': Non
-00029580: 652c 0a20 2020 2020 2020 207d 2c0a 2020  e,.        },.  
-00029590: 2020 2020 2020 2773 7175 6172 655f 6272        'square_br
-000295a0: 6163 6b65 7427 3a20 7b0a 2020 2020 2020  acket': {.      
-000295b0: 2020 2020 2020 2765 7863 6c75 6465 6431        'excluded1
-000295c0: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
-000295d0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-000295e0: 2773 7175 6172 655f 6272 6163 6b65 745f  'square_bracket_
-000295f0: 616c 7068 6127 3a20 7b0a 2020 2020 2020  alpha': {.      
-00029600: 2020 2020 2020 2765 7863 6c75 6465 647a        'excludedz
-00029610: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
-00029620: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-00029630: 2773 7175 6172 655f 6272 6163 6b65 745f  'square_bracket_
-00029640: 6578 636c 6127 3a20 7b0a 2020 2020 2020  excla': {.      
-00029650: 2020 2020 2020 2765 7863 6c75 6465 6432        'excluded2
-00029660: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
-00029670: 2020 2020 2020 2020 2027 6578 636c 7564           'exclud
-00029680: 6564 402e 7478 7427 3a20 4e6f 6e65 2c0a  ed@.txt': None,.
-00029690: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-000296a0: 2020 2027 7371 7561 7265 5f62 7261 636b     'square_brack
-000296b0: 6574 5f73 696e 676c 6527 3a20 7b0a 2020  et_single': {.  
-000296c0: 2020 2020 2020 2020 2020 2765 7863 6c75            'exclu
-000296d0: 6465 6430 2e74 7874 273a 204e 6f6e 652c  ded0.txt': None,
-000296e0: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
-000296f0: 7d0a 0a20 2020 2040 7374 6174 6963 6d65  }..    @staticme
-00029700: 7468 6f64 0a20 2020 2064 6566 2063 7265  thod.    def cre
-00029710: 6174 655f 6469 725f 7374 7275 6374 7572  ate_dir_structur
-00029720: 6528 6261 7365 5f70 6174 682c 2073 7472  e(base_path, str
-00029730: 7563 7475 7265 293a 0a20 2020 2020 2020  ucture):.       
-00029740: 2023 2063 7265 6174 6573 2061 2067 6976   # creates a giv
-00029750: 656e 2066 696c 6520 5354 5255 4354 5552  en file STRUCTUR
-00029760: 4520 696e 2042 4153 455f 5041 5448 0a20  E in BASE_PATH. 
-00029770: 2020 2020 2020 2066 6f72 206e 616d 652c         for name,
-00029780: 2073 7562 7374 7275 6374 7572 6520 696e   substructure in
-00029790: 2073 7472 7563 7475 7265 2e69 7465 6d73   structure.items
-000297a0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-000297b0: 7061 7468 203d 206f 732e 7061 7468 2e6a  path = os.path.j
-000297c0: 6f69 6e28 6261 7365 5f70 6174 682c 206e  oin(base_path, n
-000297d0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-000297e0: 2069 6620 7375 6273 7472 7563 7475 7265   if substructure
-000297f0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00029800: 2020 2020 2020 2020 2020 2320 4372 6561            # Crea
-00029810: 7465 2061 2066 696c 650a 2020 2020 2020  te a file.      
-00029820: 2020 2020 2020 2020 2020 6f70 656e 2870            open(p
-00029830: 6174 682c 2027 6127 2c20 656e 636f 6469  ath, 'a', encodi
-00029840: 6e67 3d27 7574 662d 3827 292e 636c 6f73  ng='utf-8').clos
-00029850: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
-00029860: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00029870: 2020 2020 2020 2320 4372 6561 7465 2061        # Create a
-00029880: 2073 7562 6469 7265 6374 6f72 790a 2020   subdirectory.  
-00029890: 2020 2020 2020 2020 2020 2020 2020 6f73                os
-000298a0: 2e6d 6b64 6972 2870 6174 6829 0a20 2020  .mkdir(path).   
-000298b0: 2020 2020 2020 2020 2020 2020 2054 6573               Tes
-000298c0: 7453 746f 7261 6765 5769 7468 4372 6564  tStorageWithCred
-000298d0: 656e 7469 616c 732e 6372 6561 7465 5f64  entials.create_d
-000298e0: 6972 5f73 7472 7563 7475 7265 280a 2020  ir_structure(.  
-000298f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029900: 2020 7061 7468 2c20 7375 6273 7472 7563    path, substruc
-00029910: 7475 7265 290a 0a20 2020 2040 7374 6174  ture)..    @stat
-00029920: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
-00029930: 2063 6c69 5f64 656c 6574 655f 636d 6428   cli_delete_cmd(
-00029940: 7374 6f72 655f 7479 7065 2c20 6275 636b  store_type, buck
-00029950: 6574 5f6e 616d 6529 3a0a 2020 2020 2020  et_name):.      
-00029960: 2020 6966 2073 746f 7265 5f74 7970 6520    if store_type 
-00029970: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
-00029980: 746f 7265 5479 7065 2e53 333a 0a20 2020  toreType.S3:.   
-00029990: 2020 2020 2020 2020 2075 726c 203d 2066           url = f
-000299a0: 2773 333a 2f2f 7b62 7563 6b65 745f 6e61  's3://{bucket_na
-000299b0: 6d65 7d27 0a20 2020 2020 2020 2020 2020  me}'.           
-000299c0: 2072 6574 7572 6e20 6627 6177 7320 7333   return f'aws s3
-000299d0: 2072 6220 7b75 726c 7d20 2d2d 666f 7263   rb {url} --forc
-000299e0: 6527 0a20 2020 2020 2020 2069 6620 7374  e'.        if st
-000299f0: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
-00029a00: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-00029a10: 652e 4743 533a 0a20 2020 2020 2020 2020  e.GCS:.         
-00029a20: 2020 2075 726c 203d 2066 2767 733a 2f2f     url = f'gs://
-00029a30: 7b62 7563 6b65 745f 6e61 6d65 7d27 0a20  {bucket_name}'. 
-00029a40: 2020 2020 2020 2020 2020 2067 7375 7469             gsuti
-00029a50: 6c5f 616c 6961 732c 2061 6c69 6173 5f67  l_alias, alias_g
-00029a60: 656e 203d 2064 6174 615f 7574 696c 732e  en = data_utils.
-00029a70: 6765 745f 6773 7574 696c 5f63 6f6d 6d61  get_gsutil_comma
-00029a80: 6e64 2829 0a20 2020 2020 2020 2020 2020  nd().           
-00029a90: 2072 6574 7572 6e20 6627 7b61 6c69 6173   return f'{alias
-00029aa0: 5f67 656e 7d3b 207b 6773 7574 696c 5f61  _gen}; {gsutil_a
-00029ab0: 6c69 6173 7d20 726d 202d 7220 7b75 726c  lias} rm -r {url
-00029ac0: 7d27 0a20 2020 2020 2020 2069 6620 7374  }'.        if st
-00029ad0: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
-00029ae0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-00029af0: 652e 5232 3a0a 2020 2020 2020 2020 2020  e.R2:.          
-00029b00: 2020 656e 6470 6f69 6e74 5f75 726c 203d    endpoint_url =
-00029b10: 2063 6c6f 7564 666c 6172 652e 6372 6561   cloudflare.crea
-00029b20: 7465 5f65 6e64 706f 696e 7428 290a 2020  te_endpoint().  
-00029b30: 2020 2020 2020 2020 2020 7572 6c20 3d20            url = 
-00029b40: 6627 7333 3a2f 2f7b 6275 636b 6574 5f6e  f's3://{bucket_n
-00029b50: 616d 657d 270a 2020 2020 2020 2020 2020  ame}'.          
-00029b60: 2020 7265 7475 726e 2066 2741 5753 5f53    return f'AWS_S
-00029b70: 4841 5245 445f 4352 4544 454e 5449 414c  HARED_CREDENTIAL
-00029b80: 535f 4649 4c45 3d7b 636c 6f75 6466 6c61  S_FILE={cloudfla
-00029b90: 7265 2e52 325f 4352 4544 454e 5449 414c  re.R2_CREDENTIAL
-00029ba0: 535f 5041 5448 7d20 6177 7320 7333 2072  S_PATH} aws s3 r
-00029bb0: 6220 7b75 726c 7d20 2d2d 666f 7263 6520  b {url} --force 
-00029bc0: 2d2d 656e 6470 6f69 6e74 207b 656e 6470  --endpoint {endp
-00029bd0: 6f69 6e74 5f75 726c 7d20 2d2d 7072 6f66  oint_url} --prof
-00029be0: 696c 653d 7232 270a 2020 2020 2020 2020  ile=r2'.        
-00029bf0: 6966 2073 746f 7265 5f74 7970 6520 3d3d  if store_type ==
-00029c00: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-00029c10: 7265 5479 7065 2e49 424d 3a0a 2020 2020  reType.IBM:.    
-00029c20: 2020 2020 2020 2020 6275 636b 6574 5f72          bucket_r
-00029c30: 636c 6f6e 655f 7072 6f66 696c 6520 3d20  clone_profile = 
-00029c40: 5263 6c6f 6e65 2e67 656e 6572 6174 655f  Rclone.generate_
-00029c50: 7263 6c6f 6e65 5f62 7563 6b65 745f 7072  rclone_bucket_pr
-00029c60: 6f66 696c 655f 6e61 6d65 280a 2020 2020  ofile_name(.    
-00029c70: 2020 2020 2020 2020 2020 2020 6275 636b              buck
-00029c80: 6574 5f6e 616d 652c 2052 636c 6f6e 652e  et_name, Rclone.
-00029c90: 5263 6c6f 6e65 436c 6f75 6473 2e49 424d  RcloneClouds.IBM
-00029ca0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00029cb0: 7475 726e 2066 2772 636c 6f6e 6520 7075  turn f'rclone pu
-00029cc0: 7267 6520 7b62 7563 6b65 745f 7263 6c6f  rge {bucket_rclo
-00029cd0: 6e65 5f70 726f 6669 6c65 7d3a 7b62 7563  ne_profile}:{buc
-00029ce0: 6b65 745f 6e61 6d65 7d20 2626 2072 636c  ket_name} && rcl
-00029cf0: 6f6e 6520 636f 6e66 6967 2064 656c 6574  one config delet
-00029d00: 6520 7b62 7563 6b65 745f 7263 6c6f 6e65  e {bucket_rclone
-00029d10: 5f70 726f 6669 6c65 7d27 0a0a 2020 2020  _profile}'..    
-00029d20: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
-00029d30: 2020 6465 6620 636c 695f 6c73 5f63 6d64    def cli_ls_cmd
-00029d40: 2873 746f 7265 5f74 7970 652c 2062 7563  (store_type, buc
-00029d50: 6b65 745f 6e61 6d65 2c20 7375 6666 6978  ket_name, suffix
-00029d60: 3d27 2729 3a0a 2020 2020 2020 2020 6966  =''):.        if
-00029d70: 2073 746f 7265 5f74 7970 6520 3d3d 2073   store_type == s
-00029d80: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-00029d90: 5479 7065 2e53 333a 0a20 2020 2020 2020  Type.S3:.       
-00029da0: 2020 2020 2069 6620 7375 6666 6978 3a0a       if suffix:.
-00029db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029dc0: 7572 6c20 3d20 6627 7333 3a2f 2f7b 6275  url = f's3://{bu
-00029dd0: 636b 6574 5f6e 616d 657d 2f7b 7375 6666  cket_name}/{suff
-00029de0: 6978 7d27 0a20 2020 2020 2020 2020 2020  ix}'.           
-00029df0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00029e00: 2020 2020 2020 2075 726c 203d 2066 2773         url = f's
-00029e10: 333a 2f2f 7b62 7563 6b65 745f 6e61 6d65  3://{bucket_name
-00029e20: 7d27 0a20 2020 2020 2020 2020 2020 2072  }'.            r
-00029e30: 6574 7572 6e20 6627 6177 7320 7333 206c  eturn f'aws s3 l
-00029e40: 7320 7b75 726c 7d27 0a20 2020 2020 2020  s {url}'.       
-00029e50: 2069 6620 7374 6f72 655f 7479 7065 203d   if store_type =
-00029e60: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-00029e70: 6f72 6554 7970 652e 4743 533a 0a20 2020  oreType.GCS:.   
-00029e80: 2020 2020 2020 2020 2069 6620 7375 6666           if suff
-00029e90: 6978 3a0a 2020 2020 2020 2020 2020 2020  ix:.            
-00029ea0: 2020 2020 7572 6c20 3d20 6627 6773 3a2f      url = f'gs:/
-00029eb0: 2f7b 6275 636b 6574 5f6e 616d 657d 2f7b  /{bucket_name}/{
-00029ec0: 7375 6666 6978 7d27 0a20 2020 2020 2020  suffix}'.       
-00029ed0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00029ee0: 2020 2020 2020 2020 2020 2075 726c 203d             url =
-00029ef0: 2066 2767 733a 2f2f 7b62 7563 6b65 745f   f'gs://{bucket_
-00029f00: 6e61 6d65 7d27 0a20 2020 2020 2020 2020  name}'.         
-00029f10: 2020 2072 6574 7572 6e20 6627 6773 7574     return f'gsut
-00029f20: 696c 206c 7320 7b75 726c 7d27 0a20 2020  il ls {url}'.   
-00029f30: 2020 2020 2069 6620 7374 6f72 655f 7479       if store_ty
-00029f40: 7065 203d 3d20 7374 6f72 6167 655f 6c69  pe == storage_li
-00029f50: 622e 5374 6f72 6554 7970 652e 5232 3a0a  b.StoreType.R2:.
-00029f60: 2020 2020 2020 2020 2020 2020 656e 6470              endp
-00029f70: 6f69 6e74 5f75 726c 203d 2063 6c6f 7564  oint_url = cloud
-00029f80: 666c 6172 652e 6372 6561 7465 5f65 6e64  flare.create_end
-00029f90: 706f 696e 7428 290a 2020 2020 2020 2020  point().        
-00029fa0: 2020 2020 6966 2073 7566 6669 783a 0a20      if suffix:. 
-00029fb0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-00029fc0: 726c 203d 2066 2773 333a 2f2f 7b62 7563  rl = f's3://{buc
-00029fd0: 6b65 745f 6e61 6d65 7d2f 7b73 7566 6669  ket_name}/{suffi
-00029fe0: 787d 270a 2020 2020 2020 2020 2020 2020  x}'.            
-00029ff0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0002a000: 2020 2020 2020 7572 6c20 3d20 6627 7333        url = f's3
-0002a010: 3a2f 2f7b 6275 636b 6574 5f6e 616d 657d  ://{bucket_name}
-0002a020: 270a 2020 2020 2020 2020 2020 2020 7265  '.            re
-0002a030: 7475 726e 2066 2741 5753 5f53 4841 5245  turn f'AWS_SHARE
-0002a040: 445f 4352 4544 454e 5449 414c 535f 4649  D_CREDENTIALS_FI
-0002a050: 4c45 3d7b 636c 6f75 6466 6c61 7265 2e52  LE={cloudflare.R
-0002a060: 325f 4352 4544 454e 5449 414c 535f 5041  2_CREDENTIALS_PA
-0002a070: 5448 7d20 6177 7320 7333 206c 7320 7b75  TH} aws s3 ls {u
-0002a080: 726c 7d20 2d2d 656e 6470 6f69 6e74 207b  rl} --endpoint {
-0002a090: 656e 6470 6f69 6e74 5f75 726c 7d20 2d2d  endpoint_url} --
-0002a0a0: 7072 6f66 696c 653d 7232 270a 2020 2020  profile=r2'.    
-0002a0b0: 2020 2020 6966 2073 746f 7265 5f74 7970      if store_typ
-0002a0c0: 6520 3d3d 2073 746f 7261 6765 5f6c 6962  e == storage_lib
-0002a0d0: 2e53 746f 7265 5479 7065 2e49 424d 3a0a  .StoreType.IBM:.
-0002a0e0: 2020 2020 2020 2020 2020 2020 6275 636b              buck
-0002a0f0: 6574 5f72 636c 6f6e 655f 7072 6f66 696c  et_rclone_profil
-0002a100: 6520 3d20 5263 6c6f 6e65 2e67 656e 6572  e = Rclone.gener
-0002a110: 6174 655f 7263 6c6f 6e65 5f62 7563 6b65  ate_rclone_bucke
-0002a120: 745f 7072 6f66 696c 655f 6e61 6d65 280a  t_profile_name(.
-0002a130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a140: 6275 636b 6574 5f6e 616d 652c 2052 636c  bucket_name, Rcl
-0002a150: 6f6e 652e 5263 6c6f 6e65 436c 6f75 6473  one.RcloneClouds
-0002a160: 2e49 424d 290a 2020 2020 2020 2020 2020  .IBM).          
-0002a170: 2020 7265 7475 726e 2066 2772 636c 6f6e    return f'rclon
-0002a180: 6520 6c73 207b 6275 636b 6574 5f72 636c  e ls {bucket_rcl
-0002a190: 6f6e 655f 7072 6f66 696c 657d 3a7b 6275  one_profile}:{bu
-0002a1a0: 636b 6574 5f6e 616d 657d 2f7b 7375 6666  cket_name}/{suff
-0002a1b0: 6978 7d27 0a0a 2020 2020 4073 7461 7469  ix}'..    @stati
-0002a1c0: 636d 6574 686f 640a 2020 2020 6465 6620  cmethod.    def 
-0002a1d0: 636c 695f 7265 6769 6f6e 5f63 6d64 2873  cli_region_cmd(s
-0002a1e0: 746f 7265 5f74 7970 652c 2062 7563 6b65  tore_type, bucke
-0002a1f0: 745f 6e61 6d65 293a 0a20 2020 2020 2020  t_name):.       
-0002a200: 2069 6620 7374 6f72 655f 7479 7065 203d   if store_type =
-0002a210: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-0002a220: 6f72 6554 7970 652e 5333 3a0a 2020 2020  oreType.S3:.    
-0002a230: 2020 2020 2020 2020 7265 7475 726e 2028          return (
-0002a240: 2761 7773 2073 3361 7069 2067 6574 2d62  'aws s3api get-b
-0002a250: 7563 6b65 742d 6c6f 6361 7469 6f6e 2027  ucket-location '
-0002a260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a270: 2020 2020 2066 272d 2d62 7563 6b65 7420       f'--bucket 
-0002a280: 7b62 7563 6b65 745f 6e61 6d65 7d20 2d2d  {bucket_name} --
-0002a290: 6f75 7470 7574 2074 6578 7427 290a 2020  output text').  
-0002a2a0: 2020 2020 2020 656c 6966 2073 746f 7265        elif store
-0002a2b0: 5f74 7970 6520 3d3d 2073 746f 7261 6765  _type == storage
-0002a2c0: 5f6c 6962 2e53 746f 7265 5479 7065 2e47  _lib.StoreType.G
-0002a2d0: 4353 3a0a 2020 2020 2020 2020 2020 2020  CS:.            
-0002a2e0: 7265 7475 726e 2028 6627 6773 7574 696c  return (f'gsutil
-0002a2f0: 206c 7320 2d4c 202d 6220 6773 3a2f 2f7b   ls -L -b gs://{
-0002a300: 6275 636b 6574 5f6e 616d 657d 2f20 7c20  bucket_name}/ | 
-0002a310: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0002a320: 2020 2020 2020 2767 7265 7020 224c 6f63        'grep "Loc
-0002a330: 6174 696f 6e20 636f 6e73 7472 6169 6e74  ation constraint
-0002a340: 2220 7c20 270a 2020 2020 2020 2020 2020  " | '.          
-0002a350: 2020 2020 2020 2020 2020 2761 776b 205c            'awk \
-0002a360: 277b 7072 696e 7420 746f 6c6f 7765 7228  '{print tolower(
-0002a370: 244e 4629 7d5c 2727 290a 2020 2020 2020  $NF)}\'').      
-0002a380: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0002a390: 2020 2020 7261 6973 6520 4e6f 7449 6d70      raise NotImp
-0002a3a0: 6c65 6d65 6e74 6564 4572 726f 7228 6627  lementedError(f'
-0002a3b0: 5265 6769 6f6e 2063 6f6d 6d61 6e64 206e  Region command n
-0002a3c0: 6f74 2069 6d70 6c65 6d65 6e74 6564 2066  ot implemented f
-0002a3d0: 6f72 2027 0a20 2020 2020 2020 2020 2020  or '.           
-0002a3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a3f0: 2020 2020 2020 2020 2020 2066 277b 7374             f'{st
-0002a400: 6f72 655f 7479 7065 7d27 290a 0a20 2020  ore_type}')..   
-0002a410: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
-0002a420: 2020 2064 6566 2063 6c69 5f63 6f75 6e74     def cli_count
-0002a430: 5f6e 616d 655f 696e 5f62 7563 6b65 7428  _name_in_bucket(
-0002a440: 7374 6f72 655f 7479 7065 2c20 6275 636b  store_type, buck
-0002a450: 6574 5f6e 616d 652c 2066 696c 655f 6e61  et_name, file_na
-0002a460: 6d65 2c20 7375 6666 6978 3d27 2729 3a0a  me, suffix=''):.
-0002a470: 2020 2020 2020 2020 6966 2073 746f 7265          if store
-0002a480: 5f74 7970 6520 3d3d 2073 746f 7261 6765  _type == storage
-0002a490: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
-0002a4a0: 333a 0a20 2020 2020 2020 2020 2020 2069  3:.            i
-0002a4b0: 6620 7375 6666 6978 3a0a 2020 2020 2020  f suffix:.      
-0002a4c0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0002a4d0: 2066 2761 7773 2073 3361 7069 206c 6973   f'aws s3api lis
-0002a4e0: 742d 6f62 6a65 6374 7320 2d2d 6275 636b  t-objects --buck
-0002a4f0: 6574 2022 7b62 7563 6b65 745f 6e61 6d65  et "{bucket_name
-0002a500: 7d22 202d 2d70 7265 6669 7820 7b73 7566  }" --prefix {suf
-0002a510: 6669 787d 202d 2d71 7565 7279 2022 6c65  fix} --query "le
-0002a520: 6e67 7468 2843 6f6e 7465 6e74 735b 3f63  ngth(Contents[?c
-0002a530: 6f6e 7461 696e 7328 4b65 792c 5c27 7b66  ontains(Key,\'{f
-0002a540: 696c 655f 6e61 6d65 7d5c 2729 5d2e 4b65  ile_name}\')].Ke
-0002a550: 7929 2227 0a20 2020 2020 2020 2020 2020  y)"'.           
-0002a560: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0002a570: 2020 2020 2020 2072 6574 7572 6e20 6627         return f'
-0002a580: 6177 7320 7333 6170 6920 6c69 7374 2d6f  aws s3api list-o
-0002a590: 626a 6563 7473 202d 2d62 7563 6b65 7420  bjects --bucket 
-0002a5a0: 227b 6275 636b 6574 5f6e 616d 657d 2220  "{bucket_name}" 
-0002a5b0: 2d2d 7175 6572 7920 226c 656e 6774 6828  --query "length(
-0002a5c0: 436f 6e74 656e 7473 5b3f 636f 6e74 6169  Contents[?contai
-0002a5d0: 6e73 284b 6579 2c5c 277b 6669 6c65 5f6e  ns(Key,\'{file_n
-0002a5e0: 616d 657d 5c27 295d 2e4b 6579 2922 270a  ame}\')].Key)"'.
-0002a5f0: 2020 2020 2020 2020 656c 6966 2073 746f          elif sto
-0002a600: 7265 5f74 7970 6520 3d3d 2073 746f 7261  re_type == stora
-0002a610: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-0002a620: 2e47 4353 3a0a 2020 2020 2020 2020 2020  .GCS:.          
-0002a630: 2020 6966 2073 7566 6669 783a 0a20 2020    if suffix:.   
-0002a640: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0002a650: 7572 6e20 6627 6773 7574 696c 206c 7320  urn f'gsutil ls 
-0002a660: 2d72 2067 733a 2f2f 7b62 7563 6b65 745f  -r gs://{bucket_
-0002a670: 6e61 6d65 7d2f 7b73 7566 6669 787d 207c  name}/{suffix} |
-0002a680: 2067 7265 7020 227b 6669 6c65 5f6e 616d   grep "{file_nam
-0002a690: 657d 2220 7c20 7763 202d 6c27 0a20 2020  e}" | wc -l'.   
-0002a6a0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0002a6b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0002a6c0: 6574 7572 6e20 6627 6773 7574 696c 206c  eturn f'gsutil l
-0002a6d0: 7320 2d72 2067 733a 2f2f 7b62 7563 6b65  s -r gs://{bucke
-0002a6e0: 745f 6e61 6d65 7d20 7c20 6772 6570 2022  t_name} | grep "
-0002a6f0: 7b66 696c 655f 6e61 6d65 7d22 207c 2077  {file_name}" | w
-0002a700: 6320 2d6c 270a 2020 2020 2020 2020 656c  c -l'.        el
-0002a710: 6966 2073 746f 7265 5f74 7970 6520 3d3d  if store_type ==
-0002a720: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-0002a730: 7265 5479 7065 2e52 323a 0a20 2020 2020  reType.R2:.     
-0002a740: 2020 2020 2020 2065 6e64 706f 696e 745f         endpoint_
-0002a750: 7572 6c20 3d20 636c 6f75 6466 6c61 7265  url = cloudflare
-0002a760: 2e63 7265 6174 655f 656e 6470 6f69 6e74  .create_endpoint
-0002a770: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
-0002a780: 6620 7375 6666 6978 3a0a 2020 2020 2020  f suffix:.      
-0002a790: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0002a7a0: 2066 2741 5753 5f53 4841 5245 445f 4352   f'AWS_SHARED_CR
-0002a7b0: 4544 454e 5449 414c 535f 4649 4c45 3d7b  EDENTIALS_FILE={
-0002a7c0: 636c 6f75 6466 6c61 7265 2e52 325f 4352  cloudflare.R2_CR
-0002a7d0: 4544 454e 5449 414c 535f 5041 5448 7d20  EDENTIALS_PATH} 
-0002a7e0: 6177 7320 7333 6170 6920 6c69 7374 2d6f  aws s3api list-o
-0002a7f0: 626a 6563 7473 202d 2d62 7563 6b65 7420  bjects --bucket 
-0002a800: 227b 6275 636b 6574 5f6e 616d 657d 2220  "{bucket_name}" 
-0002a810: 2d2d 7072 6566 6978 207b 7375 6666 6978  --prefix {suffix
-0002a820: 7d20 2d2d 7175 6572 7920 226c 656e 6774  } --query "lengt
-0002a830: 6828 436f 6e74 656e 7473 5b3f 636f 6e74  h(Contents[?cont
-0002a840: 6169 6e73 284b 6579 2c5c 277b 6669 6c65  ains(Key,\'{file
-0002a850: 5f6e 616d 657d 5c27 295d 2e4b 6579 2922  _name}\')].Key)"
-0002a860: 202d 2d65 6e64 706f 696e 7420 7b65 6e64   --endpoint {end
-0002a870: 706f 696e 745f 7572 6c7d 202d 2d70 726f  point_url} --pro
-0002a880: 6669 6c65 3d72 3227 0a20 2020 2020 2020  file=r2'.       
-0002a890: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0002a8a0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0002a8b0: 6e20 6627 4157 535f 5348 4152 4544 5f43  n f'AWS_SHARED_C
-0002a8c0: 5245 4445 4e54 4941 4c53 5f46 494c 453d  REDENTIALS_FILE=
-0002a8d0: 7b63 6c6f 7564 666c 6172 652e 5232 5f43  {cloudflare.R2_C
-0002a8e0: 5245 4445 4e54 4941 4c53 5f50 4154 487d  REDENTIALS_PATH}
-0002a8f0: 2061 7773 2073 3361 7069 206c 6973 742d   aws s3api list-
-0002a900: 6f62 6a65 6374 7320 2d2d 6275 636b 6574  objects --bucket
-0002a910: 2022 7b62 7563 6b65 745f 6e61 6d65 7d22   "{bucket_name}"
-0002a920: 202d 2d71 7565 7279 2022 6c65 6e67 7468   --query "length
-0002a930: 2843 6f6e 7465 6e74 735b 3f63 6f6e 7461  (Contents[?conta
-0002a940: 696e 7328 4b65 792c 5c27 7b66 696c 655f  ins(Key,\'{file_
-0002a950: 6e61 6d65 7d5c 2729 5d2e 4b65 7929 2220  name}\')].Key)" 
-0002a960: 2d2d 656e 6470 6f69 6e74 207b 656e 6470  --endpoint {endp
-0002a970: 6f69 6e74 5f75 726c 7d20 2d2d 7072 6f66  oint_url} --prof
-0002a980: 696c 653d 7232 270a 0a20 2020 2040 7374  ile=r2'..    @st
-0002a990: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
-0002a9a0: 6566 2063 6c69 5f63 6f75 6e74 5f66 696c  ef cli_count_fil
-0002a9b0: 655f 696e 5f62 7563 6b65 7428 7374 6f72  e_in_bucket(stor
-0002a9c0: 655f 7479 7065 2c20 6275 636b 6574 5f6e  e_type, bucket_n
-0002a9d0: 616d 6529 3a0a 2020 2020 2020 2020 6966  ame):.        if
-0002a9e0: 2073 746f 7265 5f74 7970 6520 3d3d 2073   store_type == s
-0002a9f0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-0002aa00: 5479 7065 2e53 333a 0a20 2020 2020 2020  Type.S3:.       
-0002aa10: 2020 2020 2072 6574 7572 6e20 6627 6177       return f'aw
-0002aa20: 7320 7333 206c 7320 7333 3a2f 2f7b 6275  s s3 ls s3://{bu
-0002aa30: 636b 6574 5f6e 616d 657d 202d 2d72 6563  cket_name} --rec
-0002aa40: 7572 7369 7665 207c 2077 6320 2d6c 270a  ursive | wc -l'.
-0002aa50: 2020 2020 2020 2020 656c 6966 2073 746f          elif sto
-0002aa60: 7265 5f74 7970 6520 3d3d 2073 746f 7261  re_type == stora
-0002aa70: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-0002aa80: 2e47 4353 3a0a 2020 2020 2020 2020 2020  .GCS:.          
-0002aa90: 2020 7265 7475 726e 2066 2767 7375 7469    return f'gsuti
-0002aaa0: 6c20 6c73 202d 7220 6773 3a2f 2f7b 6275  l ls -r gs://{bu
-0002aab0: 636b 6574 5f6e 616d 657d 2f2a 2a20 7c20  cket_name}/** | 
-0002aac0: 7763 202d 6c27 0a20 2020 2020 2020 2065  wc -l'.        e
-0002aad0: 6c69 6620 7374 6f72 655f 7479 7065 203d  lif store_type =
-0002aae0: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-0002aaf0: 6f72 6554 7970 652e 5232 3a0a 2020 2020  oreType.R2:.    
-0002ab00: 2020 2020 2020 2020 656e 6470 6f69 6e74          endpoint
-0002ab10: 5f75 726c 203d 2063 6c6f 7564 666c 6172  _url = cloudflar
-0002ab20: 652e 6372 6561 7465 5f65 6e64 706f 696e  e.create_endpoin
-0002ab30: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-0002ab40: 7265 7475 726e 2066 2741 5753 5f53 4841  return f'AWS_SHA
-0002ab50: 5245 445f 4352 4544 454e 5449 414c 535f  RED_CREDENTIALS_
-0002ab60: 4649 4c45 3d7b 636c 6f75 6466 6c61 7265  FILE={cloudflare
-0002ab70: 2e52 325f 4352 4544 454e 5449 414c 535f  .R2_CREDENTIALS_
-0002ab80: 5041 5448 7d20 6177 7320 7333 206c 7320  PATH} aws s3 ls 
-0002ab90: 7333 3a2f 2f7b 6275 636b 6574 5f6e 616d  s3://{bucket_nam
-0002aba0: 657d 202d 2d72 6563 7572 7369 7665 202d  e} --recursive -
-0002abb0: 2d65 6e64 706f 696e 7420 7b65 6e64 706f  -endpoint {endpo
-0002abc0: 696e 745f 7572 6c7d 202d 2d70 726f 6669  int_url} --profi
-0002abd0: 6c65 3d72 3220 7c20 7763 202d 6c27 0a0a  le=r2 | wc -l'..
-0002abe0: 2020 2020 4070 7974 6573 742e 6669 7874      @pytest.fixt
-0002abf0: 7572 650a 2020 2020 6465 6620 746d 705f  ure.    def tmp_
-0002ac00: 736f 7572 6365 2873 656c 662c 2074 6d70  source(self, tmp
-0002ac10: 5f70 6174 6829 3a0a 2020 2020 2020 2020  _path):.        
-0002ac20: 2320 4372 6561 7465 7320 6120 7465 6d70  # Creates a temp
-0002ac30: 6f72 6172 7920 6469 7265 6374 6f72 7920  orary directory 
-0002ac40: 7769 7468 2061 2066 696c 6520 696e 2069  with a file in i
-0002ac50: 740a 2020 2020 2020 2020 746d 705f 6469  t.        tmp_di
-0002ac60: 7220 3d20 746d 705f 7061 7468 202f 2027  r = tmp_path / '
-0002ac70: 746d 702d 736f 7572 6365 270a 2020 2020  tmp-source'.    
-0002ac80: 2020 2020 746d 705f 6469 722e 6d6b 6469      tmp_dir.mkdi
-0002ac90: 7228 290a 2020 2020 2020 2020 746d 705f  r().        tmp_
-0002aca0: 6669 6c65 203d 2074 6d70 5f64 6972 202f  file = tmp_dir /
-0002acb0: 2027 746d 702d 6669 6c65 270a 2020 2020   'tmp-file'.    
-0002acc0: 2020 2020 746d 705f 6669 6c65 2e77 7269      tmp_file.wri
-0002acd0: 7465 5f74 6578 7428 2774 6573 7427 290a  te_text('test').
-0002ace0: 2020 2020 2020 2020 6369 7263 6c65 5f6c          circle_l
-0002acf0: 696e 6b20 3d20 746d 705f 6469 7220 2f20  ink = tmp_dir / 
-0002ad00: 2763 6972 636c 652d 6c69 6e6b 270a 2020  'circle-link'.  
-0002ad10: 2020 2020 2020 6369 7263 6c65 5f6c 696e        circle_lin
-0002ad20: 6b2e 7379 6d6c 696e 6b5f 746f 2874 6d70  k.symlink_to(tmp
-0002ad30: 5f64 6972 2c20 7461 7267 6574 5f69 735f  _dir, target_is_
-0002ad40: 6469 7265 6374 6f72 793d 5472 7565 290a  directory=True).
-0002ad50: 2020 2020 2020 2020 7969 656c 6420 7374          yield st
-0002ad60: 7228 746d 705f 6469 7229 0a0a 2020 2020  r(tmp_dir)..    
-0002ad70: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
-0002ad80: 2020 6465 6620 6765 6e65 7261 7465 5f62    def generate_b
-0002ad90: 7563 6b65 745f 6e61 6d65 2829 3a0a 2020  ucket_name():.  
-0002ada0: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
-0002adb0: 6120 7465 6d70 6f72 6172 7920 6275 636b  a temporary buck
-0002adc0: 6574 206e 616d 650a 2020 2020 2020 2020  et name.        
-0002add0: 2320 7469 6d65 2e74 696d 6528 2920 7265  # time.time() re
-0002ade0: 7475 726e 7320 7661 7279 696e 6720 7072  turns varying pr
-0002adf0: 6563 6973 696f 6e20 6f6e 2064 6966 6665  ecision on diffe
-0002ae00: 7265 6e74 2073 7973 7465 6d73 2c20 736f  rent systems, so
-0002ae10: 2077 650a 2020 2020 2020 2020 2320 7265   we.        # re
-0002ae20: 706c 6163 6520 7468 6520 6465 6369 6d61  place the decima
-0002ae30: 6c20 706f 696e 7420 616e 6420 7573 6520  l point and use 
-0002ae40: 7768 6174 6576 6572 2070 7265 6369 7369  whatever precisi
-0002ae50: 6f6e 2077 6520 6361 6e20 6765 742e 0a20  on we can get.. 
-0002ae60: 2020 2020 2020 2074 696d 6573 7461 6d70         timestamp
-0002ae70: 203d 2073 7472 2874 696d 652e 7469 6d65   = str(time.time
-0002ae80: 2829 292e 7265 706c 6163 6528 272e 272c  ()).replace('.',
-0002ae90: 2027 2729 0a20 2020 2020 2020 2072 6574   '').        ret
-0002aea0: 7572 6e20 6627 736b 792d 7465 7374 2d7b  urn f'sky-test-{
-0002aeb0: 7469 6d65 7374 616d 707d 270a 0a20 2020  timestamp}'..   
-0002aec0: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
-0002aed0: 0a20 2020 2064 6566 2074 6d70 5f62 7563  .    def tmp_buc
-0002aee0: 6b65 745f 6e61 6d65 2873 656c 6629 3a0a  ket_name(self):.
-0002aef0: 2020 2020 2020 2020 7969 656c 6420 7365          yield se
-0002af00: 6c66 2e67 656e 6572 6174 655f 6275 636b  lf.generate_buck
-0002af10: 6574 5f6e 616d 6528 290a 0a20 2020 2040  et_name()..    @
-0002af20: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
-0002af30: 2064 6566 2079 6965 6c64 5f73 746f 7261   def yield_stora
-0002af40: 6765 5f6f 626a 6563 7428 0a20 2020 2020  ge_object(.     
-0002af50: 2020 2020 2020 206e 616d 653a 204f 7074         name: Opt
-0002af60: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
-0002af70: 652c 0a20 2020 2020 2020 2020 2020 2073  e,.            s
-0002af80: 6f75 7263 653a 204f 7074 696f 6e61 6c5b  ource: Optional[
-0002af90: 7374 6f72 6167 655f 6c69 622e 5061 7468  storage_lib.Path
-0002afa0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
-0002afb0: 2020 2020 2020 7374 6f72 6573 3a20 4f70        stores: Op
-0002afc0: 7469 6f6e 616c 5b44 6963 745b 7374 6f72  tional[Dict[stor
-0002afd0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0002afe0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0002aff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b000: 2020 2020 2073 746f 7261 6765 5f6c 6962       storage_lib
-0002b010: 2e41 6273 7472 6163 7453 746f 7265 5d5d  .AbstractStore]]
-0002b020: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-0002b030: 2020 2020 2070 6572 7369 7374 656e 743a       persistent:
-0002b040: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
-0002b050: 3d20 5472 7565 2c0a 2020 2020 2020 2020  = True,.        
-0002b060: 2020 2020 6d6f 6465 3a20 7374 6f72 6167      mode: storag
-0002b070: 655f 6c69 622e 5374 6f72 6167 654d 6f64  e_lib.StorageMod
-0002b080: 6520 3d20 7374 6f72 6167 655f 6c69 622e  e = storage_lib.
-0002b090: 5374 6f72 6167 654d 6f64 652e 4d4f 554e  StorageMode.MOUN
-0002b0a0: 5429 3a0a 2020 2020 2020 2020 2320 4372  T):.        # Cr
-0002b0b0: 6561 7465 7320 6120 7465 6d70 6f72 6172  eates a temporar
-0002b0c0: 7920 7374 6f72 6167 6520 6f62 6a65 6374  y storage object
-0002b0d0: 2e20 5374 6f72 6573 206d 7573 7420 6265  . Stores must be
-0002b0e0: 2061 6464 6564 2069 6e20 7468 6520 7465   added in the te
-0002b0f0: 7374 2e0a 2020 2020 2020 2020 7374 6f72  st..        stor
-0002b100: 6167 655f 6f62 6a20 3d20 7374 6f72 6167  age_obj = storag
-0002b110: 655f 6c69 622e 5374 6f72 6167 6528 6e61  e_lib.Storage(na
-0002b120: 6d65 3d6e 616d 652c 0a20 2020 2020 2020  me=name,.       
-0002b130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000238f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023900: 2020 2020 2020 2020 2020 2028 302c 2046             (0, F
+00023910: 616c 7365 2c20 2727 295d 292c 0a20 2020  alse, '')]),.   
+00023920: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00023930: 5f54 4541 5244 4f57 4e5f 5345 5256 4943  _TEARDOWN_SERVIC
+00023940: 452e 666f 726d 6174 286e 616d 653d 6e61  E.format(name=na
+00023950: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
+00023960: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
+00023970: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00023980: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00023990: 7465 7374 2e6d 6172 6b2e 7365 7276 650a  test.mark.serve.
+000239a0: 6465 6620 7465 7374 5f73 6b79 7365 7276  def test_skyserv
+000239b0: 655f 7573 6572 5f62 7567 5f72 6573 7461  e_user_bug_resta
+000239c0: 7274 2867 656e 6572 6963 5f63 6c6f 7564  rt(generic_cloud
+000239d0: 3a20 7374 7229 3a0a 2020 2020 2222 2254  : str):.    """T
+000239e0: 6573 7473 2074 6861 7420 7765 2072 6573  ests that we res
+000239f0: 7461 7274 2074 6865 2073 6572 7669 6365  tart the service
+00023a00: 2061 6674 6572 2075 7365 7220 6275 672e   after user bug.
+00023a10: 2222 220a 2020 2020 2320 544f 444f 287a  """.    # TODO(z
+00023a20: 6877 7529 3a20 7468 6973 2062 6568 6176  hwu): this behav
+00023a30: 696f 7220 6e65 6564 7320 736f 6d65 2072  ior needs some r
+00023a40: 6574 6869 6e6b 696e 672e 0a20 2020 206e  ethinking..    n
+00023a50: 616d 6520 3d20 5f67 6574 5f73 6572 7669  ame = _get_servi
+00023a60: 6365 5f6e 616d 6528 290a 2020 2020 7465  ce_name().    te
+00023a70: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00023a80: 2020 2066 2774 6573 742d 736b 7973 6572     f'test-skyser
+00023a90: 7665 2d75 7365 722d 6275 672d 7265 7374  ve-user-bug-rest
+00023aa0: 6172 7427 2c0a 2020 2020 2020 2020 5b0a  art',.        [.
+00023ab0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00023ac0: 7920 7365 7276 6520 7570 202d 6e20 7b6e  y serve up -n {n
+00023ad0: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
+00023ae0: 6e65 7269 635f 636c 6f75 647d 202d 7920  neric_cloud} -y 
+00023af0: 7465 7374 732f 736b 7973 6572 7665 2f72  tests/skyserve/r
+00023b00: 6573 7461 7274 2f75 7365 725f 6275 672e  estart/user_bug.
+00023b10: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00023b20: 2020 2066 2773 3d24 2873 6b79 2073 6572     f's=$(sky ser
+00023b30: 7665 2073 7461 7475 7320 7b6e 616d 657d  ve status {name}
+00023b40: 293b 2065 6368 6f20 2224 7322 3b27 0a20  ); echo "$s";'. 
+00023b50: 2020 2020 2020 2020 2020 2027 756e 7469             'unti
+00023b60: 6c20 6563 686f 2022 2473 2220 7c20 6772  l echo "$s" | gr
+00023b70: 6570 202d 4120 3130 3020 2253 6572 7669  ep -A 100 "Servi
+00023b80: 6365 2052 6570 6c69 6361 7322 207c 2067  ce Replicas" | g
+00023b90: 7265 7020 2253 4855 5454 494e 475f 444f  rep "SHUTTING_DO
+00023ba0: 574e 223b 2027 0a20 2020 2020 2020 2020  WN"; '.         
+00023bb0: 2020 2027 646f 2065 6368 6f20 2257 6169     'do echo "Wai
+00023bc0: 7469 6e67 2066 6f72 2066 6972 7374 2073  ting for first s
+00023bd0: 6572 7669 6365 2074 6f20 6265 2053 4855  ervice to be SHU
+00023be0: 5454 494e 4720 444f 574e 2e2e 2e22 3b20  TTING DOWN..."; 
+00023bf0: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+00023c00: 736c 6565 7020 353b 2073 3d24 2873 6b79  sleep 5; s=$(sky
+00023c10: 2073 6572 7665 2073 7461 7475 7320 7b6e   serve status {n
+00023c20: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
+00023c30: 3b20 646f 6e65 3b20 272c 0a20 2020 2020  ; done; ',.     
+00023c40: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+00023c50: 2073 6572 7665 2073 7461 7475 7320 7b6e   serve status {n
+00023c60: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
+00023c70: 3b27 0a20 2020 2020 2020 2020 2020 2027  ;'.            '
+00023c80: 756e 7469 6c20 6563 686f 2022 2473 2220  until echo "$s" 
+00023c90: 7c20 6772 6570 202d 4120 3130 3020 2253  | grep -A 100 "S
+00023ca0: 6572 7669 6365 2052 6570 6c69 6361 7322  ervice Replicas"
+00023cb0: 207c 2067 7265 7020 2246 4149 4c45 4422   | grep "FAILED"
+00023cc0: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+00023cd0: 2764 6f20 6563 686f 2022 5761 6974 696e  'do echo "Waitin
+00023ce0: 6720 666f 7220 6669 7273 7420 7365 7276  g for first serv
+00023cf0: 6963 6520 746f 2062 6520 4641 494c 4544  ice to be FAILED
+00023d00: 2e2e 2e22 3b20 270a 2020 2020 2020 2020  ..."; '.        
+00023d10: 2020 2020 6627 736c 6565 7020 353b 2073      f'sleep 5; s
+00023d20: 3d24 2873 6b79 2073 6572 7665 2073 7461  =$(sky serve sta
+00023d30: 7475 7320 7b6e 616d 657d 293b 2065 6368  tus {name}); ech
+00023d40: 6f20 2224 7322 3b20 646f 6e65 3b20 6563  o "$s"; done; ec
+00023d50: 686f 2022 2473 223b 2027 0a20 2020 2020  ho "$s"; '.     
+00023d60: 2020 2020 2020 202b 205f 6368 6563 6b5f         + _check_
+00023d70: 7265 706c 6963 615f 696e 5f73 7461 7475  replica_in_statu
+00023d80: 7328 6e61 6d65 2c20 5b28 312c 2054 7275  s(name, [(1, Tru
+00023d90: 652c 2027 4641 494c 4544 2729 5d29 202b  e, 'FAILED')]) +
+00023da0: 0a20 2020 2020 2020 2020 2020 2023 2055  .            # U
+00023db0: 7365 7220 6275 6720 6661 696c 7572 6520  ser bug failure 
+00023dc0: 7769 6c6c 2063 6175 7365 206e 6f20 6675  will cause no fu
+00023dd0: 7274 6865 7220 7363 616c 696e 672e 0a20  rther scaling.. 
+00023de0: 2020 2020 2020 2020 2020 2066 2765 6368             f'ech
+00023df0: 6f20 2224 7322 207c 2067 7265 7020 2d41  o "$s" | grep -A
+00023e00: 2031 3030 2022 5365 7276 6963 6520 5265   100 "Service Re
+00023e10: 706c 6963 6173 2220 7c20 6772 6570 2022  plicas" | grep "
+00023e20: 7b6e 616d 657d 2220 7c20 7763 202d 6c20  {name}" | wc -l 
+00023e30: 7c20 6772 6570 2031 3b20 270a 2020 2020  | grep 1; '.    
+00023e40: 2020 2020 2020 2020 6627 6563 686f 2022          f'echo "
+00023e50: 2473 2220 7c20 6772 6570 202d 4220 3130  $s" | grep -B 10
+00023e60: 3020 224e 4f5f 5245 504c 4943 4122 207c  0 "NO_REPLICA" |
+00023e70: 2067 7265 7020 2230 2f30 2227 2c0a 2020   grep "0/0"',.  
+00023e80: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00023e90: 7365 7276 6520 7570 6461 7465 207b 6e61  serve update {na
+00023ea0: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
+00023eb0: 6572 6963 5f63 6c6f 7564 7d20 2d79 2074  eric_cloud} -y t
+00023ec0: 6573 7473 2f73 6b79 7365 7276 652f 6175  ests/skyserve/au
+00023ed0: 746f 5f72 6573 7461 7274 2e79 616d 6c27  to_restart.yaml'
+00023ee0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00023ef0: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
+00023f00: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
+00023f10: 653d 6e61 6d65 297d 3b20 270a 2020 2020  e=name)}; '.    
+00023f20: 2020 2020 2020 2020 2775 6e74 696c 2063          'until c
+00023f30: 7572 6c20 2d4c 2068 7474 703a 2f2f 2465  url -L http://$e
+00023f40: 6e64 706f 696e 7420 7c20 6772 6570 2022  ndpoint | grep "
+00023f50: 4869 2c20 536b 7950 696c 6f74 2068 6572  Hi, SkyPilot her
+00023f60: 6521 223b 2064 6f20 736c 6565 7020 323b  e!"; do sleep 2;
+00023f70: 2064 6f6e 653b 2073 6c65 6570 2032 3b20   done; sleep 2; 
+00023f80: 270a 2020 2020 2020 2020 2020 2020 2b20  '.            + 
+00023f90: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
+00023fa0: 6e5f 7374 6174 7573 286e 616d 652c 205b  n_status(name, [
+00023fb0: 2831 2c20 4661 6c73 652c 2027 5245 4144  (1, False, 'READ
+00023fc0: 5927 292c 0a20 2020 2020 2020 2020 2020  Y'),.           
+00023fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023ff0: 2020 2028 312c 2046 616c 7365 2c20 2746     (1, False, 'F
+00024000: 4149 4c45 4427 295d 292c 0a20 2020 2020  AILED')]),.     
+00024010: 2020 205d 2c0a 2020 2020 2020 2020 5f54     ],.        _T
+00024020: 4541 5244 4f57 4e5f 5345 5256 4943 452e  EARDOWN_SERVICE.
+00024030: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00024040: 292c 0a20 2020 2020 2020 2074 696d 656f  ),.        timeo
+00024050: 7574 3d32 3020 2a20 3630 2c0a 2020 2020  ut=20 * 60,.    
+00024060: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00024070: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+00024080: 7374 2e6d 6172 6b2e 7365 7276 650a 4070  st.mark.serve.@p
+00024090: 7974 6573 742e 6d61 726b 2e6e 6f5f 6b75  ytest.mark.no_ku
+000240a0: 6265 726e 6574 6573 2020 2320 5265 706c  bernetes  # Repl
+000240b0: 6963 6173 206f 6e20 6b38 7320 6d61 7920  icas on k8s may 
+000240c0: 6265 2072 756e 6e69 6e67 206f 6e20 7468  be running on th
+000240d0: 6520 7361 6d65 206e 6f64 6520 616e 6420  e same node and 
+000240e0: 6861 7665 2074 6865 2073 616d 6520 7075  have the same pu
+000240f0: 626c 6963 2049 500a 6465 6620 7465 7374  blic IP.def test
+00024100: 5f73 6b79 7365 7276 655f 6c6f 6164 5f62  _skyserve_load_b
+00024110: 616c 616e 6365 7228 6765 6e65 7269 635f  alancer(generic_
+00024120: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+00024130: 2022 2222 5465 7374 2073 6b79 7365 7276   """Test skyserv
+00024140: 6520 6c6f 6164 2062 616c 616e 6365 7220  e load balancer 
+00024150: 726f 756e 642d 726f 6269 6e20 706f 6c69  round-robin poli
+00024160: 6379 2222 220a 2020 2020 6e61 6d65 203d  cy""".    name =
+00024170: 205f 6765 745f 7365 7276 6963 655f 6e61   _get_service_na
+00024180: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00024190: 5465 7374 280a 2020 2020 2020 2020 6627  Test(.        f'
+000241a0: 7465 7374 2d73 6b79 7365 7276 652d 6c6f  test-skyserve-lo
+000241b0: 6164 2d62 616c 616e 6365 7227 2c0a 2020  ad-balancer',.  
+000241c0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+000241d0: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
+000241e0: 7570 202d 6e20 7b6e 616d 657d 202d 2d63  up -n {name} --c
+000241f0: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+00024200: 6f75 647d 202d 7920 7465 7374 732f 736b  oud} -y tests/sk
+00024210: 7973 6572 7665 2f6c 6f61 645f 6261 6c61  yserve/load_bala
+00024220: 6e63 6572 2f73 6572 7669 6365 2e79 616d  ncer/service.yam
+00024230: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00024240: 5f53 4552 5645 5f57 4149 545f 554e 5449  _SERVE_WAIT_UNTI
+00024250: 4c5f 5245 4144 592e 666f 726d 6174 286e  L_READY.format(n
+00024260: 616d 653d 6e61 6d65 2c20 7265 706c 6963  ame=name, replic
+00024270: 615f 6e75 6d3d 3329 2c0a 2020 2020 2020  a_num=3),.      
+00024280: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
+00024290: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
+000242a0: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
+000242b0: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+000242c0: 6627 7b5f 5345 5256 455f 5354 4154 5553  f'{_SERVE_STATUS
+000242d0: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
+000242e0: 653d 6e61 6d65 297d 3b20 270a 2020 2020  e=name)}; '.    
+000242f0: 2020 2020 2020 2020 6627 7b5f 6765 745f          f'{_get_
+00024300: 7265 706c 6963 615f 6970 286e 616d 652c  replica_ip(name,
+00024310: 2031 297d 3b20 270a 2020 2020 2020 2020   1)}; '.        
+00024320: 2020 2020 6627 7b5f 6765 745f 7265 706c      f'{_get_repl
+00024330: 6963 615f 6970 286e 616d 652c 2032 297d  ica_ip(name, 2)}
+00024340: 3b20 7b5f 6765 745f 7265 706c 6963 615f  ; {_get_replica_
+00024350: 6970 286e 616d 652c 2033 297d 3b20 270a  ip(name, 3)}; '.
+00024360: 2020 2020 2020 2020 2020 2020 2770 7974              'pyt
+00024370: 686f 6e20 7465 7374 732f 736b 7973 6572  hon tests/skyser
+00024380: 7665 2f6c 6f61 645f 6261 6c61 6e63 6572  ve/load_balancer
+00024390: 2f74 6573 745f 726f 756e 645f 726f 6269  /test_round_robi
+000243a0: 6e2e 7079 2027 0a20 2020 2020 2020 2020  n.py '.         
+000243b0: 2020 2027 2d2d 656e 6470 6f69 6e74 2024     '--endpoint $
+000243c0: 656e 6470 6f69 6e74 202d 2d72 6570 6c69  endpoint --repli
+000243d0: 6361 2d6e 756d 2033 202d 2d72 6570 6c69  ca-num 3 --repli
+000243e0: 6361 2d69 7073 2024 6970 3120 2469 7032  ca-ips $ip1 $ip2
+000243f0: 2024 6970 3327 2c0a 2020 2020 2020 2020   $ip3',.        
+00024400: 5d2c 0a20 2020 2020 2020 205f 5445 4152  ],.        _TEAR
+00024410: 444f 574e 5f53 4552 5649 4345 2e66 6f72  DOWN_SERVICE.for
+00024420: 6d61 7428 6e61 6d65 3d6e 616d 6529 2c0a  mat(name=name),.
+00024430: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00024440: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
+00024450: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00024460: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00024470: 6d61 726b 2e67 6370 0a40 7079 7465 7374  mark.gcp.@pytest
+00024480: 2e6d 6172 6b2e 7365 7276 650a 4070 7974  .mark.serve.@pyt
+00024490: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
+000244a0: 726e 6574 6573 0a64 6566 2074 6573 745f  rnetes.def test_
+000244b0: 736b 7973 6572 7665 5f61 7574 6f5f 7265  skyserve_auto_re
+000244c0: 7374 6172 7428 293a 0a20 2020 2022 2222  start():.    """
+000244d0: 5465 7374 2073 6b79 7365 7276 6520 7769  Test skyserve wi
+000244e0: 7468 2061 7574 6f20 7265 7374 6172 7422  th auto restart"
+000244f0: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
+00024500: 6574 5f73 6572 7669 6365 5f6e 616d 6528  et_service_name(
+00024510: 290a 2020 2020 7a6f 6e65 203d 2027 7573  ).    zone = 'us
+00024520: 2d63 656e 7472 616c 312d 6127 0a20 2020  -central1-a'.   
+00024530: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00024540: 2020 2020 2020 6627 7465 7374 2d73 6b79        f'test-sky
+00024550: 7365 7276 652d 6175 746f 2d72 6573 7461  serve-auto-resta
+00024560: 7274 272c 0a20 2020 2020 2020 205b 0a20  rt',.        [. 
+00024570: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
+00024580: 4f28 7469 616e 293a 2077 6520 6361 6e20  O(tian): we can 
+00024590: 6479 6e61 6d69 6361 6c6c 7920 6765 6e65  dynamically gene
+000245a0: 7261 7465 2059 414d 4c20 6672 6f6d 2074  rate YAML from t
+000245b0: 656d 706c 6174 6520 746f 0a20 2020 2020  emplate to.     
+000245c0: 2020 2020 2020 2023 2061 766f 6964 206d         # avoid m
+000245d0: 6169 6e74 6169 6e69 6e67 2074 6f6f 206d  aintaining too m
+000245e0: 616e 7920 5941 4d4c 2066 696c 6573 0a20  any YAML files. 
+000245f0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00024600: 2073 6572 7665 2075 7020 2d6e 207b 6e61   serve up -n {na
+00024610: 6d65 7d20 2d79 2074 6573 7473 2f73 6b79  me} -y tests/sky
+00024620: 7365 7276 652f 6175 746f 5f72 6573 7461  serve/auto_resta
+00024630: 7274 2e79 616d 6c27 2c0a 2020 2020 2020  rt.yaml',.      
+00024640: 2020 2020 2020 5f53 4552 5645 5f57 4149        _SERVE_WAI
+00024650: 545f 554e 5449 4c5f 5245 4144 592e 666f  T_UNTIL_READY.fo
+00024660: 726d 6174 286e 616d 653d 6e61 6d65 2c20  rmat(name=name, 
+00024670: 7265 706c 6963 615f 6e75 6d3d 3129 2c0a  replica_num=1),.
+00024680: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00024690: 5345 5256 455f 454e 4450 4f49 4e54 5f57  SERVE_ENDPOINT_W
+000246a0: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
+000246b0: 6e61 6d65 297d 3b20 270a 2020 2020 2020  name)}; '.      
+000246c0: 2020 2020 2020 2772 6571 7565 7374 5f6f        'request_o
+000246d0: 7574 7075 743d 2428 6375 726c 202d 4c20  utput=$(curl -L 
+000246e0: 6874 7470 3a2f 2f24 656e 6470 6f69 6e74  http://$endpoint
+000246f0: 293b 2065 6368 6f20 2224 7265 7175 6573  ); echo "$reques
+00024700: 745f 6f75 7470 7574 223b 2065 6368 6f20  t_output"; echo 
+00024710: 2224 7265 7175 6573 745f 6f75 7470 7574  "$request_output
+00024720: 2220 7c20 6772 6570 2022 4869 2c20 536b  " | grep "Hi, Sk
+00024730: 7950 696c 6f74 2068 6572 6522 272c 0a20  yPilot here"',. 
+00024740: 2020 2020 2020 2020 2020 2023 2073 6c65             # sle
+00024750: 6570 2066 6f72 2032 3020 7365 636f 6e64  ep for 20 second
+00024760: 7320 2869 6e69 7469 616c 2064 656c 6179  s (initial delay
+00024770: 2920 746f 206d 616b 6520 7375 7265 2069  ) to make sure i
+00024780: 7420 7769 6c6c 0a20 2020 2020 2020 2020  t will.         
+00024790: 2020 2023 2062 6520 7265 7374 6172 7465     # be restarte
+000247a0: 640a 2020 2020 2020 2020 2020 2020 6627  d.            f'
+000247b0: 736c 6565 7020 3230 272c 0a20 2020 2020  sleep 20',.     
+000247c0: 2020 2020 2020 205f 7465 726d 696e 6174         _terminat
+000247d0: 655f 6763 705f 7265 706c 6963 6128 6e61  e_gcp_replica(na
+000247e0: 6d65 2c20 7a6f 6e65 2c20 3129 2c0a 2020  me, zone, 1),.  
+000247f0: 2020 2020 2020 2020 2020 2320 5761 6974            # Wait
+00024800: 2066 6f72 2063 6f6e 7365 6375 7469 7665   for consecutive
+00024810: 2066 6169 6c75 7265 2074 696d 656f 7574   failure timeout
+00024820: 2070 6173 7365 642e 0a20 2020 2020 2020   passed..       
+00024830: 2020 2020 2023 2049 6620 7468 6520 636c       # If the cl
+00024840: 7573 7465 7220 6973 206e 6f74 2075 7369  uster is not usi
+00024850: 6e67 2073 706f 742c 2069 7420 776f 6e27  ng spot, it won'
+00024860: 7420 6368 6563 6b20 7468 6520 636c 7573  t check the clus
+00024870: 7465 7220 7374 6174 7573 0a20 2020 2020  ter status.     
+00024880: 2020 2020 2020 2023 206f 6e20 7468 6520         # on the 
+00024890: 636c 6f75 6420 2873 696e 6365 206d 616e  cloud (since man
+000248a0: 7561 6c20 7368 7574 646f 776e 2069 7320  ual shutdown is 
+000248b0: 6e6f 7420 6120 636f 6d6d 6f6e 2062 6568  not a common beh
+000248c0: 6176 696f 7220 616e 6420 7375 6368 0a20  avior and such. 
+000248d0: 2020 2020 2020 2020 2020 2023 2071 7565             # que
+000248e0: 7269 6573 2074 616b 6573 2061 206c 6f74  ries takes a lot
+000248f0: 206f 6620 7469 6d65 292e 2049 6e73 7465   of time). Inste
+00024900: 6164 2c20 7765 2074 6869 6e6b 2063 6f6e  ad, we think con
+00024910: 7469 6e75 6f75 7320 3320 6d69 6e20 7072  tinuous 3 min pr
+00024920: 6f62 650a 2020 2020 2020 2020 2020 2020  obe.            
+00024930: 2320 6661 696c 7572 6520 6973 206e 6f74  # failure is not
+00024940: 2061 2074 656d 706f 7261 7279 2070 726f   a temporary pro
+00024950: 626c 656d 2062 7574 2069 6e64 6565 6420  blem but indeed 
+00024960: 6120 6661 696c 7572 652e 0a20 2020 2020  a failure..     
+00024970: 2020 2020 2020 2027 736c 6565 7020 3138         'sleep 18
+00024980: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00024990: 2320 5765 2063 616e 6e6f 7420 7573 6520  # We cannot use 
+000249a0: 5f53 4552 5645 5f57 4149 545f 554e 5449  _SERVE_WAIT_UNTI
+000249b0: 4c5f 5245 4144 593b 2074 6865 7265 2077  L_READY; there w
+000249c0: 696c 6c20 6265 2061 2069 6e74 6572 6d65  ill be a interme
+000249d0: 6469 6174 6520 7469 6d65 0a20 2020 2020  diate time.     
+000249e0: 2020 2020 2020 2023 2074 6861 7420 7468         # that th
+000249f0: 6520 6f75 7470 7574 206f 6620 6073 6b79  e output of `sky
+00024a00: 2073 6572 7665 2073 7461 7475 7360 2073   serve status` s
+00024a10: 686f 7773 2046 4149 4c45 4420 616e 6420  hows FAILED and 
+00024a20: 7468 6973 2073 7461 7475 7320 7769 6c6c  this status will
+00024a30: 0a20 2020 2020 2020 2020 2020 2023 2063  .            # c
+00024a40: 6175 7365 205f 5345 5256 455f 5741 4954  ause _SERVE_WAIT
+00024a50: 5f55 4e54 494c 5f52 4541 4459 2074 6f20  _UNTIL_READY to 
+00024a60: 6561 726c 7920 7175 6974 2e0a 2020 2020  early quit..    
+00024a70: 2020 2020 2020 2020 2728 7768 696c 6520          '(while 
+00024a80: 7472 7565 3b20 646f 270a 2020 2020 2020  true; do'.      
+00024a90: 2020 2020 2020 6627 2020 2020 6f75 7470        f'    outp
+00024aa0: 7574 3d24 2873 6b79 2073 6572 7665 2073  ut=$(sky serve s
+00024ab0: 7461 7475 7320 7b6e 616d 657d 293b 270a  tatus {name});'.
+00024ac0: 2020 2020 2020 2020 2020 2020 2720 2020              '   
+00024ad0: 2020 6563 686f 2022 246f 7574 7075 7422    echo "$output"
+00024ae0: 207c 2067 7265 7020 2d71 2022 312f 3122   | grep -q "1/1"
+00024af0: 2026 2620 6272 6561 6b3b 270a 2020 2020   && break;'.    
+00024b00: 2020 2020 2020 2020 2720 2020 2020 736c          '     sl
+00024b10: 6565 7020 3130 3b27 0a20 2020 2020 2020  eep 10;'.       
+00024b20: 2020 2020 2066 2764 6f6e 6529 3b20 736c       f'done); sl
+00024b30: 6565 7020 7b73 6572 7665 2e4c 425f 434f  eep {serve.LB_CO
+00024b40: 4e54 524f 4c4c 4552 5f53 594e 435f 494e  NTROLLER_SYNC_IN
+00024b50: 5445 5256 414c 5f53 4543 4f4e 4453 7d3b  TERVAL_SECONDS};
+00024b60: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00024b70: 277b 5f53 4552 5645 5f45 4e44 504f 494e  '{_SERVE_ENDPOIN
+00024b80: 545f 5741 4954 2e66 6f72 6d61 7428 6e61  T_WAIT.format(na
+00024b90: 6d65 3d6e 616d 6529 7d3b 2027 0a20 2020  me=name)}; '.   
+00024ba0: 2020 2020 2020 2020 2027 7265 7175 6573           'reques
+00024bb0: 745f 6f75 7470 7574 3d24 2863 7572 6c20  t_output=$(curl 
+00024bc0: 2d4c 2068 7474 703a 2f2f 2465 6e64 706f  -L http://$endpo
+00024bd0: 696e 7429 3b20 6563 686f 2022 2472 6571  int); echo "$req
+00024be0: 7565 7374 5f6f 7574 7075 7422 3b20 6563  uest_output"; ec
+00024bf0: 686f 2022 2472 6571 7565 7374 5f6f 7574  ho "$request_out
+00024c00: 7075 7422 207c 2067 7265 7020 2248 692c  put" | grep "Hi,
+00024c10: 2053 6b79 5069 6c6f 7420 6865 7265 2227   SkyPilot here"'
+00024c20: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00024c30: 2020 2020 205f 5445 4152 444f 574e 5f53       _TEARDOWN_S
+00024c40: 4552 5649 4345 2e66 6f72 6d61 7428 6e61  ERVICE.format(na
+00024c50: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
+00024c60: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
+00024c70: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
+00024c80: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00024c90: 0a0a 4070 7974 6573 742e 6d61 726b 2e73  ..@pytest.mark.s
+00024ca0: 6572 7665 0a64 6566 2074 6573 745f 736b  erve.def test_sk
+00024cb0: 7973 6572 7665 5f63 616e 6365 6c28 6765  yserve_cancel(ge
+00024cc0: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+00024cd0: 293a 0a20 2020 2022 2222 5465 7374 2073  ):.    """Test s
+00024ce0: 6b79 7365 7276 6520 7769 7468 2063 616e  kyserve with can
+00024cf0: 6365 6c22 2222 0a20 2020 206e 616d 6520  cel""".    name 
+00024d00: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
+00024d10: 616d 6528 290a 0a20 2020 2074 6573 7420  ame()..    test 
+00024d20: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00024d30: 6627 7465 7374 2d73 6b79 7365 7276 652d  f'test-skyserve-
+00024d40: 6361 6e63 656c 272c 0a20 2020 2020 2020  cancel',.       
+00024d50: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00024d60: 2773 6b79 2073 6572 7665 2075 7020 2d6e  'sky serve up -n
+00024d70: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00024d80: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+00024d90: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
+00024da0: 652f 6361 6e63 656c 2f63 616e 6365 6c2e  e/cancel/cancel.
+00024db0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00024dc0: 2020 205f 5345 5256 455f 5741 4954 5f55     _SERVE_WAIT_U
+00024dd0: 4e54 494c 5f52 4541 4459 2e66 6f72 6d61  NTIL_READY.forma
+00024de0: 7428 6e61 6d65 3d6e 616d 652c 2072 6570  t(name=name, rep
+00024df0: 6c69 6361 5f6e 756d 3d31 292c 0a20 2020  lica_num=1),.   
+00024e00: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
+00024e10: 5645 5f45 4e44 504f 494e 545f 5741 4954  VE_ENDPOINT_WAIT
+00024e20: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00024e30: 6529 7d3b 2070 7974 686f 6e33 2027 0a20  e)}; python3 '. 
+00024e40: 2020 2020 2020 2020 2020 2027 7465 7374             'test
+00024e50: 732f 736b 7973 6572 7665 2f63 616e 6365  s/skyserve/cance
+00024e60: 6c2f 7365 6e64 5f63 616e 6365 6c5f 7265  l/send_cancel_re
+00024e70: 7175 6573 742e 7079 2027 0a20 2020 2020  quest.py '.     
+00024e80: 2020 2020 2020 2027 2d2d 656e 6470 6f69         '--endpoi
+00024e90: 6e74 2024 656e 6470 6f69 6e74 207c 2067  nt $endpoint | g
+00024ea0: 7265 7020 2252 6571 7565 7374 2077 6173  rep "Request was
+00024eb0: 2063 616e 6365 6c6c 6564 2227 2c0a 2020   cancelled"',.  
+00024ec0: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+00024ed0: 736b 7920 7365 7276 6520 6c6f 6773 207b  sky serve logs {
+00024ee0: 6e61 6d65 7d20 3120 2d2d 6e6f 2d66 6f6c  name} 1 --no-fol
+00024ef0: 6c6f 7729 3b20 270a 2020 2020 2020 2020  low); '.        
+00024f00: 2020 2020 2775 6e74 696c 2021 2065 6368      'until ! ech
+00024f10: 6f20 2224 7322 207c 2067 7265 7020 2250  o "$s" | grep "P
+00024f20: 6c65 6173 6520 7761 6974 2066 6f72 2074  lease wait for t
+00024f30: 6865 2063 6f6e 7472 6f6c 6c65 7220 746f  he controller to
+00024f40: 2062 6522 3b20 270a 2020 2020 2020 2020   be"; '.        
+00024f50: 2020 2020 2764 6f20 6563 686f 2022 5761      'do echo "Wa
+00024f60: 6974 696e 6720 666f 7220 7365 7276 6520  iting for serve 
+00024f70: 6c6f 6773 223b 2073 6c65 6570 2031 303b  logs"; sleep 10;
+00024f80: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
+00024f90: 2773 3d24 2873 6b79 2073 6572 7665 206c  's=$(sky serve l
+00024fa0: 6f67 7320 7b6e 616d 657d 2031 202d 2d6e  ogs {name} 1 --n
+00024fb0: 6f2d 666f 6c6c 6f77 293b 2064 6f6e 653b  o-follow); done;
+00024fc0: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
+00024fd0: 6563 686f 2022 2473 223b 2065 6368 6f20  echo "$s"; echo 
+00024fe0: 2224 7322 207c 2067 7265 7020 2243 6c69  "$s" | grep "Cli
+00024ff0: 656e 7420 6469 7363 6f6e 6e65 6374 6564  ent disconnected
+00025000: 2c20 7374 6f70 7069 6e67 2063 6f6d 7075  , stopping compu
+00025010: 7461 7469 6f6e 2227 2c0a 2020 2020 2020  tation"',.      
+00025020: 2020 5d2c 0a20 2020 2020 2020 205f 5445    ],.        _TE
+00025030: 4152 444f 574e 5f53 4552 5649 4345 2e66  ARDOWN_SERVICE.f
+00025040: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+00025050: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+00025060: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
+00025070: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00025080: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00025090: 742e 6d61 726b 2e73 6572 7665 0a64 6566  t.mark.serve.def
+000250a0: 2074 6573 745f 736b 7973 6572 7665 5f75   test_skyserve_u
+000250b0: 7064 6174 6528 6765 6e65 7269 635f 636c  pdate(generic_cl
+000250c0: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
+000250d0: 2222 5465 7374 2073 6b79 7365 7276 6520  ""Test skyserve 
+000250e0: 7769 7468 2075 7064 6174 6522 2222 0a20  with update""". 
+000250f0: 2020 206e 616d 6520 3d20 5f67 6574 5f73     name = _get_s
+00025100: 6572 7669 6365 5f6e 616d 6528 290a 2020  ervice_name().  
+00025110: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00025120: 2020 2020 2020 2066 2774 6573 742d 736b         f'test-sk
+00025130: 7973 6572 7665 2d75 7064 6174 6527 2c0a  yserve-update',.
+00025140: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00025150: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
+00025160: 6520 7570 202d 6e20 7b6e 616d 657d 202d  e up -n {name} -
+00025170: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+00025180: 636c 6f75 647d 202d 7920 7465 7374 732f  cloud} -y tests/
+00025190: 736b 7973 6572 7665 2f75 7064 6174 652f  skyserve/update/
+000251a0: 6f6c 642e 7961 6d6c 272c 0a20 2020 2020  old.yaml',.     
+000251b0: 2020 2020 2020 205f 5345 5256 455f 5741         _SERVE_WA
+000251c0: 4954 5f55 4e54 494c 5f52 4541 4459 2e66  IT_UNTIL_READY.f
+000251d0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 652c  ormat(name=name,
+000251e0: 2072 6570 6c69 6361 5f6e 756d 3d32 292c   replica_num=2),
+000251f0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00025200: 5f53 4552 5645 5f45 4e44 504f 494e 545f  _SERVE_ENDPOINT_
+00025210: 5741 4954 2e66 6f72 6d61 7428 6e61 6d65  WAIT.format(name
+00025220: 3d6e 616d 6529 7d3b 2063 7572 6c20 2d4c  =name)}; curl -L
+00025230: 2068 7474 703a 2f2f 2465 6e64 706f 696e   http://$endpoin
+00025240: 7420 7c20 6772 6570 2022 4869 2c20 536b  t | grep "Hi, Sk
+00025250: 7950 696c 6f74 2068 6572 6522 272c 0a20  yPilot here"',. 
+00025260: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00025270: 2073 6572 7665 2075 7064 6174 6520 7b6e   serve update {n
+00025280: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
+00025290: 6e65 7269 635f 636c 6f75 647d 202d 2d6d  neric_cloud} --m
+000252a0: 6f64 6520 626c 7565 5f67 7265 656e 202d  ode blue_green -
+000252b0: 7920 7465 7374 732f 736b 7973 6572 7665  y tests/skyserve
+000252c0: 2f75 7064 6174 652f 6e65 772e 7961 6d6c  /update/new.yaml
+000252d0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+000252e0: 2073 6c65 6570 2062 6566 6f72 6520 7570   sleep before up
+000252f0: 6461 7465 2069 7320 7265 6769 7374 6572  date is register
+00025300: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00025310: 2773 6c65 6570 2032 3027 2c0a 2020 2020  'sleep 20',.    
+00025320: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
+00025330: 455f 454e 4450 4f49 4e54 5f57 4149 542e  E_ENDPOINT_WAIT.
+00025340: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00025350: 297d 3b20 270a 2020 2020 2020 2020 2020  )}; '.          
+00025360: 2020 2775 6e74 696c 2063 7572 6c20 2d4c    'until curl -L
+00025370: 2068 7474 703a 2f2f 2465 6e64 706f 696e   http://$endpoin
+00025380: 7420 7c20 6772 6570 2022 4869 2c20 6e65  t | grep "Hi, ne
+00025390: 7720 536b 7950 696c 6f74 2068 6572 6521  w SkyPilot here!
+000253a0: 223b 2064 6f20 736c 6565 7020 323b 2064  "; do sleep 2; d
+000253b0: 6f6e 653b 270a 2020 2020 2020 2020 2020  one;'.          
+000253c0: 2020 2320 4d61 6b65 2073 7572 6520 7468    # Make sure th
+000253d0: 6520 7472 6166 6669 6320 6973 206e 6f74  e traffic is not
+000253e0: 206d 6978 6564 0a20 2020 2020 2020 2020   mixed.         
+000253f0: 2020 2027 6375 726c 202d 4c20 6874 7470     'curl -L http
+00025400: 3a2f 2f24 656e 6470 6f69 6e74 207c 2067  ://$endpoint | g
+00025410: 7265 7020 2248 692c 206e 6577 2053 6b79  rep "Hi, new Sky
+00025420: 5069 6c6f 7420 6865 7265 2227 2c0a 2020  Pilot here"',.  
+00025430: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
+00025440: 6c61 7465 7374 2032 2076 6572 7369 6f6e  latest 2 version
+00025450: 2073 686f 756c 6420 6265 2052 4541 4459   should be READY
+00025460: 2061 6e64 2074 6865 206f 6c64 6572 2076   and the older v
+00025470: 6572 7369 6f6e 7320 7368 6f75 6c64 2062  ersions should b
+00025480: 6520 7368 7574 7469 6e67 2064 6f77 6e0a  e shutting down.
+00025490: 2020 2020 2020 2020 2020 2020 285f 6368              (_ch
+000254a0: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
+000254b0: 7461 7475 7328 6e61 6d65 2c20 5b28 322c  tatus(name, [(2,
+000254c0: 2046 616c 7365 2c20 2752 4541 4459 2729   False, 'READY')
+000254d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000254e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000254f0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00025500: 322c 2046 616c 7365 2c20 2753 4855 5454  2, False, 'SHUTT
+00025510: 494e 475f 444f 574e 2729 5d29 202b 0a20  ING_DOWN')]) +. 
+00025520: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
+00025530: 636b 5f73 6572 7669 6365 5f76 6572 7369  ck_service_versi
+00025540: 6f6e 286e 616d 652c 2022 3222 2929 2c0a  on(name, "2")),.
+00025550: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00025560: 2020 205f 5445 4152 444f 574e 5f53 4552     _TEARDOWN_SER
+00025570: 5649 4345 2e66 6f72 6d61 7428 6e61 6d65  VICE.format(name
+00025580: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
+00025590: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
+000255a0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+000255b0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+000255c0: 4070 7974 6573 742e 6d61 726b 2e73 6572  @pytest.mark.ser
+000255d0: 7665 0a64 6566 2074 6573 745f 736b 7973  ve.def test_skys
+000255e0: 6572 7665 5f72 6f6c 6c69 6e67 5f75 7064  erve_rolling_upd
+000255f0: 6174 6528 6765 6e65 7269 635f 636c 6f75  ate(generic_clou
+00025600: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
+00025610: 5465 7374 2073 6b79 7365 7276 6520 7769  Test skyserve wi
+00025620: 7468 2072 6f6c 6c69 6e67 2075 7064 6174  th rolling updat
+00025630: 6522 2222 0a20 2020 206e 616d 6520 3d20  e""".    name = 
+00025640: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
+00025650: 6528 290a 2020 2020 7369 6e67 6c65 5f6e  e().    single_n
+00025660: 6577 5f72 6570 6c69 6361 203d 205f 6368  ew_replica = _ch
+00025670: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
+00025680: 7461 7475 7328 0a20 2020 2020 2020 206e  tatus(.        n
+00025690: 616d 652c 205b 2832 2c20 4661 6c73 652c  ame, [(2, False,
+000256a0: 2027 5245 4144 5927 292c 2028 312c 2046   'READY'), (1, F
+000256b0: 616c 7365 2c20 5f53 4552 5649 4345 5f4c  alse, _SERVICE_L
+000256c0: 4155 4e43 4849 4e47 5f53 5441 5455 535f  AUNCHING_STATUS_
+000256d0: 5245 4745 5829 2c0a 2020 2020 2020 2020  REGEX),.        
+000256e0: 2020 2020 2020 2028 312c 2046 616c 7365         (1, False
+000256f0: 2c20 2753 4855 5454 494e 475f 444f 574e  , 'SHUTTING_DOWN
+00025700: 2729 5d29 0a20 2020 2074 6573 7420 3d20  ')]).    test = 
+00025710: 5465 7374 280a 2020 2020 2020 2020 6627  Test(.        f'
+00025720: 7465 7374 2d73 6b79 7365 7276 652d 726f  test-skyserve-ro
+00025730: 6c6c 696e 672d 7570 6461 7465 272c 0a20  lling-update',. 
+00025740: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00025750: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
+00025760: 2075 7020 2d6e 207b 6e61 6d65 7d20 2d2d   up -n {name} --
+00025770: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
+00025780: 6c6f 7564 7d20 2d79 2074 6573 7473 2f73  loud} -y tests/s
+00025790: 6b79 7365 7276 652f 7570 6461 7465 2f6f  kyserve/update/o
+000257a0: 6c64 2e79 616d 6c27 2c0a 2020 2020 2020  ld.yaml',.      
+000257b0: 2020 2020 2020 5f53 4552 5645 5f57 4149        _SERVE_WAI
+000257c0: 545f 554e 5449 4c5f 5245 4144 592e 666f  T_UNTIL_READY.fo
+000257d0: 726d 6174 286e 616d 653d 6e61 6d65 2c20  rmat(name=name, 
+000257e0: 7265 706c 6963 615f 6e75 6d3d 3229 2c0a  replica_num=2),.
+000257f0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00025800: 5345 5256 455f 454e 4450 4f49 4e54 5f57  SERVE_ENDPOINT_W
+00025810: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
+00025820: 6e61 6d65 297d 3b20 6375 726c 202d 4c20  name)}; curl -L 
+00025830: 6874 7470 3a2f 2f24 656e 6470 6f69 6e74  http://$endpoint
+00025840: 207c 2067 7265 7020 2248 692c 2053 6b79   | grep "Hi, Sky
+00025850: 5069 6c6f 7420 6865 7265 2227 2c0a 2020  Pilot here"',.  
+00025860: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00025870: 7365 7276 6520 7570 6461 7465 207b 6e61  serve update {na
+00025880: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
+00025890: 6572 6963 5f63 6c6f 7564 7d20 2d79 2074  eric_cloud} -y t
+000258a0: 6573 7473 2f73 6b79 7365 7276 652f 7570  ests/skyserve/up
+000258b0: 6461 7465 2f6e 6577 2e79 616d 6c27 2c0a  date/new.yaml',.
+000258c0: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
+000258d0: 6b65 2073 7572 6520 7468 6520 7472 6166  ke sure the traf
+000258e0: 6669 6320 6973 206d 6978 6564 2061 6372  fic is mixed acr
+000258f0: 6f73 7320 7477 6f20 7665 7273 696f 6e73  oss two versions
+00025900: 2c20 7468 6520 7265 706c 6963 6173 0a20  , the replicas. 
+00025910: 2020 2020 2020 2020 2020 2023 2077 6974             # wit
+00025920: 6820 6576 656e 2069 6420 7769 6c6c 2073  h even id will s
+00025930: 6c65 6570 2036 3020 7365 636f 6e64 7320  leep 60 seconds 
+00025940: 6265 666f 7265 2062 6569 6e67 2072 6561  before being rea
+00025950: 6479 2c20 736f 2077 650a 2020 2020 2020  dy, so we.      
+00025960: 2020 2020 2020 2320 7368 6f75 6c64 2062        # should b
+00025970: 6520 6162 6c65 2074 6f20 6765 7420 6f62  e able to get ob
+00025980: 7365 7276 6520 7468 6520 7065 7269 6f64  serve the period
+00025990: 2074 6861 7420 7468 6520 7472 6166 6669   that the traffi
+000259a0: 6320 6973 206d 6978 6564 0a20 2020 2020  c is mixed.     
+000259b0: 2020 2020 2020 2023 2061 6372 6f73 7320         # across 
+000259c0: 7477 6f20 7665 7273 696f 6e73 2e0a 2020  two versions..  
+000259d0: 2020 2020 2020 2020 2020 6627 7b5f 5345            f'{_SE
+000259e0: 5256 455f 454e 4450 4f49 4e54 5f57 4149  RVE_ENDPOINT_WAI
+000259f0: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
+00025a00: 6d65 297d 3b20 270a 2020 2020 2020 2020  me)}; '.        
+00025a10: 2020 2020 2775 6e74 696c 2063 7572 6c20      'until curl 
+00025a20: 2d4c 2068 7474 703a 2f2f 2465 6e64 706f  -L http://$endpo
+00025a30: 696e 7420 7c20 6772 6570 2022 4869 2c20  int | grep "Hi, 
+00025a40: 6e65 7720 536b 7950 696c 6f74 2068 6572  new SkyPilot her
+00025a50: 6521 223b 2064 6f20 736c 6565 7020 323b  e!"; do sleep 2;
+00025a60: 2064 6f6e 653b 2073 6c65 6570 2032 3b20   done; sleep 2; 
+00025a70: 270a 2020 2020 2020 2020 2020 2020 2320  '.            # 
+00025a80: 5468 6520 6c61 7465 7374 2076 6572 7369  The latest versi
+00025a90: 6f6e 2073 686f 756c 6420 6861 7665 206f  on should have o
+00025aa0: 6e65 2052 4541 4459 2061 6e64 2074 6865  ne READY and the
+00025ab0: 206f 6e65 206f 6620 7468 6520 6f6c 6465   one of the olde
+00025ac0: 7220 7665 7273 696f 6e73 2073 686f 756c  r versions shoul
+00025ad0: 6420 6265 2073 6875 7474 696e 6720 646f  d be shutting do
+00025ae0: 776e 0a20 2020 2020 2020 2020 2020 2066  wn.            f
+00025af0: 277b 7369 6e67 6c65 5f6e 6577 5f72 6570  '{single_new_rep
+00025b00: 6c69 6361 7d20 7b5f 6368 6563 6b5f 7365  lica} {_check_se
+00025b10: 7276 6963 655f 7665 7273 696f 6e28 6e61  rvice_version(na
+00025b20: 6d65 2c20 2231 2c32 2229 7d20 270a 2020  me, "1,2")} '.  
+00025b30: 2020 2020 2020 2020 2020 2320 4368 6563            # Chec
+00025b40: 6b20 7468 6520 6f75 7470 7574 2066 726f  k the output fro
+00025b50: 6d20 7468 6520 6f6c 6420 7665 7273 696f  m the old versio
+00025b60: 6e2c 2069 6d6d 6564 6961 7465 6c79 2061  n, immediately a
+00025b70: 6674 6572 2074 6865 0a20 2020 2020 2020  fter the.       
+00025b80: 2020 2020 2023 206f 7574 7075 7420 6672       # output fr
+00025b90: 6f6d 2074 6865 206e 6577 2076 6572 7369  om the new versi
+00025ba0: 6f6e 2061 7070 6561 7273 2e20 5468 6973  on appears. This
+00025bb0: 2069 7320 6775 6172 616e 7465 6564 2062   is guaranteed b
+00025bc0: 7920 7468 650a 2020 2020 2020 2020 2020  y the.          
+00025bd0: 2020 2320 726f 756e 6420 726f 6269 6e20    # round robin 
+00025be0: 6c6f 6164 2062 616c 616e 6369 6e67 2070  load balancing p
+00025bf0: 6f6c 6963 792e 0a20 2020 2020 2020 2020  olicy..         
+00025c00: 2020 2023 2054 4f44 4f28 7a68 7775 293a     # TODO(zhwu):
+00025c10: 2077 6520 7368 6f75 6c64 2068 6176 6520   we should have 
+00025c20: 6120 6d6f 7265 2067 656e 6572 616c 697a  a more generaliz
+00025c30: 6564 2077 6179 2066 6f72 2063 6865 636b  ed way for check
+00025c40: 696e 6720 7468 650a 2020 2020 2020 2020  ing the.        
+00025c50: 2020 2020 2320 6d69 7865 6420 7665 7273      # mixed vers
+00025c60: 696f 6e20 6f66 2072 6570 6c69 6361 7320  ion of replicas 
+00025c70: 746f 2061 766f 6964 2064 6570 656e 6469  to avoid dependi
+00025c80: 6e67 206f 6e20 7468 6520 7370 6563 6966  ng on the specif
+00025c90: 6963 0a20 2020 2020 2020 2020 2020 2023  ic.            #
+00025ca0: 2072 6f75 6e64 2072 6f62 696e 206c 6f61   round robin loa
+00025cb0: 6420 6261 6c61 6e63 696e 6720 706f 6c69  d balancing poli
+00025cc0: 6379 2e0a 2020 2020 2020 2020 2020 2020  cy..            
+00025cd0: 2763 7572 6c20 2d4c 2068 7474 703a 2f2f  'curl -L http://
+00025ce0: 2465 6e64 706f 696e 7420 7c20 6772 6570  $endpoint | grep
+00025cf0: 2022 4869 2c20 536b 7950 696c 6f74 2068   "Hi, SkyPilot h
+00025d00: 6572 6522 272c 0a20 2020 2020 2020 205d  ere"',.        ]
+00025d10: 2c0a 2020 2020 2020 2020 5f54 4541 5244  ,.        _TEARD
+00025d20: 4f57 4e5f 5345 5256 4943 452e 666f 726d  OWN_SERVICE.form
+00025d30: 6174 286e 616d 653d 6e61 6d65 292c 0a20  at(name=name),. 
+00025d40: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+00025d50: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
+00025d60: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00025d70: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00025d80: 6172 6b2e 7365 7276 650a 6465 6620 7465  ark.serve.def te
+00025d90: 7374 5f73 6b79 7365 7276 655f 6661 7374  st_skyserve_fast
+00025da0: 5f75 7064 6174 6528 6765 6e65 7269 635f  _update(generic_
+00025db0: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+00025dc0: 2022 2222 5465 7374 2073 6b79 7365 7276   """Test skyserv
+00025dd0: 6520 7769 7468 2066 6173 7420 7570 6461  e with fast upda
+00025de0: 7465 2028 496e 6372 656d 656e 7420 7665  te (Increment ve
+00025df0: 7273 696f 6e20 6f66 206f 6c64 2072 6570  rsion of old rep
+00025e00: 6c69 6361 7329 2222 220a 2020 2020 6e61  licas)""".    na
+00025e10: 6d65 203d 205f 6765 745f 7365 7276 6963  me = _get_servic
+00025e20: 655f 6e61 6d65 2829 0a0a 2020 2020 7465  e_name()..    te
+00025e30: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00025e40: 2020 2066 2774 6573 742d 736b 7973 6572     f'test-skyser
+00025e50: 7665 2d66 6173 742d 7570 6461 7465 272c  ve-fast-update',
+00025e60: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00025e70: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
+00025e80: 7665 2075 7020 2d6e 207b 6e61 6d65 7d20  ve up -n {name} 
+00025e90: 2d79 202d 2d63 6c6f 7564 207b 6765 6e65  -y --cloud {gene
+00025ea0: 7269 635f 636c 6f75 647d 2074 6573 7473  ric_cloud} tests
+00025eb0: 2f73 6b79 7365 7276 652f 7570 6461 7465  /skyserve/update
+00025ec0: 2f62 756d 705f 7665 7273 696f 6e5f 6265  /bump_version_be
+00025ed0: 666f 7265 2e79 616d 6c27 2c0a 2020 2020  fore.yaml',.    
+00025ee0: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
+00025ef0: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
+00025f00: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00025f10: 2c20 7265 706c 6963 615f 6e75 6d3d 3229  , replica_num=2)
+00025f20: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00025f30: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
+00025f40: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
+00025f50: 653d 6e61 6d65 297d 3b20 6375 726c 202d  e=name)}; curl -
+00025f60: 4c20 6874 7470 3a2f 2f24 656e 6470 6f69  L http://$endpoi
+00025f70: 6e74 207c 2067 7265 7020 2248 692c 2053  nt | grep "Hi, S
+00025f80: 6b79 5069 6c6f 7420 6865 7265 2227 2c0a  kyPilot here"',.
+00025f90: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00025fa0: 7920 7365 7276 6520 7570 6461 7465 207b  y serve update {
+00025fb0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+00025fc0: 656e 6572 6963 5f63 6c6f 7564 7d20 2d2d  eneric_cloud} --
+00025fd0: 6d6f 6465 2062 6c75 655f 6772 6565 6e20  mode blue_green 
+00025fe0: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
+00025ff0: 652f 7570 6461 7465 2f62 756d 705f 7665  e/update/bump_ve
+00026000: 7273 696f 6e5f 6166 7465 722e 7961 6d6c  rsion_after.yaml
+00026010: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+00026020: 2073 6c65 6570 2074 6f20 7761 6974 2066   sleep to wait f
+00026030: 6f72 2075 7064 6174 6520 746f 2062 6520  or update to be 
+00026040: 7265 6769 7374 6572 6564 2e0a 2020 2020  registered..    
+00026050: 2020 2020 2020 2020 2773 6c65 6570 2033          'sleep 3
+00026060: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00026070: 2320 3220 6f6e 2d64 6561 6d6e 6420 2872  # 2 on-deamnd (r
+00026080: 6561 6479 2920 2b20 3120 6f6e 2d64 656d  eady) + 1 on-dem
+00026090: 616e 6420 2870 726f 7669 7369 6f6e 696e  and (provisionin
+000260a0: 6729 2e0a 2020 2020 2020 2020 2020 2020  g)..            
+000260b0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000260c0: 2020 5f63 6865 636b 5f72 6570 6c69 6361    _check_replica
+000260d0: 5f69 6e5f 7374 6174 7573 280a 2020 2020  _in_status(.    
+000260e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000260f0: 6e61 6d65 2c20 5b28 322c 2046 616c 7365  name, [(2, False
+00026100: 2c20 2752 4541 4459 2729 2c0a 2020 2020  , 'READY'),.    
+00026110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026120: 2020 2020 2020 2028 312c 2046 616c 7365         (1, False
+00026130: 2c20 5f53 4552 5649 4345 5f4c 4155 4e43  , _SERVICE_LAUNC
+00026140: 4849 4e47 5f53 5441 5455 535f 5245 4745  HING_STATUS_REGE
+00026150: 5829 5d29 202b 0a20 2020 2020 2020 2020  X)]) +.         
+00026160: 2020 2020 2020 2023 2046 6173 7420 7570         # Fast up
+00026170: 6461 7465 2077 696c 6c20 6469 7265 6374  date will direct
+00026180: 6c79 2068 6176 6520 7468 6520 6c61 7465  ly have the late
+00026190: 7374 2076 6572 7369 6f6e 2072 6561 6479  st version ready
+000261a0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000261b0: 2020 5f63 6865 636b 5f73 6572 7669 6365    _check_service
+000261c0: 5f76 6572 7369 6f6e 286e 616d 652c 2022  _version(name, "
+000261d0: 3222 2929 2c0a 2020 2020 2020 2020 2020  2")),.          
+000261e0: 2020 5f53 4552 5645 5f57 4149 545f 554e    _SERVE_WAIT_UN
+000261f0: 5449 4c5f 5245 4144 592e 666f 726d 6174  TIL_READY.format
+00026200: 286e 616d 653d 6e61 6d65 2c20 7265 706c  (name=name, repl
+00026210: 6963 615f 6e75 6d3d 3329 202b 0a20 2020  ica_num=3) +.   
+00026220: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
+00026230: 7365 7276 6963 655f 7665 7273 696f 6e28  service_version(
+00026240: 6e61 6d65 2c20 2232 2229 2c0a 2020 2020  name, "2"),.    
+00026250: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
+00026260: 455f 454e 4450 4f49 4e54 5f57 4149 542e  E_ENDPOINT_WAIT.
+00026270: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00026280: 297d 3b20 6375 726c 202d 4c20 6874 7470  )}; curl -L http
+00026290: 3a2f 2f24 656e 6470 6f69 6e74 207c 2067  ://$endpoint | g
+000262a0: 7265 7020 2248 692c 2053 6b79 5069 6c6f  rep "Hi, SkyPilo
+000262b0: 7420 6865 7265 2227 2c0a 2020 2020 2020  t here"',.      
+000262c0: 2020 2020 2020 2320 5465 7374 2072 6f6c        # Test rol
+000262d0: 6c69 6e67 2075 7064 6174 650a 2020 2020  ling update.    
+000262e0: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
+000262f0: 7276 6520 7570 6461 7465 207b 6e61 6d65  rve update {name
+00026300: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+00026310: 6963 5f63 6c6f 7564 7d20 2d79 2074 6573  ic_cloud} -y tes
+00026320: 7473 2f73 6b79 7365 7276 652f 7570 6461  ts/skyserve/upda
+00026330: 7465 2f62 756d 705f 7665 7273 696f 6e5f  te/bump_version_
+00026340: 6265 666f 7265 2e79 616d 6c27 2c0a 2020  before.yaml',.  
+00026350: 2020 2020 2020 2020 2020 2320 736c 6565            # slee
+00026360: 7020 746f 2077 6169 7420 666f 7220 7570  p to wait for up
+00026370: 6461 7465 2074 6f20 6265 2072 6567 6973  date to be regis
+00026380: 7465 7265 642e 0a20 2020 2020 2020 2020  tered..         
+00026390: 2020 2027 736c 6565 7020 3135 272c 0a20     'sleep 15',. 
+000263a0: 2020 2020 2020 2020 2020 2023 2032 206f             # 2 o
+000263b0: 6e2d 6465 616d 6e64 2028 7265 6164 7929  n-deamnd (ready)
+000263c0: 202b 2031 206f 6e2d 6465 6d61 6e64 2028   + 1 on-demand (
+000263d0: 7368 7574 7469 6e67 2064 6f77 6e29 2e0a  shutting down)..
+000263e0: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
+000263f0: 636b 5f72 6570 6c69 6361 5f69 6e5f 7374  ck_replica_in_st
+00026400: 6174 7573 286e 616d 652c 205b 2832 2c20  atus(name, [(2, 
+00026410: 4661 6c73 652c 2027 5245 4144 5927 292c  False, 'READY'),
+00026420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00026430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026440: 2020 2020 2020 2020 2020 2020 2028 312c               (1,
+00026450: 2046 616c 7365 2c20 2753 4855 5454 494e   False, 'SHUTTIN
+00026460: 475f 444f 574e 2729 5d29 2c0a 2020 2020  G_DOWN')]),.    
+00026470: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
+00026480: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
+00026490: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+000264a0: 2c20 7265 706c 6963 615f 6e75 6d3d 3229  , replica_num=2)
+000264b0: 202b 0a20 2020 2020 2020 2020 2020 205f   +.            _
+000264c0: 6368 6563 6b5f 7365 7276 6963 655f 7665  check_service_ve
+000264d0: 7273 696f 6e28 6e61 6d65 2c20 2233 2229  rsion(name, "3")
+000264e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000264f0: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
+00026500: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
+00026510: 653d 6e61 6d65 297d 3b20 6375 726c 202d  e=name)}; curl -
+00026520: 4c20 6874 7470 3a2f 2f24 656e 6470 6f69  L http://$endpoi
+00026530: 6e74 207c 2067 7265 7020 2248 692c 2053  nt | grep "Hi, S
+00026540: 6b79 5069 6c6f 7420 6865 7265 2227 2c0a  kyPilot here"',.
+00026550: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00026560: 2020 205f 5445 4152 444f 574e 5f53 4552     _TEARDOWN_SER
+00026570: 5649 4345 2e66 6f72 6d61 7428 6e61 6d65  VICE.format(name
+00026580: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
+00026590: 7469 6d65 6f75 743d 3330 202a 2036 302c  timeout=30 * 60,
+000265a0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+000265b0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+000265c0: 4070 7974 6573 742e 6d61 726b 2e73 6572  @pytest.mark.ser
+000265d0: 7665 0a64 6566 2074 6573 745f 736b 7973  ve.def test_skys
+000265e0: 6572 7665 5f75 7064 6174 655f 6175 746f  erve_update_auto
+000265f0: 7363 616c 6528 6765 6e65 7269 635f 636c  scale(generic_cl
+00026600: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
+00026610: 2222 5465 7374 2073 6b79 7365 7276 6520  ""Test skyserve 
+00026620: 7570 6461 7465 2077 6974 6820 6175 746f  update with auto
+00026630: 7363 616c 6522 2222 0a20 2020 206e 616d  scale""".    nam
+00026640: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
+00026650: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00026660: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00026670: 2066 2774 6573 742d 736b 7973 6572 7665   f'test-skyserve
+00026680: 2d75 7064 6174 652d 6175 746f 7363 616c  -update-autoscal
+00026690: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
+000266a0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000266b0: 7365 7276 6520 7570 202d 6e20 7b6e 616d  serve up -n {nam
+000266c0: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
+000266d0: 7269 635f 636c 6f75 647d 202d 7920 7465  ric_cloud} -y te
+000266e0: 7374 732f 736b 7973 6572 7665 2f75 7064  sts/skyserve/upd
+000266f0: 6174 652f 6e75 6d5f 6d69 6e5f 7477 6f2e  ate/num_min_two.
+00026700: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00026710: 2020 205f 5345 5256 455f 5741 4954 5f55     _SERVE_WAIT_U
+00026720: 4e54 494c 5f52 4541 4459 2e66 6f72 6d61  NTIL_READY.forma
+00026730: 7428 6e61 6d65 3d6e 616d 652c 2072 6570  t(name=name, rep
+00026740: 6c69 6361 5f6e 756d 3d32 2920 2b0a 2020  lica_num=2) +.  
+00026750: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
+00026760: 5f73 6572 7669 6365 5f76 6572 7369 6f6e  _service_version
+00026770: 286e 616d 652c 2022 3122 292c 0a20 2020  (name, "1"),.   
+00026780: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
+00026790: 5645 5f45 4e44 504f 494e 545f 5741 4954  VE_ENDPOINT_WAIT
+000267a0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+000267b0: 6529 7d3b 2027 0a20 2020 2020 2020 2020  e)}; '.         
+000267c0: 2020 2027 6375 726c 202d 4c20 6874 7470     'curl -L http
+000267d0: 3a2f 2f24 656e 6470 6f69 6e74 207c 2067  ://$endpoint | g
+000267e0: 7265 7020 2248 692c 2053 6b79 5069 6c6f  rep "Hi, SkyPilo
+000267f0: 7420 6865 7265 2227 2c0a 2020 2020 2020  t here"',.      
+00026800: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
+00026810: 6520 7570 6461 7465 207b 6e61 6d65 7d20  e update {name} 
+00026820: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+00026830: 5f63 6c6f 7564 7d20 2d2d 6d6f 6465 2062  _cloud} --mode b
+00026840: 6c75 655f 6772 6565 6e20 2d79 2074 6573  lue_green -y tes
+00026850: 7473 2f73 6b79 7365 7276 652f 7570 6461  ts/skyserve/upda
+00026860: 7465 2f6e 756d 5f6d 696e 5f6f 6e65 2e79  te/num_min_one.y
+00026870: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00026880: 2020 2320 736c 6565 7020 6265 666f 7265    # sleep before
+00026890: 2075 7064 6174 6520 6973 2072 6567 6973   update is regis
+000268a0: 7465 7265 642e 0a20 2020 2020 2020 2020  tered..         
+000268b0: 2020 2027 736c 6565 7020 3230 272c 0a20     'sleep 20',. 
+000268c0: 2020 2020 2020 2020 2020 2023 2054 696d             # Tim
+000268d0: 656f 7574 2077 696c 6c20 6265 2074 7269  eout will be tri
+000268e0: 6767 6572 6564 2077 6865 6e20 7570 6461  ggered when upda
+000268f0: 7465 2066 6169 6c73 2e0a 2020 2020 2020  te fails..      
+00026900: 2020 2020 2020 5f53 4552 5645 5f57 4149        _SERVE_WAI
+00026910: 545f 554e 5449 4c5f 5245 4144 592e 666f  T_UNTIL_READY.fo
+00026920: 726d 6174 286e 616d 653d 6e61 6d65 2c20  rmat(name=name, 
+00026930: 7265 706c 6963 615f 6e75 6d3d 3129 202b  replica_num=1) +
+00026940: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
+00026950: 6563 6b5f 7365 7276 6963 655f 7665 7273  eck_service_vers
+00026960: 696f 6e28 6e61 6d65 2c20 2232 2229 2c0a  ion(name, "2"),.
+00026970: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00026980: 5345 5256 455f 454e 4450 4f49 4e54 5f57  SERVE_ENDPOINT_W
+00026990: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
+000269a0: 6e61 6d65 297d 3b20 270a 2020 2020 2020  name)}; '.      
+000269b0: 2020 2020 2020 2763 7572 6c20 2d4c 2068        'curl -L h
+000269c0: 7474 703a 2f2f 2465 6e64 706f 696e 7420  ttp://$endpoint 
+000269d0: 7c20 6772 6570 2022 4869 2c20 536b 7950  | grep "Hi, SkyP
+000269e0: 696c 6f74 2068 6572 6521 2227 2c0a 2020  ilot here!"',.  
+000269f0: 2020 2020 2020 2020 2020 2320 526f 6c6c            # Roll
+00026a00: 696e 6720 5570 6461 7465 0a20 2020 2020  ing Update.     
+00026a10: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
+00026a20: 7665 2075 7064 6174 6520 7b6e 616d 657d  ve update {name}
+00026a30: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+00026a40: 635f 636c 6f75 647d 202d 7920 7465 7374  c_cloud} -y test
+00026a50: 732f 736b 7973 6572 7665 2f75 7064 6174  s/skyserve/updat
+00026a60: 652f 6e75 6d5f 6d69 6e5f 7477 6f2e 7961  e/num_min_two.ya
+00026a70: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00026a80: 2023 2073 6c65 6570 2062 6566 6f72 6520   # sleep before 
+00026a90: 7570 6461 7465 2069 7320 7265 6769 7374  update is regist
+00026aa0: 6572 6564 2e0a 2020 2020 2020 2020 2020  ered..          
+00026ab0: 2020 2773 6c65 6570 2032 3027 2c0a 2020    'sleep 20',.  
+00026ac0: 2020 2020 2020 2020 2020 2320 5469 6d65            # Time
+00026ad0: 6f75 7420 7769 6c6c 2062 6520 7472 6967  out will be trig
+00026ae0: 6765 7265 6420 7768 656e 2075 7064 6174  gered when updat
+00026af0: 6520 6661 696c 732e 0a20 2020 2020 2020  e fails..       
+00026b00: 2020 2020 205f 5345 5256 455f 5741 4954       _SERVE_WAIT
+00026b10: 5f55 4e54 494c 5f52 4541 4459 2e66 6f72  _UNTIL_READY.for
+00026b20: 6d61 7428 6e61 6d65 3d6e 616d 652c 2072  mat(name=name, r
+00026b30: 6570 6c69 6361 5f6e 756d 3d32 2920 2b0a  eplica_num=2) +.
+00026b40: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
+00026b50: 636b 5f73 6572 7669 6365 5f76 6572 7369  ck_service_versi
+00026b60: 6f6e 286e 616d 652c 2022 3322 292c 0a20  on(name, "3"),. 
+00026b70: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+00026b80: 4552 5645 5f45 4e44 504f 494e 545f 5741  ERVE_ENDPOINT_WA
+00026b90: 4954 2e66 6f72 6d61 7428 6e61 6d65 3d6e  IT.format(name=n
+00026ba0: 616d 6529 7d3b 2027 0a20 2020 2020 2020  ame)}; '.       
+00026bb0: 2020 2020 2027 6375 726c 202d 4c20 6874       'curl -L ht
+00026bc0: 7470 3a2f 2f24 656e 6470 6f69 6e74 207c  tp://$endpoint |
+00026bd0: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
+00026be0: 6c6f 7420 6865 7265 2122 272c 0a20 2020  lot here!"',.   
+00026bf0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00026c00: 5f54 4541 5244 4f57 4e5f 5345 5256 4943  _TEARDOWN_SERVIC
+00026c10: 452e 666f 726d 6174 286e 616d 653d 6e61  E.format(name=na
+00026c20: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
+00026c30: 656f 7574 3d33 3020 2a20 3630 2c0a 2020  eout=30 * 60,.  
+00026c40: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00026c50: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00026c60: 7465 7374 2e6d 6172 6b2e 7365 7276 650a  test.mark.serve.
+00026c70: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00026c80: 6b75 6265 726e 6574 6573 2020 2320 5370  kubernetes  # Sp
+00026c90: 6f74 2069 6e73 7461 6e63 6573 2061 7265  ot instances are
+00026ca0: 206e 6f74 2073 7570 706f 7274 6564 2069   not supported i
+00026cb0: 6e20 4b75 6265 726e 6574 6573 0a40 7079  n Kubernetes.@py
+00026cc0: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
+00026cd0: 7472 697a 6528 276d 6f64 6527 2c20 5b27  trize('mode', ['
+00026ce0: 726f 6c6c 696e 6727 2c20 2762 6c75 655f  rolling', 'blue_
+00026cf0: 6772 6565 6e27 5d29 0a64 6566 2074 6573  green']).def tes
+00026d00: 745f 736b 7973 6572 7665 5f6e 6577 5f61  t_skyserve_new_a
+00026d10: 7574 6f73 6361 6c65 725f 7570 6461 7465  utoscaler_update
+00026d20: 286d 6f64 653a 2073 7472 2c20 6765 6e65  (mode: str, gene
+00026d30: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
+00026d40: 0a20 2020 2022 2222 5465 7374 2073 6b79  .    """Test sky
+00026d50: 7365 7276 6520 7769 7468 2075 7064 6174  serve with updat
+00026d60: 6520 7468 6174 2063 6861 6e67 6573 2061  e that changes a
+00026d70: 7574 6f73 6361 6c65 7222 2222 0a20 2020  utoscaler""".   
+00026d80: 206e 616d 6520 3d20 5f67 6574 5f73 6572   name = _get_ser
+00026d90: 7669 6365 5f6e 616d 6528 2920 2b20 6d6f  vice_name() + mo
+00026da0: 6465 0a0a 2020 2020 666f 7572 5f73 706f  de..    four_spo
+00026db0: 745f 7570 5f63 6d64 203d 205f 6368 6563  t_up_cmd = _chec
+00026dc0: 6b5f 7265 706c 6963 615f 696e 5f73 7461  k_replica_in_sta
+00026dd0: 7475 7328 6e61 6d65 2c20 5b28 342c 2054  tus(name, [(4, T
+00026de0: 7275 652c 2027 5245 4144 5927 295d 290a  rue, 'READY')]).
+00026df0: 2020 2020 7570 6461 7465 5f63 6865 636b      update_check
+00026e00: 203d 205b 6627 756e 7469 6c20 287b 666f   = [f'until ({fo
+00026e10: 7572 5f73 706f 745f 7570 5f63 6d64 7d29  ur_spot_up_cmd})
+00026e20: 3b20 646f 2073 6c65 6570 2035 3b20 646f  ; do sleep 5; do
+00026e30: 6e65 3b20 736c 6565 7020 3130 3b27 5d0a  ne; sleep 10;'].
+00026e40: 2020 2020 6966 206d 6f64 6520 3d3d 2027      if mode == '
+00026e50: 726f 6c6c 696e 6727 3a0a 2020 2020 2020  rolling':.      
+00026e60: 2020 2320 4368 6563 6b20 726f 6c6c 696e    # Check rollin
+00026e70: 6720 7570 6461 7465 2c20 6974 2077 696c  g update, it wil
+00026e80: 6c20 7465 726d 696e 6174 6520 6f6e 6520  l terminate one 
+00026e90: 6f66 2074 6865 206f 6c64 206f 6e2d 6465  of the old on-de
+00026ea0: 6d61 6e64 0a20 2020 2020 2020 2023 2069  mand.        # i
+00026eb0: 6e73 7461 6e63 6573 2c20 6f6e 6365 2074  nstances, once t
+00026ec0: 6865 7265 2061 7265 2034 2073 706f 7420  here are 4 spot 
+00026ed0: 696e 7374 616e 6365 2072 6561 6479 2e0a  instance ready..
+00026ee0: 2020 2020 2020 2020 7570 6461 7465 5f63          update_c
+00026ef0: 6865 636b 202b 3d20 5b0a 2020 2020 2020  heck += [.      
+00026f00: 2020 2020 2020 5f63 6865 636b 5f72 6570        _check_rep
+00026f10: 6c69 6361 5f69 6e5f 7374 6174 7573 280a  lica_in_status(.
+00026f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026f30: 6e61 6d65 2c20 5b28 312c 2046 616c 7365  name, [(1, False
+00026f40: 2c20 5f53 4552 5649 4345 5f4c 4155 4e43  , _SERVICE_LAUNC
+00026f50: 4849 4e47 5f53 5441 5455 535f 5245 4745  HING_STATUS_REGE
+00026f60: 5829 2c0a 2020 2020 2020 2020 2020 2020  X),.            
+00026f70: 2020 2020 2020 2020 2020 2028 312c 2046             (1, F
+00026f80: 616c 7365 2c20 2753 4855 5454 494e 475f  alse, 'SHUTTING_
+00026f90: 444f 574e 2729 2c20 2831 2c20 4661 6c73  DOWN'), (1, Fals
+00026fa0: 652c 2027 5245 4144 5927 295d 2920 2b0a  e, 'READY')]) +.
+00026fb0: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
+00026fc0: 636b 5f73 6572 7669 6365 5f76 6572 7369  ck_service_versi
+00026fd0: 6f6e 286e 616d 652c 2022 312c 3222 292c  on(name, "1,2"),
+00026fe0: 0a20 2020 2020 2020 205d 0a20 2020 2065  .        ].    e
+00026ff0: 6c73 653a 0a20 2020 2020 2020 2023 2043  lse:.        # C
+00027000: 6865 636b 2062 6c75 6520 6772 6565 6e20  heck blue green 
+00027010: 7570 6461 7465 2c20 6974 2077 696c 6c20  update, it will 
+00027020: 6b65 6570 2062 6f74 6820 6f6c 6420 6f6e  keep both old on
+00027030: 2d64 656d 616e 6420 696e 7374 616e 6365  -demand instance
+00027040: 730a 2020 2020 2020 2020 2320 7275 6e6e  s.        # runn
+00027050: 696e 672c 206f 6e63 6520 7468 6572 6520  ing, once there 
+00027060: 6172 6520 3420 7370 6f74 2069 6e73 7461  are 4 spot insta
+00027070: 6e63 6520 7265 6164 792e 0a20 2020 2020  nce ready..     
+00027080: 2020 2075 7064 6174 655f 6368 6563 6b20     update_check 
+00027090: 2b3d 205b 0a20 2020 2020 2020 2020 2020  += [.           
+000270a0: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
+000270b0: 696e 5f73 7461 7475 7328 0a20 2020 2020  in_status(.     
+000270c0: 2020 2020 2020 2020 2020 206e 616d 652c             name,
+000270d0: 205b 2831 2c20 4661 6c73 652c 205f 5345   [(1, False, _SE
+000270e0: 5256 4943 455f 4c41 554e 4348 494e 475f  RVICE_LAUNCHING_
+000270f0: 5354 4154 5553 5f52 4547 4558 292c 0a20  STATUS_REGEX),. 
+00027100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027110: 2020 2020 2020 2832 2c20 4661 6c73 652c        (2, False,
+00027120: 2027 5245 4144 5927 295d 2920 2b0a 2020   'READY')]) +.  
+00027130: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
+00027140: 5f73 6572 7669 6365 5f76 6572 7369 6f6e  _service_version
+00027150: 286e 616d 652c 2022 3122 292c 0a20 2020  (name, "1"),.   
+00027160: 2020 2020 205d 0a20 2020 2074 6573 7420       ].    test 
+00027170: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00027180: 2774 6573 742d 736b 7973 6572 7665 2d6e  'test-skyserve-n
+00027190: 6577 2d61 7574 6f73 6361 6c65 722d 7570  ew-autoscaler-up
+000271a0: 6461 7465 272c 0a20 2020 2020 2020 205b  date',.        [
+000271b0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000271c0: 6b79 2073 6572 7665 2075 7020 2d6e 207b  ky serve up -n {
+000271d0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+000271e0: 656e 6572 6963 5f63 6c6f 7564 7d20 2d79  eneric_cloud} -y
+000271f0: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
+00027200: 7570 6461 7465 2f6e 6577 5f61 7574 6f73  update/new_autos
+00027210: 6361 6c65 725f 6265 666f 7265 2e79 616d  caler_before.yam
+00027220: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00027230: 5f53 4552 5645 5f57 4149 545f 554e 5449  _SERVE_WAIT_UNTI
+00027240: 4c5f 5245 4144 592e 666f 726d 6174 286e  L_READY.format(n
+00027250: 616d 653d 6e61 6d65 2c20 7265 706c 6963  ame=name, replic
+00027260: 615f 6e75 6d3d 3229 202b 0a20 2020 2020  a_num=2) +.     
+00027270: 2020 2020 2020 205f 6368 6563 6b5f 7365         _check_se
+00027280: 7276 6963 655f 7665 7273 696f 6e28 6e61  rvice_version(na
+00027290: 6d65 2c20 2231 2229 2c0a 2020 2020 2020  me, "1"),.      
+000272a0: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
+000272b0: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
+000272c0: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
+000272d0: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+000272e0: 2773 3d24 2863 7572 6c20 2d4c 2068 7474  's=$(curl -L htt
+000272f0: 703a 2f2f 2465 6e64 706f 696e 7429 3b20  p://$endpoint); 
+00027300: 6563 686f 2022 2473 223b 2065 6368 6f20  echo "$s"; echo 
+00027310: 2224 7322 207c 2067 7265 7020 2248 692c  "$s" | grep "Hi,
+00027320: 2053 6b79 5069 6c6f 7420 6865 7265 2227   SkyPilot here"'
+00027330: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00027340: 736b 7920 7365 7276 6520 7570 6461 7465  sky serve update
+00027350: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00027360: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+00027370: 2d2d 6d6f 6465 207b 6d6f 6465 7d20 2d79  --mode {mode} -y
+00027380: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
+00027390: 7570 6461 7465 2f6e 6577 5f61 7574 6f73  update/new_autos
+000273a0: 6361 6c65 725f 6166 7465 722e 7961 6d6c  caler_after.yaml
+000273b0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+000273c0: 2057 6169 7420 666f 7220 7570 6461 7465   Wait for update
+000273d0: 2074 6f20 6265 2072 6567 6973 7465 7265   to be registere
+000273e0: 640a 2020 2020 2020 2020 2020 2020 6627  d.            f'
+000273f0: 736c 6565 7020 3132 3027 2c0a 2020 2020  sleep 120',.    
+00027400: 2020 2020 2020 2020 5f63 6865 636b 5f72          _check_r
+00027410: 6570 6c69 6361 5f69 6e5f 7374 6174 7573  eplica_in_status
+00027420: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00027430: 2020 6e61 6d65 2c20 5b28 342c 2054 7275    name, [(4, Tru
+00027440: 652c 205f 5345 5256 4943 455f 4c41 554e  e, _SERVICE_LAUN
+00027450: 4348 494e 475f 5354 4154 5553 5f52 4547  CHING_STATUS_REG
+00027460: 4558 202b 2027 5c7c 5245 4144 5927 292c  EX + '\|READY'),
+00027470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027480: 2020 2020 2020 2020 2831 2c20 4661 6c73          (1, Fals
+00027490: 652c 205f 5345 5256 4943 455f 4c41 554e  e, _SERVICE_LAUN
+000274a0: 4348 494e 475f 5354 4154 5553 5f52 4547  CHING_STATUS_REG
+000274b0: 4558 292c 0a20 2020 2020 2020 2020 2020  EX),.           
+000274c0: 2020 2020 2020 2020 2020 2020 2832 2c20              (2, 
+000274d0: 4661 6c73 652c 2027 5245 4144 5927 295d  False, 'READY')]
+000274e0: 292c 0a20 2020 2020 2020 2020 2020 202a  ),.            *
+000274f0: 7570 6461 7465 5f63 6865 636b 2c0a 2020  update_check,.  
+00027500: 2020 2020 2020 2020 2020 5f53 4552 5645            _SERVE
+00027510: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
+00027520: 592e 666f 726d 6174 286e 616d 653d 6e61  Y.format(name=na
+00027530: 6d65 2c20 7265 706c 6963 615f 6e75 6d3d  me, replica_num=
+00027540: 3529 2c0a 2020 2020 2020 2020 2020 2020  5),.            
+00027550: 6627 7b5f 5345 5256 455f 454e 4450 4f49  f'{_SERVE_ENDPOI
+00027560: 4e54 5f57 4149 542e 666f 726d 6174 286e  NT_WAIT.format(n
+00027570: 616d 653d 6e61 6d65 297d 3b20 270a 2020  ame=name)}; '.  
+00027580: 2020 2020 2020 2020 2020 2763 7572 6c20            'curl 
+00027590: 2d4c 2068 7474 703a 2f2f 2465 6e64 706f  -L http://$endpo
+000275a0: 696e 7420 7c20 6772 6570 2022 4869 2c20  int | grep "Hi, 
+000275b0: 536b 7950 696c 6f74 2068 6572 6522 272c  SkyPilot here"',
+000275c0: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
+000275d0: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
+000275e0: 7461 7475 7328 6e61 6d65 2c20 5b28 342c  tatus(name, [(4,
+000275f0: 2054 7275 652c 2027 5245 4144 5927 292c   True, 'READY'),
+00027600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027620: 2020 2020 2020 2020 2020 2020 2028 312c               (1,
+00027630: 2046 616c 7365 2c20 2752 4541 4459 2729   False, 'READY')
+00027640: 5d29 2c0a 2020 2020 2020 2020 5d2c 0a20  ]),.        ],. 
+00027650: 2020 2020 2020 205f 5445 4152 444f 574e         _TEARDOWN
+00027660: 5f53 4552 5649 4345 2e66 6f72 6d61 7428  _SERVICE.format(
+00027670: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
+00027680: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
+00027690: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+000276a0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+000276b0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+000276c0: 2e73 6572 7665 0a64 6566 2074 6573 745f  .serve.def test_
+000276d0: 736b 7973 6572 7665 5f66 6169 6c75 7265  skyserve_failure
+000276e0: 7328 6765 6e65 7269 635f 636c 6f75 643a  s(generic_cloud:
+000276f0: 2073 7472 293a 0a20 2020 2022 2222 5465   str):.    """Te
+00027700: 7374 2072 6570 6c69 6361 2066 6169 6c75  st replica failu
+00027710: 7265 2073 7461 7475 7365 7322 2222 0a20  re statuses""". 
+00027720: 2020 206e 616d 6520 3d20 5f67 6574 5f73     name = _get_s
+00027730: 6572 7669 6365 5f6e 616d 6528 290a 0a20  ervice_name().. 
+00027740: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00027750: 2020 2020 2020 2020 2774 6573 742d 736b          'test-sk
+00027760: 7973 6572 7665 2d66 6169 6c75 7265 7327  yserve-failures'
+00027770: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00027780: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
+00027790: 7276 6520 7570 202d 6e20 7b6e 616d 657d  rve up -n {name}
+000277a0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+000277b0: 635f 636c 6f75 647d 202d 7920 7465 7374  c_cloud} -y test
+000277c0: 732f 736b 7973 6572 7665 2f66 6169 6c75  s/skyserve/failu
+000277d0: 7265 732f 696e 6974 6961 6c5f 6465 6c61  res/initial_dela
+000277e0: 792e 7961 6d6c 272c 0a20 2020 2020 2020  y.yaml',.       
+000277f0: 2020 2020 2066 2773 3d24 2873 6b79 2073       f's=$(sky s
+00027800: 6572 7665 2073 7461 7475 7320 7b6e 616d  erve status {nam
+00027810: 657d 293b 2027 0a20 2020 2020 2020 2020  e}); '.         
+00027820: 2020 2066 2775 6e74 696c 2065 6368 6f20     f'until echo 
+00027830: 2224 7322 207c 2067 7265 7020 2246 4149  "$s" | grep "FAI
+00027840: 4c45 445f 494e 4954 4941 4c5f 4445 4c41  LED_INITIAL_DELA
+00027850: 5922 3b20 646f 2027 0a20 2020 2020 2020  Y"; do '.       
+00027860: 2020 2020 2027 6563 686f 2022 5761 6974       'echo "Wait
+00027870: 696e 6720 666f 7220 7265 706c 6963 6120  ing for replica 
+00027880: 746f 2062 6520 6661 696c 6564 2e2e 2e22  to be failed..."
+00027890: 3b20 736c 6565 7020 353b 2027 0a20 2020  ; sleep 5; '.   
+000278a0: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
+000278b0: 6b79 2073 6572 7665 2073 7461 7475 7320  ky serve status 
+000278c0: 7b6e 616d 657d 293b 2065 6368 6f20 2224  {name}); echo "$
+000278d0: 7322 3b20 646f 6e65 3b27 2c0a 2020 2020  s"; done;',.    
+000278e0: 2020 2020 2020 2020 2773 6c65 6570 2036          'sleep 6
+000278f0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00027900: 6627 7b5f 5345 5256 455f 5354 4154 5553  f'{_SERVE_STATUS
+00027910: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
+00027920: 653d 6e61 6d65 297d 3b20 6563 686f 2022  e=name)}; echo "
+00027930: 2473 2220 7c20 6772 6570 2022 7b6e 616d  $s" | grep "{nam
+00027940: 657d 2220 7c20 6772 6570 2022 4641 494c  e}" | grep "FAIL
+00027950: 4544 5f49 4e49 5449 414c 5f44 454c 4159  ED_INITIAL_DELAY
+00027960: 2220 7c20 7763 202d 6c20 7c20 6772 6570  " | wc -l | grep
+00027970: 2032 3b20 270a 2020 2020 2020 2020 2020   2; '.          
+00027980: 2020 2320 4d61 6b65 2073 7572 6520 6e6f    # Make sure no
+00027990: 206e 6577 2072 6570 6c69 6361 7320 6172   new replicas ar
+000279a0: 6520 7374 6172 7465 6420 666f 7220 6561  e started for ea
+000279b0: 726c 7920 6661 696c 7572 652e 0a20 2020  rly failure..   
+000279c0: 2020 2020 2020 2020 2066 2765 6368 6f20           f'echo 
+000279d0: 2224 7322 207c 2067 7265 7020 2d41 2031  "$s" | grep -A 1
+000279e0: 3030 2022 5365 7276 6963 6520 5265 706c  00 "Service Repl
+000279f0: 6963 6173 2220 7c20 6772 6570 2022 7b6e  icas" | grep "{n
+00027a00: 616d 657d 2220 7c20 7763 202d 6c20 7c20  ame}" | wc -l | 
+00027a10: 6772 6570 2032 3b27 2c0a 2020 2020 2020  grep 2;',.      
+00027a20: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
+00027a30: 6520 7570 6461 7465 207b 6e61 6d65 7d20  e update {name} 
+00027a40: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+00027a50: 5f63 6c6f 7564 7d20 2d79 2074 6573 7473  _cloud} -y tests
+00027a60: 2f73 6b79 7365 7276 652f 6661 696c 7572  /skyserve/failur
+00027a70: 6573 2f70 726f 6269 6e67 2e79 616d 6c27  es/probing.yaml'
+00027a80: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00027a90: 733d 2428 736b 7920 7365 7276 6520 7374  s=$(sky serve st
+00027aa0: 6174 7573 207b 6e61 6d65 7d29 3b20 270a  atus {name}); '.
+00027ab0: 2020 2020 2020 2020 2020 2020 2320 5761              # Wa
+00027ac0: 6974 2066 6f72 2072 6570 6c69 6361 2074  it for replica t
+00027ad0: 6f20 6265 2072 6561 6479 2e0a 2020 2020  o be ready..    
+00027ae0: 2020 2020 2020 2020 6627 756e 7469 6c20          f'until 
+00027af0: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+00027b00: 2022 5245 4144 5922 3b20 646f 2027 0a20   "READY"; do '. 
+00027b10: 2020 2020 2020 2020 2020 2027 6563 686f             'echo
+00027b20: 2022 5761 6974 696e 6720 666f 7220 7265   "Waiting for re
+00027b30: 706c 6963 6120 746f 2062 6520 6661 696c  plica to be fail
+00027b40: 6564 2e2e 2e22 3b20 736c 6565 7020 353b  ed..."; sleep 5;
+00027b50: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
+00027b60: 2773 3d24 2873 6b79 2073 6572 7665 2073  's=$(sky serve s
+00027b70: 7461 7475 7320 7b6e 616d 657d 293b 2065  tatus {name}); e
+00027b80: 6368 6f20 2224 7322 3b20 646f 6e65 3b27  cho "$s"; done;'
+00027b90: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00027ba0: 5761 6974 2066 6f72 2072 6570 6c69 6361  Wait for replica
+00027bb0: 2074 6f20 6368 616e 6765 2074 6f20 4641   to change to FA
+00027bc0: 494c 4544 5f50 524f 4249 4e47 0a20 2020  ILED_PROBING.   
+00027bd0: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
+00027be0: 6b79 2073 6572 7665 2073 7461 7475 7320  ky serve status 
+00027bf0: 7b6e 616d 657d 293b 2027 0a20 2020 2020  {name}); '.     
+00027c00: 2020 2020 2020 2066 2775 6e74 696c 2065         f'until e
+00027c10: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+00027c20: 2246 4149 4c45 445f 5052 4f42 494e 4722  "FAILED_PROBING"
+00027c30: 3b20 646f 2027 0a20 2020 2020 2020 2020  ; do '.         
+00027c40: 2020 2027 6563 686f 2022 5761 6974 696e     'echo "Waitin
+00027c50: 6720 666f 7220 7265 706c 6963 6120 746f  g for replica to
+00027c60: 2062 6520 6661 696c 6564 2e2e 2e22 3b20   be failed..."; 
+00027c70: 736c 6565 7020 353b 2027 0a20 2020 2020  sleep 5; '.     
+00027c80: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+00027c90: 2073 6572 7665 2073 7461 7475 7320 7b6e   serve status {n
+00027ca0: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
+00027cb0: 3b20 646f 6e65 3b27 202b 0a20 2020 2020  ; done;' +.     
+00027cc0: 2020 2020 2020 205f 6368 6563 6b5f 7265         _check_re
+00027cd0: 706c 6963 615f 696e 5f73 7461 7475 7328  plica_in_status(
+00027ce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027cf0: 206e 616d 652c 205b 2831 2c20 4661 6c73   name, [(1, Fals
+00027d00: 652c 2027 4641 494c 4544 5f50 524f 4249  e, 'FAILED_PROBI
+00027d10: 4e47 2729 2c0a 2020 2020 2020 2020 2020  NG'),.          
+00027d20: 2020 2020 2020 2020 2020 2020 2028 312c               (1,
+00027d30: 2046 616c 7365 2c20 5f53 4552 5649 4345   False, _SERVICE
+00027d40: 5f4c 4155 4e43 4849 4e47 5f53 5441 5455  _LAUNCHING_STATU
+00027d50: 535f 5245 4745 5829 5d29 2c0a 2020 2020  S_REGEX)]),.    
+00027d60: 2020 2020 2020 2020 2320 544f 444f 287a          # TODO(z
+00027d70: 6877 7529 3a20 6164 6420 7465 7374 2066  hwu): add test f
+00027d80: 6f72 2046 4149 4c45 445f 5052 4f56 4953  or FAILED_PROVIS
+00027d90: 494f 4e0a 2020 2020 2020 2020 5d2c 0a20  ION.        ],. 
+00027da0: 2020 2020 2020 205f 5445 4152 444f 574e         _TEARDOWN
+00027db0: 5f53 4552 5649 4345 2e66 6f72 6d61 7428  _SERVICE.format(
+00027dc0: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
+00027dd0: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
+00027de0: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+00027df0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00027e00: 290a 0a0a 2320 544f 444f 285a 696d 696e  )...# TODO(Zimin
+00027e10: 672c 2054 6961 6e29 3a20 4164 6420 7465  g, Tian): Add te
+00027e20: 7374 7320 666f 7220 6175 746f 7363 616c  sts for autoscal
+00027e30: 696e 672e 0a0a 0a23 202d 2d2d 2d2d 2d2d  ing....# -------
+00027e40: 2054 6573 7469 6e67 2075 7365 7220 7261   Testing user ra
+00027e50: 7920 636c 7573 7465 7220 2d2d 2d2d 2d2d  y cluster ------
+00027e60: 2d2d 0a64 6566 2074 6573 745f 7573 6572  --.def test_user
+00027e70: 5f72 6179 5f63 6c75 7374 6572 2867 656e  _ray_cluster(gen
+00027e80: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+00027e90: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+00027ea0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00027eb0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00027ec0: 280a 2020 2020 2020 2020 2775 7365 722d  (.        'user-
+00027ed0: 7261 792d 636c 7573 7465 7227 2c0a 2020  ray-cluster',.  
+00027ee0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00027ef0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00027f00: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+00027f10: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
+00027f20: 6c6f 7564 7d20 2272 6179 2073 7461 7274  loud} "ray start
+00027f30: 202d 2d68 6561 6422 272c 0a20 2020 2020   --head"',.     
+00027f40: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00027f50: 6320 7b6e 616d 657d 2022 6563 686f 2068  c {name} "echo h
+00027f60: 6922 272c 0a20 2020 2020 2020 2020 2020  i"',.           
+00027f70: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00027f80: 657d 2031 202d 2d73 7461 7475 7327 2c0a  e} 1 --status',.
+00027f90: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00027fa0: 7920 7374 6174 7573 202d 7220 7b6e 616d  y status -r {nam
+00027fb0: 657d 207c 2067 7265 7020 5550 272c 0a20  e} | grep UP',. 
+00027fc0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00027fd0: 2065 7865 6320 7b6e 616d 657d 2022 6563   exec {name} "ec
+00027fe0: 686f 2062 7965 2227 2c0a 2020 2020 2020  ho bye"',.      
+00027ff0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00028000: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
+00028010: 7573 272c 0a20 2020 2020 2020 205d 2c0a  us',.        ],.
+00028020: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+00028030: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+00028040: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00028050: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+00028060: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
+00028070: 7468 6520 636f 7265 2041 5049 202d 2d2d  the core API ---
+00028080: 2d2d 2d2d 2d0a 2320 4d6f 7374 206f 6620  -----.# Most of 
+00028090: 7468 6520 636f 7265 2041 5049 7320 6861  the core APIs ha
+000280a0: 7665 2062 6565 6e20 7465 7374 6564 2069  ve been tested i
+000280b0: 6e20 7468 6520 434c 4920 7465 7374 732e  n the CLI tests.
+000280c0: 0a23 2054 6865 7365 2074 6573 7473 2061  .# These tests a
+000280d0: 7265 2066 6f72 2074 6573 7469 6e67 2074  re for testing t
+000280e0: 6865 2072 6574 7572 6e20 7661 6c75 6520  he return value 
+000280f0: 6f66 2074 6865 2041 5049 7320 6e6f 7420  of the APIs not 
+00028100: 6675 6c6c 7920 7573 6564 2069 6e20 434c  fully used in CL
+00028110: 492e 0a0a 0a40 7079 7465 7374 2e6d 6172  I....@pytest.mar
+00028120: 6b2e 6763 700a 6465 6620 7465 7374 5f63  k.gcp.def test_c
+00028130: 6f72 655f 6170 695f 736b 795f 6c61 756e  ore_api_sky_laun
+00028140: 6368 5f65 7865 6328 293a 0a20 2020 206e  ch_exec():.    n
+00028150: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00028160: 6572 5f6e 616d 6528 290a 2020 2020 7461  er_name().    ta
+00028170: 736b 203d 2073 6b79 2e54 6173 6b28 7275  sk = sky.Task(ru
+00028180: 6e3d 2277 686f 616d 6922 290a 2020 2020  n="whoami").    
+00028190: 7461 736b 2e73 6574 5f72 6573 6f75 7263  task.set_resourc
+000281a0: 6573 2873 6b79 2e52 6573 6f75 7263 6573  es(sky.Resources
+000281b0: 2863 6c6f 7564 3d73 6b79 2e47 4350 2829  (cloud=sky.GCP()
+000281c0: 2929 0a20 2020 206a 6f62 5f69 642c 2068  )).    job_id, h
+000281d0: 616e 646c 6520 3d20 736b 792e 6c61 756e  andle = sky.laun
+000281e0: 6368 2874 6173 6b2c 2063 6c75 7374 6572  ch(task, cluster
+000281f0: 5f6e 616d 653d 6e61 6d65 290a 2020 2020  _name=name).    
+00028200: 6173 7365 7274 206a 6f62 5f69 6420 3d3d  assert job_id ==
+00028210: 2031 0a20 2020 2061 7373 6572 7420 6861   1.    assert ha
+00028220: 6e64 6c65 2069 7320 6e6f 7420 4e6f 6e65  ndle is not None
+00028230: 0a20 2020 2061 7373 6572 7420 6861 6e64  .    assert hand
+00028240: 6c65 2e63 6c75 7374 6572 5f6e 616d 6520  le.cluster_name 
+00028250: 3d3d 206e 616d 650a 2020 2020 6173 7365  == name.    asse
+00028260: 7274 2068 616e 646c 652e 6c61 756e 6368  rt handle.launch
+00028270: 6564 5f72 6573 6f75 7263 6573 2e63 6c6f  ed_resources.clo
+00028280: 7564 2e69 735f 7361 6d65 5f63 6c6f 7564  ud.is_same_cloud
+00028290: 2873 6b79 2e47 4350 2829 290a 2020 2020  (sky.GCP()).    
+000282a0: 6a6f 625f 6964 5f65 7865 632c 2068 616e  job_id_exec, han
+000282b0: 646c 655f 6578 6563 203d 2073 6b79 2e65  dle_exec = sky.e
+000282c0: 7865 6328 7461 736b 2c20 636c 7573 7465  xec(task, cluste
+000282d0: 725f 6e61 6d65 3d6e 616d 6529 0a20 2020  r_name=name).   
+000282e0: 2061 7373 6572 7420 6a6f 625f 6964 5f65   assert job_id_e
+000282f0: 7865 6320 3d3d 2032 0a20 2020 2061 7373  xec == 2.    ass
+00028300: 6572 7420 6861 6e64 6c65 5f65 7865 6320  ert handle_exec 
+00028310: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
+00028320: 6173 7365 7274 2068 616e 646c 655f 6578  assert handle_ex
+00028330: 6563 2e63 6c75 7374 6572 5f6e 616d 6520  ec.cluster_name 
+00028340: 3d3d 206e 616d 650a 2020 2020 6173 7365  == name.    asse
+00028350: 7274 2068 616e 646c 655f 6578 6563 2e6c  rt handle_exec.l
+00028360: 6175 6e63 6865 645f 7265 736f 7572 6365  aunched_resource
+00028370: 732e 636c 6f75 642e 6973 5f73 616d 655f  s.cloud.is_same_
+00028380: 636c 6f75 6428 736b 792e 4743 5028 2929  cloud(sky.GCP())
+00028390: 0a20 2020 2023 2046 6f72 2064 756d 6d79  .    # For dummy
+000283a0: 2074 6173 6b20 2869 2e65 2e20 7461 736b   task (i.e. task
+000283b0: 2e72 756e 2069 7320 4e6f 6e65 292c 2074  .run is None), t
+000283c0: 6865 206a 6f62 2077 6f6e 2774 2062 6520  he job won't be 
+000283d0: 7375 626d 6974 7465 642e 0a20 2020 2064  submitted..    d
+000283e0: 756d 6d79 5f74 6173 6b20 3d20 736b 792e  ummy_task = sky.
+000283f0: 5461 736b 2829 0a20 2020 206a 6f62 5f69  Task().    job_i
+00028400: 645f 6475 6d6d 792c 205f 203d 2073 6b79  d_dummy, _ = sky
+00028410: 2e65 7865 6328 6475 6d6d 795f 7461 736b  .exec(dummy_task
+00028420: 2c20 636c 7573 7465 725f 6e61 6d65 3d6e  , cluster_name=n
+00028430: 616d 6529 0a20 2020 2061 7373 6572 7420  ame).    assert 
+00028440: 6a6f 625f 6964 5f64 756d 6d79 2069 7320  job_id_dummy is 
+00028450: 4e6f 6e65 0a20 2020 2073 6b79 2e64 6f77  None.    sky.dow
+00028460: 6e28 6e61 6d65 290a 0a0a 2320 2d2d 2d2d  n(name)...# ----
+00028470: 2d2d 2d2d 2d2d 2054 6573 7469 6e67 2053  ------ Testing S
+00028480: 746f 7261 6765 202d 2d2d 2d2d 2d2d 2d2d  torage ---------
+00028490: 2d0a 636c 6173 7320 5465 7374 5374 6f72  -.class TestStor
+000284a0: 6167 6557 6974 6843 7265 6465 6e74 6961  ageWithCredentia
+000284b0: 6c73 3a0a 2020 2020 2222 2253 746f 7261  ls:.    """Stora
+000284c0: 6765 2074 6573 7473 2077 6869 6368 2072  ge tests which r
+000284d0: 6571 7569 7265 2063 7265 6465 6e74 6961  equire credentia
+000284e0: 6c73 2061 6e64 206e 6574 776f 726b 2063  ls and network c
+000284f0: 6f6e 6e65 6374 696f 6e22 2222 0a0a 2020  onnection"""..  
+00028500: 2020 4157 535f 494e 5641 4c49 445f 4e41    AWS_INVALID_NA
+00028510: 4d45 5320 3d20 5b0a 2020 2020 2020 2020  MES = [.        
+00028520: 2761 6227 2c20 2023 206c 6573 7320 7468  'ab',  # less th
+00028530: 616e 2033 2063 6861 7261 6374 6572 730a  an 3 characters.
+00028540: 2020 2020 2020 2020 2761 6263 6465 6667          'abcdefg
+00028550: 6869 6a6b 6c6d 6e6f 7071 7273 7475 7677  hijklmnopqrstuvw
+00028560: 7879 7a61 6263 6465 6667 6869 6a6b 6c6d  xyzabcdefghijklm
+00028570: 6e6f 7071 7273 7475 7677 7879 7a61 6263  nopqrstuvwxyzabc
+00028580: 6465 6667 6869 6a6b 6c6d 6e6f 7071 7273  defghijklmnopqrs
+00028590: 7475 7677 7879 7a31 272c 0a20 2020 2020  tuvwxyz1',.     
+000285a0: 2020 2023 206d 6f72 6520 7468 616e 2036     # more than 6
+000285b0: 3320 6368 6172 6163 7465 7273 0a20 2020  3 characters.   
+000285c0: 2020 2020 2027 4162 6364 6566 272c 2020       'Abcdef',  
+000285d0: 2320 636f 6e74 6169 6e73 2061 6e20 7570  # contains an up
+000285e0: 7065 7263 6173 6520 6c65 7474 6572 0a20  percase letter. 
+000285f0: 2020 2020 2020 2027 6162 6320 6465 6627         'abc def'
+00028600: 2c20 2023 2063 6f6e 7461 696e 7320 6120  ,  # contains a 
+00028610: 7370 6163 650a 2020 2020 2020 2020 2761  space.        'a
+00028620: 6263 2e2e 6465 6627 2c20 2023 2074 776f  bc..def',  # two
+00028630: 2061 646a 6163 656e 7420 7065 7269 6f64   adjacent period
+00028640: 730a 2020 2020 2020 2020 2731 3932 2e31  s.        '192.1
+00028650: 3638 2e35 2e34 272c 2020 2320 666f 726d  68.5.4',  # form
+00028660: 6174 7465 6420 6173 2061 6e20 4950 2061  atted as an IP a
+00028670: 6464 7265 7373 0a20 2020 2020 2020 2027  ddress.        '
+00028680: 786e 2d2d 6275 636b 6574 272c 2020 2320  xn--bucket',  # 
+00028690: 7374 6172 7473 2077 6974 6820 2778 6e2d  starts with 'xn-
+000286a0: 2d27 2070 7265 6669 780a 2020 2020 2020  -' prefix.      
+000286b0: 2020 2762 7563 6b65 742d 7333 616c 6961    'bucket-s3alia
+000286c0: 7327 2c20 2023 2065 6e64 7320 7769 7468  s',  # ends with
+000286d0: 2027 2d73 3361 6c69 6173 2720 7375 6666   '-s3alias' suff
+000286e0: 6978 0a20 2020 2020 2020 2027 6275 636b  ix.        'buck
+000286f0: 6574 2d2d 6f6c 2d73 3327 2c20 2023 2065  et--ol-s3',  # e
+00028700: 6e64 7320 7769 7468 2027 2d2d 6f6c 2d73  nds with '--ol-s
+00028710: 3327 2073 7566 6669 780a 2020 2020 2020  3' suffix.      
+00028720: 2020 272e 6162 6327 2c20 2023 2073 7461    '.abc',  # sta
+00028730: 7274 7320 7769 7468 2061 2064 6f74 0a20  rts with a dot. 
+00028740: 2020 2020 2020 2027 6162 632e 272c 2020         'abc.',  
+00028750: 2320 656e 6473 2077 6974 6820 6120 646f  # ends with a do
+00028760: 740a 2020 2020 2020 2020 272d 6162 6327  t.        '-abc'
+00028770: 2c20 2023 2073 7461 7274 7320 7769 7468  ,  # starts with
+00028780: 2061 2068 7970 6865 6e0a 2020 2020 2020   a hyphen.      
+00028790: 2020 2761 6263 2d27 2c20 2023 2065 6e64    'abc-',  # end
+000287a0: 7320 7769 7468 2061 2068 7970 6865 6e0a  s with a hyphen.
+000287b0: 2020 2020 5d0a 0a20 2020 2047 4353 5f49      ]..    GCS_I
+000287c0: 4e56 414c 4944 5f4e 414d 4553 203d 205b  NVALID_NAMES = [
+000287d0: 0a20 2020 2020 2020 2027 6162 272c 2020  .        'ab',  
+000287e0: 2320 6c65 7373 2074 6861 6e20 3320 6368  # less than 3 ch
+000287f0: 6172 6163 7465 7273 0a20 2020 2020 2020  aracters.       
+00028800: 2027 6162 6364 6566 6768 696a 6b6c 6d6e   'abcdefghijklmn
+00028810: 6f70 7172 7374 7576 7778 797a 6162 6364  opqrstuvwxyzabcd
+00028820: 6566 6768 696a 6b6c 6d6e 6f70 7172 7374  efghijklmnopqrst
+00028830: 7576 7778 797a 6162 6364 6566 6768 696a  uvwxyzabcdefghij
+00028840: 6b6c 6d6e 6f70 7172 7374 7576 7778 797a  klmnopqrstuvwxyz
+00028850: 3127 2c0a 2020 2020 2020 2020 2320 6d6f  1',.        # mo
+00028860: 7265 2074 6861 6e20 3633 2063 6861 7261  re than 63 chara
+00028870: 6374 6572 7320 2877 6974 686f 7574 2064  cters (without d
+00028880: 6f74 7329 0a20 2020 2020 2020 2027 4162  ots).        'Ab
+00028890: 6364 6566 272c 2020 2320 636f 6e74 6169  cdef',  # contai
+000288a0: 6e73 2061 6e20 7570 7065 7263 6173 6520  ns an uppercase 
+000288b0: 6c65 7474 6572 0a20 2020 2020 2020 2027  letter.        '
+000288c0: 6162 6320 6465 6627 2c20 2023 2063 6f6e  abc def',  # con
+000288d0: 7461 696e 7320 6120 7370 6163 650a 2020  tains a space.  
+000288e0: 2020 2020 2020 2761 6263 2e2e 6465 6627        'abc..def'
+000288f0: 2c20 2023 2074 776f 2061 646a 6163 656e  ,  # two adjacen
+00028900: 7420 7065 7269 6f64 730a 2020 2020 2020  t periods.      
+00028910: 2020 2761 6263 5f2e 6465 662e 6768 692e    'abc_.def.ghi.
+00028920: 6a6b 6c6d 6e6f 7071 7273 7475 7677 7879  jklmnopqrstuvwxy
+00028930: 7a61 6263 6465 6667 6869 6a6b 6c6d 6e6f  zabcdefghijklmno
+00028940: 7071 7273 7475 7677 7879 7a61 6263 6465  pqrstuvwxyzabcde
+00028950: 6667 6869 6a6b 6c6d 6e6f 7071 7273 7475  fghijklmnopqrstu
+00028960: 7677 7879 7a31 270a 2020 2020 2020 2020  vwxyz1'.        
+00028970: 2320 4d6f 7265 2074 6861 6e20 3633 2063  # More than 63 c
+00028980: 6861 7261 6374 6572 7320 6265 7477 6565  haracters betwee
+00028990: 6e20 646f 7473 0a20 2020 2020 2020 2027  n dots.        '
+000289a0: 6162 635f 2e64 6566 2e67 6869 2e6a 6b6c  abc_.def.ghi.jkl
+000289b0: 6d6e 6f70 7172 7374 7576 7778 797a 6162  mnopqrstuvwxyzab
+000289c0: 6364 6566 6768 696a 6b6c 6d6e 6f70 7166  cdefghijklmnopqf
+000289d0: 6768 696a 6b6c 6d6e 6f70 7172 7374 7576  ghijklmnopqrstuv
+000289e0: 7727 202a 2035 2c0a 2020 2020 2020 2020  w' * 5,.        
+000289f0: 2320 6d6f 7265 2074 6861 6e20 3232 3220  # more than 222 
+00028a00: 6368 6172 6163 7465 7273 2028 7769 7468  characters (with
+00028a10: 2064 6f74 7329 0a20 2020 2020 2020 2027   dots).        '
+00028a20: 3139 322e 3136 382e 352e 3427 2c20 2023  192.168.5.4',  #
+00028a30: 2066 6f72 6d61 7474 6564 2061 7320 616e   formatted as an
+00028a40: 2049 5020 6164 6472 6573 730a 2020 2020   IP address.    
+00028a50: 2020 2020 2767 6f6f 6762 7563 6b65 7427      'googbucket'
+00028a60: 2c20 2023 2073 7461 7274 7320 7769 7468  ,  # starts with
+00028a70: 2027 676f 6f67 2720 7072 6566 6978 0a20   'goog' prefix. 
+00028a80: 2020 2020 2020 2027 676f 6f67 6c65 6275         'googlebu
+00028a90: 636b 6574 272c 2020 2320 636f 6e74 6169  cket',  # contai
+00028aa0: 6e73 2027 676f 6f67 6c65 270a 2020 2020  ns 'google'.    
+00028ab0: 2020 2020 2767 3030 676c 6562 7563 6b65      'g00glebucke
+00028ac0: 7427 2c20 2023 2076 6172 6961 6e74 206f  t',  # variant o
+00028ad0: 6620 2767 6f6f 676c 6527 0a20 2020 2020  f 'google'.     
+00028ae0: 2020 2027 676f 3067 6c65 6275 636b 6574     'go0glebucket
+00028af0: 272c 2020 2320 7661 7269 616e 7420 6f66  ',  # variant of
+00028b00: 2027 676f 6f67 6c65 270a 2020 2020 2020   'google'.      
+00028b10: 2020 2767 306f 676c 6562 7563 6b65 7427    'g0oglebucket'
+00028b20: 2c20 2023 2076 6172 6961 6e74 206f 6620  ,  # variant of 
+00028b30: 2767 6f6f 676c 6527 0a20 2020 2020 2020  'google'.       
+00028b40: 2027 2e61 6263 272c 2020 2320 7374 6172   '.abc',  # star
+00028b50: 7473 2077 6974 6820 6120 646f 740a 2020  ts with a dot.  
+00028b60: 2020 2020 2020 2761 6263 2e27 2c20 2023        'abc.',  #
+00028b70: 2065 6e64 7320 7769 7468 2061 2064 6f74   ends with a dot
+00028b80: 0a20 2020 2020 2020 2027 5f61 6263 272c  .        '_abc',
+00028b90: 2020 2320 7374 6172 7473 2077 6974 6820    # starts with 
+00028ba0: 616e 2075 6e64 6572 7363 6f72 650a 2020  an underscore.  
+00028bb0: 2020 2020 2020 2761 6263 5f27 2c20 2023        'abc_',  #
+00028bc0: 2065 6e64 7320 7769 7468 2061 6e20 756e   ends with an un
+00028bd0: 6465 7273 636f 7265 0a20 2020 205d 0a0a  derscore.    ]..
+00028be0: 2020 2020 4942 4d5f 494e 5641 4c49 445f      IBM_INVALID_
+00028bf0: 4e41 4d45 5320 3d20 5b0a 2020 2020 2020  NAMES = [.      
+00028c00: 2020 2761 6227 2c20 2023 206c 6573 7320    'ab',  # less 
+00028c10: 7468 616e 2033 2063 6861 7261 6374 6572  than 3 character
+00028c20: 730a 2020 2020 2020 2020 2761 6263 6465  s.        'abcde
+00028c30: 6667 6869 6a6b 6c6d 6e6f 7071 7273 7475  fghijklmnopqrstu
+00028c40: 7677 7879 7a61 6263 6465 6667 6869 6a6b  vwxyzabcdefghijk
+00028c50: 6c6d 6e6f 7071 7273 7475 7677 7879 7a61  lmnopqrstuvwxyza
+00028c60: 6263 6465 6667 6869 6a6b 6c6d 6e6f 7071  bcdefghijklmnopq
+00028c70: 7273 7475 7677 7879 7a31 272c 0a20 2020  rstuvwxyz1',.   
+00028c80: 2020 2020 2023 206d 6f72 6520 7468 616e       # more than
+00028c90: 2036 3320 6368 6172 6163 7465 7273 0a20   63 characters. 
+00028ca0: 2020 2020 2020 2027 4162 6364 6566 272c         'Abcdef',
+00028cb0: 2020 2320 636f 6e74 6169 6e73 2061 6e20    # contains an 
+00028cc0: 7570 7065 7263 6173 6520 6c65 7474 6572  uppercase letter
+00028cd0: 0a20 2020 2020 2020 2027 6162 6320 6465  .        'abc de
+00028ce0: 6627 2c20 2023 2063 6f6e 7461 696e 7320  f',  # contains 
+00028cf0: 6120 7370 6163 650a 2020 2020 2020 2020  a space.        
+00028d00: 2761 6263 2e2e 6465 6627 2c20 2023 2074  'abc..def',  # t
+00028d10: 776f 2061 646a 6163 656e 7420 7065 7269  wo adjacent peri
+00028d20: 6f64 730a 2020 2020 2020 2020 2731 3932  ods.        '192
+00028d30: 2e31 3638 2e35 2e34 272c 2020 2320 666f  .168.5.4',  # fo
+00028d40: 726d 6174 7465 6420 6173 2061 6e20 4950  rmatted as an IP
+00028d50: 2061 6464 7265 7373 0a20 2020 2020 2020   address.       
+00028d60: 2027 786e 2d2d 6275 636b 6574 272c 2020   'xn--bucket',  
+00028d70: 2320 7374 6172 7473 2077 6974 6820 2778  # starts with 'x
+00028d80: 6e2d 2d27 2070 7265 6669 780a 2020 2020  n--' prefix.    
+00028d90: 2020 2020 272e 6162 6327 2c20 2023 2073      '.abc',  # s
+00028da0: 7461 7274 7320 7769 7468 2061 2064 6f74  tarts with a dot
+00028db0: 0a20 2020 2020 2020 2027 6162 632e 272c  .        'abc.',
+00028dc0: 2020 2320 656e 6473 2077 6974 6820 6120    # ends with a 
+00028dd0: 646f 740a 2020 2020 2020 2020 272d 6162  dot.        '-ab
+00028de0: 6327 2c20 2023 2073 7461 7274 7320 7769  c',  # starts wi
+00028df0: 7468 2061 2068 7970 6865 6e0a 2020 2020  th a hyphen.    
+00028e00: 2020 2020 2761 6263 2d27 2c20 2023 2065      'abc-',  # e
+00028e10: 6e64 7320 7769 7468 2061 2068 7970 6865  nds with a hyphe
+00028e20: 6e0a 2020 2020 2020 2020 2761 2e2d 6263  n.        'a.-bc
+00028e30: 272c 2020 2320 636f 6e74 6169 6e73 2074  ',  # contains t
+00028e40: 6865 2073 6571 7565 6e63 6520 272e 2d27  he sequence '.-'
+00028e50: 0a20 2020 2020 2020 2027 612d 2e62 6327  .        'a-.bc'
+00028e60: 2c20 2023 2063 6f6e 7461 696e 7320 7468  ,  # contains th
+00028e70: 6520 7365 7175 656e 6365 2027 2d2e 270a  e sequence '-.'.
+00028e80: 2020 2020 2020 2020 2761 2662 6327 2020          'a&bc'  
+00028e90: 2320 636f 6e74 6169 6e73 2073 7065 6369  # contains speci
+00028ea0: 616c 2063 6861 7261 6374 6572 730a 2020  al characters.  
+00028eb0: 2020 2020 2020 2761 625e 6327 2020 2320        'ab^c'  # 
+00028ec0: 636f 6e74 6169 6e73 2073 7065 6369 616c  contains special
+00028ed0: 2063 6861 7261 6374 6572 730a 2020 2020   characters.    
+00028ee0: 5d0a 2020 2020 4749 5449 474e 4f52 455f  ].    GITIGNORE_
+00028ef0: 5359 4e43 5f54 4553 545f 4449 525f 5354  SYNC_TEST_DIR_ST
+00028f00: 5255 4354 5552 4520 3d20 7b0a 2020 2020  RUCTURE = {.    
+00028f10: 2020 2020 2764 6f75 626c 655f 6173 7465      'double_aste
+00028f20: 7269 736b 273a 207b 0a20 2020 2020 2020  risk': {.       
+00028f30: 2020 2020 2027 646f 7562 6c65 5f61 7374       'double_ast
+00028f40: 6572 6973 6b5f 6578 636c 7564 6564 273a  erisk_excluded':
+00028f50: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+00028f60: 2020 2027 646f 7562 6c65 5f61 7374 6572     'double_aster
+00028f70: 6973 6b5f 6578 636c 7564 6564 5f64 6972  isk_excluded_dir
+00028f80: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+00028f90: 2020 2020 2027 6469 725f 6578 636c 7564       'dir_exclud
+00028fa0: 6564 273a 204e 6f6e 652c 0a20 2020 2020  ed': None,.     
+00028fb0: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+00028fc0: 2020 7d2c 0a20 2020 2020 2020 2027 646f    },.        'do
+00028fd0: 7562 6c65 5f61 7374 6572 6973 6b5f 7061  uble_asterisk_pa
+00028fe0: 7265 6e74 273a 207b 0a20 2020 2020 2020  rent': {.       
+00028ff0: 2020 2020 2027 7061 7265 6e74 273a 207b       'parent': {
+00029000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029010: 2027 616c 736f 5f65 7863 6c75 6465 642e   'also_excluded.
+00029020: 7478 7427 3a20 4e6f 6e65 2c0a 2020 2020  txt': None,.    
+00029030: 2020 2020 2020 2020 2020 2020 2763 6869              'chi
+00029040: 6c64 273a 207b 0a20 2020 2020 2020 2020  ld': {.         
+00029050: 2020 2020 2020 2020 2020 2027 646f 7562             'doub
+00029060: 6c65 5f61 7374 6572 6973 6b5f 7061 7265  le_asterisk_pare
+00029070: 6e74 5f63 6869 6c64 5f65 7863 6c75 6465  nt_child_exclude
+00029080: 642e 7478 7427 3a20 4e6f 6e65 2c0a 2020  d.txt': None,.  
+00029090: 2020 2020 2020 2020 2020 2020 2020 7d2c                },
+000290a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000290b0: 2027 646f 7562 6c65 5f61 7374 6572 6973   'double_asteris
+000290c0: 6b5f 7061 7265 6e74 5f65 7863 6c75 6465  k_parent_exclude
+000290d0: 642e 7478 7427 3a20 4e6f 6e65 2c0a 2020  d.txt': None,.  
+000290e0: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+000290f0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+00029100: 2765 7863 6c75 6465 642e 6c6f 6727 3a20  'excluded.log': 
+00029110: 4e6f 6e65 2c0a 2020 2020 2020 2020 2765  None,.        'e
+00029120: 7863 6c75 6465 645f 6469 7227 3a20 7b0a  xcluded_dir': {.
+00029130: 2020 2020 2020 2020 2020 2020 2765 7863              'exc
+00029140: 6c75 6465 642e 7478 7427 3a20 4e6f 6e65  luded.txt': None
+00029150: 2c0a 2020 2020 2020 2020 2020 2020 276e  ,.            'n
+00029160: 6573 7465 645f 6578 636c 7564 6564 273a  ested_excluded':
+00029170: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00029180: 2020 2027 6578 636c 7564 6564 273a 204e     'excluded': N
+00029190: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+000291a0: 207d 2c0a 2020 2020 2020 2020 7d2c 0a20   },.        },. 
+000291b0: 2020 2020 2020 2027 6578 702d 3127 3a20         'exp-1': 
+000291c0: 7b0a 2020 2020 2020 2020 2020 2020 2762  {.            'b
+000291d0: 655f 6578 636c 7564 6564 273a 204e 6f6e  e_excluded': Non
+000291e0: 652c 0a20 2020 2020 2020 207d 2c0a 2020  e,.        },.  
+000291f0: 2020 2020 2020 2765 7870 2d32 273a 207b        'exp-2': {
+00029200: 0a20 2020 2020 2020 2020 2020 2027 6265  .            'be
+00029210: 5f65 7863 6c75 6465 6427 3a20 4e6f 6e65  _excluded': None
+00029220: 2c0a 2020 2020 2020 2020 7d2c 0a20 2020  ,.        },.   
+00029230: 2020 2020 2027 6672 6f6e 745f 736c 6173       'front_slas
+00029240: 685f 6578 636c 7564 6564 273a 204e 6f6e  h_excluded': Non
+00029250: 652c 0a20 2020 2020 2020 2027 696e 636c  e,.        'incl
+00029260: 7564 6564 2e6c 6f67 273a 204e 6f6e 652c  uded.log': None,
+00029270: 0a20 2020 2020 2020 2027 696e 636c 7564  .        'includ
+00029280: 6564 2e74 7874 273a 204e 6f6e 652c 0a20  ed.txt': None,. 
+00029290: 2020 2020 2020 2027 696e 636c 7564 655f         'include_
+000292a0: 6469 7227 3a20 7b0a 2020 2020 2020 2020  dir': {.        
+000292b0: 2020 2020 2765 7863 6c75 6465 642e 6c6f      'excluded.lo
+000292c0: 6727 3a20 4e6f 6e65 2c0a 2020 2020 2020  g': None,.      
+000292d0: 2020 2020 2020 2769 6e63 6c75 6465 642e        'included.
+000292e0: 6c6f 6727 3a20 4e6f 6e65 2c0a 2020 2020  log': None,.    
+000292f0: 2020 2020 7d2c 0a20 2020 2020 2020 2027      },.        '
+00029300: 6e65 7374 6564 5f64 6f75 626c 655f 6173  nested_double_as
+00029310: 7465 7269 736b 273a 207b 0a20 2020 2020  terisk': {.     
+00029320: 2020 2020 2020 2027 6f6e 6527 3a20 7b0a         'one': {.
+00029330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029340: 2761 6c73 6f5f 6578 636c 7564 652e 7478  'also_exclude.tx
+00029350: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
+00029360: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+00029370: 2020 2020 2027 7477 6f27 3a20 7b0a 2020       'two': {.  
+00029380: 2020 2020 2020 2020 2020 2020 2020 2761                'a
+00029390: 6c73 6f5f 6578 636c 7564 652e 7478 7427  lso_exclude.txt'
+000293a0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+000293b0: 2020 2020 7d2c 0a20 2020 2020 2020 207d      },.        }
+000293c0: 2c0a 2020 2020 2020 2020 276e 6573 7465  ,.        'neste
+000293d0: 645f 7769 6c64 6361 7264 5f64 6972 273a  d_wildcard_dir':
+000293e0: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
+000293f0: 6d6f 6e64 6179 273a 207b 0a20 2020 2020  monday': {.     
+00029400: 2020 2020 2020 2020 2020 2027 616c 736f             'also
+00029410: 5f65 7863 6c75 6465 2e74 7874 273a 204e  _exclude.txt': N
+00029420: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00029430: 207d 2c0a 2020 2020 2020 2020 2020 2020   },.            
+00029440: 2774 7565 7364 6179 273a 207b 0a20 2020  'tuesday': {.   
+00029450: 2020 2020 2020 2020 2020 2020 2027 616c               'al
+00029460: 736f 5f65 7863 6c75 6465 2e74 7874 273a  so_exclude.txt':
+00029470: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+00029480: 2020 207d 2c0a 2020 2020 2020 2020 7d2c     },.        },
+00029490: 0a20 2020 2020 2020 2027 6e6f 5f73 6c61  .        'no_sla
+000294a0: 7368 5f65 7863 6c75 6465 6427 3a20 4e6f  sh_excluded': No
+000294b0: 6e65 2c0a 2020 2020 2020 2020 276e 6f5f  ne,.        'no_
+000294c0: 736c 6173 685f 7465 7374 7327 3a20 7b0a  slash_tests': {.
+000294d0: 2020 2020 2020 2020 2020 2020 276e 6f5f              'no_
+000294e0: 736c 6173 685f 6578 636c 7564 6564 273a  slash_excluded':
+000294f0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00029500: 2020 2027 616c 736f 5f65 7863 6c75 6465     'also_exclude
+00029510: 642e 7478 7427 3a20 4e6f 6e65 2c0a 2020  d.txt': None,.  
+00029520: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+00029530: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+00029540: 2771 7565 7374 696f 6e5f 6d61 726b 273a  'question_mark':
+00029550: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
+00029560: 6578 636c 7564 6564 312e 7478 7427 3a20  excluded1.txt': 
+00029570: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00029580: 2020 2765 7863 6c75 6465 6440 2e74 7874    'excluded@.txt
+00029590: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
+000295a0: 207d 2c0a 2020 2020 2020 2020 2773 7175   },.        'squ
+000295b0: 6172 655f 6272 6163 6b65 7427 3a20 7b0a  are_bracket': {.
+000295c0: 2020 2020 2020 2020 2020 2020 2765 7863              'exc
+000295d0: 6c75 6465 6431 2e74 7874 273a 204e 6f6e  luded1.txt': Non
+000295e0: 652c 0a20 2020 2020 2020 207d 2c0a 2020  e,.        },.  
+000295f0: 2020 2020 2020 2773 7175 6172 655f 6272        'square_br
+00029600: 6163 6b65 745f 616c 7068 6127 3a20 7b0a  acket_alpha': {.
+00029610: 2020 2020 2020 2020 2020 2020 2765 7863              'exc
+00029620: 6c75 6465 647a 2e74 7874 273a 204e 6f6e  ludedz.txt': Non
+00029630: 652c 0a20 2020 2020 2020 207d 2c0a 2020  e,.        },.  
+00029640: 2020 2020 2020 2773 7175 6172 655f 6272        'square_br
+00029650: 6163 6b65 745f 6578 636c 6127 3a20 7b0a  acket_excla': {.
+00029660: 2020 2020 2020 2020 2020 2020 2765 7863              'exc
+00029670: 6c75 6465 6432 2e74 7874 273a 204e 6f6e  luded2.txt': Non
+00029680: 652c 0a20 2020 2020 2020 2020 2020 2027  e,.            '
+00029690: 6578 636c 7564 6564 402e 7478 7427 3a20  excluded@.txt': 
+000296a0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7d2c  None,.        },
+000296b0: 0a20 2020 2020 2020 2027 7371 7561 7265  .        'square
+000296c0: 5f62 7261 636b 6574 5f73 696e 676c 6527  _bracket_single'
+000296d0: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+000296e0: 2765 7863 6c75 6465 6430 2e74 7874 273a  'excluded0.txt':
+000296f0: 204e 6f6e 652c 0a20 2020 2020 2020 207d   None,.        }
+00029700: 2c0a 2020 2020 7d0a 0a20 2020 2040 7374  ,.    }..    @st
+00029710: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
+00029720: 6566 2063 7265 6174 655f 6469 725f 7374  ef create_dir_st
+00029730: 7275 6374 7572 6528 6261 7365 5f70 6174  ructure(base_pat
+00029740: 682c 2073 7472 7563 7475 7265 293a 0a20  h, structure):. 
+00029750: 2020 2020 2020 2023 2063 7265 6174 6573         # creates
+00029760: 2061 2067 6976 656e 2066 696c 6520 5354   a given file ST
+00029770: 5255 4354 5552 4520 696e 2042 4153 455f  RUCTURE in BASE_
+00029780: 5041 5448 0a20 2020 2020 2020 2066 6f72  PATH.        for
+00029790: 206e 616d 652c 2073 7562 7374 7275 6374   name, substruct
+000297a0: 7572 6520 696e 2073 7472 7563 7475 7265  ure in structure
+000297b0: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+000297c0: 2020 2020 2020 7061 7468 203d 206f 732e        path = os.
+000297d0: 7061 7468 2e6a 6f69 6e28 6261 7365 5f70  path.join(base_p
+000297e0: 6174 682c 206e 616d 6529 0a20 2020 2020  ath, name).     
+000297f0: 2020 2020 2020 2069 6620 7375 6273 7472         if substr
+00029800: 7563 7475 7265 2069 7320 4e6f 6e65 3a0a  ucture is None:.
+00029810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029820: 2320 4372 6561 7465 2061 2066 696c 650a  # Create a file.
+00029830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029840: 6f70 656e 2870 6174 682c 2027 6127 2c20  open(path, 'a', 
+00029850: 656e 636f 6469 6e67 3d27 7574 662d 3827  encoding='utf-8'
+00029860: 292e 636c 6f73 6528 290a 2020 2020 2020  ).close().      
+00029870: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00029880: 2020 2020 2020 2020 2020 2020 2320 4372              # Cr
+00029890: 6561 7465 2061 2073 7562 6469 7265 6374  eate a subdirect
+000298a0: 6f72 790a 2020 2020 2020 2020 2020 2020  ory.            
+000298b0: 2020 2020 6f73 2e6d 6b64 6972 2870 6174      os.mkdir(pat
+000298c0: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
+000298d0: 2020 2054 6573 7453 746f 7261 6765 5769     TestStorageWi
+000298e0: 7468 4372 6564 656e 7469 616c 732e 6372  thCredentials.cr
+000298f0: 6561 7465 5f64 6972 5f73 7472 7563 7475  eate_dir_structu
+00029900: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
+00029910: 2020 2020 2020 2020 7061 7468 2c20 7375          path, su
+00029920: 6273 7472 7563 7475 7265 290a 0a20 2020  bstructure)..   
+00029930: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
+00029940: 2020 2064 6566 2063 6c69 5f64 656c 6574     def cli_delet
+00029950: 655f 636d 6428 7374 6f72 655f 7479 7065  e_cmd(store_type
+00029960: 2c20 6275 636b 6574 5f6e 616d 6529 3a0a  , bucket_name):.
+00029970: 2020 2020 2020 2020 6966 2073 746f 7265          if store
+00029980: 5f74 7970 6520 3d3d 2073 746f 7261 6765  _type == storage
+00029990: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
+000299a0: 333a 0a20 2020 2020 2020 2020 2020 2075  3:.            u
+000299b0: 726c 203d 2066 2773 333a 2f2f 7b62 7563  rl = f's3://{buc
+000299c0: 6b65 745f 6e61 6d65 7d27 0a20 2020 2020  ket_name}'.     
+000299d0: 2020 2020 2020 2072 6574 7572 6e20 6627         return f'
+000299e0: 6177 7320 7333 2072 6220 7b75 726c 7d20  aws s3 rb {url} 
+000299f0: 2d2d 666f 7263 6527 0a20 2020 2020 2020  --force'.       
+00029a00: 2069 6620 7374 6f72 655f 7479 7065 203d   if store_type =
+00029a10: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
+00029a20: 6f72 6554 7970 652e 4743 533a 0a20 2020  oreType.GCS:.   
+00029a30: 2020 2020 2020 2020 2075 726c 203d 2066           url = f
+00029a40: 2767 733a 2f2f 7b62 7563 6b65 745f 6e61  'gs://{bucket_na
+00029a50: 6d65 7d27 0a20 2020 2020 2020 2020 2020  me}'.           
+00029a60: 2067 7375 7469 6c5f 616c 6961 732c 2061   gsutil_alias, a
+00029a70: 6c69 6173 5f67 656e 203d 2064 6174 615f  lias_gen = data_
+00029a80: 7574 696c 732e 6765 745f 6773 7574 696c  utils.get_gsutil
+00029a90: 5f63 6f6d 6d61 6e64 2829 0a20 2020 2020  _command().     
+00029aa0: 2020 2020 2020 2072 6574 7572 6e20 6627         return f'
+00029ab0: 7b61 6c69 6173 5f67 656e 7d3b 207b 6773  {alias_gen}; {gs
+00029ac0: 7574 696c 5f61 6c69 6173 7d20 726d 202d  util_alias} rm -
+00029ad0: 7220 7b75 726c 7d27 0a20 2020 2020 2020  r {url}'.       
+00029ae0: 2069 6620 7374 6f72 655f 7479 7065 203d   if store_type =
+00029af0: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
+00029b00: 6f72 6554 7970 652e 5232 3a0a 2020 2020  oreType.R2:.    
+00029b10: 2020 2020 2020 2020 656e 6470 6f69 6e74          endpoint
+00029b20: 5f75 726c 203d 2063 6c6f 7564 666c 6172  _url = cloudflar
+00029b30: 652e 6372 6561 7465 5f65 6e64 706f 696e  e.create_endpoin
+00029b40: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+00029b50: 7572 6c20 3d20 6627 7333 3a2f 2f7b 6275  url = f's3://{bu
+00029b60: 636b 6574 5f6e 616d 657d 270a 2020 2020  cket_name}'.    
+00029b70: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+00029b80: 2741 5753 5f53 4841 5245 445f 4352 4544  'AWS_SHARED_CRED
+00029b90: 454e 5449 414c 535f 4649 4c45 3d7b 636c  ENTIALS_FILE={cl
+00029ba0: 6f75 6466 6c61 7265 2e52 325f 4352 4544  oudflare.R2_CRED
+00029bb0: 454e 5449 414c 535f 5041 5448 7d20 6177  ENTIALS_PATH} aw
+00029bc0: 7320 7333 2072 6220 7b75 726c 7d20 2d2d  s s3 rb {url} --
+00029bd0: 666f 7263 6520 2d2d 656e 6470 6f69 6e74  force --endpoint
+00029be0: 207b 656e 6470 6f69 6e74 5f75 726c 7d20   {endpoint_url} 
+00029bf0: 2d2d 7072 6f66 696c 653d 7232 270a 2020  --profile=r2'.  
+00029c00: 2020 2020 2020 6966 2073 746f 7265 5f74        if store_t
+00029c10: 7970 6520 3d3d 2073 746f 7261 6765 5f6c  ype == storage_l
+00029c20: 6962 2e53 746f 7265 5479 7065 2e49 424d  ib.StoreType.IBM
+00029c30: 3a0a 2020 2020 2020 2020 2020 2020 6275  :.            bu
+00029c40: 636b 6574 5f72 636c 6f6e 655f 7072 6f66  cket_rclone_prof
+00029c50: 696c 6520 3d20 5263 6c6f 6e65 2e67 656e  ile = Rclone.gen
+00029c60: 6572 6174 655f 7263 6c6f 6e65 5f62 7563  erate_rclone_buc
+00029c70: 6b65 745f 7072 6f66 696c 655f 6e61 6d65  ket_profile_name
+00029c80: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00029c90: 2020 6275 636b 6574 5f6e 616d 652c 2052    bucket_name, R
+00029ca0: 636c 6f6e 652e 5263 6c6f 6e65 436c 6f75  clone.RcloneClou
+00029cb0: 6473 2e49 424d 290a 2020 2020 2020 2020  ds.IBM).        
+00029cc0: 2020 2020 7265 7475 726e 2066 2772 636c      return f'rcl
+00029cd0: 6f6e 6520 7075 7267 6520 7b62 7563 6b65  one purge {bucke
+00029ce0: 745f 7263 6c6f 6e65 5f70 726f 6669 6c65  t_rclone_profile
+00029cf0: 7d3a 7b62 7563 6b65 745f 6e61 6d65 7d20  }:{bucket_name} 
+00029d00: 2626 2072 636c 6f6e 6520 636f 6e66 6967  && rclone config
+00029d10: 2064 656c 6574 6520 7b62 7563 6b65 745f   delete {bucket_
+00029d20: 7263 6c6f 6e65 5f70 726f 6669 6c65 7d27  rclone_profile}'
+00029d30: 0a0a 2020 2020 4073 7461 7469 636d 6574  ..    @staticmet
+00029d40: 686f 640a 2020 2020 6465 6620 636c 695f  hod.    def cli_
+00029d50: 6c73 5f63 6d64 2873 746f 7265 5f74 7970  ls_cmd(store_typ
+00029d60: 652c 2062 7563 6b65 745f 6e61 6d65 2c20  e, bucket_name, 
+00029d70: 7375 6666 6978 3d27 2729 3a0a 2020 2020  suffix=''):.    
+00029d80: 2020 2020 6966 2073 746f 7265 5f74 7970      if store_typ
+00029d90: 6520 3d3d 2073 746f 7261 6765 5f6c 6962  e == storage_lib
+00029da0: 2e53 746f 7265 5479 7065 2e53 333a 0a20  .StoreType.S3:. 
+00029db0: 2020 2020 2020 2020 2020 2069 6620 7375             if su
+00029dc0: 6666 6978 3a0a 2020 2020 2020 2020 2020  ffix:.          
+00029dd0: 2020 2020 2020 7572 6c20 3d20 6627 7333        url = f's3
+00029de0: 3a2f 2f7b 6275 636b 6574 5f6e 616d 657d  ://{bucket_name}
+00029df0: 2f7b 7375 6666 6978 7d27 0a20 2020 2020  /{suffix}'.     
+00029e00: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00029e10: 2020 2020 2020 2020 2020 2020 2075 726c               url
+00029e20: 203d 2066 2773 333a 2f2f 7b62 7563 6b65   = f's3://{bucke
+00029e30: 745f 6e61 6d65 7d27 0a20 2020 2020 2020  t_name}'.       
+00029e40: 2020 2020 2072 6574 7572 6e20 6627 6177       return f'aw
+00029e50: 7320 7333 206c 7320 7b75 726c 7d27 0a20  s s3 ls {url}'. 
+00029e60: 2020 2020 2020 2069 6620 7374 6f72 655f         if store_
+00029e70: 7479 7065 203d 3d20 7374 6f72 6167 655f  type == storage_
+00029e80: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
+00029e90: 533a 0a20 2020 2020 2020 2020 2020 2069  S:.            i
+00029ea0: 6620 7375 6666 6978 3a0a 2020 2020 2020  f suffix:.      
+00029eb0: 2020 2020 2020 2020 2020 7572 6c20 3d20            url = 
+00029ec0: 6627 6773 3a2f 2f7b 6275 636b 6574 5f6e  f'gs://{bucket_n
+00029ed0: 616d 657d 2f7b 7375 6666 6978 7d27 0a20  ame}/{suffix}'. 
+00029ee0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00029ef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029f00: 2075 726c 203d 2066 2767 733a 2f2f 7b62   url = f'gs://{b
+00029f10: 7563 6b65 745f 6e61 6d65 7d27 0a20 2020  ucket_name}'.   
+00029f20: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00029f30: 6627 6773 7574 696c 206c 7320 7b75 726c  f'gsutil ls {url
+00029f40: 7d27 0a20 2020 2020 2020 2069 6620 7374  }'.        if st
+00029f50: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
+00029f60: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+00029f70: 652e 5232 3a0a 2020 2020 2020 2020 2020  e.R2:.          
+00029f80: 2020 656e 6470 6f69 6e74 5f75 726c 203d    endpoint_url =
+00029f90: 2063 6c6f 7564 666c 6172 652e 6372 6561   cloudflare.crea
+00029fa0: 7465 5f65 6e64 706f 696e 7428 290a 2020  te_endpoint().  
+00029fb0: 2020 2020 2020 2020 2020 6966 2073 7566            if suf
+00029fc0: 6669 783a 0a20 2020 2020 2020 2020 2020  fix:.           
+00029fd0: 2020 2020 2075 726c 203d 2066 2773 333a       url = f's3:
+00029fe0: 2f2f 7b62 7563 6b65 745f 6e61 6d65 7d2f  //{bucket_name}/
+00029ff0: 7b73 7566 6669 787d 270a 2020 2020 2020  {suffix}'.      
+0002a000: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0002a010: 2020 2020 2020 2020 2020 2020 7572 6c20              url 
+0002a020: 3d20 6627 7333 3a2f 2f7b 6275 636b 6574  = f's3://{bucket
+0002a030: 5f6e 616d 657d 270a 2020 2020 2020 2020  _name}'.        
+0002a040: 2020 2020 7265 7475 726e 2066 2741 5753      return f'AWS
+0002a050: 5f53 4841 5245 445f 4352 4544 454e 5449  _SHARED_CREDENTI
+0002a060: 414c 535f 4649 4c45 3d7b 636c 6f75 6466  ALS_FILE={cloudf
+0002a070: 6c61 7265 2e52 325f 4352 4544 454e 5449  lare.R2_CREDENTI
+0002a080: 414c 535f 5041 5448 7d20 6177 7320 7333  ALS_PATH} aws s3
+0002a090: 206c 7320 7b75 726c 7d20 2d2d 656e 6470   ls {url} --endp
+0002a0a0: 6f69 6e74 207b 656e 6470 6f69 6e74 5f75  oint {endpoint_u
+0002a0b0: 726c 7d20 2d2d 7072 6f66 696c 653d 7232  rl} --profile=r2
+0002a0c0: 270a 2020 2020 2020 2020 6966 2073 746f  '.        if sto
+0002a0d0: 7265 5f74 7970 6520 3d3d 2073 746f 7261  re_type == stora
+0002a0e0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0002a0f0: 2e49 424d 3a0a 2020 2020 2020 2020 2020  .IBM:.          
+0002a100: 2020 6275 636b 6574 5f72 636c 6f6e 655f    bucket_rclone_
+0002a110: 7072 6f66 696c 6520 3d20 5263 6c6f 6e65  profile = Rclone
+0002a120: 2e67 656e 6572 6174 655f 7263 6c6f 6e65  .generate_rclone
+0002a130: 5f62 7563 6b65 745f 7072 6f66 696c 655f  _bucket_profile_
+0002a140: 6e61 6d65 280a 2020 2020 2020 2020 2020  name(.          
+0002a150: 2020 2020 2020 6275 636b 6574 5f6e 616d        bucket_nam
+0002a160: 652c 2052 636c 6f6e 652e 5263 6c6f 6e65  e, Rclone.Rclone
+0002a170: 436c 6f75 6473 2e49 424d 290a 2020 2020  Clouds.IBM).    
+0002a180: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+0002a190: 2772 636c 6f6e 6520 6c73 207b 6275 636b  'rclone ls {buck
+0002a1a0: 6574 5f72 636c 6f6e 655f 7072 6f66 696c  et_rclone_profil
+0002a1b0: 657d 3a7b 6275 636b 6574 5f6e 616d 657d  e}:{bucket_name}
+0002a1c0: 2f7b 7375 6666 6978 7d27 0a0a 2020 2020  /{suffix}'..    
+0002a1d0: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
+0002a1e0: 2020 6465 6620 636c 695f 7265 6769 6f6e    def cli_region
+0002a1f0: 5f63 6d64 2873 746f 7265 5f74 7970 652c  _cmd(store_type,
+0002a200: 2062 7563 6b65 745f 6e61 6d65 293a 0a20   bucket_name):. 
+0002a210: 2020 2020 2020 2069 6620 7374 6f72 655f         if store_
+0002a220: 7479 7065 203d 3d20 7374 6f72 6167 655f  type == storage_
+0002a230: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
+0002a240: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0002a250: 7475 726e 2028 2761 7773 2073 3361 7069  turn ('aws s3api
+0002a260: 2067 6574 2d62 7563 6b65 742d 6c6f 6361   get-bucket-loca
+0002a270: 7469 6f6e 2027 0a20 2020 2020 2020 2020  tion '.         
+0002a280: 2020 2020 2020 2020 2020 2066 272d 2d62             f'--b
+0002a290: 7563 6b65 7420 7b62 7563 6b65 745f 6e61  ucket {bucket_na
+0002a2a0: 6d65 7d20 2d2d 6f75 7470 7574 2074 6578  me} --output tex
+0002a2b0: 7427 290a 2020 2020 2020 2020 656c 6966  t').        elif
+0002a2c0: 2073 746f 7265 5f74 7970 6520 3d3d 2073   store_type == s
+0002a2d0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+0002a2e0: 5479 7065 2e47 4353 3a0a 2020 2020 2020  Type.GCS:.      
+0002a2f0: 2020 2020 2020 7265 7475 726e 2028 6627        return (f'
+0002a300: 6773 7574 696c 206c 7320 2d4c 202d 6220  gsutil ls -L -b 
+0002a310: 6773 3a2f 2f7b 6275 636b 6574 5f6e 616d  gs://{bucket_nam
+0002a320: 657d 2f20 7c20 270a 2020 2020 2020 2020  e}/ | '.        
+0002a330: 2020 2020 2020 2020 2020 2020 2767 7265              'gre
+0002a340: 7020 224c 6f63 6174 696f 6e20 636f 6e73  p "Location cons
+0002a350: 7472 6169 6e74 2220 7c20 270a 2020 2020  traint" | '.    
+0002a360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a370: 2761 776b 205c 277b 7072 696e 7420 746f  'awk \'{print to
+0002a380: 6c6f 7765 7228 244e 4629 7d5c 2727 290a  lower($NF)}\'').
+0002a390: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0002a3a0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0002a3b0: 4e6f 7449 6d70 6c65 6d65 6e74 6564 4572  NotImplementedEr
+0002a3c0: 726f 7228 6627 5265 6769 6f6e 2063 6f6d  ror(f'Region com
+0002a3d0: 6d61 6e64 206e 6f74 2069 6d70 6c65 6d65  mand not impleme
+0002a3e0: 6e74 6564 2066 6f72 2027 0a20 2020 2020  nted for '.     
+0002a3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a410: 2066 277b 7374 6f72 655f 7479 7065 7d27   f'{store_type}'
+0002a420: 290a 0a20 2020 2040 7374 6174 6963 6d65  )..    @staticme
+0002a430: 7468 6f64 0a20 2020 2064 6566 2063 6c69  thod.    def cli
+0002a440: 5f63 6f75 6e74 5f6e 616d 655f 696e 5f62  _count_name_in_b
+0002a450: 7563 6b65 7428 7374 6f72 655f 7479 7065  ucket(store_type
+0002a460: 2c20 6275 636b 6574 5f6e 616d 652c 2066  , bucket_name, f
+0002a470: 696c 655f 6e61 6d65 2c20 7375 6666 6978  ile_name, suffix
+0002a480: 3d27 2729 3a0a 2020 2020 2020 2020 6966  =''):.        if
+0002a490: 2073 746f 7265 5f74 7970 6520 3d3d 2073   store_type == s
+0002a4a0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+0002a4b0: 5479 7065 2e53 333a 0a20 2020 2020 2020  Type.S3:.       
+0002a4c0: 2020 2020 2069 6620 7375 6666 6978 3a0a       if suffix:.
+0002a4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a4e0: 7265 7475 726e 2066 2761 7773 2073 3361  return f'aws s3a
+0002a4f0: 7069 206c 6973 742d 6f62 6a65 6374 7320  pi list-objects 
+0002a500: 2d2d 6275 636b 6574 2022 7b62 7563 6b65  --bucket "{bucke
+0002a510: 745f 6e61 6d65 7d22 202d 2d70 7265 6669  t_name}" --prefi
+0002a520: 7820 7b73 7566 6669 787d 202d 2d71 7565  x {suffix} --que
+0002a530: 7279 2022 6c65 6e67 7468 2843 6f6e 7465  ry "length(Conte
+0002a540: 6e74 735b 3f63 6f6e 7461 696e 7328 4b65  nts[?contains(Ke
+0002a550: 792c 5c27 7b66 696c 655f 6e61 6d65 7d5c  y,\'{file_name}\
+0002a560: 2729 5d2e 4b65 7929 2227 0a20 2020 2020  ')].Key)"'.     
+0002a570: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0002a580: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0002a590: 7572 6e20 6627 6177 7320 7333 6170 6920  urn f'aws s3api 
+0002a5a0: 6c69 7374 2d6f 626a 6563 7473 202d 2d62  list-objects --b
+0002a5b0: 7563 6b65 7420 227b 6275 636b 6574 5f6e  ucket "{bucket_n
+0002a5c0: 616d 657d 2220 2d2d 7175 6572 7920 226c  ame}" --query "l
+0002a5d0: 656e 6774 6828 436f 6e74 656e 7473 5b3f  ength(Contents[?
+0002a5e0: 636f 6e74 6169 6e73 284b 6579 2c5c 277b  contains(Key,\'{
+0002a5f0: 6669 6c65 5f6e 616d 657d 5c27 295d 2e4b  file_name}\')].K
+0002a600: 6579 2922 270a 2020 2020 2020 2020 656c  ey)"'.        el
+0002a610: 6966 2073 746f 7265 5f74 7970 6520 3d3d  if store_type ==
+0002a620: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+0002a630: 7265 5479 7065 2e47 4353 3a0a 2020 2020  reType.GCS:.    
+0002a640: 2020 2020 2020 2020 6966 2073 7566 6669          if suffi
+0002a650: 783a 0a20 2020 2020 2020 2020 2020 2020  x:.             
+0002a660: 2020 2072 6574 7572 6e20 6627 6773 7574     return f'gsut
+0002a670: 696c 206c 7320 2d72 2067 733a 2f2f 7b62  il ls -r gs://{b
+0002a680: 7563 6b65 745f 6e61 6d65 7d2f 7b73 7566  ucket_name}/{suf
+0002a690: 6669 787d 207c 2067 7265 7020 227b 6669  fix} | grep "{fi
+0002a6a0: 6c65 5f6e 616d 657d 2220 7c20 7763 202d  le_name}" | wc -
+0002a6b0: 6c27 0a20 2020 2020 2020 2020 2020 2065  l'.            e
+0002a6c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0002a6d0: 2020 2020 2072 6574 7572 6e20 6627 6773       return f'gs
+0002a6e0: 7574 696c 206c 7320 2d72 2067 733a 2f2f  util ls -r gs://
+0002a6f0: 7b62 7563 6b65 745f 6e61 6d65 7d20 7c20  {bucket_name} | 
+0002a700: 6772 6570 2022 7b66 696c 655f 6e61 6d65  grep "{file_name
+0002a710: 7d22 207c 2077 6320 2d6c 270a 2020 2020  }" | wc -l'.    
+0002a720: 2020 2020 656c 6966 2073 746f 7265 5f74      elif store_t
+0002a730: 7970 6520 3d3d 2073 746f 7261 6765 5f6c  ype == storage_l
+0002a740: 6962 2e53 746f 7265 5479 7065 2e52 323a  ib.StoreType.R2:
+0002a750: 0a20 2020 2020 2020 2020 2020 2065 6e64  .            end
+0002a760: 706f 696e 745f 7572 6c20 3d20 636c 6f75  point_url = clou
+0002a770: 6466 6c61 7265 2e63 7265 6174 655f 656e  dflare.create_en
+0002a780: 6470 6f69 6e74 2829 0a20 2020 2020 2020  dpoint().       
+0002a790: 2020 2020 2069 6620 7375 6666 6978 3a0a       if suffix:.
+0002a7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a7b0: 7265 7475 726e 2066 2741 5753 5f53 4841  return f'AWS_SHA
+0002a7c0: 5245 445f 4352 4544 454e 5449 414c 535f  RED_CREDENTIALS_
+0002a7d0: 4649 4c45 3d7b 636c 6f75 6466 6c61 7265  FILE={cloudflare
+0002a7e0: 2e52 325f 4352 4544 454e 5449 414c 535f  .R2_CREDENTIALS_
+0002a7f0: 5041 5448 7d20 6177 7320 7333 6170 6920  PATH} aws s3api 
+0002a800: 6c69 7374 2d6f 626a 6563 7473 202d 2d62  list-objects --b
+0002a810: 7563 6b65 7420 227b 6275 636b 6574 5f6e  ucket "{bucket_n
+0002a820: 616d 657d 2220 2d2d 7072 6566 6978 207b  ame}" --prefix {
+0002a830: 7375 6666 6978 7d20 2d2d 7175 6572 7920  suffix} --query 
+0002a840: 226c 656e 6774 6828 436f 6e74 656e 7473  "length(Contents
+0002a850: 5b3f 636f 6e74 6169 6e73 284b 6579 2c5c  [?contains(Key,\
+0002a860: 277b 6669 6c65 5f6e 616d 657d 5c27 295d  '{file_name}\')]
+0002a870: 2e4b 6579 2922 202d 2d65 6e64 706f 696e  .Key)" --endpoin
+0002a880: 7420 7b65 6e64 706f 696e 745f 7572 6c7d  t {endpoint_url}
+0002a890: 202d 2d70 726f 6669 6c65 3d72 3227 0a20   --profile=r2'. 
+0002a8a0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0002a8b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a8c0: 2072 6574 7572 6e20 6627 4157 535f 5348   return f'AWS_SH
+0002a8d0: 4152 4544 5f43 5245 4445 4e54 4941 4c53  ARED_CREDENTIALS
+0002a8e0: 5f46 494c 453d 7b63 6c6f 7564 666c 6172  _FILE={cloudflar
+0002a8f0: 652e 5232 5f43 5245 4445 4e54 4941 4c53  e.R2_CREDENTIALS
+0002a900: 5f50 4154 487d 2061 7773 2073 3361 7069  _PATH} aws s3api
+0002a910: 206c 6973 742d 6f62 6a65 6374 7320 2d2d   list-objects --
+0002a920: 6275 636b 6574 2022 7b62 7563 6b65 745f  bucket "{bucket_
+0002a930: 6e61 6d65 7d22 202d 2d71 7565 7279 2022  name}" --query "
+0002a940: 6c65 6e67 7468 2843 6f6e 7465 6e74 735b  length(Contents[
+0002a950: 3f63 6f6e 7461 696e 7328 4b65 792c 5c27  ?contains(Key,\'
+0002a960: 7b66 696c 655f 6e61 6d65 7d5c 2729 5d2e  {file_name}\')].
+0002a970: 4b65 7929 2220 2d2d 656e 6470 6f69 6e74  Key)" --endpoint
+0002a980: 207b 656e 6470 6f69 6e74 5f75 726c 7d20   {endpoint_url} 
+0002a990: 2d2d 7072 6f66 696c 653d 7232 270a 0a20  --profile=r2'.. 
+0002a9a0: 2020 2040 7374 6174 6963 6d65 7468 6f64     @staticmethod
+0002a9b0: 0a20 2020 2064 6566 2063 6c69 5f63 6f75  .    def cli_cou
+0002a9c0: 6e74 5f66 696c 655f 696e 5f62 7563 6b65  nt_file_in_bucke
+0002a9d0: 7428 7374 6f72 655f 7479 7065 2c20 6275  t(store_type, bu
+0002a9e0: 636b 6574 5f6e 616d 6529 3a0a 2020 2020  cket_name):.    
+0002a9f0: 2020 2020 6966 2073 746f 7265 5f74 7970      if store_typ
+0002aa00: 6520 3d3d 2073 746f 7261 6765 5f6c 6962  e == storage_lib
+0002aa10: 2e53 746f 7265 5479 7065 2e53 333a 0a20  .StoreType.S3:. 
+0002aa20: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0002aa30: 6e20 6627 6177 7320 7333 206c 7320 7333  n f'aws s3 ls s3
+0002aa40: 3a2f 2f7b 6275 636b 6574 5f6e 616d 657d  ://{bucket_name}
+0002aa50: 202d 2d72 6563 7572 7369 7665 207c 2077   --recursive | w
+0002aa60: 6320 2d6c 270a 2020 2020 2020 2020 656c  c -l'.        el
+0002aa70: 6966 2073 746f 7265 5f74 7970 6520 3d3d  if store_type ==
+0002aa80: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+0002aa90: 7265 5479 7065 2e47 4353 3a0a 2020 2020  reType.GCS:.    
+0002aaa0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+0002aab0: 2767 7375 7469 6c20 6c73 202d 7220 6773  'gsutil ls -r gs
+0002aac0: 3a2f 2f7b 6275 636b 6574 5f6e 616d 657d  ://{bucket_name}
+0002aad0: 2f2a 2a20 7c20 7763 202d 6c27 0a20 2020  /** | wc -l'.   
+0002aae0: 2020 2020 2065 6c69 6620 7374 6f72 655f       elif store_
+0002aaf0: 7479 7065 203d 3d20 7374 6f72 6167 655f  type == storage_
+0002ab00: 6c69 622e 5374 6f72 6554 7970 652e 5232  lib.StoreType.R2
+0002ab10: 3a0a 2020 2020 2020 2020 2020 2020 656e  :.            en
+0002ab20: 6470 6f69 6e74 5f75 726c 203d 2063 6c6f  dpoint_url = clo
+0002ab30: 7564 666c 6172 652e 6372 6561 7465 5f65  udflare.create_e
+0002ab40: 6e64 706f 696e 7428 290a 2020 2020 2020  ndpoint().      
+0002ab50: 2020 2020 2020 7265 7475 726e 2066 2741        return f'A
+0002ab60: 5753 5f53 4841 5245 445f 4352 4544 454e  WS_SHARED_CREDEN
+0002ab70: 5449 414c 535f 4649 4c45 3d7b 636c 6f75  TIALS_FILE={clou
+0002ab80: 6466 6c61 7265 2e52 325f 4352 4544 454e  dflare.R2_CREDEN
+0002ab90: 5449 414c 535f 5041 5448 7d20 6177 7320  TIALS_PATH} aws 
+0002aba0: 7333 206c 7320 7333 3a2f 2f7b 6275 636b  s3 ls s3://{buck
+0002abb0: 6574 5f6e 616d 657d 202d 2d72 6563 7572  et_name} --recur
+0002abc0: 7369 7665 202d 2d65 6e64 706f 696e 7420  sive --endpoint 
+0002abd0: 7b65 6e64 706f 696e 745f 7572 6c7d 202d  {endpoint_url} -
+0002abe0: 2d70 726f 6669 6c65 3d72 3220 7c20 7763  -profile=r2 | wc
+0002abf0: 202d 6c27 0a0a 2020 2020 4070 7974 6573   -l'..    @pytes
+0002ac00: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
+0002ac10: 6620 746d 705f 736f 7572 6365 2873 656c  f tmp_source(sel
+0002ac20: 662c 2074 6d70 5f70 6174 6829 3a0a 2020  f, tmp_path):.  
+0002ac30: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
+0002ac40: 6120 7465 6d70 6f72 6172 7920 6469 7265  a temporary dire
+0002ac50: 6374 6f72 7920 7769 7468 2061 2066 696c  ctory with a fil
+0002ac60: 6520 696e 2069 740a 2020 2020 2020 2020  e in it.        
+0002ac70: 746d 705f 6469 7220 3d20 746d 705f 7061  tmp_dir = tmp_pa
+0002ac80: 7468 202f 2027 746d 702d 736f 7572 6365  th / 'tmp-source
+0002ac90: 270a 2020 2020 2020 2020 746d 705f 6469  '.        tmp_di
+0002aca0: 722e 6d6b 6469 7228 290a 2020 2020 2020  r.mkdir().      
+0002acb0: 2020 746d 705f 6669 6c65 203d 2074 6d70    tmp_file = tmp
+0002acc0: 5f64 6972 202f 2027 746d 702d 6669 6c65  _dir / 'tmp-file
+0002acd0: 270a 2020 2020 2020 2020 746d 705f 6669  '.        tmp_fi
+0002ace0: 6c65 2e77 7269 7465 5f74 6578 7428 2774  le.write_text('t
+0002acf0: 6573 7427 290a 2020 2020 2020 2020 6369  est').        ci
+0002ad00: 7263 6c65 5f6c 696e 6b20 3d20 746d 705f  rcle_link = tmp_
+0002ad10: 6469 7220 2f20 2763 6972 636c 652d 6c69  dir / 'circle-li
+0002ad20: 6e6b 270a 2020 2020 2020 2020 6369 7263  nk'.        circ
+0002ad30: 6c65 5f6c 696e 6b2e 7379 6d6c 696e 6b5f  le_link.symlink_
+0002ad40: 746f 2874 6d70 5f64 6972 2c20 7461 7267  to(tmp_dir, targ
+0002ad50: 6574 5f69 735f 6469 7265 6374 6f72 793d  et_is_directory=
+0002ad60: 5472 7565 290a 2020 2020 2020 2020 7969  True).        yi
+0002ad70: 656c 6420 7374 7228 746d 705f 6469 7229  eld str(tmp_dir)
+0002ad80: 0a0a 2020 2020 4073 7461 7469 636d 6574  ..    @staticmet
+0002ad90: 686f 640a 2020 2020 6465 6620 6765 6e65  hod.    def gene
+0002ada0: 7261 7465 5f62 7563 6b65 745f 6e61 6d65  rate_bucket_name
+0002adb0: 2829 3a0a 2020 2020 2020 2020 2320 4372  ():.        # Cr
+0002adc0: 6561 7465 7320 6120 7465 6d70 6f72 6172  eates a temporar
+0002add0: 7920 6275 636b 6574 206e 616d 650a 2020  y bucket name.  
+0002ade0: 2020 2020 2020 2320 7469 6d65 2e74 696d        # time.tim
+0002adf0: 6528 2920 7265 7475 726e 7320 7661 7279  e() returns vary
+0002ae00: 696e 6720 7072 6563 6973 696f 6e20 6f6e  ing precision on
+0002ae10: 2064 6966 6665 7265 6e74 2073 7973 7465   different syste
+0002ae20: 6d73 2c20 736f 2077 650a 2020 2020 2020  ms, so we.      
+0002ae30: 2020 2320 7265 706c 6163 6520 7468 6520    # replace the 
+0002ae40: 6465 6369 6d61 6c20 706f 696e 7420 616e  decimal point an
+0002ae50: 6420 7573 6520 7768 6174 6576 6572 2070  d use whatever p
+0002ae60: 7265 6369 7369 6f6e 2077 6520 6361 6e20  recision we can 
+0002ae70: 6765 742e 0a20 2020 2020 2020 2074 696d  get..        tim
+0002ae80: 6573 7461 6d70 203d 2073 7472 2874 696d  estamp = str(tim
+0002ae90: 652e 7469 6d65 2829 292e 7265 706c 6163  e.time()).replac
+0002aea0: 6528 272e 272c 2027 2729 0a20 2020 2020  e('.', '').     
+0002aeb0: 2020 2072 6574 7572 6e20 6627 736b 792d     return f'sky-
+0002aec0: 7465 7374 2d7b 7469 6d65 7374 616d 707d  test-{timestamp}
+0002aed0: 270a 0a20 2020 2040 7079 7465 7374 2e66  '..    @pytest.f
+0002aee0: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
+0002aef0: 6d70 5f62 7563 6b65 745f 6e61 6d65 2873  mp_bucket_name(s
+0002af00: 656c 6629 3a0a 2020 2020 2020 2020 7969  elf):.        yi
+0002af10: 656c 6420 7365 6c66 2e67 656e 6572 6174  eld self.generat
+0002af20: 655f 6275 636b 6574 5f6e 616d 6528 290a  e_bucket_name().
+0002af30: 0a20 2020 2040 7374 6174 6963 6d65 7468  .    @staticmeth
+0002af40: 6f64 0a20 2020 2064 6566 2079 6965 6c64  od.    def yield
+0002af50: 5f73 746f 7261 6765 5f6f 626a 6563 7428  _storage_object(
+0002af60: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+0002af70: 653a 204f 7074 696f 6e61 6c5b 7374 725d  e: Optional[str]
+0002af80: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+0002af90: 2020 2020 2073 6f75 7263 653a 204f 7074       source: Opt
+0002afa0: 696f 6e61 6c5b 7374 6f72 6167 655f 6c69  ional[storage_li
+0002afb0: 622e 5061 7468 5d20 3d20 4e6f 6e65 2c0a  b.Path] = None,.
+0002afc0: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+0002afd0: 6573 3a20 4f70 7469 6f6e 616c 5b44 6963  es: Optional[Dic
+0002afe0: 745b 7374 6f72 6167 655f 6c69 622e 5374  t[storage_lib.St
+0002aff0: 6f72 6554 7970 652c 0a20 2020 2020 2020  oreType,.       
+0002b000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b010: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+0002b020: 6765 5f6c 6962 2e41 6273 7472 6163 7453  ge_lib.AbstractS
+0002b030: 746f 7265 5d5d 203d 204e 6f6e 652c 0a20  tore]] = None,. 
+0002b040: 2020 2020 2020 2020 2020 2070 6572 7369             persi
+0002b050: 7374 656e 743a 204f 7074 696f 6e61 6c5b  stent: Optional[
+0002b060: 626f 6f6c 5d20 3d20 5472 7565 2c0a 2020  bool] = True,.  
+0002b070: 2020 2020 2020 2020 2020 6d6f 6465 3a20            mode: 
+0002b080: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002b090: 6167 654d 6f64 6520 3d20 7374 6f72 6167  ageMode = storag
+0002b0a0: 655f 6c69 622e 5374 6f72 6167 654d 6f64  e_lib.StorageMod
+0002b0b0: 652e 4d4f 554e 5429 3a0a 2020 2020 2020  e.MOUNT):.      
+0002b0c0: 2020 2320 4372 6561 7465 7320 6120 7465    # Creates a te
+0002b0d0: 6d70 6f72 6172 7920 7374 6f72 6167 6520  mporary storage 
+0002b0e0: 6f62 6a65 6374 2e20 5374 6f72 6573 206d  object. Stores m
+0002b0f0: 7573 7420 6265 2061 6464 6564 2069 6e20  ust be added in 
+0002b100: 7468 6520 7465 7374 2e0a 2020 2020 2020  the test..      
+0002b110: 2020 7374 6f72 6167 655f 6f62 6a20 3d20    storage_obj = 
+0002b120: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002b130: 6167 6528 6e61 6d65 3d6e 616d 652c 0a20  age(name=name,. 
 0002b140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b150: 2020 2073 6f75 7263 653d 736f 7572 6365     source=source
-0002b160: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002b170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b180: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-0002b190: 6573 3d73 746f 7265 732c 0a20 2020 2020  es=stores,.     
-0002b1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b1c0: 2020 2020 2070 6572 7369 7374 656e 743d       persistent=
-0002b1d0: 7065 7273 6973 7465 6e74 2c0a 2020 2020  persistent,.    
-0002b1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b200: 2020 2020 2020 6d6f 6465 3d6d 6f64 6529        mode=mode)
-0002b210: 0a20 2020 2020 2020 2079 6965 6c64 2073  .        yield s
-0002b220: 746f 7261 6765 5f6f 626a 0a20 2020 2020  torage_obj.     
-0002b230: 2020 2068 616e 646c 6520 3d20 676c 6f62     handle = glob
-0002b240: 616c 5f75 7365 725f 7374 6174 652e 6765  al_user_state.ge
-0002b250: 745f 6861 6e64 6c65 5f66 726f 6d5f 7374  t_handle_from_st
-0002b260: 6f72 6167 655f 6e61 6d65 280a 2020 2020  orage_name(.    
-0002b270: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-0002b280: 6f62 6a2e 6e61 6d65 290a 2020 2020 2020  obj.name).      
-0002b290: 2020 6966 2068 616e 646c 653a 0a20 2020    if handle:.   
-0002b2a0: 2020 2020 2020 2020 2023 2049 6620 6861           # If ha
-0002b2b0: 6e64 6c65 2065 7869 7374 732c 2064 656c  ndle exists, del
-0002b2c0: 6574 6520 6d61 6e75 616c 6c79 0a20 2020  ete manually.   
-0002b2d0: 2020 2020 2020 2020 2023 2054 4f44 4f28           # TODO(
-0002b2e0: 726f 6d69 6c62 293a 2054 6869 7320 6973  romilb): This is
-0002b2f0: 2070 6f74 656e 7469 616c 6c79 2072 6973   potentially ris
-0002b300: 6b79 202d 2069 6620 7468 6520 6465 6c65  ky - if the dele
-0002b310: 7465 206d 6574 686f 6420 6861 730a 2020  te method has.  
-0002b320: 2020 2020 2020 2020 2020 2320 2020 6275            #   bu
-0002b330: 6773 2c20 7468 6973 2063 616e 2063 6175  gs, this can cau
-0002b340: 7365 2072 6573 6f75 7263 6520 6c65 616b  se resource leak
-0002b350: 732e 2049 6465 616c 6c79 2077 6520 7368  s. Ideally we sh
-0002b360: 6f75 6c64 206d 616e 7561 6c6c 790a 2020  ould manually.  
-0002b370: 2020 2020 2020 2020 2020 2320 2020 656a            #   ej
-0002b380: 6563 7420 7374 6f72 6167 6520 6672 6f6d  ect storage from
-0002b390: 2067 6c6f 6261 6c5f 7573 6572 5f73 7461   global_user_sta
-0002b3a0: 7465 2061 6e64 2064 656c 6574 6520 7468  te and delete th
-0002b3b0: 6520 6275 636b 6574 2075 7369 6e67 0a20  e bucket using. 
-0002b3c0: 2020 2020 2020 2020 2020 2023 2020 2062             #   b
-0002b3d0: 6f74 6f33 2064 6972 6563 746c 792e 0a20  oto3 directly.. 
-0002b3e0: 2020 2020 2020 2020 2020 2073 746f 7261             stora
-0002b3f0: 6765 5f6f 626a 2e64 656c 6574 6528 290a  ge_obj.delete().
-0002b400: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
-0002b410: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
-0002b420: 5f73 6372 6174 6368 5f73 746f 7261 6765  _scratch_storage
-0002b430: 5f6f 626a 2873 656c 662c 2074 6d70 5f62  _obj(self, tmp_b
-0002b440: 7563 6b65 745f 6e61 6d65 293a 0a20 2020  ucket_name):.   
-0002b450: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
-0002b460: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
-0002b470: 7769 7468 206e 6f20 736f 7572 6365 2074  with no source t
-0002b480: 6f20 6372 6561 7465 2061 2073 6372 6174  o create a scrat
-0002b490: 6368 2073 746f 7261 6765 2e0a 2020 2020  ch storage..    
-0002b4a0: 2020 2020 2320 5374 6f72 6573 206d 7573      # Stores mus
-0002b4b0: 7420 6265 2061 6464 6564 2069 6e20 7468  t be added in th
-0002b4c0: 6520 7465 7374 2e0a 2020 2020 2020 2020  e test..        
-0002b4d0: 7969 656c 6420 6672 6f6d 2073 656c 662e  yield from self.
-0002b4e0: 7969 656c 645f 7374 6f72 6167 655f 6f62  yield_storage_ob
-0002b4f0: 6a65 6374 286e 616d 653d 746d 705f 6275  ject(name=tmp_bu
-0002b500: 636b 6574 5f6e 616d 6529 0a0a 2020 2020  cket_name)..    
-0002b510: 4070 7974 6573 742e 6669 7874 7572 650a  @pytest.fixture.
-0002b520: 2020 2020 6465 6620 746d 705f 6d75 6c74      def tmp_mult
-0002b530: 6970 6c65 5f73 6372 6174 6368 5f73 746f  iple_scratch_sto
-0002b540: 7261 6765 5f6f 626a 2873 656c 6629 3a0a  rage_obj(self):.
-0002b550: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
-0002b560: 7320 6120 6c69 7374 206f 6620 3520 7374  s a list of 5 st
-0002b570: 6f72 6167 6520 6f62 6a65 6374 7320 7769  orage objects wi
-0002b580: 7468 206e 6f20 736f 7572 6365 2074 6f20  th no source to 
-0002b590: 6372 6561 7465 0a20 2020 2020 2020 2023  create.        #
-0002b5a0: 206d 756c 7469 706c 6520 7363 7261 7463   multiple scratc
-0002b5b0: 6820 7374 6f72 6167 6573 2e0a 2020 2020  h storages..    
-0002b5c0: 2020 2020 2320 5374 6f72 6573 2066 6f72      # Stores for
-0002b5d0: 2065 6163 6820 6f62 6a65 6374 2069 6e20   each object in 
-0002b5e0: 7468 6520 6c69 7374 206d 7573 7420 6265  the list must be
-0002b5f0: 2061 6464 6564 2069 6e20 7468 6520 7465   added in the te
-0002b600: 7374 2e0a 2020 2020 2020 2020 7374 6f72  st..        stor
-0002b610: 6167 655f 6d75 6c74 5f6f 626a 203d 205b  age_mult_obj = [
-0002b620: 5d0a 2020 2020 2020 2020 666f 7220 5f20  ].        for _ 
-0002b630: 696e 2072 616e 6765 2835 293a 0a20 2020  in range(5):.   
-0002b640: 2020 2020 2020 2020 2074 696d 6573 7461           timesta
-0002b650: 6d70 203d 2073 7472 2874 696d 652e 7469  mp = str(time.ti
-0002b660: 6d65 2829 292e 7265 706c 6163 6528 272e  me()).replace('.
-0002b670: 272c 2027 2729 0a20 2020 2020 2020 2020  ', '').         
-0002b680: 2020 2073 746f 7265 5f6f 626a 203d 2073     store_obj = s
-0002b690: 746f 7261 6765 5f6c 6962 2e53 746f 7261  torage_lib.Stora
-0002b6a0: 6765 286e 616d 653d 6627 736b 792d 7465  ge(name=f'sky-te
-0002b6b0: 7374 2d7b 7469 6d65 7374 616d 707d 2729  st-{timestamp}')
-0002b6c0: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
-0002b6d0: 7261 6765 5f6d 756c 745f 6f62 6a2e 6170  rage_mult_obj.ap
-0002b6e0: 7065 6e64 2873 746f 7265 5f6f 626a 290a  pend(store_obj).
-0002b6f0: 2020 2020 2020 2020 7969 656c 6420 7374          yield st
-0002b700: 6f72 6167 655f 6d75 6c74 5f6f 626a 0a20  orage_mult_obj. 
-0002b710: 2020 2020 2020 2066 6f72 2073 746f 7261         for stora
-0002b720: 6765 5f6f 626a 2069 6e20 7374 6f72 6167  ge_obj in storag
-0002b730: 655f 6d75 6c74 5f6f 626a 3a0a 2020 2020  e_mult_obj:.    
-0002b740: 2020 2020 2020 2020 6861 6e64 6c65 203d          handle =
-0002b750: 2067 6c6f 6261 6c5f 7573 6572 5f73 7461   global_user_sta
-0002b760: 7465 2e67 6574 5f68 616e 646c 655f 6672  te.get_handle_fr
-0002b770: 6f6d 5f73 746f 7261 6765 5f6e 616d 6528  om_storage_name(
-0002b780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b790: 2073 746f 7261 6765 5f6f 626a 2e6e 616d   storage_obj.nam
-0002b7a0: 6529 0a20 2020 2020 2020 2020 2020 2069  e).            i
-0002b7b0: 6620 6861 6e64 6c65 3a0a 2020 2020 2020  f handle:.      
-0002b7c0: 2020 2020 2020 2020 2020 2320 4966 2068            # If h
-0002b7d0: 616e 646c 6520 6578 6973 7473 2c20 6465  andle exists, de
-0002b7e0: 6c65 7465 206d 616e 7561 6c6c 790a 2020  lete manually.  
-0002b7f0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0002b800: 544f 444f 2872 6f6d 696c 6229 3a20 5468  TODO(romilb): Th
-0002b810: 6973 2069 7320 706f 7465 6e74 6961 6c6c  is is potentiall
-0002b820: 7920 7269 736b 7920 2d20 6966 2074 6865  y risky - if the
-0002b830: 2064 656c 6574 6520 6d65 7468 6f64 2068   delete method h
-0002b840: 6173 0a20 2020 2020 2020 2020 2020 2020  as.             
-0002b850: 2020 2023 2062 7567 732c 2074 6869 7320     # bugs, this 
-0002b860: 6361 6e20 6361 7573 6520 7265 736f 7572  can cause resour
-0002b870: 6365 206c 6561 6b73 2e20 4964 6561 6c6c  ce leaks. Ideall
-0002b880: 7920 7765 2073 686f 756c 6420 6d61 6e75  y we should manu
-0002b890: 616c 6c79 0a20 2020 2020 2020 2020 2020  ally.           
-0002b8a0: 2020 2020 2023 2065 6a65 6374 2073 746f       # eject sto
-0002b8b0: 7261 6765 2066 726f 6d20 676c 6f62 616c  rage from global
-0002b8c0: 5f75 7365 725f 7374 6174 6520 616e 6420  _user_state and 
-0002b8d0: 6465 6c65 7465 2074 6865 2062 7563 6b65  delete the bucke
-0002b8e0: 7420 7573 696e 670a 2020 2020 2020 2020  t using.        
-0002b8f0: 2020 2020 2020 2020 2320 626f 746f 3320          # boto3 
-0002b900: 6469 7265 6374 6c79 2e0a 2020 2020 2020  directly..      
-0002b910: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
-0002b920: 655f 6f62 6a2e 6465 6c65 7465 2829 0a0a  e_obj.delete()..
-0002b930: 2020 2020 4070 7974 6573 742e 6669 7874      @pytest.fixt
-0002b940: 7572 650a 2020 2020 6465 6620 746d 705f  ure.    def tmp_
-0002b950: 6d75 6c74 6970 6c65 5f63 7573 746f 6d5f  multiple_custom_
-0002b960: 736f 7572 6365 5f73 746f 7261 6765 5f6f  source_storage_o
-0002b970: 626a 2873 656c 6629 3a0a 2020 2020 2020  bj(self):.      
-0002b980: 2020 2320 4372 6561 7465 7320 6120 6c69    # Creates a li
-0002b990: 7374 206f 6620 7374 6f72 6167 6520 6f62  st of storage ob
-0002b9a0: 6a65 6374 7320 7769 7468 2063 7573 746f  jects with custo
-0002b9b0: 6d20 736f 7572 6365 206e 616d 6573 2074  m source names t
-0002b9c0: 6f0a 2020 2020 2020 2020 2320 6372 6561  o.        # crea
-0002b9d0: 7465 206d 756c 7469 706c 6520 7363 7261  te multiple scra
-0002b9e0: 7463 6820 7374 6f72 6167 6573 2e0a 2020  tch storages..  
-0002b9f0: 2020 2020 2020 2320 5374 6f72 6573 2066        # Stores f
-0002ba00: 6f72 2065 6163 6820 6f62 6a65 6374 2069  or each object i
-0002ba10: 6e20 7468 6520 6c69 7374 206d 7573 7420  n the list must 
-0002ba20: 6265 2061 6464 6564 2069 6e20 7468 6520  be added in the 
-0002ba30: 7465 7374 2e0a 2020 2020 2020 2020 6375  test..        cu
-0002ba40: 7374 6f6d 5f73 6f75 7263 655f 6e61 6d65  stom_source_name
-0002ba50: 7320 3d20 5b27 2270 6174 6820 5769 7468  s = ['"path With
-0002ba60: 2053 7061 6365 7322 272c 2027 7061 7468   Spaces"', 'path
-0002ba70: 2057 6974 6820 5370 6163 6573 275d 0a20   With Spaces']. 
-0002ba80: 2020 2020 2020 2073 746f 7261 6765 5f6d         storage_m
-0002ba90: 756c 745f 6f62 6a20 3d20 5b5d 0a20 2020  ult_obj = [].   
-0002baa0: 2020 2020 2066 6f72 206e 616d 6520 696e       for name in
-0002bab0: 2063 7573 746f 6d5f 736f 7572 6365 5f6e   custom_source_n
-0002bac0: 616d 6573 3a0a 2020 2020 2020 2020 2020  ames:.          
-0002bad0: 2020 7372 635f 7061 7468 203d 206f 732e    src_path = os.
-0002bae0: 7061 7468 2e65 7870 616e 6475 7365 7228  path.expanduser(
-0002baf0: 6627 7e2f 7b6e 616d 657d 2729 0a20 2020  f'~/{name}').   
-0002bb00: 2020 2020 2020 2020 2070 6174 686c 6962           pathlib
-0002bb10: 2e50 6174 6828 7372 635f 7061 7468 292e  .Path(src_path).
-0002bb20: 6578 7061 6e64 7573 6572 2829 2e6d 6b64  expanduser().mkd
-0002bb30: 6972 2865 7869 7374 5f6f 6b3d 5472 7565  ir(exist_ok=True
-0002bb40: 290a 2020 2020 2020 2020 2020 2020 7469  ).            ti
-0002bb50: 6d65 7374 616d 7020 3d20 7374 7228 7469  mestamp = str(ti
-0002bb60: 6d65 2e74 696d 6528 2929 2e72 6570 6c61  me.time()).repla
-0002bb70: 6365 2827 2e27 2c20 2727 290a 2020 2020  ce('.', '').    
-0002bb80: 2020 2020 2020 2020 7374 6f72 655f 6f62          store_ob
-0002bb90: 6a20 3d20 7374 6f72 6167 655f 6c69 622e  j = storage_lib.
-0002bba0: 5374 6f72 6167 6528 6e61 6d65 3d66 2773  Storage(name=f's
-0002bbb0: 6b79 2d74 6573 742d 7b74 696d 6573 7461  ky-test-{timesta
-0002bbc0: 6d70 7d27 2c0a 2020 2020 2020 2020 2020  mp}',.          
-0002bbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b160: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
+0002b170: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
+0002b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b1a0: 2020 7374 6f72 6573 3d73 746f 7265 732c    stores=stores,
+0002b1b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b1d0: 2020 2020 2020 2020 2020 2070 6572 7369             persi
+0002b1e0: 7374 656e 743d 7065 7273 6973 7465 6e74  stent=persistent
+0002b1f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002b200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b210: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+0002b220: 3d6d 6f64 6529 0a20 2020 2020 2020 2079  =mode).        y
+0002b230: 6965 6c64 2073 746f 7261 6765 5f6f 626a  ield storage_obj
+0002b240: 0a20 2020 2020 2020 2068 616e 646c 6520  .        handle 
+0002b250: 3d20 676c 6f62 616c 5f75 7365 725f 7374  = global_user_st
+0002b260: 6174 652e 6765 745f 6861 6e64 6c65 5f66  ate.get_handle_f
+0002b270: 726f 6d5f 7374 6f72 6167 655f 6e61 6d65  rom_storage_name
+0002b280: 280a 2020 2020 2020 2020 2020 2020 7374  (.            st
+0002b290: 6f72 6167 655f 6f62 6a2e 6e61 6d65 290a  orage_obj.name).
+0002b2a0: 2020 2020 2020 2020 6966 2068 616e 646c          if handl
+0002b2b0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
+0002b2c0: 2049 6620 6861 6e64 6c65 2065 7869 7374   If handle exist
+0002b2d0: 732c 2064 656c 6574 6520 6d61 6e75 616c  s, delete manual
+0002b2e0: 6c79 0a20 2020 2020 2020 2020 2020 2023  ly.            #
+0002b2f0: 2054 4f44 4f28 726f 6d69 6c62 293a 2054   TODO(romilb): T
+0002b300: 6869 7320 6973 2070 6f74 656e 7469 616c  his is potential
+0002b310: 6c79 2072 6973 6b79 202d 2069 6620 7468  ly risky - if th
+0002b320: 6520 6465 6c65 7465 206d 6574 686f 6420  e delete method 
+0002b330: 6861 730a 2020 2020 2020 2020 2020 2020  has.            
+0002b340: 2320 2020 6275 6773 2c20 7468 6973 2063  #   bugs, this c
+0002b350: 616e 2063 6175 7365 2072 6573 6f75 7263  an cause resourc
+0002b360: 6520 6c65 616b 732e 2049 6465 616c 6c79  e leaks. Ideally
+0002b370: 2077 6520 7368 6f75 6c64 206d 616e 7561   we should manua
+0002b380: 6c6c 790a 2020 2020 2020 2020 2020 2020  lly.            
+0002b390: 2320 2020 656a 6563 7420 7374 6f72 6167  #   eject storag
+0002b3a0: 6520 6672 6f6d 2067 6c6f 6261 6c5f 7573  e from global_us
+0002b3b0: 6572 5f73 7461 7465 2061 6e64 2064 656c  er_state and del
+0002b3c0: 6574 6520 7468 6520 6275 636b 6574 2075  ete the bucket u
+0002b3d0: 7369 6e67 0a20 2020 2020 2020 2020 2020  sing.           
+0002b3e0: 2023 2020 2062 6f74 6f33 2064 6972 6563   #   boto3 direc
+0002b3f0: 746c 792e 0a20 2020 2020 2020 2020 2020  tly..           
+0002b400: 2073 746f 7261 6765 5f6f 626a 2e64 656c   storage_obj.del
+0002b410: 6574 6528 290a 0a20 2020 2040 7079 7465  ete()..    @pyte
+0002b420: 7374 2e66 6978 7475 7265 0a20 2020 2064  st.fixture.    d
+0002b430: 6566 2074 6d70 5f73 6372 6174 6368 5f73  ef tmp_scratch_s
+0002b440: 746f 7261 6765 5f6f 626a 2873 656c 662c  torage_obj(self,
+0002b450: 2074 6d70 5f62 7563 6b65 745f 6e61 6d65   tmp_bucket_name
+0002b460: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
+0002b470: 6174 6573 2061 2073 746f 7261 6765 206f  ates a storage o
+0002b480: 626a 6563 7420 7769 7468 206e 6f20 736f  bject with no so
+0002b490: 7572 6365 2074 6f20 6372 6561 7465 2061  urce to create a
+0002b4a0: 2073 6372 6174 6368 2073 746f 7261 6765   scratch storage
+0002b4b0: 2e0a 2020 2020 2020 2020 2320 5374 6f72  ..        # Stor
+0002b4c0: 6573 206d 7573 7420 6265 2061 6464 6564  es must be added
+0002b4d0: 2069 6e20 7468 6520 7465 7374 2e0a 2020   in the test..  
+0002b4e0: 2020 2020 2020 7969 656c 6420 6672 6f6d        yield from
+0002b4f0: 2073 656c 662e 7969 656c 645f 7374 6f72   self.yield_stor
+0002b500: 6167 655f 6f62 6a65 6374 286e 616d 653d  age_object(name=
+0002b510: 746d 705f 6275 636b 6574 5f6e 616d 6529  tmp_bucket_name)
+0002b520: 0a0a 2020 2020 4070 7974 6573 742e 6669  ..    @pytest.fi
+0002b530: 7874 7572 650a 2020 2020 6465 6620 746d  xture.    def tm
+0002b540: 705f 6d75 6c74 6970 6c65 5f73 6372 6174  p_multiple_scrat
+0002b550: 6368 5f73 746f 7261 6765 5f6f 626a 2873  ch_storage_obj(s
+0002b560: 656c 6629 3a0a 2020 2020 2020 2020 2320  elf):.        # 
+0002b570: 4372 6561 7465 7320 6120 6c69 7374 206f  Creates a list o
+0002b580: 6620 3520 7374 6f72 6167 6520 6f62 6a65  f 5 storage obje
+0002b590: 6374 7320 7769 7468 206e 6f20 736f 7572  cts with no sour
+0002b5a0: 6365 2074 6f20 6372 6561 7465 0a20 2020  ce to create.   
+0002b5b0: 2020 2020 2023 206d 756c 7469 706c 6520       # multiple 
+0002b5c0: 7363 7261 7463 6820 7374 6f72 6167 6573  scratch storages
+0002b5d0: 2e0a 2020 2020 2020 2020 2320 5374 6f72  ..        # Stor
+0002b5e0: 6573 2066 6f72 2065 6163 6820 6f62 6a65  es for each obje
+0002b5f0: 6374 2069 6e20 7468 6520 6c69 7374 206d  ct in the list m
+0002b600: 7573 7420 6265 2061 6464 6564 2069 6e20  ust be added in 
+0002b610: 7468 6520 7465 7374 2e0a 2020 2020 2020  the test..      
+0002b620: 2020 7374 6f72 6167 655f 6d75 6c74 5f6f    storage_mult_o
+0002b630: 626a 203d 205b 5d0a 2020 2020 2020 2020  bj = [].        
+0002b640: 666f 7220 5f20 696e 2072 616e 6765 2835  for _ in range(5
+0002b650: 293a 0a20 2020 2020 2020 2020 2020 2074  ):.            t
+0002b660: 696d 6573 7461 6d70 203d 2073 7472 2874  imestamp = str(t
+0002b670: 696d 652e 7469 6d65 2829 292e 7265 706c  ime.time()).repl
+0002b680: 6163 6528 272e 272c 2027 2729 0a20 2020  ace('.', '').   
+0002b690: 2020 2020 2020 2020 2073 746f 7265 5f6f           store_o
+0002b6a0: 626a 203d 2073 746f 7261 6765 5f6c 6962  bj = storage_lib
+0002b6b0: 2e53 746f 7261 6765 286e 616d 653d 6627  .Storage(name=f'
+0002b6c0: 736b 792d 7465 7374 2d7b 7469 6d65 7374  sky-test-{timest
+0002b6d0: 616d 707d 2729 0a20 2020 2020 2020 2020  amp}').         
+0002b6e0: 2020 2073 746f 7261 6765 5f6d 756c 745f     storage_mult_
+0002b6f0: 6f62 6a2e 6170 7065 6e64 2873 746f 7265  obj.append(store
+0002b700: 5f6f 626a 290a 2020 2020 2020 2020 7969  _obj).        yi
+0002b710: 656c 6420 7374 6f72 6167 655f 6d75 6c74  eld storage_mult
+0002b720: 5f6f 626a 0a20 2020 2020 2020 2066 6f72  _obj.        for
+0002b730: 2073 746f 7261 6765 5f6f 626a 2069 6e20   storage_obj in 
+0002b740: 7374 6f72 6167 655f 6d75 6c74 5f6f 626a  storage_mult_obj
+0002b750: 3a0a 2020 2020 2020 2020 2020 2020 6861  :.            ha
+0002b760: 6e64 6c65 203d 2067 6c6f 6261 6c5f 7573  ndle = global_us
+0002b770: 6572 5f73 7461 7465 2e67 6574 5f68 616e  er_state.get_han
+0002b780: 646c 655f 6672 6f6d 5f73 746f 7261 6765  dle_from_storage
+0002b790: 5f6e 616d 6528 0a20 2020 2020 2020 2020  _name(.         
+0002b7a0: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
+0002b7b0: 626a 2e6e 616d 6529 0a20 2020 2020 2020  bj.name).       
+0002b7c0: 2020 2020 2069 6620 6861 6e64 6c65 3a0a       if handle:.
+0002b7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b7e0: 2320 4966 2068 616e 646c 6520 6578 6973  # If handle exis
+0002b7f0: 7473 2c20 6465 6c65 7465 206d 616e 7561  ts, delete manua
+0002b800: 6c6c 790a 2020 2020 2020 2020 2020 2020  lly.            
+0002b810: 2020 2020 2320 544f 444f 2872 6f6d 696c      # TODO(romil
+0002b820: 6229 3a20 5468 6973 2069 7320 706f 7465  b): This is pote
+0002b830: 6e74 6961 6c6c 7920 7269 736b 7920 2d20  ntially risky - 
+0002b840: 6966 2074 6865 2064 656c 6574 6520 6d65  if the delete me
+0002b850: 7468 6f64 2068 6173 0a20 2020 2020 2020  thod has.       
+0002b860: 2020 2020 2020 2020 2023 2062 7567 732c           # bugs,
+0002b870: 2074 6869 7320 6361 6e20 6361 7573 6520   this can cause 
+0002b880: 7265 736f 7572 6365 206c 6561 6b73 2e20  resource leaks. 
+0002b890: 4964 6561 6c6c 7920 7765 2073 686f 756c  Ideally we shoul
+0002b8a0: 6420 6d61 6e75 616c 6c79 0a20 2020 2020  d manually.     
+0002b8b0: 2020 2020 2020 2020 2020 2023 2065 6a65             # eje
+0002b8c0: 6374 2073 746f 7261 6765 2066 726f 6d20  ct storage from 
+0002b8d0: 676c 6f62 616c 5f75 7365 725f 7374 6174  global_user_stat
+0002b8e0: 6520 616e 6420 6465 6c65 7465 2074 6865  e and delete the
+0002b8f0: 2062 7563 6b65 7420 7573 696e 670a 2020   bucket using.  
+0002b900: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0002b910: 626f 746f 3320 6469 7265 6374 6c79 2e0a  boto3 directly..
+0002b920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b930: 7374 6f72 6167 655f 6f62 6a2e 6465 6c65  storage_obj.dele
+0002b940: 7465 2829 0a0a 2020 2020 4070 7974 6573  te()..    @pytes
+0002b950: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
+0002b960: 6620 746d 705f 6d75 6c74 6970 6c65 5f63  f tmp_multiple_c
+0002b970: 7573 746f 6d5f 736f 7572 6365 5f73 746f  ustom_source_sto
+0002b980: 7261 6765 5f6f 626a 2873 656c 6629 3a0a  rage_obj(self):.
+0002b990: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
+0002b9a0: 7320 6120 6c69 7374 206f 6620 7374 6f72  s a list of stor
+0002b9b0: 6167 6520 6f62 6a65 6374 7320 7769 7468  age objects with
+0002b9c0: 2063 7573 746f 6d20 736f 7572 6365 206e   custom source n
+0002b9d0: 616d 6573 2074 6f0a 2020 2020 2020 2020  ames to.        
+0002b9e0: 2320 6372 6561 7465 206d 756c 7469 706c  # create multipl
+0002b9f0: 6520 7363 7261 7463 6820 7374 6f72 6167  e scratch storag
+0002ba00: 6573 2e0a 2020 2020 2020 2020 2320 5374  es..        # St
+0002ba10: 6f72 6573 2066 6f72 2065 6163 6820 6f62  ores for each ob
+0002ba20: 6a65 6374 2069 6e20 7468 6520 6c69 7374  ject in the list
+0002ba30: 206d 7573 7420 6265 2061 6464 6564 2069   must be added i
+0002ba40: 6e20 7468 6520 7465 7374 2e0a 2020 2020  n the test..    
+0002ba50: 2020 2020 6375 7374 6f6d 5f73 6f75 7263      custom_sourc
+0002ba60: 655f 6e61 6d65 7320 3d20 5b27 2270 6174  e_names = ['"pat
+0002ba70: 6820 5769 7468 2053 7061 6365 7322 272c  h With Spaces"',
+0002ba80: 2027 7061 7468 2057 6974 6820 5370 6163   'path With Spac
+0002ba90: 6573 275d 0a20 2020 2020 2020 2073 746f  es'].        sto
+0002baa0: 7261 6765 5f6d 756c 745f 6f62 6a20 3d20  rage_mult_obj = 
+0002bab0: 5b5d 0a20 2020 2020 2020 2066 6f72 206e  [].        for n
+0002bac0: 616d 6520 696e 2063 7573 746f 6d5f 736f  ame in custom_so
+0002bad0: 7572 6365 5f6e 616d 6573 3a0a 2020 2020  urce_names:.    
+0002bae0: 2020 2020 2020 2020 7372 635f 7061 7468          src_path
+0002baf0: 203d 206f 732e 7061 7468 2e65 7870 616e   = os.path.expan
+0002bb00: 6475 7365 7228 6627 7e2f 7b6e 616d 657d  duser(f'~/{name}
+0002bb10: 2729 0a20 2020 2020 2020 2020 2020 2070  ').            p
+0002bb20: 6174 686c 6962 2e50 6174 6828 7372 635f  athlib.Path(src_
+0002bb30: 7061 7468 292e 6578 7061 6e64 7573 6572  path).expanduser
+0002bb40: 2829 2e6d 6b64 6972 2865 7869 7374 5f6f  ().mkdir(exist_o
+0002bb50: 6b3d 5472 7565 290a 2020 2020 2020 2020  k=True).        
+0002bb60: 2020 2020 7469 6d65 7374 616d 7020 3d20      timestamp = 
+0002bb70: 7374 7228 7469 6d65 2e74 696d 6528 2929  str(time.time())
+0002bb80: 2e72 6570 6c61 6365 2827 2e27 2c20 2727  .replace('.', ''
+0002bb90: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
+0002bba0: 6f72 655f 6f62 6a20 3d20 7374 6f72 6167  ore_obj = storag
+0002bbb0: 655f 6c69 622e 5374 6f72 6167 6528 6e61  e_lib.Storage(na
+0002bbc0: 6d65 3d66 2773 6b79 2d74 6573 742d 7b74  me=f'sky-test-{t
+0002bbd0: 696d 6573 7461 6d70 7d27 2c0a 2020 2020  imestamp}',.    
 0002bbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bbf0: 2020 736f 7572 6365 3d73 7263 5f70 6174    source=src_pat
-0002bc00: 6829 0a20 2020 2020 2020 2020 2020 2073  h).            s
-0002bc10: 746f 7261 6765 5f6d 756c 745f 6f62 6a2e  torage_mult_obj.
-0002bc20: 6170 7065 6e64 2873 746f 7265 5f6f 626a  append(store_obj
-0002bc30: 290a 2020 2020 2020 2020 7969 656c 6420  ).        yield 
-0002bc40: 7374 6f72 6167 655f 6d75 6c74 5f6f 626a  storage_mult_obj
-0002bc50: 0a20 2020 2020 2020 2066 6f72 2073 746f  .        for sto
-0002bc60: 7261 6765 5f6f 626a 2069 6e20 7374 6f72  rage_obj in stor
-0002bc70: 6167 655f 6d75 6c74 5f6f 626a 3a0a 2020  age_mult_obj:.  
-0002bc80: 2020 2020 2020 2020 2020 6861 6e64 6c65            handle
-0002bc90: 203d 2067 6c6f 6261 6c5f 7573 6572 5f73   = global_user_s
-0002bca0: 7461 7465 2e67 6574 5f68 616e 646c 655f  tate.get_handle_
-0002bcb0: 6672 6f6d 5f73 746f 7261 6765 5f6e 616d  from_storage_nam
-0002bcc0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-0002bcd0: 2020 2073 746f 7261 6765 5f6f 626a 2e6e     storage_obj.n
-0002bce0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-0002bcf0: 2069 6620 6861 6e64 6c65 3a0a 2020 2020   if handle:.    
-0002bd00: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-0002bd10: 6167 655f 6f62 6a2e 6465 6c65 7465 2829  age_obj.delete()
-0002bd20: 0a0a 2020 2020 4070 7974 6573 742e 6669  ..    @pytest.fi
-0002bd30: 7874 7572 650a 2020 2020 6465 6620 746d  xture.    def tm
-0002bd40: 705f 6c6f 6361 6c5f 7374 6f72 6167 655f  p_local_storage_
-0002bd50: 6f62 6a28 7365 6c66 2c20 746d 705f 6275  obj(self, tmp_bu
-0002bd60: 636b 6574 5f6e 616d 652c 2074 6d70 5f73  cket_name, tmp_s
-0002bd70: 6f75 7263 6529 3a0a 2020 2020 2020 2020  ource):.        
-0002bd80: 2320 4372 6561 7465 7320 6120 7465 6d70  # Creates a temp
-0002bd90: 6f72 6172 7920 7374 6f72 6167 6520 6f62  orary storage ob
-0002bda0: 6a65 6374 2e20 5374 6f72 6573 206d 7573  ject. Stores mus
-0002bdb0: 7420 6265 2061 6464 6564 2069 6e20 7468  t be added in th
-0002bdc0: 6520 7465 7374 2e0a 2020 2020 2020 2020  e test..        
-0002bdd0: 7969 656c 6420 6672 6f6d 2073 656c 662e  yield from self.
-0002bde0: 7969 656c 645f 7374 6f72 6167 655f 6f62  yield_storage_ob
-0002bdf0: 6a65 6374 286e 616d 653d 746d 705f 6275  ject(name=tmp_bu
-0002be00: 636b 6574 5f6e 616d 652c 0a20 2020 2020  cket_name,.     
-0002be10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002be20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002be30: 2020 2020 2020 2020 736f 7572 6365 3d74          source=t
-0002be40: 6d70 5f73 6f75 7263 6529 0a0a 2020 2020  mp_source)..    
-0002be50: 4070 7974 6573 742e 6669 7874 7572 650a  @pytest.fixture.
-0002be60: 2020 2020 6465 6620 746d 705f 6c6f 6361      def tmp_loca
-0002be70: 6c5f 6c69 7374 5f73 746f 7261 6765 5f6f  l_list_storage_o
-0002be80: 626a 2873 656c 662c 2074 6d70 5f62 7563  bj(self, tmp_buc
-0002be90: 6b65 745f 6e61 6d65 2c20 746d 705f 736f  ket_name, tmp_so
-0002bea0: 7572 6365 293a 0a20 2020 2020 2020 2023  urce):.        #
-0002beb0: 2043 7265 6174 6573 2061 2074 656d 7020   Creates a temp 
-0002bec0: 7374 6f72 6167 6520 6f62 6a65 6374 2077  storage object w
-0002bed0: 6869 6368 2075 7365 7320 6120 6c69 7374  hich uses a list
-0002bee0: 206f 6620 7061 7468 7320 6173 2073 6f75   of paths as sou
-0002bef0: 7263 652e 0a20 2020 2020 2020 2023 2053  rce..        # S
-0002bf00: 746f 7265 7320 6d75 7374 2062 6520 6164  tores must be ad
-0002bf10: 6465 6420 696e 2074 6865 2074 6573 742e  ded in the test.
-0002bf20: 2041 6674 6572 2075 706c 6f61 642c 2074   After upload, t
-0002bf30: 6865 2062 7563 6b65 7420 7368 6f75 6c64  he bucket should
-0002bf40: 0a20 2020 2020 2020 2023 2068 6176 6520  .        # have 
-0002bf50: 7477 6f20 6669 6c65 7320 2d20 2f74 6d70  two files - /tmp
-0002bf60: 2d66 696c 6520 616e 6420 2f74 6d70 2d73  -file and /tmp-s
-0002bf70: 6f75 7263 652f 746d 702d 6669 6c65 0a20  ource/tmp-file. 
-0002bf80: 2020 2020 2020 206c 6973 745f 736f 7572         list_sour
-0002bf90: 6365 203d 205b 746d 705f 736f 7572 6365  ce = [tmp_source
-0002bfa0: 2c20 746d 705f 736f 7572 6365 202b 2027  , tmp_source + '
-0002bfb0: 2f74 6d70 2d66 696c 6527 5d0a 2020 2020  /tmp-file'].    
-0002bfc0: 2020 2020 7969 656c 6420 6672 6f6d 2073      yield from s
-0002bfd0: 656c 662e 7969 656c 645f 7374 6f72 6167  elf.yield_storag
-0002bfe0: 655f 6f62 6a65 6374 286e 616d 653d 746d  e_object(name=tm
-0002bff0: 705f 6275 636b 6574 5f6e 616d 652c 0a20  p_bucket_name,. 
-0002c000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c020: 2020 2020 2020 2020 2020 2020 736f 7572              sour
-0002c030: 6365 3d6c 6973 745f 736f 7572 6365 290a  ce=list_source).
-0002c040: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
-0002c050: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
-0002c060: 5f62 756c 6b5f 6465 6c5f 7374 6f72 6167  _bulk_del_storag
-0002c070: 655f 6f62 6a28 7365 6c66 2c20 746d 705f  e_obj(self, tmp_
-0002c080: 6275 636b 6574 5f6e 616d 6529 3a0a 2020  bucket_name):.  
-0002c090: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
-0002c0a0: 6120 7465 6d70 6f72 6172 7920 7374 6f72  a temporary stor
-0002c0b0: 6167 6520 6f62 6a65 6374 2066 6f72 2074  age object for t
-0002c0c0: 6573 7469 6e67 2062 756c 6b20 6465 6c65  esting bulk dele
-0002c0d0: 7469 6f6e 2e0a 2020 2020 2020 2020 2320  tion..        # 
-0002c0e0: 5374 6f72 6573 206d 7573 7420 6265 2061  Stores must be a
-0002c0f0: 6464 6564 2069 6e20 7468 6520 7465 7374  dded in the test
-0002c100: 2e0a 2020 2020 2020 2020 7769 7468 2074  ..        with t
-0002c110: 656d 7066 696c 652e 5465 6d70 6f72 6172  empfile.Temporar
-0002c120: 7944 6972 6563 746f 7279 2829 2061 7320  yDirectory() as 
-0002c130: 746d 7064 6972 3a0a 2020 2020 2020 2020  tmpdir:.        
-0002c140: 2020 2020 7375 6270 726f 6365 7373 2e63      subprocess.c
-0002c150: 6865 636b 5f6f 7574 7075 7428 6627 6d6b  heck_output(f'mk
-0002c160: 6469 7220 2d70 207b 746d 7064 6972 7d2f  dir -p {tmpdir}/
-0002c170: 666f 6c64 6572 7b7b 3030 302e 2e32 3535  folder{{000..255
-0002c180: 7d7d 272c 0a20 2020 2020 2020 2020 2020  }}',.           
-0002c190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c1a0: 2020 2020 2020 2020 2073 6865 6c6c 3d54           shell=T
-0002c1b0: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
-0002c1c0: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-0002c1d0: 6b5f 6f75 7470 7574 2866 2774 6f75 6368  k_output(f'touch
-0002c1e0: 207b 746d 7064 6972 7d2f 7465 7374 7b7b   {tmpdir}/test{{
-0002c1f0: 3030 302e 2e32 3535 7d7d 2e74 7874 272c  000..255}}.txt',
-0002c200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c220: 2020 2020 2073 6865 6c6c 3d54 7275 6529       shell=True)
-0002c230: 0a20 2020 2020 2020 2020 2020 2073 7562  .            sub
-0002c240: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
-0002c250: 7470 7574 280a 2020 2020 2020 2020 2020  tput(.          
-0002c260: 2020 2020 2020 6627 746f 7563 6820 7b74        f'touch {t
-0002c270: 6d70 6469 727d 2f66 6f6c 6465 727b 7b30  mpdir}/folder{{0
-0002c280: 3030 2e2e 3235 357d 7d2f 7465 7374 2e74  00..255}}/test.t
-0002c290: 7874 272c 2073 6865 6c6c 3d54 7275 6529  xt', shell=True)
-0002c2a0: 0a20 2020 2020 2020 2020 2020 2079 6965  .            yie
-0002c2b0: 6c64 2066 726f 6d20 7365 6c66 2e79 6965  ld from self.yie
-0002c2c0: 6c64 5f73 746f 7261 6765 5f6f 626a 6563  ld_storage_objec
-0002c2d0: 7428 6e61 6d65 3d74 6d70 5f62 7563 6b65  t(name=tmp_bucke
-0002c2e0: 745f 6e61 6d65 2c0a 2020 2020 2020 2020  t_name,.        
-0002c2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bc00: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
+0002bc10: 7263 5f70 6174 6829 0a20 2020 2020 2020  rc_path).       
+0002bc20: 2020 2020 2073 746f 7261 6765 5f6d 756c       storage_mul
+0002bc30: 745f 6f62 6a2e 6170 7065 6e64 2873 746f  t_obj.append(sto
+0002bc40: 7265 5f6f 626a 290a 2020 2020 2020 2020  re_obj).        
+0002bc50: 7969 656c 6420 7374 6f72 6167 655f 6d75  yield storage_mu
+0002bc60: 6c74 5f6f 626a 0a20 2020 2020 2020 2066  lt_obj.        f
+0002bc70: 6f72 2073 746f 7261 6765 5f6f 626a 2069  or storage_obj i
+0002bc80: 6e20 7374 6f72 6167 655f 6d75 6c74 5f6f  n storage_mult_o
+0002bc90: 626a 3a0a 2020 2020 2020 2020 2020 2020  bj:.            
+0002bca0: 6861 6e64 6c65 203d 2067 6c6f 6261 6c5f  handle = global_
+0002bcb0: 7573 6572 5f73 7461 7465 2e67 6574 5f68  user_state.get_h
+0002bcc0: 616e 646c 655f 6672 6f6d 5f73 746f 7261  andle_from_stora
+0002bcd0: 6765 5f6e 616d 6528 0a20 2020 2020 2020  ge_name(.       
+0002bce0: 2020 2020 2020 2020 2073 746f 7261 6765           storage
+0002bcf0: 5f6f 626a 2e6e 616d 6529 0a20 2020 2020  _obj.name).     
+0002bd00: 2020 2020 2020 2069 6620 6861 6e64 6c65         if handle
+0002bd10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002bd20: 2020 7374 6f72 6167 655f 6f62 6a2e 6465    storage_obj.de
+0002bd30: 6c65 7465 2829 0a0a 2020 2020 4070 7974  lete()..    @pyt
+0002bd40: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
+0002bd50: 6465 6620 746d 705f 6c6f 6361 6c5f 7374  def tmp_local_st
+0002bd60: 6f72 6167 655f 6f62 6a28 7365 6c66 2c20  orage_obj(self, 
+0002bd70: 746d 705f 6275 636b 6574 5f6e 616d 652c  tmp_bucket_name,
+0002bd80: 2074 6d70 5f73 6f75 7263 6529 3a0a 2020   tmp_source):.  
+0002bd90: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
+0002bda0: 6120 7465 6d70 6f72 6172 7920 7374 6f72  a temporary stor
+0002bdb0: 6167 6520 6f62 6a65 6374 2e20 5374 6f72  age object. Stor
+0002bdc0: 6573 206d 7573 7420 6265 2061 6464 6564  es must be added
+0002bdd0: 2069 6e20 7468 6520 7465 7374 2e0a 2020   in the test..  
+0002bde0: 2020 2020 2020 7969 656c 6420 6672 6f6d        yield from
+0002bdf0: 2073 656c 662e 7969 656c 645f 7374 6f72   self.yield_stor
+0002be00: 6167 655f 6f62 6a65 6374 286e 616d 653d  age_object(name=
+0002be10: 746d 705f 6275 636b 6574 5f6e 616d 652c  tmp_bucket_name,
+0002be20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002be30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002be40: 2020 2020 2020 2020 2020 2020 2020 736f                so
+0002be50: 7572 6365 3d74 6d70 5f73 6f75 7263 6529  urce=tmp_source)
+0002be60: 0a0a 2020 2020 4070 7974 6573 742e 6669  ..    @pytest.fi
+0002be70: 7874 7572 650a 2020 2020 6465 6620 746d  xture.    def tm
+0002be80: 705f 6c6f 6361 6c5f 6c69 7374 5f73 746f  p_local_list_sto
+0002be90: 7261 6765 5f6f 626a 2873 656c 662c 2074  rage_obj(self, t
+0002bea0: 6d70 5f62 7563 6b65 745f 6e61 6d65 2c20  mp_bucket_name, 
+0002beb0: 746d 705f 736f 7572 6365 293a 0a20 2020  tmp_source):.   
+0002bec0: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
+0002bed0: 2074 656d 7020 7374 6f72 6167 6520 6f62   temp storage ob
+0002bee0: 6a65 6374 2077 6869 6368 2075 7365 7320  ject which uses 
+0002bef0: 6120 6c69 7374 206f 6620 7061 7468 7320  a list of paths 
+0002bf00: 6173 2073 6f75 7263 652e 0a20 2020 2020  as source..     
+0002bf10: 2020 2023 2053 746f 7265 7320 6d75 7374     # Stores must
+0002bf20: 2062 6520 6164 6465 6420 696e 2074 6865   be added in the
+0002bf30: 2074 6573 742e 2041 6674 6572 2075 706c   test. After upl
+0002bf40: 6f61 642c 2074 6865 2062 7563 6b65 7420  oad, the bucket 
+0002bf50: 7368 6f75 6c64 0a20 2020 2020 2020 2023  should.        #
+0002bf60: 2068 6176 6520 7477 6f20 6669 6c65 7320   have two files 
+0002bf70: 2d20 2f74 6d70 2d66 696c 6520 616e 6420  - /tmp-file and 
+0002bf80: 2f74 6d70 2d73 6f75 7263 652f 746d 702d  /tmp-source/tmp-
+0002bf90: 6669 6c65 0a20 2020 2020 2020 206c 6973  file.        lis
+0002bfa0: 745f 736f 7572 6365 203d 205b 746d 705f  t_source = [tmp_
+0002bfb0: 736f 7572 6365 2c20 746d 705f 736f 7572  source, tmp_sour
+0002bfc0: 6365 202b 2027 2f74 6d70 2d66 696c 6527  ce + '/tmp-file'
+0002bfd0: 5d0a 2020 2020 2020 2020 7969 656c 6420  ].        yield 
+0002bfe0: 6672 6f6d 2073 656c 662e 7969 656c 645f  from self.yield_
+0002bff0: 7374 6f72 6167 655f 6f62 6a65 6374 286e  storage_object(n
+0002c000: 616d 653d 746d 705f 6275 636b 6574 5f6e  ame=tmp_bucket_n
+0002c010: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
+0002c020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c040: 2020 736f 7572 6365 3d6c 6973 745f 736f    source=list_so
+0002c050: 7572 6365 290a 0a20 2020 2040 7079 7465  urce)..    @pyte
+0002c060: 7374 2e66 6978 7475 7265 0a20 2020 2064  st.fixture.    d
+0002c070: 6566 2074 6d70 5f62 756c 6b5f 6465 6c5f  ef tmp_bulk_del_
+0002c080: 7374 6f72 6167 655f 6f62 6a28 7365 6c66  storage_obj(self
+0002c090: 2c20 746d 705f 6275 636b 6574 5f6e 616d  , tmp_bucket_nam
+0002c0a0: 6529 3a0a 2020 2020 2020 2020 2320 4372  e):.        # Cr
+0002c0b0: 6561 7465 7320 6120 7465 6d70 6f72 6172  eates a temporar
+0002c0c0: 7920 7374 6f72 6167 6520 6f62 6a65 6374  y storage object
+0002c0d0: 2066 6f72 2074 6573 7469 6e67 2062 756c   for testing bul
+0002c0e0: 6b20 6465 6c65 7469 6f6e 2e0a 2020 2020  k deletion..    
+0002c0f0: 2020 2020 2320 5374 6f72 6573 206d 7573      # Stores mus
+0002c100: 7420 6265 2061 6464 6564 2069 6e20 7468  t be added in th
+0002c110: 6520 7465 7374 2e0a 2020 2020 2020 2020  e test..        
+0002c120: 7769 7468 2074 656d 7066 696c 652e 5465  with tempfile.Te
+0002c130: 6d70 6f72 6172 7944 6972 6563 746f 7279  mporaryDirectory
+0002c140: 2829 2061 7320 746d 7064 6972 3a0a 2020  () as tmpdir:.  
+0002c150: 2020 2020 2020 2020 2020 7375 6270 726f            subpro
+0002c160: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
+0002c170: 7428 6627 6d6b 6469 7220 2d70 207b 746d  t(f'mkdir -p {tm
+0002c180: 7064 6972 7d2f 666f 6c64 6572 7b7b 3030  pdir}/folder{{00
+0002c190: 302e 2e32 3535 7d7d 272c 0a20 2020 2020  0..255}}',.     
+0002c1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c1b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0002c1c0: 6865 6c6c 3d54 7275 6529 0a20 2020 2020  hell=True).     
+0002c1d0: 2020 2020 2020 2073 7562 7072 6f63 6573         subproces
+0002c1e0: 732e 6368 6563 6b5f 6f75 7470 7574 2866  s.check_output(f
+0002c1f0: 2774 6f75 6368 207b 746d 7064 6972 7d2f  'touch {tmpdir}/
+0002c200: 7465 7374 7b7b 3030 302e 2e32 3535 7d7d  test{{000..255}}
+0002c210: 2e74 7874 272c 0a20 2020 2020 2020 2020  .txt',.         
+0002c220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c230: 2020 2020 2020 2020 2020 2073 6865 6c6c             shell
+0002c240: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
+0002c250: 2020 2073 7562 7072 6f63 6573 732e 6368     subprocess.ch
+0002c260: 6563 6b5f 6f75 7470 7574 280a 2020 2020  eck_output(.    
+0002c270: 2020 2020 2020 2020 2020 2020 6627 746f              f'to
+0002c280: 7563 6820 7b74 6d70 6469 727d 2f66 6f6c  uch {tmpdir}/fol
+0002c290: 6465 727b 7b30 3030 2e2e 3235 357d 7d2f  der{{000..255}}/
+0002c2a0: 7465 7374 2e74 7874 272c 2073 6865 6c6c  test.txt', shell
+0002c2b0: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
+0002c2c0: 2020 2079 6965 6c64 2066 726f 6d20 7365     yield from se
+0002c2d0: 6c66 2e79 6965 6c64 5f73 746f 7261 6765  lf.yield_storage
+0002c2e0: 5f6f 626a 6563 7428 6e61 6d65 3d74 6d70  _object(name=tmp
+0002c2f0: 5f62 7563 6b65 745f 6e61 6d65 2c0a 2020  _bucket_name,.  
 0002c300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c310: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
-0002c320: 746d 7064 6972 290a 0a20 2020 2040 7079  tmpdir)..    @py
-0002c330: 7465 7374 2e66 6978 7475 7265 0a20 2020  test.fixture.   
-0002c340: 2064 6566 2074 6d70 5f63 6f70 795f 6d6e   def tmp_copy_mn
-0002c350: 745f 6578 6973 7469 6e67 5f73 746f 7261  t_existing_stora
-0002c360: 6765 5f6f 626a 2873 656c 662c 2074 6d70  ge_obj(self, tmp
-0002c370: 5f73 6372 6174 6368 5f73 746f 7261 6765  _scratch_storage
-0002c380: 5f6f 626a 293a 0a20 2020 2020 2020 2023  _obj):.        #
-0002c390: 2043 7265 6174 6573 2061 2063 6f70 7920   Creates a copy 
-0002c3a0: 6d6f 756e 7420 7374 6f72 6167 6520 7768  mount storage wh
-0002c3b0: 6963 6820 7265 7573 6573 2061 6e20 6578  ich reuses an ex
-0002c3c0: 6973 7469 6e67 2073 746f 7261 6765 206f  isting storage o
-0002c3d0: 626a 6563 742e 0a20 2020 2020 2020 2074  bject..        t
-0002c3e0: 6d70 5f73 6372 6174 6368 5f73 746f 7261  mp_scratch_stora
-0002c3f0: 6765 5f6f 626a 2e61 6464 5f73 746f 7265  ge_obj.add_store
-0002c400: 2873 746f 7261 6765 5f6c 6962 2e53 746f  (storage_lib.Sto
-0002c410: 7265 5479 7065 2e53 3329 0a20 2020 2020  reType.S3).     
-0002c420: 2020 2073 746f 7261 6765 5f6e 616d 6520     storage_name 
-0002c430: 3d20 746d 705f 7363 7261 7463 685f 7374  = tmp_scratch_st
-0002c440: 6f72 6167 655f 6f62 6a2e 6e61 6d65 0a0a  orage_obj.name..
-0002c450: 2020 2020 2020 2020 2320 5472 7920 746f          # Try to
-0002c460: 2069 6e69 7469 616c 697a 6520 616e 6f74   initialize anot
-0002c470: 6865 7220 7374 6f72 6167 6520 7769 7468  her storage with
-0002c480: 2074 6865 2073 746f 7261 6765 206f 626a   the storage obj
-0002c490: 6563 7420 6372 6561 7465 640a 2020 2020  ect created.    
-0002c4a0: 2020 2020 2320 6162 6f76 652c 2062 7574      # above, but
-0002c4b0: 206e 6f77 2069 6e20 434f 5059 206d 6f64   now in COPY mod
-0002c4c0: 652e 2054 6869 7320 7368 6f75 6c64 2073  e. This should s
-0002c4d0: 7563 6365 6564 2e0a 2020 2020 2020 2020  ucceed..        
-0002c4e0: 7969 656c 6420 6672 6f6d 2073 656c 662e  yield from self.
-0002c4f0: 7969 656c 645f 7374 6f72 6167 655f 6f62  yield_storage_ob
-0002c500: 6a65 6374 286e 616d 653d 7374 6f72 6167  ject(name=storag
-0002c510: 655f 6e61 6d65 2c0a 2020 2020 2020 2020  e_name,.        
-0002c520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c320: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0002c330: 6f75 7263 653d 746d 7064 6972 290a 0a20  ource=tmpdir).. 
+0002c340: 2020 2040 7079 7465 7374 2e66 6978 7475     @pytest.fixtu
+0002c350: 7265 0a20 2020 2064 6566 2074 6d70 5f63  re.    def tmp_c
+0002c360: 6f70 795f 6d6e 745f 6578 6973 7469 6e67  opy_mnt_existing
+0002c370: 5f73 746f 7261 6765 5f6f 626a 2873 656c  _storage_obj(sel
+0002c380: 662c 2074 6d70 5f73 6372 6174 6368 5f73  f, tmp_scratch_s
+0002c390: 746f 7261 6765 5f6f 626a 293a 0a20 2020  torage_obj):.   
+0002c3a0: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
+0002c3b0: 2063 6f70 7920 6d6f 756e 7420 7374 6f72   copy mount stor
+0002c3c0: 6167 6520 7768 6963 6820 7265 7573 6573  age which reuses
+0002c3d0: 2061 6e20 6578 6973 7469 6e67 2073 746f   an existing sto
+0002c3e0: 7261 6765 206f 626a 6563 742e 0a20 2020  rage object..   
+0002c3f0: 2020 2020 2074 6d70 5f73 6372 6174 6368       tmp_scratch
+0002c400: 5f73 746f 7261 6765 5f6f 626a 2e61 6464  _storage_obj.add
+0002c410: 5f73 746f 7265 2873 746f 7261 6765 5f6c  _store(storage_l
+0002c420: 6962 2e53 746f 7265 5479 7065 2e53 3329  ib.StoreType.S3)
+0002c430: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
+0002c440: 5f6e 616d 6520 3d20 746d 705f 7363 7261  _name = tmp_scra
+0002c450: 7463 685f 7374 6f72 6167 655f 6f62 6a2e  tch_storage_obj.
+0002c460: 6e61 6d65 0a0a 2020 2020 2020 2020 2320  name..        # 
+0002c470: 5472 7920 746f 2069 6e69 7469 616c 697a  Try to initializ
+0002c480: 6520 616e 6f74 6865 7220 7374 6f72 6167  e another storag
+0002c490: 6520 7769 7468 2074 6865 2073 746f 7261  e with the stora
+0002c4a0: 6765 206f 626a 6563 7420 6372 6561 7465  ge object create
+0002c4b0: 640a 2020 2020 2020 2020 2320 6162 6f76  d.        # abov
+0002c4c0: 652c 2062 7574 206e 6f77 2069 6e20 434f  e, but now in CO
+0002c4d0: 5059 206d 6f64 652e 2054 6869 7320 7368  PY mode. This sh
+0002c4e0: 6f75 6c64 2073 7563 6365 6564 2e0a 2020  ould succeed..  
+0002c4f0: 2020 2020 2020 7969 656c 6420 6672 6f6d        yield from
+0002c500: 2073 656c 662e 7969 656c 645f 7374 6f72   self.yield_stor
+0002c510: 6167 655f 6f62 6a65 6374 286e 616d 653d  age_object(name=
+0002c520: 7374 6f72 6167 655f 6e61 6d65 2c0a 2020  storage_name,.  
 0002c530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c540: 2020 2020 206d 6f64 653d 7374 6f72 6167       mode=storag
-0002c550: 655f 6c69 622e 5374 6f72 6167 654d 6f64  e_lib.StorageMod
-0002c560: 652e 434f 5059 290a 0a20 2020 2040 7079  e.COPY)..    @py
-0002c570: 7465 7374 2e66 6978 7475 7265 0a20 2020  test.fixture.   
-0002c580: 2064 6566 2074 6d70 5f67 6974 6967 6e6f   def tmp_gitigno
-0002c590: 7265 5f73 746f 7261 6765 5f6f 626a 2873  re_storage_obj(s
-0002c5a0: 656c 662c 2074 6d70 5f62 7563 6b65 745f  elf, tmp_bucket_
-0002c5b0: 6e61 6d65 2c20 6769 7469 676e 6f72 655f  name, gitignore_
-0002c5c0: 7374 7275 6374 7572 6529 3a0a 2020 2020  structure):.    
-0002c5d0: 2020 2020 2320 4372 6561 7465 7320 6120      # Creates a 
-0002c5e0: 7465 6d70 6f72 6172 7920 7374 6f72 6167  temporary storag
-0002c5f0: 6520 6f62 6a65 6374 2066 6f72 2074 6573  e object for tes
-0002c600: 7469 6e67 202e 6769 7469 676e 6f72 6520  ting .gitignore 
-0002c610: 6669 6c74 6572 2e0a 2020 2020 2020 2020  filter..        
-0002c620: 2320 4749 5449 4749 4e4f 5245 5f53 5452  # GITIGINORE_STR
-0002c630: 5543 5455 5245 2069 7320 7265 7072 6573  UCTURE is repres
-0002c640: 656e 7469 6e67 2061 2066 696c 6520 7374  enting a file st
-0002c650: 7275 6374 7572 6520 696e 2061 2064 6963  ructure in a dic
-0002c660: 7469 6f6e 6172 790a 2020 2020 2020 2020  tionary.        
-0002c670: 2320 666f 726d 6174 2e20 4372 6561 7465  # format. Create
-0002c680: 6420 7374 6f72 6167 6520 6f62 6a65 6374  d storage object
-0002c690: 2077 696c 6c20 636f 6e74 6169 6e20 7468   will contain th
-0002c6a0: 6520 6669 6c65 2073 7472 7563 7475 7265  e file structure
-0002c6b0: 2061 6c6f 6e67 0a20 2020 2020 2020 2023   along.        #
-0002c6c0: 2077 6974 6820 2e67 6974 6967 6e6f 7265   with .gitignore
-0002c6d0: 2061 6e64 202e 6769 742f 696e 666f 2f65   and .git/info/e
-0002c6e0: 7863 6c75 6465 2066 696c 6573 2074 6f20  xclude files to 
-0002c6f0: 7465 7374 2065 7863 6c75 6465 2066 696c  test exclude fil
-0002c700: 7465 722e 0a20 2020 2020 2020 2023 2053  ter..        # S
-0002c710: 746f 7265 7320 6d75 7374 2062 6520 6164  tores must be ad
-0002c720: 6465 6420 696e 2074 6865 2074 6573 742e  ded in the test.
-0002c730: 0a20 2020 2020 2020 2077 6974 6820 7465  .        with te
-0002c740: 6d70 6669 6c65 2e54 656d 706f 7261 7279  mpfile.Temporary
-0002c750: 4469 7265 6374 6f72 7928 2920 6173 2074  Directory() as t
-0002c760: 6d70 6469 723a 0a20 2020 2020 2020 2020  mpdir:.         
-0002c770: 2020 2023 2043 7265 6174 6573 2066 696c     # Creates fil
-0002c780: 6520 7374 7275 6374 7572 6520 746f 2062  e structure to b
-0002c790: 6520 7570 6c6f 6164 6564 2069 6e20 7468  e uploaded in th
-0002c7a0: 6520 5374 6f72 6167 650a 2020 2020 2020  e Storage.      
-0002c7b0: 2020 2020 2020 7365 6c66 2e63 7265 6174        self.creat
-0002c7c0: 655f 6469 725f 7374 7275 6374 7572 6528  e_dir_structure(
-0002c7d0: 746d 7064 6972 2c20 6769 7469 676e 6f72  tmpdir, gitignor
-0002c7e0: 655f 7374 7275 6374 7572 6529 0a0a 2020  e_structure)..  
-0002c7f0: 2020 2020 2020 2020 2020 2320 4372 6561            # Crea
-0002c800: 7465 202e 6769 7469 676e 6f72 6520 616e  te .gitignore an
-0002c810: 6420 6c69 7374 2066 696c 6573 2f64 6972  d list files/dir
-0002c820: 7320 746f 2062 6520 6578 636c 7564 6564  s to be excluded
-0002c830: 2069 6e20 6974 0a20 2020 2020 2020 2020   in it.         
-0002c840: 2020 2073 6b79 7069 6c6f 745f 7061 7468     skypilot_path
-0002c850: 203d 206f 732e 7061 7468 2e64 6972 6e61   = os.path.dirna
-0002c860: 6d65 286f 732e 7061 7468 2e64 6972 6e61  me(os.path.dirna
-0002c870: 6d65 2873 6b79 2e5f 5f66 696c 655f 5f29  me(sky.__file__)
-0002c880: 290a 2020 2020 2020 2020 2020 2020 7465  ).            te
-0002c890: 6d70 5f70 6174 6820 3d20 6627 7b74 6d70  mp_path = f'{tmp
-0002c8a0: 6469 727d 2f2e 6769 7469 676e 6f72 6527  dir}/.gitignore'
-0002c8b0: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
-0002c8c0: 655f 7061 7468 203d 206f 732e 7061 7468  e_path = os.path
-0002c8d0: 2e6a 6f69 6e28 736b 7970 696c 6f74 5f70  .join(skypilot_p
-0002c8e0: 6174 682c 2027 7465 7374 732f 6769 7469  ath, 'tests/giti
-0002c8f0: 676e 6f72 655f 7465 7374 2729 0a20 2020  gnore_test').   
-0002c900: 2020 2020 2020 2020 2073 6875 7469 6c2e           shutil.
-0002c910: 636f 7079 6669 6c65 2866 696c 655f 7061  copyfile(file_pa
-0002c920: 7468 2c20 7465 6d70 5f70 6174 6829 0a0a  th, temp_path)..
-0002c930: 2020 2020 2020 2020 2020 2020 2320 4372              # Cr
-0002c940: 6561 7465 202e 6769 742f 696e 666f 2f65  eate .git/info/e
-0002c950: 7863 6c75 6465 2061 6e64 206c 6973 7420  xclude and list 
-0002c960: 6669 6c65 732f 6469 7273 2074 6f20 6265  files/dirs to be
-0002c970: 2065 7863 6c75 6465 6420 696e 2069 740a   excluded in it.
-0002c980: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
-0002c990: 5f70 6174 6820 3d20 6627 7b74 6d70 6469  _path = f'{tmpdi
-0002c9a0: 727d 2f2e 6769 742f 696e 666f 2f27 0a20  r}/.git/info/'. 
-0002c9b0: 2020 2020 2020 2020 2020 206f 732e 6d61             os.ma
-0002c9c0: 6b65 6469 7273 2874 656d 705f 7061 7468  kedirs(temp_path
-0002c9d0: 290a 2020 2020 2020 2020 2020 2020 7465  ).            te
-0002c9e0: 6d70 5f65 7863 6c75 6465 5f70 6174 6820  mp_exclude_path 
-0002c9f0: 3d20 6f73 2e70 6174 682e 6a6f 696e 2874  = os.path.join(t
-0002ca00: 656d 705f 7061 7468 2c20 2765 7863 6c75  emp_path, 'exclu
-0002ca10: 6465 2729 0a20 2020 2020 2020 2020 2020  de').           
-0002ca20: 2066 696c 655f 7061 7468 203d 206f 732e   file_path = os.
-0002ca30: 7061 7468 2e6a 6f69 6e28 736b 7970 696c  path.join(skypil
-0002ca40: 6f74 5f70 6174 682c 0a20 2020 2020 2020  ot_path,.       
-0002ca50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ca60: 2020 2020 2020 2020 2020 2020 2020 2774                't
-0002ca70: 6573 7473 2f67 6974 5f69 6e66 6f5f 6578  ests/git_info_ex
-0002ca80: 636c 7564 655f 7465 7374 2729 0a20 2020  clude_test').   
-0002ca90: 2020 2020 2020 2020 2073 6875 7469 6c2e           shutil.
-0002caa0: 636f 7079 6669 6c65 2866 696c 655f 7061  copyfile(file_pa
-0002cab0: 7468 2c20 7465 6d70 5f65 7863 6c75 6465  th, temp_exclude
-0002cac0: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
-0002cad0: 2020 2020 2320 4372 6561 7465 2073 6b79      # Create sky
-0002cae0: 2053 746f 7261 6765 2077 6974 6820 7468   Storage with th
-0002caf0: 6520 6669 6c65 7320 6372 6561 7465 640a  e files created.
-0002cb00: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
-0002cb10: 6420 6672 6f6d 2073 656c 662e 7969 656c  d from self.yiel
-0002cb20: 645f 7374 6f72 6167 655f 6f62 6a65 6374  d_storage_object
-0002cb30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0002cb40: 2020 6e61 6d65 3d74 6d70 5f62 7563 6b65    name=tmp_bucke
-0002cb50: 745f 6e61 6d65 2c0a 2020 2020 2020 2020  t_name,.        
-0002cb60: 2020 2020 2020 2020 736f 7572 6365 3d74          source=t
-0002cb70: 6d70 6469 722c 0a20 2020 2020 2020 2020  mpdir,.         
-0002cb80: 2020 2020 2020 206d 6f64 653d 7374 6f72         mode=stor
-0002cb90: 6167 655f 6c69 622e 5374 6f72 6167 654d  age_lib.StorageM
-0002cba0: 6f64 652e 434f 5059 290a 0a20 2020 2040  ode.COPY)..    @
-0002cbb0: 7079 7465 7374 2e66 6978 7475 7265 0a20  pytest.fixture. 
-0002cbc0: 2020 2064 6566 2074 6d70 5f61 7773 636c     def tmp_awscl
-0002cbd0: 695f 6275 636b 6574 2873 656c 662c 2074  i_bucket(self, t
-0002cbe0: 6d70 5f62 7563 6b65 745f 6e61 6d65 293a  mp_bucket_name):
-0002cbf0: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
-0002cc00: 6573 2061 2074 656d 706f 7261 7279 2062  es a temporary b
-0002cc10: 7563 6b65 7420 7573 696e 6720 6177 7363  ucket using awsc
-0002cc20: 6c69 0a20 2020 2020 2020 2062 7563 6b65  li.        bucke
-0002cc30: 745f 7572 6920 3d20 6627 7333 3a2f 2f7b  t_uri = f's3://{
-0002cc40: 746d 705f 6275 636b 6574 5f6e 616d 657d  tmp_bucket_name}
-0002cc50: 270a 2020 2020 2020 2020 7375 6270 726f  '.        subpro
-0002cc60: 6365 7373 2e63 6865 636b 5f63 616c 6c28  cess.check_call(
-0002cc70: 5b27 6177 7327 2c20 2773 3327 2c20 276d  ['aws', 's3', 'm
-0002cc80: 6227 2c20 6275 636b 6574 5f75 7269 5d29  b', bucket_uri])
-0002cc90: 0a20 2020 2020 2020 2079 6965 6c64 2074  .        yield t
-0002cca0: 6d70 5f62 7563 6b65 745f 6e61 6d65 2c20  mp_bucket_name, 
-0002ccb0: 6275 636b 6574 5f75 7269 0a20 2020 2020  bucket_uri.     
-0002ccc0: 2020 2073 7562 7072 6f63 6573 732e 6368     subprocess.ch
-0002ccd0: 6563 6b5f 6361 6c6c 285b 2761 7773 272c  eck_call(['aws',
-0002cce0: 2027 7333 272c 2027 7262 272c 2062 7563   's3', 'rb', buc
-0002ccf0: 6b65 745f 7572 692c 2027 2d2d 666f 7263  ket_uri, '--forc
-0002cd00: 6527 5d29 0a0a 2020 2020 4070 7974 6573  e'])..    @pytes
-0002cd10: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
-0002cd20: 6620 746d 705f 6773 7574 696c 5f62 7563  f tmp_gsutil_buc
-0002cd30: 6b65 7428 7365 6c66 2c20 746d 705f 6275  ket(self, tmp_bu
-0002cd40: 636b 6574 5f6e 616d 6529 3a0a 2020 2020  cket_name):.    
-0002cd50: 2020 2020 2320 4372 6561 7465 7320 6120      # Creates a 
-0002cd60: 7465 6d70 6f72 6172 7920 6275 636b 6574  temporary bucket
-0002cd70: 2075 7369 6e67 2067 7375 7469 6c0a 2020   using gsutil.  
-0002cd80: 2020 2020 2020 6275 636b 6574 5f75 7269        bucket_uri
-0002cd90: 203d 2066 2767 733a 2f2f 7b74 6d70 5f62   = f'gs://{tmp_b
-0002cda0: 7563 6b65 745f 6e61 6d65 7d27 0a20 2020  ucket_name}'.   
-0002cdb0: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
-0002cdc0: 6368 6563 6b5f 6361 6c6c 285b 2767 7375  check_call(['gsu
-0002cdd0: 7469 6c27 2c20 276d 6227 2c20 6275 636b  til', 'mb', buck
-0002cde0: 6574 5f75 7269 5d29 0a20 2020 2020 2020  et_uri]).       
-0002cdf0: 2079 6965 6c64 2074 6d70 5f62 7563 6b65   yield tmp_bucke
-0002ce00: 745f 6e61 6d65 2c20 6275 636b 6574 5f75  t_name, bucket_u
-0002ce10: 7269 0a20 2020 2020 2020 2073 7562 7072  ri.        subpr
-0002ce20: 6f63 6573 732e 6368 6563 6b5f 6361 6c6c  ocess.check_call
-0002ce30: 285b 2767 7375 7469 6c27 2c20 2772 6d27  (['gsutil', 'rm'
-0002ce40: 2c20 272d 7227 2c20 6275 636b 6574 5f75  , '-r', bucket_u
-0002ce50: 7269 5d29 0a0a 2020 2020 4070 7974 6573  ri])..    @pytes
-0002ce60: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
-0002ce70: 6620 746d 705f 6177 7363 6c69 5f62 7563  f tmp_awscli_buc
-0002ce80: 6b65 745f 7232 2873 656c 662c 2074 6d70  ket_r2(self, tmp
-0002ce90: 5f62 7563 6b65 745f 6e61 6d65 293a 0a20  _bucket_name):. 
-0002cea0: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
-0002ceb0: 2061 2074 656d 706f 7261 7279 2062 7563   a temporary buc
-0002cec0: 6b65 7420 7573 696e 6720 6177 7363 6c69  ket using awscli
-0002ced0: 0a20 2020 2020 2020 2065 6e64 706f 696e  .        endpoin
-0002cee0: 745f 7572 6c20 3d20 636c 6f75 6466 6c61  t_url = cloudfla
-0002cef0: 7265 2e63 7265 6174 655f 656e 6470 6f69  re.create_endpoi
-0002cf00: 6e74 2829 0a20 2020 2020 2020 2062 7563  nt().        buc
-0002cf10: 6b65 745f 7572 6920 3d20 6627 7333 3a2f  ket_uri = f's3:/
-0002cf20: 2f7b 746d 705f 6275 636b 6574 5f6e 616d  /{tmp_bucket_nam
-0002cf30: 657d 270a 2020 2020 2020 2020 7375 6270  e}'.        subp
-0002cf40: 726f 6365 7373 2e63 6865 636b 5f63 616c  rocess.check_cal
-0002cf50: 6c28 0a20 2020 2020 2020 2020 2020 2066  l(.            f
-0002cf60: 2741 5753 5f53 4841 5245 445f 4352 4544  'AWS_SHARED_CRED
-0002cf70: 454e 5449 414c 535f 4649 4c45 3d7b 636c  ENTIALS_FILE={cl
-0002cf80: 6f75 6466 6c61 7265 2e52 325f 4352 4544  oudflare.R2_CRED
-0002cf90: 454e 5449 414c 535f 5041 5448 7d20 6177  ENTIALS_PATH} aw
-0002cfa0: 7320 7333 206d 6220 7b62 7563 6b65 745f  s s3 mb {bucket_
-0002cfb0: 7572 697d 202d 2d65 6e64 706f 696e 7420  uri} --endpoint 
-0002cfc0: 7b65 6e64 706f 696e 745f 7572 6c7d 202d  {endpoint_url} -
-0002cfd0: 2d70 726f 6669 6c65 3d72 3227 2c0a 2020  -profile=r2',.  
-0002cfe0: 2020 2020 2020 2020 2020 7368 656c 6c3d            shell=
-0002cff0: 5472 7565 290a 2020 2020 2020 2020 7969  True).        yi
-0002d000: 656c 6420 746d 705f 6275 636b 6574 5f6e  eld tmp_bucket_n
-0002d010: 616d 652c 2062 7563 6b65 745f 7572 690a  ame, bucket_uri.
-0002d020: 2020 2020 2020 2020 7375 6270 726f 6365          subproce
-0002d030: 7373 2e63 6865 636b 5f63 616c 6c28 0a20  ss.check_call(. 
-0002d040: 2020 2020 2020 2020 2020 2066 2741 5753             f'AWS
-0002d050: 5f53 4841 5245 445f 4352 4544 454e 5449  _SHARED_CREDENTI
-0002d060: 414c 535f 4649 4c45 3d7b 636c 6f75 6466  ALS_FILE={cloudf
-0002d070: 6c61 7265 2e52 325f 4352 4544 454e 5449  lare.R2_CREDENTI
-0002d080: 414c 535f 5041 5448 7d20 6177 7320 7333  ALS_PATH} aws s3
-0002d090: 2072 6220 7b62 7563 6b65 745f 7572 697d   rb {bucket_uri}
-0002d0a0: 202d 2d66 6f72 6365 202d 2d65 6e64 706f   --force --endpo
-0002d0b0: 696e 7420 7b65 6e64 706f 696e 745f 7572  int {endpoint_ur
-0002d0c0: 6c7d 202d 2d70 726f 6669 6c65 3d72 3227  l} --profile=r2'
-0002d0d0: 2c0a 2020 2020 2020 2020 2020 2020 7368  ,.            sh
-0002d0e0: 656c 6c3d 5472 7565 290a 0a20 2020 2040  ell=True)..    @
-0002d0f0: 7079 7465 7374 2e66 6978 7475 7265 0a20  pytest.fixture. 
-0002d100: 2020 2064 6566 2074 6d70 5f69 626d 5f63     def tmp_ibm_c
-0002d110: 6f73 5f62 7563 6b65 7428 7365 6c66 2c20  os_bucket(self, 
-0002d120: 746d 705f 6275 636b 6574 5f6e 616d 6529  tmp_bucket_name)
-0002d130: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
-0002d140: 7465 7320 6120 7465 6d70 6f72 6172 7920  tes a temporary 
-0002d150: 6275 636b 6574 2075 7369 6e67 2049 424d  bucket using IBM
-0002d160: 2043 4f53 2041 5049 0a20 2020 2020 2020   COS API.       
-0002d170: 2073 746f 7261 6765 5f6f 626a 203d 2073   storage_obj = s
-0002d180: 746f 7261 6765 5f6c 6962 2e49 424d 436f  torage_lib.IBMCo
-0002d190: 7353 746f 7265 2873 6f75 7263 653d 2222  sStore(source=""
-0002d1a0: 2c20 6e61 6d65 3d74 6d70 5f62 7563 6b65  , name=tmp_bucke
-0002d1b0: 745f 6e61 6d65 290a 2020 2020 2020 2020  t_name).        
-0002d1c0: 7969 656c 6420 746d 705f 6275 636b 6574  yield tmp_bucket
-0002d1d0: 5f6e 616d 650a 2020 2020 2020 2020 7374  _name.        st
-0002d1e0: 6f72 6167 655f 6f62 6a2e 6465 6c65 7465  orage_obj.delete
-0002d1f0: 2829 0a0a 2020 2020 4070 7974 6573 742e  ()..    @pytest.
-0002d200: 6669 7874 7572 650a 2020 2020 6465 6620  fixture.    def 
-0002d210: 746d 705f 7075 626c 6963 5f73 746f 7261  tmp_public_stora
-0002d220: 6765 5f6f 626a 2873 656c 662c 2072 6571  ge_obj(self, req
-0002d230: 7565 7374 293a 0a20 2020 2020 2020 2023  uest):.        #
-0002d240: 2049 6e69 7469 616c 697a 6573 2061 2073   Initializes a s
-0002d250: 746f 7261 6765 206f 626a 6563 7420 7769  torage object wi
-0002d260: 7468 2061 2070 7562 6c69 6320 6275 636b  th a public buck
-0002d270: 6574 0a20 2020 2020 2020 2073 746f 7261  et.        stora
-0002d280: 6765 5f6f 626a 203d 2073 746f 7261 6765  ge_obj = storage
-0002d290: 5f6c 6962 2e53 746f 7261 6765 2873 6f75  _lib.Storage(sou
-0002d2a0: 7263 653d 7265 7175 6573 742e 7061 7261  rce=request.para
-0002d2b0: 6d29 0a20 2020 2020 2020 2079 6965 6c64  m).        yield
-0002d2c0: 2073 746f 7261 6765 5f6f 626a 0a20 2020   storage_obj.   
-0002d2d0: 2020 2020 2023 2054 6869 7320 646f 6573       # This does
-0002d2e0: 206e 6f74 2072 6571 7569 7265 2061 6e79   not require any
-0002d2f0: 2064 656c 6574 696f 6e20 6c6f 6769 6320   deletion logic 
-0002d300: 6265 6361 7573 6520 6974 2069 7320 6120  because it is a 
-0002d310: 7075 626c 6963 2062 7563 6b65 740a 2020  public bucket.  
-0002d320: 2020 2020 2020 2320 616e 6420 7368 6f75        # and shou
-0002d330: 6c64 206e 6f74 2067 6574 2061 6464 6564  ld not get added
-0002d340: 2074 6f20 676c 6f62 616c 5f75 7365 725f   to global_user_
-0002d350: 7374 6174 652e 0a0a 2020 2020 4070 7974  state...    @pyt
-0002d360: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
-0002d370: 6473 7461 636b 0a20 2020 2040 7079 7465  dstack.    @pyte
-0002d380: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
-0002d390: 697a 6528 2773 746f 7265 5f74 7970 6527  ize('store_type'
-0002d3a0: 2c20 5b0a 2020 2020 2020 2020 7374 6f72  , [.        stor
-0002d3b0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0002d3c0: 652e 5333 2c20 7374 6f72 6167 655f 6c69  e.S3, storage_li
-0002d3d0: 622e 5374 6f72 6554 7970 652e 4743 532c  b.StoreType.GCS,
-0002d3e0: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
-0002d3f0: 7061 7261 6d28 7374 6f72 6167 655f 6c69  param(storage_li
-0002d400: 622e 5374 6f72 6554 7970 652e 4942 4d2c  b.StoreType.IBM,
-0002d410: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-0002d420: 726b 2e69 626d 292c 0a20 2020 2020 2020  rk.ibm),.       
-0002d430: 2070 7974 6573 742e 7061 7261 6d28 7374   pytest.param(st
-0002d440: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0002d450: 7970 652e 5232 2c20 6d61 726b 733d 7079  ype.R2, marks=py
-0002d460: 7465 7374 2e6d 6172 6b2e 636c 6f75 6466  test.mark.cloudf
-0002d470: 6c61 7265 290a 2020 2020 5d29 0a20 2020  lare).    ]).   
-0002d480: 2064 6566 2074 6573 745f 6e65 775f 6275   def test_new_bu
-0002d490: 636b 6574 5f63 7265 6174 696f 6e5f 616e  cket_creation_an
-0002d4a0: 645f 6465 6c65 7469 6f6e 2873 656c 662c  d_deletion(self,
-0002d4b0: 2074 6d70 5f6c 6f63 616c 5f73 746f 7261   tmp_local_stora
-0002d4c0: 6765 5f6f 626a 2c0a 2020 2020 2020 2020  ge_obj,.        
-0002d4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c550: 2020 2020 2020 2020 2020 206d 6f64 653d             mode=
+0002c560: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002c570: 6167 654d 6f64 652e 434f 5059 290a 0a20  ageMode.COPY).. 
+0002c580: 2020 2040 7079 7465 7374 2e66 6978 7475     @pytest.fixtu
+0002c590: 7265 0a20 2020 2064 6566 2074 6d70 5f67  re.    def tmp_g
+0002c5a0: 6974 6967 6e6f 7265 5f73 746f 7261 6765  itignore_storage
+0002c5b0: 5f6f 626a 2873 656c 662c 2074 6d70 5f62  _obj(self, tmp_b
+0002c5c0: 7563 6b65 745f 6e61 6d65 2c20 6769 7469  ucket_name, giti
+0002c5d0: 676e 6f72 655f 7374 7275 6374 7572 6529  gnore_structure)
+0002c5e0: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
+0002c5f0: 7465 7320 6120 7465 6d70 6f72 6172 7920  tes a temporary 
+0002c600: 7374 6f72 6167 6520 6f62 6a65 6374 2066  storage object f
+0002c610: 6f72 2074 6573 7469 6e67 202e 6769 7469  or testing .giti
+0002c620: 676e 6f72 6520 6669 6c74 6572 2e0a 2020  gnore filter..  
+0002c630: 2020 2020 2020 2320 4749 5449 4749 4e4f        # GITIGINO
+0002c640: 5245 5f53 5452 5543 5455 5245 2069 7320  RE_STRUCTURE is 
+0002c650: 7265 7072 6573 656e 7469 6e67 2061 2066  representing a f
+0002c660: 696c 6520 7374 7275 6374 7572 6520 696e  ile structure in
+0002c670: 2061 2064 6963 7469 6f6e 6172 790a 2020   a dictionary.  
+0002c680: 2020 2020 2020 2320 666f 726d 6174 2e20        # format. 
+0002c690: 4372 6561 7465 6420 7374 6f72 6167 6520  Created storage 
+0002c6a0: 6f62 6a65 6374 2077 696c 6c20 636f 6e74  object will cont
+0002c6b0: 6169 6e20 7468 6520 6669 6c65 2073 7472  ain the file str
+0002c6c0: 7563 7475 7265 2061 6c6f 6e67 0a20 2020  ucture along.   
+0002c6d0: 2020 2020 2023 2077 6974 6820 2e67 6974       # with .git
+0002c6e0: 6967 6e6f 7265 2061 6e64 202e 6769 742f  ignore and .git/
+0002c6f0: 696e 666f 2f65 7863 6c75 6465 2066 696c  info/exclude fil
+0002c700: 6573 2074 6f20 7465 7374 2065 7863 6c75  es to test exclu
+0002c710: 6465 2066 696c 7465 722e 0a20 2020 2020  de filter..     
+0002c720: 2020 2023 2053 746f 7265 7320 6d75 7374     # Stores must
+0002c730: 2062 6520 6164 6465 6420 696e 2074 6865   be added in the
+0002c740: 2074 6573 742e 0a20 2020 2020 2020 2077   test..        w
+0002c750: 6974 6820 7465 6d70 6669 6c65 2e54 656d  ith tempfile.Tem
+0002c760: 706f 7261 7279 4469 7265 6374 6f72 7928  poraryDirectory(
+0002c770: 2920 6173 2074 6d70 6469 723a 0a20 2020  ) as tmpdir:.   
+0002c780: 2020 2020 2020 2020 2023 2043 7265 6174           # Creat
+0002c790: 6573 2066 696c 6520 7374 7275 6374 7572  es file structur
+0002c7a0: 6520 746f 2062 6520 7570 6c6f 6164 6564  e to be uploaded
+0002c7b0: 2069 6e20 7468 6520 5374 6f72 6167 650a   in the Storage.
+0002c7c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0002c7d0: 2e63 7265 6174 655f 6469 725f 7374 7275  .create_dir_stru
+0002c7e0: 6374 7572 6528 746d 7064 6972 2c20 6769  cture(tmpdir, gi
+0002c7f0: 7469 676e 6f72 655f 7374 7275 6374 7572  tignore_structur
+0002c800: 6529 0a0a 2020 2020 2020 2020 2020 2020  e)..            
+0002c810: 2320 4372 6561 7465 202e 6769 7469 676e  # Create .gitign
+0002c820: 6f72 6520 616e 6420 6c69 7374 2066 696c  ore and list fil
+0002c830: 6573 2f64 6972 7320 746f 2062 6520 6578  es/dirs to be ex
+0002c840: 636c 7564 6564 2069 6e20 6974 0a20 2020  cluded in it.   
+0002c850: 2020 2020 2020 2020 2073 6b79 7069 6c6f           skypilo
+0002c860: 745f 7061 7468 203d 206f 732e 7061 7468  t_path = os.path
+0002c870: 2e64 6972 6e61 6d65 286f 732e 7061 7468  .dirname(os.path
+0002c880: 2e64 6972 6e61 6d65 2873 6b79 2e5f 5f66  .dirname(sky.__f
+0002c890: 696c 655f 5f29 290a 2020 2020 2020 2020  ile__)).        
+0002c8a0: 2020 2020 7465 6d70 5f70 6174 6820 3d20      temp_path = 
+0002c8b0: 6627 7b74 6d70 6469 727d 2f2e 6769 7469  f'{tmpdir}/.giti
+0002c8c0: 676e 6f72 6527 0a20 2020 2020 2020 2020  gnore'.         
+0002c8d0: 2020 2066 696c 655f 7061 7468 203d 206f     file_path = o
+0002c8e0: 732e 7061 7468 2e6a 6f69 6e28 736b 7970  s.path.join(skyp
+0002c8f0: 696c 6f74 5f70 6174 682c 2027 7465 7374  ilot_path, 'test
+0002c900: 732f 6769 7469 676e 6f72 655f 7465 7374  s/gitignore_test
+0002c910: 2729 0a20 2020 2020 2020 2020 2020 2073  ').            s
+0002c920: 6875 7469 6c2e 636f 7079 6669 6c65 2866  hutil.copyfile(f
+0002c930: 696c 655f 7061 7468 2c20 7465 6d70 5f70  ile_path, temp_p
+0002c940: 6174 6829 0a0a 2020 2020 2020 2020 2020  ath)..          
+0002c950: 2020 2320 4372 6561 7465 202e 6769 742f    # Create .git/
+0002c960: 696e 666f 2f65 7863 6c75 6465 2061 6e64  info/exclude and
+0002c970: 206c 6973 7420 6669 6c65 732f 6469 7273   list files/dirs
+0002c980: 2074 6f20 6265 2065 7863 6c75 6465 6420   to be excluded 
+0002c990: 696e 2069 740a 2020 2020 2020 2020 2020  in it.          
+0002c9a0: 2020 7465 6d70 5f70 6174 6820 3d20 6627    temp_path = f'
+0002c9b0: 7b74 6d70 6469 727d 2f2e 6769 742f 696e  {tmpdir}/.git/in
+0002c9c0: 666f 2f27 0a20 2020 2020 2020 2020 2020  fo/'.           
+0002c9d0: 206f 732e 6d61 6b65 6469 7273 2874 656d   os.makedirs(tem
+0002c9e0: 705f 7061 7468 290a 2020 2020 2020 2020  p_path).        
+0002c9f0: 2020 2020 7465 6d70 5f65 7863 6c75 6465      temp_exclude
+0002ca00: 5f70 6174 6820 3d20 6f73 2e70 6174 682e  _path = os.path.
+0002ca10: 6a6f 696e 2874 656d 705f 7061 7468 2c20  join(temp_path, 
+0002ca20: 2765 7863 6c75 6465 2729 0a20 2020 2020  'exclude').     
+0002ca30: 2020 2020 2020 2066 696c 655f 7061 7468         file_path
+0002ca40: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
+0002ca50: 736b 7970 696c 6f74 5f70 6174 682c 0a20  skypilot_path,. 
+0002ca60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ca70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ca80: 2020 2020 2774 6573 7473 2f67 6974 5f69      'tests/git_i
+0002ca90: 6e66 6f5f 6578 636c 7564 655f 7465 7374  nfo_exclude_test
+0002caa0: 2729 0a20 2020 2020 2020 2020 2020 2073  ').            s
+0002cab0: 6875 7469 6c2e 636f 7079 6669 6c65 2866  hutil.copyfile(f
+0002cac0: 696c 655f 7061 7468 2c20 7465 6d70 5f65  ile_path, temp_e
+0002cad0: 7863 6c75 6465 5f70 6174 6829 0a0a 2020  xclude_path)..  
+0002cae0: 2020 2020 2020 2020 2020 2320 4372 6561            # Crea
+0002caf0: 7465 2073 6b79 2053 746f 7261 6765 2077  te sky Storage w
+0002cb00: 6974 6820 7468 6520 6669 6c65 7320 6372  ith the files cr
+0002cb10: 6561 7465 640a 2020 2020 2020 2020 2020  eated.          
+0002cb20: 2020 7969 656c 6420 6672 6f6d 2073 656c    yield from sel
+0002cb30: 662e 7969 656c 645f 7374 6f72 6167 655f  f.yield_storage_
+0002cb40: 6f62 6a65 6374 280a 2020 2020 2020 2020  object(.        
+0002cb50: 2020 2020 2020 2020 6e61 6d65 3d74 6d70          name=tmp
+0002cb60: 5f62 7563 6b65 745f 6e61 6d65 2c0a 2020  _bucket_name,.  
+0002cb70: 2020 2020 2020 2020 2020 2020 2020 736f                so
+0002cb80: 7572 6365 3d74 6d70 6469 722c 0a20 2020  urce=tmpdir,.   
+0002cb90: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
+0002cba0: 653d 7374 6f72 6167 655f 6c69 622e 5374  e=storage_lib.St
+0002cbb0: 6f72 6167 654d 6f64 652e 434f 5059 290a  orageMode.COPY).
+0002cbc0: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
+0002cbd0: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
+0002cbe0: 5f61 7773 636c 695f 6275 636b 6574 2873  _awscli_bucket(s
+0002cbf0: 656c 662c 2074 6d70 5f62 7563 6b65 745f  elf, tmp_bucket_
+0002cc00: 6e61 6d65 293a 0a20 2020 2020 2020 2023  name):.        #
+0002cc10: 2043 7265 6174 6573 2061 2074 656d 706f   Creates a tempo
+0002cc20: 7261 7279 2062 7563 6b65 7420 7573 696e  rary bucket usin
+0002cc30: 6720 6177 7363 6c69 0a20 2020 2020 2020  g awscli.       
+0002cc40: 2062 7563 6b65 745f 7572 6920 3d20 6627   bucket_uri = f'
+0002cc50: 7333 3a2f 2f7b 746d 705f 6275 636b 6574  s3://{tmp_bucket
+0002cc60: 5f6e 616d 657d 270a 2020 2020 2020 2020  _name}'.        
+0002cc70: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+0002cc80: 5f63 616c 6c28 5b27 6177 7327 2c20 2773  _call(['aws', 's
+0002cc90: 3327 2c20 276d 6227 2c20 6275 636b 6574  3', 'mb', bucket
+0002cca0: 5f75 7269 5d29 0a20 2020 2020 2020 2079  _uri]).        y
+0002ccb0: 6965 6c64 2074 6d70 5f62 7563 6b65 745f  ield tmp_bucket_
+0002ccc0: 6e61 6d65 2c20 6275 636b 6574 5f75 7269  name, bucket_uri
+0002ccd0: 0a20 2020 2020 2020 2073 7562 7072 6f63  .        subproc
+0002cce0: 6573 732e 6368 6563 6b5f 6361 6c6c 285b  ess.check_call([
+0002ccf0: 2761 7773 272c 2027 7333 272c 2027 7262  'aws', 's3', 'rb
+0002cd00: 272c 2062 7563 6b65 745f 7572 692c 2027  ', bucket_uri, '
+0002cd10: 2d2d 666f 7263 6527 5d29 0a0a 2020 2020  --force'])..    
+0002cd20: 4070 7974 6573 742e 6669 7874 7572 650a  @pytest.fixture.
+0002cd30: 2020 2020 6465 6620 746d 705f 6773 7574      def tmp_gsut
+0002cd40: 696c 5f62 7563 6b65 7428 7365 6c66 2c20  il_bucket(self, 
+0002cd50: 746d 705f 6275 636b 6574 5f6e 616d 6529  tmp_bucket_name)
+0002cd60: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
+0002cd70: 7465 7320 6120 7465 6d70 6f72 6172 7920  tes a temporary 
+0002cd80: 6275 636b 6574 2075 7369 6e67 2067 7375  bucket using gsu
+0002cd90: 7469 6c0a 2020 2020 2020 2020 6275 636b  til.        buck
+0002cda0: 6574 5f75 7269 203d 2066 2767 733a 2f2f  et_uri = f'gs://
+0002cdb0: 7b74 6d70 5f62 7563 6b65 745f 6e61 6d65  {tmp_bucket_name
+0002cdc0: 7d27 0a20 2020 2020 2020 2073 7562 7072  }'.        subpr
+0002cdd0: 6f63 6573 732e 6368 6563 6b5f 6361 6c6c  ocess.check_call
+0002cde0: 285b 2767 7375 7469 6c27 2c20 276d 6227  (['gsutil', 'mb'
+0002cdf0: 2c20 6275 636b 6574 5f75 7269 5d29 0a20  , bucket_uri]). 
+0002ce00: 2020 2020 2020 2079 6965 6c64 2074 6d70         yield tmp
+0002ce10: 5f62 7563 6b65 745f 6e61 6d65 2c20 6275  _bucket_name, bu
+0002ce20: 636b 6574 5f75 7269 0a20 2020 2020 2020  cket_uri.       
+0002ce30: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+0002ce40: 6b5f 6361 6c6c 285b 2767 7375 7469 6c27  k_call(['gsutil'
+0002ce50: 2c20 2772 6d27 2c20 272d 7227 2c20 6275  , 'rm', '-r', bu
+0002ce60: 636b 6574 5f75 7269 5d29 0a0a 2020 2020  cket_uri])..    
+0002ce70: 4070 7974 6573 742e 6669 7874 7572 650a  @pytest.fixture.
+0002ce80: 2020 2020 6465 6620 746d 705f 6177 7363      def tmp_awsc
+0002ce90: 6c69 5f62 7563 6b65 745f 7232 2873 656c  li_bucket_r2(sel
+0002cea0: 662c 2074 6d70 5f62 7563 6b65 745f 6e61  f, tmp_bucket_na
+0002ceb0: 6d65 293a 0a20 2020 2020 2020 2023 2043  me):.        # C
+0002cec0: 7265 6174 6573 2061 2074 656d 706f 7261  reates a tempora
+0002ced0: 7279 2062 7563 6b65 7420 7573 696e 6720  ry bucket using 
+0002cee0: 6177 7363 6c69 0a20 2020 2020 2020 2065  awscli.        e
+0002cef0: 6e64 706f 696e 745f 7572 6c20 3d20 636c  ndpoint_url = cl
+0002cf00: 6f75 6466 6c61 7265 2e63 7265 6174 655f  oudflare.create_
+0002cf10: 656e 6470 6f69 6e74 2829 0a20 2020 2020  endpoint().     
+0002cf20: 2020 2062 7563 6b65 745f 7572 6920 3d20     bucket_uri = 
+0002cf30: 6627 7333 3a2f 2f7b 746d 705f 6275 636b  f's3://{tmp_buck
+0002cf40: 6574 5f6e 616d 657d 270a 2020 2020 2020  et_name}'.      
+0002cf50: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
+0002cf60: 636b 5f63 616c 6c28 0a20 2020 2020 2020  ck_call(.       
+0002cf70: 2020 2020 2066 2741 5753 5f53 4841 5245       f'AWS_SHARE
+0002cf80: 445f 4352 4544 454e 5449 414c 535f 4649  D_CREDENTIALS_FI
+0002cf90: 4c45 3d7b 636c 6f75 6466 6c61 7265 2e52  LE={cloudflare.R
+0002cfa0: 325f 4352 4544 454e 5449 414c 535f 5041  2_CREDENTIALS_PA
+0002cfb0: 5448 7d20 6177 7320 7333 206d 6220 7b62  TH} aws s3 mb {b
+0002cfc0: 7563 6b65 745f 7572 697d 202d 2d65 6e64  ucket_uri} --end
+0002cfd0: 706f 696e 7420 7b65 6e64 706f 696e 745f  point {endpoint_
+0002cfe0: 7572 6c7d 202d 2d70 726f 6669 6c65 3d72  url} --profile=r
+0002cff0: 3227 2c0a 2020 2020 2020 2020 2020 2020  2',.            
+0002d000: 7368 656c 6c3d 5472 7565 290a 2020 2020  shell=True).    
+0002d010: 2020 2020 7969 656c 6420 746d 705f 6275      yield tmp_bu
+0002d020: 636b 6574 5f6e 616d 652c 2062 7563 6b65  cket_name, bucke
+0002d030: 745f 7572 690a 2020 2020 2020 2020 7375  t_uri.        su
+0002d040: 6270 726f 6365 7373 2e63 6865 636b 5f63  bprocess.check_c
+0002d050: 616c 6c28 0a20 2020 2020 2020 2020 2020  all(.           
+0002d060: 2066 2741 5753 5f53 4841 5245 445f 4352   f'AWS_SHARED_CR
+0002d070: 4544 454e 5449 414c 535f 4649 4c45 3d7b  EDENTIALS_FILE={
+0002d080: 636c 6f75 6466 6c61 7265 2e52 325f 4352  cloudflare.R2_CR
+0002d090: 4544 454e 5449 414c 535f 5041 5448 7d20  EDENTIALS_PATH} 
+0002d0a0: 6177 7320 7333 2072 6220 7b62 7563 6b65  aws s3 rb {bucke
+0002d0b0: 745f 7572 697d 202d 2d66 6f72 6365 202d  t_uri} --force -
+0002d0c0: 2d65 6e64 706f 696e 7420 7b65 6e64 706f  -endpoint {endpo
+0002d0d0: 696e 745f 7572 6c7d 202d 2d70 726f 6669  int_url} --profi
+0002d0e0: 6c65 3d72 3227 2c0a 2020 2020 2020 2020  le=r2',.        
+0002d0f0: 2020 2020 7368 656c 6c3d 5472 7565 290a      shell=True).
+0002d100: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
+0002d110: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
+0002d120: 5f69 626d 5f63 6f73 5f62 7563 6b65 7428  _ibm_cos_bucket(
+0002d130: 7365 6c66 2c20 746d 705f 6275 636b 6574  self, tmp_bucket
+0002d140: 5f6e 616d 6529 3a0a 2020 2020 2020 2020  _name):.        
+0002d150: 2320 4372 6561 7465 7320 6120 7465 6d70  # Creates a temp
+0002d160: 6f72 6172 7920 6275 636b 6574 2075 7369  orary bucket usi
+0002d170: 6e67 2049 424d 2043 4f53 2041 5049 0a20  ng IBM COS API. 
+0002d180: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
+0002d190: 626a 203d 2073 746f 7261 6765 5f6c 6962  bj = storage_lib
+0002d1a0: 2e49 424d 436f 7353 746f 7265 2873 6f75  .IBMCosStore(sou
+0002d1b0: 7263 653d 2222 2c20 6e61 6d65 3d74 6d70  rce="", name=tmp
+0002d1c0: 5f62 7563 6b65 745f 6e61 6d65 290a 2020  _bucket_name).  
+0002d1d0: 2020 2020 2020 7969 656c 6420 746d 705f        yield tmp_
+0002d1e0: 6275 636b 6574 5f6e 616d 650a 2020 2020  bucket_name.    
+0002d1f0: 2020 2020 7374 6f72 6167 655f 6f62 6a2e      storage_obj.
+0002d200: 6465 6c65 7465 2829 0a0a 2020 2020 4070  delete()..    @p
+0002d210: 7974 6573 742e 6669 7874 7572 650a 2020  ytest.fixture.  
+0002d220: 2020 6465 6620 746d 705f 7075 626c 6963    def tmp_public
+0002d230: 5f73 746f 7261 6765 5f6f 626a 2873 656c  _storage_obj(sel
+0002d240: 662c 2072 6571 7565 7374 293a 0a20 2020  f, request):.   
+0002d250: 2020 2020 2023 2049 6e69 7469 616c 697a       # Initializ
+0002d260: 6573 2061 2073 746f 7261 6765 206f 626a  es a storage obj
+0002d270: 6563 7420 7769 7468 2061 2070 7562 6c69  ect with a publi
+0002d280: 6320 6275 636b 6574 0a20 2020 2020 2020  c bucket.       
+0002d290: 2073 746f 7261 6765 5f6f 626a 203d 2073   storage_obj = s
+0002d2a0: 746f 7261 6765 5f6c 6962 2e53 746f 7261  torage_lib.Stora
+0002d2b0: 6765 2873 6f75 7263 653d 7265 7175 6573  ge(source=reques
+0002d2c0: 742e 7061 7261 6d29 0a20 2020 2020 2020  t.param).       
+0002d2d0: 2079 6965 6c64 2073 746f 7261 6765 5f6f   yield storage_o
+0002d2e0: 626a 0a20 2020 2020 2020 2023 2054 6869  bj.        # Thi
+0002d2f0: 7320 646f 6573 206e 6f74 2072 6571 7569  s does not requi
+0002d300: 7265 2061 6e79 2064 656c 6574 696f 6e20  re any deletion 
+0002d310: 6c6f 6769 6320 6265 6361 7573 6520 6974  logic because it
+0002d320: 2069 7320 6120 7075 626c 6963 2062 7563   is a public buc
+0002d330: 6b65 740a 2020 2020 2020 2020 2320 616e  ket.        # an
+0002d340: 6420 7368 6f75 6c64 206e 6f74 2067 6574  d should not get
+0002d350: 2061 6464 6564 2074 6f20 676c 6f62 616c   added to global
+0002d360: 5f75 7365 725f 7374 6174 652e 0a0a 2020  _user_state...  
+0002d370: 2020 4070 7974 6573 742e 6d61 726b 2e6e    @pytest.mark.n
+0002d380: 6f5f 666c 7569 6473 7461 636b 0a20 2020  o_fluidstack.   
+0002d390: 2040 7079 7465 7374 2e6d 6172 6b2e 7061   @pytest.mark.pa
+0002d3a0: 7261 6d65 7472 697a 6528 2773 746f 7265  rametrize('store
+0002d3b0: 5f74 7970 6527 2c20 5b0a 2020 2020 2020  _type', [.      
+0002d3c0: 2020 7374 6f72 6167 655f 6c69 622e 5374    storage_lib.St
+0002d3d0: 6f72 6554 7970 652e 5333 2c20 7374 6f72  oreType.S3, stor
+0002d3e0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0002d3f0: 652e 4743 532c 0a20 2020 2020 2020 2070  e.GCS,.        p
+0002d400: 7974 6573 742e 7061 7261 6d28 7374 6f72  ytest.param(stor
+0002d410: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0002d420: 652e 4942 4d2c 206d 6172 6b73 3d70 7974  e.IBM, marks=pyt
+0002d430: 6573 742e 6d61 726b 2e69 626d 292c 0a20  est.mark.ibm),. 
+0002d440: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
+0002d450: 7261 6d28 7374 6f72 6167 655f 6c69 622e  ram(storage_lib.
+0002d460: 5374 6f72 6554 7970 652e 5232 2c20 6d61  StoreType.R2, ma
+0002d470: 726b 733d 7079 7465 7374 2e6d 6172 6b2e  rks=pytest.mark.
+0002d480: 636c 6f75 6466 6c61 7265 290a 2020 2020  cloudflare).    
+0002d490: 5d29 0a20 2020 2064 6566 2074 6573 745f  ]).    def test_
+0002d4a0: 6e65 775f 6275 636b 6574 5f63 7265 6174  new_bucket_creat
+0002d4b0: 696f 6e5f 616e 645f 6465 6c65 7469 6f6e  ion_and_deletion
+0002d4c0: 2873 656c 662c 2074 6d70 5f6c 6f63 616c  (self, tmp_local
+0002d4d0: 5f73 746f 7261 6765 5f6f 626a 2c0a 2020  _storage_obj,.  
 0002d4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d4f0: 2020 2020 2020 7374 6f72 655f 7479 7065        store_type
-0002d500: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
-0002d510: 6174 6573 2061 206e 6577 2062 7563 6b65  ates a new bucke
-0002d520: 7420 7769 7468 2061 206c 6f63 616c 2073  t with a local s
-0002d530: 6f75 7263 652c 2075 706c 6f61 6473 2066  ource, uploads f
-0002d540: 696c 6573 2074 6f20 6974 0a20 2020 2020  iles to it.     
-0002d550: 2020 2023 2061 6e64 2064 656c 6574 6573     # and deletes
-0002d560: 2069 742e 0a20 2020 2020 2020 2074 6d70   it..        tmp
-0002d570: 5f6c 6f63 616c 5f73 746f 7261 6765 5f6f  _local_storage_o
-0002d580: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
-0002d590: 7265 5f74 7970 6529 0a0a 2020 2020 2020  re_type)..      
-0002d5a0: 2020 2320 5275 6e20 736b 7920 7374 6f72    # Run sky stor
-0002d5b0: 6167 6520 6c73 2074 6f20 6368 6563 6b20  age ls to check 
-0002d5c0: 6966 2073 746f 7261 6765 206f 626a 6563  if storage objec
-0002d5d0: 7420 6578 6973 7473 2069 6e20 7468 6520  t exists in the 
-0002d5e0: 6f75 7470 7574 0a20 2020 2020 2020 206f  output.        o
-0002d5f0: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
-0002d600: 6368 6563 6b5f 6f75 7470 7574 285b 2773  check_output(['s
-0002d610: 6b79 272c 2027 7374 6f72 6167 6527 2c20  ky', 'storage', 
-0002d620: 276c 7327 5d29 0a20 2020 2020 2020 2061  'ls']).        a
-0002d630: 7373 6572 7420 746d 705f 6c6f 6361 6c5f  ssert tmp_local_
-0002d640: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
-0002d650: 2069 6e20 6f75 742e 6465 636f 6465 2827   in out.decode('
-0002d660: 7574 662d 3827 290a 0a20 2020 2020 2020  utf-8')..       
-0002d670: 2023 2052 756e 2073 6b79 2073 746f 7261   # Run sky stora
-0002d680: 6765 2064 656c 6574 6520 746f 2064 656c  ge delete to del
-0002d690: 6574 6520 7468 6520 7374 6f72 6167 6520  ete the storage 
-0002d6a0: 6f62 6a65 6374 0a20 2020 2020 2020 2073  object.        s
-0002d6b0: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-0002d6c0: 6f75 7470 7574 280a 2020 2020 2020 2020  output(.        
-0002d6d0: 2020 2020 5b27 736b 7927 2c20 2773 746f      ['sky', 'sto
-0002d6e0: 7261 6765 272c 2027 6465 6c65 7465 272c  rage', 'delete',
-0002d6f0: 2074 6d70 5f6c 6f63 616c 5f73 746f 7261   tmp_local_stora
-0002d700: 6765 5f6f 626a 2e6e 616d 652c 2027 2d2d  ge_obj.name, '--
-0002d710: 7965 7327 5d29 0a0a 2020 2020 2020 2020  yes'])..        
-0002d720: 2320 5275 6e20 736b 7920 7374 6f72 6167  # Run sky storag
-0002d730: 6520 6c73 2074 6f20 6368 6563 6b20 6966  e ls to check if
-0002d740: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
-0002d750: 6973 2064 656c 6574 6564 0a20 2020 2020  is deleted.     
-0002d760: 2020 206f 7574 203d 2073 7562 7072 6f63     out = subproc
-0002d770: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
-0002d780: 285b 2773 6b79 272c 2027 7374 6f72 6167  (['sky', 'storag
-0002d790: 6527 2c20 276c 7327 5d29 0a20 2020 2020  e', 'ls']).     
-0002d7a0: 2020 2061 7373 6572 7420 746d 705f 6c6f     assert tmp_lo
-0002d7b0: 6361 6c5f 7374 6f72 6167 655f 6f62 6a2e  cal_storage_obj.
-0002d7c0: 6e61 6d65 206e 6f74 2069 6e20 6f75 742e  name not in out.
-0002d7d0: 6465 636f 6465 2827 7574 662d 3827 290a  decode('utf-8').
-0002d7e0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0002d7f0: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b0a  k.no_fluidstack.
-0002d800: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
-0002d810: 2e78 6469 7374 5f67 726f 7570 2827 6d75  .xdist_group('mu
-0002d820: 6c74 6970 6c65 5f62 7563 6b65 745f 6465  ltiple_bucket_de
-0002d830: 6c65 7469 6f6e 2729 0a20 2020 2040 7079  letion').    @py
-0002d840: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
-0002d850: 7472 697a 6528 2773 746f 7265 5f74 7970  trize('store_typ
-0002d860: 6527 2c20 5b0a 2020 2020 2020 2020 7374  e', [.        st
-0002d870: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0002d880: 7970 652e 5333 2c20 7374 6f72 6167 655f  ype.S3, storage_
-0002d890: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
-0002d8a0: 532c 0a20 2020 2020 2020 2070 7974 6573  S,.        pytes
-0002d8b0: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
-0002d8c0: 6c69 622e 5374 6f72 6554 7970 652e 5232  lib.StoreType.R2
-0002d8d0: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
-0002d8e0: 6172 6b2e 636c 6f75 6466 6c61 7265 292c  ark.cloudflare),
-0002d8f0: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
-0002d900: 7061 7261 6d28 7374 6f72 6167 655f 6c69  param(storage_li
-0002d910: 622e 5374 6f72 6554 7970 652e 4942 4d2c  b.StoreType.IBM,
-0002d920: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-0002d930: 726b 2e69 626d 290a 2020 2020 5d29 0a20  rk.ibm).    ]). 
-0002d940: 2020 2064 6566 2074 6573 745f 6d75 6c74     def test_mult
-0002d950: 6970 6c65 5f62 7563 6b65 7473 5f63 7265  iple_buckets_cre
-0002d960: 6174 696f 6e5f 616e 645f 6465 6c65 7469  ation_and_deleti
-0002d970: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
-0002d980: 7365 6c66 2c20 746d 705f 6d75 6c74 6970  self, tmp_multip
-0002d990: 6c65 5f73 6372 6174 6368 5f73 746f 7261  le_scratch_stora
-0002d9a0: 6765 5f6f 626a 2c20 7374 6f72 655f 7479  ge_obj, store_ty
-0002d9b0: 7065 293a 0a20 2020 2020 2020 2023 2043  pe):.        # C
-0002d9c0: 7265 6174 6573 206d 756c 7469 706c 6520  reates multiple 
-0002d9d0: 6e65 7720 6275 636b 6574 7328 3520 6275  new buckets(5 bu
-0002d9e0: 636b 6574 7329 2077 6974 6820 6120 6c6f  ckets) with a lo
-0002d9f0: 6361 6c20 736f 7572 6365 0a20 2020 2020  cal source.     
-0002da00: 2020 2023 2061 6e64 2064 656c 6574 6573     # and deletes
-0002da10: 2074 6865 6d2e 0a20 2020 2020 2020 2073   them..        s
-0002da20: 746f 7261 6765 5f6f 626a 5f6e 616d 6520  torage_obj_name 
-0002da30: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
-0002da40: 2073 746f 7265 5f6f 626a 2069 6e20 746d   store_obj in tm
-0002da50: 705f 6d75 6c74 6970 6c65 5f73 6372 6174  p_multiple_scrat
-0002da60: 6368 5f73 746f 7261 6765 5f6f 626a 3a0a  ch_storage_obj:.
-0002da70: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-0002da80: 655f 6f62 6a2e 6164 645f 7374 6f72 6528  e_obj.add_store(
-0002da90: 7374 6f72 655f 7479 7065 290a 2020 2020  store_type).    
-0002daa0: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-0002dab0: 6f62 6a5f 6e61 6d65 2e61 7070 656e 6428  obj_name.append(
-0002dac0: 7374 6f72 655f 6f62 6a2e 6e61 6d65 290a  store_obj.name).
-0002dad0: 0a20 2020 2020 2020 2023 2052 756e 2073  .        # Run s
-0002dae0: 6b79 2073 746f 7261 6765 206c 7320 746f  ky storage ls to
-0002daf0: 2063 6865 636b 2069 6620 616c 6c20 7374   check if all st
-0002db00: 6f72 6167 6520 6f62 6a65 6374 7320 6578  orage objects ex
-0002db10: 6973 7473 2069 6e20 7468 650a 2020 2020  ists in the.    
-0002db20: 2020 2020 2320 6f75 7470 7574 2066 696c      # output fil
-0002db30: 7465 7265 6420 6279 2073 746f 7265 2074  tered by store t
-0002db40: 7970 650a 2020 2020 2020 2020 6f75 745f  ype.        out_
-0002db50: 616c 6c20 3d20 7375 6270 726f 6365 7373  all = subprocess
-0002db60: 2e63 6865 636b 5f6f 7574 7075 7428 5b27  .check_output(['
-0002db70: 736b 7927 2c20 2773 746f 7261 6765 272c  sky', 'storage',
-0002db80: 2027 6c73 275d 290a 2020 2020 2020 2020   'ls']).        
-0002db90: 6f75 7420 3d20 5b0a 2020 2020 2020 2020  out = [.        
-0002dba0: 2020 2020 6974 656d 2e73 706c 6974 2829      item.split()
-0002dbb0: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-0002dbc0: 666f 7220 6974 656d 2069 6e20 6f75 745f  for item in out_
-0002dbd0: 616c 6c2e 6465 636f 6465 2827 7574 662d  all.decode('utf-
-0002dbe0: 3827 292e 7370 6c69 746c 696e 6573 2829  8').splitlines()
-0002dbf0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002dc00: 7374 6f72 655f 7479 7065 2e76 616c 7565  store_type.value
-0002dc10: 2069 6e20 6974 656d 0a20 2020 2020 2020   in item.       
-0002dc20: 205d 0a20 2020 2020 2020 2061 7373 6572   ].        asser
-0002dc30: 7420 616c 6c28 5b69 7465 6d20 696e 206f  t all([item in o
-0002dc40: 7574 2066 6f72 2069 7465 6d20 696e 2073  ut for item in s
-0002dc50: 746f 7261 6765 5f6f 626a 5f6e 616d 655d  torage_obj_name]
-0002dc60: 290a 0a20 2020 2020 2020 2023 2052 756e  )..        # Run
-0002dc70: 2073 6b79 2073 746f 7261 6765 2064 656c   sky storage del
-0002dc80: 6574 6520 616c 6c20 746f 2064 656c 6574  ete all to delet
-0002dc90: 6520 616c 6c20 7374 6f72 6167 6520 6f62  e all storage ob
-0002dca0: 6a65 6374 730a 2020 2020 2020 2020 6465  jects.        de
-0002dcb0: 6c65 7465 5f63 6d64 203d 205b 2773 6b79  lete_cmd = ['sky
-0002dcc0: 272c 2027 7374 6f72 6167 6527 2c20 2764  ', 'storage', 'd
-0002dcd0: 656c 6574 6527 2c20 272d 2d79 6573 275d  elete', '--yes']
-0002dce0: 0a20 2020 2020 2020 2064 656c 6574 655f  .        delete_
-0002dcf0: 636d 6420 2b3d 2073 746f 7261 6765 5f6f  cmd += storage_o
-0002dd00: 626a 5f6e 616d 650a 2020 2020 2020 2020  bj_name.        
-0002dd10: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
-0002dd20: 5f6f 7574 7075 7428 6465 6c65 7465 5f63  _output(delete_c
-0002dd30: 6d64 290a 0a20 2020 2020 2020 2023 2052  md)..        # R
-0002dd40: 756e 2073 6b79 2073 746f 7261 6765 206c  un sky storage l
-0002dd50: 7320 746f 2063 6865 636b 2069 6620 616c  s to check if al
-0002dd60: 6c20 7374 6f72 6167 6520 6f62 6a65 6374  l storage object
-0002dd70: 7320 6669 6c74 6572 6564 2062 7920 7374  s filtered by st
-0002dd80: 6f72 650a 2020 2020 2020 2020 2320 7479  ore.        # ty
-0002dd90: 7065 2061 7265 2064 656c 6574 6564 0a20  pe are deleted. 
-0002dda0: 2020 2020 2020 206f 7574 5f61 6c6c 203d         out_all =
-0002ddb0: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-0002ddc0: 6b5f 6f75 7470 7574 285b 2773 6b79 272c  k_output(['sky',
-0002ddd0: 2027 7374 6f72 6167 6527 2c20 276c 7327   'storage', 'ls'
-0002dde0: 5d29 0a20 2020 2020 2020 206f 7574 203d  ]).        out =
-0002ddf0: 205b 0a20 2020 2020 2020 2020 2020 2069   [.            i
-0002de00: 7465 6d2e 7370 6c69 7428 295b 305d 0a20  tem.split()[0]. 
-0002de10: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-0002de20: 7465 6d20 696e 206f 7574 5f61 6c6c 2e64  tem in out_all.d
-0002de30: 6563 6f64 6528 2775 7466 2d38 2729 2e73  ecode('utf-8').s
-0002de40: 706c 6974 6c69 6e65 7328 290a 2020 2020  plitlines().    
-0002de50: 2020 2020 2020 2020 6966 2073 746f 7265          if store
-0002de60: 5f74 7970 652e 7661 6c75 6520 696e 2069  _type.value in i
-0002de70: 7465 6d0a 2020 2020 2020 2020 5d0a 2020  tem.        ].  
-0002de80: 2020 2020 2020 6173 7365 7274 2061 6c6c        assert all
-0002de90: 285b 6974 656d 206e 6f74 2069 6e20 6f75  ([item not in ou
-0002dea0: 7420 666f 7220 6974 656d 2069 6e20 7374  t for item in st
-0002deb0: 6f72 6167 655f 6f62 6a5f 6e61 6d65 5d29  orage_obj_name])
-0002dec0: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
-0002ded0: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
-0002dee0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0002def0: 6b2e 7061 7261 6d65 7472 697a 6528 2773  k.parametrize('s
-0002df00: 746f 7265 5f74 7970 6527 2c20 5b0a 2020  tore_type', [.  
-0002df10: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
-0002df20: 622e 5374 6f72 6554 7970 652e 5333 2c20  b.StoreType.S3, 
-0002df30: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002df40: 6554 7970 652e 4743 532c 0a20 2020 2020  eType.GCS,.     
-0002df50: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
-0002df60: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002df70: 6554 7970 652e 4942 4d2c 206d 6172 6b73  eType.IBM, marks
-0002df80: 3d70 7974 6573 742e 6d61 726b 2e69 626d  =pytest.mark.ibm
-0002df90: 292c 0a20 2020 2020 2020 2070 7974 6573  ),.        pytes
-0002dfa0: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
-0002dfb0: 6c69 622e 5374 6f72 6554 7970 652e 5232  lib.StoreType.R2
-0002dfc0: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
-0002dfd0: 6172 6b2e 636c 6f75 6466 6c61 7265 290a  ark.cloudflare).
-0002dfe0: 2020 2020 5d29 0a20 2020 2064 6566 2074      ]).    def t
-0002dff0: 6573 745f 7570 6c6f 6164 5f73 6f75 7263  est_upload_sourc
-0002e000: 655f 7769 7468 5f73 7061 6365 7328 7365  e_with_spaces(se
-0002e010: 6c66 2c20 7374 6f72 655f 7479 7065 2c0a  lf, store_type,.
-0002e020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e040: 2020 2020 2020 2074 6d70 5f6d 756c 7469         tmp_multi
-0002e050: 706c 655f 6375 7374 6f6d 5f73 6f75 7263  ple_custom_sourc
-0002e060: 655f 7374 6f72 6167 655f 6f62 6a29 3a0a  e_storage_obj):.
-0002e070: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
-0002e080: 7320 7477 6f20 6275 636b 6574 7320 7769  s two buckets wi
-0002e090: 7468 2073 7065 6369 6669 6564 206c 6f63  th specified loc
-0002e0a0: 616c 2073 6f75 7263 6573 0a20 2020 2020  al sources.     
-0002e0b0: 2020 2023 2077 6974 6820 7370 6163 6573     # with spaces
-0002e0c0: 2069 6e20 7468 6520 6e61 6d65 0a20 2020   in the name.   
-0002e0d0: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
-0002e0e0: 5f6e 616d 6573 203d 205b 5d0a 2020 2020  _names = [].    
-0002e0f0: 2020 2020 666f 7220 7374 6f72 6167 655f      for storage_
-0002e100: 6f62 6a20 696e 2074 6d70 5f6d 756c 7469  obj in tmp_multi
-0002e110: 706c 655f 6375 7374 6f6d 5f73 6f75 7263  ple_custom_sourc
-0002e120: 655f 7374 6f72 6167 655f 6f62 6a3a 0a20  e_storage_obj:. 
-0002e130: 2020 2020 2020 2020 2020 2073 746f 7261             stora
-0002e140: 6765 5f6f 626a 2e61 6464 5f73 746f 7265  ge_obj.add_store
-0002e150: 2873 746f 7265 5f74 7970 6529 0a20 2020  (store_type).   
-0002e160: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-0002e170: 5f6f 626a 5f6e 616d 6573 2e61 7070 656e  _obj_names.appen
-0002e180: 6428 7374 6f72 6167 655f 6f62 6a2e 6e61  d(storage_obj.na
-0002e190: 6d65 290a 0a20 2020 2020 2020 2023 2052  me)..        # R
-0002e1a0: 756e 2073 6b79 2073 746f 7261 6765 206c  un sky storage l
-0002e1b0: 7320 746f 2063 6865 636b 2069 6620 616c  s to check if al
-0002e1c0: 6c20 7374 6f72 6167 6520 6f62 6a65 6374  l storage object
-0002e1d0: 7320 6578 6973 7473 2069 6e20 7468 650a  s exists in the.
-0002e1e0: 2020 2020 2020 2020 2320 6f75 7470 7574          # output
-0002e1f0: 2066 696c 7465 7265 6420 6279 2073 746f   filtered by sto
-0002e200: 7265 2074 7970 650a 2020 2020 2020 2020  re type.        
-0002e210: 6f75 745f 616c 6c20 3d20 7375 6270 726f  out_all = subpro
-0002e220: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
-0002e230: 7428 5b27 736b 7927 2c20 2773 746f 7261  t(['sky', 'stora
-0002e240: 6765 272c 2027 6c73 275d 290a 2020 2020  ge', 'ls']).    
-0002e250: 2020 2020 6f75 7420 3d20 5b0a 2020 2020      out = [.    
-0002e260: 2020 2020 2020 2020 6974 656d 2e73 706c          item.spl
-0002e270: 6974 2829 5b30 5d0a 2020 2020 2020 2020  it()[0].        
-0002e280: 2020 2020 666f 7220 6974 656d 2069 6e20      for item in 
-0002e290: 6f75 745f 616c 6c2e 6465 636f 6465 2827  out_all.decode('
-0002e2a0: 7574 662d 3827 292e 7370 6c69 746c 696e  utf-8').splitlin
-0002e2b0: 6573 2829 0a20 2020 2020 2020 2020 2020  es().           
-0002e2c0: 2069 6620 7374 6f72 655f 7479 7065 2e76   if store_type.v
-0002e2d0: 616c 7565 2069 6e20 6974 656d 0a20 2020  alue in item.   
-0002e2e0: 2020 2020 205d 0a20 2020 2020 2020 2061       ].        a
-0002e2f0: 7373 6572 7420 616c 6c28 5b69 7465 6d20  ssert all([item 
-0002e300: 696e 206f 7574 2066 6f72 2069 7465 6d20  in out for item 
-0002e310: 696e 2073 746f 7261 6765 5f6f 626a 5f6e  in storage_obj_n
-0002e320: 616d 6573 5d29 0a0a 2020 2020 4070 7974  ames])..    @pyt
-0002e330: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
-0002e340: 6473 7461 636b 0a20 2020 2040 7079 7465  dstack.    @pyte
-0002e350: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
-0002e360: 697a 6528 2773 746f 7265 5f74 7970 6527  ize('store_type'
-0002e370: 2c20 5b0a 2020 2020 2020 2020 7374 6f72  , [.        stor
-0002e380: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0002e390: 652e 5333 2c20 7374 6f72 6167 655f 6c69  e.S3, storage_li
-0002e3a0: 622e 5374 6f72 6554 7970 652e 4743 532c  b.StoreType.GCS,
-0002e3b0: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
-0002e3c0: 7061 7261 6d28 7374 6f72 6167 655f 6c69  param(storage_li
-0002e3d0: 622e 5374 6f72 6554 7970 652e 4942 4d2c  b.StoreType.IBM,
-0002e3e0: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-0002e3f0: 726b 2e69 626d 292c 0a20 2020 2020 2020  rk.ibm),.       
-0002e400: 2070 7974 6573 742e 7061 7261 6d28 7374   pytest.param(st
-0002e410: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0002e420: 7970 652e 5232 2c20 6d61 726b 733d 7079  ype.R2, marks=py
-0002e430: 7465 7374 2e6d 6172 6b2e 636c 6f75 6466  test.mark.cloudf
-0002e440: 6c61 7265 290a 2020 2020 5d29 0a20 2020  lare).    ]).   
-0002e450: 2064 6566 2074 6573 745f 6275 636b 6574   def test_bucket
-0002e460: 5f65 7874 6572 6e61 6c5f 6465 6c65 7469  _external_deleti
-0002e470: 6f6e 2873 656c 662c 2074 6d70 5f73 6372  on(self, tmp_scr
-0002e480: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
-0002e490: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002e4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e4b0: 2020 2020 2020 2020 7374 6f72 655f 7479          store_ty
-0002e4c0: 7065 293a 0a20 2020 2020 2020 2023 2043  pe):.        # C
-0002e4d0: 7265 6174 6573 2061 2062 7563 6b65 742c  reates a bucket,
-0002e4e0: 2064 656c 6574 6573 2069 7420 6578 7465   deletes it exte
-0002e4f0: 726e 616c 6c79 2075 7369 6e67 2063 6c6f  rnally using clo
-0002e500: 7564 2063 6c69 2063 6f6d 6d61 6e64 730a  ud cli commands.
-0002e510: 2020 2020 2020 2020 2320 616e 6420 7468          # and th
-0002e520: 656e 2074 7269 6573 2074 6f20 6465 6c65  en tries to dele
-0002e530: 7465 2069 7420 7573 696e 6720 736b 7920  te it using sky 
-0002e540: 7374 6f72 6167 6520 6465 6c65 7465 2e0a  storage delete..
-0002e550: 2020 2020 2020 2020 746d 705f 7363 7261          tmp_scra
-0002e560: 7463 685f 7374 6f72 6167 655f 6f62 6a2e  tch_storage_obj.
-0002e570: 6164 645f 7374 6f72 6528 7374 6f72 655f  add_store(store_
-0002e580: 7479 7065 290a 0a20 2020 2020 2020 2023  type)..        #
-0002e590: 2052 756e 2073 6b79 2073 746f 7261 6765   Run sky storage
-0002e5a0: 206c 7320 746f 2063 6865 636b 2069 6620   ls to check if 
-0002e5b0: 7374 6f72 6167 6520 6f62 6a65 6374 2065  storage object e
-0002e5c0: 7869 7374 7320 696e 2074 6865 206f 7574  xists in the out
-0002e5d0: 7075 740a 2020 2020 2020 2020 6f75 7420  put.        out 
-0002e5e0: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
-0002e5f0: 636b 5f6f 7574 7075 7428 5b27 736b 7927  ck_output(['sky'
-0002e600: 2c20 2773 746f 7261 6765 272c 2027 6c73  , 'storage', 'ls
-0002e610: 275d 290a 2020 2020 2020 2020 6173 7365  ']).        asse
-0002e620: 7274 2074 6d70 5f73 6372 6174 6368 5f73  rt tmp_scratch_s
-0002e630: 746f 7261 6765 5f6f 626a 2e6e 616d 6520  torage_obj.name 
-0002e640: 696e 206f 7574 2e64 6563 6f64 6528 2775  in out.decode('u
-0002e650: 7466 2d38 2729 0a0a 2020 2020 2020 2020  tf-8')..        
-0002e660: 2320 4465 6c65 7465 2062 7563 6b65 7420  # Delete bucket 
-0002e670: 6578 7465 726e 616c 6c79 0a20 2020 2020  externally.     
-0002e680: 2020 2063 6d64 203d 2073 656c 662e 636c     cmd = self.cl
-0002e690: 695f 6465 6c65 7465 5f63 6d64 2873 746f  i_delete_cmd(sto
-0002e6a0: 7265 5f74 7970 652c 2074 6d70 5f73 6372  re_type, tmp_scr
-0002e6b0: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
-0002e6c0: 2e6e 616d 6529 0a20 2020 2020 2020 2073  .name).        s
-0002e6d0: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-0002e6e0: 6f75 7470 7574 2863 6d64 2c20 7368 656c  output(cmd, shel
-0002e6f0: 6c3d 5472 7565 290a 0a20 2020 2020 2020  l=True)..       
-0002e700: 2023 2052 756e 2073 6b79 2073 746f 7261   # Run sky stora
-0002e710: 6765 2064 656c 6574 6520 746f 2064 656c  ge delete to del
-0002e720: 6574 6520 7468 6520 7374 6f72 6167 6520  ete the storage 
-0002e730: 6f62 6a65 6374 0a20 2020 2020 2020 206f  object.        o
-0002e740: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
-0002e750: 6368 6563 6b5f 6f75 7470 7574 280a 2020  check_output(.  
-0002e760: 2020 2020 2020 2020 2020 5b27 736b 7927            ['sky'
-0002e770: 2c20 2773 746f 7261 6765 272c 2027 6465  , 'storage', 'de
-0002e780: 6c65 7465 272c 2074 6d70 5f73 6372 6174  lete', tmp_scrat
-0002e790: 6368 5f73 746f 7261 6765 5f6f 626a 2e6e  ch_storage_obj.n
-0002e7a0: 616d 652c 2027 2d2d 7965 7327 5d29 0a20  ame, '--yes']). 
-0002e7b0: 2020 2020 2020 2023 204d 616b 6520 7375         # Make su
-0002e7c0: 7265 2062 7563 6b65 7420 7761 7320 6e6f  re bucket was no
-0002e7d0: 7420 6372 6561 7465 6420 6475 7269 6e67  t created during
-0002e7e0: 2064 656c 6574 696f 6e20 2873 6565 2069   deletion (see i
-0002e7f0: 7373 7565 2023 3133 3232 290a 2020 2020  ssue #1322).    
-0002e800: 2020 2020 6173 7365 7274 2027 6372 6561      assert 'crea
-0002e810: 7465 6427 206e 6f74 2069 6e20 6f75 742e  ted' not in out.
-0002e820: 6465 636f 6465 2827 7574 662d 3827 292e  decode('utf-8').
-0002e830: 6c6f 7765 7228 290a 0a20 2020 2020 2020  lower()..       
-0002e840: 2023 2052 756e 2073 6b79 2073 746f 7261   # Run sky stora
-0002e850: 6765 206c 7320 746f 2063 6865 636b 2069  ge ls to check i
-0002e860: 6620 7374 6f72 6167 6520 6f62 6a65 6374  f storage object
-0002e870: 2069 7320 6465 6c65 7465 640a 2020 2020   is deleted.    
-0002e880: 2020 2020 6f75 7420 3d20 7375 6270 726f      out = subpro
-0002e890: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
-0002e8a0: 7428 5b27 736b 7927 2c20 2773 746f 7261  t(['sky', 'stora
-0002e8b0: 6765 272c 2027 6c73 275d 290a 2020 2020  ge', 'ls']).    
-0002e8c0: 2020 2020 6173 7365 7274 2074 6d70 5f73      assert tmp_s
-0002e8d0: 6372 6174 6368 5f73 746f 7261 6765 5f6f  cratch_storage_o
-0002e8e0: 626a 2e6e 616d 6520 6e6f 7420 696e 206f  bj.name not in o
-0002e8f0: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
-0002e900: 2729 0a0a 2020 2020 4070 7974 6573 742e  ')..    @pytest.
-0002e910: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
-0002e920: 636b 0a20 2020 2040 7079 7465 7374 2e6d  ck.    @pytest.m
-0002e930: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
-0002e940: 2773 746f 7265 5f74 7970 6527 2c20 5b0a  'store_type', [.
-0002e950: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-0002e960: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
-0002e970: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
-0002e980: 6f72 6554 7970 652e 4743 532c 0a20 2020  oreType.GCS,.   
-0002e990: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
-0002e9a0: 6d28 7374 6f72 6167 655f 6c69 622e 5374  m(storage_lib.St
-0002e9b0: 6f72 6554 7970 652e 4942 4d2c 206d 6172  oreType.IBM, mar
-0002e9c0: 6b73 3d70 7974 6573 742e 6d61 726b 2e69  ks=pytest.mark.i
-0002e9d0: 626d 292c 0a20 2020 2020 2020 2070 7974  bm),.        pyt
-0002e9e0: 6573 742e 7061 7261 6d28 7374 6f72 6167  est.param(storag
-0002e9f0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-0002ea00: 5232 2c20 6d61 726b 733d 7079 7465 7374  R2, marks=pytest
-0002ea10: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
-0002ea20: 290a 2020 2020 5d29 0a20 2020 2064 6566  ).    ]).    def
-0002ea30: 2074 6573 745f 6275 636b 6574 5f62 756c   test_bucket_bul
-0002ea40: 6b5f 6465 6c65 7469 6f6e 2873 656c 662c  k_deletion(self,
-0002ea50: 2073 746f 7265 5f74 7970 652c 2074 6d70   store_type, tmp
-0002ea60: 5f62 756c 6b5f 6465 6c5f 7374 6f72 6167  _bulk_del_storag
-0002ea70: 655f 6f62 6a29 3a0a 2020 2020 2020 2020  e_obj):.        
-0002ea80: 2320 4372 6561 7465 7320 6120 7465 6d70  # Creates a temp
-0002ea90: 2066 6f6c 6465 7220 7769 7468 206f 7665   folder with ove
-0002eaa0: 7220 3235 3620 6669 6c65 7320 616e 6420  r 256 files and 
-0002eab0: 666f 6c64 6572 732c 2075 706c 6f61 640a  folders, upload.
-0002eac0: 2020 2020 2020 2020 2320 6669 6c65 7320          # files 
-0002ead0: 616e 6420 666f 6c64 6572 7320 746f 2061  and folders to a
-0002eae0: 206e 6577 2062 7563 6b65 742c 2074 6865   new bucket, the
-0002eaf0: 6e20 6465 6c65 7465 2062 7563 6b65 742e  n delete bucket.
-0002eb00: 0a20 2020 2020 2020 2074 6d70 5f62 756c  .        tmp_bul
-0002eb10: 6b5f 6465 6c5f 7374 6f72 6167 655f 6f62  k_del_storage_ob
-0002eb20: 6a2e 6164 645f 7374 6f72 6528 7374 6f72  j.add_store(stor
-0002eb30: 655f 7479 7065 290a 0a20 2020 2020 2020  e_type)..       
-0002eb40: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-0002eb50: 6b5f 6f75 7470 7574 285b 0a20 2020 2020  k_output([.     
-0002eb60: 2020 2020 2020 2027 736b 7927 2c20 2773         'sky', 's
-0002eb70: 746f 7261 6765 272c 2027 6465 6c65 7465  torage', 'delete
-0002eb80: 272c 2074 6d70 5f62 756c 6b5f 6465 6c5f  ', tmp_bulk_del_
-0002eb90: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
-0002eba0: 2c20 272d 2d79 6573 270a 2020 2020 2020  , '--yes'.      
-0002ebb0: 2020 5d29 0a0a 2020 2020 2020 2020 6f75    ])..        ou
-0002ebc0: 7470 7574 203d 2073 7562 7072 6f63 6573  tput = subproces
-0002ebd0: 732e 6368 6563 6b5f 6f75 7470 7574 285b  s.check_output([
-0002ebe0: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
-0002ebf0: 2c20 276c 7327 5d29 0a20 2020 2020 2020  , 'ls']).       
-0002ec00: 2061 7373 6572 7420 746d 705f 6275 6c6b   assert tmp_bulk
-0002ec10: 5f64 656c 5f73 746f 7261 6765 5f6f 626a  _del_storage_obj
-0002ec20: 2e6e 616d 6520 6e6f 7420 696e 206f 7574  .name not in out
-0002ec30: 7075 742e 6465 636f 6465 2827 7574 662d  put.decode('utf-
-0002ec40: 3827 290a 0a20 2020 2040 7079 7465 7374  8')..    @pytest
-0002ec50: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
-0002ec60: 6163 6b0a 2020 2020 4070 7974 6573 742e  ack.    @pytest.
-0002ec70: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
-0002ec80: 280a 2020 2020 2020 2020 2774 6d70 5f70  (.        'tmp_p
-0002ec90: 7562 6c69 635f 7374 6f72 6167 655f 6f62  ublic_storage_ob
-0002eca0: 6a2c 2073 746f 7265 5f74 7970 6527 2c0a  j, store_type',.
-0002ecb0: 2020 2020 2020 2020 5b28 2773 333a 2f2f          [('s3://
-0002ecc0: 7463 6761 2d32 2d6f 7065 6e27 2c20 7374  tcga-2-open', st
-0002ecd0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0002ece0: 7970 652e 5333 292c 0a20 2020 2020 2020  ype.S3),.       
-0002ecf0: 2020 2827 7333 3a2f 2f64 6967 6974 616c    ('s3://digital
-0002ed00: 636f 7270 6f72 6127 2c20 7374 6f72 6167  corpora', storag
-0002ed10: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-0002ed20: 5333 292c 0a20 2020 2020 2020 2020 2827  S3),.         ('
-0002ed30: 6773 3a2f 2f67 6370 2d70 7562 6c69 632d  gs://gcp-public-
-0002ed40: 6461 7461 2d73 656e 7469 6e65 6c2d 3227  data-sentinel-2'
-0002ed50: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
-0002ed60: 6f72 6554 7970 652e 4743 5329 5d2c 0a20  oreType.GCS)],. 
-0002ed70: 2020 2020 2020 2069 6e64 6972 6563 743d         indirect=
-0002ed80: 5b27 746d 705f 7075 626c 6963 5f73 746f  ['tmp_public_sto
-0002ed90: 7261 6765 5f6f 626a 275d 290a 2020 2020  rage_obj']).    
-0002eda0: 6465 6620 7465 7374 5f70 7562 6c69 635f  def test_public_
-0002edb0: 6275 636b 6574 2873 656c 662c 2074 6d70  bucket(self, tmp
-0002edc0: 5f70 7562 6c69 635f 7374 6f72 6167 655f  _public_storage_
-0002edd0: 6f62 6a2c 2073 746f 7265 5f74 7970 6529  obj, store_type)
-0002ede0: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
-0002edf0: 7465 7320 6120 6e65 7720 6275 636b 6574  tes a new bucket
-0002ee00: 2077 6974 6820 6120 7075 626c 6963 2073   with a public s
-0002ee10: 6f75 7263 6520 616e 6420 7665 7269 6669  ource and verifi
-0002ee20: 6573 2074 6861 7420 6974 2069 7320 6e6f  es that it is no
-0002ee30: 740a 2020 2020 2020 2020 2320 6164 6465  t.        # adde
-0002ee40: 6420 746f 2067 6c6f 6261 6c5f 7573 6572  d to global_user
-0002ee50: 5f73 7461 7465 2e0a 2020 2020 2020 2020  _state..        
-0002ee60: 746d 705f 7075 626c 6963 5f73 746f 7261  tmp_public_stora
-0002ee70: 6765 5f6f 626a 2e61 6464 5f73 746f 7265  ge_obj.add_store
-0002ee80: 2873 746f 7265 5f74 7970 6529 0a0a 2020  (store_type)..  
-0002ee90: 2020 2020 2020 2320 5275 6e20 736b 7920        # Run sky 
-0002eea0: 7374 6f72 6167 6520 6c73 2074 6f20 6368  storage ls to ch
-0002eeb0: 6563 6b20 6966 2073 746f 7261 6765 206f  eck if storage o
-0002eec0: 626a 6563 7420 6578 6973 7473 2069 6e20  bject exists in 
-0002eed0: 7468 6520 6f75 7470 7574 0a20 2020 2020  the output.     
-0002eee0: 2020 206f 7574 203d 2073 7562 7072 6f63     out = subproc
-0002eef0: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
-0002ef00: 285b 2773 6b79 272c 2027 7374 6f72 6167  (['sky', 'storag
-0002ef10: 6527 2c20 276c 7327 5d29 0a20 2020 2020  e', 'ls']).     
-0002ef20: 2020 2061 7373 6572 7420 746d 705f 7075     assert tmp_pu
-0002ef30: 626c 6963 5f73 746f 7261 6765 5f6f 626a  blic_storage_obj
-0002ef40: 2e6e 616d 6520 6e6f 7420 696e 206f 7574  .name not in out
-0002ef50: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-0002ef60: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
-0002ef70: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
-0002ef80: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0002ef90: 6b2e 7061 7261 6d65 7472 697a 6528 276e  k.parametrize('n
-0002efa0: 6f6e 6578 6973 745f 6275 636b 6574 5f75  onexist_bucket_u
-0002efb0: 726c 272c 205b 0a20 2020 2020 2020 2027  rl', [.        '
-0002efc0: 7333 3a2f 2f7b 7261 6e64 6f6d 5f6e 616d  s3://{random_nam
-0002efd0: 657d 272c 2027 6773 3a2f 2f7b 7261 6e64  e}', 'gs://{rand
-0002efe0: 6f6d 5f6e 616d 657d 272c 0a20 2020 2020  om_name}',.     
-0002eff0: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
-0002f000: 2763 6f73 3a2f 2f75 732d 6561 7374 2f7b  'cos://us-east/{
-0002f010: 7261 6e64 6f6d 5f6e 616d 657d 272c 206d  random_name}', m
-0002f020: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
-0002f030: 2e69 626d 292c 0a20 2020 2020 2020 2070  .ibm),.        p
-0002f040: 7974 6573 742e 7061 7261 6d28 2772 323a  ytest.param('r2:
-0002f050: 2f2f 7b72 616e 646f 6d5f 6e61 6d65 7d27  //{random_name}'
-0002f060: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
-0002f070: 6172 6b2e 636c 6f75 6466 6c61 7265 290a  ark.cloudflare).
-0002f080: 2020 2020 5d29 0a20 2020 2064 6566 2074      ]).    def t
-0002f090: 6573 745f 6e6f 6e65 7869 7374 656e 745f  est_nonexistent_
-0002f0a0: 6275 636b 6574 2873 656c 662c 206e 6f6e  bucket(self, non
-0002f0b0: 6578 6973 745f 6275 636b 6574 5f75 726c  exist_bucket_url
-0002f0c0: 293a 0a20 2020 2020 2020 2023 2041 7474  ):.        # Att
-0002f0d0: 656d 7074 7320 746f 2063 7265 6174 6520  empts to create 
-0002f0e0: 6665 7463 6820 6120 7374 726f 6167 6520  fetch a stroage 
-0002f0f0: 7769 7468 2061 206e 6f6e 2d65 7869 7374  with a non-exist
-0002f100: 656e 7420 736f 7572 6365 2e0a 2020 2020  ent source..    
-0002f110: 2020 2020 2320 4765 6e65 7261 7465 2061      # Generate a
-0002f120: 2072 616e 646f 6d20 6275 636b 6574 206e   random bucket n
-0002f130: 616d 6520 616e 6420 7665 7269 6679 2069  ame and verify i
-0002f140: 7420 646f 6573 6e27 7420 6578 6973 743a  t doesn't exist:
-0002f150: 0a20 2020 2020 2020 2072 6574 7279 5f63  .        retry_c
-0002f160: 6f75 6e74 203d 2030 0a20 2020 2020 2020  ount = 0.       
-0002f170: 2077 6869 6c65 2054 7275 653a 0a20 2020   while True:.   
-0002f180: 2020 2020 2020 2020 206e 6f6e 6578 6973           nonexis
-0002f190: 745f 6275 636b 6574 5f6e 616d 6520 3d20  t_bucket_name = 
-0002f1a0: 7374 7228 7575 6964 2e75 7569 6434 2829  str(uuid.uuid4()
-0002f1b0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0002f1c0: 206e 6f6e 6578 6973 745f 6275 636b 6574   nonexist_bucket
-0002f1d0: 5f75 726c 2e73 7461 7274 7377 6974 6828  _url.startswith(
-0002f1e0: 2773 3327 293a 0a20 2020 2020 2020 2020  's3'):.         
-0002f1f0: 2020 2020 2020 2063 6f6d 6d61 6e64 203d         command =
-0002f200: 2066 2761 7773 2073 3361 7069 2068 6561   f'aws s3api hea
-0002f210: 642d 6275 636b 6574 202d 2d62 7563 6b65  d-bucket --bucke
-0002f220: 7420 7b6e 6f6e 6578 6973 745f 6275 636b  t {nonexist_buck
-0002f230: 6574 5f6e 616d 657d 270a 2020 2020 2020  et_name}'.      
-0002f240: 2020 2020 2020 2020 2020 6578 7065 6374            expect
-0002f250: 6564 5f6f 7574 7075 7420 3d20 2734 3034  ed_output = '404
-0002f260: 270a 2020 2020 2020 2020 2020 2020 656c  '.            el
-0002f270: 6966 206e 6f6e 6578 6973 745f 6275 636b  if nonexist_buck
-0002f280: 6574 5f75 726c 2e73 7461 7274 7377 6974  et_url.startswit
-0002f290: 6828 2767 7327 293a 0a20 2020 2020 2020  h('gs'):.       
-0002f2a0: 2020 2020 2020 2020 2063 6f6d 6d61 6e64           command
-0002f2b0: 203d 2066 2767 7375 7469 6c20 6c73 207b   = f'gsutil ls {
-0002f2c0: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
-0002f2d0: 7572 6c2e 666f 726d 6174 2872 616e 646f  url.format(rando
-0002f2e0: 6d5f 6e61 6d65 3d6e 6f6e 6578 6973 745f  m_name=nonexist_
-0002f2f0: 6275 636b 6574 5f6e 616d 6529 7d27 0a20  bucket_name)}'. 
-0002f300: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0002f310: 7870 6563 7465 645f 6f75 7470 7574 203d  xpected_output =
-0002f320: 2027 4275 636b 6574 4e6f 7446 6f75 6e64   'BucketNotFound
-0002f330: 4578 6365 7074 696f 6e27 0a20 2020 2020  Exception'.     
-0002f340: 2020 2020 2020 2065 6c69 6620 6e6f 6e65         elif none
-0002f350: 7869 7374 5f62 7563 6b65 745f 7572 6c2e  xist_bucket_url.
-0002f360: 7374 6172 7473 7769 7468 2827 7232 2729  startswith('r2')
-0002f370: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002f380: 2020 656e 6470 6f69 6e74 5f75 726c 203d    endpoint_url =
-0002f390: 2063 6c6f 7564 666c 6172 652e 6372 6561   cloudflare.crea
-0002f3a0: 7465 5f65 6e64 706f 696e 7428 290a 2020  te_endpoint().  
-0002f3b0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0002f3c0: 6d6d 616e 6420 3d20 6627 4157 535f 5348  mmand = f'AWS_SH
-0002f3d0: 4152 4544 5f43 5245 4445 4e54 4941 4c53  ARED_CREDENTIALS
-0002f3e0: 5f46 494c 453d 7b63 6c6f 7564 666c 6172  _FILE={cloudflar
-0002f3f0: 652e 5232 5f43 5245 4445 4e54 4941 4c53  e.R2_CREDENTIALS
-0002f400: 5f50 4154 487d 2061 7773 2073 3361 7069  _PATH} aws s3api
-0002f410: 2068 6561 642d 6275 636b 6574 202d 2d62   head-bucket --b
-0002f420: 7563 6b65 7420 7b6e 6f6e 6578 6973 745f  ucket {nonexist_
-0002f430: 6275 636b 6574 5f6e 616d 657d 202d 2d65  bucket_name} --e
-0002f440: 6e64 706f 696e 7420 7b65 6e64 706f 696e  ndpoint {endpoin
-0002f450: 745f 7572 6c7d 202d 2d70 726f 6669 6c65  t_url} --profile
-0002f460: 3d72 3227 0a20 2020 2020 2020 2020 2020  =r2'.           
-0002f470: 2020 2020 2065 7870 6563 7465 645f 6f75       expected_ou
-0002f480: 7470 7574 203d 2027 3430 3427 0a20 2020  tput = '404'.   
-0002f490: 2020 2020 2020 2020 2065 6c69 6620 6e6f           elif no
-0002f4a0: 6e65 7869 7374 5f62 7563 6b65 745f 7572  nexist_bucket_ur
-0002f4b0: 6c2e 7374 6172 7473 7769 7468 2827 636f  l.startswith('co
-0002f4c0: 7327 293a 0a20 2020 2020 2020 2020 2020  s'):.           
-0002f4d0: 2020 2020 2023 2055 7369 6e67 2041 5049       # Using API
-0002f4e0: 2063 616c 6c73 2c20 7369 6e63 6520 7573   calls, since us
-0002f4f0: 696e 6720 7263 6c6f 6e65 2072 6571 7569  ing rclone requi
-0002f500: 7265 7320 6120 7072 6f66 696c 6527 7320  res a profile's 
-0002f510: 6e61 6d65 0a20 2020 2020 2020 2020 2020  name.           
-0002f520: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0002f530: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-0002f540: 7065 6374 6564 5f6f 7574 7075 7420 3d20  pected_output = 
-0002f550: 636f 6d6d 616e 6420 3d20 2265 6368 6f22  command = "echo"
-0002f560: 2020 2320 6176 6f69 6420 756e 7265 6c61    # avoid unrela
-0002f570: 7465 6420 6578 6365 7074 696f 6e20 696e  ted exception in
-0002f580: 2063 6173 6520 6f66 2066 6169 6c75 7265   case of failure
-0002f590: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0002f5a0: 2020 2020 2020 6275 636b 6574 5f6e 616d        bucket_nam
-0002f5b0: 6520 3d20 7572 6c6c 6962 2e70 6172 7365  e = urllib.parse
-0002f5c0: 2e75 726c 7370 6c69 7428 0a20 2020 2020  .urlsplit(.     
-0002f5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f5e0: 2020 206e 6f6e 6578 6973 745f 6275 636b     nonexist_buck
-0002f5f0: 6574 5f75 726c 2e66 6f72 6d61 7428 0a20  et_url.format(. 
-0002f600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f610: 2020 2020 2020 2020 2020 2072 616e 646f             rando
-0002f620: 6d5f 6e61 6d65 3d6e 6f6e 6578 6973 745f  m_name=nonexist_
-0002f630: 6275 636b 6574 5f6e 616d 6529 292e 7061  bucket_name)).pa
-0002f640: 7468 2e73 7472 6970 2827 2f27 290a 2020  th.strip('/').  
-0002f650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f660: 2020 636c 6965 6e74 203d 2069 626d 2e67    client = ibm.g
-0002f670: 6574 5f63 6f73 5f63 6c69 656e 7428 2775  et_cos_client('u
-0002f680: 732d 6561 7374 2729 0a20 2020 2020 2020  s-east').       
-0002f690: 2020 2020 2020 2020 2020 2020 2063 6c69               cli
-0002f6a0: 656e 742e 6865 6164 5f62 7563 6b65 7428  ent.head_bucket(
-0002f6b0: 4275 636b 6574 3d62 7563 6b65 745f 6e61  Bucket=bucket_na
-0002f6c0: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-0002f6d0: 2020 2020 6578 6365 7074 2069 626d 2e69      except ibm.i
-0002f6e0: 626d 5f62 6f74 6f63 6f72 652e 6578 6365  bm_botocore.exce
-0002f6f0: 7074 696f 6e73 2e43 6c69 656e 7445 7272  ptions.ClientErr
-0002f700: 6f72 2061 7320 653a 0a20 2020 2020 2020  or as e:.       
-0002f710: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0002f720: 652e 7265 7370 6f6e 7365 5b27 4572 726f  e.response['Erro
-0002f730: 7227 5d5b 2743 6f64 6527 5d20 3d3d 2027  r']['Code'] == '
-0002f740: 3430 3427 3a0a 2020 2020 2020 2020 2020  404':.          
-0002f750: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0002f760: 7375 6363 6573 730a 2020 2020 2020 2020  success.        
-0002f770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f780: 7265 7475 726e 0a20 2020 2020 2020 2020  return.         
-0002f790: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002f7a0: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-0002f7b0: 616c 7565 4572 726f 7228 2755 6e73 7570  alueError('Unsup
-0002f7c0: 706f 7274 6564 2062 7563 6b65 7420 7479  ported bucket ty
-0002f7d0: 7065 2027 0a20 2020 2020 2020 2020 2020  pe '.           
-0002f7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f7f0: 2020 2020 2020 6627 7b6e 6f6e 6578 6973        f'{nonexis
-0002f800: 745f 6275 636b 6574 5f75 726c 7d27 290a  t_bucket_url}').
-0002f810: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
-0002f820: 6865 636b 2069 6620 6275 636b 6574 2065  heck if bucket e
-0002f830: 7869 7374 7320 7573 696e 6720 7468 6520  xists using the 
-0002f840: 636c 693a 0a20 2020 2020 2020 2020 2020  cli:.           
-0002f850: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0002f860: 2020 2020 2020 6f75 7420 3d20 7375 6270        out = subp
-0002f870: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
-0002f880: 7075 7428 636f 6d6d 616e 642c 0a20 2020  put(command,.   
-0002f890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f8b0: 2020 2020 2020 2020 2020 2073 7464 6572             stder
-0002f8c0: 723d 7375 6270 726f 6365 7373 2e53 5444  r=subprocess.STD
-0002f8d0: 4f55 542c 0a20 2020 2020 2020 2020 2020  OUT,.           
-0002f8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d500: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+0002d510: 655f 7479 7065 293a 0a20 2020 2020 2020  e_type):.       
+0002d520: 2023 2043 7265 6174 6573 2061 206e 6577   # Creates a new
+0002d530: 2062 7563 6b65 7420 7769 7468 2061 206c   bucket with a l
+0002d540: 6f63 616c 2073 6f75 7263 652c 2075 706c  ocal source, upl
+0002d550: 6f61 6473 2066 696c 6573 2074 6f20 6974  oads files to it
+0002d560: 0a20 2020 2020 2020 2023 2061 6e64 2064  .        # and d
+0002d570: 656c 6574 6573 2069 742e 0a20 2020 2020  eletes it..     
+0002d580: 2020 2074 6d70 5f6c 6f63 616c 5f73 746f     tmp_local_sto
+0002d590: 7261 6765 5f6f 626a 2e61 6464 5f73 746f  rage_obj.add_sto
+0002d5a0: 7265 2873 746f 7265 5f74 7970 6529 0a0a  re(store_type)..
+0002d5b0: 2020 2020 2020 2020 2320 5275 6e20 736b          # Run sk
+0002d5c0: 7920 7374 6f72 6167 6520 6c73 2074 6f20  y storage ls to 
+0002d5d0: 6368 6563 6b20 6966 2073 746f 7261 6765  check if storage
+0002d5e0: 206f 626a 6563 7420 6578 6973 7473 2069   object exists i
+0002d5f0: 6e20 7468 6520 6f75 7470 7574 0a20 2020  n the output.   
+0002d600: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
+0002d610: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+0002d620: 7574 285b 2773 6b79 272c 2027 7374 6f72  ut(['sky', 'stor
+0002d630: 6167 6527 2c20 276c 7327 5d29 0a20 2020  age', 'ls']).   
+0002d640: 2020 2020 2061 7373 6572 7420 746d 705f       assert tmp_
+0002d650: 6c6f 6361 6c5f 7374 6f72 6167 655f 6f62  local_storage_ob
+0002d660: 6a2e 6e61 6d65 2069 6e20 6f75 742e 6465  j.name in out.de
+0002d670: 636f 6465 2827 7574 662d 3827 290a 0a20  code('utf-8').. 
+0002d680: 2020 2020 2020 2023 2052 756e 2073 6b79         # Run sky
+0002d690: 2073 746f 7261 6765 2064 656c 6574 6520   storage delete 
+0002d6a0: 746f 2064 656c 6574 6520 7468 6520 7374  to delete the st
+0002d6b0: 6f72 6167 6520 6f62 6a65 6374 0a20 2020  orage object.   
+0002d6c0: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
+0002d6d0: 6368 6563 6b5f 6f75 7470 7574 280a 2020  check_output(.  
+0002d6e0: 2020 2020 2020 2020 2020 5b27 736b 7927            ['sky'
+0002d6f0: 2c20 2773 746f 7261 6765 272c 2027 6465  , 'storage', 'de
+0002d700: 6c65 7465 272c 2074 6d70 5f6c 6f63 616c  lete', tmp_local
+0002d710: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
+0002d720: 652c 2027 2d2d 7965 7327 5d29 0a0a 2020  e, '--yes'])..  
+0002d730: 2020 2020 2020 2320 5275 6e20 736b 7920        # Run sky 
+0002d740: 7374 6f72 6167 6520 6c73 2074 6f20 6368  storage ls to ch
+0002d750: 6563 6b20 6966 2073 746f 7261 6765 206f  eck if storage o
+0002d760: 626a 6563 7420 6973 2064 656c 6574 6564  bject is deleted
+0002d770: 0a20 2020 2020 2020 206f 7574 203d 2073  .        out = s
+0002d780: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
+0002d790: 6f75 7470 7574 285b 2773 6b79 272c 2027  output(['sky', '
+0002d7a0: 7374 6f72 6167 6527 2c20 276c 7327 5d29  storage', 'ls'])
+0002d7b0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0002d7c0: 746d 705f 6c6f 6361 6c5f 7374 6f72 6167  tmp_local_storag
+0002d7d0: 655f 6f62 6a2e 6e61 6d65 206e 6f74 2069  e_obj.name not i
+0002d7e0: 6e20 6f75 742e 6465 636f 6465 2827 7574  n out.decode('ut
+0002d7f0: 662d 3827 290a 0a20 2020 2040 7079 7465  f-8')..    @pyte
+0002d800: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
+0002d810: 7374 6163 6b0a 2020 2020 4070 7974 6573  stack.    @pytes
+0002d820: 742e 6d61 726b 2e78 6469 7374 5f67 726f  t.mark.xdist_gro
+0002d830: 7570 2827 6d75 6c74 6970 6c65 5f62 7563  up('multiple_buc
+0002d840: 6b65 745f 6465 6c65 7469 6f6e 2729 0a20  ket_deletion'). 
+0002d850: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
+0002d860: 7061 7261 6d65 7472 697a 6528 2773 746f  parametrize('sto
+0002d870: 7265 5f74 7970 6527 2c20 5b0a 2020 2020  re_type', [.    
+0002d880: 2020 2020 7374 6f72 6167 655f 6c69 622e      storage_lib.
+0002d890: 5374 6f72 6554 7970 652e 5333 2c20 7374  StoreType.S3, st
+0002d8a0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002d8b0: 7970 652e 4743 532c 0a20 2020 2020 2020  ype.GCS,.       
+0002d8c0: 2070 7974 6573 742e 7061 7261 6d28 7374   pytest.param(st
+0002d8d0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002d8e0: 7970 652e 5232 2c20 6d61 726b 733d 7079  ype.R2, marks=py
+0002d8f0: 7465 7374 2e6d 6172 6b2e 636c 6f75 6466  test.mark.cloudf
+0002d900: 6c61 7265 292c 0a20 2020 2020 2020 2070  lare),.        p
+0002d910: 7974 6573 742e 7061 7261 6d28 7374 6f72  ytest.param(stor
+0002d920: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0002d930: 652e 4942 4d2c 206d 6172 6b73 3d70 7974  e.IBM, marks=pyt
+0002d940: 6573 742e 6d61 726b 2e69 626d 290a 2020  est.mark.ibm).  
+0002d950: 2020 5d29 0a20 2020 2064 6566 2074 6573    ]).    def tes
+0002d960: 745f 6d75 6c74 6970 6c65 5f62 7563 6b65  t_multiple_bucke
+0002d970: 7473 5f63 7265 6174 696f 6e5f 616e 645f  ts_creation_and_
+0002d980: 6465 6c65 7469 6f6e 280a 2020 2020 2020  deletion(.      
+0002d990: 2020 2020 2020 7365 6c66 2c20 746d 705f        self, tmp_
+0002d9a0: 6d75 6c74 6970 6c65 5f73 6372 6174 6368  multiple_scratch
+0002d9b0: 5f73 746f 7261 6765 5f6f 626a 2c20 7374  _storage_obj, st
+0002d9c0: 6f72 655f 7479 7065 293a 0a20 2020 2020  ore_type):.     
+0002d9d0: 2020 2023 2043 7265 6174 6573 206d 756c     # Creates mul
+0002d9e0: 7469 706c 6520 6e65 7720 6275 636b 6574  tiple new bucket
+0002d9f0: 7328 3520 6275 636b 6574 7329 2077 6974  s(5 buckets) wit
+0002da00: 6820 6120 6c6f 6361 6c20 736f 7572 6365  h a local source
+0002da10: 0a20 2020 2020 2020 2023 2061 6e64 2064  .        # and d
+0002da20: 656c 6574 6573 2074 6865 6d2e 0a20 2020  eletes them..   
+0002da30: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
+0002da40: 5f6e 616d 6520 3d20 5b5d 0a20 2020 2020  _name = [].     
+0002da50: 2020 2066 6f72 2073 746f 7265 5f6f 626a     for store_obj
+0002da60: 2069 6e20 746d 705f 6d75 6c74 6970 6c65   in tmp_multiple
+0002da70: 5f73 6372 6174 6368 5f73 746f 7261 6765  _scratch_storage
+0002da80: 5f6f 626a 3a0a 2020 2020 2020 2020 2020  _obj:.          
+0002da90: 2020 7374 6f72 655f 6f62 6a2e 6164 645f    store_obj.add_
+0002daa0: 7374 6f72 6528 7374 6f72 655f 7479 7065  store(store_type
+0002dab0: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
+0002dac0: 6f72 6167 655f 6f62 6a5f 6e61 6d65 2e61  orage_obj_name.a
+0002dad0: 7070 656e 6428 7374 6f72 655f 6f62 6a2e  ppend(store_obj.
+0002dae0: 6e61 6d65 290a 0a20 2020 2020 2020 2023  name)..        #
+0002daf0: 2052 756e 2073 6b79 2073 746f 7261 6765   Run sky storage
+0002db00: 206c 7320 746f 2063 6865 636b 2069 6620   ls to check if 
+0002db10: 616c 6c20 7374 6f72 6167 6520 6f62 6a65  all storage obje
+0002db20: 6374 7320 6578 6973 7473 2069 6e20 7468  cts exists in th
+0002db30: 650a 2020 2020 2020 2020 2320 6f75 7470  e.        # outp
+0002db40: 7574 2066 696c 7465 7265 6420 6279 2073  ut filtered by s
+0002db50: 746f 7265 2074 7970 650a 2020 2020 2020  tore type.      
+0002db60: 2020 6f75 745f 616c 6c20 3d20 7375 6270    out_all = subp
+0002db70: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+0002db80: 7075 7428 5b27 736b 7927 2c20 2773 746f  put(['sky', 'sto
+0002db90: 7261 6765 272c 2027 6c73 275d 290a 2020  rage', 'ls']).  
+0002dba0: 2020 2020 2020 6f75 7420 3d20 5b0a 2020        out = [.  
+0002dbb0: 2020 2020 2020 2020 2020 6974 656d 2e73            item.s
+0002dbc0: 706c 6974 2829 5b30 5d0a 2020 2020 2020  plit()[0].      
+0002dbd0: 2020 2020 2020 666f 7220 6974 656d 2069        for item i
+0002dbe0: 6e20 6f75 745f 616c 6c2e 6465 636f 6465  n out_all.decode
+0002dbf0: 2827 7574 662d 3827 292e 7370 6c69 746c  ('utf-8').splitl
+0002dc00: 696e 6573 2829 0a20 2020 2020 2020 2020  ines().         
+0002dc10: 2020 2069 6620 7374 6f72 655f 7479 7065     if store_type
+0002dc20: 2e76 616c 7565 2069 6e20 6974 656d 0a20  .value in item. 
+0002dc30: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+0002dc40: 2061 7373 6572 7420 616c 6c28 5b69 7465   assert all([ite
+0002dc50: 6d20 696e 206f 7574 2066 6f72 2069 7465  m in out for ite
+0002dc60: 6d20 696e 2073 746f 7261 6765 5f6f 626a  m in storage_obj
+0002dc70: 5f6e 616d 655d 290a 0a20 2020 2020 2020  _name])..       
+0002dc80: 2023 2052 756e 2073 6b79 2073 746f 7261   # Run sky stora
+0002dc90: 6765 2064 656c 6574 6520 616c 6c20 746f  ge delete all to
+0002dca0: 2064 656c 6574 6520 616c 6c20 7374 6f72   delete all stor
+0002dcb0: 6167 6520 6f62 6a65 6374 730a 2020 2020  age objects.    
+0002dcc0: 2020 2020 6465 6c65 7465 5f63 6d64 203d      delete_cmd =
+0002dcd0: 205b 2773 6b79 272c 2027 7374 6f72 6167   ['sky', 'storag
+0002dce0: 6527 2c20 2764 656c 6574 6527 2c20 272d  e', 'delete', '-
+0002dcf0: 2d79 6573 275d 0a20 2020 2020 2020 2064  -yes'].        d
+0002dd00: 656c 6574 655f 636d 6420 2b3d 2073 746f  elete_cmd += sto
+0002dd10: 7261 6765 5f6f 626a 5f6e 616d 650a 2020  rage_obj_name.  
+0002dd20: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
+0002dd30: 2e63 6865 636b 5f6f 7574 7075 7428 6465  .check_output(de
+0002dd40: 6c65 7465 5f63 6d64 290a 0a20 2020 2020  lete_cmd)..     
+0002dd50: 2020 2023 2052 756e 2073 6b79 2073 746f     # Run sky sto
+0002dd60: 7261 6765 206c 7320 746f 2063 6865 636b  rage ls to check
+0002dd70: 2069 6620 616c 6c20 7374 6f72 6167 6520   if all storage 
+0002dd80: 6f62 6a65 6374 7320 6669 6c74 6572 6564  objects filtered
+0002dd90: 2062 7920 7374 6f72 650a 2020 2020 2020   by store.      
+0002dda0: 2020 2320 7479 7065 2061 7265 2064 656c    # type are del
+0002ddb0: 6574 6564 0a20 2020 2020 2020 206f 7574  eted.        out
+0002ddc0: 5f61 6c6c 203d 2073 7562 7072 6f63 6573  _all = subproces
+0002ddd0: 732e 6368 6563 6b5f 6f75 7470 7574 285b  s.check_output([
+0002dde0: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
+0002ddf0: 2c20 276c 7327 5d29 0a20 2020 2020 2020  , 'ls']).       
+0002de00: 206f 7574 203d 205b 0a20 2020 2020 2020   out = [.       
+0002de10: 2020 2020 2069 7465 6d2e 7370 6c69 7428       item.split(
+0002de20: 295b 305d 0a20 2020 2020 2020 2020 2020  )[0].           
+0002de30: 2066 6f72 2069 7465 6d20 696e 206f 7574   for item in out
+0002de40: 5f61 6c6c 2e64 6563 6f64 6528 2775 7466  _all.decode('utf
+0002de50: 2d38 2729 2e73 706c 6974 6c69 6e65 7328  -8').splitlines(
+0002de60: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0002de70: 2073 746f 7265 5f74 7970 652e 7661 6c75   store_type.valu
+0002de80: 6520 696e 2069 7465 6d0a 2020 2020 2020  e in item.      
+0002de90: 2020 5d0a 2020 2020 2020 2020 6173 7365    ].        asse
+0002dea0: 7274 2061 6c6c 285b 6974 656d 206e 6f74  rt all([item not
+0002deb0: 2069 6e20 6f75 7420 666f 7220 6974 656d   in out for item
+0002dec0: 2069 6e20 7374 6f72 6167 655f 6f62 6a5f   in storage_obj_
+0002ded0: 6e61 6d65 5d29 0a0a 2020 2020 4070 7974  name])..    @pyt
+0002dee0: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
+0002def0: 6473 7461 636b 0a20 2020 2040 7079 7465  dstack.    @pyte
+0002df00: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
+0002df10: 697a 6528 2773 746f 7265 5f74 7970 6527  ize('store_type'
+0002df20: 2c20 5b0a 2020 2020 2020 2020 7374 6f72  , [.        stor
+0002df30: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0002df40: 652e 5333 2c20 7374 6f72 6167 655f 6c69  e.S3, storage_li
+0002df50: 622e 5374 6f72 6554 7970 652e 4743 532c  b.StoreType.GCS,
+0002df60: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
+0002df70: 7061 7261 6d28 7374 6f72 6167 655f 6c69  param(storage_li
+0002df80: 622e 5374 6f72 6554 7970 652e 4942 4d2c  b.StoreType.IBM,
+0002df90: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
+0002dfa0: 726b 2e69 626d 292c 0a20 2020 2020 2020  rk.ibm),.       
+0002dfb0: 2070 7974 6573 742e 7061 7261 6d28 7374   pytest.param(st
+0002dfc0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002dfd0: 7970 652e 5232 2c20 6d61 726b 733d 7079  ype.R2, marks=py
+0002dfe0: 7465 7374 2e6d 6172 6b2e 636c 6f75 6466  test.mark.cloudf
+0002dff0: 6c61 7265 290a 2020 2020 5d29 0a20 2020  lare).    ]).   
+0002e000: 2064 6566 2074 6573 745f 7570 6c6f 6164   def test_upload
+0002e010: 5f73 6f75 7263 655f 7769 7468 5f73 7061  _source_with_spa
+0002e020: 6365 7328 7365 6c66 2c20 7374 6f72 655f  ces(self, store_
+0002e030: 7479 7065 2c0a 2020 2020 2020 2020 2020  type,.          
+0002e040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e050: 2020 2020 2020 2020 2020 2020 2074 6d70               tmp
+0002e060: 5f6d 756c 7469 706c 655f 6375 7374 6f6d  _multiple_custom
+0002e070: 5f73 6f75 7263 655f 7374 6f72 6167 655f  _source_storage_
+0002e080: 6f62 6a29 3a0a 2020 2020 2020 2020 2320  obj):.        # 
+0002e090: 4372 6561 7465 7320 7477 6f20 6275 636b  Creates two buck
+0002e0a0: 6574 7320 7769 7468 2073 7065 6369 6669  ets with specifi
+0002e0b0: 6564 206c 6f63 616c 2073 6f75 7263 6573  ed local sources
+0002e0c0: 0a20 2020 2020 2020 2023 2077 6974 6820  .        # with 
+0002e0d0: 7370 6163 6573 2069 6e20 7468 6520 6e61  spaces in the na
+0002e0e0: 6d65 0a20 2020 2020 2020 2073 746f 7261  me.        stora
+0002e0f0: 6765 5f6f 626a 5f6e 616d 6573 203d 205b  ge_obj_names = [
+0002e100: 5d0a 2020 2020 2020 2020 666f 7220 7374  ].        for st
+0002e110: 6f72 6167 655f 6f62 6a20 696e 2074 6d70  orage_obj in tmp
+0002e120: 5f6d 756c 7469 706c 655f 6375 7374 6f6d  _multiple_custom
+0002e130: 5f73 6f75 7263 655f 7374 6f72 6167 655f  _source_storage_
+0002e140: 6f62 6a3a 0a20 2020 2020 2020 2020 2020  obj:.           
+0002e150: 2073 746f 7261 6765 5f6f 626a 2e61 6464   storage_obj.add
+0002e160: 5f73 746f 7265 2873 746f 7265 5f74 7970  _store(store_typ
+0002e170: 6529 0a20 2020 2020 2020 2020 2020 2073  e).            s
+0002e180: 746f 7261 6765 5f6f 626a 5f6e 616d 6573  torage_obj_names
+0002e190: 2e61 7070 656e 6428 7374 6f72 6167 655f  .append(storage_
+0002e1a0: 6f62 6a2e 6e61 6d65 290a 0a20 2020 2020  obj.name)..     
+0002e1b0: 2020 2023 2052 756e 2073 6b79 2073 746f     # Run sky sto
+0002e1c0: 7261 6765 206c 7320 746f 2063 6865 636b  rage ls to check
+0002e1d0: 2069 6620 616c 6c20 7374 6f72 6167 6520   if all storage 
+0002e1e0: 6f62 6a65 6374 7320 6578 6973 7473 2069  objects exists i
+0002e1f0: 6e20 7468 650a 2020 2020 2020 2020 2320  n the.        # 
+0002e200: 6f75 7470 7574 2066 696c 7465 7265 6420  output filtered 
+0002e210: 6279 2073 746f 7265 2074 7970 650a 2020  by store type.  
+0002e220: 2020 2020 2020 6f75 745f 616c 6c20 3d20        out_all = 
+0002e230: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+0002e240: 5f6f 7574 7075 7428 5b27 736b 7927 2c20  _output(['sky', 
+0002e250: 2773 746f 7261 6765 272c 2027 6c73 275d  'storage', 'ls']
+0002e260: 290a 2020 2020 2020 2020 6f75 7420 3d20  ).        out = 
+0002e270: 5b0a 2020 2020 2020 2020 2020 2020 6974  [.            it
+0002e280: 656d 2e73 706c 6974 2829 5b30 5d0a 2020  em.split()[0].  
+0002e290: 2020 2020 2020 2020 2020 666f 7220 6974            for it
+0002e2a0: 656d 2069 6e20 6f75 745f 616c 6c2e 6465  em in out_all.de
+0002e2b0: 636f 6465 2827 7574 662d 3827 292e 7370  code('utf-8').sp
+0002e2c0: 6c69 746c 696e 6573 2829 0a20 2020 2020  litlines().     
+0002e2d0: 2020 2020 2020 2069 6620 7374 6f72 655f         if store_
+0002e2e0: 7479 7065 2e76 616c 7565 2069 6e20 6974  type.value in it
+0002e2f0: 656d 0a20 2020 2020 2020 205d 0a20 2020  em.        ].   
+0002e300: 2020 2020 2061 7373 6572 7420 616c 6c28       assert all(
+0002e310: 5b69 7465 6d20 696e 206f 7574 2066 6f72  [item in out for
+0002e320: 2069 7465 6d20 696e 2073 746f 7261 6765   item in storage
+0002e330: 5f6f 626a 5f6e 616d 6573 5d29 0a0a 2020  _obj_names])..  
+0002e340: 2020 4070 7974 6573 742e 6d61 726b 2e6e    @pytest.mark.n
+0002e350: 6f5f 666c 7569 6473 7461 636b 0a20 2020  o_fluidstack.   
+0002e360: 2040 7079 7465 7374 2e6d 6172 6b2e 7061   @pytest.mark.pa
+0002e370: 7261 6d65 7472 697a 6528 2773 746f 7265  rametrize('store
+0002e380: 5f74 7970 6527 2c20 5b0a 2020 2020 2020  _type', [.      
+0002e390: 2020 7374 6f72 6167 655f 6c69 622e 5374    storage_lib.St
+0002e3a0: 6f72 6554 7970 652e 5333 2c20 7374 6f72  oreType.S3, stor
+0002e3b0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0002e3c0: 652e 4743 532c 0a20 2020 2020 2020 2070  e.GCS,.        p
+0002e3d0: 7974 6573 742e 7061 7261 6d28 7374 6f72  ytest.param(stor
+0002e3e0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0002e3f0: 652e 4942 4d2c 206d 6172 6b73 3d70 7974  e.IBM, marks=pyt
+0002e400: 6573 742e 6d61 726b 2e69 626d 292c 0a20  est.mark.ibm),. 
+0002e410: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
+0002e420: 7261 6d28 7374 6f72 6167 655f 6c69 622e  ram(storage_lib.
+0002e430: 5374 6f72 6554 7970 652e 5232 2c20 6d61  StoreType.R2, ma
+0002e440: 726b 733d 7079 7465 7374 2e6d 6172 6b2e  rks=pytest.mark.
+0002e450: 636c 6f75 6466 6c61 7265 290a 2020 2020  cloudflare).    
+0002e460: 5d29 0a20 2020 2064 6566 2074 6573 745f  ]).    def test_
+0002e470: 6275 636b 6574 5f65 7874 6572 6e61 6c5f  bucket_external_
+0002e480: 6465 6c65 7469 6f6e 2873 656c 662c 2074  deletion(self, t
+0002e490: 6d70 5f73 6372 6174 6368 5f73 746f 7261  mp_scratch_stora
+0002e4a0: 6765 5f6f 626a 2c0a 2020 2020 2020 2020  ge_obj,.        
+0002e4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e4c0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0002e4d0: 6f72 655f 7479 7065 293a 0a20 2020 2020  ore_type):.     
+0002e4e0: 2020 2023 2043 7265 6174 6573 2061 2062     # Creates a b
+0002e4f0: 7563 6b65 742c 2064 656c 6574 6573 2069  ucket, deletes i
+0002e500: 7420 6578 7465 726e 616c 6c79 2075 7369  t externally usi
+0002e510: 6e67 2063 6c6f 7564 2063 6c69 2063 6f6d  ng cloud cli com
+0002e520: 6d61 6e64 730a 2020 2020 2020 2020 2320  mands.        # 
+0002e530: 616e 6420 7468 656e 2074 7269 6573 2074  and then tries t
+0002e540: 6f20 6465 6c65 7465 2069 7420 7573 696e  o delete it usin
+0002e550: 6720 736b 7920 7374 6f72 6167 6520 6465  g sky storage de
+0002e560: 6c65 7465 2e0a 2020 2020 2020 2020 746d  lete..        tm
+0002e570: 705f 7363 7261 7463 685f 7374 6f72 6167  p_scratch_storag
+0002e580: 655f 6f62 6a2e 6164 645f 7374 6f72 6528  e_obj.add_store(
+0002e590: 7374 6f72 655f 7479 7065 290a 0a20 2020  store_type)..   
+0002e5a0: 2020 2020 2023 2052 756e 2073 6b79 2073       # Run sky s
+0002e5b0: 746f 7261 6765 206c 7320 746f 2063 6865  torage ls to che
+0002e5c0: 636b 2069 6620 7374 6f72 6167 6520 6f62  ck if storage ob
+0002e5d0: 6a65 6374 2065 7869 7374 7320 696e 2074  ject exists in t
+0002e5e0: 6865 206f 7574 7075 740a 2020 2020 2020  he output.      
+0002e5f0: 2020 6f75 7420 3d20 7375 6270 726f 6365    out = subproce
+0002e600: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
+0002e610: 5b27 736b 7927 2c20 2773 746f 7261 6765  ['sky', 'storage
+0002e620: 272c 2027 6c73 275d 290a 2020 2020 2020  ', 'ls']).      
+0002e630: 2020 6173 7365 7274 2074 6d70 5f73 6372    assert tmp_scr
+0002e640: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
+0002e650: 2e6e 616d 6520 696e 206f 7574 2e64 6563  .name in out.dec
+0002e660: 6f64 6528 2775 7466 2d38 2729 0a0a 2020  ode('utf-8')..  
+0002e670: 2020 2020 2020 2320 4465 6c65 7465 2062        # Delete b
+0002e680: 7563 6b65 7420 6578 7465 726e 616c 6c79  ucket externally
+0002e690: 0a20 2020 2020 2020 2063 6d64 203d 2073  .        cmd = s
+0002e6a0: 656c 662e 636c 695f 6465 6c65 7465 5f63  elf.cli_delete_c
+0002e6b0: 6d64 2873 746f 7265 5f74 7970 652c 2074  md(store_type, t
+0002e6c0: 6d70 5f73 6372 6174 6368 5f73 746f 7261  mp_scratch_stora
+0002e6d0: 6765 5f6f 626a 2e6e 616d 6529 0a20 2020  ge_obj.name).   
+0002e6e0: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
+0002e6f0: 6368 6563 6b5f 6f75 7470 7574 2863 6d64  check_output(cmd
+0002e700: 2c20 7368 656c 6c3d 5472 7565 290a 0a20  , shell=True).. 
+0002e710: 2020 2020 2020 2023 2052 756e 2073 6b79         # Run sky
+0002e720: 2073 746f 7261 6765 2064 656c 6574 6520   storage delete 
+0002e730: 746f 2064 656c 6574 6520 7468 6520 7374  to delete the st
+0002e740: 6f72 6167 6520 6f62 6a65 6374 0a20 2020  orage object.   
+0002e750: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
+0002e760: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+0002e770: 7574 280a 2020 2020 2020 2020 2020 2020  ut(.            
+0002e780: 5b27 736b 7927 2c20 2773 746f 7261 6765  ['sky', 'storage
+0002e790: 272c 2027 6465 6c65 7465 272c 2074 6d70  ', 'delete', tmp
+0002e7a0: 5f73 6372 6174 6368 5f73 746f 7261 6765  _scratch_storage
+0002e7b0: 5f6f 626a 2e6e 616d 652c 2027 2d2d 7965  _obj.name, '--ye
+0002e7c0: 7327 5d29 0a20 2020 2020 2020 2023 204d  s']).        # M
+0002e7d0: 616b 6520 7375 7265 2062 7563 6b65 7420  ake sure bucket 
+0002e7e0: 7761 7320 6e6f 7420 6372 6561 7465 6420  was not created 
+0002e7f0: 6475 7269 6e67 2064 656c 6574 696f 6e20  during deletion 
+0002e800: 2873 6565 2069 7373 7565 2023 3133 3232  (see issue #1322
+0002e810: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+0002e820: 2027 6372 6561 7465 6427 206e 6f74 2069   'created' not i
+0002e830: 6e20 6f75 742e 6465 636f 6465 2827 7574  n out.decode('ut
+0002e840: 662d 3827 292e 6c6f 7765 7228 290a 0a20  f-8').lower().. 
+0002e850: 2020 2020 2020 2023 2052 756e 2073 6b79         # Run sky
+0002e860: 2073 746f 7261 6765 206c 7320 746f 2063   storage ls to c
+0002e870: 6865 636b 2069 6620 7374 6f72 6167 6520  heck if storage 
+0002e880: 6f62 6a65 6374 2069 7320 6465 6c65 7465  object is delete
+0002e890: 640a 2020 2020 2020 2020 6f75 7420 3d20  d.        out = 
+0002e8a0: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+0002e8b0: 5f6f 7574 7075 7428 5b27 736b 7927 2c20  _output(['sky', 
+0002e8c0: 2773 746f 7261 6765 272c 2027 6c73 275d  'storage', 'ls']
+0002e8d0: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+0002e8e0: 2074 6d70 5f73 6372 6174 6368 5f73 746f   tmp_scratch_sto
+0002e8f0: 7261 6765 5f6f 626a 2e6e 616d 6520 6e6f  rage_obj.name no
+0002e900: 7420 696e 206f 7574 2e64 6563 6f64 6528  t in out.decode(
+0002e910: 2775 7466 2d38 2729 0a0a 2020 2020 4070  'utf-8')..    @p
+0002e920: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
+0002e930: 7569 6473 7461 636b 0a20 2020 2040 7079  uidstack.    @py
+0002e940: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
+0002e950: 7472 697a 6528 2773 746f 7265 5f74 7970  trize('store_typ
+0002e960: 6527 2c20 5b0a 2020 2020 2020 2020 7374  e', [.        st
+0002e970: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002e980: 7970 652e 5333 2c20 7374 6f72 6167 655f  ype.S3, storage_
+0002e990: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
+0002e9a0: 532c 0a20 2020 2020 2020 2070 7974 6573  S,.        pytes
+0002e9b0: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
+0002e9c0: 6c69 622e 5374 6f72 6554 7970 652e 4942  lib.StoreType.IB
+0002e9d0: 4d2c 206d 6172 6b73 3d70 7974 6573 742e  M, marks=pytest.
+0002e9e0: 6d61 726b 2e69 626d 292c 0a20 2020 2020  mark.ibm),.     
+0002e9f0: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
+0002ea00: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002ea10: 6554 7970 652e 5232 2c20 6d61 726b 733d  eType.R2, marks=
+0002ea20: 7079 7465 7374 2e6d 6172 6b2e 636c 6f75  pytest.mark.clou
+0002ea30: 6466 6c61 7265 290a 2020 2020 5d29 0a20  dflare).    ]). 
+0002ea40: 2020 2064 6566 2074 6573 745f 6275 636b     def test_buck
+0002ea50: 6574 5f62 756c 6b5f 6465 6c65 7469 6f6e  et_bulk_deletion
+0002ea60: 2873 656c 662c 2073 746f 7265 5f74 7970  (self, store_typ
+0002ea70: 652c 2074 6d70 5f62 756c 6b5f 6465 6c5f  e, tmp_bulk_del_
+0002ea80: 7374 6f72 6167 655f 6f62 6a29 3a0a 2020  storage_obj):.  
+0002ea90: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
+0002eaa0: 6120 7465 6d70 2066 6f6c 6465 7220 7769  a temp folder wi
+0002eab0: 7468 206f 7665 7220 3235 3620 6669 6c65  th over 256 file
+0002eac0: 7320 616e 6420 666f 6c64 6572 732c 2075  s and folders, u
+0002ead0: 706c 6f61 640a 2020 2020 2020 2020 2320  pload.        # 
+0002eae0: 6669 6c65 7320 616e 6420 666f 6c64 6572  files and folder
+0002eaf0: 7320 746f 2061 206e 6577 2062 7563 6b65  s to a new bucke
+0002eb00: 742c 2074 6865 6e20 6465 6c65 7465 2062  t, then delete b
+0002eb10: 7563 6b65 742e 0a20 2020 2020 2020 2074  ucket..        t
+0002eb20: 6d70 5f62 756c 6b5f 6465 6c5f 7374 6f72  mp_bulk_del_stor
+0002eb30: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
+0002eb40: 6528 7374 6f72 655f 7479 7065 290a 0a20  e(store_type).. 
+0002eb50: 2020 2020 2020 2073 7562 7072 6f63 6573         subproces
+0002eb60: 732e 6368 6563 6b5f 6f75 7470 7574 285b  s.check_output([
+0002eb70: 0a20 2020 2020 2020 2020 2020 2027 736b  .            'sk
+0002eb80: 7927 2c20 2773 746f 7261 6765 272c 2027  y', 'storage', '
+0002eb90: 6465 6c65 7465 272c 2074 6d70 5f62 756c  delete', tmp_bul
+0002eba0: 6b5f 6465 6c5f 7374 6f72 6167 655f 6f62  k_del_storage_ob
+0002ebb0: 6a2e 6e61 6d65 2c20 272d 2d79 6573 270a  j.name, '--yes'.
+0002ebc0: 2020 2020 2020 2020 5d29 0a0a 2020 2020          ])..    
+0002ebd0: 2020 2020 6f75 7470 7574 203d 2073 7562      output = sub
+0002ebe0: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
+0002ebf0: 7470 7574 285b 2773 6b79 272c 2027 7374  tput(['sky', 'st
+0002ec00: 6f72 6167 6527 2c20 276c 7327 5d29 0a20  orage', 'ls']). 
+0002ec10: 2020 2020 2020 2061 7373 6572 7420 746d         assert tm
+0002ec20: 705f 6275 6c6b 5f64 656c 5f73 746f 7261  p_bulk_del_stora
+0002ec30: 6765 5f6f 626a 2e6e 616d 6520 6e6f 7420  ge_obj.name not 
+0002ec40: 696e 206f 7574 7075 742e 6465 636f 6465  in output.decode
+0002ec50: 2827 7574 662d 3827 290a 0a20 2020 2040  ('utf-8')..    @
+0002ec60: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
+0002ec70: 6c75 6964 7374 6163 6b0a 2020 2020 4070  luidstack.    @p
+0002ec80: 7974 6573 742e 6d61 726b 2e70 6172 616d  ytest.mark.param
+0002ec90: 6574 7269 7a65 280a 2020 2020 2020 2020  etrize(.        
+0002eca0: 2774 6d70 5f70 7562 6c69 635f 7374 6f72  'tmp_public_stor
+0002ecb0: 6167 655f 6f62 6a2c 2073 746f 7265 5f74  age_obj, store_t
+0002ecc0: 7970 6527 2c0a 2020 2020 2020 2020 5b28  ype',.        [(
+0002ecd0: 2773 333a 2f2f 7463 6761 2d32 2d6f 7065  's3://tcga-2-ope
+0002ece0: 6e27 2c20 7374 6f72 6167 655f 6c69 622e  n', storage_lib.
+0002ecf0: 5374 6f72 6554 7970 652e 5333 292c 0a20  StoreType.S3),. 
+0002ed00: 2020 2020 2020 2020 2827 7333 3a2f 2f64          ('s3://d
+0002ed10: 6967 6974 616c 636f 7270 6f72 6127 2c20  igitalcorpora', 
+0002ed20: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002ed30: 6554 7970 652e 5333 292c 0a20 2020 2020  eType.S3),.     
+0002ed40: 2020 2020 2827 6773 3a2f 2f67 6370 2d70      ('gs://gcp-p
+0002ed50: 7562 6c69 632d 6461 7461 2d73 656e 7469  ublic-data-senti
+0002ed60: 6e65 6c2d 3227 2c20 7374 6f72 6167 655f  nel-2', storage_
+0002ed70: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
+0002ed80: 5329 5d2c 0a20 2020 2020 2020 2069 6e64  S)],.        ind
+0002ed90: 6972 6563 743d 5b27 746d 705f 7075 626c  irect=['tmp_publ
+0002eda0: 6963 5f73 746f 7261 6765 5f6f 626a 275d  ic_storage_obj']
+0002edb0: 290a 2020 2020 6465 6620 7465 7374 5f70  ).    def test_p
+0002edc0: 7562 6c69 635f 6275 636b 6574 2873 656c  ublic_bucket(sel
+0002edd0: 662c 2074 6d70 5f70 7562 6c69 635f 7374  f, tmp_public_st
+0002ede0: 6f72 6167 655f 6f62 6a2c 2073 746f 7265  orage_obj, store
+0002edf0: 5f74 7970 6529 3a0a 2020 2020 2020 2020  _type):.        
+0002ee00: 2320 4372 6561 7465 7320 6120 6e65 7720  # Creates a new 
+0002ee10: 6275 636b 6574 2077 6974 6820 6120 7075  bucket with a pu
+0002ee20: 626c 6963 2073 6f75 7263 6520 616e 6420  blic source and 
+0002ee30: 7665 7269 6669 6573 2074 6861 7420 6974  verifies that it
+0002ee40: 2069 7320 6e6f 740a 2020 2020 2020 2020   is not.        
+0002ee50: 2320 6164 6465 6420 746f 2067 6c6f 6261  # added to globa
+0002ee60: 6c5f 7573 6572 5f73 7461 7465 2e0a 2020  l_user_state..  
+0002ee70: 2020 2020 2020 746d 705f 7075 626c 6963        tmp_public
+0002ee80: 5f73 746f 7261 6765 5f6f 626a 2e61 6464  _storage_obj.add
+0002ee90: 5f73 746f 7265 2873 746f 7265 5f74 7970  _store(store_typ
+0002eea0: 6529 0a0a 2020 2020 2020 2020 2320 5275  e)..        # Ru
+0002eeb0: 6e20 736b 7920 7374 6f72 6167 6520 6c73  n sky storage ls
+0002eec0: 2074 6f20 6368 6563 6b20 6966 2073 746f   to check if sto
+0002eed0: 7261 6765 206f 626a 6563 7420 6578 6973  rage object exis
+0002eee0: 7473 2069 6e20 7468 6520 6f75 7470 7574  ts in the output
+0002eef0: 0a20 2020 2020 2020 206f 7574 203d 2073  .        out = s
+0002ef00: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
+0002ef10: 6f75 7470 7574 285b 2773 6b79 272c 2027  output(['sky', '
+0002ef20: 7374 6f72 6167 6527 2c20 276c 7327 5d29  storage', 'ls'])
+0002ef30: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0002ef40: 746d 705f 7075 626c 6963 5f73 746f 7261  tmp_public_stora
+0002ef50: 6765 5f6f 626a 2e6e 616d 6520 6e6f 7420  ge_obj.name not 
+0002ef60: 696e 206f 7574 2e64 6563 6f64 6528 2775  in out.decode('u
+0002ef70: 7466 2d38 2729 0a0a 2020 2020 4070 7974  tf-8')..    @pyt
+0002ef80: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
+0002ef90: 6473 7461 636b 0a20 2020 2040 7079 7465  dstack.    @pyte
+0002efa0: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
+0002efb0: 697a 6528 276e 6f6e 6578 6973 745f 6275  ize('nonexist_bu
+0002efc0: 636b 6574 5f75 726c 272c 205b 0a20 2020  cket_url', [.   
+0002efd0: 2020 2020 2027 7333 3a2f 2f7b 7261 6e64       's3://{rand
+0002efe0: 6f6d 5f6e 616d 657d 272c 2027 6773 3a2f  om_name}', 'gs:/
+0002eff0: 2f7b 7261 6e64 6f6d 5f6e 616d 657d 272c  /{random_name}',
+0002f000: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
+0002f010: 7061 7261 6d28 2763 6f73 3a2f 2f75 732d  param('cos://us-
+0002f020: 6561 7374 2f7b 7261 6e64 6f6d 5f6e 616d  east/{random_nam
+0002f030: 657d 272c 206d 6172 6b73 3d70 7974 6573  e}', marks=pytes
+0002f040: 742e 6d61 726b 2e69 626d 292c 0a20 2020  t.mark.ibm),.   
+0002f050: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
+0002f060: 6d28 2772 323a 2f2f 7b72 616e 646f 6d5f  m('r2://{random_
+0002f070: 6e61 6d65 7d27 2c20 6d61 726b 733d 7079  name}', marks=py
+0002f080: 7465 7374 2e6d 6172 6b2e 636c 6f75 6466  test.mark.cloudf
+0002f090: 6c61 7265 290a 2020 2020 5d29 0a20 2020  lare).    ]).   
+0002f0a0: 2064 6566 2074 6573 745f 6e6f 6e65 7869   def test_nonexi
+0002f0b0: 7374 656e 745f 6275 636b 6574 2873 656c  stent_bucket(sel
+0002f0c0: 662c 206e 6f6e 6578 6973 745f 6275 636b  f, nonexist_buck
+0002f0d0: 6574 5f75 726c 293a 0a20 2020 2020 2020  et_url):.       
+0002f0e0: 2023 2041 7474 656d 7074 7320 746f 2063   # Attempts to c
+0002f0f0: 7265 6174 6520 6665 7463 6820 6120 7374  reate fetch a st
+0002f100: 726f 6167 6520 7769 7468 2061 206e 6f6e  roage with a non
+0002f110: 2d65 7869 7374 656e 7420 736f 7572 6365  -existent source
+0002f120: 2e0a 2020 2020 2020 2020 2320 4765 6e65  ..        # Gene
+0002f130: 7261 7465 2061 2072 616e 646f 6d20 6275  rate a random bu
+0002f140: 636b 6574 206e 616d 6520 616e 6420 7665  cket name and ve
+0002f150: 7269 6679 2069 7420 646f 6573 6e27 7420  rify it doesn't 
+0002f160: 6578 6973 743a 0a20 2020 2020 2020 2072  exist:.        r
+0002f170: 6574 7279 5f63 6f75 6e74 203d 2030 0a20  etry_count = 0. 
+0002f180: 2020 2020 2020 2077 6869 6c65 2054 7275         while Tru
+0002f190: 653a 0a20 2020 2020 2020 2020 2020 206e  e:.            n
+0002f1a0: 6f6e 6578 6973 745f 6275 636b 6574 5f6e  onexist_bucket_n
+0002f1b0: 616d 6520 3d20 7374 7228 7575 6964 2e75  ame = str(uuid.u
+0002f1c0: 7569 6434 2829 290a 2020 2020 2020 2020  uid4()).        
+0002f1d0: 2020 2020 6966 206e 6f6e 6578 6973 745f      if nonexist_
+0002f1e0: 6275 636b 6574 5f75 726c 2e73 7461 7274  bucket_url.start
+0002f1f0: 7377 6974 6828 2773 3327 293a 0a20 2020  swith('s3'):.   
+0002f200: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
+0002f210: 6d61 6e64 203d 2066 2761 7773 2073 3361  mand = f'aws s3a
+0002f220: 7069 2068 6561 642d 6275 636b 6574 202d  pi head-bucket -
+0002f230: 2d62 7563 6b65 7420 7b6e 6f6e 6578 6973  -bucket {nonexis
+0002f240: 745f 6275 636b 6574 5f6e 616d 657d 270a  t_bucket_name}'.
+0002f250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f260: 6578 7065 6374 6564 5f6f 7574 7075 7420  expected_output 
+0002f270: 3d20 2734 3034 270a 2020 2020 2020 2020  = '404'.        
+0002f280: 2020 2020 656c 6966 206e 6f6e 6578 6973      elif nonexis
+0002f290: 745f 6275 636b 6574 5f75 726c 2e73 7461  t_bucket_url.sta
+0002f2a0: 7274 7377 6974 6828 2767 7327 293a 0a20  rtswith('gs'):. 
+0002f2b0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0002f2c0: 6f6d 6d61 6e64 203d 2066 2767 7375 7469  ommand = f'gsuti
+0002f2d0: 6c20 6c73 207b 6e6f 6e65 7869 7374 5f62  l ls {nonexist_b
+0002f2e0: 7563 6b65 745f 7572 6c2e 666f 726d 6174  ucket_url.format
+0002f2f0: 2872 616e 646f 6d5f 6e61 6d65 3d6e 6f6e  (random_name=non
+0002f300: 6578 6973 745f 6275 636b 6574 5f6e 616d  exist_bucket_nam
+0002f310: 6529 7d27 0a20 2020 2020 2020 2020 2020  e)}'.           
+0002f320: 2020 2020 2065 7870 6563 7465 645f 6f75       expected_ou
+0002f330: 7470 7574 203d 2027 4275 636b 6574 4e6f  tput = 'BucketNo
+0002f340: 7446 6f75 6e64 4578 6365 7074 696f 6e27  tFoundException'
+0002f350: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+0002f360: 6620 6e6f 6e65 7869 7374 5f62 7563 6b65  f nonexist_bucke
+0002f370: 745f 7572 6c2e 7374 6172 7473 7769 7468  t_url.startswith
+0002f380: 2827 7232 2729 3a0a 2020 2020 2020 2020  ('r2'):.        
+0002f390: 2020 2020 2020 2020 656e 6470 6f69 6e74          endpoint
+0002f3a0: 5f75 726c 203d 2063 6c6f 7564 666c 6172  _url = cloudflar
+0002f3b0: 652e 6372 6561 7465 5f65 6e64 706f 696e  e.create_endpoin
+0002f3c0: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+0002f3d0: 2020 2020 636f 6d6d 616e 6420 3d20 6627      command = f'
+0002f3e0: 4157 535f 5348 4152 4544 5f43 5245 4445  AWS_SHARED_CREDE
+0002f3f0: 4e54 4941 4c53 5f46 494c 453d 7b63 6c6f  NTIALS_FILE={clo
+0002f400: 7564 666c 6172 652e 5232 5f43 5245 4445  udflare.R2_CREDE
+0002f410: 4e54 4941 4c53 5f50 4154 487d 2061 7773  NTIALS_PATH} aws
+0002f420: 2073 3361 7069 2068 6561 642d 6275 636b   s3api head-buck
+0002f430: 6574 202d 2d62 7563 6b65 7420 7b6e 6f6e  et --bucket {non
+0002f440: 6578 6973 745f 6275 636b 6574 5f6e 616d  exist_bucket_nam
+0002f450: 657d 202d 2d65 6e64 706f 696e 7420 7b65  e} --endpoint {e
+0002f460: 6e64 706f 696e 745f 7572 6c7d 202d 2d70  ndpoint_url} --p
+0002f470: 726f 6669 6c65 3d72 3227 0a20 2020 2020  rofile=r2'.     
+0002f480: 2020 2020 2020 2020 2020 2065 7870 6563             expec
+0002f490: 7465 645f 6f75 7470 7574 203d 2027 3430  ted_output = '40
+0002f4a0: 3427 0a20 2020 2020 2020 2020 2020 2065  4'.            e
+0002f4b0: 6c69 6620 6e6f 6e65 7869 7374 5f62 7563  lif nonexist_buc
+0002f4c0: 6b65 745f 7572 6c2e 7374 6172 7473 7769  ket_url.startswi
+0002f4d0: 7468 2827 636f 7327 293a 0a20 2020 2020  th('cos'):.     
+0002f4e0: 2020 2020 2020 2020 2020 2023 2055 7369             # Usi
+0002f4f0: 6e67 2041 5049 2063 616c 6c73 2c20 7369  ng API calls, si
+0002f500: 6e63 6520 7573 696e 6720 7263 6c6f 6e65  nce using rclone
+0002f510: 2072 6571 7569 7265 7320 6120 7072 6f66   requires a prof
+0002f520: 696c 6527 7320 6e61 6d65 0a20 2020 2020  ile's name.     
+0002f530: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+0002f540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f550: 2020 2020 6578 7065 6374 6564 5f6f 7574      expected_out
+0002f560: 7075 7420 3d20 636f 6d6d 616e 6420 3d20  put = command = 
+0002f570: 2265 6368 6f22 2020 2320 6176 6f69 6420  "echo"  # avoid 
+0002f580: 756e 7265 6c61 7465 6420 6578 6365 7074  unrelated except
+0002f590: 696f 6e20 696e 2063 6173 6520 6f66 2066  ion in case of f
+0002f5a0: 6169 6c75 7265 2e0a 2020 2020 2020 2020  ailure..        
+0002f5b0: 2020 2020 2020 2020 2020 2020 6275 636b              buck
+0002f5c0: 6574 5f6e 616d 6520 3d20 7572 6c6c 6962  et_name = urllib
+0002f5d0: 2e70 6172 7365 2e75 726c 7370 6c69 7428  .parse.urlsplit(
+0002f5e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f5f0: 2020 2020 2020 2020 206e 6f6e 6578 6973           nonexis
+0002f600: 745f 6275 636b 6574 5f75 726c 2e66 6f72  t_bucket_url.for
+0002f610: 6d61 7428 0a20 2020 2020 2020 2020 2020  mat(.           
+0002f620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f630: 2072 616e 646f 6d5f 6e61 6d65 3d6e 6f6e   random_name=non
+0002f640: 6578 6973 745f 6275 636b 6574 5f6e 616d  exist_bucket_nam
+0002f650: 6529 292e 7061 7468 2e73 7472 6970 2827  e)).path.strip('
+0002f660: 2f27 290a 2020 2020 2020 2020 2020 2020  /').            
+0002f670: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
+0002f680: 2069 626d 2e67 6574 5f63 6f73 5f63 6c69   ibm.get_cos_cli
+0002f690: 656e 7428 2775 732d 6561 7374 2729 0a20  ent('us-east'). 
+0002f6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f6b0: 2020 2063 6c69 656e 742e 6865 6164 5f62     client.head_b
+0002f6c0: 7563 6b65 7428 4275 636b 6574 3d62 7563  ucket(Bucket=buc
+0002f6d0: 6b65 745f 6e61 6d65 290a 2020 2020 2020  ket_name).      
+0002f6e0: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0002f6f0: 2069 626d 2e69 626d 5f62 6f74 6f63 6f72   ibm.ibm_botocor
+0002f700: 652e 6578 6365 7074 696f 6e73 2e43 6c69  e.exceptions.Cli
+0002f710: 656e 7445 7272 6f72 2061 7320 653a 0a20  entError as e:. 
+0002f720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f730: 2020 2069 6620 652e 7265 7370 6f6e 7365     if e.response
+0002f740: 5b27 4572 726f 7227 5d5b 2743 6f64 6527  ['Error']['Code'
+0002f750: 5d20 3d3d 2027 3430 3427 3a0a 2020 2020  ] == '404':.    
+0002f760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f770: 2020 2020 2320 7375 6363 6573 730a 2020      # success.  
+0002f780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f790: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+0002f7a0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0002f7b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0002f7c0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+0002f7d0: 2755 6e73 7570 706f 7274 6564 2062 7563  'Unsupported buc
+0002f7e0: 6b65 7420 7479 7065 2027 0a20 2020 2020  ket type '.     
+0002f7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f800: 2020 2020 2020 2020 2020 2020 6627 7b6e              f'{n
+0002f810: 6f6e 6578 6973 745f 6275 636b 6574 5f75  onexist_bucket_u
+0002f820: 726c 7d27 290a 0a20 2020 2020 2020 2020  rl}')..         
+0002f830: 2020 2023 2043 6865 636b 2069 6620 6275     # Check if bu
+0002f840: 636b 6574 2065 7869 7374 7320 7573 696e  cket exists usin
+0002f850: 6720 7468 6520 636c 693a 0a20 2020 2020  g the cli:.     
+0002f860: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0002f870: 2020 2020 2020 2020 2020 2020 6f75 7420              out 
+0002f880: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
+0002f890: 636b 5f6f 7574 7075 7428 636f 6d6d 616e  ck_output(comman
+0002f8a0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0002f8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f8d0: 2073 7464 6572 723d 7375 6270 726f 6365   stderr=subproce
+0002f8e0: 7373 2e53 5444 4f55 542c 0a20 2020 2020  ss.STDOUT,.     
 0002f8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f900: 2020 2073 6865 6c6c 3d54 7275 6529 0a20     shell=True). 
-0002f910: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-0002f920: 7420 7375 6270 726f 6365 7373 2e43 616c  t subprocess.Cal
-0002f930: 6c65 6450 726f 6365 7373 4572 726f 7220  ledProcessError 
-0002f940: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-0002f950: 2020 2020 2020 6f75 7420 3d20 652e 6f75        out = e.ou
-0002f960: 7470 7574 0a20 2020 2020 2020 2020 2020  tput.           
-0002f970: 206f 7574 203d 206f 7574 2e64 6563 6f64   out = out.decod
-0002f980: 6528 2775 7466 2d38 2729 0a20 2020 2020  e('utf-8').     
-0002f990: 2020 2020 2020 2069 6620 6578 7065 6374         if expect
-0002f9a0: 6564 5f6f 7574 7075 7420 696e 206f 7574  ed_output in out
-0002f9b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002f9c0: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
-0002f9d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0002f9e0: 2020 2020 2020 2020 2020 7265 7472 795f            retry_
-0002f9f0: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
-0002fa00: 2020 2020 2020 2020 2020 2069 6620 7265             if re
-0002fa10: 7472 795f 636f 756e 7420 3e20 333a 0a20  try_count > 3:. 
-0002fa20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fa30: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
-0002fa40: 4572 726f 7228 2755 6e61 626c 6520 746f  Error('Unable to
-0002fa50: 2066 696e 6420 6120 6e6f 6e65 7869 7374   find a nonexist
-0002fa60: 656e 7420 6275 636b 6574 2027 0a20 2020  ent bucket '.   
-0002fa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fa80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fa90: 2020 2020 2774 6f20 7573 652e 2054 6869      'to use. Thi
-0002faa0: 7320 6973 2068 6967 6c79 2075 6e6c 696b  s is higly unlik
-0002fab0: 656c 7920 2d20 270a 2020 2020 2020 2020  ely - '.        
-0002fac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fad0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0002fae0: 6368 6563 6b20 6966 2074 6865 2074 6573  check if the tes
-0002faf0: 7473 2061 7265 2063 6f72 7265 6374 2e27  ts are correct.'
-0002fb00: 290a 0a20 2020 2020 2020 2077 6974 6820  )..        with 
-0002fb10: 7079 7465 7374 2e72 6169 7365 7328 0a20  pytest.raises(. 
-0002fb20: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002fb30: 6b79 2e65 7863 6570 7469 6f6e 732e 5374  ky.exceptions.St
-0002fb40: 6f72 6167 6542 7563 6b65 7447 6574 4572  orageBucketGetEr
-0002fb50: 726f 722c 0a20 2020 2020 2020 2020 2020  ror,.           
-0002fb60: 2020 2020 206d 6174 6368 3d27 4174 7465       match='Atte
-0002fb70: 6d70 7465 6420 746f 2075 7365 2061 206e  mpted to use a n
-0002fb80: 6f6e 2d65 7869 7374 656e 7420 6275 636b  on-existent buck
-0002fb90: 6574 2061 7320 6120 736f 7572 6365 2729  et as a source')
-0002fba0: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
-0002fbb0: 6f72 6167 655f 6f62 6a20 3d20 7374 6f72  orage_obj = stor
-0002fbc0: 6167 655f 6c69 622e 5374 6f72 6167 6528  age_lib.Storage(
-0002fbd0: 736f 7572 6365 3d6e 6f6e 6578 6973 745f  source=nonexist_
-0002fbe0: 6275 636b 6574 5f75 726c 2e66 6f72 6d61  bucket_url.forma
-0002fbf0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-0002fc00: 2020 2072 616e 646f 6d5f 6e61 6d65 3d6e     random_name=n
-0002fc10: 6f6e 6578 6973 745f 6275 636b 6574 5f6e  onexist_bucket_n
-0002fc20: 616d 6529 290a 0a20 2020 2040 7079 7465  ame))..    @pyte
-0002fc30: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
-0002fc40: 7374 6163 6b0a 2020 2020 4070 7974 6573  stack.    @pytes
-0002fc50: 742e 6d61 726b 2e70 6172 616d 6574 7269  t.mark.parametri
-0002fc60: 7a65 2827 7072 6976 6174 655f 6275 636b  ze('private_buck
-0002fc70: 6574 272c 205b 0a20 2020 2020 2020 2066  et', [.        f
-0002fc80: 2773 333a 2f2f 696d 6167 656e 6574 272c  's3://imagenet',
-0002fc90: 2066 2767 733a 2f2f 696d 6167 656e 6574   f'gs://imagenet
-0002fca0: 272c 0a20 2020 2020 2020 2070 7974 6573  ',.        pytes
-0002fcb0: 742e 7061 7261 6d28 2763 6f73 3a2f 2f75  t.param('cos://u
-0002fcc0: 732d 6561 7374 2f62 7563 6b65 7431 272c  s-east/bucket1',
-0002fcd0: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-0002fce0: 726b 2e69 626d 290a 2020 2020 5d29 0a20  rk.ibm).    ]). 
-0002fcf0: 2020 2064 6566 2074 6573 745f 7072 6976     def test_priv
-0002fd00: 6174 655f 6275 636b 6574 2873 656c 662c  ate_bucket(self,
-0002fd10: 2070 7269 7661 7465 5f62 7563 6b65 7429   private_bucket)
-0002fd20: 3a0a 2020 2020 2020 2020 2320 4174 7465  :.        # Atte
-0002fd30: 6d70 7473 2074 6f20 6163 6365 7373 2070  mpts to access p
-0002fd40: 7269 7661 7465 2062 7563 6b65 7473 206e  rivate buckets n
-0002fd50: 6f74 2062 656c 6f6e 6769 6e67 2074 6f20  ot belonging to 
-0002fd60: 7468 6520 7573 6572 2e0a 2020 2020 2020  the user..      
-0002fd70: 2020 2320 5468 6573 6520 6275 636b 6574    # These bucket
-0002fd80: 7320 6172 6520 6b6e 6f77 6e20 746f 2062  s are known to b
-0002fd90: 6520 7072 6976 6174 652c 2062 7574 206d  e private, but m
-0002fda0: 6179 206e 6565 6420 746f 2062 6520 7570  ay need to be up
-0002fdb0: 6461 7465 6420 6966 0a20 2020 2020 2020  dated if.       
-0002fdc0: 2023 2074 6865 7920 6172 6520 7265 6d6f   # they are remo
-0002fdd0: 7665 6420 6279 2074 6865 6972 206f 776e  ved by their own
-0002fde0: 6572 732e 0a20 2020 2020 2020 2070 7269  ers..        pri
-0002fdf0: 7661 7465 5f62 7563 6b65 745f 6e61 6d65  vate_bucket_name
-0002fe00: 203d 2075 726c 6c69 622e 7061 7273 652e   = urllib.parse.
-0002fe10: 7572 6c73 706c 6974 2870 7269 7661 7465  urlsplit(private
-0002fe20: 5f62 7563 6b65 7429 2e6e 6574 6c6f 6320  _bucket).netloc 
-0002fe30: 6966 205c 0a20 2020 2020 2020 2020 2020  if \.           
-0002fe40: 2020 2075 726c 6c69 622e 7061 7273 652e     urllib.parse.
-0002fe50: 7572 6c73 706c 6974 2870 7269 7661 7465  urlsplit(private
-0002fe60: 5f62 7563 6b65 7429 2e73 6368 656d 6520  _bucket).scheme 
-0002fe70: 213d 2027 636f 7327 2065 6c73 6520 5c0a  != 'cos' else \.
-0002fe80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fe90: 2020 7572 6c6c 6962 2e70 6172 7365 2e75    urllib.parse.u
-0002fea0: 726c 7370 6c69 7428 7072 6976 6174 655f  rlsplit(private_
-0002feb0: 6275 636b 6574 292e 7061 7468 2e73 7472  bucket).path.str
-0002fec0: 6970 2827 2f27 290a 2020 2020 2020 2020  ip('/').        
-0002fed0: 7769 7468 2070 7974 6573 742e 7261 6973  with pytest.rais
-0002fee0: 6573 280a 2020 2020 2020 2020 2020 2020  es(.            
-0002fef0: 2020 2020 736b 792e 6578 6365 7074 696f      sky.exceptio
-0002ff00: 6e73 2e53 746f 7261 6765 4275 636b 6574  ns.StorageBucket
-0002ff10: 4765 7445 7272 6f72 2c0a 2020 2020 2020  GetError,.      
-0002ff20: 2020 2020 2020 2020 2020 6d61 7463 683d            match=
-0002ff30: 7374 6f72 6167 655f 6c69 622e 5f42 5543  storage_lib._BUC
-0002ff40: 4b45 545f 4641 494c 5f54 4f5f 434f 4e4e  KET_FAIL_TO_CONN
-0002ff50: 4543 545f 4d45 5353 4147 452e 666f 726d  ECT_MESSAGE.form
-0002ff60: 6174 280a 2020 2020 2020 2020 2020 2020  at(.            
-0002ff70: 2020 2020 2020 2020 6e61 6d65 3d70 7269          name=pri
-0002ff80: 7661 7465 5f62 7563 6b65 745f 6e61 6d65  vate_bucket_name
-0002ff90: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-0002ffa0: 7374 6f72 6167 655f 6f62 6a20 3d20 7374  storage_obj = st
-0002ffb0: 6f72 6167 655f 6c69 622e 5374 6f72 6167  orage_lib.Storag
-0002ffc0: 6528 736f 7572 6365 3d70 7269 7661 7465  e(source=private
-0002ffd0: 5f62 7563 6b65 7429 0a0a 2020 2020 4070  _bucket)..    @p
-0002ffe0: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
-0002fff0: 7569 6473 7461 636b 0a20 2020 2040 7079  uidstack.    @py
-00030000: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
-00030010: 7472 697a 6528 2765 7874 5f62 7563 6b65  trize('ext_bucke
-00030020: 745f 6669 7874 7572 652c 2073 746f 7265  t_fixture, store
-00030030: 5f74 7970 6527 2c0a 2020 2020 2020 2020  _type',.        
-00030040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030050: 2020 2020 205b 2827 746d 705f 6177 7363       [('tmp_awsc
-00030060: 6c69 5f62 7563 6b65 7427 2c20 7374 6f72  li_bucket', stor
-00030070: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-00030080: 652e 5333 292c 0a20 2020 2020 2020 2020  e.S3),.         
-00030090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000300a0: 2020 2020 2028 2774 6d70 5f67 7375 7469       ('tmp_gsuti
-000300b0: 6c5f 6275 636b 6574 272c 2073 746f 7261  l_bucket', stora
-000300c0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-000300d0: 2e47 4353 292c 0a20 2020 2020 2020 2020  .GCS),.         
-000300e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000300f0: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
-00030100: 6d28 2774 6d70 5f69 626d 5f63 6f73 5f62  m('tmp_ibm_cos_b
-00030110: 7563 6b65 7427 2c0a 2020 2020 2020 2020  ucket',.        
-00030120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f910: 2020 2020 2020 2020 2073 6865 6c6c 3d54           shell=T
+0002f920: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
+0002f930: 2065 7863 6570 7420 7375 6270 726f 6365   except subproce
+0002f940: 7373 2e43 616c 6c65 6450 726f 6365 7373  ss.CalledProcess
+0002f950: 4572 726f 7220 6173 2065 3a0a 2020 2020  Error as e:.    
+0002f960: 2020 2020 2020 2020 2020 2020 6f75 7420              out 
+0002f970: 3d20 652e 6f75 7470 7574 0a20 2020 2020  = e.output.     
+0002f980: 2020 2020 2020 206f 7574 203d 206f 7574         out = out
+0002f990: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+0002f9a0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0002f9b0: 6578 7065 6374 6564 5f6f 7574 7075 7420  expected_output 
+0002f9c0: 696e 206f 7574 3a0a 2020 2020 2020 2020  in out:.        
+0002f9d0: 2020 2020 2020 2020 6272 6561 6b0a 2020          break.  
+0002f9e0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0002f9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fa00: 7265 7472 795f 636f 756e 7420 2b3d 2031  retry_count += 1
+0002fa10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002fa20: 2069 6620 7265 7472 795f 636f 756e 7420   if retry_count 
+0002fa30: 3e20 333a 0a20 2020 2020 2020 2020 2020  > 3:.           
+0002fa40: 2020 2020 2020 2020 2072 6169 7365 2052           raise R
+0002fa50: 756e 7469 6d65 4572 726f 7228 2755 6e61  untimeError('Una
+0002fa60: 626c 6520 746f 2066 696e 6420 6120 6e6f  ble to find a no
+0002fa70: 6e65 7869 7374 656e 7420 6275 636b 6574  nexistent bucket
+0002fa80: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0002fa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002faa0: 2020 2020 2020 2020 2020 2774 6f20 7573            'to us
+0002fab0: 652e 2054 6869 7320 6973 2068 6967 6c79  e. This is higly
+0002fac0: 2075 6e6c 696b 656c 7920 2d20 270a 2020   unlikely - '.  
+0002fad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002faf0: 2020 2020 2027 6368 6563 6b20 6966 2074       'check if t
+0002fb00: 6865 2074 6573 7473 2061 7265 2063 6f72  he tests are cor
+0002fb10: 7265 6374 2e27 290a 0a20 2020 2020 2020  rect.')..       
+0002fb20: 2077 6974 6820 7079 7465 7374 2e72 6169   with pytest.rai
+0002fb30: 7365 7328 0a20 2020 2020 2020 2020 2020  ses(.           
+0002fb40: 2020 2020 2073 6b79 2e65 7863 6570 7469       sky.excepti
+0002fb50: 6f6e 732e 5374 6f72 6167 6542 7563 6b65  ons.StorageBucke
+0002fb60: 7447 6574 4572 726f 722c 0a20 2020 2020  tGetError,.     
+0002fb70: 2020 2020 2020 2020 2020 206d 6174 6368             match
+0002fb80: 3d27 4174 7465 6d70 7465 6420 746f 2075  ='Attempted to u
+0002fb90: 7365 2061 206e 6f6e 2d65 7869 7374 656e  se a non-existen
+0002fba0: 7420 6275 636b 6574 2061 7320 6120 736f  t bucket as a so
+0002fbb0: 7572 6365 2729 3a0a 2020 2020 2020 2020  urce'):.        
+0002fbc0: 2020 2020 7374 6f72 6167 655f 6f62 6a20      storage_obj 
+0002fbd0: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
+0002fbe0: 6f72 6167 6528 736f 7572 6365 3d6e 6f6e  orage(source=non
+0002fbf0: 6578 6973 745f 6275 636b 6574 5f75 726c  exist_bucket_url
+0002fc00: 2e66 6f72 6d61 7428 0a20 2020 2020 2020  .format(.       
+0002fc10: 2020 2020 2020 2020 2072 616e 646f 6d5f           random_
+0002fc20: 6e61 6d65 3d6e 6f6e 6578 6973 745f 6275  name=nonexist_bu
+0002fc30: 636b 6574 5f6e 616d 6529 290a 0a20 2020  cket_name))..   
+0002fc40: 2040 7079 7465 7374 2e6d 6172 6b2e 6e6f   @pytest.mark.no
+0002fc50: 5f66 6c75 6964 7374 6163 6b0a 2020 2020  _fluidstack.    
+0002fc60: 4070 7974 6573 742e 6d61 726b 2e70 6172  @pytest.mark.par
+0002fc70: 616d 6574 7269 7a65 2827 7072 6976 6174  ametrize('privat
+0002fc80: 655f 6275 636b 6574 272c 205b 0a20 2020  e_bucket', [.   
+0002fc90: 2020 2020 2066 2773 333a 2f2f 696d 6167       f's3://imag
+0002fca0: 656e 6574 272c 2066 2767 733a 2f2f 696d  enet', f'gs://im
+0002fcb0: 6167 656e 6574 272c 0a20 2020 2020 2020  agenet',.       
+0002fcc0: 2070 7974 6573 742e 7061 7261 6d28 2763   pytest.param('c
+0002fcd0: 6f73 3a2f 2f75 732d 6561 7374 2f62 7563  os://us-east/buc
+0002fce0: 6b65 7431 272c 206d 6172 6b73 3d70 7974  ket1', marks=pyt
+0002fcf0: 6573 742e 6d61 726b 2e69 626d 290a 2020  est.mark.ibm).  
+0002fd00: 2020 5d29 0a20 2020 2064 6566 2074 6573    ]).    def tes
+0002fd10: 745f 7072 6976 6174 655f 6275 636b 6574  t_private_bucket
+0002fd20: 2873 656c 662c 2070 7269 7661 7465 5f62  (self, private_b
+0002fd30: 7563 6b65 7429 3a0a 2020 2020 2020 2020  ucket):.        
+0002fd40: 2320 4174 7465 6d70 7473 2074 6f20 6163  # Attempts to ac
+0002fd50: 6365 7373 2070 7269 7661 7465 2062 7563  cess private buc
+0002fd60: 6b65 7473 206e 6f74 2062 656c 6f6e 6769  kets not belongi
+0002fd70: 6e67 2074 6f20 7468 6520 7573 6572 2e0a  ng to the user..
+0002fd80: 2020 2020 2020 2020 2320 5468 6573 6520          # These 
+0002fd90: 6275 636b 6574 7320 6172 6520 6b6e 6f77  buckets are know
+0002fda0: 6e20 746f 2062 6520 7072 6976 6174 652c  n to be private,
+0002fdb0: 2062 7574 206d 6179 206e 6565 6420 746f   but may need to
+0002fdc0: 2062 6520 7570 6461 7465 6420 6966 0a20   be updated if. 
+0002fdd0: 2020 2020 2020 2023 2074 6865 7920 6172         # they ar
+0002fde0: 6520 7265 6d6f 7665 6420 6279 2074 6865  e removed by the
+0002fdf0: 6972 206f 776e 6572 732e 0a20 2020 2020  ir owners..     
+0002fe00: 2020 2070 7269 7661 7465 5f62 7563 6b65     private_bucke
+0002fe10: 745f 6e61 6d65 203d 2075 726c 6c69 622e  t_name = urllib.
+0002fe20: 7061 7273 652e 7572 6c73 706c 6974 2870  parse.urlsplit(p
+0002fe30: 7269 7661 7465 5f62 7563 6b65 7429 2e6e  rivate_bucket).n
+0002fe40: 6574 6c6f 6320 6966 205c 0a20 2020 2020  etloc if \.     
+0002fe50: 2020 2020 2020 2020 2075 726c 6c69 622e           urllib.
+0002fe60: 7061 7273 652e 7572 6c73 706c 6974 2870  parse.urlsplit(p
+0002fe70: 7269 7661 7465 5f62 7563 6b65 7429 2e73  rivate_bucket).s
+0002fe80: 6368 656d 6520 213d 2027 636f 7327 2065  cheme != 'cos' e
+0002fe90: 6c73 6520 5c0a 2020 2020 2020 2020 2020  lse \.          
+0002fea0: 2020 2020 2020 2020 7572 6c6c 6962 2e70          urllib.p
+0002feb0: 6172 7365 2e75 726c 7370 6c69 7428 7072  arse.urlsplit(pr
+0002fec0: 6976 6174 655f 6275 636b 6574 292e 7061  ivate_bucket).pa
+0002fed0: 7468 2e73 7472 6970 2827 2f27 290a 2020  th.strip('/').  
+0002fee0: 2020 2020 2020 7769 7468 2070 7974 6573        with pytes
+0002fef0: 742e 7261 6973 6573 280a 2020 2020 2020  t.raises(.      
+0002ff00: 2020 2020 2020 2020 2020 736b 792e 6578            sky.ex
+0002ff10: 6365 7074 696f 6e73 2e53 746f 7261 6765  ceptions.Storage
+0002ff20: 4275 636b 6574 4765 7445 7272 6f72 2c0a  BucketGetError,.
+0002ff30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ff40: 6d61 7463 683d 7374 6f72 6167 655f 6c69  match=storage_li
+0002ff50: 622e 5f42 5543 4b45 545f 4641 494c 5f54  b._BUCKET_FAIL_T
+0002ff60: 4f5f 434f 4e4e 4543 545f 4d45 5353 4147  O_CONNECT_MESSAG
+0002ff70: 452e 666f 726d 6174 280a 2020 2020 2020  E.format(.      
+0002ff80: 2020 2020 2020 2020 2020 2020 2020 6e61                na
+0002ff90: 6d65 3d70 7269 7661 7465 5f62 7563 6b65  me=private_bucke
+0002ffa0: 745f 6e61 6d65 2929 3a0a 2020 2020 2020  t_name)):.      
+0002ffb0: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
+0002ffc0: 6a20 3d20 7374 6f72 6167 655f 6c69 622e  j = storage_lib.
+0002ffd0: 5374 6f72 6167 6528 736f 7572 6365 3d70  Storage(source=p
+0002ffe0: 7269 7661 7465 5f62 7563 6b65 7429 0a0a  rivate_bucket)..
+0002fff0: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
+00030000: 2e6e 6f5f 666c 7569 6473 7461 636b 0a20  .no_fluidstack. 
+00030010: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
+00030020: 7061 7261 6d65 7472 697a 6528 2765 7874  parametrize('ext
+00030030: 5f62 7563 6b65 745f 6669 7874 7572 652c  _bucket_fixture,
+00030040: 2073 746f 7265 5f74 7970 6527 2c0a 2020   store_type',.  
+00030050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030060: 2020 2020 2020 2020 2020 205b 2827 746d             [('tm
+00030070: 705f 6177 7363 6c69 5f62 7563 6b65 7427  p_awscli_bucket'
+00030080: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
+00030090: 6f72 6554 7970 652e 5333 292c 0a20 2020  oreType.S3),.   
+000300a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000300b0: 2020 2020 2020 2020 2020 2028 2774 6d70             ('tmp
+000300c0: 5f67 7375 7469 6c5f 6275 636b 6574 272c  _gsutil_bucket',
+000300d0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+000300e0: 7265 5479 7065 2e47 4353 292c 0a20 2020  reType.GCS),.   
+000300f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030100: 2020 2020 2020 2020 2020 2070 7974 6573             pytes
+00030110: 742e 7061 7261 6d28 2774 6d70 5f69 626d  t.param('tmp_ibm
+00030120: 5f63 6f73 5f62 7563 6b65 7427 2c0a 2020  _cos_bucket',.  
 00030130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030140: 2020 2073 746f 7261 6765 5f6c 6962 2e53     storage_lib.S
-00030150: 746f 7265 5479 7065 2e49 424d 2c0a 2020  toreType.IBM,.  
-00030160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030180: 2020 2020 2020 2020 206d 6172 6b73 3d70           marks=p
-00030190: 7974 6573 742e 6d61 726b 2e69 626d 292c  ytest.mark.ibm),
-000301a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000301b0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000301c0: 7974 6573 742e 7061 7261 6d28 2774 6d70  ytest.param('tmp
-000301d0: 5f61 7773 636c 695f 6275 636b 6574 5f72  _awscli_bucket_r
-000301e0: 3227 2c0a 2020 2020 2020 2020 2020 2020  2',.            
-000301f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030200: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00030210: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-00030220: 5479 7065 2e52 322c 0a20 2020 2020 2020  Type.R2,.       
-00030230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030150: 2020 2020 2020 2020 2073 746f 7261 6765           storage
+00030160: 5f6c 6962 2e53 746f 7265 5479 7065 2e49  _lib.StoreType.I
+00030170: 424d 2c0a 2020 2020 2020 2020 2020 2020  BM,.            
+00030180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030190: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+000301a0: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
+000301b0: 2e69 626d 292c 0a20 2020 2020 2020 2020  .ibm),.         
+000301c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000301d0: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
+000301e0: 6d28 2774 6d70 5f61 7773 636c 695f 6275  m('tmp_awscli_bu
+000301f0: 636b 6574 5f72 3227 2c0a 2020 2020 2020  cket_r2',.      
+00030200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030220: 2020 2020 2073 746f 7261 6765 5f6c 6962       storage_lib
+00030230: 2e53 746f 7265 5479 7065 2e52 322c 0a20  .StoreType.R2,. 
 00030240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030250: 2020 2020 6d61 726b 733d 7079 7465 7374      marks=pytest
-00030260: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
-00030270: 295d 290a 2020 2020 6465 6620 7465 7374  )]).    def test
-00030280: 5f75 706c 6f61 645f 746f 5f65 7869 7374  _upload_to_exist
-00030290: 696e 675f 6275 636b 6574 2873 656c 662c  ing_bucket(self,
-000302a0: 2065 7874 5f62 7563 6b65 745f 6669 7874   ext_bucket_fixt
-000302b0: 7572 652c 2072 6571 7565 7374 2c0a 2020  ure, request,.  
-000302c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000302d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000302e0: 2020 2020 2074 6d70 5f73 6f75 7263 652c       tmp_source,
-000302f0: 2073 746f 7265 5f74 7970 6529 3a0a 2020   store_type):.  
-00030300: 2020 2020 2020 2320 5472 6965 7320 7570        # Tries up
-00030310: 6c6f 6164 696e 6720 6578 6973 7469 6e67  loading existing
-00030320: 2066 696c 6573 2074 6f20 6e65 776c 7920   files to newly 
-00030330: 6372 6561 7465 6420 6275 636b 6574 2028  created bucket (
-00030340: 6f75 7473 6964 6520 6f66 0a20 2020 2020  outside of.     
-00030350: 2020 2023 2073 6b79 2920 616e 6420 7665     # sky) and ve
-00030360: 7269 6669 6573 2074 6861 7420 6669 6c65  rifies that file
-00030370: 7320 6172 6520 7772 6974 7465 6e2e 0a20  s are written.. 
-00030380: 2020 2020 2020 2062 7563 6b65 745f 6e61         bucket_na
-00030390: 6d65 2c20 5f20 3d20 7265 7175 6573 742e  me, _ = request.
-000303a0: 6765 7466 6978 7475 7265 7661 6c75 6528  getfixturevalue(
-000303b0: 6578 745f 6275 636b 6574 5f66 6978 7475  ext_bucket_fixtu
-000303c0: 7265 290a 2020 2020 2020 2020 7374 6f72  re).        stor
-000303d0: 6167 655f 6f62 6a20 3d20 7374 6f72 6167  age_obj = storag
-000303e0: 655f 6c69 622e 5374 6f72 6167 6528 6e61  e_lib.Storage(na
-000303f0: 6d65 3d62 7563 6b65 745f 6e61 6d65 2c20  me=bucket_name, 
-00030400: 736f 7572 6365 3d74 6d70 5f73 6f75 7263  source=tmp_sourc
-00030410: 6529 0a20 2020 2020 2020 2073 746f 7261  e).        stora
-00030420: 6765 5f6f 626a 2e61 6464 5f73 746f 7265  ge_obj.add_store
-00030430: 2873 746f 7265 5f74 7970 6529 0a0a 2020  (store_type)..  
-00030440: 2020 2020 2020 2320 4368 6563 6b20 6966        # Check if
-00030450: 2074 6d70 5f73 6f75 7263 652f 746d 702d   tmp_source/tmp-
-00030460: 6669 6c65 2065 7869 7374 7320 696e 2074  file exists in t
-00030470: 6865 2062 7563 6b65 7420 7573 696e 6720  he bucket using 
-00030480: 6177 7320 636c 690a 2020 2020 2020 2020  aws cli.        
-00030490: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
-000304a0: 2e63 6865 636b 5f6f 7574 7075 7428 7365  .check_output(se
-000304b0: 6c66 2e63 6c69 5f6c 735f 636d 6428 7374  lf.cli_ls_cmd(st
-000304c0: 6f72 655f 7479 7065 2c20 6275 636b 6574  ore_type, bucket
-000304d0: 5f6e 616d 6529 2c0a 2020 2020 2020 2020  _name),.        
-000304e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000304f0: 2020 2020 2020 2020 2020 2020 2020 7368                sh
-00030500: 656c 6c3d 5472 7565 290a 2020 2020 2020  ell=True).      
-00030510: 2020 6173 7365 7274 2027 746d 702d 6669    assert 'tmp-fi
-00030520: 6c65 2720 696e 206f 7574 2e64 6563 6f64  le' in out.decod
-00030530: 6528 2775 7466 2d38 2729 2c20 5c0a 2020  e('utf-8'), \.  
-00030540: 2020 2020 2020 2020 2020 2746 696c 6520            'File 
-00030550: 6e6f 7420 666f 756e 6420 696e 2062 7563  not found in buc
-00030560: 6b65 7420 2d20 6f75 7470 7574 2077 6173  ket - output was
-00030570: 203a 207b 7d27 2e66 6f72 6d61 7428 6f75   : {}'.format(ou
-00030580: 742e 6465 636f 6465 0a20 2020 2020 2020  t.decode.       
-00030590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030260: 2020 2020 2020 2020 2020 6d61 726b 733d            marks=
+00030270: 7079 7465 7374 2e6d 6172 6b2e 636c 6f75  pytest.mark.clou
+00030280: 6466 6c61 7265 295d 290a 2020 2020 6465  dflare)]).    de
+00030290: 6620 7465 7374 5f75 706c 6f61 645f 746f  f test_upload_to
+000302a0: 5f65 7869 7374 696e 675f 6275 636b 6574  _existing_bucket
+000302b0: 2873 656c 662c 2065 7874 5f62 7563 6b65  (self, ext_bucke
+000302c0: 745f 6669 7874 7572 652c 2072 6571 7565  t_fixture, reque
+000302d0: 7374 2c0a 2020 2020 2020 2020 2020 2020  st,.            
+000302e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000302f0: 2020 2020 2020 2020 2020 2074 6d70 5f73             tmp_s
+00030300: 6f75 7263 652c 2073 746f 7265 5f74 7970  ource, store_typ
+00030310: 6529 3a0a 2020 2020 2020 2020 2320 5472  e):.        # Tr
+00030320: 6965 7320 7570 6c6f 6164 696e 6720 6578  ies uploading ex
+00030330: 6973 7469 6e67 2066 696c 6573 2074 6f20  isting files to 
+00030340: 6e65 776c 7920 6372 6561 7465 6420 6275  newly created bu
+00030350: 636b 6574 2028 6f75 7473 6964 6520 6f66  cket (outside of
+00030360: 0a20 2020 2020 2020 2023 2073 6b79 2920  .        # sky) 
+00030370: 616e 6420 7665 7269 6669 6573 2074 6861  and verifies tha
+00030380: 7420 6669 6c65 7320 6172 6520 7772 6974  t files are writ
+00030390: 7465 6e2e 0a20 2020 2020 2020 2062 7563  ten..        buc
+000303a0: 6b65 745f 6e61 6d65 2c20 5f20 3d20 7265  ket_name, _ = re
+000303b0: 7175 6573 742e 6765 7466 6978 7475 7265  quest.getfixture
+000303c0: 7661 6c75 6528 6578 745f 6275 636b 6574  value(ext_bucket
+000303d0: 5f66 6978 7475 7265 290a 2020 2020 2020  _fixture).      
+000303e0: 2020 7374 6f72 6167 655f 6f62 6a20 3d20    storage_obj = 
+000303f0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+00030400: 6167 6528 6e61 6d65 3d62 7563 6b65 745f  age(name=bucket_
+00030410: 6e61 6d65 2c20 736f 7572 6365 3d74 6d70  name, source=tmp
+00030420: 5f73 6f75 7263 6529 0a20 2020 2020 2020  _source).       
+00030430: 2073 746f 7261 6765 5f6f 626a 2e61 6464   storage_obj.add
+00030440: 5f73 746f 7265 2873 746f 7265 5f74 7970  _store(store_typ
+00030450: 6529 0a0a 2020 2020 2020 2020 2320 4368  e)..        # Ch
+00030460: 6563 6b20 6966 2074 6d70 5f73 6f75 7263  eck if tmp_sourc
+00030470: 652f 746d 702d 6669 6c65 2065 7869 7374  e/tmp-file exist
+00030480: 7320 696e 2074 6865 2062 7563 6b65 7420  s in the bucket 
+00030490: 7573 696e 6720 6177 7320 636c 690a 2020  using aws cli.  
+000304a0: 2020 2020 2020 6f75 7420 3d20 7375 6270        out = subp
+000304b0: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+000304c0: 7075 7428 7365 6c66 2e63 6c69 5f6c 735f  put(self.cli_ls_
+000304d0: 636d 6428 7374 6f72 655f 7479 7065 2c20  cmd(store_type, 
+000304e0: 6275 636b 6574 5f6e 616d 6529 2c0a 2020  bucket_name),.  
+000304f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030510: 2020 2020 7368 656c 6c3d 5472 7565 290a      shell=True).
+00030520: 2020 2020 2020 2020 6173 7365 7274 2027          assert '
+00030530: 746d 702d 6669 6c65 2720 696e 206f 7574  tmp-file' in out
+00030540: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+00030550: 2c20 5c0a 2020 2020 2020 2020 2020 2020  , \.            
+00030560: 2746 696c 6520 6e6f 7420 666f 756e 6420  'File not found 
+00030570: 696e 2062 7563 6b65 7420 2d20 6f75 7470  in bucket - outp
+00030580: 7574 2077 6173 203a 207b 7d27 2e66 6f72  ut was : {}'.for
+00030590: 6d61 7428 6f75 742e 6465 636f 6465 0a20  mat(out.decode. 
 000305a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000305b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000305c0: 2020 2020 2020 2020 2028 2775 7466 2d38           ('utf-8
-000305d0: 2729 290a 0a20 2020 2020 2020 2023 2043  '))..        # C
-000305e0: 6865 636b 2073 796d 6c69 6e6b 7320 2d20  heck symlinks - 
-000305f0: 7379 6d6c 696e 6b73 2064 6f6e 2774 2067  symlinks don't g
-00030600: 6574 2063 6f70 6965 6420 6279 2073 6b79  et copied by sky
-00030610: 2073 746f 7261 6765 0a20 2020 2020 2020   storage.       
-00030620: 2061 7373 6572 7420 2870 6174 686c 6962   assert (pathlib
-00030630: 2e50 6174 6828 746d 705f 736f 7572 6365  .Path(tmp_source
-00030640: 2920 2f20 2763 6972 636c 652d 6c69 6e6b  ) / 'circle-link
-00030650: 2729 2e69 735f 7379 6d6c 696e 6b28 292c  ').is_symlink(),
-00030660: 2028 0a20 2020 2020 2020 2020 2020 2027   (.            '
-00030670: 6369 7263 6c65 2d6c 696e 6b20 7761 7320  circle-link was 
-00030680: 6e6f 7420 666f 756e 6420 696e 2074 6865  not found in the
-00030690: 2075 706c 6f61 6420 736f 7572 6365 202d   upload source -
-000306a0: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-000306b0: 6172 6520 7468 6520 7465 7374 2066 6978  are the test fix
-000306c0: 7475 7265 7320 636f 7272 6563 743f 2729  tures correct?')
-000306d0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-000306e0: 2763 6972 636c 652d 6c69 6e6b 2720 6e6f  'circle-link' no
-000306f0: 7420 696e 206f 7574 2e64 6563 6f64 6528  t in out.decode(
-00030700: 2775 7466 2d38 2729 2c20 280a 2020 2020  'utf-8'), (.    
-00030710: 2020 2020 2020 2020 2753 796d 6c69 6e6b          'Symlink
-00030720: 2066 6f75 6e64 2069 6e20 6275 636b 6574   found in bucket
-00030730: 202d 206c 7320 6f75 7470 7574 2077 6173   - ls output was
-00030740: 203a 207b 7d27 2e66 6f72 6d61 7428 0a20   : {}'.format(. 
-00030750: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00030760: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
-00030770: 2729 2929 0a0a 2020 2020 2020 2020 2320  ')))..        # 
-00030780: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
-00030790: 6c73 2074 6f20 6368 6563 6b20 6966 2073  ls to check if s
-000307a0: 746f 7261 6765 206f 626a 6563 7420 6578  torage object ex
-000307b0: 6973 7473 2069 6e20 7468 6520 6f75 7470  ists in the outp
-000307c0: 7574 2e0a 2020 2020 2020 2020 2320 4974  ut..        # It
-000307d0: 2073 686f 756c 6420 6e6f 7420 6578 6973   should not exis
-000307e0: 7420 6265 6361 7573 6520 7468 6520 6275  t because the bu
-000307f0: 636b 6574 2077 6173 2063 7265 6174 6564  cket was created
-00030800: 2065 7874 6572 6e61 6c6c 792e 0a20 2020   externally..   
-00030810: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
-00030820: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-00030830: 7574 285b 2773 6b79 272c 2027 7374 6f72  ut(['sky', 'stor
-00030840: 6167 6527 2c20 276c 7327 5d29 0a20 2020  age', 'ls']).   
-00030850: 2020 2020 2061 7373 6572 7420 7374 6f72       assert stor
-00030860: 6167 655f 6f62 6a2e 6e61 6d65 206e 6f74  age_obj.name not
-00030870: 2069 6e20 6f75 742e 6465 636f 6465 2827   in out.decode('
-00030880: 7574 662d 3827 290a 0a20 2020 2040 7079  utf-8')..    @py
-00030890: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
-000308a0: 6964 7374 6163 6b0a 2020 2020 6465 6620  idstack.    def 
-000308b0: 7465 7374 5f63 6f70 795f 6d6f 756e 745f  test_copy_mount_
-000308c0: 6578 6973 7469 6e67 5f73 746f 7261 6765  existing_storage
-000308d0: 2873 656c 662c 0a20 2020 2020 2020 2020  (self,.         
-000308e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000305c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000305d0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+000305e0: 2775 7466 2d38 2729 290a 0a20 2020 2020  'utf-8'))..     
+000305f0: 2020 2023 2043 6865 636b 2073 796d 6c69     # Check symli
+00030600: 6e6b 7320 2d20 7379 6d6c 696e 6b73 2064  nks - symlinks d
+00030610: 6f6e 2774 2067 6574 2063 6f70 6965 6420  on't get copied 
+00030620: 6279 2073 6b79 2073 746f 7261 6765 0a20  by sky storage. 
+00030630: 2020 2020 2020 2061 7373 6572 7420 2870         assert (p
+00030640: 6174 686c 6962 2e50 6174 6828 746d 705f  athlib.Path(tmp_
+00030650: 736f 7572 6365 2920 2f20 2763 6972 636c  source) / 'circl
+00030660: 652d 6c69 6e6b 2729 2e69 735f 7379 6d6c  e-link').is_syml
+00030670: 696e 6b28 292c 2028 0a20 2020 2020 2020  ink(), (.       
+00030680: 2020 2020 2027 6369 7263 6c65 2d6c 696e       'circle-lin
+00030690: 6b20 7761 7320 6e6f 7420 666f 756e 6420  k was not found 
+000306a0: 696e 2074 6865 2075 706c 6f61 6420 736f  in the upload so
+000306b0: 7572 6365 202d 2027 0a20 2020 2020 2020  urce - '.       
+000306c0: 2020 2020 2027 6172 6520 7468 6520 7465       'are the te
+000306d0: 7374 2066 6978 7475 7265 7320 636f 7272  st fixtures corr
+000306e0: 6563 743f 2729 0a20 2020 2020 2020 2061  ect?').        a
+000306f0: 7373 6572 7420 2763 6972 636c 652d 6c69  ssert 'circle-li
+00030700: 6e6b 2720 6e6f 7420 696e 206f 7574 2e64  nk' not in out.d
+00030710: 6563 6f64 6528 2775 7466 2d38 2729 2c20  ecode('utf-8'), 
+00030720: 280a 2020 2020 2020 2020 2020 2020 2753  (.            'S
+00030730: 796d 6c69 6e6b 2066 6f75 6e64 2069 6e20  ymlink found in 
+00030740: 6275 636b 6574 202d 206c 7320 6f75 7470  bucket - ls outp
+00030750: 7574 2077 6173 203a 207b 7d27 2e66 6f72  ut was : {}'.for
+00030760: 6d61 7428 0a20 2020 2020 2020 2020 2020  mat(.           
+00030770: 2020 2020 206f 7574 2e64 6563 6f64 6528       out.decode(
+00030780: 2775 7466 2d38 2729 2929 0a0a 2020 2020  'utf-8')))..    
+00030790: 2020 2020 2320 5275 6e20 736b 7920 7374      # Run sky st
+000307a0: 6f72 6167 6520 6c73 2074 6f20 6368 6563  orage ls to chec
+000307b0: 6b20 6966 2073 746f 7261 6765 206f 626a  k if storage obj
+000307c0: 6563 7420 6578 6973 7473 2069 6e20 7468  ect exists in th
+000307d0: 6520 6f75 7470 7574 2e0a 2020 2020 2020  e output..      
+000307e0: 2020 2320 4974 2073 686f 756c 6420 6e6f    # It should no
+000307f0: 7420 6578 6973 7420 6265 6361 7573 6520  t exist because 
+00030800: 7468 6520 6275 636b 6574 2077 6173 2063  the bucket was c
+00030810: 7265 6174 6564 2065 7874 6572 6e61 6c6c  reated externall
+00030820: 792e 0a20 2020 2020 2020 206f 7574 203d  y..        out =
+00030830: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+00030840: 6b5f 6f75 7470 7574 285b 2773 6b79 272c  k_output(['sky',
+00030850: 2027 7374 6f72 6167 6527 2c20 276c 7327   'storage', 'ls'
+00030860: 5d29 0a20 2020 2020 2020 2061 7373 6572  ]).        asser
+00030870: 7420 7374 6f72 6167 655f 6f62 6a2e 6e61  t storage_obj.na
+00030880: 6d65 206e 6f74 2069 6e20 6f75 742e 6465  me not in out.de
+00030890: 636f 6465 2827 7574 662d 3827 290a 0a20  code('utf-8').. 
+000308a0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
+000308b0: 6e6f 5f66 6c75 6964 7374 6163 6b0a 2020  no_fluidstack.  
+000308c0: 2020 6465 6620 7465 7374 5f63 6f70 795f    def test_copy_
+000308d0: 6d6f 756e 745f 6578 6973 7469 6e67 5f73  mount_existing_s
+000308e0: 746f 7261 6765 2873 656c 662c 0a20 2020  torage(self,.   
 000308f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030900: 746d 705f 636f 7079 5f6d 6e74 5f65 7869  tmp_copy_mnt_exi
-00030910: 7374 696e 675f 7374 6f72 6167 655f 6f62  sting_storage_ob
-00030920: 6a29 3a0a 2020 2020 2020 2020 2320 4372  j):.        # Cr
-00030930: 6561 7465 7320 6120 6275 636b 6574 2077  eates a bucket w
-00030940: 6974 6820 6e6f 2073 6f75 7263 6520 696e  ith no source in
-00030950: 204d 4f55 4e54 206d 6f64 6520 2865 6d70   MOUNT mode (emp
-00030960: 7479 2062 7563 6b65 7429 2c20 616e 640a  ty bucket), and.
-00030970: 2020 2020 2020 2020 2320 7468 656e 2074          # then t
-00030980: 7269 6573 2074 6f20 6c6f 6164 2074 6865  ries to load the
-00030990: 2073 616d 6520 7374 6f72 6167 6520 696e   same storage in
-000309a0: 2043 4f50 5920 6d6f 6465 2e0a 2020 2020   COPY mode..    
-000309b0: 2020 2020 746d 705f 636f 7079 5f6d 6e74      tmp_copy_mnt
-000309c0: 5f65 7869 7374 696e 675f 7374 6f72 6167  _existing_storag
-000309d0: 655f 6f62 6a2e 6164 645f 7374 6f72 6528  e_obj.add_store(
-000309e0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-000309f0: 6554 7970 652e 5333 290a 2020 2020 2020  eType.S3).      
-00030a00: 2020 7374 6f72 6167 655f 6e61 6d65 203d    storage_name =
-00030a10: 2074 6d70 5f63 6f70 795f 6d6e 745f 6578   tmp_copy_mnt_ex
-00030a20: 6973 7469 6e67 5f73 746f 7261 6765 5f6f  isting_storage_o
-00030a30: 626a 2e6e 616d 650a 0a20 2020 2020 2020  bj.name..       
-00030a40: 2023 2043 6865 636b 2060 736b 7920 7374   # Check `sky st
-00030a50: 6f72 6167 6520 6c73 6020 746f 2065 6e73  orage ls` to ens
-00030a60: 7572 6520 7374 6f72 6167 6520 6f62 6a65  ure storage obje
-00030a70: 6374 2065 7869 7374 730a 2020 2020 2020  ct exists.      
-00030a80: 2020 6f75 7420 3d20 7375 6270 726f 6365    out = subproce
-00030a90: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
-00030aa0: 5b27 736b 7927 2c20 2773 746f 7261 6765  ['sky', 'storage
-00030ab0: 272c 2027 6c73 275d 292e 6465 636f 6465  ', 'ls']).decode
-00030ac0: 2827 7574 662d 3827 290a 2020 2020 2020  ('utf-8').      
-00030ad0: 2020 6173 7365 7274 2073 746f 7261 6765    assert storage
-00030ae0: 5f6e 616d 6520 696e 206f 7574 2c20 6627  _name in out, f'
-00030af0: 5374 6f72 6167 6520 7b73 746f 7261 6765  Storage {storage
-00030b00: 5f6e 616d 657d 206e 6f74 2066 6f75 6e64  _name} not found
-00030b10: 2069 6e20 736b 7920 7374 6f72 6167 6520   in sky storage 
-00030b20: 6c73 2e27 0a0a 2020 2020 4070 7974 6573  ls.'..    @pytes
-00030b30: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
-00030b40: 7461 636b 0a20 2020 2040 7079 7465 7374  tack.    @pytest
-00030b50: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
-00030b60: 6528 2773 746f 7265 5f74 7970 6527 2c20  e('store_type', 
-00030b70: 5b0a 2020 2020 2020 2020 7374 6f72 6167  [.        storag
-00030b80: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-00030b90: 5333 2c20 7374 6f72 6167 655f 6c69 622e  S3, storage_lib.
-00030ba0: 5374 6f72 6554 7970 652e 4743 532c 0a20  StoreType.GCS,. 
-00030bb0: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
-00030bc0: 7261 6d28 7374 6f72 6167 655f 6c69 622e  ram(storage_lib.
-00030bd0: 5374 6f72 6554 7970 652e 4942 4d2c 206d  StoreType.IBM, m
-00030be0: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
-00030bf0: 2e69 626d 292c 0a20 2020 2020 2020 2070  .ibm),.        p
-00030c00: 7974 6573 742e 7061 7261 6d28 7374 6f72  ytest.param(stor
-00030c10: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-00030c20: 652e 5232 2c20 6d61 726b 733d 7079 7465  e.R2, marks=pyte
-00030c30: 7374 2e6d 6172 6b2e 636c 6f75 6466 6c61  st.mark.cloudfla
-00030c40: 7265 290a 2020 2020 5d29 0a20 2020 2064  re).    ]).    d
-00030c50: 6566 2074 6573 745f 6c69 7374 5f73 6f75  ef test_list_sou
-00030c60: 7263 6528 7365 6c66 2c20 746d 705f 6c6f  rce(self, tmp_lo
-00030c70: 6361 6c5f 6c69 7374 5f73 746f 7261 6765  cal_list_storage
-00030c80: 5f6f 626a 2c20 7374 6f72 655f 7479 7065  _obj, store_type
-00030c90: 293a 0a20 2020 2020 2020 2023 2055 7365  ):.        # Use
-00030ca0: 7320 6120 6c69 7374 2069 6e20 7468 6520  s a list in the 
-00030cb0: 736f 7572 6365 2066 6965 6c64 2074 6f20  source field to 
-00030cc0: 7370 6563 6966 7920 6120 6669 6c65 2061  specify a file a
-00030cd0: 6e64 2061 2064 6972 6563 746f 7279 2074  nd a directory t
-00030ce0: 6f0a 2020 2020 2020 2020 2320 6265 2075  o.        # be u
-00030cf0: 706c 6f61 6465 6420 746f 2074 6865 2073  ploaded to the s
-00030d00: 746f 7261 6765 206f 626a 6563 742e 0a20  torage object.. 
-00030d10: 2020 2020 2020 2074 6d70 5f6c 6f63 616c         tmp_local
-00030d20: 5f6c 6973 745f 7374 6f72 6167 655f 6f62  _list_storage_ob
-00030d30: 6a2e 6164 645f 7374 6f72 6528 7374 6f72  j.add_store(stor
-00030d40: 655f 7479 7065 290a 0a20 2020 2020 2020  e_type)..       
-00030d50: 2023 2043 6865 636b 2069 6620 746d 702d   # Check if tmp-
-00030d60: 6669 6c65 2065 7869 7374 7320 696e 2074  file exists in t
-00030d70: 6865 2062 7563 6b65 7420 726f 6f74 2075  he bucket root u
-00030d80: 7369 6e67 2063 6c69 0a20 2020 2020 2020  sing cli.       
-00030d90: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
-00030da0: 732e 6368 6563 6b5f 6f75 7470 7574 2873  s.check_output(s
-00030db0: 656c 662e 636c 695f 6c73 5f63 6d64 280a  elf.cli_ls_cmd(.
-00030dc0: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-00030dd0: 655f 7479 7065 2c20 746d 705f 6c6f 6361  e_type, tmp_loca
-00030de0: 6c5f 6c69 7374 5f73 746f 7261 6765 5f6f  l_list_storage_o
-00030df0: 626a 2e6e 616d 6529 2c0a 2020 2020 2020  bj.name),.      
-00030e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030910: 2020 2020 2020 746d 705f 636f 7079 5f6d        tmp_copy_m
+00030920: 6e74 5f65 7869 7374 696e 675f 7374 6f72  nt_existing_stor
+00030930: 6167 655f 6f62 6a29 3a0a 2020 2020 2020  age_obj):.      
+00030940: 2020 2320 4372 6561 7465 7320 6120 6275    # Creates a bu
+00030950: 636b 6574 2077 6974 6820 6e6f 2073 6f75  cket with no sou
+00030960: 7263 6520 696e 204d 4f55 4e54 206d 6f64  rce in MOUNT mod
+00030970: 6520 2865 6d70 7479 2062 7563 6b65 7429  e (empty bucket)
+00030980: 2c20 616e 640a 2020 2020 2020 2020 2320  , and.        # 
+00030990: 7468 656e 2074 7269 6573 2074 6f20 6c6f  then tries to lo
+000309a0: 6164 2074 6865 2073 616d 6520 7374 6f72  ad the same stor
+000309b0: 6167 6520 696e 2043 4f50 5920 6d6f 6465  age in COPY mode
+000309c0: 2e0a 2020 2020 2020 2020 746d 705f 636f  ..        tmp_co
+000309d0: 7079 5f6d 6e74 5f65 7869 7374 696e 675f  py_mnt_existing_
+000309e0: 7374 6f72 6167 655f 6f62 6a2e 6164 645f  storage_obj.add_
+000309f0: 7374 6f72 6528 7374 6f72 6167 655f 6c69  store(storage_li
+00030a00: 622e 5374 6f72 6554 7970 652e 5333 290a  b.StoreType.S3).
+00030a10: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
+00030a20: 6e61 6d65 203d 2074 6d70 5f63 6f70 795f  name = tmp_copy_
+00030a30: 6d6e 745f 6578 6973 7469 6e67 5f73 746f  mnt_existing_sto
+00030a40: 7261 6765 5f6f 626a 2e6e 616d 650a 0a20  rage_obj.name.. 
+00030a50: 2020 2020 2020 2023 2043 6865 636b 2060         # Check `
+00030a60: 736b 7920 7374 6f72 6167 6520 6c73 6020  sky storage ls` 
+00030a70: 746f 2065 6e73 7572 6520 7374 6f72 6167  to ensure storag
+00030a80: 6520 6f62 6a65 6374 2065 7869 7374 730a  e object exists.
+00030a90: 2020 2020 2020 2020 6f75 7420 3d20 7375          out = su
+00030aa0: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
+00030ab0: 7574 7075 7428 5b27 736b 7927 2c20 2773  utput(['sky', 's
+00030ac0: 746f 7261 6765 272c 2027 6c73 275d 292e  torage', 'ls']).
+00030ad0: 6465 636f 6465 2827 7574 662d 3827 290a  decode('utf-8').
+00030ae0: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
+00030af0: 746f 7261 6765 5f6e 616d 6520 696e 206f  torage_name in o
+00030b00: 7574 2c20 6627 5374 6f72 6167 6520 7b73  ut, f'Storage {s
+00030b10: 746f 7261 6765 5f6e 616d 657d 206e 6f74  torage_name} not
+00030b20: 2066 6f75 6e64 2069 6e20 736b 7920 7374   found in sky st
+00030b30: 6f72 6167 6520 6c73 2e27 0a0a 2020 2020  orage ls.'..    
+00030b40: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00030b50: 666c 7569 6473 7461 636b 0a20 2020 2040  fluidstack.    @
+00030b60: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
+00030b70: 6d65 7472 697a 6528 2773 746f 7265 5f74  metrize('store_t
+00030b80: 7970 6527 2c20 5b0a 2020 2020 2020 2020  ype', [.        
+00030b90: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+00030ba0: 6554 7970 652e 5333 2c20 7374 6f72 6167  eType.S3, storag
+00030bb0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+00030bc0: 4743 532c 0a20 2020 2020 2020 2070 7974  GCS,.        pyt
+00030bd0: 6573 742e 7061 7261 6d28 7374 6f72 6167  est.param(storag
+00030be0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+00030bf0: 4942 4d2c 206d 6172 6b73 3d70 7974 6573  IBM, marks=pytes
+00030c00: 742e 6d61 726b 2e69 626d 292c 0a20 2020  t.mark.ibm),.   
+00030c10: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
+00030c20: 6d28 7374 6f72 6167 655f 6c69 622e 5374  m(storage_lib.St
+00030c30: 6f72 6554 7970 652e 5232 2c20 6d61 726b  oreType.R2, mark
+00030c40: 733d 7079 7465 7374 2e6d 6172 6b2e 636c  s=pytest.mark.cl
+00030c50: 6f75 6466 6c61 7265 290a 2020 2020 5d29  oudflare).    ])
+00030c60: 0a20 2020 2064 6566 2074 6573 745f 6c69  .    def test_li
+00030c70: 7374 5f73 6f75 7263 6528 7365 6c66 2c20  st_source(self, 
+00030c80: 746d 705f 6c6f 6361 6c5f 6c69 7374 5f73  tmp_local_list_s
+00030c90: 746f 7261 6765 5f6f 626a 2c20 7374 6f72  torage_obj, stor
+00030ca0: 655f 7479 7065 293a 0a20 2020 2020 2020  e_type):.       
+00030cb0: 2023 2055 7365 7320 6120 6c69 7374 2069   # Uses a list i
+00030cc0: 6e20 7468 6520 736f 7572 6365 2066 6965  n the source fie
+00030cd0: 6c64 2074 6f20 7370 6563 6966 7920 6120  ld to specify a 
+00030ce0: 6669 6c65 2061 6e64 2061 2064 6972 6563  file and a direc
+00030cf0: 746f 7279 2074 6f0a 2020 2020 2020 2020  tory to.        
+00030d00: 2320 6265 2075 706c 6f61 6465 6420 746f  # be uploaded to
+00030d10: 2074 6865 2073 746f 7261 6765 206f 626a   the storage obj
+00030d20: 6563 742e 0a20 2020 2020 2020 2074 6d70  ect..        tmp
+00030d30: 5f6c 6f63 616c 5f6c 6973 745f 7374 6f72  _local_list_stor
+00030d40: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
+00030d50: 6528 7374 6f72 655f 7479 7065 290a 0a20  e(store_type).. 
+00030d60: 2020 2020 2020 2023 2043 6865 636b 2069         # Check i
+00030d70: 6620 746d 702d 6669 6c65 2065 7869 7374  f tmp-file exist
+00030d80: 7320 696e 2074 6865 2062 7563 6b65 7420  s in the bucket 
+00030d90: 726f 6f74 2075 7369 6e67 2063 6c69 0a20  root using cli. 
+00030da0: 2020 2020 2020 206f 7574 203d 2073 7562         out = sub
+00030db0: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
+00030dc0: 7470 7574 2873 656c 662e 636c 695f 6c73  tput(self.cli_ls
+00030dd0: 5f63 6d64 280a 2020 2020 2020 2020 2020  _cmd(.          
+00030de0: 2020 7374 6f72 655f 7479 7065 2c20 746d    store_type, tm
+00030df0: 705f 6c6f 6361 6c5f 6c69 7374 5f73 746f  p_local_list_sto
+00030e00: 7261 6765 5f6f 626a 2e6e 616d 6529 2c0a  rage_obj.name),.
 00030e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030e20: 7368 656c 6c3d 5472 7565 290a 2020 2020  shell=True).    
-00030e30: 2020 2020 6173 7365 7274 2027 746d 702d      assert 'tmp-
-00030e40: 6669 6c65 2720 696e 206f 7574 2e64 6563  file' in out.dec
-00030e50: 6f64 6528 2775 7466 2d38 2729 2c20 5c0a  ode('utf-8'), \.
-00030e60: 2020 2020 2020 2020 2020 2020 2746 696c              'Fil
-00030e70: 6520 6e6f 7420 666f 756e 6420 696e 2062  e not found in b
-00030e80: 7563 6b65 7420 2d20 6f75 7470 7574 2077  ucket - output w
-00030e90: 6173 203a 207b 7d27 2e66 6f72 6d61 7428  as : {}'.format(
-00030ea0: 6f75 742e 6465 636f 6465 0a20 2020 2020  out.decode.     
-00030eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030e30: 2020 2020 2020 7368 656c 6c3d 5472 7565        shell=True
+00030e40: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+00030e50: 2027 746d 702d 6669 6c65 2720 696e 206f   'tmp-file' in o
+00030e60: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
+00030e70: 2729 2c20 5c0a 2020 2020 2020 2020 2020  '), \.          
+00030e80: 2020 2746 696c 6520 6e6f 7420 666f 756e    'File not foun
+00030e90: 6420 696e 2062 7563 6b65 7420 2d20 6f75  d in bucket - ou
+00030ea0: 7470 7574 2077 6173 203a 207b 7d27 2e66  tput was : {}'.f
+00030eb0: 6f72 6d61 7428 6f75 742e 6465 636f 6465  ormat(out.decode
+00030ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00030ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030ee0: 2020 2020 2020 2020 2020 2028 2775 7466             ('utf
-00030ef0: 2d38 2729 290a 0a20 2020 2020 2020 2023  -8'))..        #
-00030f00: 2043 6865 636b 2069 6620 746d 702d 6669   Check if tmp-fi
-00030f10: 6c65 2065 7869 7374 7320 696e 2074 6865  le exists in the
-00030f20: 2062 7563 6b65 742f 746d 702d 736f 7572   bucket/tmp-sour
-00030f30: 6365 2075 7369 6e67 2063 6c69 0a20 2020  ce using cli.   
-00030f40: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
-00030f50: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-00030f60: 7574 2873 656c 662e 636c 695f 6c73 5f63  ut(self.cli_ls_c
-00030f70: 6d64 280a 2020 2020 2020 2020 2020 2020  md(.            
-00030f80: 7374 6f72 655f 7479 7065 2c20 746d 705f  store_type, tmp_
-00030f90: 6c6f 6361 6c5f 6c69 7374 5f73 746f 7261  local_list_stora
-00030fa0: 6765 5f6f 626a 2e6e 616d 652c 2027 746d  ge_obj.name, 'tm
-00030fb0: 702d 736f 7572 6365 2f27 292c 0a20 2020  p-source/'),.   
-00030fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030fe0: 2020 2073 6865 6c6c 3d54 7275 6529 0a20     shell=True). 
-00030ff0: 2020 2020 2020 2061 7373 6572 7420 2774         assert 't
-00031000: 6d70 2d66 696c 6527 2069 6e20 6f75 742e  mp-file' in out.
-00031010: 6465 636f 6465 2827 7574 662d 3827 292c  decode('utf-8'),
-00031020: 205c 0a20 2020 2020 2020 2020 2020 2027   \.            '
-00031030: 4669 6c65 206e 6f74 2066 6f75 6e64 2069  File not found i
-00031040: 6e20 6275 636b 6574 202d 206f 7574 7075  n bucket - outpu
-00031050: 7420 7761 7320 3a20 7b7d 272e 666f 726d  t was : {}'.form
-00031060: 6174 286f 7574 2e64 6563 6f64 650a 2020  at(out.decode.  
-00031070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030f00: 2028 2775 7466 2d38 2729 290a 0a20 2020   ('utf-8'))..   
+00030f10: 2020 2020 2023 2043 6865 636b 2069 6620       # Check if 
+00030f20: 746d 702d 6669 6c65 2065 7869 7374 7320  tmp-file exists 
+00030f30: 696e 2074 6865 2062 7563 6b65 742f 746d  in the bucket/tm
+00030f40: 702d 736f 7572 6365 2075 7369 6e67 2063  p-source using c
+00030f50: 6c69 0a20 2020 2020 2020 206f 7574 203d  li.        out =
+00030f60: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+00030f70: 6b5f 6f75 7470 7574 2873 656c 662e 636c  k_output(self.cl
+00030f80: 695f 6c73 5f63 6d64 280a 2020 2020 2020  i_ls_cmd(.      
+00030f90: 2020 2020 2020 7374 6f72 655f 7479 7065        store_type
+00030fa0: 2c20 746d 705f 6c6f 6361 6c5f 6c69 7374  , tmp_local_list
+00030fb0: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
+00030fc0: 652c 2027 746d 702d 736f 7572 6365 2f27  e, 'tmp-source/'
+00030fd0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00030fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030ff0: 2020 2020 2020 2020 2073 6865 6c6c 3d54           shell=T
+00031000: 7275 6529 0a20 2020 2020 2020 2061 7373  rue).        ass
+00031010: 6572 7420 2774 6d70 2d66 696c 6527 2069  ert 'tmp-file' i
+00031020: 6e20 6f75 742e 6465 636f 6465 2827 7574  n out.decode('ut
+00031030: 662d 3827 292c 205c 0a20 2020 2020 2020  f-8'), \.       
+00031040: 2020 2020 2027 4669 6c65 206e 6f74 2066       'File not f
+00031050: 6f75 6e64 2069 6e20 6275 636b 6574 202d  ound in bucket -
+00031060: 206f 7574 7075 7420 7761 7320 3a20 7b7d   output was : {}
+00031070: 272e 666f 726d 6174 286f 7574 2e64 6563  '.format(out.dec
+00031080: 6f64 650a 2020 2020 2020 2020 2020 2020  ode.            
 00031090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000310a0: 2020 2020 2020 2020 2020 2020 2020 2827                ('
-000310b0: 7574 662d 3827 2929 0a0a 2020 2020 4070  utf-8'))..    @p
-000310c0: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
-000310d0: 7569 6473 7461 636b 0a20 2020 2040 7079  uidstack.    @py
-000310e0: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
-000310f0: 7472 697a 6528 2769 6e76 616c 6964 5f6e  trize('invalid_n
-00031100: 616d 655f 6c69 7374 2c20 7374 6f72 655f  ame_list, store_
-00031110: 7479 7065 272c 0a20 2020 2020 2020 2020  type',.         
-00031120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031130: 2020 2020 5b28 4157 535f 494e 5641 4c49      [(AWS_INVALI
-00031140: 445f 4e41 4d45 532c 2073 746f 7261 6765  D_NAMES, storage
-00031150: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
-00031160: 3329 2c0a 2020 2020 2020 2020 2020 2020  3),.            
-00031170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031180: 2020 2847 4353 5f49 4e56 414c 4944 5f4e    (GCS_INVALID_N
-00031190: 414d 4553 2c20 7374 6f72 6167 655f 6c69  AMES, storage_li
-000311a0: 622e 5374 6f72 6554 7970 652e 4743 5329  b.StoreType.GCS)
-000311b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000311c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000311d0: 7079 7465 7374 2e70 6172 616d 2849 424d  pytest.param(IBM
-000311e0: 5f49 4e56 414c 4944 5f4e 414d 4553 2c0a  _INVALID_NAMES,.
-000311f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031210: 2020 2020 2020 2020 2020 2073 746f 7261             stora
-00031220: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-00031230: 2e49 424d 2c0a 2020 2020 2020 2020 2020  .IBM,.          
-00031240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000310a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000310b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000310c0: 2020 2020 2827 7574 662d 3827 2929 0a0a      ('utf-8'))..
+000310d0: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
+000310e0: 2e6e 6f5f 666c 7569 6473 7461 636b 0a20  .no_fluidstack. 
+000310f0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
+00031100: 7061 7261 6d65 7472 697a 6528 2769 6e76  parametrize('inv
+00031110: 616c 6964 5f6e 616d 655f 6c69 7374 2c20  alid_name_list, 
+00031120: 7374 6f72 655f 7479 7065 272c 0a20 2020  store_type',.   
+00031130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031140: 2020 2020 2020 2020 2020 5b28 4157 535f            [(AWS_
+00031150: 494e 5641 4c49 445f 4e41 4d45 532c 2073  INVALID_NAMES, s
+00031160: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+00031170: 5479 7065 2e53 3329 2c0a 2020 2020 2020  Type.S3),.      
+00031180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031190: 2020 2020 2020 2020 2847 4353 5f49 4e56          (GCS_INV
+000311a0: 414c 4944 5f4e 414d 4553 2c20 7374 6f72  ALID_NAMES, stor
+000311b0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+000311c0: 652e 4743 5329 2c0a 2020 2020 2020 2020  e.GCS),.        
+000311d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000311e0: 2020 2020 2020 7079 7465 7374 2e70 6172        pytest.par
+000311f0: 616d 2849 424d 5f49 4e56 414c 4944 5f4e  am(IBM_INVALID_N
+00031200: 414d 4553 2c0a 2020 2020 2020 2020 2020  AMES,.          
+00031210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031230: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+00031240: 7265 5479 7065 2e49 424d 2c0a 2020 2020  reType.IBM,.    
 00031250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031260: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-00031270: 726b 2e69 626d 292c 0a20 2020 2020 2020  rk.ibm),.       
-00031280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031290: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
-000312a0: 7261 6d28 4157 535f 494e 5641 4c49 445f  ram(AWS_INVALID_
-000312b0: 4e41 4d45 532c 0a20 2020 2020 2020 2020  NAMES,.         
-000312c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031270: 2020 2020 2020 206d 6172 6b73 3d70 7974         marks=pyt
+00031280: 6573 742e 6d61 726b 2e69 626d 292c 0a20  est.mark.ibm),. 
+00031290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000312a0: 2020 2020 2020 2020 2020 2020 2070 7974               pyt
+000312b0: 6573 742e 7061 7261 6d28 4157 535f 494e  est.param(AWS_IN
+000312c0: 5641 4c49 445f 4e41 4d45 532c 0a20 2020  VALID_NAMES,.   
 000312d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000312e0: 2020 7374 6f72 6167 655f 6c69 622e 5374    storage_lib.St
-000312f0: 6f72 6554 7970 652e 5232 2c0a 2020 2020  oreType.R2,.    
-00031300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031320: 2020 2020 2020 206d 6172 6b73 3d70 7974         marks=pyt
-00031330: 6573 742e 6d61 726b 2e63 6c6f 7564 666c  est.mark.cloudfl
-00031340: 6172 6529 5d29 0a20 2020 2064 6566 2074  are)]).    def t
-00031350: 6573 745f 696e 7661 6c69 645f 6e61 6d65  est_invalid_name
-00031360: 7328 7365 6c66 2c20 696e 7661 6c69 645f  s(self, invalid_
-00031370: 6e61 6d65 5f6c 6973 742c 2073 746f 7265  name_list, store
-00031380: 5f74 7970 6529 3a0a 2020 2020 2020 2020  _type):.        
-00031390: 2320 5573 6573 2061 206c 6973 7420 696e  # Uses a list in
-000313a0: 2074 6865 2073 6f75 7263 6520 6669 656c   the source fiel
-000313b0: 6420 746f 2073 7065 6369 6679 2061 2066  d to specify a f
-000313c0: 696c 6520 616e 6420 6120 6469 7265 6374  ile and a direct
-000313d0: 6f72 7920 746f 0a20 2020 2020 2020 2023  ory to.        #
-000313e0: 2062 6520 7570 6c6f 6164 6564 2074 6f20   be uploaded to 
-000313f0: 7468 6520 7374 6f72 6167 6520 6f62 6a65  the storage obje
-00031400: 6374 2e0a 2020 2020 2020 2020 666f 7220  ct..        for 
-00031410: 6e61 6d65 2069 6e20 696e 7661 6c69 645f  name in invalid_
-00031420: 6e61 6d65 5f6c 6973 743a 0a20 2020 2020  name_list:.     
-00031430: 2020 2020 2020 2077 6974 6820 7079 7465         with pyte
-00031440: 7374 2e72 6169 7365 7328 736b 792e 6578  st.raises(sky.ex
-00031450: 6365 7074 696f 6e73 2e53 746f 7261 6765  ceptions.Storage
-00031460: 4e61 6d65 4572 726f 7229 3a0a 2020 2020  NameError):.    
-00031470: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-00031480: 6167 655f 6f62 6a20 3d20 7374 6f72 6167  age_obj = storag
-00031490: 655f 6c69 622e 5374 6f72 6167 6528 6e61  e_lib.Storage(na
-000314a0: 6d65 3d6e 616d 6529 0a20 2020 2020 2020  me=name).       
-000314b0: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-000314c0: 5f6f 626a 2e61 6464 5f73 746f 7265 2873  _obj.add_store(s
-000314d0: 746f 7265 5f74 7970 6529 0a0a 2020 2020  tore_type)..    
-000314e0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-000314f0: 666c 7569 6473 7461 636b 0a20 2020 2040  fluidstack.    @
-00031500: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
-00031510: 6d65 7472 697a 6528 0a20 2020 2020 2020  metrize(.       
-00031520: 2027 6769 7469 676e 6f72 655f 7374 7275   'gitignore_stru
-00031530: 6374 7572 652c 2073 746f 7265 5f74 7970  cture, store_typ
-00031540: 6527 2c0a 2020 2020 2020 2020 5b28 4749  e',.        [(GI
-00031550: 5449 474e 4f52 455f 5359 4e43 5f54 4553  TIGNORE_SYNC_TES
-00031560: 545f 4449 525f 5354 5255 4354 5552 452c  T_DIR_STRUCTURE,
-00031570: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-00031580: 7265 5479 7065 2e53 3329 2c0a 2020 2020  reType.S3),.    
-00031590: 2020 2020 2028 4749 5449 474e 4f52 455f       (GITIGNORE_
-000315a0: 5359 4e43 5f54 4553 545f 4449 525f 5354  SYNC_TEST_DIR_ST
-000315b0: 5255 4354 5552 452c 2073 746f 7261 6765  RUCTURE, storage
-000315c0: 5f6c 6962 2e53 746f 7265 5479 7065 2e47  _lib.StoreType.G
-000315d0: 4353 292c 0a20 2020 2020 2020 2020 7079  CS),.         py
-000315e0: 7465 7374 2e70 6172 616d 2847 4954 4947  test.param(GITIG
-000315f0: 4e4f 5245 5f53 594e 435f 5445 5354 5f44  NORE_SYNC_TEST_D
-00031600: 4952 5f53 5452 5543 5455 5245 2c0a 2020  IR_STRUCTURE,.  
-00031610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031620: 2020 2020 7374 6f72 6167 655f 6c69 622e      storage_lib.
-00031630: 5374 6f72 6554 7970 652e 5232 2c0a 2020  StoreType.R2,.  
-00031640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031650: 2020 2020 6d61 726b 733d 7079 7465 7374      marks=pytest
-00031660: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
-00031670: 295d 290a 2020 2020 6465 6620 7465 7374  )]).    def test
-00031680: 5f65 7863 6c75 6465 645f 6669 6c65 5f63  _excluded_file_c
-00031690: 6c6f 7564 5f73 746f 7261 6765 5f75 706c  loud_storage_upl
-000316a0: 6f61 645f 636f 7079 2873 656c 662c 2067  oad_copy(self, g
-000316b0: 6974 6967 6e6f 7265 5f73 7472 7563 7475  itignore_structu
-000316c0: 7265 2c0a 2020 2020 2020 2020 2020 2020  re,.            
-000316d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000312e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000312f0: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
+00031300: 6c69 622e 5374 6f72 6554 7970 652e 5232  lib.StoreType.R2
+00031310: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00031320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031330: 2020 2020 2020 2020 2020 2020 206d 6172               mar
+00031340: 6b73 3d70 7974 6573 742e 6d61 726b 2e63  ks=pytest.mark.c
+00031350: 6c6f 7564 666c 6172 6529 5d29 0a20 2020  loudflare)]).   
+00031360: 2064 6566 2074 6573 745f 696e 7661 6c69   def test_invali
+00031370: 645f 6e61 6d65 7328 7365 6c66 2c20 696e  d_names(self, in
+00031380: 7661 6c69 645f 6e61 6d65 5f6c 6973 742c  valid_name_list,
+00031390: 2073 746f 7265 5f74 7970 6529 3a0a 2020   store_type):.  
+000313a0: 2020 2020 2020 2320 5573 6573 2061 206c        # Uses a l
+000313b0: 6973 7420 696e 2074 6865 2073 6f75 7263  ist in the sourc
+000313c0: 6520 6669 656c 6420 746f 2073 7065 6369  e field to speci
+000313d0: 6679 2061 2066 696c 6520 616e 6420 6120  fy a file and a 
+000313e0: 6469 7265 6374 6f72 7920 746f 0a20 2020  directory to.   
+000313f0: 2020 2020 2023 2062 6520 7570 6c6f 6164       # be upload
+00031400: 6564 2074 6f20 7468 6520 7374 6f72 6167  ed to the storag
+00031410: 6520 6f62 6a65 6374 2e0a 2020 2020 2020  e object..      
+00031420: 2020 666f 7220 6e61 6d65 2069 6e20 696e    for name in in
+00031430: 7661 6c69 645f 6e61 6d65 5f6c 6973 743a  valid_name_list:
+00031440: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
+00031450: 6820 7079 7465 7374 2e72 6169 7365 7328  h pytest.raises(
+00031460: 736b 792e 6578 6365 7074 696f 6e73 2e53  sky.exceptions.S
+00031470: 746f 7261 6765 4e61 6d65 4572 726f 7229  torageNameError)
+00031480: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00031490: 2020 7374 6f72 6167 655f 6f62 6a20 3d20    storage_obj = 
+000314a0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+000314b0: 6167 6528 6e61 6d65 3d6e 616d 6529 0a20  age(name=name). 
+000314c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000314d0: 746f 7261 6765 5f6f 626a 2e61 6464 5f73  torage_obj.add_s
+000314e0: 746f 7265 2873 746f 7265 5f74 7970 6529  tore(store_type)
+000314f0: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
+00031500: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
+00031510: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+00031520: 6b2e 7061 7261 6d65 7472 697a 6528 0a20  k.parametrize(. 
+00031530: 2020 2020 2020 2027 6769 7469 676e 6f72         'gitignor
+00031540: 655f 7374 7275 6374 7572 652c 2073 746f  e_structure, sto
+00031550: 7265 5f74 7970 6527 2c0a 2020 2020 2020  re_type',.      
+00031560: 2020 5b28 4749 5449 474e 4f52 455f 5359    [(GITIGNORE_SY
+00031570: 4e43 5f54 4553 545f 4449 525f 5354 5255  NC_TEST_DIR_STRU
+00031580: 4354 5552 452c 2073 746f 7261 6765 5f6c  CTURE, storage_l
+00031590: 6962 2e53 746f 7265 5479 7065 2e53 3329  ib.StoreType.S3)
+000315a0: 2c0a 2020 2020 2020 2020 2028 4749 5449  ,.         (GITI
+000315b0: 474e 4f52 455f 5359 4e43 5f54 4553 545f  GNORE_SYNC_TEST_
+000315c0: 4449 525f 5354 5255 4354 5552 452c 2073  DIR_STRUCTURE, s
+000315d0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+000315e0: 5479 7065 2e47 4353 292c 0a20 2020 2020  Type.GCS),.     
+000315f0: 2020 2020 7079 7465 7374 2e70 6172 616d      pytest.param
+00031600: 2847 4954 4947 4e4f 5245 5f53 594e 435f  (GITIGNORE_SYNC_
+00031610: 5445 5354 5f44 4952 5f53 5452 5543 5455  TEST_DIR_STRUCTU
+00031620: 5245 2c0a 2020 2020 2020 2020 2020 2020  RE,.            
+00031630: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+00031640: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+00031650: 5232 2c0a 2020 2020 2020 2020 2020 2020  R2,.            
+00031660: 2020 2020 2020 2020 2020 6d61 726b 733d            marks=
+00031670: 7079 7465 7374 2e6d 6172 6b2e 636c 6f75  pytest.mark.clou
+00031680: 6466 6c61 7265 295d 290a 2020 2020 6465  dflare)]).    de
+00031690: 6620 7465 7374 5f65 7863 6c75 6465 645f  f test_excluded_
+000316a0: 6669 6c65 5f63 6c6f 7564 5f73 746f 7261  file_cloud_stora
+000316b0: 6765 5f75 706c 6f61 645f 636f 7079 2873  ge_upload_copy(s
+000316c0: 656c 662c 2067 6974 6967 6e6f 7265 5f73  elf, gitignore_s
+000316d0: 7472 7563 7475 7265 2c0a 2020 2020 2020  tructure,.      
 000316e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000316f0: 2020 2020 2020 2020 2073 746f 7265 5f74           store_t
-00031700: 7970 652c 0a20 2020 2020 2020 2020 2020  ype,.           
-00031710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000316f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031700: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00031710: 746f 7265 5f74 7970 652c 0a20 2020 2020  tore_type,.     
 00031720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031730: 2020 2020 2020 2020 2020 746d 705f 6769            tmp_gi
-00031740: 7469 676e 6f72 655f 7374 6f72 6167 655f  tignore_storage_
-00031750: 6f62 6a29 3a0a 2020 2020 2020 2020 2320  obj):.        # 
-00031760: 7465 7374 7320 6966 2066 696c 6573 2069  tests if files i
-00031770: 6e63 6c75 6465 6420 696e 202e 6769 7469  ncluded in .giti
-00031780: 676e 6f72 6520 616e 6420 2e67 6974 2f69  gnore and .git/i
-00031790: 6e66 6f2f 6578 636c 7564 6520 6172 650a  nfo/exclude are.
-000317a0: 2020 2020 2020 2020 2320 6578 636c 7564          # exclud
-000317b0: 6564 2066 726f 6d20 6265 696e 6720 7472  ed from being tr
-000317c0: 616e 7366 6572 7265 6420 746f 2053 746f  ansferred to Sto
-000317d0: 7261 6765 0a0a 2020 2020 2020 2020 746d  rage..        tm
-000317e0: 705f 6769 7469 676e 6f72 655f 7374 6f72  p_gitignore_stor
-000317f0: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
-00031800: 6528 7374 6f72 655f 7479 7065 290a 0a20  e(store_type).. 
-00031810: 2020 2020 2020 2075 706c 6f61 645f 6669         upload_fi
-00031820: 6c65 5f6e 616d 6520 3d20 2769 6e63 6c75  le_name = 'inclu
-00031830: 6465 6427 0a20 2020 2020 2020 2023 2043  ded'.        # C
-00031840: 6f75 6e74 2074 6865 206e 756d 6265 7220  ount the number 
-00031850: 6f66 2066 696c 6573 2077 6974 6820 7468  of files with th
-00031860: 6520 6769 7665 6e20 6669 6c65 206e 616d  e given file nam
-00031870: 650a 2020 2020 2020 2020 7570 5f63 6d64  e.        up_cmd
-00031880: 203d 2073 656c 662e 636c 695f 636f 756e   = self.cli_coun
-00031890: 745f 6e61 6d65 5f69 6e5f 6275 636b 6574  t_name_in_bucket
-000318a0: 2873 746f 7265 5f74 7970 652c 205c 0a20  (store_type, \. 
-000318b0: 2020 2020 2020 2020 2020 2074 6d70 5f67             tmp_g
-000318c0: 6974 6967 6e6f 7265 5f73 746f 7261 6765  itignore_storage
-000318d0: 5f6f 626a 2e6e 616d 652c 2066 696c 655f  _obj.name, file_
-000318e0: 6e61 6d65 3d75 706c 6f61 645f 6669 6c65  name=upload_file
-000318f0: 5f6e 616d 6529 0a20 2020 2020 2020 2067  _name).        g
-00031900: 6974 5f65 7863 6c75 6465 5f63 6d64 203d  it_exclude_cmd =
-00031910: 2073 656c 662e 636c 695f 636f 756e 745f   self.cli_count_
-00031920: 6e61 6d65 5f69 6e5f 6275 636b 6574 2873  name_in_bucket(s
-00031930: 746f 7265 5f74 7970 652c 205c 0a20 2020  tore_type, \.   
-00031940: 2020 2020 2020 2020 2074 6d70 5f67 6974           tmp_git
-00031950: 6967 6e6f 7265 5f73 746f 7261 6765 5f6f  ignore_storage_o
-00031960: 626a 2e6e 616d 652c 2066 696c 655f 6e61  bj.name, file_na
-00031970: 6d65 3d27 2e67 6974 2729 0a20 2020 2020  me='.git').     
-00031980: 2020 2063 6e74 5f6e 756d 5f66 696c 655f     cnt_num_file_
-00031990: 636d 6420 3d20 7365 6c66 2e63 6c69 5f63  cmd = self.cli_c
-000319a0: 6f75 6e74 5f66 696c 655f 696e 5f62 7563  ount_file_in_buc
-000319b0: 6b65 7428 0a20 2020 2020 2020 2020 2020  ket(.           
-000319c0: 2073 746f 7265 5f74 7970 652c 2074 6d70   store_type, tmp
-000319d0: 5f67 6974 6967 6e6f 7265 5f73 746f 7261  _gitignore_stora
-000319e0: 6765 5f6f 626a 2e6e 616d 6529 0a0a 2020  ge_obj.name)..  
-000319f0: 2020 2020 2020 7570 5f6f 7574 7075 7420        up_output 
-00031a00: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
-00031a10: 636b 5f6f 7574 7075 7428 7570 5f63 6d64  ck_output(up_cmd
-00031a20: 2c20 7368 656c 6c3d 5472 7565 290a 2020  , shell=True).  
-00031a30: 2020 2020 2020 6769 745f 6578 636c 7564        git_exclud
-00031a40: 655f 6f75 7470 7574 203d 2073 7562 7072  e_output = subpr
-00031a50: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-00031a60: 7574 2867 6974 5f65 7863 6c75 6465 5f63  ut(git_exclude_c
-00031a70: 6d64 2c0a 2020 2020 2020 2020 2020 2020  md,.            
-00031a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031750: 746d 705f 6769 7469 676e 6f72 655f 7374  tmp_gitignore_st
+00031760: 6f72 6167 655f 6f62 6a29 3a0a 2020 2020  orage_obj):.    
+00031770: 2020 2020 2320 7465 7374 7320 6966 2066      # tests if f
+00031780: 696c 6573 2069 6e63 6c75 6465 6420 696e  iles included in
+00031790: 202e 6769 7469 676e 6f72 6520 616e 6420   .gitignore and 
+000317a0: 2e67 6974 2f69 6e66 6f2f 6578 636c 7564  .git/info/exclud
+000317b0: 6520 6172 650a 2020 2020 2020 2020 2320  e are.        # 
+000317c0: 6578 636c 7564 6564 2066 726f 6d20 6265  excluded from be
+000317d0: 696e 6720 7472 616e 7366 6572 7265 6420  ing transferred 
+000317e0: 746f 2053 746f 7261 6765 0a0a 2020 2020  to Storage..    
+000317f0: 2020 2020 746d 705f 6769 7469 676e 6f72      tmp_gitignor
+00031800: 655f 7374 6f72 6167 655f 6f62 6a2e 6164  e_storage_obj.ad
+00031810: 645f 7374 6f72 6528 7374 6f72 655f 7479  d_store(store_ty
+00031820: 7065 290a 0a20 2020 2020 2020 2075 706c  pe)..        upl
+00031830: 6f61 645f 6669 6c65 5f6e 616d 6520 3d20  oad_file_name = 
+00031840: 2769 6e63 6c75 6465 6427 0a20 2020 2020  'included'.     
+00031850: 2020 2023 2043 6f75 6e74 2074 6865 206e     # Count the n
+00031860: 756d 6265 7220 6f66 2066 696c 6573 2077  umber of files w
+00031870: 6974 6820 7468 6520 6769 7665 6e20 6669  ith the given fi
+00031880: 6c65 206e 616d 650a 2020 2020 2020 2020  le name.        
+00031890: 7570 5f63 6d64 203d 2073 656c 662e 636c  up_cmd = self.cl
+000318a0: 695f 636f 756e 745f 6e61 6d65 5f69 6e5f  i_count_name_in_
+000318b0: 6275 636b 6574 2873 746f 7265 5f74 7970  bucket(store_typ
+000318c0: 652c 205c 0a20 2020 2020 2020 2020 2020  e, \.           
+000318d0: 2074 6d70 5f67 6974 6967 6e6f 7265 5f73   tmp_gitignore_s
+000318e0: 746f 7261 6765 5f6f 626a 2e6e 616d 652c  torage_obj.name,
+000318f0: 2066 696c 655f 6e61 6d65 3d75 706c 6f61   file_name=uploa
+00031900: 645f 6669 6c65 5f6e 616d 6529 0a20 2020  d_file_name).   
+00031910: 2020 2020 2067 6974 5f65 7863 6c75 6465       git_exclude
+00031920: 5f63 6d64 203d 2073 656c 662e 636c 695f  _cmd = self.cli_
+00031930: 636f 756e 745f 6e61 6d65 5f69 6e5f 6275  count_name_in_bu
+00031940: 636b 6574 2873 746f 7265 5f74 7970 652c  cket(store_type,
+00031950: 205c 0a20 2020 2020 2020 2020 2020 2074   \.            t
+00031960: 6d70 5f67 6974 6967 6e6f 7265 5f73 746f  mp_gitignore_sto
+00031970: 7261 6765 5f6f 626a 2e6e 616d 652c 2066  rage_obj.name, f
+00031980: 696c 655f 6e61 6d65 3d27 2e67 6974 2729  ile_name='.git')
+00031990: 0a20 2020 2020 2020 2063 6e74 5f6e 756d  .        cnt_num
+000319a0: 5f66 696c 655f 636d 6420 3d20 7365 6c66  _file_cmd = self
+000319b0: 2e63 6c69 5f63 6f75 6e74 5f66 696c 655f  .cli_count_file_
+000319c0: 696e 5f62 7563 6b65 7428 0a20 2020 2020  in_bucket(.     
+000319d0: 2020 2020 2020 2073 746f 7265 5f74 7970         store_typ
+000319e0: 652c 2074 6d70 5f67 6974 6967 6e6f 7265  e, tmp_gitignore
+000319f0: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
+00031a00: 6529 0a0a 2020 2020 2020 2020 7570 5f6f  e)..        up_o
+00031a10: 7574 7075 7420 3d20 7375 6270 726f 6365  utput = subproce
+00031a20: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
+00031a30: 7570 5f63 6d64 2c20 7368 656c 6c3d 5472  up_cmd, shell=Tr
+00031a40: 7565 290a 2020 2020 2020 2020 6769 745f  ue).        git_
+00031a50: 6578 636c 7564 655f 6f75 7470 7574 203d  exclude_output =
+00031a60: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+00031a70: 6b5f 6f75 7470 7574 2867 6974 5f65 7863  k_output(git_exc
+00031a80: 6c75 6465 5f63 6d64 2c0a 2020 2020 2020  lude_cmd,.      
 00031a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031aa0: 2020 2020 2020 2020 2073 6865 6c6c 3d54           shell=T
-00031ab0: 7275 6529 0a20 2020 2020 2020 2063 6e74  rue).        cnt
-00031ac0: 5f6f 7574 7075 7420 3d20 7375 6270 726f  _output = subpro
-00031ad0: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
-00031ae0: 7428 636e 745f 6e75 6d5f 6669 6c65 5f63  t(cnt_num_file_c
-00031af0: 6d64 2c20 7368 656c 6c3d 5472 7565 290a  md, shell=True).
-00031b00: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00031b10: 2733 2720 696e 2075 705f 6f75 7470 7574  '3' in up_output
-00031b20: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-00031b30: 2c20 5c0a 2020 2020 2020 2020 2020 2020  , \.            
-00031b40: 2020 2020 2746 696c 6573 2074 6f20 6265      'Files to be
-00031b50: 2069 6e63 6c75 6465 6420 6172 6520 6e6f   included are no
-00031b60: 7420 636f 6d70 6c65 7465 6c79 2075 706c  t completely upl
-00031b70: 6f61 6465 642e 270a 2020 2020 2020 2020  oaded.'.        
-00031b80: 2320 3120 6973 2072 6561 6420 6173 202e  # 1 is read as .
-00031b90: 6769 7469 676e 6f72 6520 6973 2075 706c  gitignore is upl
-00031ba0: 6f61 6465 640a 2020 2020 2020 2020 6173  oaded.        as
-00031bb0: 7365 7274 2027 3127 2069 6e20 6769 745f  sert '1' in git_
-00031bc0: 6578 636c 7564 655f 6f75 7470 7574 2e64  exclude_output.d
-00031bd0: 6563 6f64 6528 2775 7466 2d38 2729 2c20  ecode('utf-8'), 
-00031be0: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
-00031bf0: 2027 2e67 6974 2064 6972 6563 746f 7279   '.git directory
-00031c00: 2073 686f 756c 6420 6e6f 7420 6265 2075   should not be u
-00031c10: 706c 6f61 6465 642e 270a 2020 2020 2020  ploaded.'.      
-00031c20: 2020 2320 3420 6669 6c65 7320 696e 636c    # 4 files incl
-00031c30: 7564 6520 2e67 6974 6967 6e6f 7265 2c20  ude .gitignore, 
-00031c40: 696e 636c 7564 6564 2e6c 6f67 2c20 696e  included.log, in
-00031c50: 636c 7564 6564 2e74 7874 2c20 696e 636c  cluded.txt, incl
-00031c60: 7564 655f 6469 722f 696e 636c 7564 6564  ude_dir/included
-00031c70: 2e6c 6f67 0a20 2020 2020 2020 2061 7373  .log.        ass
-00031c80: 6572 7420 2734 2720 696e 2063 6e74 5f6f  ert '4' in cnt_o
-00031c90: 7574 7075 742e 6465 636f 6465 2827 7574  utput.decode('ut
-00031ca0: 662d 3827 292c 205c 0a20 2020 2020 2020  f-8'), \.       
-00031cb0: 2020 2020 2020 2020 2753 6f6d 6520 6974          'Some it
-00031cc0: 656d 7320 6c69 7374 6564 2069 6e20 2e67  ems listed in .g
-00031cd0: 6974 6967 6e6f 7265 2061 6e64 202e 6769  itignore and .gi
-00031ce0: 742f 696e 666f 2f65 7863 6c75 6465 2061  t/info/exclude a
-00031cf0: 7265 206e 6f74 2065 7863 6c75 6465 642e  re not excluded.
-00031d00: 270a 0a20 2020 2040 7079 7465 7374 2e6d  '..    @pytest.m
-00031d10: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
-00031d20: 2765 7874 5f62 7563 6b65 745f 6669 7874  'ext_bucket_fixt
-00031d30: 7572 652c 2073 746f 7265 5f74 7970 6527  ure, store_type'
-00031d40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00031d50: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-00031d60: 2827 746d 705f 6177 7363 6c69 5f62 7563  ('tmp_awscli_buc
-00031d70: 6b65 7427 2c20 7374 6f72 6167 655f 6c69  ket', storage_li
-00031d80: 622e 5374 6f72 6554 7970 652e 5333 292c  b.StoreType.S3),
-00031d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031da0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00031db0: 2774 6d70 5f67 7375 7469 6c5f 6275 636b  'tmp_gsutil_buck
-00031dc0: 6574 272c 2073 746f 7261 6765 5f6c 6962  et', storage_lib
-00031dd0: 2e53 746f 7265 5479 7065 2e47 4353 292c  .StoreType.GCS),
-00031de0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031df0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00031e00: 7974 6573 742e 7061 7261 6d28 2774 6d70  ytest.param('tmp
-00031e10: 5f61 7773 636c 695f 6275 636b 6574 5f72  _awscli_bucket_r
-00031e20: 3227 2c0a 2020 2020 2020 2020 2020 2020  2',.            
-00031e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031e40: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00031e50: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-00031e60: 5479 7065 2e52 322c 0a20 2020 2020 2020  Type.R2,.       
-00031e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031ab0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00031ac0: 6865 6c6c 3d54 7275 6529 0a20 2020 2020  hell=True).     
+00031ad0: 2020 2063 6e74 5f6f 7574 7075 7420 3d20     cnt_output = 
+00031ae0: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+00031af0: 5f6f 7574 7075 7428 636e 745f 6e75 6d5f  _output(cnt_num_
+00031b00: 6669 6c65 5f63 6d64 2c20 7368 656c 6c3d  file_cmd, shell=
+00031b10: 5472 7565 290a 0a20 2020 2020 2020 2061  True)..        a
+00031b20: 7373 6572 7420 2733 2720 696e 2075 705f  ssert '3' in up_
+00031b30: 6f75 7470 7574 2e64 6563 6f64 6528 2775  output.decode('u
+00031b40: 7466 2d38 2729 2c20 5c0a 2020 2020 2020  tf-8'), \.      
+00031b50: 2020 2020 2020 2020 2020 2746 696c 6573            'Files
+00031b60: 2074 6f20 6265 2069 6e63 6c75 6465 6420   to be included 
+00031b70: 6172 6520 6e6f 7420 636f 6d70 6c65 7465  are not complete
+00031b80: 6c79 2075 706c 6f61 6465 642e 270a 2020  ly uploaded.'.  
+00031b90: 2020 2020 2020 2320 3120 6973 2072 6561        # 1 is rea
+00031ba0: 6420 6173 202e 6769 7469 676e 6f72 6520  d as .gitignore 
+00031bb0: 6973 2075 706c 6f61 6465 640a 2020 2020  is uploaded.    
+00031bc0: 2020 2020 6173 7365 7274 2027 3127 2069      assert '1' i
+00031bd0: 6e20 6769 745f 6578 636c 7564 655f 6f75  n git_exclude_ou
+00031be0: 7470 7574 2e64 6563 6f64 6528 2775 7466  tput.decode('utf
+00031bf0: 2d38 2729 2c20 5c0a 2020 2020 2020 2020  -8'), \.        
+00031c00: 2020 2020 2020 2027 2e67 6974 2064 6972         '.git dir
+00031c10: 6563 746f 7279 2073 686f 756c 6420 6e6f  ectory should no
+00031c20: 7420 6265 2075 706c 6f61 6465 642e 270a  t be uploaded.'.
+00031c30: 2020 2020 2020 2020 2320 3420 6669 6c65          # 4 file
+00031c40: 7320 696e 636c 7564 6520 2e67 6974 6967  s include .gitig
+00031c50: 6e6f 7265 2c20 696e 636c 7564 6564 2e6c  nore, included.l
+00031c60: 6f67 2c20 696e 636c 7564 6564 2e74 7874  og, included.txt
+00031c70: 2c20 696e 636c 7564 655f 6469 722f 696e  , include_dir/in
+00031c80: 636c 7564 6564 2e6c 6f67 0a20 2020 2020  cluded.log.     
+00031c90: 2020 2061 7373 6572 7420 2734 2720 696e     assert '4' in
+00031ca0: 2063 6e74 5f6f 7574 7075 742e 6465 636f   cnt_output.deco
+00031cb0: 6465 2827 7574 662d 3827 292c 205c 0a20  de('utf-8'), \. 
+00031cc0: 2020 2020 2020 2020 2020 2020 2020 2753                'S
+00031cd0: 6f6d 6520 6974 656d 7320 6c69 7374 6564  ome items listed
+00031ce0: 2069 6e20 2e67 6974 6967 6e6f 7265 2061   in .gitignore a
+00031cf0: 6e64 202e 6769 742f 696e 666f 2f65 7863  nd .git/info/exc
+00031d00: 6c75 6465 2061 7265 206e 6f74 2065 7863  lude are not exc
+00031d10: 6c75 6465 642e 270a 0a20 2020 2040 7079  luded.'..    @py
+00031d20: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
+00031d30: 7472 697a 6528 2765 7874 5f62 7563 6b65  trize('ext_bucke
+00031d40: 745f 6669 7874 7572 652c 2073 746f 7265  t_fixture, store
+00031d50: 5f74 7970 6527 2c0a 2020 2020 2020 2020  _type',.        
+00031d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031d70: 2020 2020 205b 2827 746d 705f 6177 7363       [('tmp_awsc
+00031d80: 6c69 5f62 7563 6b65 7427 2c20 7374 6f72  li_bucket', stor
+00031d90: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+00031da0: 652e 5333 292c 0a20 2020 2020 2020 2020  e.S3),.         
+00031db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031dc0: 2020 2020 2028 2774 6d70 5f67 7375 7469       ('tmp_gsuti
+00031dd0: 6c5f 6275 636b 6574 272c 2073 746f 7261  l_bucket', stora
+00031de0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+00031df0: 2e47 4353 292c 0a20 2020 2020 2020 2020  .GCS),.         
+00031e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031e10: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
+00031e20: 6d28 2774 6d70 5f61 7773 636c 695f 6275  m('tmp_awscli_bu
+00031e30: 636b 6574 5f72 3227 2c0a 2020 2020 2020  cket_r2',.      
+00031e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031e60: 2020 2020 2073 746f 7261 6765 5f6c 6962       storage_lib
+00031e70: 2e53 746f 7265 5479 7065 2e52 322c 0a20  .StoreType.R2,. 
 00031e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031e90: 2020 2020 6d61 726b 733d 7079 7465 7374      marks=pytest
-00031ea0: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
-00031eb0: 295d 290a 2020 2020 6465 6620 7465 7374  )]).    def test
-00031ec0: 5f65 7874 6572 6e61 6c6c 795f 6372 6561  _externally_crea
-00031ed0: 7465 645f 6275 636b 6574 5f6d 6f75 6e74  ted_bucket_mount
-00031ee0: 5f77 6974 686f 7574 5f73 6f75 7263 6528  _without_source(
-00031ef0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00031f00: 662c 2065 7874 5f62 7563 6b65 745f 6669  f, ext_bucket_fi
-00031f10: 7874 7572 652c 2072 6571 7565 7374 2c20  xture, request, 
-00031f20: 7374 6f72 655f 7479 7065 293a 0a20 2020  store_type):.   
-00031f30: 2020 2020 2023 204e 6f6e 2d73 6b79 206d       # Non-sky m
-00031f40: 616e 6167 6564 2062 7563 6b65 7473 2862  anaged buckets(b
-00031f50: 7563 6b65 7473 2063 7265 6174 6564 206f  uckets created o
-00031f60: 7574 7369 6465 206f 6620 536b 7970 696c  utside of Skypil
-00031f70: 6f74 2043 4c49 290a 2020 2020 2020 2020  ot CLI).        
-00031f80: 2320 6172 6520 616c 6c6f 7765 6420 746f  # are allowed to
-00031f90: 2062 6520 4d4f 554e 5465 6420 6279 2073   be MOUNTed by s
-00031fa0: 7065 6369 6679 696e 6720 7468 6520 5552  pecifying the UR
-00031fb0: 4920 6f66 2074 6865 2062 7563 6b65 7420  I of the bucket 
-00031fc0: 746f 0a20 2020 2020 2020 2023 2073 6f75  to.        # sou
-00031fd0: 7263 6520 6669 656c 6420 6f6e 6c79 2e20  rce field only. 
-00031fe0: 5768 656e 2069 7420 6973 2061 7474 656d  When it is attem
-00031ff0: 7074 6564 2062 7920 7370 6563 6966 7969  pted by specifyi
-00032000: 6e67 2074 6865 206e 616d 6520 6f66 0a20  ng the name of. 
-00032010: 2020 2020 2020 2023 2074 6865 2062 7563         # the buc
-00032020: 6b65 7420 6f6e 6c79 2c20 6974 2073 686f  ket only, it sho
-00032030: 756c 6420 6572 726f 7220 6f75 742e 0a20  uld error out.. 
-00032040: 2020 2020 2020 2023 0a20 2020 2020 2020         #.       
-00032050: 2023 2054 4f44 4f28 646f 796f 756e 6729   # TODO(doyoung)
-00032060: 3a20 4164 6420 7465 7374 2066 6f72 2049  : Add test for I
-00032070: 424d 2043 4f53 2e20 4375 7272 656e 746c  BM COS. Currentl
-00032080: 792c 2074 6869 7320 6973 2062 6c6f 636b  y, this is block
-00032090: 6564 0a20 2020 2020 2020 2023 2061 7320  ed.        # as 
-000320a0: 7263 6c6f 6e65 2075 7365 6420 746f 2069  rclone used to i
-000320b0: 6e74 6572 6163 7420 7769 7468 2049 424d  nteract with IBM
-000320c0: 2043 4f53 2064 6f65 7320 6e6f 7420 7375   COS does not su
-000320d0: 7070 6f72 7420 6665 6174 7572 6520 746f  pport feature to
-000320e0: 0a20 2020 2020 2020 2023 2063 7265 6174  .        # creat
-000320f0: 6520 6120 6275 636b 6574 2c20 616e 6420  e a bucket, and 
-00032100: 7468 6520 6962 6d63 6c6f 7564 2043 4c49  the ibmcloud CLI
-00032110: 2069 7320 6e6f 7420 7375 7070 6f72 7465   is not supporte
-00032120: 6420 696e 2053 6b79 7069 6c6f 742e 0a20  d in Skypilot.. 
-00032130: 2020 2020 2020 2023 2045 6974 6865 7220         # Either 
-00032140: 6f66 2074 6865 2066 6561 7475 7265 2069  of the feature i
-00032150: 7320 6e65 6365 7373 6172 7920 746f 2073  s necessary to s
-00032160: 696d 756c 6174 6520 616e 2065 7874 6572  imulate an exter
-00032170: 6e61 6c20 6275 636b 6574 0a20 2020 2020  nal bucket.     
-00032180: 2020 2023 2063 7265 6174 696f 6e20 666f     # creation fo
-00032190: 7220 4942 4d20 434f 532e 0a20 2020 2020  r IBM COS..     
-000321a0: 2020 2023 2068 7474 7073 3a2f 2f67 6974     # https://git
-000321b0: 6875 622e 636f 6d2f 736b 7970 696c 6f74  hub.com/skypilot
-000321c0: 2d6f 7267 2f73 6b79 7069 6c6f 742f 7075  -org/skypilot/pu
-000321d0: 6c6c 2f31 3936 362f 6669 6c65 7323 7231  ll/1966/files#r1
-000321e0: 3235 3334 3339 3833 370a 0a20 2020 2020  253439837..     
-000321f0: 2020 2065 7874 5f62 7563 6b65 745f 6e61     ext_bucket_na
-00032200: 6d65 2c20 6578 745f 6275 636b 6574 5f75  me, ext_bucket_u
-00032210: 7269 203d 2072 6571 7565 7374 2e67 6574  ri = request.get
-00032220: 6669 7874 7572 6576 616c 7565 280a 2020  fixturevalue(.  
-00032230: 2020 2020 2020 2020 2020 6578 745f 6275            ext_bu
-00032240: 636b 6574 5f66 6978 7475 7265 290a 2020  cket_fixture).  
-00032250: 2020 2020 2020 2320 696e 7661 6c69 6420        # invalid 
-00032260: 7370 6563 0a20 2020 2020 2020 2077 6974  spec.        wit
-00032270: 6820 7079 7465 7374 2e72 6169 7365 7328  h pytest.raises(
-00032280: 736b 792e 6578 6365 7074 696f 6e73 2e53  sky.exceptions.S
-00032290: 746f 7261 6765 5370 6563 4572 726f 7229  torageSpecError)
-000322a0: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-000322b0: 2020 2073 746f 7261 6765 5f6f 626a 203d     storage_obj =
-000322c0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-000322d0: 7261 6765 280a 2020 2020 2020 2020 2020  rage(.          
-000322e0: 2020 2020 2020 6e61 6d65 3d65 7874 5f62        name=ext_b
-000322f0: 7563 6b65 745f 6e61 6d65 2c20 6d6f 6465  ucket_name, mode
-00032300: 3d73 746f 7261 6765 5f6c 6962 2e53 746f  =storage_lib.Sto
-00032310: 7261 6765 4d6f 6465 2e4d 4f55 4e54 290a  rageMode.MOUNT).
-00032320: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-00032330: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
-00032340: 6528 7374 6f72 655f 7479 7065 290a 0a20  e(store_type).. 
-00032350: 2020 2020 2020 2061 7373 6572 7420 2741         assert 'A
-00032360: 7474 656d 7074 6564 2074 6f20 6d6f 756e  ttempted to moun
-00032370: 7420 6120 6e6f 6e2d 736b 7920 6d61 6e61  t a non-sky mana
-00032380: 6765 6420 6275 636b 6574 2720 696e 2073  ged bucket' in s
-00032390: 7472 2865 290a 0a20 2020 2020 2020 2023  tr(e)..        #
-000323a0: 2076 616c 6964 2073 7065 630a 2020 2020   valid spec.    
-000323b0: 2020 2020 7374 6f72 6167 655f 6f62 6a20      storage_obj 
-000323c0: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-000323d0: 6f72 6167 6528 736f 7572 6365 3d65 7874  orage(source=ext
-000323e0: 5f62 7563 6b65 745f 7572 692c 0a20 2020  _bucket_uri,.   
-000323f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032410: 2020 2020 2020 206d 6f64 653d 7374 6f72         mode=stor
-00032420: 6167 655f 6c69 622e 5374 6f72 6167 654d  age_lib.StorageM
-00032430: 6f64 652e 4d4f 554e 5429 0a20 2020 2020  ode.MOUNT).     
-00032440: 2020 2068 616e 646c 6520 3d20 676c 6f62     handle = glob
-00032450: 616c 5f75 7365 725f 7374 6174 652e 6765  al_user_state.ge
-00032460: 745f 6861 6e64 6c65 5f66 726f 6d5f 7374  t_handle_from_st
-00032470: 6f72 6167 655f 6e61 6d65 280a 2020 2020  orage_name(.    
-00032480: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-00032490: 6f62 6a2e 6e61 6d65 290a 2020 2020 2020  obj.name).      
-000324a0: 2020 6966 2068 616e 646c 653a 0a20 2020    if handle:.   
-000324b0: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-000324c0: 5f6f 626a 2e64 656c 6574 6528 290a 0a20  _obj.delete().. 
-000324d0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-000324e0: 6e6f 5f66 6c75 6964 7374 6163 6b0a 2020  no_fluidstack.  
-000324f0: 2020 4070 7974 6573 742e 6d61 726b 2e70    @pytest.mark.p
-00032500: 6172 616d 6574 7269 7a65 2827 7265 6769  arametrize('regi
-00032510: 6f6e 272c 205b 0a20 2020 2020 2020 2027  on', [.        '
-00032520: 6170 2d6e 6f72 7468 6561 7374 2d31 272c  ap-northeast-1',
-00032530: 2027 6170 2d6e 6f72 7468 6561 7374 2d32   'ap-northeast-2
-00032540: 272c 2027 6170 2d6e 6f72 7468 6561 7374  ', 'ap-northeast
-00032550: 2d33 272c 2027 6170 2d73 6f75 7468 2d31  -3', 'ap-south-1
-00032560: 272c 0a20 2020 2020 2020 2027 6170 2d73  ',.        'ap-s
-00032570: 6f75 7468 6561 7374 2d31 272c 2027 6170  outheast-1', 'ap
-00032580: 2d73 6f75 7468 6561 7374 2d32 272c 2027  -southeast-2', '
-00032590: 6575 2d63 656e 7472 616c 2d31 272c 2027  eu-central-1', '
-000325a0: 6575 2d6e 6f72 7468 2d31 272c 0a20 2020  eu-north-1',.   
-000325b0: 2020 2020 2027 6575 2d77 6573 742d 3127       'eu-west-1'
-000325c0: 2c20 2765 752d 7765 7374 2d32 272c 2027  , 'eu-west-2', '
-000325d0: 6575 2d77 6573 742d 3327 2c20 2773 612d  eu-west-3', 'sa-
-000325e0: 6561 7374 2d31 272c 2027 7573 2d65 6173  east-1', 'us-eas
-000325f0: 742d 3127 2c0a 2020 2020 2020 2020 2775  t-1',.        'u
-00032600: 732d 6561 7374 2d32 272c 2027 7573 2d77  s-east-2', 'us-w
-00032610: 6573 742d 3127 2c20 2775 732d 7765 7374  est-1', 'us-west
-00032620: 2d32 270a 2020 2020 5d29 0a20 2020 2064  -2'.    ]).    d
-00032630: 6566 2074 6573 745f 6177 735f 7265 6769  ef test_aws_regi
-00032640: 6f6e 7328 7365 6c66 2c20 746d 705f 6c6f  ons(self, tmp_lo
-00032650: 6361 6c5f 7374 6f72 6167 655f 6f62 6a2c  cal_storage_obj,
-00032660: 2072 6567 696f 6e29 3a0a 2020 2020 2020   region):.      
-00032670: 2020 2320 5468 6973 2074 6573 7473 2063    # This tests c
-00032680: 7265 6174 696f 6e20 616e 6420 7570 6c6f  reation and uplo
-00032690: 6164 2074 6f20 6275 636b 6574 2069 6e20  ad to bucket in 
-000326a0: 616c 6c20 4157 5320 7333 2072 6567 696f  all AWS s3 regio
-000326b0: 6e73 0a20 2020 2020 2020 2023 2054 6f20  ns.        # To 
-000326c0: 7465 7374 2066 756c 6c20 6675 6e63 7469  test full functi
-000326d0: 6f6e 616c 6974 792c 2075 7365 2074 6573  onality, use tes
-000326e0: 745f 6d61 6e61 6765 645f 6a6f 6273 5f73  t_managed_jobs_s
-000326f0: 746f 7261 6765 2061 626f 7665 2e0a 2020  torage above..  
-00032700: 2020 2020 2020 7374 6f72 655f 7479 7065        store_type
-00032710: 203d 2073 746f 7261 6765 5f6c 6962 2e53   = storage_lib.S
-00032720: 746f 7265 5479 7065 2e53 330a 2020 2020  toreType.S3.    
-00032730: 2020 2020 746d 705f 6c6f 6361 6c5f 7374      tmp_local_st
-00032740: 6f72 6167 655f 6f62 6a2e 6164 645f 7374  orage_obj.add_st
-00032750: 6f72 6528 7374 6f72 655f 7479 7065 2c20  ore(store_type, 
-00032760: 7265 6769 6f6e 3d72 6567 696f 6e29 0a20  region=region). 
-00032770: 2020 2020 2020 2062 7563 6b65 745f 6e61         bucket_na
-00032780: 6d65 203d 2074 6d70 5f6c 6f63 616c 5f73  me = tmp_local_s
-00032790: 746f 7261 6765 5f6f 626a 2e6e 616d 650a  torage_obj.name.
-000327a0: 0a20 2020 2020 2020 2023 2043 6f6e 6669  .        # Confi
-000327b0: 726d 2074 6861 7420 7468 6520 6275 636b  rm that the buck
-000327c0: 6574 2077 6173 2063 7265 6174 6564 2069  et was created i
-000327d0: 6e20 7468 6520 636f 7272 6563 7420 7265  n the correct re
-000327e0: 6769 6f6e 0a20 2020 2020 2020 2072 6567  gion.        reg
-000327f0: 696f 6e5f 636d 6420 3d20 7365 6c66 2e63  ion_cmd = self.c
-00032800: 6c69 5f72 6567 696f 6e5f 636d 6428 7374  li_region_cmd(st
-00032810: 6f72 655f 7479 7065 2c20 6275 636b 6574  ore_type, bucket
-00032820: 5f6e 616d 6529 0a20 2020 2020 2020 206f  _name).        o
-00032830: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
-00032840: 6368 6563 6b5f 6f75 7470 7574 2872 6567  check_output(reg
-00032850: 696f 6e5f 636d 642c 2073 6865 6c6c 3d54  ion_cmd, shell=T
-00032860: 7275 6529 0a20 2020 2020 2020 206f 7574  rue).        out
-00032870: 7075 7420 3d20 6f75 742e 6465 636f 6465  put = out.decode
-00032880: 2827 7574 662d 3827 290a 2020 2020 2020  ('utf-8').      
-00032890: 2020 6578 7065 6374 6564 5f6f 7574 7075    expected_outpu
-000328a0: 745f 7265 6769 6f6e 203d 2072 6567 696f  t_region = regio
-000328b0: 6e0a 2020 2020 2020 2020 6966 2072 6567  n.        if reg
-000328c0: 696f 6e20 3d3d 2027 7573 2d65 6173 742d  ion == 'us-east-
-000328d0: 3127 3a0a 2020 2020 2020 2020 2020 2020  1':.            
-000328e0: 6578 7065 6374 6564 5f6f 7574 7075 745f  expected_output_
-000328f0: 7265 6769 6f6e 203d 2027 4e6f 6e65 2720  region = 'None' 
-00032900: 2023 2075 732d 6561 7374 2d31 2069 7320   # us-east-1 is 
-00032910: 7468 6520 6465 6661 756c 7420 7265 6769  the default regi
-00032920: 6f6e 0a20 2020 2020 2020 2061 7373 6572  on.        asser
-00032930: 7420 6578 7065 6374 6564 5f6f 7574 7075  t expected_outpu
-00032940: 745f 7265 6769 6f6e 2069 6e20 6f75 742e  t_region in out.
-00032950: 6465 636f 6465 2827 7574 662d 3827 292c  decode('utf-8'),
-00032960: 2028 0a20 2020 2020 2020 2020 2020 2066   (.            f
-00032970: 2742 7563 6b65 7420 7761 7320 6e6f 7420  'Bucket was not 
-00032980: 666f 756e 6420 696e 2072 6567 696f 6e20  found in region 
-00032990: 7b72 6567 696f 6e7d 202d 2027 0a20 2020  {region} - '.   
-000329a0: 2020 2020 2020 2020 2066 276f 7574 7075           f'outpu
-000329b0: 7420 6f66 207b 7265 6769 6f6e 5f63 6d64  t of {region_cmd
-000329c0: 7d20 7761 733a 207b 6f75 7470 7574 7d27  } was: {output}'
-000329d0: 290a 0a20 2020 2020 2020 2023 2043 6865  )..        # Che
-000329e0: 636b 2069 6620 746d 705f 736f 7572 6365  ck if tmp_source
-000329f0: 2f74 6d70 2d66 696c 6520 6578 6973 7473  /tmp-file exists
-00032a00: 2069 6e20 7468 6520 6275 636b 6574 2075   in the bucket u
-00032a10: 7369 6e67 2063 6c69 0a20 2020 2020 2020  sing cli.       
-00032a20: 206c 735f 636d 6420 3d20 7365 6c66 2e63   ls_cmd = self.c
-00032a30: 6c69 5f6c 735f 636d 6428 7374 6f72 655f  li_ls_cmd(store_
-00032a40: 7479 7065 2c20 6275 636b 6574 5f6e 616d  type, bucket_nam
-00032a50: 6529 0a20 2020 2020 2020 206f 7574 203d  e).        out =
-00032a60: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-00032a70: 6b5f 6f75 7470 7574 286c 735f 636d 642c  k_output(ls_cmd,
-00032a80: 2073 6865 6c6c 3d54 7275 6529 0a20 2020   shell=True).   
-00032a90: 2020 2020 206f 7574 7075 7420 3d20 6f75       output = ou
-00032aa0: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
-00032ab0: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-00032ac0: 2027 746d 702d 6669 6c65 2720 696e 206f   'tmp-file' in o
-00032ad0: 7574 7075 742c 2028 0a20 2020 2020 2020  utput, (.       
-00032ae0: 2020 2020 2066 2774 6d70 2d66 696c 6520       f'tmp-file 
-00032af0: 6e6f 7420 666f 756e 6420 696e 2062 7563  not found in buc
-00032b00: 6b65 7420 2d20 6f75 7470 7574 206f 6620  ket - output of 
-00032b10: 7b6c 735f 636d 647d 2077 6173 3a20 7b6f  {ls_cmd} was: {o
-00032b20: 7574 7075 747d 2729 0a0a 2020 2020 4070  utput}')..    @p
-00032b30: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
-00032b40: 7569 6473 7461 636b 0a20 2020 2040 7079  uidstack.    @py
-00032b50: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
-00032b60: 7472 697a 6528 2772 6567 696f 6e27 2c20  trize('region', 
-00032b70: 5b0a 2020 2020 2020 2020 276e 6f72 7468  [.        'north
-00032b80: 616d 6572 6963 612d 6e6f 7274 6865 6173  america-northeas
-00032b90: 7431 272c 2027 6e6f 7274 6861 6d65 7269  t1', 'northameri
-00032ba0: 6361 2d6e 6f72 7468 6561 7374 3227 2c20  ca-northeast2', 
-00032bb0: 2775 732d 6365 6e74 7261 6c31 272c 0a20  'us-central1',. 
-00032bc0: 2020 2020 2020 2027 7573 2d65 6173 7431         'us-east1
-00032bd0: 272c 2027 7573 2d65 6173 7434 272c 2027  ', 'us-east4', '
-00032be0: 7573 2d65 6173 7435 272c 2027 7573 2d73  us-east5', 'us-s
-00032bf0: 6f75 7468 3127 2c20 2775 732d 7765 7374  outh1', 'us-west
-00032c00: 3127 2c20 2775 732d 7765 7374 3227 2c0a  1', 'us-west2',.
-00032c10: 2020 2020 2020 2020 2775 732d 7765 7374          'us-west
-00032c20: 3327 2c20 2775 732d 7765 7374 3427 2c20  3', 'us-west4', 
-00032c30: 2773 6f75 7468 616d 6572 6963 612d 6561  'southamerica-ea
-00032c40: 7374 3127 2c20 2773 6f75 7468 616d 6572  st1', 'southamer
-00032c50: 6963 612d 7765 7374 3127 2c0a 2020 2020  ica-west1',.    
-00032c60: 2020 2020 2765 7572 6f70 652d 6365 6e74      'europe-cent
-00032c70: 7261 6c32 272c 2027 6575 726f 7065 2d6e  ral2', 'europe-n
-00032c80: 6f72 7468 3127 2c20 2765 7572 6f70 652d  orth1', 'europe-
-00032c90: 736f 7574 6877 6573 7431 272c 2027 6575  southwest1', 'eu
-00032ca0: 726f 7065 2d77 6573 7431 272c 0a20 2020  rope-west1',.   
-00032cb0: 2020 2020 2027 6575 726f 7065 2d77 6573       'europe-wes
-00032cc0: 7432 272c 2027 6575 726f 7065 2d77 6573  t2', 'europe-wes
-00032cd0: 7433 272c 2027 6575 726f 7065 2d77 6573  t3', 'europe-wes
-00032ce0: 7434 272c 2027 6575 726f 7065 2d77 6573  t4', 'europe-wes
-00032cf0: 7436 272c 0a20 2020 2020 2020 2027 6575  t6',.        'eu
-00032d00: 726f 7065 2d77 6573 7438 272c 2027 6575  rope-west8', 'eu
-00032d10: 726f 7065 2d77 6573 7439 272c 2027 6575  rope-west9', 'eu
-00032d20: 726f 7065 2d77 6573 7431 3027 2c20 2765  rope-west10', 'e
-00032d30: 7572 6f70 652d 7765 7374 3132 272c 0a20  urope-west12',. 
-00032d40: 2020 2020 2020 2027 6173 6961 2d65 6173         'asia-eas
-00032d50: 7431 272c 2027 6173 6961 2d65 6173 7432  t1', 'asia-east2
-00032d60: 272c 2027 6173 6961 2d6e 6f72 7468 6561  ', 'asia-northea
-00032d70: 7374 3127 2c20 2761 7369 612d 6e6f 7274  st1', 'asia-nort
-00032d80: 6865 6173 7432 272c 0a20 2020 2020 2020  heast2',.       
-00032d90: 2027 6173 6961 2d6e 6f72 7468 6561 7374   'asia-northeast
-00032da0: 3327 2c20 2761 7369 612d 736f 7574 6865  3', 'asia-southe
-00032db0: 6173 7431 272c 2027 6173 6961 2d73 6f75  ast1', 'asia-sou
-00032dc0: 7468 3127 2c20 2761 7369 612d 736f 7574  th1', 'asia-sout
-00032dd0: 6832 272c 0a20 2020 2020 2020 2027 6173  h2',.        'as
-00032de0: 6961 2d73 6f75 7468 6561 7374 3227 2c20  ia-southeast2', 
-00032df0: 276d 652d 6365 6e74 7261 6c31 272c 2027  'me-central1', '
-00032e00: 6d65 2d63 656e 7472 616c 3227 2c20 276d  me-central2', 'm
-00032e10: 652d 7765 7374 3127 2c0a 2020 2020 2020  e-west1',.      
-00032e20: 2020 2761 7573 7472 616c 6961 2d73 6f75    'australia-sou
-00032e30: 7468 6561 7374 3127 2c20 2761 7573 7472  theast1', 'austr
-00032e40: 616c 6961 2d73 6f75 7468 6561 7374 3227  alia-southeast2'
-00032e50: 2c20 2761 6672 6963 612d 736f 7574 6831  , 'africa-south1
-00032e60: 270a 2020 2020 5d29 0a20 2020 2064 6566  '.    ]).    def
-00032e70: 2074 6573 745f 6763 735f 7265 6769 6f6e   test_gcs_region
-00032e80: 7328 7365 6c66 2c20 746d 705f 6c6f 6361  s(self, tmp_loca
-00032e90: 6c5f 7374 6f72 6167 655f 6f62 6a2c 2072  l_storage_obj, r
-00032ea0: 6567 696f 6e29 3a0a 2020 2020 2020 2020  egion):.        
-00032eb0: 2320 5468 6973 2074 6573 7473 2063 7265  # This tests cre
-00032ec0: 6174 696f 6e20 616e 6420 7570 6c6f 6164  ation and upload
-00032ed0: 2074 6f20 6275 636b 6574 2069 6e20 616c   to bucket in al
-00032ee0: 6c20 4743 5320 7265 6769 6f6e 730a 2020  l GCS regions.  
-00032ef0: 2020 2020 2020 2320 546f 2074 6573 7420        # To test 
-00032f00: 6675 6c6c 2066 756e 6374 696f 6e61 6c69  full functionali
-00032f10: 7479 2c20 7573 6520 7465 7374 5f6d 616e  ty, use test_man
-00032f20: 6167 6564 5f6a 6f62 735f 7374 6f72 6167  aged_jobs_storag
-00032f30: 6520 6162 6f76 652e 0a20 2020 2020 2020  e above..       
-00032f40: 2073 746f 7265 5f74 7970 6520 3d20 7374   store_type = st
-00032f50: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-00032f60: 7970 652e 4743 530a 2020 2020 2020 2020  ype.GCS.        
-00032f70: 746d 705f 6c6f 6361 6c5f 7374 6f72 6167  tmp_local_storag
-00032f80: 655f 6f62 6a2e 6164 645f 7374 6f72 6528  e_obj.add_store(
-00032f90: 7374 6f72 655f 7479 7065 2c20 7265 6769  store_type, regi
-00032fa0: 6f6e 3d72 6567 696f 6e29 0a20 2020 2020  on=region).     
-00032fb0: 2020 2062 7563 6b65 745f 6e61 6d65 203d     bucket_name =
-00032fc0: 2074 6d70 5f6c 6f63 616c 5f73 746f 7261   tmp_local_stora
-00032fd0: 6765 5f6f 626a 2e6e 616d 650a 0a20 2020  ge_obj.name..   
-00032fe0: 2020 2020 2023 2043 6f6e 6669 726d 2074       # Confirm t
-00032ff0: 6861 7420 7468 6520 6275 636b 6574 2077  hat the bucket w
-00033000: 6173 2063 7265 6174 6564 2069 6e20 7468  as created in th
-00033010: 6520 636f 7272 6563 7420 7265 6769 6f6e  e correct region
-00033020: 0a20 2020 2020 2020 2072 6567 696f 6e5f  .        region_
-00033030: 636d 6420 3d20 7365 6c66 2e63 6c69 5f72  cmd = self.cli_r
-00033040: 6567 696f 6e5f 636d 6428 7374 6f72 655f  egion_cmd(store_
-00033050: 7479 7065 2c20 6275 636b 6574 5f6e 616d  type, bucket_nam
-00033060: 6529 0a20 2020 2020 2020 206f 7574 203d  e).        out =
-00033070: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-00033080: 6b5f 6f75 7470 7574 2872 6567 696f 6e5f  k_output(region_
-00033090: 636d 642c 2073 6865 6c6c 3d54 7275 6529  cmd, shell=True)
-000330a0: 0a20 2020 2020 2020 206f 7574 7075 7420  .        output 
-000330b0: 3d20 6f75 742e 6465 636f 6465 2827 7574  = out.decode('ut
-000330c0: 662d 3827 290a 2020 2020 2020 2020 6173  f-8').        as
-000330d0: 7365 7274 2072 6567 696f 6e20 696e 206f  sert region in o
-000330e0: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
-000330f0: 2729 2c20 280a 2020 2020 2020 2020 2020  '), (.          
-00033100: 2020 6627 4275 636b 6574 2077 6173 206e    f'Bucket was n
-00033110: 6f74 2066 6f75 6e64 2069 6e20 7265 6769  ot found in regi
-00033120: 6f6e 207b 7265 6769 6f6e 7d20 2d20 270a  on {region} - '.
-00033130: 2020 2020 2020 2020 2020 2020 6627 6f75              f'ou
-00033140: 7470 7574 206f 6620 7b72 6567 696f 6e5f  tput of {region_
-00033150: 636d 647d 2077 6173 3a20 7b6f 7574 7075  cmd} was: {outpu
-00033160: 747d 2729 0a0a 2020 2020 2020 2020 2320  t}')..        # 
-00033170: 4368 6563 6b20 6966 2074 6d70 5f73 6f75  Check if tmp_sou
-00033180: 7263 652f 746d 702d 6669 6c65 2065 7869  rce/tmp-file exi
-00033190: 7374 7320 696e 2074 6865 2062 7563 6b65  sts in the bucke
-000331a0: 7420 7573 696e 6720 636c 690a 2020 2020  t using cli.    
-000331b0: 2020 2020 6c73 5f63 6d64 203d 2073 656c      ls_cmd = sel
-000331c0: 662e 636c 695f 6c73 5f63 6d64 2873 746f  f.cli_ls_cmd(sto
-000331d0: 7265 5f74 7970 652c 2062 7563 6b65 745f  re_type, bucket_
-000331e0: 6e61 6d65 290a 2020 2020 2020 2020 6f75  name).        ou
-000331f0: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
-00033200: 6865 636b 5f6f 7574 7075 7428 6c73 5f63  heck_output(ls_c
-00033210: 6d64 2c20 7368 656c 6c3d 5472 7565 290a  md, shell=True).
-00033220: 2020 2020 2020 2020 6f75 7470 7574 203d          output =
-00033230: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
-00033240: 2d38 2729 0a20 2020 2020 2020 2061 7373  -8').        ass
-00033250: 6572 7420 2774 6d70 2d66 696c 6527 2069  ert 'tmp-file' i
-00033260: 6e20 6f75 7470 7574 2c20 280a 2020 2020  n output, (.    
-00033270: 2020 2020 2020 2020 6627 746d 702d 6669          f'tmp-fi
-00033280: 6c65 206e 6f74 2066 6f75 6e64 2069 6e20  le not found in 
-00033290: 6275 636b 6574 202d 206f 7574 7075 7420  bucket - output 
-000332a0: 6f66 207b 6c73 5f63 6d64 7d20 7761 733a  of {ls_cmd} was:
-000332b0: 207b 6f75 7470 7574 7d27 290a 0a0a 2320   {output}')...# 
-000332c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7469  ---------- Testi
-000332d0: 6e67 2059 414d 4c20 5370 6563 7320 2d2d  ng YAML Specs --
-000332e0: 2d2d 2d2d 2d2d 2d2d 0a23 204f 7572 2073  --------.# Our s
-000332f0: 6b79 2073 746f 7261 6765 2072 6571 7569  ky storage requi
-00033300: 7265 7320 6372 6564 656e 7469 616c 7320  res credentials 
-00033310: 746f 2063 6865 636b 2074 6865 2062 7563  to check the buc
-00033320: 6b65 7420 6578 6973 7461 6e63 6520 7768  ket existance wh
-00033330: 656e 0a23 206c 6f61 6469 6e67 2061 2074  en.# loading a t
-00033340: 6173 6b20 6672 6f6d 2074 6865 2079 616d  ask from the yam
-00033350: 6c20 6669 6c65 2c20 736f 2077 6520 6361  l file, so we ca
-00033360: 6e6e 6f74 206d 616b 6520 6974 2061 2075  nnot make it a u
-00033370: 6e69 7420 7465 7374 2e0a 636c 6173 7320  nit test..class 
-00033380: 5465 7374 5961 6d6c 5370 6563 733a 0a20  TestYamlSpecs:. 
-00033390: 2020 2023 2054 4f44 4f28 7a68 7775 293a     # TODO(zhwu):
-000333a0: 2041 6464 2074 6573 7420 666f 7220 6074   Add test for `t
-000333b0: 6f5f 7961 6d6c 5f63 6f6e 6669 6760 2066  o_yaml_config` f
-000333c0: 6f72 2074 6865 2053 746f 7261 6765 206f  or the Storage o
-000333d0: 626a 6563 742e 0a20 2020 2023 2020 5765  bject..    #  We
-000333e0: 2073 686f 756c 6420 6e6f 7420 7573 6520   should not use 
-000333f0: 6065 7861 6d70 6c65 732f 7374 6f72 6167  `examples/storag
-00033400: 655f 6465 6d6f 2e79 616d 6c60 2068 6572  e_demo.yaml` her
-00033410: 652c 2073 696e 6365 2069 7420 7265 7175  e, since it requ
-00033420: 6972 6573 0a20 2020 2023 2020 7573 6572  ires.    #  user
-00033430: 7320 746f 2065 6e73 7572 6520 6275 636b  s to ensure buck
-00033440: 6574 206e 616d 6573 2074 6f20 6e6f 7420  et names to not 
-00033450: 6578 6973 7420 616e 642f 6f72 2062 6520  exist and/or be 
-00033460: 756e 6971 7565 2e0a 2020 2020 5f54 4553  unique..    _TES
-00033470: 545f 5941 4d4c 5f50 4154 4853 203d 205b  T_YAML_PATHS = [
-00033480: 0a20 2020 2020 2020 2027 6578 616d 706c  .        'exampl
-00033490: 6573 2f6d 696e 696d 616c 2e79 616d 6c27  es/minimal.yaml'
-000334a0: 2c20 2765 7861 6d70 6c65 732f 6d61 6e61  , 'examples/mana
-000334b0: 6765 645f 6a6f 622e 7961 6d6c 272c 0a20  ged_job.yaml',. 
-000334c0: 2020 2020 2020 2027 6578 616d 706c 6573         'examples
-000334d0: 2f75 7369 6e67 5f66 696c 655f 6d6f 756e  /using_file_moun
-000334e0: 7473 2e79 616d 6c27 2c20 2765 7861 6d70  ts.yaml', 'examp
-000334f0: 6c65 732f 7265 736e 6574 5f61 7070 2e79  les/resnet_app.y
-00033500: 616d 6c27 2c0a 2020 2020 2020 2020 2765  aml',.        'e
-00033510: 7861 6d70 6c65 732f 6d75 6c74 695f 686f  xamples/multi_ho
-00033520: 7374 6e61 6d65 2e79 616d 6c27 0a20 2020  stname.yaml'.   
-00033530: 205d 0a0a 2020 2020 6465 6620 5f69 735f   ]..    def _is_
-00033540: 6469 6374 5f73 7562 7365 7428 7365 6c66  dict_subset(self
-00033550: 2c20 6431 2c20 6432 293a 0a20 2020 2020  , d1, d2):.     
-00033560: 2020 2022 2222 4368 6563 6b20 6966 2064     """Check if d
-00033570: 3120 6973 2074 6865 2073 7562 7365 7420  1 is the subset 
-00033580: 6f66 2064 322e 2222 220a 2020 2020 2020  of d2.""".      
-00033590: 2020 666f 7220 6b2c 2076 2069 6e20 6431    for k, v in d1
-000335a0: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-000335b0: 2020 2020 2020 6966 206b 206e 6f74 2069        if k not i
-000335c0: 6e20 6432 3a0a 2020 2020 2020 2020 2020  n d2:.          
-000335d0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-000335e0: 6e63 6528 762c 206c 6973 7429 206f 7220  nce(v, list) or 
-000335f0: 6973 696e 7374 616e 6365 2876 2c20 6469  isinstance(v, di
-00033600: 6374 293a 0a20 2020 2020 2020 2020 2020  ct):.           
-00033610: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00033620: 6c65 6e28 7629 203d 3d20 302c 2028 6b2c  len(v) == 0, (k,
-00033630: 2076 290a 2020 2020 2020 2020 2020 2020   v).            
-00033640: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00033650: 2020 2020 2020 2020 2020 2020 2020 6173                as
-00033660: 7365 7274 2046 616c 7365 2c20 286b 2c20  sert False, (k, 
-00033670: 7629 0a20 2020 2020 2020 2020 2020 2065  v).            e
-00033680: 6c69 6620 6973 696e 7374 616e 6365 2876  lif isinstance(v
-00033690: 2c20 6469 6374 293a 0a20 2020 2020 2020  , dict):.       
-000336a0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-000336b0: 6973 696e 7374 616e 6365 2864 325b 6b5d  isinstance(d2[k]
-000336c0: 2c20 6469 6374 292c 2028 6b2c 2076 2c20  , dict), (k, v, 
-000336d0: 6432 290a 2020 2020 2020 2020 2020 2020  d2).            
-000336e0: 2020 2020 7365 6c66 2e5f 6973 5f64 6963      self._is_dic
-000336f0: 745f 7375 6273 6574 2876 2c20 6432 5b6b  t_subset(v, d2[k
-00033700: 5d29 0a20 2020 2020 2020 2020 2020 2065  ]).            e
-00033710: 6c69 6620 6973 696e 7374 616e 6365 2876  lif isinstance(v
-00033720: 2c20 7374 7229 3a0a 2020 2020 2020 2020  , str):.        
-00033730: 2020 2020 2020 2020 6966 206b 203d 3d20          if k == 
-00033740: 2761 6363 656c 6572 6174 6f72 7327 3a0a  'accelerators':.
-00033750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033760: 2020 2020 7265 736f 7572 6365 7320 3d20      resources = 
-00033770: 736b 792e 5265 736f 7572 6365 7328 290a  sky.Resources().
-00033780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033790: 2020 2020 7265 736f 7572 6365 732e 5f73      resources._s
-000337a0: 6574 5f61 6363 656c 6572 6174 6f72 7328  et_accelerators(
-000337b0: 762c 204e 6f6e 6529 0a20 2020 2020 2020  v, None).       
-000337c0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-000337d0: 6572 7420 7265 736f 7572 6365 732e 6163  ert resources.ac
-000337e0: 6365 6c65 7261 746f 7273 203d 3d20 6432  celerators == d2
-000337f0: 5b6b 5d2c 2028 6b2c 2076 2c20 6432 290a  [k], (k, v, d2).
-00033800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033810: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00033820: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00033830: 2076 2e6c 6f77 6572 2829 203d 3d20 6432   v.lower() == d2
-00033840: 5b6b 5d2e 6c6f 7765 7228 292c 2028 6b2c  [k].lower(), (k,
-00033850: 2076 2c20 6432 5b6b 5d29 0a20 2020 2020   v, d2[k]).     
-00033860: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00033870: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-00033880: 6572 7420 7620 3d3d 2064 325b 6b5d 2c20  ert v == d2[k], 
-00033890: 286b 2c20 762c 2064 325b 6b5d 290a 0a20  (k, v, d2[k]).. 
-000338a0: 2020 2064 6566 205f 6368 6563 6b5f 6571     def _check_eq
-000338b0: 7569 7661 6c65 6e74 2873 656c 662c 2079  uivalent(self, y
-000338c0: 616d 6c5f 7061 7468 293a 0a20 2020 2020  aml_path):.     
-000338d0: 2020 2022 2222 4368 6563 6b20 6966 2074     """Check if t
-000338e0: 6865 2079 616d 6c20 6973 2065 7175 6976  he yaml is equiv
-000338f0: 616c 656e 7420 6166 7465 7220 6c6f 6164  alent after load
-00033900: 2061 6e64 2064 756d 7020 6167 6169 6e2e   and dump again.
-00033910: 2222 220a 2020 2020 2020 2020 6f72 6967  """.        orig
-00033920: 696e 5f74 6173 6b5f 636f 6e66 6967 203d  in_task_config =
-00033930: 2063 6f6d 6d6f 6e5f 7574 696c 732e 7265   common_utils.re
-00033940: 6164 5f79 616d 6c28 7961 6d6c 5f70 6174  ad_yaml(yaml_pat
-00033950: 6829 0a0a 2020 2020 2020 2020 7461 736b  h)..        task
-00033960: 203d 2073 6b79 2e54 6173 6b2e 6672 6f6d   = sky.Task.from
-00033970: 5f79 616d 6c28 7961 6d6c 5f70 6174 6829  _yaml(yaml_path)
-00033980: 0a20 2020 2020 2020 206e 6577 5f74 6173  .        new_tas
-00033990: 6b5f 636f 6e66 6967 203d 2074 6173 6b2e  k_config = task.
-000339a0: 746f 5f79 616d 6c5f 636f 6e66 6967 2829  to_yaml_config()
-000339b0: 0a20 2020 2020 2020 2023 2064 3120 3c3d  .        # d1 <=
-000339c0: 2064 320a 2020 2020 2020 2020 7072 696e   d2.        prin
-000339d0: 7428 6f72 6967 696e 5f74 6173 6b5f 636f  t(origin_task_co
-000339e0: 6e66 6967 2c20 6e65 775f 7461 736b 5f63  nfig, new_task_c
-000339f0: 6f6e 6669 6729 0a20 2020 2020 2020 2073  onfig).        s
-00033a00: 656c 662e 5f69 735f 6469 6374 5f73 7562  elf._is_dict_sub
-00033a10: 7365 7428 6f72 6967 696e 5f74 6173 6b5f  set(origin_task_
-00033a20: 636f 6e66 6967 2c20 6e65 775f 7461 736b  config, new_task
-00033a30: 5f63 6f6e 6669 6729 0a0a 2020 2020 6465  _config)..    de
-00033a40: 6620 7465 7374 5f6c 6f61 645f 6475 6d70  f test_load_dump
-00033a50: 5f79 616d 6c5f 636f 6e66 6967 5f65 7175  _yaml_config_equ
-00033a60: 6976 616c 656e 7428 7365 6c66 293a 0a20  ivalent(self):. 
-00033a70: 2020 2020 2020 2022 2222 5465 7374 2069         """Test i
-00033a80: 6620 7468 6520 7961 6d6c 2063 6f6e 6669  f the yaml confi
-00033a90: 6720 6973 2065 7175 6976 616c 656e 7420  g is equivalent 
-00033aa0: 6166 7465 7220 6c6f 6164 2061 6e64 2064  after load and d
-00033ab0: 756d 7020 6167 6169 6e2e 2222 220a 2020  ump again.""".  
-00033ac0: 2020 2020 2020 7061 7468 6c69 622e 5061        pathlib.Pa
-00033ad0: 7468 2827 7e2f 6461 7461 7365 7473 2729  th('~/datasets')
-00033ae0: 2e65 7870 616e 6475 7365 7228 292e 6d6b  .expanduser().mk
-00033af0: 6469 7228 6578 6973 745f 6f6b 3d54 7275  dir(exist_ok=Tru
-00033b00: 6529 0a20 2020 2020 2020 2070 6174 686c  e).        pathl
-00033b10: 6962 2e50 6174 6828 277e 2f74 6d70 6669  ib.Path('~/tmpfi
-00033b20: 6c65 2729 2e65 7870 616e 6475 7365 7228  le').expanduser(
-00033b30: 292e 746f 7563 6828 290a 2020 2020 2020  ).touch().      
-00033b40: 2020 7061 7468 6c69 622e 5061 7468 2827    pathlib.Path('
-00033b50: 7e2f 2e73 7368 2729 2e65 7870 616e 6475  ~/.ssh').expandu
-00033b60: 7365 7228 292e 6d6b 6469 7228 6578 6973  ser().mkdir(exis
-00033b70: 745f 6f6b 3d54 7275 6529 0a20 2020 2020  t_ok=True).     
-00033b80: 2020 2070 6174 686c 6962 2e50 6174 6828     pathlib.Path(
-00033b90: 277e 2f2e 7373 682f 6964 5f72 7361 2e70  '~/.ssh/id_rsa.p
-00033ba0: 7562 2729 2e65 7870 616e 6475 7365 7228  ub').expanduser(
-00033bb0: 292e 746f 7563 6828 290a 2020 2020 2020  ).touch().      
-00033bc0: 2020 7061 7468 6c69 622e 5061 7468 2827    pathlib.Path('
-00033bd0: 7e2f 746d 702d 776f 726b 6469 7227 292e  ~/tmp-workdir').
-00033be0: 6578 7061 6e64 7573 6572 2829 2e6d 6b64  expanduser().mkd
-00033bf0: 6972 2865 7869 7374 5f6f 6b3d 5472 7565  ir(exist_ok=True
-00033c00: 290a 2020 2020 2020 2020 7061 7468 6c69  ).        pathli
-00033c10: 622e 5061 7468 2827 7e2f 446f 776e 6c6f  b.Path('~/Downlo
-00033c20: 6164 732f 7470 7527 292e 6578 7061 6e64  ads/tpu').expand
-00033c30: 7573 6572 2829 2e6d 6b64 6972 2870 6172  user().mkdir(par
-00033c40: 656e 7473 3d54 7275 652c 0a20 2020 2020  ents=True,.     
-00033c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031ea0: 2020 2020 2020 2020 2020 6d61 726b 733d            marks=
+00031eb0: 7079 7465 7374 2e6d 6172 6b2e 636c 6f75  pytest.mark.clou
+00031ec0: 6466 6c61 7265 295d 290a 2020 2020 6465  dflare)]).    de
+00031ed0: 6620 7465 7374 5f65 7874 6572 6e61 6c6c  f test_externall
+00031ee0: 795f 6372 6561 7465 645f 6275 636b 6574  y_created_bucket
+00031ef0: 5f6d 6f75 6e74 5f77 6974 686f 7574 5f73  _mount_without_s
+00031f00: 6f75 7263 6528 0a20 2020 2020 2020 2020  ource(.         
+00031f10: 2020 2073 656c 662c 2065 7874 5f62 7563     self, ext_buc
+00031f20: 6b65 745f 6669 7874 7572 652c 2072 6571  ket_fixture, req
+00031f30: 7565 7374 2c20 7374 6f72 655f 7479 7065  uest, store_type
+00031f40: 293a 0a20 2020 2020 2020 2023 204e 6f6e  ):.        # Non
+00031f50: 2d73 6b79 206d 616e 6167 6564 2062 7563  -sky managed buc
+00031f60: 6b65 7473 2862 7563 6b65 7473 2063 7265  kets(buckets cre
+00031f70: 6174 6564 206f 7574 7369 6465 206f 6620  ated outside of 
+00031f80: 536b 7970 696c 6f74 2043 4c49 290a 2020  Skypilot CLI).  
+00031f90: 2020 2020 2020 2320 6172 6520 616c 6c6f        # are allo
+00031fa0: 7765 6420 746f 2062 6520 4d4f 554e 5465  wed to be MOUNTe
+00031fb0: 6420 6279 2073 7065 6369 6679 696e 6720  d by specifying 
+00031fc0: 7468 6520 5552 4920 6f66 2074 6865 2062  the URI of the b
+00031fd0: 7563 6b65 7420 746f 0a20 2020 2020 2020  ucket to.       
+00031fe0: 2023 2073 6f75 7263 6520 6669 656c 6420   # source field 
+00031ff0: 6f6e 6c79 2e20 5768 656e 2069 7420 6973  only. When it is
+00032000: 2061 7474 656d 7074 6564 2062 7920 7370   attempted by sp
+00032010: 6563 6966 7969 6e67 2074 6865 206e 616d  ecifying the nam
+00032020: 6520 6f66 0a20 2020 2020 2020 2023 2074  e of.        # t
+00032030: 6865 2062 7563 6b65 7420 6f6e 6c79 2c20  he bucket only, 
+00032040: 6974 2073 686f 756c 6420 6572 726f 7220  it should error 
+00032050: 6f75 742e 0a20 2020 2020 2020 2023 0a20  out..        #. 
+00032060: 2020 2020 2020 2023 2054 4f44 4f28 646f         # TODO(do
+00032070: 796f 756e 6729 3a20 4164 6420 7465 7374  young): Add test
+00032080: 2066 6f72 2049 424d 2043 4f53 2e20 4375   for IBM COS. Cu
+00032090: 7272 656e 746c 792c 2074 6869 7320 6973  rrently, this is
+000320a0: 2062 6c6f 636b 6564 0a20 2020 2020 2020   blocked.       
+000320b0: 2023 2061 7320 7263 6c6f 6e65 2075 7365   # as rclone use
+000320c0: 6420 746f 2069 6e74 6572 6163 7420 7769  d to interact wi
+000320d0: 7468 2049 424d 2043 4f53 2064 6f65 7320  th IBM COS does 
+000320e0: 6e6f 7420 7375 7070 6f72 7420 6665 6174  not support feat
+000320f0: 7572 6520 746f 0a20 2020 2020 2020 2023  ure to.        #
+00032100: 2063 7265 6174 6520 6120 6275 636b 6574   create a bucket
+00032110: 2c20 616e 6420 7468 6520 6962 6d63 6c6f  , and the ibmclo
+00032120: 7564 2043 4c49 2069 7320 6e6f 7420 7375  ud CLI is not su
+00032130: 7070 6f72 7465 6420 696e 2053 6b79 7069  pported in Skypi
+00032140: 6c6f 742e 0a20 2020 2020 2020 2023 2045  lot..        # E
+00032150: 6974 6865 7220 6f66 2074 6865 2066 6561  ither of the fea
+00032160: 7475 7265 2069 7320 6e65 6365 7373 6172  ture is necessar
+00032170: 7920 746f 2073 696d 756c 6174 6520 616e  y to simulate an
+00032180: 2065 7874 6572 6e61 6c20 6275 636b 6574   external bucket
+00032190: 0a20 2020 2020 2020 2023 2063 7265 6174  .        # creat
+000321a0: 696f 6e20 666f 7220 4942 4d20 434f 532e  ion for IBM COS.
+000321b0: 0a20 2020 2020 2020 2023 2068 7474 7073  .        # https
+000321c0: 3a2f 2f67 6974 6875 622e 636f 6d2f 736b  ://github.com/sk
+000321d0: 7970 696c 6f74 2d6f 7267 2f73 6b79 7069  ypilot-org/skypi
+000321e0: 6c6f 742f 7075 6c6c 2f31 3936 362f 6669  lot/pull/1966/fi
+000321f0: 6c65 7323 7231 3235 3334 3339 3833 370a  les#r1253439837.
+00032200: 0a20 2020 2020 2020 2065 7874 5f62 7563  .        ext_buc
+00032210: 6b65 745f 6e61 6d65 2c20 6578 745f 6275  ket_name, ext_bu
+00032220: 636b 6574 5f75 7269 203d 2072 6571 7565  cket_uri = reque
+00032230: 7374 2e67 6574 6669 7874 7572 6576 616c  st.getfixtureval
+00032240: 7565 280a 2020 2020 2020 2020 2020 2020  ue(.            
+00032250: 6578 745f 6275 636b 6574 5f66 6978 7475  ext_bucket_fixtu
+00032260: 7265 290a 2020 2020 2020 2020 2320 696e  re).        # in
+00032270: 7661 6c69 6420 7370 6563 0a20 2020 2020  valid spec.     
+00032280: 2020 2077 6974 6820 7079 7465 7374 2e72     with pytest.r
+00032290: 6169 7365 7328 736b 792e 6578 6365 7074  aises(sky.except
+000322a0: 696f 6e73 2e53 746f 7261 6765 5370 6563  ions.StorageSpec
+000322b0: 4572 726f 7229 2061 7320 653a 0a20 2020  Error) as e:.   
+000322c0: 2020 2020 2020 2020 2073 746f 7261 6765           storage
+000322d0: 5f6f 626a 203d 2073 746f 7261 6765 5f6c  _obj = storage_l
+000322e0: 6962 2e53 746f 7261 6765 280a 2020 2020  ib.Storage(.    
+000322f0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00032300: 3d65 7874 5f62 7563 6b65 745f 6e61 6d65  =ext_bucket_name
+00032310: 2c20 6d6f 6465 3d73 746f 7261 6765 5f6c  , mode=storage_l
+00032320: 6962 2e53 746f 7261 6765 4d6f 6465 2e4d  ib.StorageMode.M
+00032330: 4f55 4e54 290a 2020 2020 2020 2020 2020  OUNT).          
+00032340: 2020 7374 6f72 6167 655f 6f62 6a2e 6164    storage_obj.ad
+00032350: 645f 7374 6f72 6528 7374 6f72 655f 7479  d_store(store_ty
+00032360: 7065 290a 0a20 2020 2020 2020 2061 7373  pe)..        ass
+00032370: 6572 7420 2741 7474 656d 7074 6564 2074  ert 'Attempted t
+00032380: 6f20 6d6f 756e 7420 6120 6e6f 6e2d 736b  o mount a non-sk
+00032390: 7920 6d61 6e61 6765 6420 6275 636b 6574  y managed bucket
+000323a0: 2720 696e 2073 7472 2865 290a 0a20 2020  ' in str(e)..   
+000323b0: 2020 2020 2023 2076 616c 6964 2073 7065       # valid spe
+000323c0: 630a 2020 2020 2020 2020 7374 6f72 6167  c.        storag
+000323d0: 655f 6f62 6a20 3d20 7374 6f72 6167 655f  e_obj = storage_
+000323e0: 6c69 622e 5374 6f72 6167 6528 736f 7572  lib.Storage(sour
+000323f0: 6365 3d65 7874 5f62 7563 6b65 745f 7572  ce=ext_bucket_ur
+00032400: 692c 0a20 2020 2020 2020 2020 2020 2020  i,.             
+00032410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032420: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
+00032430: 653d 7374 6f72 6167 655f 6c69 622e 5374  e=storage_lib.St
+00032440: 6f72 6167 654d 6f64 652e 4d4f 554e 5429  orageMode.MOUNT)
+00032450: 0a20 2020 2020 2020 2068 616e 646c 6520  .        handle 
+00032460: 3d20 676c 6f62 616c 5f75 7365 725f 7374  = global_user_st
+00032470: 6174 652e 6765 745f 6861 6e64 6c65 5f66  ate.get_handle_f
+00032480: 726f 6d5f 7374 6f72 6167 655f 6e61 6d65  rom_storage_name
+00032490: 280a 2020 2020 2020 2020 2020 2020 7374  (.            st
+000324a0: 6f72 6167 655f 6f62 6a2e 6e61 6d65 290a  orage_obj.name).
+000324b0: 2020 2020 2020 2020 6966 2068 616e 646c          if handl
+000324c0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+000324d0: 746f 7261 6765 5f6f 626a 2e64 656c 6574  torage_obj.delet
+000324e0: 6528 290a 0a20 2020 2040 7079 7465 7374  e()..    @pytest
+000324f0: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
+00032500: 6163 6b0a 2020 2020 4070 7974 6573 742e  ack.    @pytest.
+00032510: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
+00032520: 2827 7265 6769 6f6e 272c 205b 0a20 2020  ('region', [.   
+00032530: 2020 2020 2027 6170 2d6e 6f72 7468 6561       'ap-northea
+00032540: 7374 2d31 272c 2027 6170 2d6e 6f72 7468  st-1', 'ap-north
+00032550: 6561 7374 2d32 272c 2027 6170 2d6e 6f72  east-2', 'ap-nor
+00032560: 7468 6561 7374 2d33 272c 2027 6170 2d73  theast-3', 'ap-s
+00032570: 6f75 7468 2d31 272c 0a20 2020 2020 2020  outh-1',.       
+00032580: 2027 6170 2d73 6f75 7468 6561 7374 2d31   'ap-southeast-1
+00032590: 272c 2027 6170 2d73 6f75 7468 6561 7374  ', 'ap-southeast
+000325a0: 2d32 272c 2027 6575 2d63 656e 7472 616c  -2', 'eu-central
+000325b0: 2d31 272c 2027 6575 2d6e 6f72 7468 2d31  -1', 'eu-north-1
+000325c0: 272c 0a20 2020 2020 2020 2027 6575 2d77  ',.        'eu-w
+000325d0: 6573 742d 3127 2c20 2765 752d 7765 7374  est-1', 'eu-west
+000325e0: 2d32 272c 2027 6575 2d77 6573 742d 3327  -2', 'eu-west-3'
+000325f0: 2c20 2773 612d 6561 7374 2d31 272c 2027  , 'sa-east-1', '
+00032600: 7573 2d65 6173 742d 3127 2c0a 2020 2020  us-east-1',.    
+00032610: 2020 2020 2775 732d 6561 7374 2d32 272c      'us-east-2',
+00032620: 2027 7573 2d77 6573 742d 3127 2c20 2775   'us-west-1', 'u
+00032630: 732d 7765 7374 2d32 270a 2020 2020 5d29  s-west-2'.    ])
+00032640: 0a20 2020 2064 6566 2074 6573 745f 6177  .    def test_aw
+00032650: 735f 7265 6769 6f6e 7328 7365 6c66 2c20  s_regions(self, 
+00032660: 746d 705f 6c6f 6361 6c5f 7374 6f72 6167  tmp_local_storag
+00032670: 655f 6f62 6a2c 2072 6567 696f 6e29 3a0a  e_obj, region):.
+00032680: 2020 2020 2020 2020 2320 5468 6973 2074          # This t
+00032690: 6573 7473 2063 7265 6174 696f 6e20 616e  ests creation an
+000326a0: 6420 7570 6c6f 6164 2074 6f20 6275 636b  d upload to buck
+000326b0: 6574 2069 6e20 616c 6c20 4157 5320 7333  et in all AWS s3
+000326c0: 2072 6567 696f 6e73 0a20 2020 2020 2020   regions.       
+000326d0: 2023 2054 6f20 7465 7374 2066 756c 6c20   # To test full 
+000326e0: 6675 6e63 7469 6f6e 616c 6974 792c 2075  functionality, u
+000326f0: 7365 2074 6573 745f 6d61 6e61 6765 645f  se test_managed_
+00032700: 6a6f 6273 5f73 746f 7261 6765 2061 626f  jobs_storage abo
+00032710: 7665 2e0a 2020 2020 2020 2020 7374 6f72  ve..        stor
+00032720: 655f 7479 7065 203d 2073 746f 7261 6765  e_type = storage
+00032730: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
+00032740: 330a 2020 2020 2020 2020 746d 705f 6c6f  3.        tmp_lo
+00032750: 6361 6c5f 7374 6f72 6167 655f 6f62 6a2e  cal_storage_obj.
+00032760: 6164 645f 7374 6f72 6528 7374 6f72 655f  add_store(store_
+00032770: 7479 7065 2c20 7265 6769 6f6e 3d72 6567  type, region=reg
+00032780: 696f 6e29 0a20 2020 2020 2020 2062 7563  ion).        buc
+00032790: 6b65 745f 6e61 6d65 203d 2074 6d70 5f6c  ket_name = tmp_l
+000327a0: 6f63 616c 5f73 746f 7261 6765 5f6f 626a  ocal_storage_obj
+000327b0: 2e6e 616d 650a 0a20 2020 2020 2020 2023  .name..        #
+000327c0: 2043 6f6e 6669 726d 2074 6861 7420 7468   Confirm that th
+000327d0: 6520 6275 636b 6574 2077 6173 2063 7265  e bucket was cre
+000327e0: 6174 6564 2069 6e20 7468 6520 636f 7272  ated in the corr
+000327f0: 6563 7420 7265 6769 6f6e 0a20 2020 2020  ect region.     
+00032800: 2020 2072 6567 696f 6e5f 636d 6420 3d20     region_cmd = 
+00032810: 7365 6c66 2e63 6c69 5f72 6567 696f 6e5f  self.cli_region_
+00032820: 636d 6428 7374 6f72 655f 7479 7065 2c20  cmd(store_type, 
+00032830: 6275 636b 6574 5f6e 616d 6529 0a20 2020  bucket_name).   
+00032840: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
+00032850: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+00032860: 7574 2872 6567 696f 6e5f 636d 642c 2073  ut(region_cmd, s
+00032870: 6865 6c6c 3d54 7275 6529 0a20 2020 2020  hell=True).     
+00032880: 2020 206f 7574 7075 7420 3d20 6f75 742e     output = out.
+00032890: 6465 636f 6465 2827 7574 662d 3827 290a  decode('utf-8').
+000328a0: 2020 2020 2020 2020 6578 7065 6374 6564          expected
+000328b0: 5f6f 7574 7075 745f 7265 6769 6f6e 203d  _output_region =
+000328c0: 2072 6567 696f 6e0a 2020 2020 2020 2020   region.        
+000328d0: 6966 2072 6567 696f 6e20 3d3d 2027 7573  if region == 'us
+000328e0: 2d65 6173 742d 3127 3a0a 2020 2020 2020  -east-1':.      
+000328f0: 2020 2020 2020 6578 7065 6374 6564 5f6f        expected_o
+00032900: 7574 7075 745f 7265 6769 6f6e 203d 2027  utput_region = '
+00032910: 4e6f 6e65 2720 2023 2075 732d 6561 7374  None'  # us-east
+00032920: 2d31 2069 7320 7468 6520 6465 6661 756c  -1 is the defaul
+00032930: 7420 7265 6769 6f6e 0a20 2020 2020 2020  t region.       
+00032940: 2061 7373 6572 7420 6578 7065 6374 6564   assert expected
+00032950: 5f6f 7574 7075 745f 7265 6769 6f6e 2069  _output_region i
+00032960: 6e20 6f75 742e 6465 636f 6465 2827 7574  n out.decode('ut
+00032970: 662d 3827 292c 2028 0a20 2020 2020 2020  f-8'), (.       
+00032980: 2020 2020 2066 2742 7563 6b65 7420 7761       f'Bucket wa
+00032990: 7320 6e6f 7420 666f 756e 6420 696e 2072  s not found in r
+000329a0: 6567 696f 6e20 7b72 6567 696f 6e7d 202d  egion {region} -
+000329b0: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
+000329c0: 276f 7574 7075 7420 6f66 207b 7265 6769  'output of {regi
+000329d0: 6f6e 5f63 6d64 7d20 7761 733a 207b 6f75  on_cmd} was: {ou
+000329e0: 7470 7574 7d27 290a 0a20 2020 2020 2020  tput}')..       
+000329f0: 2023 2043 6865 636b 2069 6620 746d 705f   # Check if tmp_
+00032a00: 736f 7572 6365 2f74 6d70 2d66 696c 6520  source/tmp-file 
+00032a10: 6578 6973 7473 2069 6e20 7468 6520 6275  exists in the bu
+00032a20: 636b 6574 2075 7369 6e67 2063 6c69 0a20  cket using cli. 
+00032a30: 2020 2020 2020 206c 735f 636d 6420 3d20         ls_cmd = 
+00032a40: 7365 6c66 2e63 6c69 5f6c 735f 636d 6428  self.cli_ls_cmd(
+00032a50: 7374 6f72 655f 7479 7065 2c20 6275 636b  store_type, buck
+00032a60: 6574 5f6e 616d 6529 0a20 2020 2020 2020  et_name).       
+00032a70: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
+00032a80: 732e 6368 6563 6b5f 6f75 7470 7574 286c  s.check_output(l
+00032a90: 735f 636d 642c 2073 6865 6c6c 3d54 7275  s_cmd, shell=Tru
+00032aa0: 6529 0a20 2020 2020 2020 206f 7574 7075  e).        outpu
+00032ab0: 7420 3d20 6f75 742e 6465 636f 6465 2827  t = out.decode('
+00032ac0: 7574 662d 3827 290a 2020 2020 2020 2020  utf-8').        
+00032ad0: 6173 7365 7274 2027 746d 702d 6669 6c65  assert 'tmp-file
+00032ae0: 2720 696e 206f 7574 7075 742c 2028 0a20  ' in output, (. 
+00032af0: 2020 2020 2020 2020 2020 2066 2774 6d70             f'tmp
+00032b00: 2d66 696c 6520 6e6f 7420 666f 756e 6420  -file not found 
+00032b10: 696e 2062 7563 6b65 7420 2d20 6f75 7470  in bucket - outp
+00032b20: 7574 206f 6620 7b6c 735f 636d 647d 2077  ut of {ls_cmd} w
+00032b30: 6173 3a20 7b6f 7574 7075 747d 2729 0a0a  as: {output}')..
+00032b40: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
+00032b50: 2e6e 6f5f 666c 7569 6473 7461 636b 0a20  .no_fluidstack. 
+00032b60: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
+00032b70: 7061 7261 6d65 7472 697a 6528 2772 6567  parametrize('reg
+00032b80: 696f 6e27 2c20 5b0a 2020 2020 2020 2020  ion', [.        
+00032b90: 276e 6f72 7468 616d 6572 6963 612d 6e6f  'northamerica-no
+00032ba0: 7274 6865 6173 7431 272c 2027 6e6f 7274  rtheast1', 'nort
+00032bb0: 6861 6d65 7269 6361 2d6e 6f72 7468 6561  hamerica-northea
+00032bc0: 7374 3227 2c20 2775 732d 6365 6e74 7261  st2', 'us-centra
+00032bd0: 6c31 272c 0a20 2020 2020 2020 2027 7573  l1',.        'us
+00032be0: 2d65 6173 7431 272c 2027 7573 2d65 6173  -east1', 'us-eas
+00032bf0: 7434 272c 2027 7573 2d65 6173 7435 272c  t4', 'us-east5',
+00032c00: 2027 7573 2d73 6f75 7468 3127 2c20 2775   'us-south1', 'u
+00032c10: 732d 7765 7374 3127 2c20 2775 732d 7765  s-west1', 'us-we
+00032c20: 7374 3227 2c0a 2020 2020 2020 2020 2775  st2',.        'u
+00032c30: 732d 7765 7374 3327 2c20 2775 732d 7765  s-west3', 'us-we
+00032c40: 7374 3427 2c20 2773 6f75 7468 616d 6572  st4', 'southamer
+00032c50: 6963 612d 6561 7374 3127 2c20 2773 6f75  ica-east1', 'sou
+00032c60: 7468 616d 6572 6963 612d 7765 7374 3127  thamerica-west1'
+00032c70: 2c0a 2020 2020 2020 2020 2765 7572 6f70  ,.        'europ
+00032c80: 652d 6365 6e74 7261 6c32 272c 2027 6575  e-central2', 'eu
+00032c90: 726f 7065 2d6e 6f72 7468 3127 2c20 2765  rope-north1', 'e
+00032ca0: 7572 6f70 652d 736f 7574 6877 6573 7431  urope-southwest1
+00032cb0: 272c 2027 6575 726f 7065 2d77 6573 7431  ', 'europe-west1
+00032cc0: 272c 0a20 2020 2020 2020 2027 6575 726f  ',.        'euro
+00032cd0: 7065 2d77 6573 7432 272c 2027 6575 726f  pe-west2', 'euro
+00032ce0: 7065 2d77 6573 7433 272c 2027 6575 726f  pe-west3', 'euro
+00032cf0: 7065 2d77 6573 7434 272c 2027 6575 726f  pe-west4', 'euro
+00032d00: 7065 2d77 6573 7436 272c 0a20 2020 2020  pe-west6',.     
+00032d10: 2020 2027 6575 726f 7065 2d77 6573 7438     'europe-west8
+00032d20: 272c 2027 6575 726f 7065 2d77 6573 7439  ', 'europe-west9
+00032d30: 272c 2027 6575 726f 7065 2d77 6573 7431  ', 'europe-west1
+00032d40: 3027 2c20 2765 7572 6f70 652d 7765 7374  0', 'europe-west
+00032d50: 3132 272c 0a20 2020 2020 2020 2027 6173  12',.        'as
+00032d60: 6961 2d65 6173 7431 272c 2027 6173 6961  ia-east1', 'asia
+00032d70: 2d65 6173 7432 272c 2027 6173 6961 2d6e  -east2', 'asia-n
+00032d80: 6f72 7468 6561 7374 3127 2c20 2761 7369  ortheast1', 'asi
+00032d90: 612d 6e6f 7274 6865 6173 7432 272c 0a20  a-northeast2',. 
+00032da0: 2020 2020 2020 2027 6173 6961 2d6e 6f72         'asia-nor
+00032db0: 7468 6561 7374 3327 2c20 2761 7369 612d  theast3', 'asia-
+00032dc0: 736f 7574 6865 6173 7431 272c 2027 6173  southeast1', 'as
+00032dd0: 6961 2d73 6f75 7468 3127 2c20 2761 7369  ia-south1', 'asi
+00032de0: 612d 736f 7574 6832 272c 0a20 2020 2020  a-south2',.     
+00032df0: 2020 2027 6173 6961 2d73 6f75 7468 6561     'asia-southea
+00032e00: 7374 3227 2c20 276d 652d 6365 6e74 7261  st2', 'me-centra
+00032e10: 6c31 272c 2027 6d65 2d63 656e 7472 616c  l1', 'me-central
+00032e20: 3227 2c20 276d 652d 7765 7374 3127 2c0a  2', 'me-west1',.
+00032e30: 2020 2020 2020 2020 2761 7573 7472 616c          'austral
+00032e40: 6961 2d73 6f75 7468 6561 7374 3127 2c20  ia-southeast1', 
+00032e50: 2761 7573 7472 616c 6961 2d73 6f75 7468  'australia-south
+00032e60: 6561 7374 3227 2c20 2761 6672 6963 612d  east2', 'africa-
+00032e70: 736f 7574 6831 270a 2020 2020 5d29 0a20  south1'.    ]). 
+00032e80: 2020 2064 6566 2074 6573 745f 6763 735f     def test_gcs_
+00032e90: 7265 6769 6f6e 7328 7365 6c66 2c20 746d  regions(self, tm
+00032ea0: 705f 6c6f 6361 6c5f 7374 6f72 6167 655f  p_local_storage_
+00032eb0: 6f62 6a2c 2072 6567 696f 6e29 3a0a 2020  obj, region):.  
+00032ec0: 2020 2020 2020 2320 5468 6973 2074 6573        # This tes
+00032ed0: 7473 2063 7265 6174 696f 6e20 616e 6420  ts creation and 
+00032ee0: 7570 6c6f 6164 2074 6f20 6275 636b 6574  upload to bucket
+00032ef0: 2069 6e20 616c 6c20 4743 5320 7265 6769   in all GCS regi
+00032f00: 6f6e 730a 2020 2020 2020 2020 2320 546f  ons.        # To
+00032f10: 2074 6573 7420 6675 6c6c 2066 756e 6374   test full funct
+00032f20: 696f 6e61 6c69 7479 2c20 7573 6520 7465  ionality, use te
+00032f30: 7374 5f6d 616e 6167 6564 5f6a 6f62 735f  st_managed_jobs_
+00032f40: 7374 6f72 6167 6520 6162 6f76 652e 0a20  storage above.. 
+00032f50: 2020 2020 2020 2073 746f 7265 5f74 7970         store_typ
+00032f60: 6520 3d20 7374 6f72 6167 655f 6c69 622e  e = storage_lib.
+00032f70: 5374 6f72 6554 7970 652e 4743 530a 2020  StoreType.GCS.  
+00032f80: 2020 2020 2020 746d 705f 6c6f 6361 6c5f        tmp_local_
+00032f90: 7374 6f72 6167 655f 6f62 6a2e 6164 645f  storage_obj.add_
+00032fa0: 7374 6f72 6528 7374 6f72 655f 7479 7065  store(store_type
+00032fb0: 2c20 7265 6769 6f6e 3d72 6567 696f 6e29  , region=region)
+00032fc0: 0a20 2020 2020 2020 2062 7563 6b65 745f  .        bucket_
+00032fd0: 6e61 6d65 203d 2074 6d70 5f6c 6f63 616c  name = tmp_local
+00032fe0: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
+00032ff0: 650a 0a20 2020 2020 2020 2023 2043 6f6e  e..        # Con
+00033000: 6669 726d 2074 6861 7420 7468 6520 6275  firm that the bu
+00033010: 636b 6574 2077 6173 2063 7265 6174 6564  cket was created
+00033020: 2069 6e20 7468 6520 636f 7272 6563 7420   in the correct 
+00033030: 7265 6769 6f6e 0a20 2020 2020 2020 2072  region.        r
+00033040: 6567 696f 6e5f 636d 6420 3d20 7365 6c66  egion_cmd = self
+00033050: 2e63 6c69 5f72 6567 696f 6e5f 636d 6428  .cli_region_cmd(
+00033060: 7374 6f72 655f 7479 7065 2c20 6275 636b  store_type, buck
+00033070: 6574 5f6e 616d 6529 0a20 2020 2020 2020  et_name).       
+00033080: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
+00033090: 732e 6368 6563 6b5f 6f75 7470 7574 2872  s.check_output(r
+000330a0: 6567 696f 6e5f 636d 642c 2073 6865 6c6c  egion_cmd, shell
+000330b0: 3d54 7275 6529 0a20 2020 2020 2020 206f  =True).        o
+000330c0: 7574 7075 7420 3d20 6f75 742e 6465 636f  utput = out.deco
+000330d0: 6465 2827 7574 662d 3827 290a 2020 2020  de('utf-8').    
+000330e0: 2020 2020 6173 7365 7274 2072 6567 696f      assert regio
+000330f0: 6e20 696e 206f 7574 2e64 6563 6f64 6528  n in out.decode(
+00033100: 2775 7466 2d38 2729 2c20 280a 2020 2020  'utf-8'), (.    
+00033110: 2020 2020 2020 2020 6627 4275 636b 6574          f'Bucket
+00033120: 2077 6173 206e 6f74 2066 6f75 6e64 2069   was not found i
+00033130: 6e20 7265 6769 6f6e 207b 7265 6769 6f6e  n region {region
+00033140: 7d20 2d20 270a 2020 2020 2020 2020 2020  } - '.          
+00033150: 2020 6627 6f75 7470 7574 206f 6620 7b72    f'output of {r
+00033160: 6567 696f 6e5f 636d 647d 2077 6173 3a20  egion_cmd} was: 
+00033170: 7b6f 7574 7075 747d 2729 0a0a 2020 2020  {output}')..    
+00033180: 2020 2020 2320 4368 6563 6b20 6966 2074      # Check if t
+00033190: 6d70 5f73 6f75 7263 652f 746d 702d 6669  mp_source/tmp-fi
+000331a0: 6c65 2065 7869 7374 7320 696e 2074 6865  le exists in the
+000331b0: 2062 7563 6b65 7420 7573 696e 6720 636c   bucket using cl
+000331c0: 690a 2020 2020 2020 2020 6c73 5f63 6d64  i.        ls_cmd
+000331d0: 203d 2073 656c 662e 636c 695f 6c73 5f63   = self.cli_ls_c
+000331e0: 6d64 2873 746f 7265 5f74 7970 652c 2062  md(store_type, b
+000331f0: 7563 6b65 745f 6e61 6d65 290a 2020 2020  ucket_name).    
+00033200: 2020 2020 6f75 7420 3d20 7375 6270 726f      out = subpro
+00033210: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
+00033220: 7428 6c73 5f63 6d64 2c20 7368 656c 6c3d  t(ls_cmd, shell=
+00033230: 5472 7565 290a 2020 2020 2020 2020 6f75  True).        ou
+00033240: 7470 7574 203d 206f 7574 2e64 6563 6f64  tput = out.decod
+00033250: 6528 2775 7466 2d38 2729 0a20 2020 2020  e('utf-8').     
+00033260: 2020 2061 7373 6572 7420 2774 6d70 2d66     assert 'tmp-f
+00033270: 696c 6527 2069 6e20 6f75 7470 7574 2c20  ile' in output, 
+00033280: 280a 2020 2020 2020 2020 2020 2020 6627  (.            f'
+00033290: 746d 702d 6669 6c65 206e 6f74 2066 6f75  tmp-file not fou
+000332a0: 6e64 2069 6e20 6275 636b 6574 202d 206f  nd in bucket - o
+000332b0: 7574 7075 7420 6f66 207b 6c73 5f63 6d64  utput of {ls_cmd
+000332c0: 7d20 7761 733a 207b 6f75 7470 7574 7d27  } was: {output}'
+000332d0: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
+000332e0: 2054 6573 7469 6e67 2059 414d 4c20 5370   Testing YAML Sp
+000332f0: 6563 7320 2d2d 2d2d 2d2d 2d2d 2d2d 0a23  ecs ----------.#
+00033300: 204f 7572 2073 6b79 2073 746f 7261 6765   Our sky storage
+00033310: 2072 6571 7569 7265 7320 6372 6564 656e   requires creden
+00033320: 7469 616c 7320 746f 2063 6865 636b 2074  tials to check t
+00033330: 6865 2062 7563 6b65 7420 6578 6973 7461  he bucket exista
+00033340: 6e63 6520 7768 656e 0a23 206c 6f61 6469  nce when.# loadi
+00033350: 6e67 2061 2074 6173 6b20 6672 6f6d 2074  ng a task from t
+00033360: 6865 2079 616d 6c20 6669 6c65 2c20 736f  he yaml file, so
+00033370: 2077 6520 6361 6e6e 6f74 206d 616b 6520   we cannot make 
+00033380: 6974 2061 2075 6e69 7420 7465 7374 2e0a  it a unit test..
+00033390: 636c 6173 7320 5465 7374 5961 6d6c 5370  class TestYamlSp
+000333a0: 6563 733a 0a20 2020 2023 2054 4f44 4f28  ecs:.    # TODO(
+000333b0: 7a68 7775 293a 2041 6464 2074 6573 7420  zhwu): Add test 
+000333c0: 666f 7220 6074 6f5f 7961 6d6c 5f63 6f6e  for `to_yaml_con
+000333d0: 6669 6760 2066 6f72 2074 6865 2053 746f  fig` for the Sto
+000333e0: 7261 6765 206f 626a 6563 742e 0a20 2020  rage object..   
+000333f0: 2023 2020 5765 2073 686f 756c 6420 6e6f   #  We should no
+00033400: 7420 7573 6520 6065 7861 6d70 6c65 732f  t use `examples/
+00033410: 7374 6f72 6167 655f 6465 6d6f 2e79 616d  storage_demo.yam
+00033420: 6c60 2068 6572 652c 2073 696e 6365 2069  l` here, since i
+00033430: 7420 7265 7175 6972 6573 0a20 2020 2023  t requires.    #
+00033440: 2020 7573 6572 7320 746f 2065 6e73 7572    users to ensur
+00033450: 6520 6275 636b 6574 206e 616d 6573 2074  e bucket names t
+00033460: 6f20 6e6f 7420 6578 6973 7420 616e 642f  o not exist and/
+00033470: 6f72 2062 6520 756e 6971 7565 2e0a 2020  or be unique..  
+00033480: 2020 5f54 4553 545f 5941 4d4c 5f50 4154    _TEST_YAML_PAT
+00033490: 4853 203d 205b 0a20 2020 2020 2020 2027  HS = [.        '
+000334a0: 6578 616d 706c 6573 2f6d 696e 696d 616c  examples/minimal
+000334b0: 2e79 616d 6c27 2c20 2765 7861 6d70 6c65  .yaml', 'example
+000334c0: 732f 6d61 6e61 6765 645f 6a6f 622e 7961  s/managed_job.ya
+000334d0: 6d6c 272c 0a20 2020 2020 2020 2027 6578  ml',.        'ex
+000334e0: 616d 706c 6573 2f75 7369 6e67 5f66 696c  amples/using_fil
+000334f0: 655f 6d6f 756e 7473 2e79 616d 6c27 2c20  e_mounts.yaml', 
+00033500: 2765 7861 6d70 6c65 732f 7265 736e 6574  'examples/resnet
+00033510: 5f61 7070 2e79 616d 6c27 2c0a 2020 2020  _app.yaml',.    
+00033520: 2020 2020 2765 7861 6d70 6c65 732f 6d75      'examples/mu
+00033530: 6c74 695f 686f 7374 6e61 6d65 2e79 616d  lti_hostname.yam
+00033540: 6c27 0a20 2020 205d 0a0a 2020 2020 6465  l'.    ]..    de
+00033550: 6620 5f69 735f 6469 6374 5f73 7562 7365  f _is_dict_subse
+00033560: 7428 7365 6c66 2c20 6431 2c20 6432 293a  t(self, d1, d2):
+00033570: 0a20 2020 2020 2020 2022 2222 4368 6563  .        """Chec
+00033580: 6b20 6966 2064 3120 6973 2074 6865 2073  k if d1 is the s
+00033590: 7562 7365 7420 6f66 2064 322e 2222 220a  ubset of d2.""".
+000335a0: 2020 2020 2020 2020 666f 7220 6b2c 2076          for k, v
+000335b0: 2069 6e20 6431 2e69 7465 6d73 2829 3a0a   in d1.items():.
+000335c0: 2020 2020 2020 2020 2020 2020 6966 206b              if k
+000335d0: 206e 6f74 2069 6e20 6432 3a0a 2020 2020   not in d2:.    
+000335e0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+000335f0: 7369 6e73 7461 6e63 6528 762c 206c 6973  sinstance(v, lis
+00033600: 7429 206f 7220 6973 696e 7374 616e 6365  t) or isinstance
+00033610: 2876 2c20 6469 6374 293a 0a20 2020 2020  (v, dict):.     
+00033620: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00033630: 7373 6572 7420 6c65 6e28 7629 203d 3d20  ssert len(v) == 
+00033640: 302c 2028 6b2c 2076 290a 2020 2020 2020  0, (k, v).      
+00033650: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00033660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033670: 2020 2020 6173 7365 7274 2046 616c 7365      assert False
+00033680: 2c20 286b 2c20 7629 0a20 2020 2020 2020  , (k, v).       
+00033690: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
+000336a0: 616e 6365 2876 2c20 6469 6374 293a 0a20  ance(v, dict):. 
+000336b0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+000336c0: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+000336d0: 2864 325b 6b5d 2c20 6469 6374 292c 2028  (d2[k], dict), (
+000336e0: 6b2c 2076 2c20 6432 290a 2020 2020 2020  k, v, d2).      
+000336f0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00033700: 6973 5f64 6963 745f 7375 6273 6574 2876  is_dict_subset(v
+00033710: 2c20 6432 5b6b 5d29 0a20 2020 2020 2020  , d2[k]).       
+00033720: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
+00033730: 616e 6365 2876 2c20 7374 7229 3a0a 2020  ance(v, str):.  
+00033740: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00033750: 206b 203d 3d20 2761 6363 656c 6572 6174   k == 'accelerat
+00033760: 6f72 7327 3a0a 2020 2020 2020 2020 2020  ors':.          
+00033770: 2020 2020 2020 2020 2020 7265 736f 7572            resour
+00033780: 6365 7320 3d20 736b 792e 5265 736f 7572  ces = sky.Resour
+00033790: 6365 7328 290a 2020 2020 2020 2020 2020  ces().          
+000337a0: 2020 2020 2020 2020 2020 7265 736f 7572            resour
+000337b0: 6365 732e 5f73 6574 5f61 6363 656c 6572  ces._set_acceler
+000337c0: 6174 6f72 7328 762c 204e 6f6e 6529 0a20  ators(v, None). 
+000337d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000337e0: 2020 2061 7373 6572 7420 7265 736f 7572     assert resour
+000337f0: 6365 732e 6163 6365 6c65 7261 746f 7273  ces.accelerators
+00033800: 203d 3d20 6432 5b6b 5d2c 2028 6b2c 2076   == d2[k], (k, v
+00033810: 2c20 6432 290a 2020 2020 2020 2020 2020  , d2).          
+00033820: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00033830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033840: 6173 7365 7274 2076 2e6c 6f77 6572 2829  assert v.lower()
+00033850: 203d 3d20 6432 5b6b 5d2e 6c6f 7765 7228   == d2[k].lower(
+00033860: 292c 2028 6b2c 2076 2c20 6432 5b6b 5d29  ), (k, v, d2[k])
+00033870: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00033880: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00033890: 2020 2061 7373 6572 7420 7620 3d3d 2064     assert v == d
+000338a0: 325b 6b5d 2c20 286b 2c20 762c 2064 325b  2[k], (k, v, d2[
+000338b0: 6b5d 290a 0a20 2020 2064 6566 205f 6368  k])..    def _ch
+000338c0: 6563 6b5f 6571 7569 7661 6c65 6e74 2873  eck_equivalent(s
+000338d0: 656c 662c 2079 616d 6c5f 7061 7468 293a  elf, yaml_path):
+000338e0: 0a20 2020 2020 2020 2022 2222 4368 6563  .        """Chec
+000338f0: 6b20 6966 2074 6865 2079 616d 6c20 6973  k if the yaml is
+00033900: 2065 7175 6976 616c 656e 7420 6166 7465   equivalent afte
+00033910: 7220 6c6f 6164 2061 6e64 2064 756d 7020  r load and dump 
+00033920: 6167 6169 6e2e 2222 220a 2020 2020 2020  again.""".      
+00033930: 2020 6f72 6967 696e 5f74 6173 6b5f 636f    origin_task_co
+00033940: 6e66 6967 203d 2063 6f6d 6d6f 6e5f 7574  nfig = common_ut
+00033950: 696c 732e 7265 6164 5f79 616d 6c28 7961  ils.read_yaml(ya
+00033960: 6d6c 5f70 6174 6829 0a0a 2020 2020 2020  ml_path)..      
+00033970: 2020 7461 736b 203d 2073 6b79 2e54 6173    task = sky.Tas
+00033980: 6b2e 6672 6f6d 5f79 616d 6c28 7961 6d6c  k.from_yaml(yaml
+00033990: 5f70 6174 6829 0a20 2020 2020 2020 206e  _path).        n
+000339a0: 6577 5f74 6173 6b5f 636f 6e66 6967 203d  ew_task_config =
+000339b0: 2074 6173 6b2e 746f 5f79 616d 6c5f 636f   task.to_yaml_co
+000339c0: 6e66 6967 2829 0a20 2020 2020 2020 2023  nfig().        #
+000339d0: 2064 3120 3c3d 2064 320a 2020 2020 2020   d1 <= d2.      
+000339e0: 2020 7072 696e 7428 6f72 6967 696e 5f74    print(origin_t
+000339f0: 6173 6b5f 636f 6e66 6967 2c20 6e65 775f  ask_config, new_
+00033a00: 7461 736b 5f63 6f6e 6669 6729 0a20 2020  task_config).   
+00033a10: 2020 2020 2073 656c 662e 5f69 735f 6469       self._is_di
+00033a20: 6374 5f73 7562 7365 7428 6f72 6967 696e  ct_subset(origin
+00033a30: 5f74 6173 6b5f 636f 6e66 6967 2c20 6e65  _task_config, ne
+00033a40: 775f 7461 736b 5f63 6f6e 6669 6729 0a0a  w_task_config)..
+00033a50: 2020 2020 6465 6620 7465 7374 5f6c 6f61      def test_loa
+00033a60: 645f 6475 6d70 5f79 616d 6c5f 636f 6e66  d_dump_yaml_conf
+00033a70: 6967 5f65 7175 6976 616c 656e 7428 7365  ig_equivalent(se
+00033a80: 6c66 293a 0a20 2020 2020 2020 2022 2222  lf):.        """
+00033a90: 5465 7374 2069 6620 7468 6520 7961 6d6c  Test if the yaml
+00033aa0: 2063 6f6e 6669 6720 6973 2065 7175 6976   config is equiv
+00033ab0: 616c 656e 7420 6166 7465 7220 6c6f 6164  alent after load
+00033ac0: 2061 6e64 2064 756d 7020 6167 6169 6e2e   and dump again.
+00033ad0: 2222 220a 2020 2020 2020 2020 7061 7468  """.        path
+00033ae0: 6c69 622e 5061 7468 2827 7e2f 6461 7461  lib.Path('~/data
+00033af0: 7365 7473 2729 2e65 7870 616e 6475 7365  sets').expanduse
+00033b00: 7228 292e 6d6b 6469 7228 6578 6973 745f  r().mkdir(exist_
+00033b10: 6f6b 3d54 7275 6529 0a20 2020 2020 2020  ok=True).       
+00033b20: 2070 6174 686c 6962 2e50 6174 6828 277e   pathlib.Path('~
+00033b30: 2f74 6d70 6669 6c65 2729 2e65 7870 616e  /tmpfile').expan
+00033b40: 6475 7365 7228 292e 746f 7563 6828 290a  duser().touch().
+00033b50: 2020 2020 2020 2020 7061 7468 6c69 622e          pathlib.
+00033b60: 5061 7468 2827 7e2f 2e73 7368 2729 2e65  Path('~/.ssh').e
+00033b70: 7870 616e 6475 7365 7228 292e 6d6b 6469  xpanduser().mkdi
+00033b80: 7228 6578 6973 745f 6f6b 3d54 7275 6529  r(exist_ok=True)
+00033b90: 0a20 2020 2020 2020 2070 6174 686c 6962  .        pathlib
+00033ba0: 2e50 6174 6828 277e 2f2e 7373 682f 6964  .Path('~/.ssh/id
+00033bb0: 5f72 7361 2e70 7562 2729 2e65 7870 616e  _rsa.pub').expan
+00033bc0: 6475 7365 7228 292e 746f 7563 6828 290a  duser().touch().
+00033bd0: 2020 2020 2020 2020 7061 7468 6c69 622e          pathlib.
+00033be0: 5061 7468 2827 7e2f 746d 702d 776f 726b  Path('~/tmp-work
+00033bf0: 6469 7227 292e 6578 7061 6e64 7573 6572  dir').expanduser
+00033c00: 2829 2e6d 6b64 6972 2865 7869 7374 5f6f  ().mkdir(exist_o
+00033c10: 6b3d 5472 7565 290a 2020 2020 2020 2020  k=True).        
+00033c20: 7061 7468 6c69 622e 5061 7468 2827 7e2f  pathlib.Path('~/
+00033c30: 446f 776e 6c6f 6164 732f 7470 7527 292e  Downloads/tpu').
+00033c40: 6578 7061 6e64 7573 6572 2829 2e6d 6b64  expanduser().mkd
+00033c50: 6972 2870 6172 656e 7473 3d54 7275 652c  ir(parents=True,
+00033c60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00033c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033c80: 2020 2020 2020 6578 6973 745f 6f6b 3d54        exist_ok=T
-00033c90: 7275 6529 0a20 2020 2020 2020 2066 6f72  rue).        for
-00033ca0: 2079 616d 6c5f 7061 7468 2069 6e20 7365   yaml_path in se
-00033cb0: 6c66 2e5f 5445 5354 5f59 414d 4c5f 5041  lf._TEST_YAML_PA
-00033cc0: 5448 533a 0a20 2020 2020 2020 2020 2020  THS:.           
-00033cd0: 2073 656c 662e 5f63 6865 636b 5f65 7175   self._check_equ
-00033ce0: 6976 616c 656e 7428 7961 6d6c 5f70 6174  ivalent(yaml_pat
-00033cf0: 6829 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  h)...# ---------
-00033d00: 2d20 5465 7374 696e 6720 4d75 6c74 6970  - Testing Multip
-00033d10: 6c65 2041 6363 656c 6572 6174 6f72 7320  le Accelerators 
-00033d20: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
-00033d30: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
-00033d40: 7374 6163 6b20 2023 2046 6c75 6964 7374  stack  # Fluidst
-00033d50: 6163 6b20 646f 6573 206e 6f74 2073 7570  ack does not sup
-00033d60: 706f 7274 204b 3830 2067 7075 7320 666f  port K80 gpus fo
-00033d70: 7220 6e6f 770a 4070 7974 6573 742e 6d61  r now.@pytest.ma
-00033d80: 726b 2e6e 6f5f 7061 7065 7273 7061 6365  rk.no_paperspace
-00033d90: 2020 2320 5061 7065 7273 7061 6365 2064    # Paperspace d
-00033da0: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-00033db0: 4b38 3020 6770 7573 0a64 6566 2074 6573  K80 gpus.def tes
-00033dc0: 745f 6d75 6c74 6970 6c65 5f61 6363 656c  t_multiple_accel
-00033dd0: 6572 6174 6f72 735f 6f72 6465 7265 6428  erators_ordered(
-00033de0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-00033df0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-00033e00: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-00033e10: 7428 0a20 2020 2020 2020 2027 6d75 6c74  t(.        'mult
-00033e20: 6970 6c65 2d61 6363 656c 6572 6174 6f72  iple-accelerator
-00033e30: 732d 6f72 6465 7265 6427 2c0a 2020 2020  s-ordered',.    
-00033e40: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00033e50: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00033e60: 7920 2d63 207b 6e61 6d65 7d20 7465 7374  y -c {name} test
-00033e70: 732f 7465 7374 5f79 616d 6c73 2f74 6573  s/test_yamls/tes
-00033e80: 745f 6d75 6c74 6970 6c65 5f61 6363 656c  t_multiple_accel
-00033e90: 6572 6174 6f72 735f 6f72 6465 7265 642e  erators_ordered.
-00033ea0: 7961 6d6c 207c 2067 7265 7020 2255 7369  yaml | grep "Usi
-00033eb0: 6e67 2075 7365 722d 7370 6563 6966 6965  ng user-specifie
-00033ec0: 6420 6163 6365 6c65 7261 746f 7273 206c  d accelerators l
-00033ed0: 6973 7422 272c 0a20 2020 2020 2020 2020  ist"',.         
-00033ee0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00033ef0: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
-00033f00: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-00033f10: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-00033f20: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00033f30: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00033f40: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
-00033f50: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
-00033f60: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00033f70: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00033f80: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00033f90: 5f66 6c75 6964 7374 6163 6b20 2023 2046  _fluidstack  # F
-00033fa0: 6c75 6964 7374 6163 6b20 6861 7320 6c6f  luidstack has lo
-00033fb0: 7720 6176 6169 6c61 6269 6c69 7479 2066  w availability f
-00033fc0: 6f72 2054 3420 4750 5573 0a40 7079 7465  or T4 GPUs.@pyte
-00033fd0: 7374 2e6d 6172 6b2e 6e6f 5f70 6170 6572  st.mark.no_paper
-00033fe0: 7370 6163 6520 2023 2050 6170 6572 7370  space  # Papersp
-00033ff0: 6163 6520 646f 6573 206e 6f74 2073 7570  ace does not sup
-00034000: 706f 7274 2054 3420 4750 5573 0a64 6566  port T4 GPUs.def
-00034010: 2074 6573 745f 6d75 6c74 6970 6c65 5f61   test_multiple_a
-00034020: 6363 656c 6572 6174 6f72 735f 6f72 6465  ccelerators_orde
-00034030: 7265 645f 7769 7468 5f64 6566 6175 6c74  red_with_default
-00034040: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-00034050: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00034060: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-00034070: 7374 280a 2020 2020 2020 2020 276d 756c  st(.        'mul
-00034080: 7469 706c 652d 6163 6365 6c65 7261 746f  tiple-accelerato
-00034090: 7273 2d6f 7264 6572 6564 272c 0a20 2020  rs-ordered',.   
-000340a0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-000340b0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-000340c0: 2d79 202d 6320 7b6e 616d 657d 2074 6573  -y -c {name} tes
-000340d0: 7473 2f74 6573 745f 7961 6d6c 732f 7465  ts/test_yamls/te
-000340e0: 7374 5f6d 756c 7469 706c 655f 6163 6365  st_multiple_acce
-000340f0: 6c65 7261 746f 7273 5f6f 7264 6572 6564  lerators_ordered
-00034100: 5f77 6974 685f 6465 6661 756c 742e 7961  _with_default.ya
-00034110: 6d6c 207c 2067 7265 7020 2255 7369 6e67  ml | grep "Using
-00034120: 2075 7365 722d 7370 6563 6966 6965 6420   user-specified 
-00034130: 6163 6365 6c65 7261 746f 7273 206c 6973  accelerators lis
-00034140: 7422 272c 0a20 2020 2020 2020 2020 2020  t"',.           
-00034150: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00034160: 657d 2031 202d 2d73 7461 7475 7327 2c20  e} 1 --status', 
-00034170: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
-00034180: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
-00034190: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-000341a0: 7461 7475 7320 7b6e 616d 657d 207c 2067  tatus {name} | g
-000341b0: 7265 7020 5370 6f74 272c 0a20 2020 2020  rep Spot',.     
-000341c0: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-000341d0: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-000341e0: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
-000341f0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00034200: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00034210: 2e6e 6f5f 666c 7569 6473 7461 636b 2020  .no_fluidstack  
-00034220: 2320 466c 7569 6473 7461 636b 2068 6173  # Fluidstack has
-00034230: 206c 6f77 2061 7661 696c 6162 696c 6974   low availabilit
-00034240: 7920 666f 7220 5434 2047 5055 730a 4070  y for T4 GPUs.@p
-00034250: 7974 6573 742e 6d61 726b 2e6e 6f5f 7061  ytest.mark.no_pa
-00034260: 7065 7273 7061 6365 2020 2320 5061 7065  perspace  # Pape
-00034270: 7273 7061 6365 2064 6f65 7320 6e6f 7420  rspace does not 
-00034280: 7375 7070 6f72 7420 5434 2047 5055 730a  support T4 GPUs.
-00034290: 6465 6620 7465 7374 5f6d 756c 7469 706c  def test_multipl
-000342a0: 655f 6163 6365 6c65 7261 746f 7273 5f75  e_accelerators_u
-000342b0: 6e6f 7264 6572 6564 2829 3a0a 2020 2020  nordered():.    
-000342c0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-000342d0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-000342e0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-000342f0: 2020 2020 276d 756c 7469 706c 652d 6163      'multiple-ac
-00034300: 6365 6c65 7261 746f 7273 2d75 6e6f 7264  celerators-unord
-00034310: 6572 6564 272c 0a20 2020 2020 2020 205b  ered',.        [
-00034320: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00034330: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-00034340: 7b6e 616d 657d 2074 6573 7473 2f74 6573  {name} tests/tes
-00034350: 745f 7961 6d6c 732f 7465 7374 5f6d 756c  t_yamls/test_mul
-00034360: 7469 706c 655f 6163 6365 6c65 7261 746f  tiple_accelerato
-00034370: 7273 5f75 6e6f 7264 6572 6564 2e79 616d  rs_unordered.yam
-00034380: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00034390: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-000343a0: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
-000343b0: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-000343c0: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-000343d0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-000343e0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-000343f0: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-00034400: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00034410: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00034420: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b20  k.no_fluidstack 
-00034430: 2023 2046 6c75 6964 7374 6163 6b20 6861   # Fluidstack ha
-00034440: 7320 6c6f 7720 6176 6169 6c61 6269 6c69  s low availabili
-00034450: 7479 2066 6f72 2054 3420 4750 5573 0a40  ty for T4 GPUs.@
-00034460: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f70  pytest.mark.no_p
-00034470: 6170 6572 7370 6163 6520 2023 2050 6170  aperspace  # Pap
-00034480: 6572 7370 6163 6520 646f 6573 206e 6f74  erspace does not
-00034490: 2073 7570 706f 7274 2054 3420 4750 5573   support T4 GPUs
-000344a0: 0a64 6566 2074 6573 745f 6d75 6c74 6970  .def test_multip
-000344b0: 6c65 5f61 6363 656c 6572 6174 6f72 735f  le_accelerators_
-000344c0: 756e 6f72 6465 7265 645f 7769 7468 5f64  unordered_with_d
-000344d0: 6566 6175 6c74 2829 3a0a 2020 2020 6e61  efault():.    na
-000344e0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-000344f0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-00034500: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00034510: 2020 276d 756c 7469 706c 652d 6163 6365    'multiple-acce
-00034520: 6c65 7261 746f 7273 2d75 6e6f 7264 6572  lerators-unorder
-00034530: 6564 272c 0a20 2020 2020 2020 205b 0a20  ed',.        [. 
-00034540: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00034550: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00034560: 616d 657d 2074 6573 7473 2f74 6573 745f  ame} tests/test_
-00034570: 7961 6d6c 732f 7465 7374 5f6d 756c 7469  yamls/test_multi
-00034580: 706c 655f 6163 6365 6c65 7261 746f 7273  ple_accelerators
-00034590: 5f75 6e6f 7264 6572 6564 5f77 6974 685f  _unordered_with_
-000345a0: 6465 6661 756c 742e 7961 6d6c 272c 0a20  default.yaml',. 
-000345b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000345c0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-000345d0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
-000345e0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
-000345f0: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
-00034600: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
-00034610: 7b6e 616d 657d 207c 2067 7265 7020 5370  {name} | grep Sp
-00034620: 6f74 272c 0a20 2020 2020 2020 205d 2c0a  ot',.        ],.
-00034630: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-00034640: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-00034650: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00034660: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-00034670: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
-00034680: 7569 6473 7461 636b 2020 2320 5265 7175  uidstack  # Requ
-00034690: 6972 6573 206f 7468 6572 2063 6c6f 7564  ires other cloud
-000346a0: 7320 746f 2062 6520 656e 6162 6c65 640a  s to be enabled.
-000346b0: 6465 6620 7465 7374 5f6d 756c 7469 706c  def test_multipl
-000346c0: 655f 7265 736f 7572 6365 7328 293a 0a20  e_resources():. 
-000346d0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-000346e0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-000346f0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00034700: 2020 2020 2020 2027 6d75 6c74 6970 6c65         'multiple
-00034710: 2d72 6573 6f75 7263 6573 272c 0a20 2020  -resources',.   
-00034720: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00034730: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00034740: 2d79 202d 6320 7b6e 616d 657d 2074 6573  -y -c {name} tes
-00034750: 7473 2f74 6573 745f 7961 6d6c 732f 7465  ts/test_yamls/te
-00034760: 7374 5f6d 756c 7469 706c 655f 7265 736f  st_multiple_reso
-00034770: 7572 6365 732e 7961 6d6c 272c 0a20 2020  urces.yaml',.   
-00034780: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00034790: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-000347a0: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-000347b0: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-000347c0: 6465 642e 0a20 2020 2020 2020 205d 2c0a  ded..        ],.
-000347d0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-000347e0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-000347f0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00034800: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-00034810: 2d2d 2d2d 2d2d 2d2d 2d2d 2053 6b79 2042  ---------- Sky B
-00034820: 656e 6368 6d61 726b 202d 2d2d 2d2d 2d2d  enchmark -------
-00034830: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
-00034840: 2e6e 6f5f 666c 7569 6473 7461 636b 2020  .no_fluidstack  
-00034850: 2320 5265 7175 6972 6573 206f 7468 6572  # Requires other
-00034860: 2063 6c6f 7564 7320 746f 2062 6520 656e   clouds to be en
-00034870: 6162 6c65 640a 4070 7974 6573 742e 6d61  abled.@pytest.ma
-00034880: 726b 2e6e 6f5f 7061 7065 7273 7061 6365  rk.no_paperspace
-00034890: 2020 2320 5265 7175 6972 6573 206f 7468    # Requires oth
-000348a0: 6572 2063 6c6f 7564 7320 746f 2062 6520  er clouds to be 
-000348b0: 656e 6162 6c65 640a 4070 7974 6573 742e  enabled.@pytest.
-000348c0: 6d61 726b 2e6e 6f5f 6b75 6265 726e 6574  mark.no_kubernet
-000348d0: 6573 0a64 6566 2074 6573 745f 736b 795f  es.def test_sky_
-000348e0: 6265 6e63 6828 6765 6e65 7269 635f 636c  bench(generic_cl
-000348f0: 6f75 643a 2073 7472 293a 0a20 2020 206e  oud: str):.    n
-00034900: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00034910: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-00034920: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00034930: 2020 2027 736b 792d 6265 6e63 6827 2c0a     'sky-bench',.
-00034940: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00034950: 2020 2020 2020 6627 736b 7920 6265 6e63        f'sky benc
-00034960: 6820 6c61 756e 6368 202d 7920 2d62 207b  h launch -y -b {
-00034970: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
-00034980: 656e 6572 6963 5f63 6c6f 7564 7d20 2d69  eneric_cloud} -i
-00034990: 3020 7465 7374 732f 7465 7374 5f79 616d  0 tests/test_yam
-000349a0: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
-000349b0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-000349c0: 6c65 6570 2031 3230 272c 0a20 2020 2020  leep 120',.     
-000349d0: 2020 2020 2020 2066 2773 6b79 2062 656e         f'sky ben
-000349e0: 6368 2073 686f 7720 7b6e 616d 657d 207c  ch show {name} |
-000349f0: 2067 7265 7020 736b 792d 6265 6e63 682d   grep sky-bench-
-00034a00: 7b6e 616d 657d 207c 2067 7265 7020 4649  {name} | grep FI
-00034a10: 4e49 5348 4544 272c 0a20 2020 2020 2020  NISHED',.       
-00034a20: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-00034a30: 7920 6265 6e63 6820 646f 776e 207b 6e61  y bench down {na
-00034a40: 6d65 7d20 2d79 3b20 736b 7920 6265 6e63  me} -y; sky benc
-00034a50: 6820 6465 6c65 7465 207b 6e61 6d65 7d20  h delete {name} 
-00034a60: 2d79 272c 0a20 2020 2029 0a20 2020 2072  -y',.    ).    r
-00034a70: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00034a80: 290a                                     ).
+00033c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033c90: 2020 2020 2020 2020 2020 2020 6578 6973              exis
+00033ca0: 745f 6f6b 3d54 7275 6529 0a20 2020 2020  t_ok=True).     
+00033cb0: 2020 2066 6f72 2079 616d 6c5f 7061 7468     for yaml_path
+00033cc0: 2069 6e20 7365 6c66 2e5f 5445 5354 5f59   in self._TEST_Y
+00033cd0: 414d 4c5f 5041 5448 533a 0a20 2020 2020  AML_PATHS:.     
+00033ce0: 2020 2020 2020 2073 656c 662e 5f63 6865         self._che
+00033cf0: 636b 5f65 7175 6976 616c 656e 7428 7961  ck_equivalent(ya
+00033d00: 6d6c 5f70 6174 6829 0a0a 0a23 202d 2d2d  ml_path)...# ---
+00033d10: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
+00033d20: 4d75 6c74 6970 6c65 2041 6363 656c 6572  Multiple Acceler
+00033d30: 6174 6f72 7320 2d2d 2d2d 2d2d 2d2d 2d2d  ators ----------
+00033d40: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00033d50: 5f66 6c75 6964 7374 6163 6b20 2023 2046  _fluidstack  # F
+00033d60: 6c75 6964 7374 6163 6b20 646f 6573 206e  luidstack does n
+00033d70: 6f74 2073 7570 706f 7274 204b 3830 2067  ot support K80 g
+00033d80: 7075 7320 666f 7220 6e6f 770a 4070 7974  pus for now.@pyt
+00033d90: 6573 742e 6d61 726b 2e6e 6f5f 7061 7065  est.mark.no_pape
+00033da0: 7273 7061 6365 2020 2320 5061 7065 7273  rspace  # Papers
+00033db0: 7061 6365 2064 6f65 7320 6e6f 7420 7375  pace does not su
+00033dc0: 7070 6f72 7420 4b38 3020 6770 7573 0a64  pport K80 gpus.d
+00033dd0: 6566 2074 6573 745f 6d75 6c74 6970 6c65  ef test_multiple
+00033de0: 5f61 6363 656c 6572 6174 6f72 735f 6f72  _accelerators_or
+00033df0: 6465 7265 6428 293a 0a20 2020 206e 616d  dered():.    nam
+00033e00: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00033e10: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00033e20: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00033e30: 2027 6d75 6c74 6970 6c65 2d61 6363 656c   'multiple-accel
+00033e40: 6572 6174 6f72 732d 6f72 6465 7265 6427  erators-ordered'
+00033e50: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00033e60: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+00033e70: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+00033e80: 7d20 7465 7374 732f 7465 7374 5f79 616d  } tests/test_yam
+00033e90: 6c73 2f74 6573 745f 6d75 6c74 6970 6c65  ls/test_multiple
+00033ea0: 5f61 6363 656c 6572 6174 6f72 735f 6f72  _accelerators_or
+00033eb0: 6465 7265 642e 7961 6d6c 207c 2067 7265  dered.yaml | gre
+00033ec0: 7020 2255 7369 6e67 2075 7365 722d 7370  p "Using user-sp
+00033ed0: 6563 6966 6965 6420 6163 6365 6c65 7261  ecified accelera
+00033ee0: 746f 7273 206c 6973 7422 272c 0a20 2020  tors list"',.   
+00033ef0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00033f00: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
+00033f10: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+00033f20: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
+00033f30: 6465 642e 0a20 2020 2020 2020 205d 2c0a  ded..        ],.
+00033f40: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+00033f50: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+00033f60: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+00033f70: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
+00033f80: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00033f90: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00033fa0: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
+00033fb0: 6b20 2023 2046 6c75 6964 7374 6163 6b20  k  # Fluidstack 
+00033fc0: 6861 7320 6c6f 7720 6176 6169 6c61 6269  has low availabi
+00033fd0: 6c69 7479 2066 6f72 2054 3420 4750 5573  lity for T4 GPUs
+00033fe0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00033ff0: 5f70 6170 6572 7370 6163 6520 2023 2050  _paperspace  # P
+00034000: 6170 6572 7370 6163 6520 646f 6573 206e  aperspace does n
+00034010: 6f74 2073 7570 706f 7274 2054 3420 4750  ot support T4 GP
+00034020: 5573 0a64 6566 2074 6573 745f 6d75 6c74  Us.def test_mult
+00034030: 6970 6c65 5f61 6363 656c 6572 6174 6f72  iple_accelerator
+00034040: 735f 6f72 6465 7265 645f 7769 7468 5f64  s_ordered_with_d
+00034050: 6566 6175 6c74 2829 3a0a 2020 2020 6e61  efault():.    na
+00034060: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00034070: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+00034080: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00034090: 2020 276d 756c 7469 706c 652d 6163 6365    'multiple-acce
+000340a0: 6c65 7261 746f 7273 2d6f 7264 6572 6564  lerators-ordered
+000340b0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+000340c0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+000340d0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+000340e0: 657d 2074 6573 7473 2f74 6573 745f 7961  e} tests/test_ya
+000340f0: 6d6c 732f 7465 7374 5f6d 756c 7469 706c  mls/test_multipl
+00034100: 655f 6163 6365 6c65 7261 746f 7273 5f6f  e_accelerators_o
+00034110: 7264 6572 6564 5f77 6974 685f 6465 6661  rdered_with_defa
+00034120: 756c 742e 7961 6d6c 207c 2067 7265 7020  ult.yaml | grep 
+00034130: 2255 7369 6e67 2075 7365 722d 7370 6563  "Using user-spec
+00034140: 6966 6965 6420 6163 6365 6c65 7261 746f  ified accelerato
+00034150: 7273 206c 6973 7422 272c 0a20 2020 2020  rs list"',.     
+00034160: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00034170: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+00034180: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+00034190: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+000341a0: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
+000341b0: 2773 6b79 2073 7461 7475 7320 7b6e 616d  'sky status {nam
+000341c0: 657d 207c 2067 7265 7020 5370 6f74 272c  e} | grep Spot',
+000341d0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+000341e0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+000341f0: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
+00034200: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00034210: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00034220: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
+00034230: 7461 636b 2020 2320 466c 7569 6473 7461  tack  # Fluidsta
+00034240: 636b 2068 6173 206c 6f77 2061 7661 696c  ck has low avail
+00034250: 6162 696c 6974 7920 666f 7220 5434 2047  ability for T4 G
+00034260: 5055 730a 4070 7974 6573 742e 6d61 726b  PUs.@pytest.mark
+00034270: 2e6e 6f5f 7061 7065 7273 7061 6365 2020  .no_paperspace  
+00034280: 2320 5061 7065 7273 7061 6365 2064 6f65  # Paperspace doe
+00034290: 7320 6e6f 7420 7375 7070 6f72 7420 5434  s not support T4
+000342a0: 2047 5055 730a 6465 6620 7465 7374 5f6d   GPUs.def test_m
+000342b0: 756c 7469 706c 655f 6163 6365 6c65 7261  ultiple_accelera
+000342c0: 746f 7273 5f75 6e6f 7264 6572 6564 2829  tors_unordered()
+000342d0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+000342e0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+000342f0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00034300: 280a 2020 2020 2020 2020 276d 756c 7469  (.        'multi
+00034310: 706c 652d 6163 6365 6c65 7261 746f 7273  ple-accelerators
+00034320: 2d75 6e6f 7264 6572 6564 272c 0a20 2020  -unordered',.   
+00034330: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00034340: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00034350: 2d79 202d 6320 7b6e 616d 657d 2074 6573  -y -c {name} tes
+00034360: 7473 2f74 6573 745f 7961 6d6c 732f 7465  ts/test_yamls/te
+00034370: 7374 5f6d 756c 7469 706c 655f 6163 6365  st_multiple_acce
+00034380: 6c65 7261 746f 7273 5f75 6e6f 7264 6572  lerators_unorder
+00034390: 6564 2e79 616d 6c27 2c0a 2020 2020 2020  ed.yaml',.      
+000343a0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+000343b0: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
+000343c0: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
+000343d0: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
+000343e0: 2e0a 2020 2020 2020 2020 5d2c 0a20 2020  ..        ],.   
+000343f0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+00034400: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+00034410: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00034420: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+00034430: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
+00034440: 7374 6163 6b20 2023 2046 6c75 6964 7374  stack  # Fluidst
+00034450: 6163 6b20 6861 7320 6c6f 7720 6176 6169  ack has low avai
+00034460: 6c61 6269 6c69 7479 2066 6f72 2054 3420  lability for T4 
+00034470: 4750 5573 0a40 7079 7465 7374 2e6d 6172  GPUs.@pytest.mar
+00034480: 6b2e 6e6f 5f70 6170 6572 7370 6163 6520  k.no_paperspace 
+00034490: 2023 2050 6170 6572 7370 6163 6520 646f   # Paperspace do
+000344a0: 6573 206e 6f74 2073 7570 706f 7274 2054  es not support T
+000344b0: 3420 4750 5573 0a64 6566 2074 6573 745f  4 GPUs.def test_
+000344c0: 6d75 6c74 6970 6c65 5f61 6363 656c 6572  multiple_acceler
+000344d0: 6174 6f72 735f 756e 6f72 6465 7265 645f  ators_unordered_
+000344e0: 7769 7468 5f64 6566 6175 6c74 2829 3a0a  with_default():.
+000344f0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00034500: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00034510: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00034520: 2020 2020 2020 2020 276d 756c 7469 706c          'multipl
+00034530: 652d 6163 6365 6c65 7261 746f 7273 2d75  e-accelerators-u
+00034540: 6e6f 7264 6572 6564 272c 0a20 2020 2020  nordered',.     
+00034550: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00034560: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00034570: 202d 6320 7b6e 616d 657d 2074 6573 7473   -c {name} tests
+00034580: 2f74 6573 745f 7961 6d6c 732f 7465 7374  /test_yamls/test
+00034590: 5f6d 756c 7469 706c 655f 6163 6365 6c65  _multiple_accele
+000345a0: 7261 746f 7273 5f75 6e6f 7264 6572 6564  rators_unordered
+000345b0: 5f77 6974 685f 6465 6661 756c 742e 7961  _with_default.ya
+000345c0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+000345d0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+000345e0: 657d 2031 202d 2d73 7461 7475 7327 2c20  e} 1 --status', 
+000345f0: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+00034600: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
+00034610: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00034620: 7461 7475 7320 7b6e 616d 657d 207c 2067  tatus {name} | g
+00034630: 7265 7020 5370 6f74 272c 0a20 2020 2020  rep Spot',.     
+00034640: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+00034650: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+00034660: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
+00034670: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00034680: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+00034690: 2e6e 6f5f 666c 7569 6473 7461 636b 2020  .no_fluidstack  
+000346a0: 2320 5265 7175 6972 6573 206f 7468 6572  # Requires other
+000346b0: 2063 6c6f 7564 7320 746f 2062 6520 656e   clouds to be en
+000346c0: 6162 6c65 640a 6465 6620 7465 7374 5f6d  abled.def test_m
+000346d0: 756c 7469 706c 655f 7265 736f 7572 6365  ultiple_resource
+000346e0: 7328 293a 0a20 2020 206e 616d 6520 3d20  s():.    name = 
+000346f0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00034700: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+00034710: 6573 7428 0a20 2020 2020 2020 2027 6d75  est(.        'mu
+00034720: 6c74 6970 6c65 2d72 6573 6f75 7263 6573  ltiple-resources
+00034730: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00034740: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00034750: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+00034760: 657d 2074 6573 7473 2f74 6573 745f 7961  e} tests/test_ya
+00034770: 6d6c 732f 7465 7374 5f6d 756c 7469 706c  mls/test_multipl
+00034780: 655f 7265 736f 7572 6365 732e 7961 6d6c  e_resources.yaml
+00034790: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000347a0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+000347b0: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
+000347c0: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+000347d0: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+000347e0: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+000347f0: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+00034800: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
+00034810: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00034820: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
+00034830: 2053 6b79 2042 656e 6368 6d61 726b 202d   Sky Benchmark -
+00034840: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
+00034850: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
+00034860: 7461 636b 2020 2320 5265 7175 6972 6573  tack  # Requires
+00034870: 206f 7468 6572 2063 6c6f 7564 7320 746f   other clouds to
+00034880: 2062 6520 656e 6162 6c65 640a 4070 7974   be enabled.@pyt
+00034890: 6573 742e 6d61 726b 2e6e 6f5f 7061 7065  est.mark.no_pape
+000348a0: 7273 7061 6365 2020 2320 5265 7175 6972  rspace  # Requir
+000348b0: 6573 206f 7468 6572 2063 6c6f 7564 7320  es other clouds 
+000348c0: 746f 2062 6520 656e 6162 6c65 640a 4070  to be enabled.@p
+000348d0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6b75  ytest.mark.no_ku
+000348e0: 6265 726e 6574 6573 0a64 6566 2074 6573  bernetes.def tes
+000348f0: 745f 736b 795f 6265 6e63 6828 6765 6e65  t_sky_bench(gene
+00034900: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
+00034910: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00034920: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00034930: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00034940: 0a20 2020 2020 2020 2027 736b 792d 6265  .        'sky-be
+00034950: 6e63 6827 2c0a 2020 2020 2020 2020 5b0a  nch',.        [.
+00034960: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00034970: 7920 6265 6e63 6820 6c61 756e 6368 202d  y bench launch -
+00034980: 7920 2d62 207b 6e61 6d65 7d20 2d2d 636c  y -b {name} --cl
+00034990: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+000349a0: 7564 7d20 2d69 3020 7465 7374 732f 7465  ud} -i0 tests/te
+000349b0: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
+000349c0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+000349d0: 2020 2020 2773 6c65 6570 2031 3230 272c      'sleep 120',
+000349e0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000349f0: 6b79 2062 656e 6368 2073 686f 7720 7b6e  ky bench show {n
+00034a00: 616d 657d 207c 2067 7265 7020 736b 792d  ame} | grep sky-
+00034a10: 6265 6e63 682d 7b6e 616d 657d 207c 2067  bench-{name} | g
+00034a20: 7265 7020 4649 4e49 5348 4544 272c 0a20  rep FINISHED',. 
+00034a30: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00034a40: 2020 6627 736b 7920 6265 6e63 6820 646f    f'sky bench do
+00034a50: 776e 207b 6e61 6d65 7d20 2d79 3b20 736b  wn {name} -y; sk
+00034a60: 7920 6265 6e63 6820 6465 6c65 7465 207b  y bench delete {
+00034a70: 6e61 6d65 7d20 2d79 272c 0a20 2020 2029  name} -y',.    )
+00034a80: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00034a90: 7428 7465 7374 290a                      t(test).
```

### Comparing `skypilot_nightly-1.0.0.dev20240510/tests/test_storage.py` & `skypilot_nightly-1.0.0.dev20240511/tests/test_storage.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/tests/test_wheels.py` & `skypilot_nightly-1.0.0.dev20240511/tests/test_wheels.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240510/tests/test_yaml_parser.py` & `skypilot_nightly-1.0.0.dev20240511/tests/test_yaml_parser.py`

 * *Files identical despite different names*

